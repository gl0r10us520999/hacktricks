# рдмрд┐рди рдФрд░ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╕реЗ рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}

## рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА

рдЪрдВрдХреНрд╕ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреА рджрдХреНрд╖рддрд╛ рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рд░ рдЪрдВрдХ рдХреЗрд╡рд▓ рдПрдХ рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ рдореЗрдВ рдирд╣реАрдВ рд╣реЛрддрд╛, рдмрд▓реНрдХрд┐ рдХрдИ рдкреНрд░рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВред рдпреЗ рдмрд┐рди рд╣реИрдВ рдФрд░ 5 рдкреНрд░рдХрд╛рд░ рдХреЗ рдмрд┐рди рд╣реЛрддреЗ рд╣реИрдВ: [62](https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407) рдЫреЛрдЯреЗ рдмрд┐рди, 63 рдмрдбрд╝реЗ рдмрд┐рди, 1 рдЕрд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди, 10 рдлрд╛рд╕реНрдЯ рдмрд┐рди рдФрд░ 64 рдЯреАрдХреИрд╢ рдмрд┐рди рдкреНрд░рддрд┐ рдереНрд░реЗрдбред

рдкреНрд░рддреНрдпреЗрдХ рдЕрд╕реЙрд░реНрдЯреЗрдб, рдЫреЛрдЯреЗ рдФрд░ рдмрдбрд╝реЗ рдмрд┐рди рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкрддрд╛ рдЙрд╕реА рдРрд░реЗ рдХреЗ рдЕрдВрджрд░ рд╣реЛрддрд╛ рд╣реИред рдЗрдВрдбреЗрдХреНрд╕ 0 рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛, 1 рдЕрд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рд╣реИ, рдмрд┐рди 2-64 рдЫреЛрдЯреЗ рдмрд┐рди рд╣реИрдВ рдФрд░ рдмрд┐рди 65-127 рдмрдбрд╝реЗ рдмрд┐рди рд╣реИрдВред

### рдЯреАрдХреИрд╢ (рдкреНрд░рддрд┐-рдереНрд░реЗрдб рдХреИрд╢) рдмрд┐рди

рд╣рд╛рд▓рд╛рдВрдХрд┐ рдереНрд░реЗрдбреНрд╕ рдЕрдкрдиреА рдЦреБрдж рдХреА рд╣реАрдк рд░рдЦрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ (рджреЗрдЦреЗрдВ [Arenas](bins-and-memory-allocations.md#arenas) рдФрд░ [Subheaps](bins-and-memory-allocations.md#subheaps)), рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЬрд┐рд╕рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдереНрд░реЗрдбреНрд╕ рд╣реЛрддреЗ рд╣реИрдВ (рдЬреИрд╕реЗ рдПрдХ рд╡реЗрдм рд╕рд░реНрд╡рд░) **рджреВрд╕рд░реЗ рдереНрд░реЗрдбреНрд╕ рдХреЗ рд╕рд╛рде рд╣реАрдк рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИ**ред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдореБрдЦреНрдп рд╕рдорд╛рдзрд╛рди **рд▓реЙрдХрд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реИ, рдЬреЛ **рдереНрд░реЗрдбреНрд╕ рдХреЛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рдзреАрдорд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рдЯреАрдХреИрд╢ рдПрдХ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдХреА рддрд░рд╣ рд╣реЛрддрд╛ рд╣реИ рдкреНрд░рддрд┐ рдереНрд░реЗрдб рдЗрд╕ рддрд░рд╣ рд╕реЗ рдХрд┐ рдпрд╣ рдПрдХ **рд╕рд┐рдВрдЧрд▓ рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ** рд╣реИ рдЬреЛ рдЪрдВрдХреНрд╕ рдХреЛ рдорд░реНрдЬ рдирд╣реАрдВ рдХрд░рддрд╛ред рдкреНрд░рддреНрдпреЗрдХ рдереНрд░реЗрдб рдХреЗ рдкрд╛рд╕ **64 рд╕рд┐рдВрдЧрд▓реА-рд▓рд┐рдВрдХреНрдб рдЯреАрдХреИрд╢ рдмрд┐рди** рд╣реЛрддреЗ рд╣реИрдВред рдкреНрд░рддреНрдпреЗрдХ рдмрд┐рди рдореЗрдВ рдЕрдзрд┐рдХрддрдо [7 рд╕рдорд╛рди рдЖрдХрд╛рд░ рдХреЗ рдЪрдВрдХреНрд╕](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323) рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ [64-рдмрд┐рдЯ рд╕рд┐рд╕реНрдЯрдо рдкрд░ 24 рд╕реЗ 1032B рдФрд░ 32-рдмрд┐рдЯ рд╕рд┐рд╕реНрдЯрдо рдкрд░ 12 рд╕реЗ 516B](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315) рдХреЗ рдмреАрдЪ рд╣реЛрддреЗ рд╣реИрдВред

**рдЬрдм рдПрдХ рдереНрд░реЗрдб** рдПрдХ рдЪрдВрдХ рдХреЛ рдлреНрд░реА рдХрд░рддрд╛ рд╣реИ, **рдпрджрд┐ рдпрд╣ рдЯреАрдХреИрд╢ рдореЗрдВ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдмрдбрд╝рд╛ рдирд╣реАрдВ рд╣реИ** рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдЯреАрдХреИрд╢ рдмрд┐рди **рднрд░рд╛ рдирд╣реАрдВ рд╣реИ** (рдкрд╣рд▓реЗ рд╕реЗ 7 рдЪрдВрдХреНрд╕), **рддреЛ рдЗрд╕реЗ рд╡рд╣рд╛рдВ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред рдпрджрд┐ рдпрд╣ рдЯреАрдХреИрд╢ рдореЗрдВ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛, рддреЛ рдЗрд╕реЗ рдлреНрд░реА рдСрдкрд░реЗрд╢рди рдХреЛ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реАрдк рд▓реЙрдХ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЬрдм рдПрдХ **рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рдлреНрд░реА рдЪрдВрдХ **рдЯреАрдХреИрд╢ рдореЗрдВ рд╣реИ рддреЛ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛**, рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдЗрд╕реЗ рд╡реИрд╢реНрд╡рд┐рдХ рдмрд┐рди рдореЗрдВ рдПрдХ рдЦреЛрдЬрдиреЗ рдпрд╛ рдПрдХ рдирдпрд╛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реАрдк рд▓реЙрдХ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдПрдХ рдЕрдиреБрдХреВрд▓рди рднреА рд╣реИ, рдЬрдмрдХрд┐ рд╣реАрдк рд▓реЙрдХ рд╣реЛрдиреЗ рдкрд░, рдереНрд░реЗрдб **рдЕрдкрдиреЗ рдЯреАрдХреИрд╢ рдХреЛ рдЕрдиреБрд░реЛрдзрд┐рдд рдЖрдХрд╛рд░ рдХреЗ рд╣реАрдк рдЪрдВрдХреНрд╕ (7) рд╕реЗ рднрд░реЗрдЧрд╛**, рддрд╛рдХрд┐ рдпрджрд┐ рдЗрд╕реЗ рдФрд░ рдЕрдзрд┐рдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ, рддреЛ рдЗрд╕реЗ рдЯреАрдХреИрд╢ рдореЗрдВ рдорд┐рд▓ рдЬрд╛рдПрдЧрд╛ред

<details>

<summary>рдЯреАрдХреИрд╢ рдЪрдВрдХ рдЙрджрд╛рд╣рд░рдг рдЬреЛрдбрд╝реЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunk;
chunk = malloc(24);
printf("Address of the chunk: %p\n", (void *)chunk);
gets(chunk);
free(chunk);
return 0;
}
```
рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдФрд░ рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рд╕реЗ ret рдСрдкрдХреЛрдб рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧ рдХрд░реЗрдВред рдлрд┐рд░ gef рдХреЗ рд╕рд╛рде рдЖрдк рдЙрдкрдпреЛрдЧ рдореЗрдВ tcache рдмрд┐рди рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
gefтЮд  heap bins
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Tcachebins for thread 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Tcachebins[idx=0, size=0x20, count=1] тЖР  Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
```
</details>

#### Tcache Structs & Functions

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдореЗрдВ **max bins** рдФрд░ **chunks per index** рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ, **`tcache_entry`** рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдЬреЛ рдбрдмрд▓ рдлреНрд░реА рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ **`tcache_perthread_struct`**, рдПрдХ рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдЬреЛ рдкреНрд░рддреНрдпреЗрдХ рдереНрд░реЗрдб рдмрд┐рди рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рдЗрдВрдбреЗрдХреНрд╕ рдХреЗ рдкрддреЗ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

<details>

<summary><code>tcache_entry</code> рдФрд░ <code>tcache_perthread_struct</code></summary>
```c
// From https://github.com/bminor/glibc/blob/f942a732d37a96217ef828116ebe64a644db18d7/malloc/malloc.c

/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */
# define TCACHE_MAX_BINS		64
# define MAX_TCACHE_SIZE	tidx2usize (TCACHE_MAX_BINS-1)

/* Only used to pre-fill the tunables.  */
# define tidx2usize(idx)	(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)

/* When "x" is from chunksize().  */
# define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)
/* When "x" is a user-provided size.  */
# define usize2tidx(x) csize2tidx (request2size (x))

/* With rounding and alignment, the bins are...
idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)
idx 1   bytes 25..40 or 13..20
idx 2   bytes 41..56 or 21..28
etc.  */

/* This is another arbitrary limit, which tunables can change.  Each
tcache bin will hold at most this number of chunks.  */
# define TCACHE_FILL_COUNT 7

/* Maximum chunks in tcache bins for tunables.  This value must fit the range
of tcache->counts[] entries, else they may overflow.  */
# define MAX_TCACHE_COUNT UINT16_MAX

[...]

typedef struct tcache_entry
{
struct tcache_entry *next;
/* This field exists to detect double frees.  */
uintptr_t key;
} tcache_entry;

/* There is one of these for each thread, which contains the
per-thread cache (hence "tcache_perthread_struct").  Keeping
overall size low is mildly important.  Note that COUNTS and ENTRIES
are redundant (we could have just counted the linked list each
time), this is for performance reasons.  */
typedef struct tcache_perthread_struct
{
uint16_t counts[TCACHE_MAX_BINS];
tcache_entry *entries[TCACHE_MAX_BINS];
} tcache_perthread_struct;
```
</details>

рдлрдВрдХреНрд╢рди `__tcache_init` рд╡рд╣ рдлрдВрдХреНрд╢рди рд╣реИ рдЬреЛ `tcache_perthread_struct` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рди рдмрдирд╛рддрд╛ рдФрд░ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддрд╛ рд╣реИред

<details>

<summary>tcache_init рдХреЛрдб</summary>
```c
// From https://github.com/bminor/glibc/blob/f942a732d37a96217ef828116ebe64a644db18d7/malloc/malloc.c#L3241C1-L3274C2

static void
tcache_init(void)
{
mstate ar_ptr;
void *victim = 0;
const size_t bytes = sizeof (tcache_perthread_struct);

if (tcache_shutting_down)
return;

arena_get (ar_ptr, bytes);
victim = _int_malloc (ar_ptr, bytes);
if (!victim && ar_ptr != NULL)
{
ar_ptr = arena_get_retry (ar_ptr, bytes);
victim = _int_malloc (ar_ptr, bytes);
}


if (ar_ptr != NULL)
__libc_lock_unlock (ar_ptr->mutex);

/* In a low memory situation, we may not be able to allocate memory
- in which case, we just keep trying later.  However, we
typically do this very early, so either there is sufficient
memory, or there isn't enough memory to do non-trivial
allocations anyway.  */
if (victim)
{
tcache = (tcache_perthread_struct *) victim;
memset (tcache, 0, sizeof (tcache_perthread_struct));
}

}
```
</details>

#### Tcache рдЗрдВрдбреЗрдХреНрд╕

Tcache рдореЗрдВ рдХрдИ рдмрд┐рди рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рдЖрдХрд╛рд░ рдФрд░ **рдкреНрд░рддреНрдпреЗрдХ рдЗрдВрдбреЗрдХреНрд╕ рдХреЗ рдкрд╣рд▓реЗ рдЪрдВрдХ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдЗрдВрдбреЗрдХреНрд╕ рдХреЗ рд▓рд┐рдП рдЪрдВрдХреНрд╕ рдХреА рдорд╛рддреНрд░рд╛ рдПрдХ рдЪрдВрдХ рдХреЗ рдЕрдВрджрд░ рд╕реНрдерд┐рдд рд╣реЛрддреА рд╣реИ**ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рдЪрдВрдХ рдХреЛ рдвреВрдВрдврдирд╛ (рдЖрдорддреМрд░ рдкрд░ рдкрд╣рд▓рд╛), рд╕рднреА tcache рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдмрд┐рдВрджреБрдУрдВ рдФрд░ Tcache рдЪрдВрдХреНрд╕ рдХреА рдорд╛рддреНрд░рд╛ рдХреЛ рдвреВрдВрдврдирд╛ рд╕рдВрднрд╡ рд╣реИред

### рдлрд╛рд╕реНрдЯ рдмрд┐рди

рдлрд╛рд╕реНрдЯ рдмрд┐рди рдХреЛ **рдЫреЛрдЯреЗ рдЪрдВрдХреНрд╕ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди рдХреЛ рддреЗрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ** рдЬреЛ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореБрдХреНрдд рдХрд┐рдП рдЧрдП рдЪрдВрдХреНрд╕ рдХреЛ рддреНрд╡рд░рд┐рдд-рдПрдХреНрд╕реЗрд╕ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рд░рдЦрддреЗ рд╣реИрдВред рдпреЗ рдмрд┐рди рдПрдХ рд▓рд╛рд╕реНрдЯ-рдЗрди, рдлрд░реНрд╕реНрдЯ-рдЖрдЙрдЯ (LIFO) рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЪрдВрдХ рдкрд╣рд▓реЗ** рдлрд┐рд░ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рдПрдХ рдирдпрд╛ рдЖрд╡рдВрдЯрди рдЕрдиреБрд░реЛрдз рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рд╡реНрдпрд╡рд╣рд╛рд░ рдЧрддрд┐ рдХреЗ рд▓рд┐рдП рдлрд╛рдпрджреЗрдордВрдж рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рд╕реНрдЯреИрдХ (LIFO) рдХреЗ рд╢реАрд░реНрд╖ рд╕реЗ рдбрд╛рд▓рдирд╛ рдФрд░ рд╣рдЯрд╛рдирд╛ рдПрдХ рдХрддрд╛рд░ (FIFO) рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рддреЗрдЬ рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **рдлрд╛рд╕реНрдЯ рдмрд┐рди рд╕рд┐рдВрдЧрд▓реА рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ**, рдбрдмрд▓ рд▓рд┐рдВрдХреНрдб рдирд╣реАрдВ, рдЬреЛ рдЧрддрд┐ рдХреЛ рдФрд░ рдмрдврд╝рд╛рддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдореЗрдВ рдЪрдВрдХреНрд╕ рдкрдбрд╝реЛрд╕реА рдХреЗ рд╕рд╛рде рд╡рд┐рд▓рдп рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдордзреНрдп рд╕реЗ рд╣рдЯрд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЬрдЯрд┐рд▓ рд╕рдВрд░рдЪрдирд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред рдПрдХ рд╕рд┐рдВрдЧрд▓реА рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ рдЗрди рдСрдкрд░реЗрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд░рд▓ рдФрд░ рддреЗрдЬ рд╣реЛрддреА рд╣реИред

рдмреБрдирд┐рдпрд╛рджреА рд░реВрдк рд╕реЗ, рдпрд╣рд╛рдБ рдЬреЛ рд╣реЛрддрд╛ рд╣реИ рд╡рд╣ рдпрд╣ рд╣реИ рдХрд┐ рд╣реЗрдбрд░ (рдкрд╣рд▓реЗ рдЪрдВрдХ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░) рд╣рдореЗрд╢рд╛ рдЙрд╕ рдЖрдХрд╛рд░ рдХреЗ рдирд╡реАрдирддрдо рдореБрдХреНрдд рдЪрдВрдХ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИред рддреЛ:

* рдЬрдм рдЙрд╕ рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рдирдпрд╛ рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╣реЗрдбрд░ рдПрдХ рдореБрдХреНрдд рдЪрдВрдХ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдпрд╣ рдореБрдХреНрдд рдЪрдВрдХ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдЕрдЧрд▓реЗ рдЪрдВрдХ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реИ, рдпрд╣ рдкрддрд╛ рд╣реЗрдбрд░ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЕрдЧрд▓реА рдЖрд╡рдВрдЯрди рдХреЛ рдкрддрд╛ рдЪрд▓реЗ рдХрд┐ рдЙрдкрд▓рдмреНрдз рдЪрдВрдХ рдХрд╣рд╛рдБ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╣реИред
* рдЬрдм рдПрдХ рдЪрдВрдХ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдореБрдХреНрдд рдЪрдВрдХ рд╡рд░реНрддрдорд╛рди рдЙрдкрд▓рдмреНрдз рдЪрдВрдХ рдХреЗ рдкрддреЗ рдХреЛ рд╕рд╣реЗрдЬрддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рдирдП рдореБрдХреНрдд рдХрд┐рдП рдЧрдП рдЪрдВрдХ рдХрд╛ рдкрддрд╛ рд╣реЗрдбрд░ рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рдПрдЧрд╛ред

рдПрдХ рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ рдХрд╛ рдЕрдзрд┐рдХрддрдо рдЖрдХрд╛рд░ `0x80` рд╣реИ рдФрд░ рдЗрдиреНрд╣реЗрдВ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ `0x20` рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рдЪрдВрдХ рдЗрдВрдбреЗрдХреНрд╕ `0` рдореЗрдВ рд╣реЛрдЧрд╛, `0x30` рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рдЪрдВрдХ рдЗрдВрдбреЗрдХреНрд╕ `1` рдореЗрдВ рд╣реЛрдЧрд╛...

{% hint style="danger" %}
рдлрд╛рд╕реНрдЯ рдмрд┐рди рдореЗрдВ рдЪрдВрдХреНрд╕ рдХреЛ рдЙрдкрд▓рдмреНрдз рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ рдХреБрдЫ рд╕рдордп рдХреЗ рд▓рд┐рдП рдлрд╛рд╕реНрдЯ рдмрд┐рди рдЪрдВрдХреНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдмрдЬрд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рд╡реЗ рдЪрд╛рд░реЛрдВ рдУрд░ рдХреЗ рдЕрдиреНрдп рдореБрдХреНрдд рдЪрдВрдХреНрд╕ рдХреЗ рд╕рд╛рде рд╡рд┐рд▓рдп рдХрд░ рд╕рдХреЗрдВред
{% endhint %}
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

/*
Fastbins

An array of lists holding recently freed small chunks.  Fastbins
are not doubly linked.  It is faster to single-link them, and
since chunks are never removed from the middles of these lists,
double linking is not necessary. Also, unlike regular bins, they
are not even processed in FIFO order (they use faster LIFO) since
ordering doesn't much matter in the transient contexts in which
fastbins are normally used.

Chunks in fastbins keep their inuse bit set, so they cannot
be consolidated with other free chunks. malloc_consolidate
releases all chunks in fastbins and consolidates them with
other free chunks.
*/

typedef struct malloc_chunk *mfastbinptr;
#define fastbin(ar_ptr, idx) ((ar_ptr)->fastbinsY[idx])

/* offset 2 to use otherwise unindexable first 2 bins */
#define fastbin_index(sz) \
((((unsigned int) (sz)) >> (SIZE_SZ == 8 ? 4 : 3)) - 2)


/* The maximum fastbin request size we support */
#define MAX_FAST_SIZE     (80 * SIZE_SZ / 4)

#define NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)
```
<details>

<summary>рдПрдХ рдлрд╛рд╕реНрдЯрдмрд┐рди рдЪрдВрдХ рдЙрджрд╛рд╣рд░рдг рдЬреЛрдбрд╝реЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[8];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 8; i++) {
chunks[i] = malloc(24);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

return 0;
}
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо рд╕рдорд╛рди рдЖрдХрд╛рд░ рдХреЗ 8 рдЪрдВрдХреНрд╕ рдХреЛ рдХреИрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ tcache рдХреЛ рднрд░ рджреЗрдВ рдФрд░ рдЖрдард╡рд╛рдВ рдлрд╛рд╕реНрдЯ рдЪрдВрдХ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛред

рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдФрд░ `main` рдлрд╝рдВрдХреНрд╢рди рд╕реЗ `ret` рдСрдкрдХреЛрдб рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧ рдХрд░реЗрдВред рдлрд┐рд░ `gef` рдХреЗ рд╕рд╛рде рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ tcache рдмрд┐рди рднрд░рд╛ рд╣реБрдЖ рд╣реИ рдФрд░ рдПрдХ рдЪрдВрдХ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдореЗрдВ рд╣реИ:
```bash
gefтЮд  heap bins
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Tcachebins for thread 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Tcachebins[idx=0, size=0x20, count=7] тЖР  Chunk(addr=0xaaaaaaac1770, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1750, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1730, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1710, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac16f0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac16d0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Fastbins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Fastbins[idx=0, size=0x20]  тЖР  Chunk(addr=0xaaaaaaac1790, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
Fastbins[idx=1, size=0x30] 0x00
```
</details>

### рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди

рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдПрдХ **рдХреИрд╢** рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реАрдк рдкреНрд░рдмрдВрдзрдХ рджреНрд╡рд╛рд░рд╛ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди рдХреЛ рддреЗрдЬрд╝ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ: рдЬрдм рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрджрд┐ рдпрд╣ рдЯреБрдХрдбрд╝рд╛ рдПрдХ tcache рдпрд╛ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдореЗрдВ рдЖрд╡рдВрдЯрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝реЗ рдХреЗ рд╕рд╛рде рдЯрдХрд░рд╛ рдирд╣реАрдВ рд░рд╣рд╛ рд╣реИ, рддреЛ рд╣реАрдк рдкреНрд░рдмрдВрдзрдХ рддреБрд░рдВрдд рдЗрд╕реЗ рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖ рдЫреЛрдЯреЗ рдпрд╛ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ рдирд╣реАрдВ рд░рдЦрддрд╛ред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдпрд╣ рдкрд╣рд▓реЗ рдХрд┐рд╕реА рднреА рдкрдбрд╝реЛрд╕реА рдореБрдХреНрдд рдЯреБрдХрдбрд╝реЛрдВ рдХреЗ рд╕рд╛рде **рдорд┐рд▓рд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИ** рддрд╛рдХрд┐ рдореБрдХреНрдд рдореЗрдореЛрд░реА рдХрд╛ рдПрдХ рдмрдбрд╝рд╛ рдмреНрд▓реЙрдХ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдлрд┐рд░, рдпрд╣ рдЗрд╕ рдирдП рдЯреБрдХрдбрд╝реЗ рдХреЛ "рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди" рдирд╛рдордХ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдмрд┐рди рдореЗрдВ рд░рдЦрддрд╛ рд╣реИред

рдЬрдм рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо **рдореЗрдореЛрд░реА рдХреЗ рд▓рд┐рдП рдкреВрдЫрддрд╛ рд╣реИ**, рддреЛ рд╣реАрдк рдкреНрд░рдмрдВрдзрдХ **рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ** рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреНрдпрд╛ рд╡рд╣рд╛рдБ рдкрд░реНрдпрд╛рдкреНрдд рдЖрдХрд╛рд░ рдХрд╛ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рдПрдХ рдкрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рддреБрд░рдВрдд рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдЗрд╕реЗ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рдЙрдкрдпреБрдХреНрдд рдЯреБрдХрдбрд╝рд╛ рдирд╣реАрдВ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЗрд╕ рд╕реВрдЪреА рдореЗрдВ рд╕рднреА рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдЙрдирдХреЗ рдЖрдХрд╛рд░ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЫреЛрдЯреЗ рдпрд╛ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рджреЗрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдПрдХ рдмрдбрд╝рд╛ рдЯреБрдХрдбрд╝рд╛ 2 рдЖрдзреЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдмрд╛рдХреА MINSIZE рд╕реЗ рдмрдбрд╝рд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рд╡рд╛рдкрд╕ рд░рдЦрд╛ рдЬрд╛рдПрдЧрд╛ред

рддреЛ, рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореБрдХреНрдд рдХреА рдЧрдИ рдореЗрдореЛрд░реА рдХреЛ рддреЗрдЬреА рд╕реЗ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди рдХреЛ рддреЗрдЬрд╝ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ рдФрд░ рд╕рдордп-рдЦрдкрдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдЦреЛрдЬреЛрдВ рдФрд░ рд╡рд┐рд▓рдп рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рдХрдо рдХрд░рддрд╛ рд╣реИред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рднрд▓реЗ рд╣реА рдЯреБрдХрдбрд╝реЗ рд╡рд┐рднрд┐рдиреНрди рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдХреЗ рд╣реЛрдВ, рдпрджрд┐ рдПрдХ рдЙрдкрд▓рдмреНрдз рдЯреБрдХрдбрд╝рд╛ рджреВрд╕рд░реЗ рдЙрдкрд▓рдмреНрдз рдЯреБрдХрдбрд╝реЗ рдХреЗ рд╕рд╛рде рдЯрдХрд░рд╛ рд░рд╣рд╛ рд╣реИ (рднрд▓реЗ рд╣реА рд╡реЗ рдореВрд▓ рд░реВрдк рд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдмрд┐рдиреЛрдВ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реЛрдВ), рддреЛ рдЙрдиреНрд╣реЗрдВ рдорд┐рд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

<details>

<summary>рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЬреЛрдбрд╝реЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[9];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 9; i++) {
chunks[i] = malloc(0x100);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

return 0;
}
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо рдПрдХ рд╣реА рдЖрдХрд╛рд░ рдХреЗ 9 рдЪрдВрдХреНрд╕ рдХреЛ рдХреИрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ **tcache рдХреЛ рднрд░ рджреЗрдВ** рдФрд░ рдЖрдард╡рд╛рдВ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **fastbin рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдмрдбрд╝рд╛ рд╣реИ** рдФрд░ рдиреМрд╡рд╛рдВ рдореБрдХреНрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЗрд╕рд▓рд┐рдП рдиреМрд╡рд╛рдВ рдФрд░ рдЖрдард╡рд╛рдВ **рд╢реАрд░реНрд╖ рдЪрдВрдХ рдХреЗ рд╕рд╛рде рд╡рд┐рд▓рдп рдирд╣реАрдВ рд╣реЛрддреЗ**ред

рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдФрд░ `main` рдлрд╝рдВрдХреНрд╢рди рд╕реЗ `ret` рдСрдкрдХреЛрдб рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧ рдХрд░реЗрдВред рдлрд┐рд░ `gef` рдХреЗ рд╕рд╛рде рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ tcache рдмрд┐рди рднрд░рд╛ рд╣реБрдЖ рд╣реИ рдФрд░ рдПрдХ рдЪрдВрдХ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рд╣реИ:
```bash
gefтЮд  heap bins
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Tcachebins for thread 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Tcachebins[idx=15, size=0x110, count=7] тЖР  Chunk(addr=0xaaaaaaac1d10, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1c00, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1af0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac19e0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac18d0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac17c0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac12a0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Fastbins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Unsorted Bin for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] unsorted_bins[0]: fw=0xaaaaaaac1e10, bk=0xaaaaaaac1e10
тЖТ   Chunk(addr=0xaaaaaaac1e20, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in unsorted bin.
```
</details>

### рдЫреЛрдЯреЗ рдмрд┐рди

рдЫреЛрдЯреЗ рдмрд┐рди рдмрдбрд╝реЗ рдмрд┐рдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рддреЗрдЬ рд╣реЛрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рддреЗрдЬ рдмрд┐рдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдзреАрдореЗ рд╣реЛрддреЗ рд╣реИрдВред

62 рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рдмрд┐рди рдореЗрдВ **рдПрдХ рд╣реА рдЖрдХрд╛рд░ рдХреЗ рдЯреБрдХрдбрд╝реЗ** рд╣реЛрдВрдЧреЗ: 16, 24, ... (32-рдмрд┐рдЯ рдореЗрдВ рдЕрдзрд┐рдХрддрдо рдЖрдХрд╛рд░ 504 рдмрд╛рдЗрдЯ рдФрд░ 64-рдмрд┐рдЯ рдореЗрдВ 1024)ред рдпрд╣ рдЙрд╕ рдмрд┐рди рдХреЛ рдЦреЛрдЬрдиреЗ рдХреА рдЧрддрд┐ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рд╕реНрдерд╛рди рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдЗрди рд╕реВрдЪрд┐рдпреЛрдВ рдкрд░ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рдбрд╛рд▓рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдореЗрдВред

рдпрд╣ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╣реИ рдХрд┐ рдЫреЛрдЯреЗ рдмрд┐рди рдХрд╛ рдЖрдХрд╛рд░ рдмрд┐рди рдХреЗ рдЕрдиреБрдХреНрд░рдорд╛рдВрдХ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЧрдгрдирд╛ рдХреА рдЬрд╛рддреА рд╣реИ:

* рд╕рдмрд╕реЗ рдЫреЛрдЯрд╛ рдЖрдХрд╛рд░: 2\*4\*рдЕрдиреБрдХреНрд░рдорд╛рдВрдХ (рдЬреИрд╕реЗ рдЕрдиреБрдХреНрд░рдорд╛рдВрдХ 5 -> 40)
* рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ рдЖрдХрд╛рд░: 2\*8\*рдЕрдиреБрдХреНрд░рдорд╛рдВрдХ (рдЬреИрд╕реЗ рдЕрдиреБрдХреНрд░рдорд╛рдВрдХ 5 -> 80)
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711
#define NSMALLBINS         64
#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT
#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > CHUNK_HDR_SZ)
#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)

#define in_smallbin_range(sz)  \
((unsigned long) (sz) < (unsigned long) MIN_LARGE_SIZE)

#define smallbin_index(sz) \
((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
+ SMALLBIN_CORRECTION)
```
рдЫреЛрдЯреЗ рдФрд░ рдмрдбрд╝реЗ рдмрд┐рди рдХреЗ рдмреАрдЪ рдЪрдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди:
```c
#define bin_index(sz) \
((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))
```
<details>

<summary>рдПрдХ рдЫреЛрдЯрд╛ рдЯреБрдХрдбрд╝рд╛ рдЙрджрд╛рд╣рд░рдг рдЬреЛрдбрд╝реЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[10];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 9; i++) {
chunks[i] = malloc(0x100);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

chunks[9] = malloc(0x110);

return 0;
}
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ рд╣рдо рдПрдХ рд╣реА рдЖрдХрд╛рд░ рдХреЗ 9 рдЪрдВрдХреНрд╕ рдХреЛ рдХреИрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ **tcache рдХреЛ рднрд░ рджреЗрдВ** рдФрд░ рдЖрдард╡рд╛рдВ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **fastbin рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдмрдбрд╝рд╛ рд╣реИ** рдФрд░ рдиреМрд╡рд╛рдВ рдореБрдХреНрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЗрд╕рд▓рд┐рдП рдиреМрд╡рд╛рдВ рдФрд░ рдЖрдард╡рд╛рдВ **рд╢реАрд░реНрд╖ рдЪрдВрдХ рдХреЗ рд╕рд╛рде рд╡рд┐рд▓рдп рдирд╣реАрдВ рд╣реЛрддреЗ**ред рдлрд┐рд░ рд╣рдо 0x110 рдХрд╛ рдПрдХ рдмрдбрд╝рд╛ рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ **рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рдореЗрдВ рдЪрдВрдХ рдХреЛ рдЫреЛрдЯреЗ рдмрд┐рди рдореЗрдВ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИ**ред

рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдФрд░ `main` рдлрд╝рдВрдХреНрд╢рди рдХреЗ `ret` рдСрдкрдХреЛрдб рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧ рдХрд░реЗрдВред рдлрд┐рд░ `gef` рдХреЗ рд╕рд╛рде рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ tcache рдмрд┐рди рднрд░рд╛ рд╣реБрдЖ рд╣реИ рдФрд░ рдПрдХ рдЪрдВрдХ рдЫреЛрдЯреЗ рдмрд┐рди рдореЗрдВ рд╣реИ:
```bash
gefтЮд  heap bins
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Tcachebins for thread 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Tcachebins[idx=15, size=0x110, count=7] тЖР  Chunk(addr=0xaaaaaaac1d10, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1c00, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac1af0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac19e0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac18d0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac17c0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  Chunk(addr=0xaaaaaaac12a0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Fastbins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Unsorted Bin for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] Found 0 chunks in unsorted bin.
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Small Bins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] small_bins[16]: fw=0xaaaaaaac1e10, bk=0xaaaaaaac1e10
тЖТ   Chunk(addr=0xaaaaaaac1e20, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in 1 small non-empty bins.
```
</details>

### Large bins

рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЬреЛ рдирд┐рд╢реНрдЪрд┐рдд рдЖрдХрд╛рд░ рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рддреЗ рд╣реИрдВ, рдкреНрд░рддреНрдпреЗрдХ **large bin рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ**ред рдпрд╣ рдЕрдзрд┐рдХ рд▓рдЪреАрд▓рд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЛ **рд╡рд┐рднрд┐рдиреНрди рдЖрдХрд╛рд░реЛрдВ** рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ рдмрд┐рдирд╛ рдкреНрд░рддреНрдпреЗрдХ рдЖрдХрд╛рд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдмрд┐рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗред

рдПрдХ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрдХ рдореЗрдВ, рдмрдбрд╝реЗ рдмрд┐рди рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреЗ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реИрдВред рдмрдбрд╝реЗ рдмрд┐рдиреЛрдВ рдХреЗ рд▓рд┐рдП рд░реЗрдВрдЬ рдзреАрд░реЗ-рдзреАрд░реЗ рдмрдврд╝рддреА рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдкрд╣рд▓рд╛ рдмрд┐рди 512 рд╕реЗ 576 рдмрд╛рдЗрдЯреНрд╕ рддрдХ рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдХрд╡рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрдмрдХрд┐ рдЕрдЧрд▓рд╛ 576 рд╕реЗ 640 рдмрд╛рдЗрдЯреНрд╕ рддрдХ рдХрд╡рд░ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдкреИрдЯрд░реНрди рдЬрд╛рд░реА рд░рд╣рддрд╛ рд╣реИ, рд╕рдмрд╕реЗ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ 1MB рд╕реЗ рдКрдкрд░ рдХреЗ рд╕рднреА рдЯреБрдХрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВред

рдмрдбрд╝реЗ рдмрд┐рди рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рд╕рдВрдЪрд╛рд▓рди рдореЗрдВ рдзреАрдореЗ рд╣реЛрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЗрдВ рдЖрд╡рдВрдЯрди рдХреЗ рд▓рд┐рдП **рд╕рд░реНрд╡рд╢реНрд░реЗрд╖реНрда рдлрд┐рдЯ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рдЯреБрдХрдбрд╝реЛрдВ рдХреЗ рдЖрдХрд╛рд░ рдХреА рд╕реВрдЪреА рдХреЛ рдХреНрд░рдордмрджреНрдз рдФрд░ рдЦреЛрдЬрдиреЗ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЬрдм рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ рдбрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдХреНрд░рдордмрджреНрдз рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдЬрдм рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ, рддреЛ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рд╕рд╣реА рдЯреБрдХрдбрд╝рд╛ рдЦреЛрдЬрдирд╛ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрд╛рд░реНрдп рдЙрдиреНрд╣реЗрдВ **рдзреАрдорд╛** рдмрдирд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЪреВрдВрдХрд┐ рдмрдбрд╝реЗ рдЖрд╡рдВрдЯрди рдЫреЛрдЯреЗ рдЖрд╡рдВрдЯрдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрдо рд╕рд╛рдорд╛рдиреНрдп рд╣реЛрддреЗ рд╣реИрдВ, рдпрд╣ рдПрдХ рд╕реНрд╡реАрдХрд╛рд░реНрдп рд╡реНрдпрд╛рдкрд╛рд░-рдмрдВрдж рд╣реИред

рдпрд╣рд╛рдБ рд╣реИрдВ:

* 32 рдмрд┐рди 64B рд░реЗрдВрдЬ рдХреЗ (рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреЗ рд╕рд╛рде рдЯрдХрд░рд╛рддреЗ рд╣реИрдВ)
* 16 рдмрд┐рди 512B рд░реЗрдВрдЬ рдХреЗ (рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреЗ рд╕рд╛рде рдЯрдХрд░рд╛рддреЗ рд╣реИрдВ)
* 8 рдмрд┐рди 4096B рд░реЗрдВрдЬ рдХреЗ (рдХреБрдЫ рдЫреЛрдЯреЗ рдмрд┐рдиреЛрдВ рдХреЗ рд╕рд╛рде рдЯрдХрд░рд╛рддреЗ рд╣реИрдВ)
* 4 рдмрд┐рди 32768B рд░реЗрдВрдЬ рдХреЗ
* 2 рдмрд┐рди 262144B рд░реЗрдВрдЬ рдХреЗ
* 1 рдмрд┐рди рд╢реЗрд╖ рдЖрдХрд╛рд░реЛрдВ рдХреЗ рд▓рд┐рдП

<details>

<summary>Large bin sizes code</summary>
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

#define largebin_index_32(sz)                                                \
(((((unsigned long) (sz)) >> 6) <= 38) ?  56 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

#define largebin_index_32_big(sz)                                            \
(((((unsigned long) (sz)) >> 6) <= 45) ?  49 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

// XXX It remains to be seen whether it is good to keep the widths of
// XXX the buckets the same or whether it should be scaled by a factor
// XXX of two as well.
#define largebin_index_64(sz)                                                \
(((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

#define largebin_index(sz) \
(SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
: MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
: largebin_index_32 (sz))
```
</details>

<details>

<summary>рдПрдХ рдмрдбрд╝рд╛ рдЯреБрдХрдбрд╝рд╛ рдЙрджрд╛рд╣рд░рдг рдЬреЛрдбрд╝реЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[2];

chunks[0] = malloc(0x1500);
chunks[1] = malloc(0x1500);
free(chunks[0]);
chunks[0] = malloc(0x2000);

return 0;
}
```
2 рдмрдбрд╝реЗ рдЖрд╡рдВрдЯрди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдлрд┐рд░ рдПрдХ рдХреЛ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЗрд╕реЗ рдЕрд╕рдВрд░рдЪрд┐рдд рдмрд┐рди рдореЗрдВ рдбрд╛рд▓рддреЗ рд╣реБрдП) рдФрд░ рдПрдХ рдмрдбрд╝рд╛ рдЖрд╡рдВрдЯрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдореБрдХреНрдд рдПрдХ рдХреЛ рдЕрд╕рдВрд░рдЪрд┐рдд рдмрд┐рди рд╕реЗ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ рд▓реЗ рдЬрд╛рддреЗ рд╣реБрдП)ред

рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ рдФрд░ `main` рдлрд╝рдВрдХреНрд╢рди рд╕реЗ `ret` рдСрдкрдХреЛрдб рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧ рдХрд░реЗрдВред рдлрд┐рд░ `gef` рдХреЗ рд╕рд╛рде рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ tcache рдмрд┐рди рднрд░рд╛ рд╣реБрдЖ рд╣реИ рдФрд░ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдмрдбрд╝реЗ рдмрд┐рди рдореЗрдВ рд╣реИ:
```bash
gefтЮд  heap bin
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Tcachebins for thread 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
All tcachebins are empty
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Fastbins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Unsorted Bin for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] Found 0 chunks in unsorted bin.
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Small Bins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] Found 0 chunks in 0 small non-empty bins.
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА Large Bins for arena at 0xfffff7f90b00 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
[+] large_bins[100]: fw=0xaaaaaaac1290, bk=0xaaaaaaac1290
тЖТ   Chunk(addr=0xaaaaaaac12a0, size=0x1510, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in 1 large non-empty bins.
```
</details>

### рд╢реАрд░реНрд╖ рднрд╛рдЧ
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

/*
Top

The top-most available chunk (i.e., the one bordering the end of
available memory) is treated specially. It is never included in
any bin, is used only if no other chunk is available, and is
released back to the system if it is very large (see
M_TRIM_THRESHOLD).  Because top initially
points to its own bin with initial zero size, thus forcing
extension on the first malloc request, we avoid having any special
code in malloc to check whether it even exists yet. But we still
need to do so when getting memory from system, so we make
initial_top treat the bin as a legal but unusable chunk during the
interval between initialization and the first call to
sysmalloc. (This is somewhat delicate, since it relies on
the 2 preceding words to be zero during this interval as well.)
*/

/* Conveniently, the unsorted bin can be used as dummy top on first call */
#define initial_top(M)              (unsorted_chunks (M))
```
рдмреБрдирд┐рдпрд╛рджреА рд░реВрдк рд╕реЗ, рдпрд╣ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕рднреА рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реАрдк рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдЬрдм malloc рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрджрд┐ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЙрдкрд▓рдмреНрдз рдореБрдХреНрдд рдЯреБрдХрдбрд╝рд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝рд╛ рдЕрдкрдирд╛ рдЖрдХрд╛рд░ рдШрдЯрд╛ рджреЗрдЧрд╛ рдЖрд╡рд╢реНрдпрдХ рд╕реНрдерд╛рди рджреЗрдиреЗ рдХреЗ рд▓рд┐рдПред\
Top Chunk рдХрд╛ рдкреЙрдЗрдВрдЯрд░ `malloc_state` рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╢реБрд░реБрдЖрдд рдореЗрдВ, рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝реЗ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

<details>

<summary>Top Chunk рдЙрджрд╛рд╣рд░рдг рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunk;
chunk = malloc(24);
printf("Address of the chunk: %p\n", (void *)chunk);
gets(chunk);
return 0;
}
```
`main` рдХреЗ `ret` рдСрдкрдХреЛрдб рдореЗрдВ рдмреНрд░реЗрдХ рдкреЙрдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдФрд░ рдбрд┐рдмрдЧ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ malloc рдиреЗ рдкрддрд╛ `0xaaaaaaac12a0` рд▓реМрдЯрд╛рдпрд╛ рдФрд░ рдпреЗ рдЪрдВрдХреНрд╕ рд╣реИрдВ:
```bash
gefтЮд  heap chunks
Chunk(addr=0xaaaaaaac1010, size=0x290, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac1010     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]
Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac12a0     41 41 41 41 41 41 41 00 00 00 00 00 00 00 00 00    AAAAAAA.........]
Chunk(addr=0xaaaaaaac12c0, size=0x410, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac12c0     41 64 64 72 65 73 73 20 6f 66 20 74 68 65 20 63    Address of the c]
Chunk(addr=0xaaaaaaac16d0, size=0x410, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac16d0     41 41 41 41 41 41 41 0a 00 00 00 00 00 00 00 00    AAAAAAA.........]
Chunk(addr=0xaaaaaaac1ae0, size=0x20530, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  тЖР  top chunk
```
рдЬрд╣рд╛рдБ рдпрд╣ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝рд╛ рдкрддреЗ `0xaaaaaaac1ae0` рдкрд░ рд╣реИред рдпрд╣ рдХреЛрдИ рдЖрд╢реНрдЪрд░реНрдп рдХреА рдмрд╛рдд рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЕрдВрддрд┐рдо рдЖрд╡рдВрдЯрд┐рдд рдЯреБрдХрдбрд╝рд╛ `0xaaaaaaac12a0` рдкрд░ рдерд╛ рдЬрд┐рд╕рдХрд╛ рдЖрдХрд╛рд░ `0x410` рдерд╛ рдФрд░ `0xaaaaaaac12a0 + 0x410 = 0xaaaaaaac1ae0`ред\
рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝реЗ рдХреА рд▓рдВрдмрд╛рдИ рдЗрд╕рдХреЗ рдЯреБрдХрдбрд╝реЗ рдХреЗ рд╣реЗрдбрд░ рдкрд░ рджреЗрдЦреА рдЬрд╛ рд╕рдХреЗ:
```bash
gefтЮд  x/8wx 0xaaaaaaac1ae0 - 16
0xaaaaaaac1ad0:	0x00000000	0x00000000	0x00020531	0x00000000
0xaaaaaaac1ae0:	0x00000000	0x00000000	0x00000000	0x00000000
```
</details>

### рдЕрдВрддрд┐рдо рд╢реЗрд╖

рдЬрдм malloc рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрд╕рдВрд░рдЪрд┐рдд рдмрд┐рди рд╕реЗ рдпрд╛ рд╢реАрд░реНрд╖ рдЯреБрдХрдбрд╝реЗ рд╕реЗ), рддреЛ рд╡рд┐рднрд╛рдЬрд┐рдд рдЯреБрдХрдбрд╝реЗ рдХреЗ рд╢реЗрд╖ рд╕реЗ рдмрдирд╛рдП рдЧрдП рдЯреБрдХрдбрд╝реЗ рдХреЛ рдЕрдВрддрд┐рдо рд╢реЗрд╖ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдкреЙрдЗрдВрдЯрд░ `malloc_state` рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИред

## рдЖрд╡рдВрдЯрди рдкреНрд░рд╡рд╛рд╣

рдЪреЗрдХ рдХрд░реЗрдВ:

{% content-ref url="heap-memory-functions/malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](heap-memory-functions/malloc-and-sysmalloc.md)
{% endcontent-ref %}

## рдореБрдХреНрдд рдкреНрд░рд╡рд╛рд╣

рдЪреЗрдХ рдХрд░реЗрдВ:

{% content-ref url="heap-memory-functions/free.md" %}
[free.md](heap-memory-functions/free.md)
{% endcontent-ref %}

## рд╣реАрдк рдлрд╝рдВрдХреНрд╢рдВрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ

рд╣реАрдк рдореЗрдВ рднрд╛рд░реА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рдВрд╕ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдП рдЧрдП рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

{% content-ref url="heap-memory-functions/heap-functions-security-checks.md" %}
[heap-functions-security-checks.md](heap-memory-functions/heap-functions-security-checks.md)
{% endcontent-ref %}

## рд╕рдВрджрд░реНрдн

* [https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/](https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/)
* [https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/](https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/)
* [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/tcache/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/tcache/)

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
