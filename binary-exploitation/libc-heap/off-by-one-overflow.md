# Off by one overflow

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

PosiadajÄ…c dostÄ™p do przepeÅ‚nienia 1B, atakujÄ…cy moÅ¼e zmodyfikowaÄ‡ pole `size` nastÄ™pnego kawaÅ‚ka. UmoÅ¼liwia to manipulacjÄ™ tym, ktÃ³re kawaÅ‚ki sÄ… faktycznie zwalniane, potencjalnie generujÄ…c kawaÅ‚ek, ktÃ³ry zawiera inny legalny kawaÅ‚ek. Eksploatacja jest podobna do [double free](double-free.md) lub nakÅ‚adajÄ…cych siÄ™ kawaÅ‚kÃ³w.

IstniejÄ… 2 typy podatnoÅ›ci off by one:

* Dowolny bajt: Ten rodzaj pozwala na nadpisanie tego bajtu dowolnÄ… wartoÅ›ciÄ…
* Bajt null (off-by-null): Ten rodzaj pozwala na nadpisanie tego bajtu tylko wartoÅ›ciÄ… 0x00
* Typowym przykÅ‚adem tej podatnoÅ›ci moÅ¼na zobaczyÄ‡ w poniÅ¼szym kodzie, gdzie zachowanie `strlen` i `strcpy` jest niespÃ³jne, co pozwala ustawiÄ‡ bajt 0x00 na poczÄ…tku nastÄ™pnego kawaÅ‚ka.
* MoÅ¼e to byÄ‡ wykorzystane z [House of Einherjar](house-of-einherjar.md).
* JeÅ›li uÅ¼ywasz Tcache, moÅ¼na to wykorzystaÄ‡ w sytuacji [double free](double-free.md).

<details>

<summary>Off-by-null</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

WÅ›rÃ³d innych kontroli, teraz za kaÅ¼dym razem, gdy kawaÅ‚ek pamiÄ™ci jest zwalniany, poprzedni rozmiar jest porÃ³wnywany z rozmiarem skonfigurowanym w metadanych kawaÅ‚ka, co sprawia, Å¼e atak ten jest doÅ›Ä‡ skomplikowany od wersji 2.28.

### PrzykÅ‚ad kodu:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Ten atak nie dziaÅ‚a juÅ¼ z powodu uÅ¼ycia Tcaches.
* Co wiÄ™cej, jeÅ›li sprÃ³bujesz go naduÅ¼yÄ‡, uÅ¼ywajÄ…c wiÄ™kszych kawaÅ‚kÃ³w (wiÄ™c tcaches nie sÄ… zaangaÅ¼owane), otrzymasz bÅ‚Ä…d: `malloc(): invalid next size (unsorted)`

### Cel

* SprawiÄ‡, aby kawaÅ‚ek byÅ‚ zawarty w innym kawaÅ‚ku, tak aby dostÄ™p do zapisu w tym drugim kawaÅ‚ku pozwalaÅ‚ na nadpisanie zawartego.

### Wymagania

* Off by one overflow, aby zmodyfikowaÄ‡ informacje o rozmiarze w metadanych.

### OgÃ³lny atak off-by-one

* Przydziel trzy kawaÅ‚ki `A`, `B` i `C` (powiedzmy rozmiar 0x20), oraz kolejny, aby zapobiec konsolidacji z top-chunk.
* Zwalniamy `C` (wstawiony do listy wolnych kawaÅ‚kÃ³w Tcache 0x20).
* UÅ¼yj kawaÅ‚ka `A`, aby przepeÅ‚niÄ‡ `B`. NaduÅ¼yj off-by-one, aby zmodyfikowaÄ‡ pole `size` w `B` z 0x21 na 0x41.
* Teraz mamy `B` zawierajÄ…cy wolny kawaÅ‚ek `C`.
* Zwalniamy `B` i przydzielamy kawaÅ‚ek 0x40 (zostanie umieszczony tutaj ponownie).
* MoÅ¼emy zmodyfikowaÄ‡ wskaÅºnik `fd` z `C`, ktÃ³ry jest nadal wolny (trucizna Tcache).

### Atak off-by-null

* 3 kawaÅ‚ki pamiÄ™ci (a, b, c) sÄ… rezerwowane jeden po drugim. NastÄ™pnie Å›rodkowy kawaÅ‚ek jest zwalniany. Pierwszy kawaÅ‚ek zawiera lukÄ™ off by one, a atakujÄ…cy naduÅ¼ywa jej z 0x00 (jeÅ›li poprzedni bajt byÅ‚ 0x10, to sprawiÅ‚oby, Å¼e Å›rodkowy kawaÅ‚ek wskazywaÅ‚by, Å¼e jest o 0x10 mniejszy niÅ¼ w rzeczywistoÅ›ci).
* NastÄ™pnie w zwolnionym kawaÅ‚ku (b) przydzielane sÄ… 2 mniejsze kawaÅ‚ki, jednak `b + b->size` nigdy nie aktualizuje kawaÅ‚ka c, poniewaÅ¼ wskazywany adres jest mniejszy niÅ¼ powinien.
* NastÄ™pnie, b1 i c sÄ… zwalniane. PoniewaÅ¼ `c - c->prev_size` nadal wskazuje na b (teraz b1), oba sÄ… konsolidowane w jeden kawaÅ‚ek. Jednak b2 wciÄ…Å¼ znajduje siÄ™ pomiÄ™dzy b1 a c.
* Na koniec wykonywana jest nowa alokacja malloc, odzyskujÄ…c ten obszar pamiÄ™ci, ktÃ³ry w rzeczywistoÅ›ci bÄ™dzie zawieraÅ‚ b2, co pozwala wÅ‚aÅ›cicielowi nowego malloca kontrolowaÄ‡ zawartoÅ›Ä‡ b2.

Ten obrazek doskonale wyjaÅ›nia atak:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## Inne przykÅ‚ady i odniesienia

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Bon-nie-appetit. HTB Cyber Apocalypse CTF 2022**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/)
* Off-by-one z powodu `strlen`, ktÃ³re uwzglÄ™dnia pole `size` nastÄ™pnego kawaÅ‚ka.
* UÅ¼ywane jest Tcache, wiÄ™c ogÃ³lne ataki off-by-one dziaÅ‚ajÄ…, aby uzyskaÄ‡ dowolny zapis z truciznÄ… Tcache.
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* MoÅ¼liwe jest naduÅ¼ycie off by one, aby wycieknÄ…Ä‡ adres z sterty, poniewaÅ¼ bajt 0x00 na koÅ„cu ciÄ…gu jest nadpisywany przez nastÄ™pne pole.
* Dowolny zapis uzyskuje siÄ™ przez naduÅ¼ycie zapisu off by one, aby wskaÅºnik wskazywaÅ‚ na inne miejsce, gdzie zostanie zbudowana faÅ‚szywa struktura z faÅ‚szywymi wskaÅºnikami. NastÄ™pnie moÅ¼liwe jest podÄ…Å¼anie za wskaÅºnikiem tej struktury, aby uzyskaÄ‡ dowolny zapis.
* Adres libc jest wyciekany, poniewaÅ¼ jeÅ›li sterta jest rozszerzana za pomocÄ… mmap, pamiÄ™Ä‡ przydzielona przez mmap ma staÅ‚y offset od libc.
* Na koniec dowolny zapis jest naduÅ¼ywany, aby zapisaÄ‡ w adresie \_\_free\_hook z adresem one gadget.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* Istnieje luka NULL off by one w funkcji `getline`, ktÃ³ra odczytuje linie wejÅ›ciowe od uÅ¼ytkownika. Ta funkcja jest uÅ¼ywana do odczytu "klucza" treÅ›ci, a nie samej treÅ›ci.
* W opisie piÄ™Ä‡ poczÄ…tkowych kawaÅ‚kÃ³w jest tworzonych:
* chunk1 (0x200)
* chunk2  (0x50)
* chunk5 (0x68)
* chunk3 (0x1f8)
* chunk4 (0xf0)
* chunk defense (0x400), aby uniknÄ…Ä‡ konsolidacji z top chunk.
* NastÄ™pnie kawaÅ‚ki 1, 5 i 3 sÄ… zwalniane, wiÄ™c:
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* NastÄ™pnie naduÅ¼ywajÄ…c chunk3 (0x1f8), luka null off-by-one jest naduÅ¼ywana, zapisujÄ…c `prev_size` jako `0x4e0`.
* ZauwaÅ¼, Å¼e rozmiary poczÄ…tkowo przydzielonych kawaÅ‚kÃ³w 1, 2, 5 i 3 oraz nagÅ‚Ã³wki 4 z tych kawaÅ‚kÃ³w sumujÄ… siÄ™ do `0x4e0`:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* NastÄ™pnie kawaÅ‚ek 4 jest zwalniany, generujÄ…c kawaÅ‚ek, ktÃ³ry pochÅ‚ania wszystkie kawaÅ‚ki aÅ¼ do poczÄ…tku:
* ```python
[ 0x4e0 Chunk 1-2-5-3 (free) ] [ 0xf0 Chunk 4 (corrupted) ] [ 0x400 Chunk defense ]
```
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* NastÄ™pnie przydzielane sÄ… `0x200` bajtÃ³w, wypeÅ‚niajÄ…c oryginalny kawaÅ‚ek 1.
* A nastÄ™pnie przydzielane sÄ… kolejne 0x200 bajtÃ³w, a kawaÅ‚ek 2 jest niszczony, wiÄ™c nie ma Å¼adnego wycieku i to nie dziaÅ‚a? MoÅ¼e to nie powinno byÄ‡ robione.
* NastÄ™pnie przydzielany jest kolejny kawaÅ‚ek z 0x58 "a"s (nadpisujÄ…c kawaÅ‚ek 2 i docierajÄ…c do kawaÅ‚ka 5) i modyfikuje `fd` szybkiego kawaÅ‚ka kawaÅ‚ka 5, wskazujÄ…c go na `__malloc_hook`.
* NastÄ™pnie przydzielany jest kawaÅ‚ek 0x68, wiÄ™c faÅ‚szywy szybki kawaÅ‚ek w `__malloc_hook` jest nastÄ™pnym szybkim kawaÅ‚kiem.
* Na koniec przydzielany jest nowy szybki kawaÅ‚ek 0x68, a `__malloc_hook` jest nadpisywany adresem `one_gadget`.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
