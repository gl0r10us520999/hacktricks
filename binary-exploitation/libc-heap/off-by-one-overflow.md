# Off by one overflow

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Sadece 1B overflow eriÅŸimine sahip olmak, bir saldÄ±rganÄ±n bir sonraki chunk'Ä±n `size` alanÄ±nÄ± deÄŸiÅŸtirmesine olanak tanÄ±r. Bu, hangi chunk'larÄ±n gerÃ§ekten serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ± manipÃ¼le etmeyi saÄŸlar ve potansiyel olarak baÅŸka bir geÃ§erli chunk iÃ§eren bir chunk oluÅŸturabilir. SÃ¶mÃ¼rÃ¼, [double free](double-free.md) veya Ã¼st Ã¼ste binen chunk'lar ile benzerdir.

Ä°ki tÃ¼r off by one gÃ¼venlik aÃ§Ä±ÄŸÄ± vardÄ±r:

* Keyfi byte: Bu tÃ¼r, o byte'Ä± herhangi bir deÄŸerle Ã¼zerine yazmaya olanak tanÄ±r.
* Null byte (off-by-null): Bu tÃ¼r, o byte'Ä± yalnÄ±zca 0x00 ile Ã¼zerine yazmaya olanak tanÄ±r.
* Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n yaygÄ±n bir Ã¶rneÄŸi, `strlen` ve `strcpy` davranÄ±ÅŸÄ±nÄ±n tutarsÄ±z olduÄŸu aÅŸaÄŸÄ±daki kodda gÃ¶rÃ¼lebilir; bu, bir sonraki chunk'Ä±n baÅŸÄ±nda 0x00 byte'Ä± ayarlamaya olanak tanÄ±r.
* Bu, [House of Einherjar](house-of-einherjar.md) ile sÃ¶mÃ¼rÃ¼lebilir.
* Tcache kullanÄ±lÄ±yorsa, bu bir [double free](double-free.md) durumuna dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir.

<details>

<summary>Off-by-null</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

DiÄŸer kontrollerin yanÄ± sÄ±ra, artÄ±k bir parÃ§a serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda, Ã¶nceki boyut, meta verilerin parÃ§asÄ±nda yapÄ±landÄ±rÄ±lan boyut ile karÅŸÄ±laÅŸtÄ±rÄ±lmaktadÄ±r, bu da bu saldÄ±rÄ±yÄ± 2.28 sÃ¼rÃ¼mÃ¼nden itibaren oldukÃ§a karmaÅŸÄ±k hale getirmektedir.

### Kod Ã¶rneÄŸi:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Bu saldÄ±rÄ± artÄ±k Tcaches kullanÄ±mÄ± nedeniyle Ã§alÄ±ÅŸmamaktadÄ±r.
* AyrÄ±ca, daha bÃ¼yÃ¼k parÃ§alarÄ± kullanarak bunu kÃ¶tÃ¼ye kullanmaya Ã§alÄ±ÅŸÄ±rsanÄ±z (bu durumda tcaches dahil deÄŸildir), `malloc(): invalid next size (unsorted)` hatasÄ±nÄ± alÄ±rsÄ±nÄ±z.

### Hedef

* Bir parÃ§anÄ±n baÅŸka bir parÃ§anÄ±n iÃ§inde yer almasÄ±nÄ± saÄŸlamak, bÃ¶ylece o ikinci parÃ§aya yazma eriÅŸimi, iÃ§eridekini Ã¼zerine yazmaya izin verir.

### Gereksinimler

* Boyut meta verisi bilgisini deÄŸiÅŸtirmek iÃ§in off by one overflow.

### Genel off-by-one saldÄ±rÄ±sÄ±

* ÃœÃ§ parÃ§a `A`, `B` ve `C` (Ã¶rneÄŸin boyut 0x20) ayÄ±rÄ±n ve Ã¼st parÃ§ayla birleÅŸtirmeyi Ã¶nlemek iÃ§in baÅŸka bir parÃ§a ayÄ±rÄ±n.
* `C` parÃ§asÄ±nÄ± serbest bÄ±rakÄ±n (0x20 Tcache serbest listesine eklenmiÅŸtir).
* `A` parÃ§asÄ±nÄ± `B` Ã¼zerinde taÅŸmak iÃ§in kullanÄ±n. Off-by-one'Ä± kÃ¶tÃ¼ye kullanarak `B`'nin `size` alanÄ±nÄ± 0x21'den 0x41'e deÄŸiÅŸtirin.
* ArtÄ±k `B`, serbest parÃ§a `C`'yi iÃ§ermektedir.
* `B`'yi serbest bÄ±rakÄ±n ve 0x40 boyutunda bir parÃ§a ayÄ±rÄ±n (buraya tekrar yerleÅŸtirilecektir).
* Hala serbest olan `C`'nin `fd` iÅŸaretÃ§isini deÄŸiÅŸtirebiliriz (Tcache zehirlenmesi).

### Off-by-null saldÄ±rÄ±sÄ±

* 3 bellek parÃ§asÄ± (a, b, c) ardÄ±ÅŸÄ±k olarak ayrÄ±lÄ±r. ArdÄ±ndan ortadaki parÃ§a serbest bÄ±rakÄ±lÄ±r. Ä°lk parÃ§a bir off by one overflow aÃ§Ä±ÄŸÄ± iÃ§erir ve saldÄ±rgan bunu 0x00 ile kÃ¶tÃ¼ye kullanÄ±r (Ã¶nceki byte 0x10 olsaydÄ±, ortadaki parÃ§a gerÃ§ekte olduÄŸundan 0x10 daha kÃ¼Ã§Ã¼k olduÄŸunu gÃ¶sterirdi).
* ArdÄ±ndan, ortada serbest bÄ±rakÄ±lan parÃ§aya (b) 2 tane daha kÃ¼Ã§Ã¼k parÃ§a ayrÄ±lÄ±r, ancak `b + b->size` asla c parÃ§asÄ±nÄ± gÃ¼ncellemez Ã§Ã¼nkÃ¼ iÅŸaret edilen adres olmasÄ± gerekenin altÄ±ndadÄ±r.
* ArdÄ±ndan, b1 ve c serbest bÄ±rakÄ±lÄ±r. `c - c->prev_size` hala b'ye (ÅŸimdi b1) iÅŸaret ettiÄŸinden, her ikisi de tek bir parÃ§ada birleÅŸtirilir. Ancak, b2 hala b1 ve c arasÄ±nda iÃ§tedir.
* Son olarak, bu bellek alanÄ±nÄ± geri almak iÃ§in yeni bir malloc gerÃ§ekleÅŸtirilir ve bu alan aslÄ±nda b2'yi iÃ§erecektir, bu da yeni malloc'un sahibinin b2'nin iÃ§eriÄŸini kontrol etmesine izin verir.

Bu resim saldÄ±rÄ±yÄ± mÃ¼kemmel bir ÅŸekilde aÃ§Ä±klamaktadÄ±r:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## DiÄŸer Ã–rnekler & Referanslar

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Bon-nie-appetit. HTB Cyber Apocalypse CTF 2022**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/)
* `strlen`'in bir sonraki parÃ§anÄ±n `size` alanÄ±nÄ± dikkate almasÄ± nedeniyle off-by-one.
* Tcache kullanÄ±lÄ±yor, bu nedenle genel off-by-one saldÄ±rÄ±larÄ±, Tcache zehirlenmesi ile keyfi yazma ilkesini elde etmek iÃ§in Ã§alÄ±ÅŸÄ±r.
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* Off by one'Ä± kÃ¶tÃ¼ye kullanarak heap'ten bir adres sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r Ã§Ã¼nkÃ¼ bir dizeyi aÅŸan 0x00 byte'Ä±, bir sonraki alan tarafÄ±ndan Ã¼zerine yazÄ±lmaktadÄ±r.
* Keyfi yazma, iÅŸaretÃ§iyi baÅŸka bir yere iÅŸaret edecek ÅŸekilde sahte iÅŸaretÃ§ilerle sahte bir yapÄ± oluÅŸturmak iÃ§in off by one yazma aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanarak elde edilir. ArdÄ±ndan, bu yapÄ±nÄ±n iÅŸaretÃ§isini takip ederek keyfi yazma elde etmek mÃ¼mkÃ¼ndÃ¼r.
* libc adresi sÄ±zdÄ±rÄ±lÄ±r Ã§Ã¼nkÃ¼ heap mmap kullanÄ±larak geniÅŸletildiÄŸinde, mmap tarafÄ±ndan tahsis edilen bellek libc'den sabit bir ofset ile ayrÄ±lmÄ±ÅŸtÄ±r.
* Son olarak, keyfi yazma, `__free\_hook` adresine bir gadget ile yazmak iÃ§in kÃ¶tÃ¼ye kullanÄ±lÄ±r.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* KullanÄ±cÄ± giriÅŸi satÄ±rlarÄ±nÄ± okuyan `getline` fonksiyonunda bir NULL off by one aÃ§Ä±ÄŸÄ± vardÄ±r. Bu fonksiyon, iÃ§eriÄŸin "anahtarÄ±nÄ±" okumak iÃ§in kullanÄ±lÄ±r ve iÃ§eriÄŸi deÄŸil.
* YazÄ±mda 5 baÅŸlangÄ±Ã§ parÃ§asÄ± oluÅŸturulur:
* chunk1 (0x200)
* chunk2  (0x50)
* chunk5 (0x68)
* chunk3 (0x1f8)
* chunk4 (0xf0)
* Ã¼st parÃ§a ile birleÅŸtirmeyi Ã¶nlemek iÃ§in chunk defense (0x400)
* ArdÄ±ndan chunk 1, 5 ve 3 serbest bÄ±rakÄ±lÄ±r, bÃ¶ylece:
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* ArdÄ±ndan chunk3 (0x1f8) kÃ¶tÃ¼ye kullanÄ±larak null off-by-one, `prev_size`'i `0x4e0` olarak yazmaktadÄ±r.
* BaÅŸlangÄ±Ã§ta tahsis edilen chunk1, 2, 5 ve 3'Ã¼n boyutlarÄ±nÄ±n yanÄ± sÄ±ra bu parÃ§alarÄ±n baÅŸlÄ±klarÄ±nÄ±n toplamÄ± `0x4e0`'a eÅŸittir:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* ArdÄ±ndan, chunk 4 serbest bÄ±rakÄ±lÄ±r ve baÅŸlangÄ±ca kadar tÃ¼m parÃ§alarÄ± tÃ¼keten bir parÃ§a oluÅŸturur:
* ```python
[ 0x4e0 Chunk 1-2-5-3 (free) ] [ 0xf0 Chunk 4 (corrupted) ] [ 0x400 Chunk defense ]
```
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* ArdÄ±ndan, `0x200` byte ayrÄ±lÄ±r ve orijinal chunk 1 doldurulur.
* Ve baÅŸka bir 0x200 byte ayrÄ±lÄ±r ve chunk2 yok edilir ve bu nedenle hiÃ§bir sÄ±zdÄ±rma yoktur ve bu Ã§alÄ±ÅŸmaz mÄ±? Belki bu yapÄ±lmamalÄ±.
* ArdÄ±ndan, 0x58 "a" ile baÅŸka bir parÃ§a ayrÄ±lÄ±r (chunk2'yi Ã¼zerine yazar ve chunk5'e ulaÅŸÄ±r) ve chunk5'in hÄ±zlÄ± bin parÃ§asÄ±nÄ±n `fd`'sini `__malloc_hook`'a iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirir.
* ArdÄ±ndan, 0x68 boyutunda bir parÃ§a ayrÄ±lÄ±r, bÃ¶ylece `__malloc_hook`'taki sahte hÄ±zlÄ± bin parÃ§asÄ± bir sonraki hÄ±zlÄ± bin parÃ§asÄ±dÄ±r.
* Son olarak, 0x68 boyutunda yeni bir hÄ±zlÄ± bin parÃ§asÄ± ayrÄ±lÄ±r ve `__malloc_hook` bir `one_gadget` adresi ile Ã¼zerine yazÄ±lÄ±r.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **HackTricks'e ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek hacking ipuÃ§larÄ±nÄ± paylaÅŸÄ±n.**

</details>
{% endhint %}
