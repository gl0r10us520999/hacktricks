# Off by one overflow

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Imati pristup 1B overflow-u omoguÄ‡ava napadaÄu da izmeni polje `size` iz sledeÄ‡eg dela. Ovo omoguÄ‡ava manipulaciju kojim delovima se zapravo oslobaÄ‘aju, potencijalno generiÅ¡uÄ‡i deo koji sadrÅ¾i joÅ¡ jedan legitiman deo. Eksploatacija je sliÄna [double free](double-free.md) ili preklapajuÄ‡im delovima.

Postoje 2 tipa off by one ranjivosti:

* Arbitrarni bajt: Ova vrsta omoguÄ‡ava prepisivanje tog bajta bilo kojom vrednoÅ¡Ä‡u
* Null bajt (off-by-null): Ova vrsta omoguÄ‡ava prepisivanje tog bajta samo sa 0x00
* UobiÄajen primer ove ranjivosti moÅ¾e se videti u sledeÄ‡em kodu gde je ponaÅ¡anje `strlen` i `strcpy` nekonzistentno, Å¡to omoguÄ‡ava postavljanje 0x00 bajta na poÄetak sledeÄ‡eg dela.
* Ovo se moÅ¾e iskoristiti sa [House of Einherjar](house-of-einherjar.md).
* Ako se koristi Tcache, ovo se moÅ¾e iskoristiti za situaciju [double free](double-free.md).

<details>

<summary>Off-by-null</summary>
```c
// From https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off_by_one/
int main(void)
{
char buffer[40]="";
void *chunk1;
chunk1 = malloc(24);
puts("Get Input");
gets(buffer);
if(strlen(buffer)==24)
{
strcpy(chunk1,buffer);
}
return 0;
}
```
</details>

MeÄ‘u ostalim proverama, sada kada je deo slobodan, prethodna veliÄina se uporeÄ‘uje sa veliÄinom konfigurisanim u metapodacima dela, Å¡to ovu napad Äini priliÄno sloÅ¾enim od verzije 2.28.

### Primer koda:

* [https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c](https://github.com/DhavalKapil/heap-exploitation/blob/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/shrinking\_free\_chunks.c)
* Ovaj napad viÅ¡e ne funkcioniÅ¡e zbog koriÅ¡Ä‡enja Tcaches.
* Å taviÅ¡e, ako pokuÅ¡ate da ga zloupotrebite koristeÄ‡i veÄ‡e delove (tako da tcaches nisu ukljuÄeni), dobiÄ‡ete greÅ¡ku: `malloc(): invalid next size (unsorted)`

### Cilj

* Napraviti da deo bude sadrÅ¾an unutar drugog dela tako da pisanje pristupa preko tog drugog dela omoguÄ‡ava prepisivanje sadrÅ¾anog dela

### Zahtevi

* Off by one overflow za modifikaciju informacija o veliÄini metapodataka

### OpÅ¡ti off-by-one napad

* Alocirati tri dela `A`, `B` i `C` (recimo veliÄine 0x20), i joÅ¡ jedan da spreÄi konsolidaciju sa top-chunk.
* Osloboditi `C` (ubacen u 0x20 Tcache slobodnu listu).
* Koristiti deo `A` da preplavi `B`. Zloupotrebiti off-by-one da modifikujete polje `size` `B` sa 0x21 na 0x41.
* Sada imamo `B` koji sadrÅ¾i slobodan deo `C`
* Osloboditi `B` i alocirati 0x40 deo (biÄ‡e ponovo postavljen ovde)
* MoÅ¾emo modifikovati `fd` pokazivaÄ iz `C`, koji je joÅ¡ uvek slobodan (Tcache trovanje)

### Off-by-null napad

* 3 dela memorije (a, b, c) su rezervisana jedan za drugim. Zatim je srednji deo osloboÄ‘en. Prvi deo sadrÅ¾i ranjivost off by one overflow i napadaÄ je zloupotrebljava sa 0x00 (ako je prethodni bajt bio 0x10, to bi uÄinilo da srednji deo pokazuje da je 0x10 manji nego Å¡to zapravo jeste).
* Zatim, 2 manja dela su alocirana u osloboÄ‘enom delu (b), meÄ‘utim, poÅ¡to `b + b->size` nikada ne aÅ¾urira deo c jer je pokazana adresa manja nego Å¡to bi trebala.
* Zatim, b1 i c se oslobaÄ‘aju. PoÅ¡to `c - c->prev_size` joÅ¡ uvek pokazuje na b (sada b1), oba se konsoliduju u jedan deo. MeÄ‘utim, b2 je joÅ¡ uvek unutra izmeÄ‘u b1 i c.
* Na kraju, izvrÅ¡ava se nova malloc koja vraÄ‡a ovu memorijsku oblast koja Ä‡e zapravo sadrÅ¾ati b2, omoguÄ‡avajuÄ‡i vlasniku nove malloc da kontroliÅ¡e sadrÅ¾aj b2.

Ova slika savrÅ¡eno objaÅ¡njava napad:

<figure><img src="../../.gitbook/assets/image (1247).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks">https://heap-exploitation.dhavalkapil.com/attacks/shrinking_free_chunks</a></p></figcaption></figure>

## Ostali primeri i reference

* [**https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks**](https://heap-exploitation.dhavalkapil.com/attacks/shrinking\_free\_chunks)
* [**Bon-nie-appetit. HTB Cyber Apocalypse CTF 2022**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/bon-nie-appetit/)
* Off-by-one zbog `strlen` koji uzima u obzir polje `size` sledeÄ‡eg dela.
* Tcache se koristi, tako da opÅ¡ti off-by-one napadi funkcioniÅ¡u da dobiju proizvoljnu write primitivu sa Tcache trovanjem.
* [**Asis CTF 2016 b00ks**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#1-asis-ctf-2016-b00ks)
* MoguÄ‡e je zloupotrebiti off by one da se otkrije adresa iz heap-a jer bajt 0x00 na kraju stringa bude prepisan sledeÄ‡im poljem.
* Proizvoljno pisanje se dobija zloupotrebom off by one pisanja da se pokazivaÄ usmeri na drugo mesto gde Ä‡e biti izgraÄ‘ena laÅ¾na struktura sa laÅ¾nim pokazivaÄima. Zatim, moguÄ‡e je pratiti pokazivaÄ ove strukture da se dobije proizvoljno pisanje.
* libc adresa se otkriva jer ako se heap proÅ¡iri koristeÄ‡i mmap, memorija alocirana od mmap ima fiksni offset od libc.
* Na kraju, proizvoljno pisanje se zloupotrebljava da se piÅ¡e u adresu \_\_free\_hook sa jednim gadgetom.
* [**plaidctf 2015 plaiddb**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/off\_by\_one/#instance-2-plaidctf-2015-plaiddb)
* Postoji NULL off by one ranjivost u funkciji `getline` koja Äita linije korisniÄkog unosa. Ova funkcija se koristi za Äitanje "kljuÄa" sadrÅ¾aja, a ne samog sadrÅ¾aja.
* U pisanju se kreira 5 inicijalnih delova:
* chunk1 (0x200)
* chunk2  (0x50)
* chunk5 (0x68)
* chunk3 (0x1f8)
* chunk4 (0xf0)
* chunk odbrane (0x400) da se izbegne konsolidacija sa top chunk
* Zatim se oslobaÄ‘aju chunk 1, 5 i 3, tako da:
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* Zatim, zloupotrebljavajuÄ‡i chunk3 (0x1f8) se zloupotrebljava null off-by-one prepisujuÄ‡i prev\_size na `0x4e0`.
* Obratite paÅ¾nju na to kako veliÄine inicijalno alociranih chunk1, 2, 5 i 3 plus zaglavlja 4 od tih chunkova jednako je `0x4e0`:  `hex(0x1f8 + 0x10 + 0x68 + 0x10 + 0x50 + 0x10 + 0x200) = 0x4e0`
* Zatim, chunk 4 se oslobaÄ‘a, generiÅ¡uÄ‡i chunk koji konzumira sve delove do poÄetka:
* ```python
[ 0x4e0 Chunk 1-2-5-3 (free) ] [ 0xf0 Chunk 4 (corrupted) ] [ 0x400 Chunk defense ]
```
* ```python
[ 0x200 Chunk 1 (free) ] [ 0x50 Chunk 2 ] [ 0x68 Chunk 5 (free) ] [ 0x1f8 Chunk 3 (free) ] [ 0xf0 Chunk 4 ] [ 0x400 Chunk defense ]
```
* Zatim, alocira se `0x200` bajtova popunjavajuÄ‡i originalni chunk 1
* I joÅ¡ `0x200` bajtova se alocira i chunk2 se uniÅ¡tava i stoga nema viÅ¡e curenja i ovo ne funkcioniÅ¡e? MoÅ¾da ovo ne bi trebalo da se radi
* Zatim, alocira joÅ¡ jedan chunk sa 0x58 "a"s (prepisujuÄ‡i chunk2 i dosegnuvÅ¡i chunk5) i modifikuje `fd` brzog bin chunk-a chunk5 usmeravajuÄ‡i ga na `__malloc_hook`
* Zatim, alocira se chunk od 0x68 tako da laÅ¾ni brzi bin chunk u `__malloc_hook` bude sledeÄ‡i brzi bin chunk
* Na kraju, novi brzi bin chunk od 0x68 se alocira i `__malloc_hook` se prepisuje sa adresom `one_gadget`

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
