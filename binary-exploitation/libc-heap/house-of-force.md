# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

### Kod

* Ta technika zostaa zaatana ([**tutaj**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) i generuje ten bd: `malloc(): corrupted top size`
* Mo偶esz spr贸bowa [**kodu std**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html), aby go przetestowa, jeli chcesz.

### Cel

* Celem tego ataku jest mo偶liwo przydzielenia kawaka pamici pod okrelonym adresem.

### Wymagania

* Przepenienie, kt贸re pozwala na nadpisanie rozmiaru nag贸wka g贸rnego kawaka (np. -1).
* Mo偶liwo kontrolowania rozmiaru przydzielania pamici na stercie.

### Atak

Jeli atakujcy chce przydzieli kawaek pamici pod adresem P, aby nadpisa warto tutaj. Zaczyna od nadpisania rozmiaru g贸rnego kawaka wartoci `-1` (mo偶e za pomoc przepenienia). To zapewnia, 偶e malloc nie bdzie u偶ywa mmap do 偶adnego przydziau, poniewa偶 g贸rny kawaek zawsze bdzie mia wystarczajco du偶o miejsca.

Nastpnie oblicza odlego midzy adresem g贸rnego kawaka a docelow przestrzeni do przydzielenia. Dzieje si tak, poniewa偶 malloc o tym rozmiarze zostanie wykonany w celu przeniesienia g贸rnego kawaka na t pozycj. W ten spos贸b r贸偶nica/rozmiar mo偶e by atwo obliczona:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Zatem, przydzielenie rozmiaru `target - old_top - 4*sizeof(long)` (4 longi s potrzebne z powodu metadanych g贸rnego kawaka i nowego kawaka podczas alokacji) przeniesie g贸rny kawaek do adresu, kt贸ry chcemy nadpisa.\
Nastpnie, wykonaj kolejne malloc, aby uzyska kawaek pod docelowym adresem.

### Odniesienia i inne przykady

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Celem tego scenariusza jest ret2win, w kt贸rym musimy zmodyfikowa adres funkcji, kt贸ra ma by wywoana przez adres funkcji ret2win
* Program binarny ma przepenienie, kt贸re mo偶na wykorzysta do modyfikacji rozmiaru g贸rnego kawaka, kt贸ry jest zmieniany na -1 lub p64(0xffffffffffffffff)
* Nastpnie oblicza si adres miejsca, w kt贸rym znajduje si wska藕nik do nadpisania, a r贸偶nica od bie偶cej pozycji g贸rnego kawaka do tego miejsca jest alokowana za pomoc `malloc`
* Na koniec alokowany jest nowy kawaek, kt贸ry bdzie zawiera ten po偶dany cel wewntrz, kt贸ry jest nadpisywany przez funkcj ret2win
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* W `Input your name:` znajduje si pocztkowa luka, kt贸ra pozwala na wyciek adresu z heap
* Nastpnie w funkcjonalnoci `Org:` i `Host:` mo偶liwe jest wypenienie 64B wska藕nika `s`, gdy zapytano o **nazwa organizacji**, kt贸ra w stosie jest nastpnie ledzona przez adres v2, kt贸ry jest nastpnie ledzony przez wskazan **nazw hosta**. Poniewa偶 nastpnie, strcpy bdzie kopiowa zawarto s do kawaka o rozmiarze 64B, mo偶liwe jest **nadpisanie rozmiaru g贸rnego kawaka** danymi umieszczonymi w **nazwie hosta**.
* Teraz, gdy mo偶liwe jest dowolne zapisanie, GOT `atoi` zosta nadpisany adresem printf. Nastpnie mo偶liwe byo wyciekanie adresu `IO_2_1_stderr` _z_ `%24$p`. A z tym wyciekiem libc mo偶liwe byo ponowne nadpisanie GOT `atoi` adresem do `system` i wywoanie go, przekazujc jako parametr `/bin/sh`
* Alternatywna metoda [proponowana w tym innym opisie](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud) polega na nadpisaniu `free` z `puts`, a nastpnie dodaniu adresu `atoi@got`, w wska藕niku, kt贸ry p贸藕niej zostanie zwolniony, aby zosta wycieknity, a z tym wyciekiem ponownie nadpisa `atoi@got` z `system` i wywoa go z `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Istnieje UAF, kt贸ry pozwala na ponowne u偶ycie kawaka, kt贸ry zosta zwolniony bez wyczyszczenia wska藕nika. Poniewa偶 istniej pewne metody odczytu, mo偶liwe jest wyciekanie adresu libc, zapisujc wska藕nik do funkcji free w GOT tutaj, a nastpnie wywoujc funkcj odczytu.
* Nastpnie, House of force zosta u偶yty (wykorzystujc UAF) do nadpisania rozmiaru pozostaej przestrzeni na -1, alokowania kawaka wystarczajco du偶ego, aby dotrze do hooka free, a nastpnie alokowania kolejnego kawaka, kt贸ry bdzie zawiera hook free. Nastpnie, zapisz w hooku adres `system`, zapisz w kawaku `"/bin/sh"` i na koniec zwolnij kawaek z t zawartoci cigu.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
