# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### Code

* Ova tehnika je zakrpljena ([**ovde**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) i proizvodi ovu greÅ¡ku: `malloc(): corrupted top size`
* MoÅ¾ete probati [**kod odavde**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) da ga testirate ako Å¾elite.

### Goal

* Cilj ovog napada je da se omoguÄ‡i alokacija chunk-a na specifiÄnoj adresi.

### Requirements

* Overflow koji omoguÄ‡ava prepisivanje veliÄine zaglavlja gornjeg chunk-a (npr. -1).
* MoguÄ‡nost kontrole veliÄine alokacije na heap-u.

### Attack

Ako napadaÄ Å¾eli da alocira chunk na adresi P da bi prepisao vrednost ovde. PoÄinje prepisivanjem veliÄine gornjeg chunk-a sa `-1` (moÅ¾da sa overflow-om). Ovo osigurava da malloc neÄ‡e koristiti mmap za bilo koju alokaciju jer Ä‡e gornji chunk uvek imati dovoljno prostora.

Zatim, izraÄunava razdaljinu izmeÄ‘u adrese gornjeg chunk-a i ciljnog prostora za alokaciju. To je zato Å¡to Ä‡e se malloc sa tom veliÄinom izvrÅ¡iti kako bi se gornji chunk pomerio na tu poziciju. Ovako se razlika/veliÄina moÅ¾e lako izraÄunati:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Zato, alociranje veliÄine `target - old_top - 4*sizeof(long)` (4 long-ova su zbog metapodataka gornjeg dela i novog dela kada se alocira) Ä‡e pomeriti gornji deo na adresu koju Å¾elimo da prepiÅ¡emo.\
Zatim, uradite joÅ¡ jedan malloc da dobijete deo na ciljnoj adresi.

### References & Other Examples

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Cilj ovog scenarija je ret2win gde treba da modifikujemo adresu funkcije koja Ä‡e biti pozvana adresom ret2win funkcije
* Binarni fajl ima overflow koji se moÅ¾e iskoristiti za modifikaciju veliÄine gornjeg dela, koja se menja na -1 ili p64(0xffffffffffffffff)
* Zatim, izraÄunava se adresa do mesta gde se nalazi pokazivaÄ koji treba prepisati, a razlika od trenutne pozicije gornjeg dela do tamo se alocira sa `malloc`
* Na kraju se alocira novi deo koji Ä‡e sadrÅ¾ati ovu Å¾eljenu metu unutar koje se prepisuje funkcija ret2win
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* U `Input your name:` postoji inicijalna ranjivost koja omoguÄ‡ava da se iscuri adresa iz heap-a
* Zatim u `Org:` i `Host:` funkcionalnosti moguÄ‡e je popuniti 64B `s` pokazivaÄa kada se traÅ¾i **org name**, koji u steku sledi adresu v2, koja zatim sledi oznaÄenoj **host name**. Kako Ä‡e strcpy kopirati sadrÅ¾aj s u deo veliÄine 64B, moguÄ‡e je **prepisati veliÄinu gornjeg dela** sa podacima stavljenim unutar **host name**.
* Sada kada je proizvoljno pisanje moguÄ‡e, `atoi`-ov GOT je prepisan na adresu printf. tada je bilo moguÄ‡e iscuriti adresu `IO_2_1_stderr` _sa_ `%24$p`. I sa ovim libc leak-om bilo je moguÄ‡e ponovo prepisati `atoi`-ov GOT sa adresom `system` i pozvati ga prosledivÅ¡i kao parametar `/bin/sh`
* Alternativna metoda [predloÅ¾ena u ovom drugom izveÅ¡taju](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud) je da se prepisuje `free` sa `puts`, a zatim dodaje adresa `atoi@got`, u pokazivaÄ koji Ä‡e kasnije biti osloboÄ‘en tako da se iscuri i sa ovim leak-om ponovo prepisuje `atoi@got` sa `system` i poziva ga sa `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Postoji UAF koji omoguÄ‡ava ponovnu upotrebu dela koji je osloboÄ‘en bez brisanja pokazivaÄa. Zbog nekih metoda Äitanja, moguÄ‡e je iscuriti libc adresu pisanjem pokazivaÄa na funkciju free u GOT ovde i zatim pozivajuÄ‡i funkciju read.
* Zatim, House of force je koriÅ¡Ä‡en (zloupotrebljavajuÄ‡i UAF) da prepiÅ¡e veliÄinu preostalog prostora sa -1, alocira deo dovoljno veliki da doÄ‘e do free hook-a, a zatim alocira joÅ¡ jedan deo koji Ä‡e sadrÅ¾ati free hook. Zatim, upisuje u hook adresu `system`, upisuje u deo `"/bin/sh"` i konaÄno oslobaÄ‘a deo sa tim sadrÅ¾ajem stringa.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
