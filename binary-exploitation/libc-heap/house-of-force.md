# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### Code

* ì´ ê¸°ìˆ ì€ íŒ¨ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤ ([**ì—¬ê¸°**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) ê·¸ë¦¬ê³  ì´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤: `malloc(): corrupted top size`
* ì›í•˜ì‹ ë‹¤ë©´ [**ì—¬ê¸°ì„œ ì½”ë“œ**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)ë¥¼ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Goal

* ì´ ê³µê²©ì˜ ëª©í‘œëŠ” íŠ¹ì • ì£¼ì†Œì— ì²­í¬ë¥¼ í• ë‹¹í•  ìˆ˜ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.

### Requirements

* ìƒë‹¨ ì²­í¬ í—¤ë”ì˜ í¬ê¸°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆëŠ” ì˜¤ë²„í”Œë¡œìš° (ì˜ˆ: -1).
* í™ í• ë‹¹ì˜ í¬ê¸°ë¥¼ ì œì–´í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### Attack

ê³µê²©ìê°€ ì£¼ì†Œ Pì— ì²­í¬ë¥¼ í• ë‹¹í•˜ì—¬ ì—¬ê¸°ì˜ ê°’ì„ ë®ì–´ì“°ê³  ì‹¶ë‹¤ë©´, ê·¸ëŠ” ìƒë‹¨ ì²­í¬ í¬ê¸°ë¥¼ `-1`ë¡œ ë®ì–´ì“°ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤ (ì•„ë§ˆë„ ì˜¤ë²„í”Œë¡œìš°ë¡œ). ì´ë ‡ê²Œ í•˜ë©´ mallocì´ ì–´ë–¤ í• ë‹¹ì—ë„ mmapì„ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìƒë‹¨ ì²­í¬ëŠ” í•­ìƒ ì¶©ë¶„í•œ ê³µê°„ì„ ê°€ì§ˆ ê²ƒì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, ìƒë‹¨ ì²­í¬ì˜ ì£¼ì†Œì™€ í• ë‹¹í•  ëŒ€ìƒ ê³µê°„ ì‚¬ì´ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ì´ëŠ” í•´ë‹¹ í¬ê¸°ë¡œ mallocì´ ìˆ˜í–‰ë˜ì–´ ìƒë‹¨ ì²­í¬ë¥¼ ê·¸ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚¤ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì°¨ì´/í¬ê¸°ë¥¼ ì‰½ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
ë”°ë¼ì„œ `target - old_top - 4*sizeof(long)` í¬ê¸°ë¥¼ í• ë‹¹í•˜ë©´(4ê°œì˜ longì€ ìƒë‹¨ ì²­í¬ì˜ ë©”íƒ€ë°ì´í„°ì™€ í• ë‹¹ëœ ìƒˆ ì²­í¬ì˜ ë©”íƒ€ë°ì´í„° ë•Œë¬¸ì…ë‹ˆë‹¤) ìƒë‹¨ ì²­í¬ë¥¼ ìš°ë¦¬ê°€ ë®ì–´ì“°ê³ ì í•˜ëŠ” ì£¼ì†Œë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤.\
ê·¸ëŸ° ë‹¤ìŒ, ëª©í‘œ ì£¼ì†Œì—ì„œ ì²­í¬ë¥¼ ì–»ê¸° ìœ„í•´ ë˜ ë‹¤ë¥¸ mallocì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### References & Other Examples

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* ì´ ì‹œë‚˜ë¦¬ì˜¤ì˜ ëª©í‘œëŠ” ret2winìœ¼ë¡œ, ret2win í•¨ìˆ˜ì˜ ì£¼ì†Œì— ì˜í•´ í˜¸ì¶œë  í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
* ì´ ë°”ì´ë„ˆë¦¬ëŠ” ìƒë‹¨ ì²­í¬ í¬ê¸°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì˜¤ë²„í”Œë¡œìš°ê°€ ìˆìœ¼ë©°, ì´ëŠ” -1 ë˜ëŠ” p64(0xffffffffffffffff)ë¡œ ìˆ˜ì •ë©ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ ë®ì–´ì“¸ í¬ì¸í„°ê°€ ì¡´ì¬í•˜ëŠ” ìœ„ì¹˜ì˜ ì£¼ì†Œë¥¼ ê³„ì‚°í•˜ê³ , í˜„ì¬ ìƒë‹¨ ì²­í¬ì˜ ìœ„ì¹˜ì—ì„œ ê·¸ê³³ê¹Œì§€ì˜ ì°¨ì´ë¥¼ `malloc`ìœ¼ë¡œ í• ë‹¹í•©ë‹ˆë‹¤.
* ë§ˆì§€ë§‰ìœ¼ë¡œ, ì´ ì›í•˜ëŠ” ëª©í‘œë¥¼ í¬í•¨í•  ìƒˆë¡œìš´ ì²­í¬ê°€ í• ë‹¹ë˜ë©°, ì´ëŠ” ret2win í•¨ìˆ˜ì— ì˜í•´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `Input your name:`ì—ëŠ” í™ì—ì„œ ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆëŠ” ì´ˆê¸° ì·¨ì•½ì ì´ ìˆìŠµë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ `Org:` ë° `Host:` ê¸°ëŠ¥ì—ì„œ **org name**ì„ ìš”ì²­í•  ë•Œ `s` í¬ì¸í„°ì˜ 64Bë¥¼ ì±„ìš¸ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ìŠ¤íƒì—ì„œ v2ì˜ ì£¼ì†Œ ë‹¤ìŒì— ìœ„ì¹˜í•˜ê³ , ê·¸ ë‹¤ìŒì— ì§€ì •ëœ **host name**ì´ ì˜µë‹ˆë‹¤. ì´í›„, strcpyê°€ sì˜ ë‚´ìš©ì„ 64B í¬ê¸°ì˜ ì²­í¬ì— ë³µì‚¬í•˜ë¯€ë¡œ, **host name**ì— ë„£ì€ ë°ì´í„°ë¡œ **ìƒë‹¨ ì²­í¬ì˜ í¬ê¸°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
* ì´ì œ ì„ì˜ì˜ ì“°ê¸°ê°€ ê°€ëŠ¥í•´ì§€ë©´, `atoi`ì˜ GOTê°€ printfì˜ ì£¼ì†Œë¡œ ë®ì–´ì”Œì›Œì¡ŒìŠµë‹ˆë‹¤. ê·¸ í›„ `%24$p`ë¡œ `IO_2_1_stderr`ì˜ ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ libc ëˆ„ì¶œë¡œ `atoi`ì˜ GOTë¥¼ ë‹¤ì‹œ `system`ì˜ ì£¼ì†Œë¡œ ë®ì–´ì“°ê³ , `/bin/sh`ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•˜ì—¬ í˜¸ì¶œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
* [ì´ ë‹¤ë¥¸ ê¸€ì—ì„œ ì œì•ˆëœ ëŒ€ì•ˆ ë°©ë²•](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud)ì€ `free`ë¥¼ `puts`ë¡œ ë®ì–´ì“°ê³ , ë‚˜ì¤‘ì— í•´ì œë  í¬ì¸í„°ì— `atoi@got`ì˜ ì£¼ì†Œë¥¼ ì¶”ê°€í•˜ì—¬ ëˆ„ì¶œë˜ë„ë¡ í•œ ë‹¤ìŒ, ì´ ëˆ„ì¶œë¡œ ë‹¤ì‹œ `atoi@got`ì„ `system`ìœ¼ë¡œ ë®ì–´ì“°ê³  `/bin/sh`ë¡œ í˜¸ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* í¬ì¸í„°ë¥¼ ì§€ìš°ì§€ ì•Šê³  í•´ì œëœ ì²­í¬ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” UAFê°€ ìˆìŠµë‹ˆë‹¤. ì¼ë¶€ ì½ê¸° ë©”ì„œë“œê°€ ìˆê¸° ë•Œë¬¸ì—, ì—¬ê¸°ì—ì„œ free í•¨ìˆ˜ì˜ í¬ì¸í„°ë¥¼ GOTì— ì‘ì„±í•˜ì—¬ libc ì£¼ì†Œë¥¼ ëˆ„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ ì½ê¸° í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, House of forceê°€ ì‚¬ìš©ë˜ì–´(UAFë¥¼ ì•…ìš©í•˜ì—¬) ë‚¨ì€ ê³µê°„ì˜ í¬ê¸°ë¥¼ -1ë¡œ ë®ì–´ì“°ê³ , free hookì— ë„ë‹¬í•  ìˆ˜ ìˆì„ ë§Œí¼ í° ì²­í¬ë¥¼ í• ë‹¹í•œ ë‹¤ìŒ, free hookì„ í¬í•¨í•  ë˜ ë‹¤ë¥¸ ì²­í¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ hookì— `system`ì˜ ì£¼ì†Œë¥¼ ì‘ì„±í•˜ê³ , ì²­í¬ì— `"/bin/sh"`ë¥¼ ì‘ì„±í•œ í›„, í•´ë‹¹ ë¬¸ìì—´ ë‚´ìš©ì„ ê°€ì§„ ì²­í¬ë¥¼ í•´ì œí•©ë‹ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
