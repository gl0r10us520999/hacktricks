# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

### Kod

* Bu teknik yamanmÄ±ÅŸtÄ±r ([**burada**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) ve bu hatayÄ± Ã¼retir: `malloc(): corrupted top size`
* Ä°sterseniz bunu test etmek iÃ§in [**kod buradan**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) deneyebilirsiniz.

### Hedef

* Bu saldÄ±rÄ±nÄ±n hedefi, belirli bir adreste bir parÃ§a ayÄ±rabilmektir.

### Gereksinimler

* Ãœst parÃ§a baÅŸlÄ±ÄŸÄ±nÄ±n boyutunu (Ã¶rneÄŸin -1) yazmayÄ± saÄŸlayan bir taÅŸma.
* YÄ±ÄŸÄ±n tahsisi boyutunu kontrol edebilmek.

### SaldÄ±rÄ±

EÄŸer bir saldÄ±rgan, burada bir deÄŸeri yazmak iÃ§in P adresinde bir parÃ§a ayÄ±rmak istiyorsa, Ã¼st parÃ§a boyutunu `-1` ile (belki bir taÅŸma ile) yazmaya baÅŸlar. Bu, malloc'un herhangi bir tahsis iÃ§in mmap kullanmayacaÄŸÄ±ndan emin olur Ã§Ã¼nkÃ¼ Ãœst parÃ§a her zaman yeterli alana sahip olacaktÄ±r.

Sonra, Ã¼st parÃ§anÄ±n adresi ile tahsis edilecek hedef alan arasÄ±ndaki mesafeyi hesaplayÄ±n. Bunun nedeni, o boyutta bir malloc'un, Ã¼st parÃ§ayÄ± o konuma taÅŸÄ±mak iÃ§in yapÄ±lacak olmasÄ±dÄ±r. Fark/boyutun nasÄ±l kolayca hesaplanabileceÄŸi ÅŸÃ¶yle:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Bu nedenle, `target - old_top - 4*sizeof(long)` boyutunda bir alan ayÄ±rmak (4 long, Ã¼st parÃ§a ve yeni parÃ§a iÃ§in meta veriler nedeniyle) Ã¼st parÃ§ayÄ± yazmak istediÄŸimiz adrese taÅŸÄ±yacaktÄ±r.\
Sonra, hedef adreste bir parÃ§a almak iÃ§in baÅŸka bir malloc yapÄ±n.

### Referanslar ve DiÄŸer Ã–rnekler

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Bu senaryonun amacÄ±, ret2win fonksiyonunun adresi tarafÄ±ndan Ã§aÄŸrÄ±lacak bir fonksiyonun adresini deÄŸiÅŸtirmektir.
* Ä°kili dosyada, Ã¼st parÃ§a boyutunu deÄŸiÅŸtirmek iÃ§in istismar edilebilecek bir taÅŸma vardÄ±r; bu, -1 veya p64(0xffffffffffffffff) olarak deÄŸiÅŸtirilir.
* Sonra, yazÄ±lacak yerin adresi hesaplanÄ±r ve Ã¼st parÃ§anÄ±n mevcut konumundan oraya olan fark `malloc` ile ayrÄ±lÄ±r.
* Son olarak, iÃ§inde bu istenen hedefi barÄ±ndÄ±racak yeni bir parÃ§a ayrÄ±lÄ±r; bu, ret2win fonksiyonu tarafÄ±ndan Ã¼zerine yazÄ±lÄ±r.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `Input your name:` kÄ±smÄ±nda, heap'ten bir adres sÄ±zdÄ±rmaya izin veren bir baÅŸlangÄ±Ã§ zafiyeti vardÄ±r.
* Sonra `Org:` ve `Host:` iÅŸlevselliÄŸinde, **org adÄ±** istendiÄŸinde `s` iÅŸaretÃ§isinin 64B'sini doldurmak mÃ¼mkÃ¼ndÃ¼r; bu, yÄ±ÄŸÄ±nda v2'nin adresinden sonra gelir ve ardÄ±ndan belirtilen **host adÄ±** gelir. SonrasÄ±nda, strcpy `s`'nin iÃ§eriÄŸini 64B boyutundaki bir parÃ§aya kopyalayacaÄŸÄ± iÃ§in, **host adÄ±** iÃ§ine yerleÅŸtirilen verilerle **Ã¼st parÃ§anÄ±n boyutunu** **Ã¼zerine yazmak** mÃ¼mkÃ¼ndÃ¼r.
* ArtÄ±k keyfi yazma mÃ¼mkÃ¼n olduÄŸuna gÃ¶re, `atoi`'nin GOT'u printf'in adresi ile Ã¼zerine yazÄ±ldÄ±. Bu sayede `%24$p` ile `IO_2_1_stderr` adresi sÄ±zdÄ±rÄ±labildi. Ve bu libc sÄ±zÄ±ntÄ±sÄ± ile `atoi`'nin GOT'u tekrar `system` adresi ile Ã¼zerine yazÄ±ldÄ± ve parametre olarak `/bin/sh` geÃ§ildi.
* [Bu diÄŸer yazÄ±da Ã¶nerilen alternatif bir yÃ¶ntem](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), `free`'yi `puts` ile Ã¼zerine yazmak ve sonra daha sonra serbest bÄ±rakÄ±lacak iÅŸaretÃ§iye `atoi@got` adresini eklemektir; bÃ¶ylece sÄ±zdÄ±rÄ±lÄ±r ve bu sÄ±zÄ±ntÄ± ile tekrar `atoi@got`'u `system` ile Ã¼zerine yazmak ve `/bin/sh` ile Ã§aÄŸÄ±rmak mÃ¼mkÃ¼ndÃ¼r.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* TemizlenmemiÅŸ bir iÅŸaretÃ§i ile serbest bÄ±rakÄ±lmÄ±ÅŸ bir parÃ§ayÄ± yeniden kullanmaya izin veren bir UAF vardÄ±r. BazÄ± okuma yÃ¶ntemleri nedeniyle, burada free fonksiyonuna bir iÅŸaretÃ§i yazarak bir libc adresi sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r ve ardÄ±ndan okuma fonksiyonu Ã§aÄŸrÄ±lÄ±r.
* Sonra, UAF'yi istismar ederek, kalan alanÄ±n boyutunu -1 ile Ã¼zerine yazmak, serbest bÄ±rakma kancasÄ± iÃ§in yeterince bÃ¼yÃ¼k bir parÃ§a ayÄ±rmak ve ardÄ±ndan serbest bÄ±rakma kancasÄ±nÄ± iÃ§erecek baÅŸka bir parÃ§a ayÄ±rmak iÃ§in House of force kullanÄ±ldÄ±. ArdÄ±ndan, kancaya `system` adresini yazÄ±n, bir parÃ§aya `"/bin/sh"` yazÄ±n ve son olarak bu dize iÃ§eriÄŸi ile parÃ§ayÄ± serbest bÄ±rakÄ±n.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
