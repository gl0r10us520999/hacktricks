# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

### Code

* Cette technique a √©t√© corrig√©e ([**ici**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) et produit cette erreur : `malloc(): corrupted top size`
* Vous pouvez essayer le [**code d'ici**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) pour le tester si vous le souhaitez.

### Objectif

* L'objectif de cette attaque est de pouvoir allouer un chunk √† une adresse sp√©cifique.

### Exigences

* Un d√©passement qui permet d'√©craser la taille de l'en-t√™te du chunk sup√©rieur (par exemple -1).
* √ätre capable de contr√¥ler la taille de l'allocation de tas.

### Attaque

Si un attaquant veut allouer un chunk √† l'adresse P pour √©craser une valeur ici. Il commence par √©craser la taille du chunk sup√©rieur avec `-1` (peut-√™tre avec un d√©passement). Cela garantit que malloc n'utilisera pas mmap pour toute allocation, car le chunk sup√©rieur aura toujours suffisamment d'espace.

Ensuite, calculez la distance entre l'adresse du chunk sup√©rieur et l'espace cible √† allouer. C'est parce qu'un malloc avec cette taille sera effectu√© afin de d√©placer le chunk sup√©rieur √† cette position. C'est ainsi que la diff√©rence/taille peut √™tre facilement calcul√©e :
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Donc, allouer une taille de `target - old_top - 4*sizeof(long)` (les 4 longs sont dus aux m√©tadonn√©es du top chunk et du nouveau chunk lors de l'allocation) d√©placera le top chunk √† l'adresse que nous voulons √©craser.\
Ensuite, effectuez un autre malloc pour obtenir un chunk √† l'adresse cible.

### R√©f√©rences & Autres Exemples

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* L'objectif de ce sc√©nario est un ret2win o√π nous devons modifier l'adresse d'une fonction qui va √™tre appel√©e par l'adresse de la fonction ret2win.
* Le binaire a un d√©bordement qui peut √™tre exploit√© pour modifier la taille du top chunk, qui est modifi√©e √† -1 ou p64(0xffffffffffffffff).
* Ensuite, l'adresse de l'endroit o√π le pointeur √† √©craser existe est calcul√©e, et la diff√©rence entre la position actuelle du top chunk et cet endroit est allou√©e avec `malloc`.
* Enfin, un nouveau chunk est allou√© qui contiendra cette cible d√©sir√©e √† l'int√©rieur, qui est √©cras√©e par la fonction ret2win.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* Dans le `Input your name:`, il y a une vuln√©rabilit√© initiale qui permet de leak une adresse de la heap.
* Ensuite, dans la fonctionnalit√© `Org:` et `Host:`, il est possible de remplir les 64B du pointeur `s` lorsqu'on demande le **nom de l'organisation**, qui dans la pile est suivi par l'adresse de v2, qui est ensuite suivi par le **nom d'h√¥te** indiqu√©. Comme ensuite, strcpy va copier le contenu de s dans un chunk de taille 64B, il est possible de **√©craser la taille du top chunk** avec les donn√©es mises √† l'int√©rieur du **nom d'h√¥te**.
* Maintenant que l'√©criture arbitraire est possible, le GOT de `atoi` a √©t√© √©cras√© √† l'adresse de printf. Il a alors √©t√© possible de leak l'adresse de `IO_2_1_stderr` _avec_ `%24$p`. Et avec ce leak libc, il a √©t√© possible d'√©craser √† nouveau le GOT de `atoi` avec l'adresse de `system` et de l'appeler en passant comme param√®tre `/bin/sh`.
* Une m√©thode alternative [propos√©e dans cet autre article](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud) consiste √† √©craser `free` avec `puts`, puis √† ajouter l'adresse de `atoi@got`, dans le pointeur qui sera ensuite lib√©r√© afin qu'il soit leak√© et avec ce leak √©craser √† nouveau `atoi@got` avec `system` et l'appeler avec `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Il y a un UAF permettant de r√©utiliser un chunk qui a √©t√© lib√©r√© sans effacer le pointeur. En raison de certaines m√©thodes de lecture, il est possible de leak une adresse libc en √©crivant un pointeur vers la fonction free dans le GOT ici, puis en appelant la fonction de lecture.
* Ensuite, House of force a √©t√© utilis√© (abusant de l'UAF) pour √©craser la taille de l'espace restant avec un -1, allouer un chunk suffisamment grand pour atteindre le hook free, puis allouer un autre chunk qui contiendra le hook free. Ensuite, √©crire dans le hook l'adresse de `system`, √©crire dans un chunk `"/bin/sh"` et enfin lib√©rer le chunk avec ce contenu de cha√Æne.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
