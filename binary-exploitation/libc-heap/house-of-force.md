# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

### Code

* Diese Technik wurde gepatcht ([**hier**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) und erzeugt diesen Fehler: `malloc(): corrupted top size`
* Du kannst den [**Code von hier**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) ausprobieren, um ihn zu testen, wenn du m√∂chtest.

### Ziel

* Das Ziel dieses Angriffs ist es, einen Chunk an einer bestimmten Adresse zuzuweisen.

### Anforderungen

* Ein √úberlauf, der es erm√∂glicht, die Gr√∂√üe des Top-Chunks-Headers zu √ºberschreiben (z.B. -1).
* In der Lage sein, die Gr√∂√üe der Heap-Zuweisung zu kontrollieren.

### Angriff

Wenn ein Angreifer einen Chunk an der Adresse P zuweisen m√∂chte, um hier einen Wert zu √ºberschreiben. Er beginnt damit, die Gr√∂√üe des Top-Chunks mit `-1` zu √ºberschreiben (vielleicht mit einem √úberlauf). Dies stellt sicher, dass malloc mmap f√ºr keine Zuweisung verwenden wird, da der Top-Chunk immer gen√ºgend Platz haben wird.

Dann berechne den Abstand zwischen der Adresse des Top-Chunks und dem Zielbereich, der zugewiesen werden soll. Dies liegt daran, dass eine malloc mit dieser Gr√∂√üe durchgef√ºhrt wird, um den Top-Chunk an diese Position zu verschieben. So kann der Unterschied/die Gr√∂√üe leicht berechnet werden:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Daher wird die Zuweisung einer Gr√∂√üe von `target - old_top - 4*sizeof(long)` (die 4 longs sind wegen der Metadaten des oberen Chunks und des neuen Chunks bei der Zuweisung) den oberen Chunk an die Adresse verschieben, die wir √ºberschreiben m√∂chten.\
Dann f√ºhren Sie eine weitere malloc durch, um einen Chunk an der Zieladresse zu erhalten.

### Referenzen & Weitere Beispiele

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Das Ziel dieses Szenarios ist ein ret2win, bei dem wir die Adresse einer Funktion √§ndern m√ºssen, die durch die Adresse der ret2win-Funktion aufgerufen wird.
* Die Bin√§rdatei hat einen √úberlauf, der ausgenutzt werden kann, um die Gr√∂√üe des oberen Chunks zu √§ndern, die auf -1 oder p64(0xffffffffffffffff) ge√§ndert wird.
* Dann wird die Adresse zu dem Ort berechnet, an dem der Zeiger zum √úberschreiben existiert, und die Differenz von der aktuellen Position des oberen Chunks dorthin wird mit `malloc` zugewiesen.
* Schlie√ülich wird ein neuer Chunk zugewiesen, der dieses gew√ºnschte Ziel enth√§lt, das von der ret2win-Funktion √ºberschrieben wird.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* Im `Input your name:` gibt es eine anf√§ngliche Schwachstelle, die es erm√∂glicht, eine Adresse aus dem Heap zu leaken.
* Dann ist es in der `Org:` und `Host:` Funktionalit√§t m√∂glich, die 64B des `s` Zeigers auszuf√ºllen, wenn nach dem **org name** gefragt wird, der im Stack von der Adresse von v2 gefolgt wird, die dann von dem angegebenen **host name** gefolgt wird. Da strcpy dann den Inhalt von s in einen Chunk der Gr√∂√üe 64B kopiert, ist es m√∂glich, **die Gr√∂√üe des oberen Chunks zu √ºberschreiben** mit den Daten, die im **host name** eingegeben wurden.
* Jetzt, da ein beliebiges Schreiben m√∂glich ist, wurde die GOT von `atoi` auf die Adresse von printf √ºberschrieben. Es war dann m√∂glich, die Adresse von `IO_2_1_stderr` _mit_ `%24$p` zu leaken. Und mit diesem libc-Leak war es m√∂glich, die GOT von `atoi` erneut mit der Adresse von `system` zu √ºberschreiben und sie mit `/bin/sh` aufzurufen.
* Eine alternative Methode [vorgeschlagen in diesem anderen Bericht](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud) besteht darin, `free` mit `puts` zu √ºberschreiben und dann die Adresse von `atoi@got` in den Zeiger einzuf√ºgen, der sp√§ter freigegeben wird, sodass er geleakt wird und mit diesem Leak erneut `atoi@got` mit `system` √ºberschrieben wird und es mit `/bin/sh` aufgerufen wird.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Es gibt ein UAF, das es erm√∂glicht, einen Chunk wiederzuverwenden, der freigegeben wurde, ohne den Zeiger zu l√∂schen. Da es einige Lese-Methoden gibt, ist es m√∂glich, eine libc-Adresse zu leaken, indem man einen Zeiger auf die Free-Funktion in der GOT hier schreibt und dann die Lese-Funktion aufruft.
* Dann wurde House of Force verwendet (Missbrauch des UAF), um die Gr√∂√üe des verbleibenden Raums mit -1 zu √ºberschreiben, einen Chunk gro√ü genug zuzuweisen, um zum Free-Hook zu gelangen, und dann einen weiteren Chunk zuzuweisen, der den Free-Hook enthalten wird. Dann wird in den Hook die Adresse von `system` geschrieben, in einen Chunk `"/bin/sh"` geschrieben und schlie√ülich der Chunk mit diesem String-Inhalt freigegeben.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
