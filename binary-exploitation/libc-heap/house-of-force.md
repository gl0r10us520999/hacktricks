# House of Force



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

### ã‚³ãƒ¼ãƒ‰

* ã“ã®æŠ€è¡“ã¯ãƒ‘ãƒƒãƒãŒå½“ã¦ã‚‰ã‚Œã¾ã—ãŸ ([**ã“ã¡ã‚‰**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) ãã—ã¦ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™: `malloc(): corrupted top size`
* ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯ã€[**ã“ã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### ç›®æ¨™

* ã“ã®æ”»æ’ƒã®ç›®æ¨™ã¯ã€ç‰¹å®šã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

### è¦ä»¶

* ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’ä¸Šæ›¸ãã§ãã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ (ä¾‹: -1)ã€‚
* ãƒ’ãƒ¼ãƒ—å‰²ã‚Šå½“ã¦ã®ã‚µã‚¤ã‚ºã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ã€‚

### æ”»æ’ƒ

æ”»æ’ƒè€…ãŒã‚¢ãƒ‰ãƒ¬ã‚¹Pã«ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¦ã“ã“ã«å€¤ã‚’ä¸Šæ›¸ãã—ãŸã„å ´åˆã€å½¼ã¯ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã‚’ `-1` ã§ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ (ãŠãã‚‰ãã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ã£ã¦)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¯å¸¸ã«ååˆ†ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒã¤ãŸã‚ã€mallocã¯ã©ã®å‰²ã‚Šå½“ã¦ã‚‚mmapã‚’ä½¿ç”¨ã—ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

æ¬¡ã«ã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨å‰²ã‚Šå½“ã¦ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒšãƒ¼ã‚¹ã®é–“ã®è·é›¢ã‚’è¨ˆç®—ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãã®ã‚µã‚¤ã‚ºã®mallocãŒå®Ÿè¡Œã•ã‚Œã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ãŒãã®ä½ç½®ã«ç§»å‹•ã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚ã“ã‚ŒãŒã€å·®åˆ†/ã‚µã‚¤ã‚ºã‚’ç°¡å˜ã«è¨ˆç®—ã§ãã‚‹æ–¹æ³•ã§ã™:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
ã—ãŸãŒã£ã¦ã€`target - old_top - 4*sizeof(long)`ã®ã‚µã‚¤ã‚ºã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ï¼ˆ4ã¤ã®longã¯ã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¨æ–°ã—ãå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ï¼‰ã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã‚’ä¸Šæ›¸ãã—ãŸã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç§»å‹•ã•ã›ã¾ã™ã€‚\
æ¬¡ã«ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã‚‚ã†ä¸€åº¦mallocã‚’è¡Œã„ã¾ã™ã€‚

### å‚è€ƒæ–‡çŒ®ã¨ä»–ã®ä¾‹

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* ã“ã®ã‚·ãƒŠãƒªã‚ªã®ç›®çš„ã¯ã€ret2winã®ãŸã‚ã«ã€ret2winé–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã™ã€‚
* ãƒã‚¤ãƒŠãƒªã«ã¯ã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã§ãã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯-1ã¾ãŸã¯p64(0xffffffffffffffff)ã«å¤‰æ›´ã•ã‚Œã¾ã™ã€‚
* æ¬¡ã«ã€ä¸Šæ›¸ãã™ã‚‹ãƒã‚¤ãƒ³ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´æ‰€ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨ˆç®—ã•ã‚Œã€ãã“ã¸ã®ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã®ç¾åœ¨ã®ä½ç½®ã‹ã‚‰ã®å·®åˆ†ãŒ`malloc`ã§å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚
* æœ€å¾Œã«ã€ã“ã®æœ›ã¾ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å«ã‚€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã€ã“ã‚Œã¯ret2winé–¢æ•°ã«ã‚ˆã£ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `Input your name:`ã«ã¯ã€ãƒ’ãƒ¼ãƒ—ã‹ã‚‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã‚‹åˆæœŸã®è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ã€‚
* æ¬¡ã«ã€`Org:`ãŠã‚ˆã³`Host:`æ©Ÿèƒ½ã§ã¯ã€**org name**ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã¨ãã«`s`ãƒã‚¤ãƒ³ã‚¿ã®64Bã‚’åŸ‹ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã¯ã‚¹ã‚¿ãƒƒã‚¯å†…ã§v2ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¾Œã«ç¶šãã€ãã®å¾Œã«æŒ‡å®šã•ã‚ŒãŸ**host name**ãŒç¶šãã¾ã™ã€‚strcpyãŒsã®å†…å®¹ã‚’64Bã®ãƒãƒ£ãƒ³ã‚¯ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ãŸã‚ã€**host name**ã«å…¥ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§**ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’ä¸Šæ›¸ãã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
* ä»»æ„ã®æ›¸ãè¾¼ã¿ãŒå¯èƒ½ã«ãªã£ãŸä»Šã€`atoi`ã®GOTã¯printfã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ä¸Šæ›¸ãã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`IO_2_1_stderr`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’`%24$p`ã§æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã®libcã®æ¼æ´©ã«ã‚ˆã‚Šã€å†åº¦`atoi`ã®GOTã‚’`system`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¸Šæ›¸ãã—ã€`/bin/sh`ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
* [ã“ã®åˆ¥ã®æ›¸ãè¾¼ã¿ã§ææ¡ˆã•ã‚ŒãŸä»£æ›¿æ–¹æ³•](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud)ã¯ã€`free`ã‚’`puts`ã§ä¸Šæ›¸ãã—ã€ãã®å¾Œã€å¾Œã§è§£æ”¾ã•ã‚Œã‚‹ãƒã‚¤ãƒ³ã‚¿ã«`atoi@got`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šæ¼æ´©ã—ã€ã“ã®æ¼æ´©ã‚’ä½¿ã£ã¦å†åº¦`atoi@got`ã‚’`system`ã§ä¸Šæ›¸ãã—ã€`/bin/sh`ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚¯ãƒªã‚¢ã›ãšã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’å†åˆ©ç”¨ã§ãã‚‹UAFãŒã‚ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®èª­ã¿å–ã‚Šãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§freeé–¢æ•°ã®ãƒã‚¤ãƒ³ã‚¿ã‚’GOTã«æ›¸ãè¾¼ã‚€ã“ã¨ã§libcã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã€ãã®å¾Œèª­ã¿å–ã‚Šé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
* æ¬¡ã«ã€House of forceãŒä½¿ç”¨ã•ã‚Œï¼ˆUAFã‚’æ‚ªç”¨ã—ã¦ï¼‰ã€å·¦å´ã®ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚µã‚¤ã‚ºã‚’-1ã§ä¸Šæ›¸ãã—ã€free hookã«åˆ°é”ã™ã‚‹ã®ã«ååˆ†ãªå¤§ãã•ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã€æ¬¡ã«free hookã‚’å«ã‚€åˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚æ¬¡ã«ã€ãƒ•ãƒƒã‚¯ã«`system`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã¿ã€ãƒãƒ£ãƒ³ã‚¯ã«`"/bin/sh"`ã‚’æ›¸ãè¾¼ã¿ã€æœ€å¾Œã«ãã®æ–‡å­—åˆ—å†…å®¹ã‚’æŒã¤ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã—ã¾ã™ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
