# House of Force

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

### Kod

* Bu teknik yamanmıştır ([**burada**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) ve bu hatayı üretir: `malloc(): corrupted top size`
* İsterseniz bunu test etmek için [**kod buradan**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) deneyebilirsiniz.

### Hedef

* Bu saldırının hedefi, belirli bir adreste bir parça ayırabilmektir.

### Gereksinimler

* Üst parça başlığının boyutunu (örneğin -1) yazmayı sağlayan bir taşma.
* Yığın tahsisi boyutunu kontrol edebilmek.

### Saldırı

Eğer bir saldırgan, burada bir değeri yazmak için P adresinde bir parça ayırmak istiyorsa, üst parça boyutunu `-1` ile (belki bir taşma ile) yazmaya başlar. Bu, malloc'un herhangi bir tahsis için mmap kullanmayacağından emin olur çünkü Üst parça her zaman yeterli alana sahip olacaktır.

Sonra, üst parçanın adresi ile tahsis edilecek hedef alan arasındaki mesafeyi hesaplayın. Bunun nedeni, o boyutta bir malloc'un, üst parçayı o konuma taşımak için yapılacak olmasıdır. Fark/boyutun nasıl kolayca hesaplanabileceği şöyle:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Bu nedenle, `target - old_top - 4*sizeof(long)` boyutunda bir alan ayırmak (4 long, üst parça ve yeni parça için meta veriler nedeniyle) üst parçayı yazmak istediğimiz adrese taşıyacaktır.\
Sonra, hedef adreste bir parça almak için başka bir malloc yapın.

### Referanslar ve Diğer Örnekler

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Bu senaryonun amacı, ret2win fonksiyonunun adresi tarafından çağrılacak bir fonksiyonun adresini değiştirmektir.
* İkili dosyada, üst parça boyutunu değiştirmek için istismar edilebilecek bir taşma vardır; bu, -1 veya p64(0xffffffffffffffff) olarak değiştirilir.
* Sonra, yazılacak yerin adresi hesaplanır ve üst parçanın mevcut konumundan oraya olan fark `malloc` ile ayrılır.
* Son olarak, içinde bu istenen hedefi barındıracak yeni bir parça ayrılır; bu, ret2win fonksiyonu tarafından üzerine yazılır.
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* `Input your name:` kısmında, heap'ten bir adres sızdırmaya izin veren bir başlangıç zafiyeti vardır.
* Sonra `Org:` ve `Host:` işlevselliğinde, **org adı** istendiğinde `s` işaretçisinin 64B'sini doldurmak mümkündür; bu, yığında v2'nin adresinden sonra gelir ve ardından belirtilen **host adı** gelir. Sonrasında, strcpy `s`'nin içeriğini 64B boyutundaki bir parçaya kopyalayacağı için, **host adı** içine yerleştirilen verilerle **üst parçanın boyutunu** **üzerine yazmak** mümkündür.
* Artık keyfi yazma mümkün olduğuna göre, `atoi`'nin GOT'u printf'in adresi ile üzerine yazıldı. Bu sayede `%24$p` ile `IO_2_1_stderr` adresi sızdırılabildi. Ve bu libc sızıntısı ile `atoi`'nin GOT'u tekrar `system` adresi ile üzerine yazıldı ve parametre olarak `/bin/sh` geçildi.
* [Bu diğer yazıda önerilen alternatif bir yöntem](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), `free`'yi `puts` ile üzerine yazmak ve sonra daha sonra serbest bırakılacak işaretçiye `atoi@got` adresini eklemektir; böylece sızdırılır ve bu sızıntı ile tekrar `atoi@got`'u `system` ile üzerine yazmak ve `/bin/sh` ile çağırmak mümkündür.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Temizlenmemiş bir işaretçi ile serbest bırakılmış bir parçayı yeniden kullanmaya izin veren bir UAF vardır. Bazı okuma yöntemleri nedeniyle, burada free fonksiyonuna bir işaretçi yazarak bir libc adresi sızdırmak mümkündür ve ardından okuma fonksiyonu çağrılır.
* Sonra, UAF'yi istismar ederek, kalan alanın boyutunu -1 ile üzerine yazmak, serbest bırakma kancası için yeterince büyük bir parça ayırmak ve ardından serbest bırakma kancasını içerecek başka bir parça ayırmak için House of force kullanıldı. Ardından, kancaya `system` adresini yazın, bir parçaya `"/bin/sh"` yazın ve son olarak bu dize içeriği ile parçayı serbest bırakın.

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuçlarını paylaşmak için [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.**

</details>
{% endhint %}
