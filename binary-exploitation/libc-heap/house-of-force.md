# House of Force



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### Code

* Mbinu hii ilirekebishwa ([**hapa**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) na inazalisha kosa hili: `malloc(): corrupted top size`
* Unaweza kujaribu [**kod kutoka hapa**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) ili kuijaribu ikiwa unataka.

### Goal

* Lengo la shambulio hili ni kuwa na uwezo wa kugawa kipande katika anwani maalum.

### Requirements

* Overflow inayoruhusu kuandika upya saizi ya kichwa cha kipande cha juu (mfano -1).
* Kuwa na uwezo wa kudhibiti saizi ya ugawaji wa heap

### Attack

Ikiwa mshambuliaji anataka kugawa kipande katika anwani P ili kuandika upya thamani hapa. Anaanza kwa kuandika upya saizi ya kipande cha juu kwa `-1` (labda kwa kutumia overflow). Hii inahakikisha kwamba malloc haitatumia mmap kwa ugawaji wowote kwani kipande cha Juu kitakuwa na nafasi ya kutosha kila wakati.

Kisha, hesabu umbali kati ya anwani ya kipande cha juu na nafasi ya lengo kugawa. Hii ni kwa sababu malloc yenye saizi hiyo itafanywa ili kuhamasisha kipande cha juu katika nafasi hiyo. Hii ndiyo njia ambayo tofauti/saizi inaweza kuhesabiwa kwa urahisi:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Kwa hivyo, kugawa ukubwa wa `target - old_top - 4*sizeof(long)` (long 4 ni kwa sababu ya metadata ya kipande cha juu na kipande kipya wakati kinapogawiwa) kutahamasishe kipande cha juu kwenye anwani tunayotaka kufuta.\
Kisha, fanya malloc nyingine ili kupata kipande kwenye anwani ya lengo.

### Marejeleo na Mifano Mingine

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Lengo la hali hii ni ret2win ambapo tunahitaji kubadilisha anwani ya kazi ambayo itaitwa na anwani ya kazi ya ret2win
* Binary ina overflow ambayo inaweza kutumika kubadilisha ukubwa wa kipande cha juu, ambacho kinabadilishwa kuwa -1 au p64(0xffffffffffffffff)
* Kisha, inakokotwa anwani ya mahali ambapo kiashiria cha kufuta kinapatikana, na tofauti kutoka kwa nafasi ya sasa ya kipande cha juu hadi pale inagawiwa na `malloc`
* Hatimaye, kipande kipya kinagawiwa ambacho kitakuwa na lengo hili lililotakikana ndani ambayo inafutwa na kazi ya ret2win
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* Katika `Input your name:` kuna udhaifu wa awali unaoruhusu kufuta anwani kutoka kwenye heap
* Kisha katika kazi za `Org:` na `Host:` inawezekana kujaza 64B ya kiashiria `s` wakati inapoombwa jina la **org**, ambalo katika stack linafuatiwa na anwani ya v2, ambayo kisha inafuatiwa na jina la **host** lililoonyeshwa. Kwa hivyo, strcpy itakuwa ikikopi maudhui ya s kwenye kipande cha ukubwa 64B, inawezekana **kufuta ukubwa wa kipande cha juu** na data iliyowekwa ndani ya **jina la host**.
* Sasa kwamba kuandika bila mpangilio kunawezekana, GOT ya `atoi` ilifutwa hadi anwani ya printf. kisha ilikuwa inawezekana kufuta anwani ya `IO_2_1_stderr` _na_ `%24$p`. Na kwa kufuta hii ya libc ilikuwa inawezekana kufuta tena GOT ya `atoi` na anwani ya `system` na kuitwa ikipita kama param `/bin/sh`
* Njia mbadala [iliyopendekezwa katika andiko hili lingine](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), ni kufuta `free` na `puts`, na kisha kuongeza anwani ya `atoi@got`, katika kiashiria ambacho kitakuwa kimeachiliwa baadaye ili kifutwe na kwa kufuta hii kufuta tena `atoi@got` na `system` na kuitwa na `/bin/sh`.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Kuna UAF inayoruhusu kutumia kipande ambacho kimeachiliwa bila kufuta kiashiria. Kwa sababu kuna baadhi ya mbinu za kusoma, inawezekana kufuta anwani ya libc kwa kuandika kiashiria kwenye kazi ya bure katika GOT hapa na kisha kuita kazi ya kusoma.
* Kisha, House of force ilitumika (ik abusing UAF) kufuta ukubwa wa nafasi iliyobaki na -1, kugawa kipande kikubwa cha kutosha kufikia hook ya bure, na kisha kugawa kipande kingine ambacho kitakuwa na hook ya bure. Kisha, andika kwenye hook anwani ya `system`, andika kwenye kipande `"/bin/sh"` na hatimaye fungua kipande hicho chenye maudhui hayo.
