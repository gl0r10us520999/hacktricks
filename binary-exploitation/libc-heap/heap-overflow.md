# Heap Overflow

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

Ein Heap Overflow ist wie ein [**Stack Overflow**](../stack-overflow/), aber im Heap. Grunds√§tzlich bedeutet es, dass ein gewisser Speicher im Heap reserviert wurde, um einige Daten zu speichern, und **die gespeicherten Daten gr√∂√üer waren als der reservierte Speicher.**

Bei Stack Overflows wissen wir, dass einige Register wie der Befehlszeiger oder der Stack-Frame aus dem Stack wiederhergestellt werden und es m√∂glich sein k√∂nnte, dies auszunutzen. Im Falle von Heap Overflows **wird standardm√§√üig keine sensiblen Informationen** im Heap-Chunk gespeichert, der √ºberlaufen werden kann. Es k√∂nnte jedoch sensible Informationen oder Zeiger geben, sodass die **Kritikalit√§t** dieser Schwachstelle **abh√§ngt** von **den Daten, die √ºberschrieben werden k√∂nnten**, und wie ein Angreifer dies ausnutzen k√∂nnte.

{% hint style="success" %}
Um √úberlauf-Offsets zu finden, kannst du die gleichen Muster wie bei [**Stack Overflows**](../stack-overflow/#finding-stack-overflows-offsets) verwenden.
{% endhint %}

### Stack Overflows vs Heap Overflows

Bei Stack Overflows ist die Anordnung und die Daten, die zum Zeitpunkt des Ausl√∂sens der Schwachstelle im Stack vorhanden sind, ziemlich zuverl√§ssig. Das liegt daran, dass der Stack linear ist, immer in kollidierendem Speicher zunimmt, an **bestimmten Stellen des Programmlaufs der Stack-Speicher normalerweise √§hnliche Daten speichert** und eine spezifische Struktur mit einigen Zeigern am Ende des von jeder Funktion verwendeten Stack-Teils hat.

Im Falle eines Heap Overflows ist der verwendete Speicher jedoch nicht linear, sondern **zugewiesene Chunks befinden sich normalerweise an getrennten Speicherpositionen** (nicht nebeneinander), aufgrund von **Bins und Zonen**, die Zuweisungen nach Gr√∂√üe trennen, und weil **zuvor freigegebener Speicher verwendet wird**, bevor neue Chunks zugewiesen werden. Es ist **kompliziert zu wissen, welches Objekt mit dem anf√§lligen** f√ºr einen Heap Overflow kollidieren wird. Daher ist es notwendig, einen **zuverl√§ssigen Weg zu finden, um das gew√ºnschte Objekt im Speicher** neben dem √ºberlaufbaren zu platzieren.

Eine der Techniken, die daf√ºr verwendet wird, ist **Heap Grooming**, die beispielsweise [**in diesem Beitrag**](https://azeria-labs.com/grooming-the-ios-kernel-heap/) verwendet wird. In dem Beitrag wird erkl√§rt, wie im iOS-Kernel, wenn eine Zone keinen Speicher mehr hat, um Chunks zu speichern, sie um eine Kernel-Seite erweitert wird, und diese Seite in Chunks der erwarteten Gr√∂√üen aufgeteilt wird, die in der Reihenfolge verwendet werden (bis zur iOS-Version 9.2, danach werden diese Chunks auf eine randomisierte Weise verwendet, um die Ausnutzung dieser Angriffe zu erschweren).

Daher wird in dem vorherigen Beitrag, in dem ein Heap Overflow auftritt, um das √ºberlaufene Objekt dazu zu bringen, mit einem Opferobjekt zu kollidieren, mehrere **`kallocs` von mehreren Threads erzwungen, um sicherzustellen, dass alle freien Chunks gef√ºllt sind und dass eine neue Seite erstellt wird**.

Um diese F√ºllung mit Objekten einer bestimmten Gr√∂√üe zu erzwingen, ist die **out-of-line Zuweisung, die mit einem iOS Mach-Port verbunden ist**, ein idealer Kandidat. Durch das Anpassen der Gr√∂√üe der Nachricht ist es m√∂glich, die Gr√∂√üe der `kalloc`-Zuweisung genau anzugeben, und wenn der entsprechende Mach-Port zerst√∂rt wird, wird die entsprechende Zuweisung sofort wieder an `kfree` freigegeben.

Dann k√∂nnen einige dieser Platzhalter **freigegeben** werden. Die **`kalloc.4096`-Freiliste gibt Elemente in einer Last-In-First-Out-Reihenfolge frei**, was im Grunde bedeutet, dass, wenn einige Platzhalter freigegeben werden und der Exploit versucht, mehrere Opferobjekte zuzuweisen, w√§hrend er versucht, das anf√§llige Objekt f√ºr den Overflow zuzuweisen, es wahrscheinlich ist, dass dieses Objekt von einem Opferobjekt gefolgt wird.

### Beispiel libc

[**Auf dieser Seite**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) ist es m√∂glich, eine grundlegende Heap Overflow-Emulation zu finden, die zeigt, wie das √úberschreiben des prev in use-Bits des n√§chsten Chunks und der Position der prev-Gr√∂√üe es erm√∂glicht, einen **verwendeten Chunk zu konsolidieren** (indem er denkt, dass er unbenutzt ist) und **dann erneut zuzuweisen**, wobei es m√∂glich ist, Daten zu √ºberschreiben, die in einem anderen Zeiger verwendet werden.

Ein weiteres Beispiel aus [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) zeigt ein sehr einfaches Beispiel eines CTF, bei dem ein **Heap Overflow** ausgenutzt werden kann, um die Gewinnerfunktion aufzurufen, um **die Flagge zu erhalten**.

Im [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) Beispiel ist es m√∂glich zu sehen, wie durch das Ausnutzen eines Buffer Overflows es m√∂glich ist, **in einem nahegelegenen Chunk eine Adresse zu √ºberschreiben**, an die **willk√ºrliche Daten des Benutzers** geschrieben werden sollen.

### Beispiel ARM64

Auf der Seite [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) findest du ein Heap Overflow-Beispiel, bei dem ein Befehl, der ausgef√ºhrt werden soll, im folgenden Chunk des √ºberlaufenen Chunks gespeichert ist. Es ist also m√∂glich, den ausgef√ºhrten Befehl zu √§ndern, indem man ihn mit einem einfachen Exploit wie √ºberschreibt:
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Weitere Beispiele

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Wir nutzen eine Integer Overflow-Sicherheitsanf√§lligkeit, um einen Heap Overflow zu erzeugen.
* Wir korrumpieren Zeiger auf eine Funktion innerhalb einer `struct` des √ºberlaufenen Chunks, um eine Funktion wie `system` festzulegen und Codeausf√ºhrung zu erhalten.

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
