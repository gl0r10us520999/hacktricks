# D√©bordement de Tas

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Informations de Base

Un d√©bordement de tas est comme un [**d√©bordement de pile**](../stack-overflow/) mais dans le tas. En gros, cela signifie qu'un espace a √©t√© r√©serv√© dans le tas pour stocker des donn√©es et que **les donn√©es stock√©es √©taient plus grandes que l'espace r√©serv√©.**

Dans les d√©bordements de pile, nous savons que certains registres comme le pointeur d'instruction ou le cadre de pile vont √™tre restaur√©s √† partir de la pile et il pourrait √™tre possible d'en abuser. Dans le cas des d√©bordements de tas, il **n'y a pas d'informations sensibles stock√©es par d√©faut** dans le morceau de tas qui peut √™tre d√©bord√©. Cependant, cela pourrait √™tre des informations sensibles ou des pointeurs, donc la **criticit√©** de cette vuln√©rabilit√© **d√©pend** de **quelles donn√©es pourraient √™tre √©cras√©es** et comment un attaquant pourrait en abuser.

{% hint style="success" %}
Pour trouver les d√©calages de d√©bordement, vous pouvez utiliser les m√™mes motifs que dans les [**d√©bordements de pile**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### D√©bordements de Pile vs D√©bordements de Tas

Dans les d√©bordements de pile, l'agencement et les donn√©es qui vont √™tre pr√©sentes dans la pile au moment o√π la vuln√©rabilit√© peut √™tre d√©clench√©e sont assez fiables. Cela est d√ª au fait que la pile est lin√©aire, toujours croissante dans la m√©moire en collision, dans **des endroits sp√©cifiques de l'ex√©cution du programme, la m√©moire de la pile stocke g√©n√©ralement des types de donn√©es similaires** et elle a une structure sp√©cifique avec des pointeurs √† la fin de la partie de la pile utilis√©e par chaque fonction.

Cependant, dans le cas d'un d√©bordement de tas, la m√©moire utilis√©e n'est pas lin√©aire mais **les morceaux allou√©s sont g√©n√©ralement dans des positions s√©par√©es de la m√©moire** (pas l'un √† c√¥t√© de l'autre) √† cause des **bins et zones** s√©parant les allocations par taille et parce que **la m√©moire pr√©c√©demment lib√©r√©e est utilis√©e** avant d'allouer de nouveaux morceaux. Il est **compliqu√© de savoir quel objet va entrer en collision avec celui vuln√©rable** √† un d√©bordement de tas. Donc, lorsqu'un d√©bordement de tas est trouv√©, il est n√©cessaire de trouver un **moyen fiable de faire en sorte que l'objet d√©sir√© soit le suivant en m√©moire** de celui qui peut √™tre d√©bord√©.

Une des techniques utilis√©es pour cela est **Heap Grooming** qui est utilis√©e par exemple [**dans ce post**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). Dans le post, il est expliqu√© que lorsque dans le noyau iOS, une zone manque de m√©moire pour stocker des morceaux de m√©moire, elle l'agrandit par une page de noyau, et cette page est divis√©e en morceaux des tailles attendues qui seraient utilis√©es dans l'ordre (jusqu'√† la version iOS 9.2, puis ces morceaux sont utilis√©s de mani√®re randomis√©e pour compliquer l'exploitation de ces attaques).

Par cons√©quent, dans le post pr√©c√©dent o√π un d√©bordement de tas se produit, afin de forcer l'objet d√©bord√© √† entrer en collision avec un ordre de victime, plusieurs **`kallocs` sont forc√©s par plusieurs threads pour essayer de s'assurer que tous les morceaux libres sont remplis et qu'une nouvelle page est cr√©√©e**.

Pour forcer ce remplissage avec des objets d'une taille sp√©cifique, l'**allocation hors ligne associ√©e √† un port mach iOS** est un candidat id√©al. En fa√ßonnant la taille du message, il est possible de sp√©cifier exactement la taille de l'allocation `kalloc` et lorsque le port mach correspondant est d√©truit, l'allocation correspondante sera imm√©diatement lib√©r√©e √† `kfree`.

Ensuite, certains de ces espaces r√©serv√©s peuvent √™tre **lib√©r√©s**. La **liste libre `kalloc.4096` lib√®re des √©l√©ments dans un ordre dernier entr√©, premier sorti**, ce qui signifie essentiellement que si certains espaces r√©serv√©s sont lib√©r√©s et que l'exploit essaie d'allouer plusieurs objets victimes tout en essayant d'allouer l'objet vuln√©rable au d√©bordement, il est probable que cet objet sera suivi par un objet victime.

### Exemple libc

[**Sur cette page**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html), il est possible de trouver une √©mulation de d√©bordement de tas de base qui montre comment √©craser le bit prev in use du morceau suivant et la position de la taille prev, il est possible de **consolider un morceau utilis√©** (en le faisant penser qu'il est inutilis√©) et **ensuite de le r√©allouer** en √©tant capable d'√©craser des donn√©es qui sont utilis√©es dans un autre pointeur √©galement.

Un autre exemple de [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) montre un exemple tr√®s basique d'un CTF o√π un **d√©bordement de tas** peut √™tre abus√© pour appeler la fonction gagnante pour **obtenir le drapeau**.

Dans l'exemple [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html), il est possible de voir comment en abusant d'un d√©bordement de tampon, il est possible d'**√©craser dans un morceau voisin une adresse** o√π **des donn√©es arbitraires de l'utilisateur** vont √™tre √©crites.

### Exemple ARM64

Sur la page [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/), vous pouvez trouver un exemple de d√©bordement de tas o√π une commande qui va √™tre ex√©cut√©e est stock√©e dans le morceau suivant du morceau d√©bord√©. Ainsi, il est possible de modifier la commande ex√©cut√©e en l'√©crasant avec un exploit simple tel que :
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Autres exemples

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Nous utilisons une vuln√©rabilit√© d'Integer Overflow pour obtenir un Heap Overflow.
* Nous corrompons des pointeurs vers une fonction √† l'int√©rieur d'un `struct` du chunk d√©bord√© pour d√©finir une fonction telle que `system` et obtenir l'ex√©cution de code.

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
