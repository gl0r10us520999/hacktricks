# Heap Overflow

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

å †æº¢å‡ºå°±åƒä¸€ä¸ª [**æ ˆæº¢å‡º**](../stack-overflow/) ä½†å‘ç”Ÿåœ¨å †ä¸­ã€‚åŸºæœ¬ä¸Šï¼Œè¿™æ„å‘³ç€åœ¨å †ä¸­ä¿ç•™äº†ä¸€äº›ç©ºé—´æ¥å­˜å‚¨æ•°æ®ï¼Œè€Œ **å­˜å‚¨çš„æ•°æ®å¤§äºä¿ç•™çš„ç©ºé—´ã€‚**

åœ¨æ ˆæº¢å‡ºä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€äº›å¯„å­˜å™¨ï¼Œå¦‚æŒ‡ä»¤æŒ‡é’ˆæˆ–æ ˆå¸§ï¼Œå°†ä»æ ˆä¸­æ¢å¤ï¼Œå¹¶ä¸”å¯èƒ½ä¼šæ»¥ç”¨è¿™ä¸€ç‚¹ã€‚åœ¨å †æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œ**é»˜è®¤æƒ…å†µä¸‹å †å—ä¸­æ²¡æœ‰å­˜å‚¨ä»»ä½•æ•æ„Ÿä¿¡æ¯**ï¼Œå¯ä»¥è¢«æº¢å‡ºã€‚ç„¶è€Œï¼Œå®ƒå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯æˆ–æŒ‡é’ˆï¼Œå› æ­¤è¿™ç§æ¼æ´çš„ **ä¸¥é‡æ€§** **å–å†³äº** **å“ªäº›æ•°æ®å¯èƒ½è¢«è¦†ç›–** ä»¥åŠæ”»å‡»è€…å¦‚ä½•åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚

{% hint style="success" %}
ä¸ºäº†æ‰¾åˆ°æº¢å‡ºåç§»é‡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸ [**æ ˆæº¢å‡º**](../stack-overflow/#finding-stack-overflows-offsets) ç›¸åŒçš„æ¨¡å¼ã€‚
{% endhint %}

### æ ˆæº¢å‡ºä¸å †æº¢å‡º

åœ¨æ ˆæº¢å‡ºä¸­ï¼Œè§¦å‘æ¼æ´æ—¶æ ˆä¸­å°†å­˜åœ¨çš„æ’åˆ—å’Œæ•°æ®æ˜¯ç›¸å½“å¯é çš„ã€‚è¿™æ˜¯å› ä¸ºæ ˆæ˜¯çº¿æ€§çš„ï¼Œæ€»æ˜¯å¢åŠ åœ¨ç¢°æ’å†…å­˜ä¸­ï¼Œåœ¨ **ç¨‹åºè¿è¡Œçš„ç‰¹å®šä½ç½®ï¼Œæ ˆå†…å­˜é€šå¸¸å­˜å‚¨ç±»ä¼¼ç±»å‹çš„æ•°æ®**ï¼Œå¹¶ä¸”å®ƒå…·æœ‰ä¸€äº›ç‰¹å®šçš„ç»“æ„ï¼Œæœ«å°¾æœ‰ä¸€äº›æŒ‡å‘æ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„æ ˆéƒ¨åˆ†çš„æŒ‡é’ˆã€‚

ç„¶è€Œï¼Œåœ¨å †æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çš„å†…å­˜ä¸æ˜¯çº¿æ€§çš„ï¼Œè€Œæ˜¯ **åˆ†é…çš„å—é€šå¸¸ä½äºå†…å­˜çš„ä¸åŒä½ç½®**ï¼ˆè€Œä¸æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰ï¼Œå› ä¸º **bins å’Œ zones** æŒ‰å¤§å°åˆ†éš”åˆ†é…ï¼Œå¹¶ä¸”å› ä¸º **å…ˆå‰é‡Šæ”¾çš„å†…å­˜åœ¨åˆ†é…æ–°å—ä¹‹å‰è¢«ä½¿ç”¨**ã€‚å› æ­¤ï¼Œ**å¾ˆéš¾çŸ¥é“å°†ä¸æ˜“å—å †æº¢å‡ºå½±å“çš„å¯¹è±¡å‘ç”Ÿç¢°æ’çš„å¯¹è±¡**ã€‚å› æ­¤ï¼Œå½“å‘ç°å †æº¢å‡ºæ—¶ï¼Œéœ€è¦æ‰¾åˆ°ä¸€ç§ **å¯é çš„æ–¹æ³•ä½¿æ‰€éœ€å¯¹è±¡åœ¨å†…å­˜ä¸­ç´§æŒ¨ç€å¯ä»¥æº¢å‡ºçš„å¯¹è±¡**ã€‚

ç”¨äºæ­¤çš„ä¸€ç§æŠ€æœ¯æ˜¯ **Heap Grooming**ï¼Œä¾‹å¦‚åœ¨ [**è¿™ç¯‡æ–‡ç« ä¸­**](https://azeria-labs.com/grooming-the-ios-kernel-heap/)ã€‚æ–‡ç« è§£é‡Šäº†å½“ iOS å†…æ ¸ä¸­çš„ä¸€ä¸ªåŒºåŸŸæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥å­˜å‚¨å†…å­˜å—æ—¶ï¼Œå®ƒé€šè¿‡ä¸€ä¸ªå†…æ ¸é¡µé¢æ‰©å±•ï¼Œå¹¶ä¸”è¯¥é¡µé¢è¢«åˆ†å‰²æˆé¢„æœŸå¤§å°çš„å—ï¼Œè¿™äº›å—å°†æŒ‰é¡ºåºä½¿ç”¨ï¼ˆç›´åˆ° iOS ç‰ˆæœ¬ 9.2ï¼Œç„¶åè¿™äº›å—ä»¥éšæœºæ–¹å¼ä½¿ç”¨ï¼Œä»¥å¢åŠ è¿™äº›æ”»å‡»çš„åˆ©ç”¨éš¾åº¦ï¼‰ã€‚

å› æ­¤ï¼Œåœ¨å‘ç”Ÿå †æº¢å‡ºçš„å‰ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œä¸ºäº†å¼ºåˆ¶æº¢å‡ºçš„å¯¹è±¡ä¸å—å®³è€…å¯¹è±¡å‘ç”Ÿç¢°æ’ï¼Œå¤šä¸ª **`kallocs` è¢«å¤šä¸ªçº¿ç¨‹å¼ºåˆ¶æ‰§è¡Œï¼Œä»¥ç¡®ä¿æ‰€æœ‰ç©ºé—²å—éƒ½è¢«å¡«æ»¡ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ–°é¡µé¢**ã€‚

ä¸ºäº†å¼ºåˆ¶ç”¨ç‰¹å®šå¤§å°çš„å¯¹è±¡å¡«å……ï¼Œ**ä¸ iOS mach ç«¯å£ç›¸å…³çš„ç¦»çº¿åˆ†é…**æ˜¯ä¸€ä¸ªç†æƒ³çš„å€™é€‰è€…ã€‚é€šè¿‡ç²¾ç¡®è®¾ç½®æ¶ˆæ¯çš„å¤§å°ï¼Œå¯ä»¥å‡†ç¡®æŒ‡å®š `kalloc` åˆ†é…çš„å¤§å°ï¼Œå½“ç›¸åº”çš„ mach ç«¯å£è¢«é”€æ¯æ—¶ï¼Œç›¸åº”çš„åˆ†é…å°†ç«‹å³é‡Šæ”¾å› `kfree`ã€‚

ç„¶åï¼Œè¿™äº›å ä½ç¬¦ä¸­çš„ä¸€äº›å¯ä»¥è¢« **é‡Šæ”¾**ã€‚**`kalloc.4096` ç©ºé—²åˆ—è¡¨ä»¥åè¿›å…ˆå‡ºé¡ºåºé‡Šæ”¾å…ƒç´ **ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€å¦‚æœä¸€äº›å ä½ç¬¦è¢«é‡Šæ”¾ï¼Œè€Œåˆ©ç”¨å°è¯•åœ¨å°è¯•åˆ†é…æ˜“å—æº¢å‡ºå½±å“çš„å¯¹è±¡æ—¶åˆ†é…å¤šä¸ªå—å®³è€…å¯¹è±¡ï¼Œåˆ™è¯¥å¯¹è±¡å¾ˆå¯èƒ½ä¼šè¢«ä¸€ä¸ªå—å®³è€…å¯¹è±¡è·Ÿéšã€‚

### ç¤ºä¾‹ libc

åœ¨ [**æ­¤é¡µé¢**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåŸºæœ¬çš„å †æº¢å‡ºä»¿çœŸï¼Œå±•ç¤ºäº†å¦‚ä½•é€šè¿‡è¦†ç›–ä¸‹ä¸€ä¸ªå—çš„ prev in use ä½å’Œ prev size çš„ä½ç½®æ¥ **åˆå¹¶ä¸€ä¸ªå·²ä½¿ç”¨çš„å—**ï¼ˆä½¿å…¶è®¤ä¸ºæ˜¯æœªä½¿ç”¨çš„ï¼‰å¹¶ **å†æ¬¡åˆ†é…å®ƒ**ï¼Œèƒ½å¤Ÿè¦†ç›–åœ¨ä¸åŒæŒ‡é’ˆä¸­ä½¿ç”¨çš„æ•°æ®ã€‚

å¦ä¸€ä¸ªæ¥è‡ª [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) çš„ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªéå¸¸åŸºæœ¬çš„ CTF ç¤ºä¾‹ï¼Œå…¶ä¸­ **å †æº¢å‡º** å¯ä»¥è¢«æ»¥ç”¨ä»¥è°ƒç”¨èµ¢å®¶å‡½æ•°ä»¥ **è·å–æ ‡å¿—**ã€‚

åœ¨ [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä½•é€šè¿‡æ»¥ç”¨ç¼“å†²åŒºæº¢å‡ºæ¥ **åœ¨ä¸€ä¸ªä¸´è¿‘å—ä¸­è¦†ç›–ä¸€ä¸ªåœ°å€**ï¼Œè¯¥åœ°å€å°†å†™å…¥ **æ¥è‡ªç”¨æˆ·çš„ä»»æ„æ•°æ®**ã€‚

### ç¤ºä¾‹ ARM64

åœ¨é¡µé¢ [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå †æº¢å‡ºç¤ºä¾‹ï¼Œå…¶ä¸­è¦æ‰§è¡Œçš„å‘½ä»¤å­˜å‚¨åœ¨æº¢å‡ºå—çš„ä¸‹ä¸€ä¸ªå—ä¸­ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡ç”¨ç®€å•çš„åˆ©ç”¨è¦†ç›–å®ƒæ¥ä¿®æ”¹æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### å…¶ä»–ç¤ºä¾‹

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* æˆ‘ä»¬åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´æ¥è·å–å †æº¢å‡ºã€‚
* æˆ‘ä»¬ç ´åæŒ‡å‘æº¢å‡ºå—å†… `struct` çš„å‡½æ•°æŒ‡é’ˆï¼Œä»¥è®¾ç½®å¦‚ `system` çš„å‡½æ•°å¹¶è·å¾—ä»£ç æ‰§è¡Œã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
