# D√©bordement de tas

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

Un d√©bordement de tas est similaire √† un [**d√©bordement de pile**](../stack-overflow/) mais dans le tas. Fondamentalement, cela signifie qu'un espace a √©t√© r√©serv√© dans le tas pour stocker des donn√©es et que **les donn√©es stock√©es √©taient plus grandes que l'espace r√©serv√©**.

Dans les d√©bordements de pile, nous savons que certains registres comme le pointeur d'instruction ou le cadre de pile vont √™tre restaur√©s √† partir de la pile et il pourrait √™tre possible d'en abuser. En cas de d√©bordement de tas, il **n'y a aucune information sensible stock√©e par d√©faut** dans le fragment de tas qui peut √™tre d√©bord√©. Cependant, il pourrait s'agir d'informations sensibles ou de pointeurs, donc la **criticit√©** de cette vuln√©rabilit√© **d√©pend** de **quelles donn√©es pourraient √™tre √©cras√©es** et comment un attaquant pourrait en abuser.

{% hint style="success" %}
Pour trouver les d√©calages de d√©bordement, vous pouvez utiliser les m√™mes motifs que dans les [**d√©bordements de pile**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### D√©bordements de pile vs d√©bordements de tas

Dans les d√©bordements de pile, l'agencement et les donn√©es qui seront pr√©sentes dans la pile au moment o√π la vuln√©rabilit√© peut √™tre d√©clench√©e sont assez fiables. Cela est d√ª au fait que la pile est lin√©aire, augmentant toujours dans la m√©moire en collision, dans **des endroits sp√©cifiques de l'ex√©cution du programme, la m√©moire de pile stocke g√©n√©ralement un type de donn√©es similaire** et elle a une structure sp√©cifique avec certains pointeurs √† la fin de la partie de pile utilis√©e par chaque fonction.

Cependant, dans le cas d'un d√©bordement de tas, la m√©moire utilis√©e n'est pas lin√©aire mais **les fragments allou√©s sont g√©n√©ralement √† des positions s√©par√©es de la m√©moire** (pas les uns √† c√¥t√© des autres) en raison des **bacs et des zones** s√©parant les allocations par taille et parce que **la m√©moire pr√©c√©demment lib√©r√©e est utilis√©e** avant d'allouer de nouveaux fragments. Il est **compliqu√© de savoir quel objet va entrer en collision avec celui vuln√©rable** √† un d√©bordement de tas. Ainsi, lorsqu'un d√©bordement de tas est trouv√©, il est n√©cessaire de trouver un **moyen fiable de faire en sorte que l'objet d√©sir√© soit le suivant en m√©moire** √† partir de celui qui peut √™tre d√©bord√©.

L'une des techniques utilis√©es pour cela est le **d√©m√™lage de tas** qui est utilis√© par exemple [**dans ce post**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). Dans le post, il est expliqu√© comment dans le noyau iOS, lorsqu'une zone manque de m√©moire pour stocker des fragments de m√©moire, elle l'agrandit d'une page de noyau, et cette page est divis√©e en fragments des tailles attendues qui seraient utilis√©es dans l'ordre (jusqu'√† la version iOS 9.2, puis ces fragments sont utilis√©s de mani√®re al√©atoire pour compliquer l'exploitation de ces attaques).

Par cons√©quent, dans le post pr√©c√©dent o√π un d√©bordement de tas se produit, pour forcer l'objet d√©bord√© √† entrer en collision avec un ordre victime, plusieurs **`kallocs` sont forc√©s par plusieurs threads pour essayer de s'assurer que tous les fragments libres sont remplis et qu'une nouvelle page est cr√©√©e**.

Pour forcer ce remplissage avec des objets d'une taille sp√©cifique, l'**allocation hors ligne associ√©e √† un port mach iOS** est un candidat id√©al. En ajustant la taille du message, il est possible de sp√©cifier exactement la taille de l'allocation `kalloc` et lorsque le port mach correspondant est d√©truit, l'allocation correspondante sera imm√©diatement lib√©r√©e √† `kfree`.

Ensuite, certains de ces espaces r√©serv√©s peuvent √™tre **lib√©r√©s**. La liste de lib√©ration **`kalloc.4096` lib√®re les √©l√©ments dans un ordre dernier entr√©, premier sorti**, ce qui signifie essentiellement que si certains espaces r√©serv√©s sont lib√©r√©s et que l'exploit essaie d'allouer plusieurs objets victimes tout en essayant d'allouer l'objet vuln√©rable au d√©bordement, il est probable que cet objet sera suivi d'un objet victime.

### Exemple libc

[**Sur cette page**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html), il est possible de trouver une √©mulation de d√©bordement de tas de base qui montre comment en √©crivant le bit prev in use du fragment suivant et la position de la taille prev, il est possible de **consolider un fragment utilis√©** (en le faisant croire qu'il est inutilis√©) et **ensuite le r√©allouer** en pouvant √©craser des donn√©es qui sont utilis√©es dans un autre pointeur √©galement.

Un autre exemple de [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) montre un exemple tr√®s basique d'un CTF o√π un **d√©bordement de tas** peut √™tre exploit√© pour appeler la fonction gagnante et **obtenir le drapeau**.

Dans l'exemple [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html), il est possible de voir comment en abusant d'un d√©passement de tampon, il est possible d'**√©craser dans un fragment proche une adresse** o√π **des donn√©es arbitraires de l'utilisateur** vont √™tre √©crites.

### Exemple ARM64

Sur la page [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/), vous pouvez trouver un exemple de d√©bordement de tas o√π une commande qui va √™tre ex√©cut√©e est stock√©e dans le fragment suivant √† partir du fragment d√©bord√©. Ainsi, il est possible de modifier la commande ex√©cut√©e en l'√©crasant avec une exploitation facile telle que :
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Autres exemples

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Nous utilisons une vuln√©rabilit√© de d√©bordement d'entier pour obtenir un d√©bordement de tas.
* Nous corrompons les pointeurs vers une fonction √† l'int√©rieur d'une `struct` du bloc d√©bord√© pour d√©finir une fonction telle que `system` et obtenir l'ex√©cution de code.

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
