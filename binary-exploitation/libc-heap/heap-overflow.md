# Desbordamiento de Mont칤culo

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Informaci칩n B치sica

Un desbordamiento de mont칤culo es como un [**desbordamiento de pila**](../stack-overflow/) pero en el mont칤culo. B치sicamente significa que se reserv칩 un espacio en el mont칤culo para almacenar algunos datos y **los datos almacenados eran m치s grandes que el espacio reservado.**

En los desbordamientos de pila sabemos que algunos registros como el puntero de instrucci칩n o el marco de pila se van a restaurar desde la pila y podr칤a ser posible abusar de esto. En el caso de los desbordamientos de mont칤culo, **no hay informaci칩n sensible almacenada por defecto** en el fragmento de mont칤culo que puede ser desbordado. Sin embargo, podr칤a haber informaci칩n sensible o punteros, por lo que la **criticidad** de esta vulnerabilidad **depende** de **qu칠 datos podr칤an ser sobrescritos** y c칩mo un atacante podr칤a abusar de esto.

{% hint style="success" %}
Para encontrar los desplazamientos de desbordamiento, puedes usar los mismos patrones que en [**desbordamientos de pila**](../stack-overflow/#finding-stack-overflows-offsets).
{% endhint %}

### Desbordamientos de Pila vs Desbordamientos de Mont칤culo

En los desbordamientos de pila, la disposici칩n y los datos que van a estar presentes en la pila en el momento en que se puede activar la vulnerabilidad son bastante confiables. Esto se debe a que la pila es lineal, siempre aumentando en memoria colisionante, en **lugares espec칤ficos de la ejecuci칩n del programa, la memoria de la pila generalmente almacena un tipo similar de datos** y tiene una estructura espec칤fica con algunos punteros al final de la parte de la pila utilizada por cada funci칩n.

Sin embargo, en el caso de un desbordamiento de mont칤culo, la memoria utilizada no es lineal, sino que **los fragmentos asignados suelen estar en posiciones separadas de la memoria** (no uno al lado del otro) debido a **bins y zonas** que separan las asignaciones por tama침o y porque **la memoria previamente liberada se utiliza** antes de asignar nuevos fragmentos. Es **complicado saber el objeto que va a colisionar con el que es vulnerable** a un desbordamiento de mont칤culo. Por lo tanto, cuando se encuentra un desbordamiento de mont칤culo, es necesario encontrar una **manera confiable de hacer que el objeto deseado est칠 al lado en memoria** del que puede ser desbordado.

Una de las t칠cnicas utilizadas para esto es **Heap Grooming**, que se utiliza, por ejemplo, [**en esta publicaci칩n**](https://azeria-labs.com/grooming-the-ios-kernel-heap/). En la publicaci칩n se explica c칩mo, cuando en el n칰cleo de iOS, una zona se queda sin memoria para almacenar fragmentos de memoria, se expande por una p치gina del n칰cleo, y esta p치gina se divide en fragmentos de los tama침os esperados que se utilizar칤an en orden (hasta la versi칩n 9.2 de iOS, luego estos fragmentos se utilizan de manera aleatoria para dificultar la explotaci칩n de estos ataques).

Por lo tanto, en la publicaci칩n anterior donde ocurre un desbordamiento de mont칤culo, para forzar que el objeto desbordado colisione con un orden de v칤ctima, se **forzan varios `kallocs` por varios hilos para intentar asegurar que todos los fragmentos libres est칠n llenos y que se cree una nueva p치gina**.

Para forzar este llenado con objetos de un tama침o espec칤fico, la **asignaci칩n fuera de l칤nea asociada con un puerto mach de iOS** es un candidato ideal. Al elaborar el tama침o del mensaje, es posible especificar exactamente el tama침o de la asignaci칩n `kalloc` y cuando el puerto mach correspondiente se destruye, la asignaci칩n correspondiente se liberar치 inmediatamente de nuevo a `kfree`.

Luego, algunos de estos marcadores de posici칩n pueden ser **liberados**. La **lista libre `kalloc.4096` libera elementos en un orden de 칰ltimo en entrar, primero en salir**, lo que b치sicamente significa que si algunos marcadores de posici칩n son liberados y el exploit intenta asignar varios objetos de v칤ctima mientras intenta asignar el objeto vulnerable al desbordamiento, es probable que este objeto sea seguido por un objeto de v칤ctima.

### Ejemplo libc

[**En esta p치gina**](https://guyinatuxedo.github.io/27-edit\_free\_chunk/heap\_consolidation\_explanation/index.html) es posible encontrar una emulaci칩n b치sica de desbordamiento de mont칤culo que muestra c칩mo sobrescribir el bit de uso previo del siguiente fragmento y la posici칩n del tama침o previo es posible **consolidar un fragmento utilizado** (haci칠ndolo pensar que es no utilizado) y **luego asignarlo nuevamente** pudiendo sobrescribir datos que est치n siendo utilizados en un puntero diferente tambi칠n.

Otro ejemplo de [**protostar heap 0**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap0/index.html) muestra un ejemplo muy b치sico de un CTF donde un **desbordamiento de mont칤culo** puede ser abusado para llamar a la funci칩n ganadora para **obtener la bandera**.

En el ejemplo de [**protostar heap 1**](https://guyinatuxedo.github.io/24-heap\_overflow/protostar\_heap1/index.html) es posible ver c칩mo abusando de un desbordamiento de b칰fer es posible **sobrescribir en un fragmento cercano una direcci칩n** donde **se van a escribir datos arbitrarios del usuario**.

### Ejemplo ARM64

En la p치gina [https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/](https://8ksec.io/arm64-reversing-and-exploitation-part-1-arm-instruction-set-simple-heap-overflow/) puedes encontrar un ejemplo de desbordamiento de mont칤culo donde un comando que se va a ejecutar se almacena en el siguiente fragmento del fragmento desbordado. Por lo tanto, es posible modificar el comando ejecutado sobrescribi칠ndolo con un exploit f치cil como:
```bash
python3 -c 'print("/"*0x400+"/bin/ls\x00")' > hax.txt
```
### Otros ejemplos

* [**Auth-or-out. Hack The Box**](https://7rocky.github.io/en/ctf/htb-challenges/pwn/auth-or-out/)
* Usamos una vulnerabilidad de desbordamiento de enteros para obtener un desbordamiento de heap.
* Corrompemos punteros a una funci칩n dentro de un `struct` del chunk desbordado para establecer una funci칩n como `system` y obtener ejecuci칩n de c칩digo.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
