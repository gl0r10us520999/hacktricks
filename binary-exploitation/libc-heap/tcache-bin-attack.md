# Attaque Tcache Bin

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Informations de base

Pour plus d'informations sur ce qu'est un Tcache bin, consultez cette page :

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Tout d'abord, notez que le Tcache a √©t√© introduit dans la version 2.26 de Glibc.

L'**attaque Tcache** (√©galement connue sous le nom de **poisonnement Tcache**) propos√©e sur la [**page guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) est tr√®s similaire √† l'attaque fast bin o√π le but est de remplacer le pointeur vers le prochain chunk dans le bin √† l'int√©rieur d'un chunk lib√©r√© par une adresse arbitraire afin qu'il soit ensuite possible d'**allouer cette adresse sp√©cifique et potentiellement √©craser les pointeurs**.

Cependant, de nos jours, si vous ex√©cutez le code mentionn√©, vous obtiendrez l'erreur : **`malloc(): unaligned tcache chunk detected`**. Il est donc n√©cessaire d'√©crire comme adresse dans le nouveau pointeur une adresse align√©e (ou d'ex√©cuter suffisamment de fois le binaire pour que l'adresse √©crite soit en fait align√©e).

### Attaque des index Tcache

Il est g√©n√©ralement possible de trouver au d√©but du tas un chunk contenant le **nombre de chunks par index** √† l'int√©rieur du tcache et l'adresse du **chunk principal de chaque index tcache**. Si pour une raison quelconque il est possible de modifier cette information, il serait possible de **faire pointer le chunk principal d'un index vers une adresse souhait√©e** (comme `__malloc_hook`) pour ensuite allouer un chunk de la taille de l'index et √©craser le contenu de `__malloc_hook` dans ce cas.

## Exemples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuite d'informations Libc** : Il est possible de remplir les tcaches, d'ajouter un chunk dans la liste non tri√©e, de vider le tcache et de **r√©allouer le chunk depuis le bin non tri√©** en √©crasant seulement les 8 premiers octets, laissant **la deuxi√®me adresse vers libc du chunk intacte afin que nous puissions la lire**.
* **Attaque Tcache** : Le binaire est vuln√©rable √† un d√©bordement de tas de 1 octet. Cela sera abus√© pour changer l'**en-t√™te de taille** d'un chunk allou√© en le rendant plus grand. Ensuite, ce chunk sera **lib√©r√©**, l'ajoutant au tcache de chunks de taille factice. Ensuite, nous allouerons un chunk de la taille factice, et le chunk pr√©c√©dent sera **retourn√© sachant que ce chunk √©tait en fait plus petit** et cela nous donne l'opportunit√© d'**√©craser le prochain chunk en m√©moire**.\
Nous allons en abuser pour **√©craser le pointeur FD du prochain chunk** pour pointer vers **`malloc_hook`**, afin qu'il soit possible d'allouer 2 pointeurs : d'abord le pointeur l√©gitime que nous venons de modifier, puis la deuxi√®me allocation retournera un chunk dans **`malloc_hook`** qu'il est possible d'abuser pour √©crire un **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuite d'informations Libc** : Il y a une utilisation apr√®s lib√©ration et un double lib√©ration. Dans ce rapport, l'auteur a divulgu√© une adresse de libc en lisant l'adresse d'un chunk plac√© dans un petit bin (comme le fuyant depuis le bin non tri√© mais depuis le petit).
* **Attaque Tcache** : Une Tcache est effectu√©e via un **double free**. Le m√™me chunk est lib√©r√© deux fois, donc √† l'int√©rieur du Tcache, le chunk pointera vers lui-m√™me. Ensuite, il est allou√©, son pointeur FD est modifi√© pour pointer vers le **free hook** et ensuite il est allou√© √† nouveau, donc le prochain chunk dans la liste sera dans le free hook. Ensuite, cela est √©galement allou√© et il est possible d'√©crire l'adresse de `system` ici afin que lorsqu'un malloc contenant `"/bin/sh"` est lib√©r√©, nous obtenons un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principale vuln√©rabilit√© ici est la capacit√© de `free` n'importe quelle adresse dans le tas en indiquant son offset.
* **Attaque des index Tcache** : Il est possible d'allouer et de lib√©rer un chunk d'une taille qui, lorsqu'elle est stock√©e √† l'int√©rieur du chunk tcache (le chunk avec les informations des bins tcache), g√©n√©rera une **adresse avec la valeur 0x100**. Cela est d√ª au fait que le tcache stocke le nombre de chunks dans chaque bin dans des octets diff√©rents, donc un chunk dans un index sp√©cifique g√©n√®re la valeur 0x100.
* Ensuite, cette valeur ressemble √† un chunk de taille 0x100. Permettant d'en abuser en `free` cette adresse. Cela **ajoutera cette adresse √† l'index des chunks de taille 0x100 dans le tcache**.
* Ensuite, **en allouant** un chunk de taille **0x100**, l'adresse pr√©c√©dente sera retourn√©e comme un chunk, permettant d'√©craser d'autres index tcache.\
Par exemple, en mettant l'adresse de malloc hook dans l'un d'eux et en allouant un chunk de la taille de cet index, cela accordera un chunk dans calloc hook, ce qui permet d'√©crire un one gadget pour obtenir un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* M√™me vuln√©rabilit√© que pr√©c√©demment avec une restriction suppl√©mentaire.
* **Attaque des index Tcache** : Attaque similaire √† la pr√©c√©dente mais utilisant moins d'√©tapes en **lib√©rant le chunk qui contient les informations tcache** afin que son adresse soit ajout√©e √† l'index tcache de sa taille, il est donc possible d'allouer cette taille et d'obtenir les informations du chunk tcache en tant que chunk, ce qui permet d'ajouter le free hook comme adresse d'un index, de l'allouer et d'√©crire un one gadget dessus.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** pour ajouter un nombre au pointeur `fd`.
* Beaucoup de **heap feng-shui** est n√©cessaire dans ce d√©fi. Le rapport montre comment **contr√¥ler la t√™te de la liste libre Tcache** est tr√®s pratique.
* **Fuite Glibc** via `stdout` (FSOP).
* **Poisonnement Tcache** pour obtenir une primitive d'√©criture arbitraire.

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
