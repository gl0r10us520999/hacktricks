# Tcache Bin Attack

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}

## 基本情報

Tcache binとは何かについての詳細は、次のページを参照してください：

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

まず最初に、TcacheはGlibcバージョン2.26で導入されました。

**Tcache攻撃**（または**Tcacheポイズニング**）は、[**guyinatuxidoページ**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html)で提案されており、目標は解放されたチャンク内のビン内の次のチャンクへのポインタを任意のアドレスに上書きして、後でその特定のアドレスを**割り当ててポインタを上書きする可能性がある**という点で、ファストビン攻撃と非常に似ています。

ただし、現在では、上記のコードを実行するとエラーが発生します：**`malloc(): unaligned tcache chunk detected`**。そのため、新しいポインタにアラインされたアドレスを書き込む必要があります（または、実際にアラインされたアドレスに書き込むためにバイナリを十分な回数実行する必要があります）。

### Tcacheインデックス攻撃

通常、ヒープの先頭には、Tcache内の**各インデックスごとのチャンクの数**を含むチャンクと、**各Tcacheインデックスのヘッドチャンクへのアドレス**が含まれています。何らかの理由でこの情報を変更できる場合、**特定のアドレス（たとえば`__malloc_hook`）を指すようにいくつかのインデックスのヘッドチャンクを変更することが可能**になります。その後、そのインデックスのサイズのチャンクを割り当て、この場合は`__malloc_hook`の内容を上書きすることが可能になります。

## 例

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc情報リーク**: Tcacheを埋め、チャンクをアンソートリストに追加し、Tcacheを空にし、**アンソートビンからチャンクを再割り当て**して、最初の8Bだけを上書きし、**チャンクの2番目のアドレスをそのままにして読み取る**ことが可能です。
* **Tcache攻撃**: バイナリには1Bのヒープオーバーフローの脆弱性があります。これを悪用して、割り当てられたチャンクの**サイズヘッダー**を大きく変更します。その後、このチャンクを**解放**し、偽のサイズのチャンクのTcacheに追加します。その後、偽のサイズでチャンクを割り当て、前のチャンクが実際にはより小さいことを知っているため、これを**上書きしてメモリ内の次のチャンク**を可能にします。\
これを悪用して、次のチャンクのFDポインタを**`malloc_hook`**を指すように**上書き**し、その後、2つのポインタを割り当てることができます：まず、変更した正規のポインタ、そして次に2番目の割り当ては、`malloc_hook`にあるチャンクを返します。これを悪用して、**ワンガジェット**を書き込むために悪用できます。
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc情報リーク**: ユーザーアフターフリーとダブルフリーがあります。この解説では、著者が小さなビンに配置されたチャンクのアドレスを読み取ることで、libcのアドレスをリークしました（アンソートビンからではなく、小さなビンからリークしました）。
* **Tcache攻撃**: **ダブルフリー**を介してTcacheが実行されます。同じチャンクが2回解放されるため、Tcache内ではチャンクが自分自身を指すようになります。その後、割り当てられ、そのFDポインタが**free hook**を指すように変更され、再度割り当てられるため、リスト内の次のチャンクはfree hookになります。その後、これも割り当てられ、`system`のアドレスをここに書き込むことができるため、`"/bin/sh"`を含むmallocが解放されるとシェルを取得できます。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* ここでの主な脆弱性は、オフセットを指定してヒープ内の任意のアドレスを`free`できることです。
* **Tcacheインデックス攻撃**: Tcacheチャンク（Tcacheビンの情報を含むチャンク）に格納されるサイズのチャンクを割り当てて解放すると、値が0x100のアドレスが生成されます。これは、Tcacheが各ビンのチャンク数を異なるバイトで格納するためです。したがって、特定のインデックスの1つのチャンクが値0x100を生成します。
* その後、この値はサイズ0x100のチャンクがあるかのように見えます。このアドレスを`free`することで、そのアドレスがTcache内のサイズ0x100のチャンクのインデックスに追加されます。
* その後、サイズが**0x100**のチャンクを**割り当て**すると、前のアドレスがチャンクとして返され、他のTcacheインデックスを上書きすることが可能になります。\
たとえば、その中のmallocフックのアドレスを配置し、そのインデックスのサイズのチャンクを割り当てると、callocフックにチャンクが付与され、ワンガジェットを書き込むことが可能になります。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* 以前と同じ脆弱性がありますが、1つの追加制限があります。
* **Tcacheインデックス攻撃**: 前の攻撃と似た攻撃ですが、**Tcache情報を含むチャンクを解放**して、そのアドレスがそのサイズのTcacheインデックスに追加されるため、そのサイズを割り当ててTcacheチャンク情報を取得し、その情報を使用してfree hookを1つのインデックスのアドレスとして追加し、それを割り当ててワンガジェットを書き込むことが可能です。
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* `fd`ポインタに数値を追加するための**Write After Free**。
* このチャレンジでは、多くの**ヒープファングシュイ**が必要です。解説では、Tcacheのフリーリストのヘッドを制御することが非常に便利であることを示しています。
* `stdout`（FSOP）を介した**Glibcリーク**。
* **Tcacheポイズニング**を使用して任意の書き込みプリミティブを取得します。

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* **💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)**に参加するか、[**telegram グループ**](https://t.me/peass)**に参加するか、**Twitter**で**フォロー**する🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)**の GitHub リポジトリに PR を提出してください。**
