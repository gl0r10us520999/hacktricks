# Tcache Bin Attack

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Basic Information

Para mais informa√ß√µes sobre o que √© um Tcache bin, confira esta p√°gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Primeiramente, note que o Tcache foi introduzido na vers√£o 2.26 do Glibc.

O **ataque Tcache** (tamb√©m conhecido como **envenenamento de Tcache**) proposto na [**p√°gina guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) √© muito semelhante ao ataque de fast bin, onde o objetivo √© sobrescrever o ponteiro para o pr√≥ximo chunk no bin dentro de um chunk liberado para um endere√ßo arbitr√°rio, para que depois seja poss√≠vel **alocar aquele endere√ßo espec√≠fico e potencialmente sobrescrever ponteiros**.

No entanto, atualmente, se voc√™ executar o c√≥digo mencionado, receber√° o erro: **`malloc(): unaligned tcache chunk detected`**. Portanto, √© necess√°rio escrever como endere√ßo no novo ponteiro um endere√ßo alinhado (ou executar o bin√°rio o suficiente para que o endere√ßo escrito esteja realmente alinhado).

### Tcache indexes attack

Geralmente, √© poss√≠vel encontrar no in√≠cio do heap um chunk contendo a **quantidade de chunks por √≠ndice** dentro do tcache e o endere√ßo do **chunk cabe√ßa de cada √≠ndice de tcache**. Se por algum motivo for poss√≠vel modificar essa informa√ß√£o, seria poss√≠vel **fazer o chunk cabe√ßa de algum √≠ndice apontar para um endere√ßo desejado** (como `__malloc_hook`) para ent√£o alocar um chunk do tamanho do √≠ndice e sobrescrever o conte√∫do de `__malloc_hook` neste caso.

## Examples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc info leak**: √â poss√≠vel preencher os tcaches, adicionar um chunk na lista n√£o ordenada, esvaziar o tcache e **re-alocar o chunk do bin n√£o ordenado** apenas sobrescrevendo os primeiros 8B, deixando o **segundo endere√ßo para libc do chunk intacto para que possamos l√™-lo**.
* **Tcache attack**: O bin√°rio √© vulner√°vel a um overflow de heap de 1B. Isso ser√° abusado para mudar o **cabe√ßalho de tamanho** de um chunk alocado, tornando-o maior. Ent√£o, esse chunk ser√° **liberado**, adicionando-o ao tcache de chunks de tamanho falso. Em seguida, alocaremos um chunk com o tamanho falso, e o chunk anterior ser√° **retornado sabendo que esse chunk era na verdade menor**, e isso nos d√° a oportunidade de **sobrescrever o pr√≥ximo chunk na mem√≥ria**.\
Abusaremos disso para **sobrescrever o ponteiro FD do pr√≥ximo chunk** para apontar para **`malloc_hook`**, para que ent√£o seja poss√≠vel alocar 2 ponteiros: primeiro o ponteiro leg√≠timo que acabamos de modificar, e ent√£o a segunda aloca√ß√£o retornar√° um chunk em **`malloc_hook`** que √© poss√≠vel abusar para escrever um **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc info leak**: H√° um uso ap√≥s a libera√ß√£o e um duplo free. Neste writeup, o autor vazou um endere√ßo da libc lendo o endere√ßo de um chunk colocado em um bin pequeno (como vazando do bin n√£o ordenado, mas do pequeno).
* **Tcache attack**: Um Tcache √© realizado via um **duplo free**. O mesmo chunk √© liberado duas vezes, ent√£o dentro do Tcache o chunk apontar√° para si mesmo. Em seguida, √© alocado, seu ponteiro FD √© modificado para apontar para o **free hook** e ent√£o √© alocado novamente, de modo que o pr√≥ximo chunk na lista estar√° no free hook. Ent√£o, isso tamb√©m √© alocado e √© poss√≠vel escrever o endere√ßo de `system` aqui, para que quando um malloc contendo `"/bin/sh"` for liberado, consigamos uma shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* A principal vulnerabilidade aqui √© a capacidade de `free` qualquer endere√ßo no heap indicando seu offset.
* **Tcache indexes attack**: √â poss√≠vel alocar e liberar um chunk de um tamanho que, quando armazenado dentro do chunk tcache (o chunk com as informa√ß√µes dos bins de tcache), gerar√° um **endere√ßo com o valor 0x100**. Isso ocorre porque o tcache armazena a quantidade de chunks em cada bin em bytes diferentes, portanto, um chunk em um √≠ndice espec√≠fico gera o valor 0x100.
* Ent√£o, esse valor parece que h√° um chunk de tamanho 0x100. Permitindo abusar disso ao `free` esse endere√ßo. Isso **adicionar√° esse endere√ßo ao √≠ndice de chunks de tamanho 0x100 no tcache**.
* Ent√£o, **alocando** um chunk de tamanho **0x100**, o endere√ßo anterior ser√° retornado como um chunk, permitindo sobrescrever outros √≠ndices de tcache.\
Por exemplo, colocando o endere√ßo do malloc hook em um deles e alocando um chunk do tamanho desse √≠ndice garantir√° um chunk no calloc hook, o que permite escrever um one gadget para obter uma shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Mesma vulnerabilidade que antes com uma restri√ß√£o extra.
* **Tcache indexes attack**: Ataque semelhante ao anterior, mas usando menos etapas ao **liberar o chunk que cont√©m as informa√ß√µes do tcache**, de modo que seu endere√ßo seja adicionado ao √≠ndice de tcache de seu tamanho, permitindo alocar esse tamanho e obter as informa√ß√µes do chunk de tcache como um chunk, o que permite adicionar o free hook como o endere√ßo de um √≠ndice, aloc√°-lo e escrever um one gadget nele.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** para adicionar um n√∫mero ao ponteiro `fd`.
* Muito de **heap feng-shui** √© necess√°rio neste desafio. O writeup mostra como **controlar a cabe√ßa da lista livre do Tcache** √© bastante √∫til.
* **Glibc leak** atrav√©s de `stdout` (FSOP).
* **Tcache poisoning** para obter uma primitiva de escrita arbitr√°ria.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
