# Tcache Bin Attack

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

F√ºr weitere Informationen dar√ºber, was ein Tcache-Bin ist, siehe diese Seite:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Zun√§chst einmal ist zu beachten, dass der Tcache in Glibc Version 2.26 eingef√ºhrt wurde.

Der **Tcache-Angriff** (auch bekannt als **Tcache-Vergiftung**), der auf der [**guyinatuxido-Seite**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) vorgeschlagen wird, ist sehr √§hnlich dem Fast-Bin-Angriff, bei dem das Ziel darin besteht, den Zeiger auf den n√§chsten Chunk im Bin innerhalb eines freigegebenen Chunks auf eine beliebige Adresse zu √ºberschreiben, sodass es sp√§ter m√∂glich ist, **diese spezifische Adresse zuzuweisen und potenziell Zeiger zu √ºberschreiben**.

Heutzutage erh√§lt man jedoch, wenn man den genannten Code ausf√ºhrt, den Fehler: **`malloc(): unaligned tcache chunk detected`**. Daher ist es notwendig, als Adresse im neuen Zeiger eine ausgerichtete Adresse zu schreiben (oder das Bin√§rprogramm gen√ºgend oft auszuf√ºhren, sodass die geschriebene Adresse tats√§chlich ausgerichtet ist).

### Tcache-Indexangriff

In der Regel ist es m√∂glich, am Anfang des Heaps einen Chunk zu finden, der die **Anzahl der Chunks pro Index** im Tcache und die Adresse des **Head-Chunks jedes Tcache-Index** enth√§lt. Wenn es aus irgendeinem Grund m√∂glich ist, diese Informationen zu √§ndern, w√§re es m√∂glich, **den Head-Chunk eines Index auf eine gew√ºnschte Adresse** (wie `__malloc_hook`) zeigen zu lassen, um dann einen Chunk der Gr√∂√üe des Index zuzuweisen und den Inhalt von `__malloc_hook` in diesem Fall zu √ºberschreiben.

## Beispiele

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc-Info-Leak**: Es ist m√∂glich, die Tcache zu f√ºllen, einen Chunk in die unsortierte Liste hinzuzuf√ºgen, die Tcache zu leeren und **den Chunk aus dem unsortierten Bin erneut zuzuweisen**, indem nur die ersten 8B √ºberschrieben werden, wobei die **zweite Adresse zu libc aus dem Chunk intakt bleibt, sodass wir sie lesen k√∂nnen**.
* **Tcache-Angriff**: Das Bin√§rprogramm ist anf√§llig f√ºr einen 1B Heap-Overflow. Dies wird ausgenutzt, um den **Gr√∂√üenheader** eines zugewiesenen Chunks zu √§ndern und ihn gr√∂√üer zu machen. Dann wird dieser Chunk **freigegeben**, wodurch er zur Tcache von Chunks der gef√§lschten Gr√∂√üe hinzugef√ºgt wird. Dann werden wir einen Chunk mit der gef√§lschten Gr√∂√üe zuweisen, und der vorherige Chunk wird **zur√ºckgegeben, wobei bekannt ist, dass dieser Chunk tats√§chlich kleiner war**, was die M√∂glichkeit bietet, **den n√§chsten Chunk im Speicher zu √ºberschreiben**.\
Wir werden dies ausnutzen, um **den FD-Zeiger des n√§chsten Chunks** auf **`malloc_hook`** zu zeigen, sodass es m√∂glich ist, 2 Zeiger zuzuweisen: zuerst den legitimen Zeiger, den wir gerade ge√§ndert haben, und dann wird die zweite Zuweisung einen Chunk in **`malloc_hook`** zur√ºckgeben, den wir ausnutzen k√∂nnen, um ein **one gadget** zu schreiben.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc-Info-Leak**: Es gibt eine Verwendung nach der Freigabe und eine doppelte Freigabe. In diesem Bericht hat der Autor eine Adresse von libc geleakt, indem er die Adresse eines Chunks gelesen hat, der in einem kleinen Bin platziert wurde (wie das Leaken aus dem unsortierten Bin, aber aus dem kleinen).
* **Tcache-Angriff**: Ein Tcache wird √ºber eine **doppelte Freigabe** durchgef√ºhrt. Der gleiche Chunk wird zweimal freigegeben, sodass der Chunk innerhalb der Tcache auf sich selbst zeigt. Dann wird er zugewiesen, sein FD-Zeiger wird ge√§ndert, um auf den **free hook** zu zeigen, und dann wird er erneut zugewiesen, sodass der n√§chste Chunk in der Liste im Free Hook sein wird. Dann wird auch dieser zugewiesen, und es ist m√∂glich, die Adresse von `system` hier zu schreiben, sodass wir, wenn ein malloc mit `"/bin/sh"` freigegeben wird, eine Shell erhalten.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Die Hauptanf√§lligkeit hier ist die F√§higkeit, jede Adresse im Heap durch Angabe ihres Offsets zu `free`.
* **Tcache-Indexangriff**: Es ist m√∂glich, einen Chunk einer Gr√∂√üe zuzuweisen und freizugeben, der, wenn er im Tcache-Chunk (dem Chunk mit den Informationen der Tcache-Bins) gespeichert wird, eine **Adresse mit dem Wert 0x100** erzeugt. Dies liegt daran, dass der Tcache die Anzahl der Chunks in jedem Bin in verschiedenen Bytes speichert, sodass ein Chunk in einem bestimmten Index den Wert 0x100 erzeugt.
* Dann sieht dieser Wert so aus, als g√§be es einen Chunk der Gr√∂√üe 0x100. Dies erm√∂glicht es, ihn durch `free` dieser Adresse auszunutzen. Dies wird **diese Adresse zum Index der Chunks der Gr√∂√üe 0x100 im Tcache hinzuf√ºgen**.
* Dann wird durch **Zuweisen** eines Chunks der Gr√∂√üe **0x100** die vorherige Adresse als Chunk zur√ºckgegeben, was es erm√∂glicht, andere Tcache-Indizes zu √ºberschreiben.\
Zum Beispiel, indem die Adresse des malloc hooks in einen von ihnen gesetzt wird und ein Chunk der Gr√∂√üe dieses Index zugewiesen wird, erh√§lt man einen Chunk im calloc hook, was das Schreiben eines one gadgets erm√∂glicht, um eine Shell zu erhalten.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Die gleiche Verwundbarkeit wie zuvor mit einer zus√§tzlichen Einschr√§nkung.
* **Tcache-Indexangriff**: √Ñhnlicher Angriff wie der vorherige, aber mit weniger Schritten, indem **der Chunk, der die Tcache-Informationen enth√§lt, freigegeben wird**, sodass seine Adresse zum Tcache-Index seiner Gr√∂√üe hinzugef√ºgt wird, sodass es m√∂glich ist, diese Gr√∂√üe zuzuweisen und die Tcache-Chunk-Informationen als Chunk zu erhalten, was es erm√∂glicht, den free hook als Adresse eines Index hinzuzuf√ºgen, ihn zuzuweisen und ein one gadget darauf zu schreiben.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free**, um eine Zahl zum `fd`-Zeiger hinzuzuf√ºgen.
* Eine Menge **Heap Feng-Shui** ist in dieser Herausforderung erforderlich. Der Bericht zeigt, wie **die Kontrolle √ºber den Kopf der Tcache** Freiliste sehr n√ºtzlich ist.
* **Glibc-Leak** √ºber `stdout` (FSOP).
* **Tcache-Vergiftung**, um eine beliebige Schreibprimitive zu erhalten.

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
