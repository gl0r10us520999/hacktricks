# Ataque al Bin Tcache

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
{% endhint %}

## Informaci칩n B치sica

Para obtener m치s informaci칩n sobre qu칠 es un bin Tcache, consulta esta p치gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

En primer lugar, ten en cuenta que el Tcache fue introducido en la versi칩n 2.26 de Glibc.

El **ataque Tcache** (tambi칠n conocido como **envenenamiento Tcache**) propuesto en la [**p치gina guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) es muy similar al ataque de fast bin donde el objetivo es sobrescribir el puntero al siguiente chunk en el bin dentro de un chunk liberado a una direcci칩n arbitraria para luego **asignar esa direcci칩n espec칤fica y potencialmente sobrescribir punteros**.

Sin embargo, en la actualidad, si ejecutas el c칩digo mencionado, obtendr치s el error: **`malloc(): unaligned tcache chunk detected`**. Por lo tanto, es necesario escribir una direcci칩n alineada en el nuevo puntero (o ejecutar suficientes veces el binario para que la direcci칩n escrita est칠 realmente alineada).

### Ataque a 칤ndices Tcache

Por lo general, al principio del heap es posible encontrar un chunk que contiene la **cantidad de chunks por 칤ndice** dentro del tcache y la direcci칩n del **chunk principal de cada 칤ndice del tcache**. Si por alguna raz칩n es posible modificar esta informaci칩n, ser칤a posible **hacer que el chunk principal de alg칰n 칤ndice apunte a una direcci칩n deseada** (como `__malloc_hook`) para luego asignar un chunk del tama침o del 칤ndice y sobrescribir el contenido de `__malloc_hook` en este caso.

## Ejemplos

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuga de informaci칩n de Libc**: Es posible llenar los tcaches, agregar un chunk a la lista no ordenada, vaciar el tcache y **re-asignar el chunk desde el bin no ordenado** solo sobrescribiendo los primeros 8B, dejando la **segunda direcci칩n a libc del chunk intacta para poder leerla**.
* **Ataque Tcache**: El binario es vulnerable a un desbordamiento de heap de 1B. Esto se abusar치 para cambiar el **encabezado de tama침o** de un chunk asignado haci칠ndolo m치s grande. Luego, este chunk ser치 **liberado**, agreg치ndolo al tcache de chunks del tama침o falso. Luego, asignaremos un chunk con el tama침o falsificado, y el chunk anterior ser치 **devuelto sabiendo que este chunk era en realidad m치s peque침o** y esto nos brinda la oportunidad de **sobrescribir el siguiente chunk en memoria**.\
Esto se abusar치 para **sobrescribir el puntero FD del siguiente chunk** para que apunte a **`malloc_hook`**, por lo que luego es posible asignar 2 punteros: primero el puntero leg칤timo que acabamos de modificar, y luego la segunda asignaci칩n devolver치 un chunk en **`malloc_hook`** que es posible abusar para escribir un **gadget 칰nico**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuga de informaci칩n de Libc**: Hay un uso despu칠s de liberar y una doble liberaci칩n. En este writeup, el autor filtr칩 una direcci칩n de libc leyendo la direcci칩n de un chunk colocado en un bin peque침o (como filtrarlo desde el bin no ordenado pero desde el peque침o).
* **Ataque Tcache**: Se realiza un Tcache a trav칠s de una **doble liberaci칩n**. El mismo chunk se libera dos veces, por lo que dentro del Tcache el chunk apuntar치 a s칤 mismo. Luego, se asigna, se modifica su puntero FD para que apunte al **gancho de liberaci칩n** y luego se asigna nuevamente para que el siguiente chunk en la lista est칠 en el gancho de liberaci칩n. Luego, esto tambi칠n se asigna y es posible escribir la direcci칩n de `system` aqu칤, por lo que cuando se libera un malloc que contiene `"/bin/sh"` obtenemos una shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principal vulnerabilidad aqu칤 es la capacidad de `liberar` cualquier direcci칩n en el heap indicando su desplazamiento
* **Ataque a 칤ndices Tcache**: Es posible asignar y liberar un chunk de un tama침o que, cuando se almacena dentro del chunk tcache (el chunk con la informaci칩n de los bins tcache), generar치 una **direcci칩n con el valor 0x100**. Esto se debe a que el tcache almacena la cantidad de chunks en cada bin en bytes diferentes, por lo tanto, un chunk en un 칤ndice espec칤fico genera el valor 0x100.
* Luego, este valor parece que hay un chunk de tama침o 0x100. Permitiendo abusar de 칠l al `liberar` esta direcci칩n. Esto **agregar치 esa direcci칩n al 칤ndice de chunks de tama침o 0x100 en el tcache**.
* Luego, **asignar** un chunk de tama침o **0x100**, la direcci칩n anterior se devolver치 como un chunk, lo que permite sobrescribir otros 칤ndices tcache.\
Por ejemplo, colocar la direcci칩n de malloc hook en uno de ellos y asignar un chunk del tama침o de ese 칤ndice otorgar치 un chunk en el gancho de calloc, lo que permite escribir un gadget 칰nico para obtener una shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Misma vulnerabilidad que antes con una restricci칩n adicional
* **Ataque a 칤ndices Tcache**: Ataque similar al anterior pero usando menos pasos al **liberar el chunk que contiene la informaci칩n del tcache** para que su direcci칩n se agregue al 칤ndice tcache de su tama침o, por lo que es posible asignar ese tama침o y obtener la informaci칩n del chunk tcache como un chunk, lo que permite agregar el gancho de liberaci칩n como la direcci칩n de un 칤ndice, asignarlo y escribir un gadget 칰nico en 칠l.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** para agregar un n칰mero al puntero `fd`.
* Se necesita mucho **heap feng-shui** en este desaf칤o. El writeup muestra c칩mo **controlar la cabeza de la lista libre del Tcache** es bastante 칰til.
* **Fuga de Glibc** a trav칠s de `stdout` (FSOP).
* **Envenenamiento Tcache** para obtener un primitivo de escritura arbitraria.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.
