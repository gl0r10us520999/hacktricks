# Tcache Bin Attack

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Tcache bin hakkÄ±nda daha fazla bilgi iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Ã–ncelikle, Tcache'in Glibc sÃ¼rÃ¼m 2.26'da tanÄ±tÄ±ldÄ±ÄŸÄ±nÄ± unutmayÄ±n.

**Tcache saldÄ±rÄ±sÄ±** (aynÄ± zamanda **Tcache zehirlenmesi** olarak da bilinir) [**guyinatuxido sayfasÄ±nda**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) Ã¶nerilen, serbest bÄ±rakÄ±lmÄ±ÅŸ bir parÃ§anÄ±n iÃ§indeki bir binin sonraki parÃ§aya iÅŸaret eden iÅŸaretÃ§iyi rastgele bir adrese yazmak amacÄ±yla hÄ±zlÄ± bin saldÄ±rÄ±sÄ±na Ã§ok benzer, bÃ¶ylece daha sonra **belirli bir adresi ayÄ±rmak ve potansiyel olarak iÅŸaretÃ§ileri yazmak** mÃ¼mkÃ¼ndÃ¼r.

Ancak, gÃ¼nÃ¼mÃ¼zde, belirtilen kodu Ã§alÄ±ÅŸtÄ±rÄ±rsanÄ±z **`malloc(): unaligned tcache chunk detected`** hatasÄ±nÄ± alÄ±rsÄ±nÄ±z. Bu nedenle, yeni iÅŸaretÃ§ide yazÄ±lacak adresin hizalanmÄ±ÅŸ bir adres olmasÄ± gerekmektedir (veya yazÄ±lan adresin gerÃ§ekten hizalanmÄ±ÅŸ olmasÄ± iÃ§in ikiliyi yeterince kez Ã§alÄ±ÅŸtÄ±rmak).

### Tcache indeksleri saldÄ±rÄ±sÄ±

Genellikle, yÄ±ÄŸÄ±n baÅŸlangÄ±cÄ±nda tcache iÃ§indeki **indeks baÅŸÄ±na parÃ§a sayÄ±sÄ±nÄ±** ve **her tcache indeksinin baÅŸ parÃ§asÄ±nÄ±n adresini** iÃ§eren bir parÃ§a bulmak mÃ¼mkÃ¼ndÃ¼r. EÄŸer bu bilgiyi deÄŸiÅŸtirmek mÃ¼mkÃ¼n olursa, **bazÄ± indekslerin baÅŸ parÃ§asÄ±nÄ± istenen bir adrese** (Ã¶rneÄŸin `__malloc_hook`) iÅŸaret edecek ÅŸekilde ayarlamak mÃ¼mkÃ¼n olacaktÄ±r, bÃ¶ylece indeks boyutunda bir parÃ§a ayÄ±rabilir ve bu durumda `__malloc_hook` iÃ§eriÄŸini yazabiliriz.

## Ã–rnekler

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc bilgi sÄ±zÄ±ntÄ±sÄ±**: Tcache'leri doldurmak, dÃ¼zensiz listeye bir parÃ§a eklemek, tcache'i boÅŸaltmak ve **dÃ¼zensiz binin iÃ§inden parÃ§ayÄ± yeniden ayÄ±rmak** mÃ¼mkÃ¼ndÃ¼r, sadece ilk 8B'yi yazarak, parÃ§anÄ±n **ikinci adresini libc'den saÄŸlam tutarak okuyabiliriz**.
* **Tcache saldÄ±rÄ±sÄ±**: Ä°kili, 1B yÄ±ÄŸÄ±n taÅŸmasÄ± aÃ§Ä±sÄ±ndan savunmasÄ±zdÄ±r. Bu, bir ayrÄ±lmÄ±ÅŸ parÃ§anÄ±n **boyut baÅŸlÄ±ÄŸÄ±nÄ±** deÄŸiÅŸtirerek daha bÃ¼yÃ¼k hale getirmek iÃ§in kullanÄ±lacaktÄ±r. ArdÄ±ndan, bu parÃ§a **serbest bÄ±rakÄ±lacak**, sahte boyutun tcache'ine eklenecektir. Sonra, sahte boyutta bir parÃ§a ayÄ±racaÄŸÄ±z ve Ã¶nceki parÃ§a **bu parÃ§anÄ±n aslÄ±nda daha kÃ¼Ã§Ã¼k olduÄŸunu bilerek dÃ¶necektir** ve bu, **bellekteki bir sonraki parÃ§ayÄ± yazma fÄ±rsatÄ±nÄ± saÄŸlar**.\
Bunu, **bir sonraki parÃ§anÄ±n FD iÅŸaretÃ§isini** **`malloc_hook`**'a iÅŸaret edecek ÅŸekilde yazmak iÃ§in kullanacaÄŸÄ±z, bÃ¶ylece iki iÅŸaretÃ§i ayÄ±rmak mÃ¼mkÃ¼n olacaktÄ±r: Ã¶nce deÄŸiÅŸtirdiÄŸimiz geÃ§erli iÅŸaretÃ§i, ardÄ±ndan ikinci ayÄ±rma **`malloc_hook`**'ta bir parÃ§a dÃ¶ndÃ¼recektir ve bu, **bir gadget** yazmak iÃ§in istismar edilebilir.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc bilgi sÄ±zÄ±ntÄ±sÄ±**: Bir serbest bÄ±rakma sonrasÄ± kullanÄ±m ve Ã§ift serbest bÄ±rakma vardÄ±r. Bu yazÄ±da yazar, kÃ¼Ã§Ã¼k bir bin iÃ§inde yer alan bir parÃ§anÄ±n adresini okuyarak libc'nin bir adresini sÄ±zdÄ±rdÄ± (dÃ¼zensiz binin iÃ§inden sÄ±zdÄ±rmak gibi ama kÃ¼Ã§Ã¼k olanÄ±ndan).
* **Tcache saldÄ±rÄ±sÄ±**: Bir Tcache, **Ã§ift serbest bÄ±rakma** yoluyla gerÃ§ekleÅŸtirilir. AynÄ± parÃ§a iki kez serbest bÄ±rakÄ±lÄ±r, bu nedenle Tcache iÃ§inde parÃ§a kendisine iÅŸaret eder. ArdÄ±ndan, ayrÄ±lÄ±r, FD iÅŸaretÃ§isi **serbest kancaya** iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirilir ve sonra tekrar ayrÄ±lÄ±r, bÃ¶ylece listedeki bir sonraki parÃ§a serbest kancada olacaktÄ±r. ArdÄ±ndan, bu da ayrÄ±lÄ±r ve burada `system` adresini yazmak mÃ¼mkÃ¼ndÃ¼r, bÃ¶ylece `"/bin/sh"` iÃ§eren bir malloc serbest bÄ±rakÄ±ldÄ±ÄŸÄ±nda bir shell alÄ±rÄ±z.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* Buradaki ana zafiyet, yÄ±ÄŸÄ±n iÃ§inde herhangi bir adresi `free` etme kapasitesidir, ofsetini belirterek.
* **Tcache indeksleri saldÄ±rÄ±sÄ±**: Tcache parÃ§a bilgisi iÃ§eren bir parÃ§anÄ±n boyutunun, tcache parÃ§a bilgisi iÃ§inde depolandÄ±ÄŸÄ±nda **0x100 deÄŸeri** Ã¼retecek ÅŸekilde ayrÄ±lmasÄ± ve serbest bÄ±rakÄ±lmasÄ± mÃ¼mkÃ¼ndÃ¼r. Bu, tcache'in her binin iÃ§indeki parÃ§a sayÄ±sÄ±nÄ± farklÄ± baytlarda depolamasÄ±ndan kaynaklanmaktadÄ±r, bu nedenle belirli bir indekste bir parÃ§a 0x100 deÄŸerini Ã¼retir.
* ArdÄ±ndan, bu deÄŸer 0x100 boyutunda bir parÃ§a varmÄ±ÅŸ gibi gÃ¶rÃ¼nÃ¼r. Bu, bu adresi `free` ederek istismar etmeyi saÄŸlar. Bu, **o adresi tcache'deki 0x100 boyutundaki parÃ§alarÄ±n indeksine ekleyecektir**.
* Sonra, **0x100** boyutunda bir parÃ§a **ayÄ±rarak**, Ã¶nceki adres bir parÃ§a olarak dÃ¶necek ve diÄŸer tcache indekslerini yazma imkanÄ± saÄŸlayacaktÄ±r.\
Ã–rneÄŸin, malloc kancasÄ± adresini bunlardan birine koymak ve o indeksin boyutunda bir parÃ§a ayÄ±rmak, calloc kancasÄ±nda bir parÃ§a elde etmemizi saÄŸlayacak, bu da bir gadget yazmak iÃ§in bir shell elde etmemizi saÄŸlar.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Ã–ncekine benzer bir zafiyet, ancak bir ekstra kÄ±sÄ±tlama ile.
* **Tcache indeksleri saldÄ±rÄ±sÄ±**: Ã–ncekine benzer bir saldÄ±rÄ±, ancak **tcache bilgilerini iÃ§eren parÃ§ayÄ± serbest bÄ±rakarak** daha az adÄ±m kullanarak gerÃ§ekleÅŸtirilir, bÃ¶ylece adresi boyutunun tcache indeksine eklenir, bÃ¶ylece o boyutta ayÄ±rmak ve tcache parÃ§a bilgilerini bir parÃ§a olarak almak mÃ¼mkÃ¼n olur, bu da serbest kancayÄ± bir indeksin adresi olarak eklemeyi, ayÄ±rmayÄ± ve Ã¼zerine bir gadget yazmayÄ± saÄŸlar.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* `fd` iÅŸaretÃ§isine bir sayÄ± eklemek iÃ§in **Write After Free**.
* Bu zorlukta Ã§ok fazla **heap feng-shui** gereklidir. YazÄ±, **Tcache** serbest listesi baÅŸÄ±nÄ± kontrol etmenin oldukÃ§a kullanÄ±ÅŸlÄ± olduÄŸunu gÃ¶steriyor.
* `stdout` Ã¼zerinden **Glibc sÄ±zÄ±ntÄ±sÄ±** (FSOP).
* Rastgele bir yazma ilkesine ulaÅŸmak iÃ§in **Tcache zehirlenmesi**. 

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
