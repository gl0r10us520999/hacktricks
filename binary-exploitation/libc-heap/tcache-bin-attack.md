# Tcache Bin Attack

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

Aby uzyska wicej informacji na temat tego, czym jest Tcache bin, sprawd藕 t stron:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Przede wszystkim zauwa偶, 偶e Tcache zosta wprowadzony w wersji Glibc 2.26.

**Atak Tcache** (znany r贸wnie偶 jako **trucie Tcache**) zaproponowany na stronie [**guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) jest bardzo podobny do ataku na szybkie biny, gdzie celem jest nadpisanie wska藕nika do nastpnego kawaka w binie wewntrz zwolnionego kawaka na dowolny adres, aby p贸藕niej mo偶na byo **przydzieli ten konkretny adres i potencjalnie nadpisa wska藕niki**.

Jednak obecnie, jeli uruchomisz wspomniany kod, otrzymasz bd: **`malloc(): unaligned tcache chunk detected`**. Dlatego konieczne jest zapisanie jako adres w nowym wska藕niku wyr贸wnanego adresu (lub wykonanie wystarczajcej liczby razy binarnego, aby zapisany adres by faktycznie wyr贸wnany).

### Atak na indeksy Tcache

Zazwyczaj na pocztku sterty mo偶na znale藕 kawaek zawierajcy **liczb kawak贸w na indeks** wewntrz tcache oraz adres do **g贸wnego kawaka ka偶dego indeksu tcache**. Jeli z jakiego powodu mo偶liwe jest modyfikowanie tych informacji, mo偶na **sprawi, aby g贸wny kawaek niekt贸rego indeksu wskazywa na po偶dany adres** (np. `__malloc_hook`), aby nastpnie przydzieli kawaek o rozmiarze indeksu i nadpisa zawarto `__malloc_hook` w tym przypadku.

## Przykady

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Wycieki informacji z Libc**: Mo偶liwe jest wypenienie tcache, dodanie kawaka do nieposortowanej listy, opr贸偶nienie tcache i **ponowne przydzielenie kawaka z nieposortowanego binu** tylko nadpisujc pierwsze 8B, pozostawiajc **drugi adres do libc z kawaka nietknity, aby m贸c go odczyta**.
* **Atak Tcache**: Binarne jest podatne na 1B przepenienie sterty. To zostanie wykorzystane do zmiany **nag贸wka rozmiaru** przydzielonego kawaka, czynic go wikszym. Nastpnie ten kawaek zostanie **zwolniony**, dodajc go do tcache kawak贸w o faszywym rozmiarze. Nastpnie przydzielimy kawaek o faszywym rozmiarze, a poprzedni kawaek zostanie **zwr贸cony, wiedzc, 偶e ten kawaek by faktycznie mniejszy**, co daje mo偶liwo **nadpisania nastpnego kawaka w pamici**.\
Wykorzystamy to do **nadpisania wska藕nika FD nastpnego kawaka**, aby wskazywa na **`malloc_hook`**, aby nastpnie mo偶na byo przydzieli 2 wska藕niki: najpierw legitny wska藕nik, kt贸ry wanie zmodyfikowalimy, a nastpnie drugie przydzielenie zwr贸ci kawaek w **`malloc_hook`**, kt贸ry mo偶na wykorzysta do zapisania **jednego gad偶etu**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Wycieki informacji z Libc**: Istnieje u偶ycie po zwolnieniu i podw贸jne zwolnienie. W tym opisie autor wyciek adres libc, odczytujc adres kawaka umieszczonego w maym binie (jak wyciekajc go z nieposortowanego binu, ale z maego).
* **Atak Tcache**: Atak Tcache jest przeprowadzany za pomoc **podw贸jnego zwolnienia**. Ten sam kawaek jest zwalniany dwa razy, wic wewntrz Tcache kawaek bdzie wskazywa na siebie. Nastpnie jest przydzielany, jego wska藕nik FD jest modyfikowany, aby wskazywa na **free hook**, a nastpnie jest ponownie przydzielany, wic nastpny kawaek na licie bdzie w free hook. Nastpnie ten kawaek jest r贸wnie偶 przydzielany i mo偶liwe jest zapisanie adresu `system` tutaj, wic gdy malloc zawierajcy `"/bin/sh"` zostanie zwolniony, uzyskujemy powok.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* G贸wna podatno tutaj to mo偶liwo `free` dowolnego adresu w stercie, wskazujc jego offset.
* **Atak na indeksy Tcache**: Mo偶liwe jest przydzielenie i zwolnienie kawaka o rozmiarze, kt贸ry po zapisaniu wewntrz kawaka tcache (kawaka z informacjami o binach tcache) wygeneruje **adres o wartoci 0x100**. Dzieje si tak, poniewa偶 tcache przechowuje liczb kawak贸w w ka偶dym binie w r贸偶nych bajtach, dlatego jeden kawaek w jednym konkretnym indeksie generuje warto 0x100.
* Nastpnie ta warto wyglda, jakby istnia kawaek o rozmiarze 0x100. Umo偶liwiajc nadu偶ycie tego przez `free` ten adres. To **doda ten adres do indeksu kawak贸w o rozmiarze 0x100 w tcache**.
* Nastpnie, **przydzielajc** kawaek o rozmiarze **0x100**, poprzedni adres zostanie zwr贸cony jako kawaek, co pozwoli na nadpisanie innych indeks贸w tcache.\
Na przykad umieszczajc adres malloc hook w jednym z nich i przydzielajc kawaek o rozmiarze tego indeksu, uzyskamy kawaek w calloc hook, co pozwala na zapisanie jednego gad偶etu, aby uzyska powok.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Ta sama podatno co wczeniej z jednym dodatkowym ograniczeniem.
* **Atak na indeksy Tcache**: Podobny atak do poprzedniego, ale z mniejsz liczb krok贸w, poprzez **zwolnienie kawaka, kt贸ry zawiera informacje o tcache**, aby jego adres zosta dodany do indeksu tcache o jego rozmiarze, wic mo偶liwe jest przydzielenie tego rozmiaru i uzyskanie informacji o kawaku tcache jako kawaka, co pozwala na dodanie free hook jako adresu jednego indeksu, przydzielenie go i zapisanie jednego gad偶etu na nim.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Zapis po zwolnieniu** w celu dodania liczby do wska藕nika `fd`.
* W tym wyzwaniu potrzebne jest du偶o **feng-shui sterty**. Opis pokazuje, jak **kontrolowanie gowy Tcache** listy zwolnionych jest bardzo przydatne.
* **Wycieki Glibc** przez `stdout` (FSOP).
* **Trucie Tcache** w celu uzyskania dowolnej prymitywy zapisu.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
