# Attaque de la Tcache

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

Pour plus d'informations sur ce qu'est un Tcache bin, consultez cette page :

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Tout d'abord, notez que la Tcache a √©t√© introduite dans la version 2.26 de Glibc.

L'**attaque de la Tcache** (√©galement connue sous le nom de **poisoning de la Tcache**) propos√©e dans la [**page guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) est tr√®s similaire √† l'attaque de la fast bin o√π le but est de remplacer le pointeur vers le chunk suivant dans le bin √† l'int√©rieur d'un chunk lib√©r√© par une adresse arbitraire afin de **pouvoir allouer cette adresse sp√©cifique et potentiellement √©craser des pointeurs**.

Cependant, de nos jours, si vous ex√©cutez le code mentionn√©, vous obtiendrez l'erreur : **`malloc(): unaligned tcache chunk detected`**. Il est donc n√©cessaire d'√©crire une adresse align√©e dans le nouveau pointeur (ou d'ex√©cuter suffisamment de fois le binaire pour que l'adresse √©crite soit effectivement align√©e).

### Attaque des index de la Tcache

Il est g√©n√©ralement possible de trouver au d√©but du tas un chunk contenant la **quantit√© de chunks par index** √† l'int√©rieur de la tcache et l'adresse de la **t√™te du chunk de chaque index de la tcache**. Si, pour une raison quelconque, il est possible de modifier ces informations, il serait possible de **faire pointer la t√™te du chunk de certains index vers une adresse souhait√©e** (comme `__malloc_hook`) pour ensuite allouer un chunk de la taille de l'index et √©craser le contenu de `__malloc_hook` dans ce cas.

## Exemples

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuite d'informations sur Libc** : Il est possible de remplir les tcaches, d'ajouter un chunk dans la liste non tri√©e, de vider la tcache et de **r√©-allouer le chunk de la liste non tri√©e** en ne rempla√ßant que les premiers 8B, laissant la **deuxi√®me adresse de Libc du chunk intacte pour que nous puissions la lire**.
* **Attaque de la Tcache** : Le binaire est vuln√©rable √† un d√©bordement de tas de 1B. Cela sera exploit√© pour modifier l'**en-t√™te de taille** d'un chunk allou√© le rendant plus grand. Ensuite, ce chunk sera **lib√©r√©**, ajout√© √† la tcache des chunks de la fausse taille. Ensuite, nous allouerons un chunk avec la taille falsifi√©e, et le chunk pr√©c√©dent sera **retourn√© en sachant que ce chunk √©tait en r√©alit√© plus petit** et cela ouvre la possibilit√© de **√©craser le chunk suivant en m√©moire**.\
Nous allons exploiter cela pour **√©craser le pointeur FD du chunk suivant** pour pointer vers **`malloc_hook`**, puis il est possible d'allouer 2 pointeurs : d'abord le pointeur l√©gitime que nous venons de modifier, puis la deuxi√®me allocation renverra un chunk dans **`malloc_hook`** qu'il est possible d'exploiter pour √©crire un **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuite d'informations sur Libc** : Il y a une utilisation apr√®s lib√©ration et une double lib√©ration. Dans ce compte rendu, l'auteur a divulgu√© une adresse de Libc en lisant l'adresse d'un chunk plac√© dans un petit bin (comme en le fuyant du bin non tri√© mais du petit).
* **Attaque de la Tcache** : Une Tcache est effectu√©e via une **double lib√©ration**. Le m√™me chunk est lib√©r√© deux fois, donc √† l'int√©rieur de la Tcache, le chunk pointera vers lui-m√™me. Ensuite, il est allou√©, son pointeur FD est modifi√© pour pointer vers le **free hook** puis il est allou√© √† nouveau de sorte que le chunk suivant dans la liste sera dans le free hook. Ensuite, celui-ci est √©galement allou√© et il est possible d'√©crire l'adresse de `system` ici, donc lorsqu'un malloc contenant `"/bin/sh"` est lib√©r√©, nous obtenons un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principale vuln√©rabilit√© ici est la capacit√© de `lib√©rer` n'importe quelle adresse dans le tas en indiquant son d√©calage
* **Attaque des index de la Tcache** : Il est possible d'allouer et de lib√©rer un chunk d'une taille telle que lorsqu'il est stock√© √† l'int√©rieur du chunk de la tcache (le chunk avec les informations des bins de la tcache) il g√©n√©rera une **adresse avec la valeur 0x100**. Cela est d√ª au fait que la tcache stocke la quantit√© de chunks sur chaque bin dans des octets diff√©rents, donc un chunk dans un index sp√©cifique g√©n√®re la valeur 0x100.
* Ensuite, cette valeur ressemble √† un chunk de taille 0x100. Permettant de l'exploiter en le `lib√©rant`. Cela ajoutera cette adresse √† l'index des chunks de taille 0x100 dans la tcache.
* Ensuite, en **allouant** un chunk de taille **0x100**, l'adresse pr√©c√©dente sera retourn√©e en tant que chunk, permettant d'√©craser d'autres index de la tcache.\
Par exemple, en mettant l'adresse de malloc hook dans l'un d'eux et en allouant un chunk de la taille de cet index, un chunk dans calloc hook sera accord√©, ce qui permet d'√©crire un one gadget pour obtenir un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* M√™me vuln√©rabilit√© qu'auparavant avec une restriction suppl√©mentaire
* **Attaque des index de la Tcache** : Attaque similaire √† la pr√©c√©dente mais en utilisant moins d'√©tapes en **lib√©rant le chunk qui contient les informations de la tcache** afin que son adresse soit ajout√©e √† l'index de la tcache de sa taille, il est donc possible d'allouer cette taille et d'obtenir les informations de la tcache comme un chunk, ce qui permet d'ajouter le free hook en tant qu'adresse d'un index, de l'allouer et d'√©crire un one gadget dessus.
* [**Porte math√©matique. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** pour ajouter un nombre au pointeur `fd`.
* Beaucoup de **heap feng-shui** est n√©cessaire dans ce d√©fi. Le compte rendu montre comment **contr√¥ler la t√™te de la liste libre de la Tcache** est tr√®s pratique.
* **Fuite de Glibc** via `stdout` (FSOP).
* **Empoisonnement de la Tcache** pour obtenir un primitive d'√©criture arbitraire.
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux d√©p√¥ts** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.
