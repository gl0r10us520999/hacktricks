# Tcache Bin Attack

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}

## 基本情報

Tcacheビンについての詳細は、このページを確認してください：

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

まず、TcacheはGlibcバージョン2.26で導入されたことに注意してください。

**Tcache攻撃**（**Tcacheポイズニング**とも呼ばれる）は、[**guyinatuxidoページ**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html)で提案されており、目標は解放されたチャンク内のビンの次のチャンクへのポインタを任意のアドレスに上書きすることです。その後、特定のアドレスを**割り当ててポインタを上書きする**ことが可能になります。

しかし、現在、前述のコードを実行すると、エラーが発生します：**`malloc(): unaligned tcache chunk detected`**。したがって、新しいポインタに書き込むアドレスはアラインされたアドレスである必要があります（または、書き込まれたアドレスが実際にアラインされるまでバイナリを十分に実行する必要があります）。

### Tcacheインデックス攻撃

通常、ヒープの最初に**インデックスごとのチャンクの数**を含むチャンクと、各Tcacheインデックスの**ヘッドチャンクへのアドレス**が見つかります。何らかの理由でこの情報を変更できる場合、**特定のインデックスのヘッドチャンクを希望のアドレス**（例えば`__malloc_hook`）にポイントさせることが可能になり、その後、インデックスのサイズのチャンクを割り当てて、`__malloc_hook`の内容を上書きすることができます。

## 例

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc情報漏洩**：Tcacheを満たし、未整理リストにチャンクを追加し、Tcacheを空にし、**未整理ビンからチャンクを再割り当てする**ことが可能です。最初の8Bを上書きするだけで、**チャンクからのlibcへの2番目のアドレスをそのままにしておくことができます**。
* **Tcache攻撃**：バイナリは1Bヒープオーバーフローに対して脆弱です。これを利用して、割り当てられたチャンクの**サイズヘッダー**を変更して大きくします。その後、このチャンクは**解放され**、偽のサイズのチャンクのTcacheに追加されます。次に、偽のサイズのチャンクを割り当てると、前のチャンクが**返され、実際にはこのチャンクが小さかったことがわかります**。これにより、**メモリ内の次のチャンクを上書きする**機会が得られます。\
この機会を利用して、**次のチャンクのFDポインタを**`malloc_hook`にポイントさせ、次に2つのポインタを割り当てることが可能になります：最初は修正した正当なポインタ、次に2回目の割り当ては**`malloc_hook`**内のチャンクを返し、これを利用して**ワンガジェット**を書き込むことができます。
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc情報漏洩**：使用後の解放と二重解放があります。この書き込みでは、著者は小さなビンに配置されたチャンクのアドレスを読み取ることでlibcのアドレスを漏洩しました（未整理ビンから漏洩するのと同様ですが、小さなビンからです）。
* **Tcache攻撃**：Tcacheは**二重解放**を介して実行されます。同じチャンクが2回解放されるため、Tcache内でチャンクは自分自身を指します。その後、割り当てられ、FDポインタが**フリーフック**を指すように変更され、再度割り当てられると、リスト内の次のチャンクがフリーフックに配置されます。次に、これも割り当てられ、ここに`system`のアドレスを書き込むことが可能です。これにより、`"/bin/sh"`を含むmallocが解放されると、シェルが得られます。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* ここでの主な脆弱性は、オフセットを指定することでヒープ内の任意のアドレスを`free`できる能力です。
* **Tcacheインデックス攻撃**：Tcacheチャンク（Tcacheビンの情報を持つチャンク）内に格納されるサイズのチャンクを割り当てて解放することで、**値0x100のアドレスを生成する**ことが可能です。これは、Tcacheが各ビンのチャンク数を異なるバイトに格納するため、特定のインデックスのチャンクが値0x100を生成するからです。
* 次に、この値はサイズ0x100のチャンクが存在するように見えます。これにより、このアドレスを`free`することで悪用できます。これにより、**そのアドレスがTcache内のサイズ0x100のチャンクのインデックスに追加されます**。
* 次に、**サイズ0x100のチャンクを割り当てると、前のアドレスがチャンクとして返され、他のTcacheインデックスを上書きすることが可能になります。**\
例えば、mallocフックのアドレスをそのうちの1つに入れ、そのインデックスのサイズのチャンクを割り当てることで、callocフック内のチャンクを得ることができ、これにワンガジェットを書き込んでシェルを取得できます。
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* 前回と同じ脆弱性ですが、1つの追加制限があります。
* **Tcacheインデックス攻撃**：前回の攻撃に似ていますが、**Tcache情報を含むチャンクを解放することによって、より少ないステップで実行されます**。これにより、そのアドレスがそのサイズのTcacheインデックスに追加され、そのサイズを割り当ててTcacheチャンク情報をチャンクとして取得できるようになります。これにより、フリーフックをインデックスのアドレスとして追加し、それを割り当ててワンガジェットを書き込むことが可能になります。
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* `fd`ポインタに数値を追加するための**Write After Free**。
* このチャレンジでは多くの**ヒープフェンシュイ**が必要です。書き込みでは、**Tcache**のフリーリストのヘッドを制御することが非常に便利であることが示されています。
* `stdout`を介した**Glibc漏洩**（FSOP）。
* 任意の書き込みプリミティブを取得するための**Tcacheポイズニング**。

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}
