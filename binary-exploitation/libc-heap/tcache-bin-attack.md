# Tcache Bin Attack

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æœ‰å…³ Tcache bin çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

é¦–å…ˆï¼Œè¯·æ³¨æ„ Tcache æ˜¯åœ¨ Glibc ç‰ˆæœ¬ 2.26 ä¸­å¼•å…¥çš„ã€‚

**Tcache æ”»å‡»**ï¼ˆä¹Ÿç§°ä¸º **Tcache ä¸­æ¯’**ï¼‰åœ¨ [**guyinatuxido é¡µé¢**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) ä¸­æå‡ºï¼Œä¸å¿«é€Ÿ bin æ”»å‡»éå¸¸ç›¸ä¼¼ï¼Œå…¶ç›®æ ‡æ˜¯åœ¨å·²é‡Šæ”¾çš„ chunk ä¸­è¦†ç›–æŒ‡å‘ä¸‹ä¸€ä¸ª chunk çš„æŒ‡é’ˆï¼Œä»¥æŒ‡å‘ä»»æ„åœ°å€ï¼Œä»¥ä¾¿åç»­å¯ä»¥ **åˆ†é…è¯¥ç‰¹å®šåœ°å€å¹¶å¯èƒ½è¦†ç›–æŒ‡é’ˆ**ã€‚

ç„¶è€Œï¼Œå¦‚ä»Šï¼Œå¦‚æœæ‚¨è¿è¡Œä¸Šè¿°ä»£ç ï¼Œæ‚¨å°†æ”¶åˆ°é”™è¯¯ï¼š**`malloc(): unaligned tcache chunk detected`**ã€‚å› æ­¤ï¼Œéœ€è¦åœ¨æ–°æŒ‡é’ˆä¸­å†™å…¥ä¸€ä¸ªå¯¹é½çš„åœ°å€ï¼ˆæˆ–å¤šæ¬¡æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥ä¾¿å†™å…¥çš„åœ°å€å®é™…ä¸Šæ˜¯å¯¹é½çš„ï¼‰ã€‚

### Tcache ç´¢å¼•æ”»å‡»

é€šå¸¸å¯ä»¥åœ¨å †çš„å¼€å¤´æ‰¾åˆ°ä¸€ä¸ª chunkï¼Œå…¶ä¸­åŒ…å« **æ¯ä¸ªç´¢å¼•çš„ chunk æ•°é‡** å’ŒæŒ‡å‘ **æ¯ä¸ª tcache ç´¢å¼•çš„å¤´ chunk çš„åœ°å€**ã€‚å¦‚æœå‡ºäºæŸç§åŸå› å¯ä»¥ä¿®æ”¹æ­¤ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ **ä½¿æŸä¸ªç´¢å¼•çš„å¤´ chunk æŒ‡å‘æ‰€éœ€åœ°å€**ï¼ˆå¦‚ `__malloc_hook`ï¼‰ï¼Œç„¶ååˆ†é…ä¸€ä¸ªä¸ç´¢å¼•å¤§å°ç›¸åŒçš„ chunkï¼Œå¹¶åœ¨è¿™ç§æƒ…å†µä¸‹è¦†ç›– `__malloc_hook` çš„å†…å®¹ã€‚

## ç¤ºä¾‹

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Libc ä¿¡æ¯æ³„éœ²**ï¼šå¯ä»¥å¡«å…… tcachesï¼Œå°†ä¸€ä¸ª chunk æ·»åŠ åˆ°æœªæ’åºåˆ—è¡¨ä¸­ï¼Œæ¸…ç©º tcache å¹¶ **ä»…è¦†ç›–å‰ 8B ä»æœªæ’åº bin ä¸­é‡æ–°åˆ†é… chunk**ï¼Œä¿ç•™ **æ¥è‡ª chunk çš„ç¬¬äºŒä¸ª libc åœ°å€ä¸å˜ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è¯»å–å®ƒ**ã€‚
* **Tcache æ”»å‡»**ï¼šè¯¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜“å— 1B å †æº¢å‡ºæ”»å‡»ã€‚è¿™å°†è¢«æ»¥ç”¨ä»¥æ›´æ”¹å·²åˆ†é… chunk çš„ **å¤§å°å¤´**ï¼Œä½¿å…¶å˜å¤§ã€‚ç„¶åï¼Œè¿™ä¸ª chunk å°†è¢« **é‡Šæ”¾**ï¼Œå°†å…¶æ·»åŠ åˆ°å‡å¤§å°çš„ tcache ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†åˆ†é…ä¸€ä¸ªå‡å¤§å°çš„ chunkï¼Œä¹‹å‰çš„ chunk å°†è¢« **è¿”å›ï¼ŒçŸ¥é“è¿™ä¸ª chunk å®é™…ä¸Šæ›´å°**ï¼Œè¿™ä¸º **è¦†ç›–å†…å­˜ä¸­çš„ä¸‹ä¸€ä¸ª chunk** æä¾›äº†æœºä¼šã€‚\
æˆ‘ä»¬å°†åˆ©ç”¨è¿™ä¸€ç‚¹ **è¦†ç›–ä¸‹ä¸€ä¸ª chunk çš„ FD æŒ‡é’ˆ**ï¼Œä½¿å…¶æŒ‡å‘ **`malloc_hook`**ï¼Œç„¶åå¯ä»¥åˆ†é… 2 ä¸ªæŒ‡é’ˆï¼šé¦–å…ˆæ˜¯æˆ‘ä»¬åˆšåˆšä¿®æ”¹çš„åˆæ³•æŒ‡é’ˆï¼Œç„¶åç¬¬äºŒæ¬¡åˆ†é…å°†è¿”å›ä¸€ä¸ªåœ¨ **`malloc_hook`** ä¸­çš„ chunkï¼Œå¯ä»¥åˆ©ç”¨å®ƒå†™å…¥ **one gadget**ã€‚
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Libc ä¿¡æ¯æ³„éœ²**ï¼šå­˜åœ¨ä½¿ç”¨åé‡Šæ”¾å’ŒåŒé‡é‡Šæ”¾ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä½œè€…é€šè¿‡è¯»å–æ”¾ç½®åœ¨å° bin ä¸­çš„ chunk çš„åœ°å€æ³„éœ²äº† libc çš„åœ°å€ï¼ˆå°±åƒä»æœªæ’åº bin ä¸­æ³„éœ²ï¼Œä½†æ¥è‡ªå° binï¼‰ã€‚
* **Tcache æ”»å‡»**ï¼šé€šè¿‡ **åŒé‡é‡Šæ”¾** æ‰§è¡Œ Tcacheã€‚ç›¸åŒçš„ chunk è¢«é‡Šæ”¾ä¸¤æ¬¡ï¼Œå› æ­¤åœ¨ Tcache ä¸­ï¼Œchunk å°†æŒ‡å‘è‡ªèº«ã€‚ç„¶åï¼Œå®ƒè¢«åˆ†é…ï¼Œå…¶ FD æŒ‡é’ˆè¢«ä¿®æ”¹ä¸ºæŒ‡å‘ **free hook**ï¼Œç„¶åå†æ¬¡åˆ†é…ï¼Œå› æ­¤åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª chunk å°†åœ¨ free hook ä¸­ã€‚ç„¶åï¼Œè¿™ä¹Ÿè¢«åˆ†é…ï¼Œå¯ä»¥åœ¨è¿™é‡Œå†™å…¥ `system` çš„åœ°å€ï¼Œå› æ­¤å½“åŒ…å« `"/bin/sh"` çš„ malloc è¢«é‡Šæ”¾æ—¶ï¼Œæˆ‘ä»¬è·å¾—ä¸€ä¸ª shellã€‚
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* è¿™é‡Œçš„ä¸»è¦æ¼æ´æ˜¯é€šè¿‡æŒ‡ç¤ºå…¶åç§»é‡ `free` å †ä¸­çš„ä»»ä½•åœ°å€çš„èƒ½åŠ›ã€‚
* **Tcache ç´¢å¼•æ”»å‡»**ï¼šå¯ä»¥åˆ†é…å’Œé‡Šæ”¾ä¸€ä¸ªå¤§å°çš„ chunkï¼Œå½“å­˜å‚¨åœ¨ tcache chunk ä¸­ï¼ˆåŒ…å« tcache bins ä¿¡æ¯çš„ chunkï¼‰æ—¶ï¼Œå°†ç”Ÿæˆä¸€ä¸ª **å€¼ä¸º 0x100 çš„åœ°å€**ã€‚è¿™æ˜¯å› ä¸º tcache åœ¨ä¸åŒå­—èŠ‚ä¸­å­˜å‚¨æ¯ä¸ª bin çš„ chunk æ•°é‡ï¼Œå› æ­¤ä¸€ä¸ªç‰¹å®šç´¢å¼•ä¸­çš„ chunk ç”Ÿæˆå€¼ 0x100ã€‚
* ç„¶åï¼Œè¿™ä¸ªå€¼çœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º 0x100 çš„ chunkã€‚å…è®¸é€šè¿‡ `free` è¿™ä¸ªåœ°å€æ¥æ»¥ç”¨å®ƒã€‚è¿™å°† **å°†è¯¥åœ°å€æ·»åŠ åˆ° tcache ä¸­å¤§å°ä¸º 0x100 çš„ chunk çš„ç´¢å¼•**ã€‚
* ç„¶åï¼Œ**åˆ†é…** ä¸€ä¸ªå¤§å°ä¸º **0x100** çš„ chunkï¼Œä¹‹å‰çš„åœ°å€å°†ä½œä¸º chunk è¿”å›ï¼Œä»è€Œå…è®¸è¦†ç›–å…¶ä»– tcache ç´¢å¼•ã€‚\
ä¾‹å¦‚ï¼Œå°† malloc hook çš„åœ°å€æ”¾å…¥å…¶ä¸­ä¸€ä¸ªç´¢å¼•ä¸­ï¼Œå¹¶åˆ†é…ä¸è¯¥ç´¢å¼•å¤§å°ç›¸åŒçš„ chunk å°†è·å¾—ä¸€ä¸ªåœ¨ calloc hook ä¸­çš„ chunkï¼Œè¿™å…è®¸å†™å…¥ä¸€ä¸ª gadget ä»¥è·å¾— shellã€‚
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* ä¸ä¹‹å‰ç›¸åŒçš„æ¼æ´ï¼Œä½†æœ‰ä¸€ä¸ªé¢å¤–çš„é™åˆ¶ã€‚
* **Tcache ç´¢å¼•æ”»å‡»**ï¼šä¸ä¹‹å‰ç±»ä¼¼çš„æ”»å‡»ï¼Œä½†é€šè¿‡ **é‡Šæ”¾åŒ…å« tcache ä¿¡æ¯çš„ chunk** æ¥ä½¿ç”¨æ›´å°‘çš„æ­¥éª¤ï¼Œå› æ­¤å®ƒçš„åœ°å€è¢«æ·»åŠ åˆ°å…¶å¤§å°çš„ tcache ç´¢å¼•ä¸­ï¼Œå› æ­¤å¯ä»¥åˆ†é…è¯¥å¤§å°å¹¶å°† tcache chunk ä¿¡æ¯ä½œä¸º chunk è·å–ï¼Œè¿™å…è®¸å°† free hook æ·»åŠ ä¸ºä¸€ä¸ªç´¢å¼•çš„åœ°å€ï¼Œåˆ†é…å®ƒï¼Œå¹¶åœ¨å…¶ä¸Šå†™å…¥ä¸€ä¸ª gadgetã€‚
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **å†™åé‡Šæ”¾** ä»¥å°†æ•°å­—æ·»åŠ åˆ° `fd` æŒ‡é’ˆã€‚
* åœ¨è¿™ä¸ªæŒ‘æˆ˜ä¸­éœ€è¦å¤§é‡çš„ **å †é£æ°´**ã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº† **æ§åˆ¶ Tcache** ç©ºé—²åˆ—è¡¨çš„å¤´éƒ¨æ˜¯å¤šä¹ˆæ–¹ä¾¿ã€‚
* é€šè¿‡ `stdout` çš„ **Glibc æ³„éœ²**ï¼ˆFSOPï¼‰ã€‚
* **Tcache ä¸­æ¯’** ä»¥è·å¾—ä»»æ„å†™å…¥åŸè¯­ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
