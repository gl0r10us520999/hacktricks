# Tcache Bin Attack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Para m치s informaci칩n sobre qu칠 es un Tcache bin, consulta esta p치gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Primero que nada, ten en cuenta que el Tcache fue introducido en la versi칩n 2.26 de Glibc.

El **ataque Tcache** (tambi칠n conocido como **envenenamiento de Tcache**) propuesto en la [**p치gina de guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) es muy similar al ataque de fast bin donde el objetivo es sobrescribir el puntero al siguiente chunk en el bin dentro de un chunk liberado a una direcci칩n arbitraria para que luego sea posible **asignar esa direcci칩n espec칤fica y potencialmente sobrescribir punteros**.

Sin embargo, hoy en d칤a, si ejecutas el c칩digo mencionado, obtendr치s el error: **`malloc(): unaligned tcache chunk detected`**. Por lo tanto, es necesario escribir como direcci칩n en el nuevo puntero una direcci칩n alineada (o ejecutar el binario suficientes veces para que la direcci칩n escrita est칠 realmente alineada).

### Ataque de 칤ndices de Tcache

Por lo general, es posible encontrar al principio del heap un chunk que contiene la **cantidad de chunks por 칤ndice** dentro del tcache y la direcci칩n del **chunk cabeza de cada 칤ndice de tcache**. Si por alguna raz칩n es posible modificar esta informaci칩n, ser칤a posible **hacer que el chunk cabeza de alg칰n 칤ndice apunte a una direcci칩n deseada** (como `__malloc_hook`) para luego asignar un chunk del tama침o del 칤ndice y sobrescribir el contenido de `__malloc_hook` en este caso.

## Ejemplos

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Fuga de informaci칩n de Libc**: Es posible llenar los tcaches, agregar un chunk a la lista no ordenada, vaciar el tcache y **re-asignar el chunk de la bin no ordenada** sobrescribiendo solo los primeros 8B, dejando la **segunda direcci칩n a libc del chunk intacta para que podamos leerla**.
* **Ataque Tcache**: El binario es vulnerable a un desbordamiento de heap de 1B. Esto se abusar치 para cambiar el **encabezado de tama침o** de un chunk asignado haci칠ndolo m치s grande. Luego, este chunk ser치 **liberado**, a침adi칠ndolo al tcache de chunks de tama침o falso. Luego, asignaremos un chunk con el tama침o falso, y el chunk anterior ser치 **devuelto sabiendo que este chunk era en realidad m치s peque침o** y esto brinda la oportunidad de **sobrescribir el siguiente chunk en memoria**.\
Abusaremos de esto para **sobrescribir el puntero FD del siguiente chunk** para que apunte a **`malloc_hook`**, de modo que luego sea posible asignar 2 punteros: primero el puntero leg칤timo que acabamos de modificar, y luego la segunda asignaci칩n devolver치 un chunk en **`malloc_hook`** que es posible abusar para escribir un **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Fuga de informaci칩n de Libc**: Hay un uso despu칠s de liberar y un doble liberado. En este informe, el autor filtr칩 una direcci칩n de libc al leer la direcci칩n de un chunk colocado en un bin peque침o (como filtrarlo de la bin no ordenada pero desde el peque침o).
* **Ataque Tcache**: Se realiza un Tcache a trav칠s de un **doble liberado**. El mismo chunk se libera dos veces, por lo que dentro del Tcache el chunk apuntar치 a s칤 mismo. Luego, se asigna, su puntero FD se modifica para apuntar al **free hook** y luego se asigna nuevamente, por lo que el siguiente chunk en la lista estar치 en el free hook. Luego, esto tambi칠n se asigna y es posible escribir la direcci칩n de `system` aqu칤 para que cuando se libere un malloc que contenga `"/bin/sh"` obtengamos un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* La principal vulnerabilidad aqu칤 es la capacidad de `free` cualquier direcci칩n en el heap indicando su desplazamiento.
* **Ataque de 칤ndices de Tcache**: Es posible asignar y liberar un chunk de un tama침o que, cuando se almacena dentro del chunk de tcache (el chunk con la informaci칩n de los bins de tcache), generar치 una **direcci칩n con el valor 0x100**. Esto se debe a que el tcache almacena la cantidad de chunks en cada bin en diferentes bytes, por lo tanto, un chunk en un 칤ndice espec칤fico genera el valor 0x100.
* Luego, este valor parece que hay un chunk de tama침o 0x100. Permitiendo abusar de 칠l al `free` esta direcci칩n. Esto **agregar치 esa direcci칩n al 칤ndice de chunks de tama침o 0x100 en el tcache**.
* Luego, **asignando** un chunk de tama침o **0x100**, la direcci칩n anterior ser치 devuelta como un chunk, permitiendo sobrescribir otros 칤ndices de tcache.\
Por ejemplo, poniendo la direcci칩n de malloc hook en uno de ellos y asignando un chunk del tama침o de ese 칤ndice otorgar치 un chunk en calloc hook, lo que permite escribir un one gadget para obtener un shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* La misma vulnerabilidad que antes con una restricci칩n adicional.
* **Ataque de 칤ndices de Tcache**: Ataque similar al anterior pero usando menos pasos al **liberar el chunk que contiene la informaci칩n de tcache** para que su direcci칩n se agregue al 칤ndice de tcache de su tama침o, por lo que es posible asignar ese tama침o y obtener la informaci칩n del chunk de tcache como un chunk, lo que permite agregar el free hook como la direcci칩n de un 칤ndice, asignarlo y escribir un one gadget en 칠l.
* [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
* **Write After Free** para agregar un n칰mero al puntero `fd`.
* Se necesita mucho **heap feng-shui** en este desaf칤o. El informe muestra c칩mo **controlar la cabeza de la lista libre de Tcache** es bastante 칰til.
* **Fuga de Glibc** a trav칠s de `stdout` (FSOP).
* **Envenenamiento de Tcache** para obtener un primitivo de escritura arbitraria.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
