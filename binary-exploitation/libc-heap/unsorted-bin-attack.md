# Unsorted Bin Attack

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æœ‰å…³ä»€ä¹ˆæ˜¯æœªæ’åºçš„ bin çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é¡µé¢ï¼š

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

æœªæ’åºåˆ—è¡¨èƒ½å¤Ÿå°†åœ°å€å†™å…¥ `unsorted_chunks (av)` çš„ `bk` åœ°å€ã€‚å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…èƒ½å¤Ÿ**ä¿®æ”¹æœªæ’åº bin ä¸­ä¸€ä¸ª chunk çš„ `bk` æŒ‡é’ˆçš„åœ°å€**ï¼Œä»–å°±èƒ½å¤Ÿ**å°†è¯¥åœ°å€å†™å…¥ä»»æ„åœ°å€**ï¼Œè¿™å¯èƒ½æœ‰åŠ©äºæ³„éœ² Glibc åœ°å€æˆ–ç»•è¿‡æŸäº›é˜²å¾¡ã€‚

æ‰€ä»¥ï¼ŒåŸºæœ¬ä¸Šï¼Œè¿™ç§æ”»å‡»å…è®¸**åœ¨ä»»æ„åœ°å€è®¾ç½®ä¸€ä¸ªå¤§æ•°å­—**ã€‚è¿™ä¸ªå¤§æ•°å­—æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå¯ä»¥æ˜¯å †åœ°å€æˆ– Glibc åœ°å€ã€‚ä¸€ä¸ªå…¸å‹çš„ç›®æ ‡æ˜¯**`global_max_fast`**ï¼Œä»¥å…è®¸åˆ›å»ºæ›´å¤§å°ºå¯¸çš„å¿«é€Ÿ binï¼ˆå¹¶ä»æœªæ’åº bin æ”»å‡»è½¬åˆ°å¿«é€Ÿ bin æ”»å‡»ï¼‰ã€‚

{% hint style="success" %}
æŸ¥çœ‹ [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) ä¸­æä¾›çš„ç¤ºä¾‹ï¼Œå¹¶ä½¿ç”¨ 0x4000 å’Œ 0x5000 ä»£æ›¿ 0x400 å’Œ 0x500 ä½œä¸º chunk å¤§å°ï¼ˆä»¥é¿å… Tcacheï¼‰ï¼Œå¯ä»¥çœ‹åˆ°**å¦‚ä»Š**é”™è¯¯ **`malloc(): unsorted double linked list corrupted`** è¢«è§¦å‘ã€‚

å› æ­¤ï¼Œè¿™ç§æœªæ’åº bin æ”»å‡»ç°åœ¨ï¼ˆé™¤äº†å…¶ä»–æ£€æŸ¥ï¼‰è¿˜éœ€è¦èƒ½å¤Ÿä¿®å¤åŒå‘é“¾è¡¨ï¼Œä»¥ä¾¿ç»•è¿‡ `victim->bk->fd == victim` æˆ– `victim->fd == av (arena)`ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æƒ³è¦å†™å…¥çš„åœ°å€å¿…é¡»åœ¨å…¶ `fd` ä½ç½®å…·æœ‰å‡ chunk çš„åœ°å€ï¼Œå¹¶ä¸”å‡ chunk çš„ `fd` æŒ‡å‘ arenaã€‚
{% endhint %}

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œè¿™ç§æ”»å‡»ä¼šç ´åæœªæ’åºçš„ binï¼ˆå› æ­¤å°å’Œå¤§ä¹Ÿä¼šï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨åªèƒ½**ä½¿ç”¨å¿«é€Ÿ bin çš„åˆ†é…**ï¼ˆæ›´å¤æ‚çš„ç¨‹åºå¯èƒ½ä¼šè¿›è¡Œå…¶ä»–åˆ†é…å¹¶å´©æºƒï¼‰ï¼Œå¹¶ä¸”è¦è§¦å‘è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»**åˆ†é…ç›¸åŒçš„å¤§å°ï¼Œå¦åˆ™ç¨‹åºå°†å´©æºƒã€‚**

è¯·æ³¨æ„ï¼Œè¦†ç›– **`global_max_fast`** å¯èƒ½åœ¨è¿™ç§æƒ…å†µä¸‹æœ‰æ‰€å¸®åŠ©ï¼Œå‰ææ˜¯å¿«é€Ÿ bin èƒ½å¤Ÿå¤„ç†æ‰€æœ‰å…¶ä»–åˆ†é…ï¼Œç›´åˆ°åˆ©ç”¨å®Œæˆã€‚
{% endhint %}

æ¥è‡ª [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) çš„ä»£ç è§£é‡Šå¾—å¾ˆå¥½ï¼Œå°½ç®¡å¦‚æœä½ ä¿®æ”¹ malloc ä»¥åˆ†é…è¶³å¤Ÿå¤§çš„å†…å­˜ä»¥é¿å… Tcacheï¼Œä½ ä¼šçœ‹åˆ°ä¹‹å‰æåˆ°çš„é”™è¯¯å‡ºç°ï¼Œé˜»æ­¢è¿™ç§æŠ€æœ¯ï¼š**`malloc(): unsorted double linked list corrupted`**

## æœªæ’åº Bin ä¿¡æ¯æ³„éœ²æ”»å‡»

è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸åŸºæœ¬çš„æ¦‚å¿µã€‚æœªæ’åº bin ä¸­çš„ chunks å°†å…·æœ‰æŒ‡é’ˆã€‚æœªæ’åº bin ä¸­çš„ç¬¬ä¸€ä¸ª chunk å®é™…ä¸Šå°†å…·æœ‰**`fd`** å’Œ **`bk`** é“¾æ¥**æŒ‡å‘ä¸» arena çš„ä¸€éƒ¨åˆ† (Glibc)**ã€‚\
å› æ­¤ï¼Œå¦‚æœä½ èƒ½å¤Ÿ**å°†ä¸€ä¸ª chunk æ”¾å…¥æœªæ’åº bin å¹¶è¯»å–å®ƒ**ï¼ˆä½¿ç”¨åé‡Šæ”¾ï¼‰æˆ–**åœ¨ä¸è¦†ç›–è‡³å°‘ 1 ä¸ªæŒ‡é’ˆçš„æƒ…å†µä¸‹å†æ¬¡åˆ†é…å®ƒ**ï¼Œç„¶å**è¯»å–**å®ƒï¼Œä½ å°±å¯ä»¥è·å¾—**Glibc ä¿¡æ¯æ³„éœ²**ã€‚

åœ¨è¿™ä¸ª [**å†™ä½œä¸­ä½¿ç”¨çš„ç±»ä¼¼æ”»å‡»**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html)ä¸­ï¼Œåˆ©ç”¨äº†ä¸€ä¸ª 4 ä¸ª chunk ç»“æ„ï¼ˆAã€Bã€C å’Œ D - D ä»…ç”¨äºé˜²æ­¢ä¸é¡¶éƒ¨ chunk åˆå¹¶ï¼‰ï¼Œå› æ­¤åœ¨ B ä¸­ä½¿ç”¨äº†ä¸€ä¸ªç©ºå­—èŠ‚æº¢å‡ºï¼Œä½¿ C è¡¨ç¤º B æœªä½¿ç”¨ã€‚æ­¤å¤–ï¼Œåœ¨ B ä¸­ä¿®æ”¹äº† `prev_size` æ•°æ®ï¼Œå› æ­¤å¤§å°ä¸å†æ˜¯ B çš„å¤§å°ï¼Œè€Œæ˜¯ A+Bã€‚\
ç„¶å C è¢«é‡Šæ”¾ï¼Œå¹¶ä¸ A+B åˆå¹¶ï¼ˆä½† B ä»åœ¨ä½¿ç”¨ä¸­ï¼‰ã€‚åˆ†é…äº†ä¸€ä¸ªå¤§å°ä¸º A çš„æ–° chunkï¼Œç„¶åå°†æ³„éœ²çš„ libc åœ°å€å†™å…¥ Bï¼Œä»è€Œæ³„éœ²äº†å®ƒä»¬ã€‚

## å‚è€ƒèµ„æ–™å’Œå…¶ä»–ç¤ºä¾‹

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* ç›®æ ‡æ˜¯ç”¨å¤§äº 4869 çš„å€¼è¦†ç›–ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä»¥ä¾¿èƒ½å¤Ÿè·å–æ ‡å¿—ï¼Œå¹¶ä¸”æœªå¯ç”¨ PIEã€‚
* å¯ä»¥ç”Ÿæˆä»»æ„å¤§å°çš„ chunksï¼Œå¹¶ä¸”å­˜åœ¨æ‰€éœ€å¤§å°çš„å †æº¢å‡ºã€‚
* æ”»å‡»å¼€å§‹åˆ›å»º 3 ä¸ª chunksï¼šchunk0 ç”¨äºåˆ©ç”¨æº¢å‡ºï¼Œchunk1 è¢«æº¢å‡ºï¼Œchunk2 ä»¥é˜²æ­¢é¡¶éƒ¨ chunk åˆå¹¶ä¹‹å‰çš„ chunksã€‚
* ç„¶åï¼Œchunk1 è¢«é‡Šæ”¾ï¼Œchunk0 è¢«æº¢å‡ºåˆ° chunk1 çš„ `bk` æŒ‡é’ˆæŒ‡å‘ï¼š`bk = magic - 0x10`
* ç„¶åï¼Œåˆ†é…ä¸€ä¸ªä¸ chunk1 ç›¸åŒå¤§å°çš„ chunk3ï¼Œè¿™å°†è§¦å‘æœªæ’åº bin æ”»å‡»å¹¶ä¿®æ”¹å…¨å±€å˜é‡çš„å€¼ï¼Œä»è€Œä½¿è·å–æ ‡å¿—æˆä¸ºå¯èƒ½ã€‚
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* åˆå¹¶å‡½æ•°æ˜¯è„†å¼±çš„ï¼Œå› ä¸ºå¦‚æœä¼ å…¥çš„ä¸¤ä¸ªç´¢å¼•ç›¸åŒï¼Œå®ƒå°†å¯¹å…¶è¿›è¡Œé‡æ–°åˆ†é…ï¼Œç„¶åé‡Šæ”¾å®ƒï¼Œä½†è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥é‡Šæ”¾åŒºåŸŸçš„æŒ‡é’ˆï¼Œå¯ä»¥ä½¿ç”¨ã€‚
* å› æ­¤ï¼Œ**åˆ›å»ºäº† 2 ä¸ª chunks**ï¼š**chunk0** å°†ä¸è‡ªèº«åˆå¹¶ï¼Œchunk1 ä»¥é˜²æ­¢ä¸é¡¶éƒ¨ chunk åˆå¹¶ã€‚ç„¶åï¼Œ**åˆå¹¶å‡½æ•°è¢«è°ƒç”¨ä¸¤æ¬¡ä¸ chunk0**ï¼Œè¿™å°†å¯¼è‡´ä½¿ç”¨åé‡Šæ”¾ã€‚
* ç„¶åï¼Œ**`view`** å‡½æ•°è¢«è°ƒç”¨ï¼Œç´¢å¼•ä¸º 2ï¼ˆå³ä½¿ç”¨åé‡Šæ”¾ chunk çš„ç´¢å¼•ï¼‰ï¼Œè¿™å°†**æ³„éœ²ä¸€ä¸ª libc åœ°å€**ã€‚
* ç”±äºäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰ä¿æŠ¤æªæ–½ï¼Œä»…å…è®¸ malloc å¤§äº **`global_max_fast`** çš„å¤§å°ï¼Œå› æ­¤ä¸ä½¿ç”¨å¿«é€Ÿ binï¼Œå°†ä½¿ç”¨æœªæ’åº bin æ”»å‡»æ¥è¦†ç›–å…¨å±€å˜é‡ `global_max_fast`ã€‚
* ç„¶åï¼Œå¯ä»¥è°ƒç”¨ç¼–è¾‘å‡½æ•°ï¼Œç´¢å¼•ä¸º 2ï¼ˆä½¿ç”¨åé‡Šæ”¾æŒ‡é’ˆï¼‰ï¼Œå¹¶è¦†ç›– `bk` æŒ‡é’ˆä»¥æŒ‡å‘ `p64(global_max_fast-0x10)`ã€‚ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªæ–° chunk å°†ä½¿ç”¨ä¹‹å‰è¢«ç ´åçš„é‡Šæ”¾åœ°å€ (0x20) å°†**è§¦å‘æœªæ’åº bin æ”»å‡»**ï¼Œè¦†ç›– `global_max_fast`ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œç°åœ¨å…è®¸åœ¨å¿«é€Ÿ bins ä¸­åˆ›å»º chunksã€‚
* ç°åœ¨æ‰§è¡Œ **å¿«é€Ÿ bin æ”»å‡»**ï¼š
* é¦–å…ˆå‘ç°å¯ä»¥åœ¨ **`__free_hook`** ä½ç½®å¤„ç†å¤§å°ä¸º 200 çš„å¿«é€Ÿ **chunks**ï¼š
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* å¦‚æœæˆ‘ä»¬è®¾æ³•åœ¨æ­¤ä½ç½®è·å¾—å¤§å°ä¸º 0x200 çš„å¿«é€Ÿ chunkï¼Œå°†èƒ½å¤Ÿè¦†ç›–å°†è¢«æ‰§è¡Œçš„å‡½æ•°æŒ‡é’ˆã€‚
* ä¸ºæ­¤ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `0xfc` çš„æ–° chunkï¼Œå¹¶è°ƒç”¨åˆå¹¶å‡½æ•°ä¸¤æ¬¡ä½¿ç”¨è¯¥æŒ‡é’ˆï¼Œè¿™æ ·æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªæŒ‡å‘å¤§å°ä¸º `0xfc*2 = 0x1f8` çš„é‡Šæ”¾ chunk çš„æŒ‡é’ˆã€‚
* ç„¶åï¼Œåœ¨æ­¤ chunk ä¸­è°ƒç”¨ç¼–è¾‘å‡½æ•°ä»¥ä¿®æ”¹æ­¤å¿«é€Ÿ bin çš„ **`fd`** åœ°å€ï¼Œä½¿å…¶æŒ‡å‘ä¹‹å‰çš„ **`__free_hook`** å‡½æ•°ã€‚
* ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `0x1f8` çš„ chunkï¼Œä»¥ä»å¿«é€Ÿ bin ä¸­æ£€ç´¢ä¹‹å‰æ— ç”¨çš„ chunkï¼Œå› æ­¤åˆ›å»ºå¦ä¸€ä¸ªå¤§å°ä¸º `0x1f8` çš„ chunk ä»¥è·å– **`__free_hook`** ä¸­çš„å¿«é€Ÿ bin chunkï¼Œè¯¥ chunk è¢«è¦†ç›–ä¸º **`system`** å‡½æ•°çš„åœ°å€ã€‚
* æœ€åï¼Œé‡Šæ”¾ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸² `/bin/sh\x00` çš„ chunkï¼Œè°ƒç”¨åˆ é™¤å‡½æ•°ï¼Œè§¦å‘ **`__free_hook`** å‡½æ•°ï¼Œè¯¥å‡½æ•°æŒ‡å‘ systemï¼Œå‚æ•°ä¸º `/bin/sh\x00`ã€‚
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* å¦ä¸€ä¸ªåˆ©ç”¨ 1B æº¢å‡ºåˆå¹¶æœªæ’åº bin ä¸­çš„ chunks å¹¶è·å– libc ä¿¡æ¯æ³„éœ²çš„ç¤ºä¾‹ï¼Œç„¶åæ‰§è¡Œå¿«é€Ÿ bin æ”»å‡»ä»¥ç”¨ä¸€ä¸ª gadget åœ°å€è¦†ç›– malloc hookã€‚
* [**Robot Factory. BlackHat MEA CTF 2022**](https://7rocky.github.io/en/ctf/other/blackhat-ctf/robot-factory/)
* æˆ‘ä»¬åªèƒ½åˆ†é…å¤§äº `0x100` çš„ chunksã€‚
* ä½¿ç”¨æœªæ’åº bin æ”»å‡»è¦†ç›– `global_max_fast`ï¼ˆç”±äº ASLRï¼ŒæˆåŠŸç‡ä¸º 1/16ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ä¿®æ”¹ 12 ä½ï¼Œä½†å¿…é¡»ä¿®æ”¹ 16 ä½ï¼‰ã€‚
* å¿«é€Ÿ bin æ”»å‡»ä»¥ä¿®æ”¹å…¨å±€ chunk æ•°ç»„ã€‚è¿™æä¾›äº†ä¸€ä¸ªä»»æ„è¯»/å†™åŸè¯­ï¼Œå…è®¸ä¿®æ”¹ GOT å¹¶è®¾ç½®æŸäº›å‡½æ•°æŒ‡å‘ `system`ã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
