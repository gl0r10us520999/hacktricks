# Unsorted Bin Attack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

For more information about what is an unsorted bin check this page:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Unsorted liste mogu da upisu adresu u `unsorted_chunks (av)` u `bk` adresu chunk-a. Stoga, ako napadaÄ moÅ¾e da **modifikuje adresu `bk` pokazivaÄa** u chunk-u unutar unsorted bin-a, mogao bi da **upisuje tu adresu u proizvoljnu adresu** Å¡to bi moglo biti korisno za leak Glibc adresa ili zaobiÄ‡i neku od odbrana.

Dakle, u suÅ¡tini, ovaj napad omoguÄ‡ava da **postavite veliku brojku na proizvoljnu adresu**. Ova velika brojka je adresa, koja moÅ¾e biti adresa heap-a ili Glibc adresa. TipiÄan cilj je **`global_max_fast`** kako bi se omoguÄ‡ilo kreiranje fast bin binova sa veÄ‡im veliÄinama (i prelazak iz unsorted bin napada u fast bin napad).

{% hint style="success" %}
Taking a look to the example provided in [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) and using 0x4000 and 0x5000 instead of 0x400 and 0x500 as chunk sizes (to avoid Tcache) it's possible to see that **nowadays** the error **`malloc(): unsorted double linked list corrupted`** is triggered.

Stoga, ovaj unsorted bin napad sada (pored drugih provera) takoÄ‘e zahteva da bude moguÄ‡e popraviti dvostruko povezanu listu tako da se zaobiÄ‘e `victim->bk->fd == victim` ili ne `victim->fd == av (arena)`, Å¡to znaÄi da adresa na koju Å¾elimo da piÅ¡emo mora imati adresu laÅ¾nog chunk-a u svom `fd` poloÅ¾aju i da laÅ¾ni chunk `fd` pokazuje na arenu.
{% endhint %}

{% hint style="danger" %}
Note that this attack corrupts the unsorted bin (hence small and large too). So we can only **use allocations from the fast bin now** (a more complex program might do other allocations and crash), and to trigger this we must **allocate the same size or the program will crash.**

Napomena da prepisivanje **`global_max_fast`** moÅ¾e pomoÄ‡i u ovom sluÄaju verujuÄ‡i da Ä‡e fast bin moÄ‡i da se brine o svim ostalim alokacijama dok se eksploatacija ne zavrÅ¡i.
{% endhint %}

The code from [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) explains it very well, although if you modify the mallocs to allocate memory big enough so don't end in a Tcache you can see that the previously mentioned error appears preventing this technique: **`malloc(): unsorted double linked list corrupted`**

## Unsorted Bin Infoleak Attack

Ovo je zapravo vrlo osnovni koncept. Chunk-ovi u unsorted bin-u Ä‡e imati pokazivaÄe. Prvi chunk u unsorted bin-u Ä‡e zapravo imati **`fd`** i **`bk`** linkove **koji upuÄ‡uju na deo glavne arene (Glibc)**.\
Stoga, ako moÅ¾ete **staviti chunk unutar unsorted bin-a i proÄitati ga** (use after free) ili **ponovo ga alocirati bez prepisivanja barem 1 od pokazivaÄa** da biste zatim **proÄitali** ga, moÅ¾ete imati **Glibc info leak**.

SliÄan [**napad koriÅ¡Ä‡en u ovom izveÅ¡taju**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html), bio je zloupotreba strukture od 4 chunk-a (A, B, C i D - D je samo da spreÄi konsolidaciju sa top chunk-om) tako da je koriÅ¡Ä‡en null byte overflow u B da bi C ukazivao da je B neiskoriÅ¡Ä‡en. TakoÄ‘e, u B su podaci `prev_size` modifikovani tako da je veliÄina umesto veliÄine B bila A+B.\
Zatim je C dealokiran, i konsolidovan sa A+B (ali je B joÅ¡ uvek bio u upotrebi). Novi chunk veliÄine A je alociran i zatim su adrese libc leak-ovane napisane u B odakle su leak-ovane.

## References & Other examples

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Cilj je prepisati globalnu promenljivu sa vrednoÅ¡Ä‡u veÄ‡om od 4869 kako bi bilo moguÄ‡e dobiti zastavicu i PIE nije omoguÄ‡en.
* MoguÄ‡e je generisati chunk-ove proizvoljnih veliÄina i postoji heap overflow sa Å¾eljenom veliÄinom.
* Napad poÄinje kreiranjem 3 chunk-a: chunk0 za zloupotrebu overflow-a, chunk1 da bude overflow-ovan i chunk2 da top chunk ne konsoliduje prethodne.
* Zatim, chunk1 se oslobaÄ‘a i chunk0 se overflow-uje tako da `bk` pokazivaÄ chunk-a1 pokazuje na: `bk = magic - 0x10`
* Zatim, chunk3 se alocira sa istom veliÄinom kao chunk1, Å¡to Ä‡e pokrenuti unsorted bin napad i izmeniti vrednost globalne promenljive, omoguÄ‡avajuÄ‡i dobijanje zastavice.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Funkcija merge je ranjiva jer ako su oba prosleÄ‘ena indeksa ista, ona Ä‡e realloc-ovati na njemu i zatim ga osloboditi, ali vraÄ‡ajuÄ‡i pokazivaÄ na tu osloboÄ‘enu oblast koja se moÅ¾e koristiti.
* Stoga, **2 chunk-a su kreirana**: **chunk0** koji Ä‡e se spojiti sa samim sobom i chunk1 da spreÄi konsolidaciju sa top chunk-om. Zatim, **merge funkcija se poziva sa chunk0** dva puta Å¡to Ä‡e izazvati use after free.
* Zatim, **`view`** funkcija se poziva sa indeksom 2 (Å¡to je indeks chunk-a koji je use after free), Å¡to Ä‡e **leak-ovati libc adresu**.
* Kako binarni fajl ima zaÅ¡tite da samo malloc veliÄine veÄ‡e od **`global_max_fast`** pa se nijedan fastbin ne koristi, koristiÄ‡e se unsorted bin napad da prepiÅ¡e globalnu promenljivu `global_max_fast`.
* Zatim, moguÄ‡e je pozvati edit funkciju sa indeksom 2 (pokazivaÄ use after free) i prepisati `bk` pokazivaÄ da pokazuje na `p64(global_max_fast-0x10)`. Zatim, kreiranje novog chunk-a koristi prethodno kompromitovanu osloboÄ‘enu adresu (0x20) Ä‡e **pokrenuti unsorted bin napad** prepisujuÄ‡i `global_max_fast` koja je veoma velika vrednost, omoguÄ‡avajuÄ‡i sada kreiranje chunk-ova u fast bin-ovima.
* Sada se izvodi **fast bin napad**:
* Prvo je otkriveno da je moguÄ‡e raditi sa fast **chunk-ovima veliÄine 200** na **`__free_hook`** lokaciji:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Ako uspemo da dobijemo fast chunk veliÄine 0x200 na ovoj lokaciji, biÄ‡e moguÄ‡e prepisati pokazivaÄ funkcije koja Ä‡e biti izvrÅ¡ena
* Za to, kreira se novi chunk veliÄine `0xfc` i merge funkcija se poziva sa tim pokazivaÄem dva puta, na ovaj naÄin dobijamo pokazivaÄ na osloboÄ‘eni chunk veliÄine `0xfc*2 = 0x1f8` u fast bin-u.
* Zatim, edit funkcija se poziva na ovom chunk-u da izmeni **`fd`** adresu ovog fast bin-a da pokazuje na prethodnu **`__free_hook`** funkciju.
* Zatim, kreira se chunk veliÄine `0x1f8` da se povuÄe iz fast bin-a prethodni beskorisni chunk tako da se kreira joÅ¡ jedan chunk veliÄine `0x1f8` da se dobije fast bin chunk u **`__free_hook`** koji se prepisuje sa adresom funkcije **`system`**.
* I konaÄno, chunk koji sadrÅ¾i string `/bin/sh\x00` se oslobaÄ‘a pozivajuÄ‡i delete funkciju, pokreÄ‡uÄ‡i **`__free_hook`** funkciju koja pokazuje na system sa `/bin/sh\x00` kao parametrom.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* JoÅ¡ jedan primer zloupotrebe 1B overflow-a da se konsoliduju chunk-ovi u unsorted bin-u i dobiju libc infoleak i zatim izvrÅ¡i fast bin napad da prepiÅ¡e malloc hook sa adresom jednog gadget-a
* [**Robot Factory. BlackHat MEA CTF 2022**](https://7rocky.github.io/en/ctf/other/blackhat-ctf/robot-factory/)
* MoÅ¾emo alocirati samo chunk-ove veliÄine veÄ‡e od `0x100`.
* Prepisivanje `global_max_fast` koriÅ¡Ä‡enjem Unsorted Bin napada (radi 1/16 puta zbog ASLR, jer treba da modifikujemo 12 bita, ali moramo modifikovati 16 bita).
* Fast Bin napad za modifikaciju globalnog niza chunk-ova. Ovo daje proizvoljnu read/write primitivu, koja omoguÄ‡ava modifikaciju GOT-a i postavljanje neke funkcije da pokazuje na `system`.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
