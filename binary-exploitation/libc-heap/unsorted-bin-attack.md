# Unsorted Bin Attack

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Unsorted bin'in ne olduÄŸunu Ã¶ÄŸrenmek iÃ§in bu sayfayÄ± kontrol edin:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Unsorted listeler, `bk` adresinde `unsorted_chunks (av)` adresini yazma yeteneÄŸine sahiptir. Bu nedenle, bir saldÄ±rgan **unsorted bin iÃ§indeki bir chunk'taki `bk` iÅŸaretÃ§isinin adresini deÄŸiÅŸtirebilirse**, bu adresi **rastgele bir adrese yazabilir** ki bu da Glibc adreslerini sÄ±zdÄ±rmak veya bazÄ± savunmalarÄ± aÅŸmak iÃ§in faydalÄ± olabilir.

Yani, temelde bu saldÄ±rÄ±, **rastgele bir adreste bÃ¼yÃ¼k bir sayÄ± ayarlamaya** olanak tanÄ±r. Bu bÃ¼yÃ¼k sayÄ±, bir heap adresi veya bir Glibc adresi olabilecek bir adrestir. Tipik bir hedef, **`global_max_fast`**'tÄ±r; bu, daha bÃ¼yÃ¼k boyutlarda hÄ±zlÄ± binler oluÅŸturulmasÄ±na izin verir (ve bir unsorted bin saldÄ±rÄ±sÄ±ndan hÄ±zlÄ± bin saldÄ±rÄ±sÄ±na geÃ§iÅŸ yapar).

{% hint style="success" %}
[https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) adresinde saÄŸlanan Ã¶rneÄŸe bakarak ve chunk boyutlarÄ± olarak 0x400 ve 0x500 yerine 0x4000 ve 0x5000 kullanarak (Tcache'den kaÃ§Ä±nmak iÃ§in) **gÃ¼nÃ¼mÃ¼zde** **`malloc(): unsorted double linked list corrupted`** hatasÄ±nÄ±n tetiklendiÄŸini gÃ¶rebilirsiniz.

Bu nedenle, bu unsorted bin saldÄ±rÄ±sÄ± artÄ±k (diÄŸer kontrollerin yanÄ± sÄ±ra) Ã§ift baÄŸlÄ± listeyi dÃ¼zeltme yeteneÄŸine de ihtiyaÃ§ duyar, bÃ¶ylece `victim->bk->fd == victim` veya `victim->fd == av (arena)` atlanÄ±r; bu, yazmak istediÄŸimiz adresin `fd` konumunda sahte chunk'Ä±n adresini iÃ§ermesi ve sahte chunk'Ä±n `fd`'sinin arenaya iÅŸaret etmesi gerektiÄŸi anlamÄ±na gelir.
{% endhint %}

{% hint style="danger" %}
Bu saldÄ±rÄ±nÄ±n unsorted bin'i (dolayÄ±sÄ±yla kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k olanlarÄ± da) bozduÄŸunu unutmayÄ±n. Bu nedenle, artÄ±k yalnÄ±zca **hÄ±zlÄ± binlerden tahsisat kullanabiliriz** (daha karmaÅŸÄ±k bir program baÅŸka tahsisatlar yapabilir ve Ã§Ã¶kebilir) ve bunu tetiklemek iÃ§in **aynÄ± boyutta tahsisat yapmalÄ±yÄ±z yoksa program Ã§Ã¶ker.**

**`global_max_fast`**'Ä± geÃ§ersiz kÄ±lmak, bu durumda yardÄ±mcÄ± olabilir; hÄ±zlÄ± binin, istismar tamamlanana kadar diÄŸer tÃ¼m tahsisatlarla ilgilenebileceÄŸine gÃ¼venerek.
{% endhint %}

[**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) tarafÄ±ndan saÄŸlanan kod bunu Ã§ok iyi aÃ§Ä±klÄ±yor, ancak malloc'larÄ± yeterince bÃ¼yÃ¼k bir bellek tahsis etmek iÃ§in deÄŸiÅŸtirirseniz, bÃ¶ylece Tcache'de sona ermezseniz, daha Ã¶nce bahsedilen hatanÄ±n bu tekniÄŸi engellediÄŸini gÃ¶rebilirsiniz: **`malloc(): unsorted double linked list corrupted`**

## Unsorted Bin Bilgi SÄ±zdÄ±rma SaldÄ±rÄ±sÄ±

Bu aslÄ±nda Ã§ok temel bir kavramdÄ±r. Unsorted bin'deki chunk'lar iÅŸaretÃ§ilere sahip olacaktÄ±r. Unsorted bin'deki ilk chunk, aslÄ±nda **`fd`** ve **`bk`** baÄŸlantÄ±larÄ±na **ana arenanÄ±n (Glibc) bir kÄ±smÄ±na iÅŸaret eder**.\
Bu nedenle, bir chunk'Ä± unsorted bin'e **yerleÅŸtirip okuyabilirseniz** (free'den sonra kullanma) veya **en az 1 iÅŸaretÃ§iyi geÃ§ersiz kÄ±lmadan tekrar tahsis edebilirseniz** ve ardÄ±ndan **okuyabilirseniz**, bir **Glibc bilgi sÄ±zÄ±ntÄ±sÄ±** elde edebilirsiniz.

Bu yazÄ±mda kullanÄ±lan benzer bir [**saldÄ±rÄ±**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html), 4 chunk yapÄ±sÄ±nÄ± (A, B, C ve D - D yalnÄ±zca Ã¼st chunk ile konsolidasyonu Ã¶nlemek iÃ§in) kÃ¶tÃ¼ye kullanmak iÃ§in B'deki bir null byte taÅŸmasÄ±nÄ± kullanarak C'nin B'nin kullanÄ±lmadÄ±ÄŸÄ±nÄ± belirtmesini saÄŸladÄ±. AyrÄ±ca, B'deki `prev_size` verisi deÄŸiÅŸtirilerek boyut, B'nin boyutu yerine A+B olarak ayarlandÄ±.\
Sonra C serbest bÄ±rakÄ±ldÄ± ve A+B ile konsolide edildi (ancak B hala kullanÄ±lÄ±yordu). A boyutunda yeni bir chunk tahsis edildi ve ardÄ±ndan libc sÄ±zdÄ±rÄ±lan adresler B'ye yazÄ±ldÄ± ve buradan sÄ±zdÄ±rÄ±ldÄ±.

## Referanslar ve DiÄŸer Ã–rnekler

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* AmaÃ§, 4869'dan bÃ¼yÃ¼k bir deÄŸerle bir global deÄŸiÅŸkeni geÃ§ersiz kÄ±lmak, bÃ¶ylece bayraÄŸÄ± almak ve PIE'nin etkin olmamasÄ±nÄ± saÄŸlamaktÄ±r.
* Rastgele boyutlarda chunk'lar oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r ve istenen boyutta bir heap taÅŸmasÄ± vardÄ±r.
* SaldÄ±rÄ±, 3 chunk oluÅŸturarak baÅŸlar: taÅŸmayÄ± kÃ¶tÃ¼ye kullanmak iÃ§in chunk0, taÅŸma yapÄ±lacak chunk1 ve Ã¼st chunk'un Ã¶nceki chunk'larla konsolide olmamasÄ± iÃ§in chunk2.
* Sonra, chunk1 serbest bÄ±rakÄ±lÄ±r ve chunk0, chunk1'in `bk` iÅŸaretÃ§isinin iÅŸaret ettiÄŸi yere taÅŸma yapar: `bk = magic - 0x10`
* ArdÄ±ndan, chunk1 ile aynÄ± boyutta chunk3 tahsis edilir, bu da unsorted bin saldÄ±rÄ±sÄ±nÄ± tetikleyecek ve global deÄŸiÅŸkenin deÄŸerini deÄŸiÅŸtirecektir, bÃ¶ylece bayraÄŸÄ± almak mÃ¼mkÃ¼n olacaktÄ±r.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* BirleÅŸtirme iÅŸlevi, her iki geÃ§irilen indeks aynÄ± olduÄŸunda onu yeniden tahsis edeceÄŸi ve ardÄ±ndan serbest bÄ±rakacaÄŸÄ± iÃ§in savunmasÄ±zdÄ±r, ancak serbest bÄ±rakÄ±lan bÃ¶lgeye bir iÅŸaretÃ§i dÃ¶ndÃ¼rÃ¼r.
* Bu nedenle, **2 chunk oluÅŸturulur**: **chunk0** kendisiyle birleÅŸtirilecek ve Ã¼st chunk ile konsolide olmasÄ±nÄ± Ã¶nlemek iÃ§in chunk1. ArdÄ±ndan, **chunk0 ile birleÅŸtirme iÅŸlevi** iki kez Ã§aÄŸrÄ±lÄ±r, bu da free'den sonra kullanma durumuna neden olur.
* Sonra, **`view`** iÅŸlevi, free'den sonra kullanÄ±lan chunk'Ä±n indeksi olan 2 ile Ã§aÄŸrÄ±lÄ±r; bu, **bir libc adresini sÄ±zdÄ±rÄ±r**.
* Ä°kili, yalnÄ±zca **`global_max_fast`**'dan daha bÃ¼yÃ¼k boyutlarÄ± malloc etmeye izin verecek ÅŸekilde korumalara sahip olduÄŸundan, hÄ±zlÄ± bin kullanÄ±lmadÄ±ÄŸÄ± iÃ§in bir unsorted bin saldÄ±rÄ±sÄ± kullanÄ±lacak ve global deÄŸiÅŸken `global_max_fast`'Ä± geÃ§ersiz kÄ±lmak iÃ§in kullanÄ±lacaktÄ±r.
* ArdÄ±ndan, 2 indeksi (free'den sonra kullanÄ±lan iÅŸaretÃ§i) ile edit iÅŸlevi Ã§aÄŸrÄ±labilir ve `bk` iÅŸaretÃ§isi `p64(global_max_fast-0x10)`'a iÅŸaret edecek ÅŸekilde geÃ§ersiz kÄ±lÄ±nabilir. ArdÄ±ndan, yeni bir chunk oluÅŸturmak, daha Ã¶nce tehlikeye atÄ±lmÄ±ÅŸ serbest adresi (0x20) kullanacak ve **unsorted bin saldÄ±rÄ±sÄ±nÄ± tetikleyecektir**; bu, `global_max_fast`'Ä± Ã§ok bÃ¼yÃ¼k bir deÄŸerle geÃ§ersiz kÄ±lacaktÄ±r ve artÄ±k hÄ±zlÄ± binlerde chunk'lar oluÅŸturmak mÃ¼mkÃ¼n olacaktÄ±r.
* Åimdi bir **hÄ±zlÄ± bin saldÄ±rÄ±sÄ±** gerÃ§ekleÅŸtirilir:
* Ã–ncelikle, **`__free_hook`** konumunda hÄ±zlÄ± **200 boyutunda chunk'larla Ã§alÄ±ÅŸmanÄ±n mÃ¼mkÃ¼n olduÄŸu keÅŸfedilir**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* Bu konumda 0x200 boyutunda hÄ±zlÄ± bir chunk elde edebilirsek, Ã§alÄ±ÅŸtÄ±rÄ±lacak bir iÅŸlev iÅŸaretÃ§isini geÃ§ersiz kÄ±lmak mÃ¼mkÃ¼n olacaktÄ±r.
* Bunun iÃ§in, `0xfc` boyutunda yeni bir chunk oluÅŸturulur ve birleÅŸtirilmiÅŸ iÅŸlev bu iÅŸaretÃ§i ile iki kez Ã§aÄŸrÄ±lÄ±r; bu ÅŸekilde, hÄ±zlÄ± bin iÃ§inde `0xfc*2 = 0x1f8` boyutunda serbest bir chunk'a iÅŸaret eden bir iÅŸaretÃ§i elde ederiz.
* ArdÄ±ndan, bu chunk'ta edit iÅŸlevi Ã§aÄŸrÄ±larak bu hÄ±zlÄ± binin **`fd`** adresi Ã¶nceki **`__free_hook`** iÅŸlevine iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirilir.
* ArdÄ±ndan, hÄ±zlÄ± bin'den Ã¶nceki iÅŸe yaramaz chunk'Ä± almak iÃ§in `0x1f8` boyutunda bir chunk oluÅŸturulur; bÃ¶ylece **`__free_hook`** iÃ§inde hÄ±zlÄ± bir bin chunk'Ä± elde edilir ve bu, **`system`** iÅŸlevinin adresi ile geÃ§ersiz kÄ±lÄ±nÄ±r.
* Ve nihayet, `/bin/sh\x00` dizesini iÃ§eren bir chunk, silme iÅŸlevini Ã§aÄŸÄ±rarak serbest bÄ±rakÄ±lÄ±r; bu, **`__free_hook`** iÅŸlevini tetikler ve `/bin/sh\x00` parametre olarak sistem iÅŸlevine iÅŸaret eder.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* Unsorted bin'de chunk'larÄ± konsolide etmek ve bir libc bilgi sÄ±zÄ±ntÄ±sÄ± elde etmek iÃ§in 1B taÅŸmasÄ±nÄ± kÃ¶tÃ¼ye kullanmanÄ±n baÅŸka bir Ã¶rneÄŸi ve ardÄ±ndan malloc hook'u bir gadget adresi ile geÃ§ersiz kÄ±lmak iÃ§in hÄ±zlÄ± bin saldÄ±rÄ±sÄ±.
* [**Robot Factory. BlackHat MEA CTF 2022**](https://7rocky.github.io/en/ctf/other/blackhat-ctf/robot-factory/)
* Sadece `0x100`'den bÃ¼yÃ¼k boyutlarda chunk'lar tahsis edebiliriz.
* Unsorted Bin saldÄ±rÄ±sÄ± kullanarak `global_max_fast`'Ä± geÃ§ersiz kÄ±lmak (ASLR nedeniyle 1/16 kez Ã§alÄ±ÅŸÄ±r, Ã§Ã¼nkÃ¼ 12 bit deÄŸiÅŸtirmemiz gerekir, ancak 16 bit deÄŸiÅŸtirmeliyiz).
* Global chunk dizisini deÄŸiÅŸtirmek iÃ§in hÄ±zlÄ± bin saldÄ±rÄ±sÄ±. Bu, GOT'u deÄŸiÅŸtirme ve bazÄ± iÅŸlevleri `system`'a iÅŸaret etme yeteneÄŸi veren rastgele okuma/yazma ilkesidir.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
