# Atak na Niesortowany Koszyk

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

## Podstawowe Informacje

Aby uzyskaÄ‡ wiÄ™cej informacji na temat tego, czym jest niesortowany koszyk, sprawdÅº tÄ™ stronÄ™:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Niesortowane listy mogÄ… zapisaÄ‡ adres do `unsorted_chunks (av)` w adresie `bk` kawaÅ‚ka. Dlatego, jeÅ›li atakujÄ…cy moÅ¼e **zmodyfikowaÄ‡ adres wskaÅºnika `bk`** w kawaÅ‚ku wewnÄ…trz niesortowanego koszyka, mÃ³gÅ‚by byÄ‡ w stanie **zapisaÄ‡ ten adres w dowolnym adresie**, co mogÅ‚oby byÄ‡ pomocne do wycieku adresÃ³w Glibc lub obejÅ›cia niektÃ³rych zabezpieczeÅ„.

Tak wiÄ™c, zasadniczo, ten atak pozwala na **ustawienie duÅ¼ej liczby w dowolnym adresie**. Ta duÅ¼a liczba to adres, ktÃ³ry moÅ¼e byÄ‡ adresem sterty lub adresem Glibc. Typowym celem jest **`global_max_fast`**, aby umoÅ¼liwiÄ‡ tworzenie szybkich koszykÃ³w o wiÄ™kszych rozmiarach (i przejÅ›cie z ataku na niesortowany koszyk do ataku na szybki koszyk).

{% hint style="success" %}
PatrzÄ…c na przykÅ‚ad podany w [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#principle) i uÅ¼ywajÄ…c 0x4000 i 0x5000 zamiast 0x400 i 0x500 jako rozmiarÃ³w kawaÅ‚kÃ³w (aby uniknÄ…Ä‡ Tcache), moÅ¼na zobaczyÄ‡, Å¼e **obecnie** bÅ‚Ä…d **`malloc(): niesortowana podwÃ³jnie powiÄ…zana lista uszkodzona`** jest wyzwalany.

Dlatego ten atak na niesortowany koszyk teraz (wÅ›rÃ³d innych kontroli) rÃ³wnieÅ¼ wymaga moÅ¼liwoÅ›ci naprawienia podwÃ³jnie powiÄ…zanej listy, aby to obejÅ›Ä‡ `victim->bk->fd == victim` lub nie `victim->fd == av (arena)`, co oznacza, Å¼e adres, w ktÃ³rym chcemy zapisaÄ‡, musi mieÄ‡ adres faÅ‚szywego kawaÅ‚ka w swojej pozycji `fd`, a faÅ‚szywy kawaÅ‚ek `fd` wskazuje na arenÄ™.
{% endhint %}

{% hint style="danger" %}
ZauwaÅ¼, Å¼e ten atak psuje niesortowany koszyk (stÄ…d maÅ‚y i duÅ¼y rÃ³wnieÅ¼). Dlatego moÅ¼emy teraz **uÅ¼ywaÄ‡ tylko alokacji z szybkiego koszyka** (bardziej zÅ‚oÅ¼ony program moÅ¼e wykonaÄ‡ inne alokacje i siÄ™ zawiesiÄ‡), a aby to wyzwoliÄ‡, musimy **alokowaÄ‡ ten sam rozmiar, w przeciwnym razie program siÄ™ zawiesi.**

ZauwaÅ¼, Å¼e nadpisanie **`global_max_fast`** moÅ¼e pomÃ³c w tym przypadku, ufajÄ…c, Å¼e szybki koszyk bÄ™dzie w stanie zajÄ…Ä‡ siÄ™ wszystkimi innymi alokacjami, aÅ¼ do zakoÅ„czenia eksploatu.
{% endhint %}

Kod z [**guyinatuxedo**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/unsorted\_explanation/index.html) wyjaÅ›nia to bardzo dobrze, chociaÅ¼ jeÅ›li zmodyfikujesz mallocy, aby alokowaÄ‡ pamiÄ™Ä‡ wystarczajÄ…co duÅ¼Ä…, aby nie skoÅ„czyÄ‡ w Tcache, moÅ¼esz zobaczyÄ‡, Å¼e wczeÅ›niej wspomniany bÅ‚Ä…d pojawia siÄ™, uniemoÅ¼liwiajÄ…c tÄ™ technikÄ™: **`malloc(): niesortowana podwÃ³jnie powiÄ…zana lista uszkodzona`**

## Atak na Wycieki Informacji z Niesortowanego Koszyka

To w rzeczywistoÅ›ci bardzo podstawowa koncepcja. KawaÅ‚ki w niesortowanym koszyku bÄ™dÄ… miaÅ‚y wskaÅºniki. Pierwszy kawaÅ‚ek w niesortowanym koszyku bÄ™dzie miaÅ‚ **`fd`** i **`bk`** linki **wskazujÄ…ce na czÄ™Å›Ä‡ gÅ‚Ã³wnej areny (Glibc)**.\
Dlatego, jeÅ›li moÅ¼esz **wÅ‚oÅ¼yÄ‡ kawaÅ‚ek do niesortowanego koszyka i go odczytaÄ‡** (uÅ¼ycie po zwolnieniu) lub **ponownie go alokowaÄ‡ bez nadpisywania przynajmniej 1 z wskaÅºnikÃ³w**, aby nastÄ™pnie **go odczytaÄ‡**, moÅ¼esz uzyskaÄ‡ **wyciek informacji Glibc**.

Podobny [**atak uÅ¼yty w tym opisie**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw18\_alienVSsamurai/index.html) polegaÅ‚ na naduÅ¼ywaniu struktury 4 kawaÅ‚kÃ³w (A, B, C i D - D jest tylko po to, aby zapobiec konsolidacji z gÃ³rnym kawaÅ‚kiem), wiÄ™c uÅ¼yto przepeÅ‚nienia bajtu null w B, aby sprawiÄ‡, Å¼e C wskazywaÅ‚o, Å¼e B byÅ‚ nieuÅ¼ywany. Ponadto w B zmodyfikowano dane `prev_size`, aby rozmiar zamiast rozmiaru B wynosiÅ‚ A+B.\
NastÄ™pnie C zostaÅ‚ zwolniony i skonsolidowany z A+B (ale B wciÄ…Å¼ byÅ‚ uÅ¼ywany). Nowy kawaÅ‚ek o rozmiarze A zostaÅ‚ alokowany, a nastÄ™pnie adresy wyciekÃ³w libc zostaÅ‚y zapisane w B, skÄ…d zostaÅ‚y wyciekniÄ™te.

## Odniesienia i inne przykÅ‚ady

* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/unsorted\_bin\_attack/#hitcon-training-lab14-magic-heap)
* Celem jest nadpisanie zmiennej globalnej wartoÅ›ciÄ… wiÄ™kszÄ… niÅ¼ 4869, aby moÅ¼liwe byÅ‚o uzyskanie flagi, a PIE nie jest wÅ‚Ä…czone.
* MoÅ¼liwe jest generowanie kawaÅ‚kÃ³w o dowolnych rozmiarach, a takÅ¼e wystÄ™puje przepeÅ‚nienie sterty o poÅ¼Ä…danym rozmiarze.
* Atak zaczyna siÄ™ od stworzenia 3 kawaÅ‚kÃ³w: chunk0 do naduÅ¼ywania przepeÅ‚nienia, chunk1 do przepeÅ‚nienia i chunk2, aby gÃ³rny kawaÅ‚ek nie konsolidowaÅ‚ poprzednich.
* NastÄ™pnie chunk1 jest zwalniany, a chunk0 jest przepeÅ‚niany, aby wskaÅºnik `bk` chunk1 wskazywaÅ‚ na: `bk = magic - 0x10`
* NastÄ™pnie chunk3 jest alokowany o tym samym rozmiarze co chunk1, co wyzwoli atak na niesortowany koszyk i zmodyfikuje wartoÅ›Ä‡ zmiennej globalnej, co umoÅ¼liwi uzyskanie flagi.
* [**https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html**](https://guyinatuxedo.github.io/31-unsortedbin\_attack/0ctf16\_zerostorage/index.html)
* Funkcja merge jest podatna, poniewaÅ¼ jeÅ›li oba przekazane indeksy sÄ… takie same, to zrealokuje jÄ… i nastÄ™pnie zwolni, ale zwrÃ³ci wskaÅºnik do tego zwolnionego obszaru, ktÃ³ry moÅ¼na wykorzystaÄ‡.
* Dlatego **tworzone sÄ… 2 kawaÅ‚ki**: **chunk0**, ktÃ³ry zostanie scalony z samym sobÄ…, oraz chunk1, aby zapobiec konsolidacji z gÃ³rnym kawaÅ‚kiem. NastÄ™pnie **funkcja merge jest wywoÅ‚ywana z chunk0** dwukrotnie, co spowoduje uÅ¼ycie po zwolnieniu.
* NastÄ™pnie **funkcja `view`** jest wywoÅ‚ywana z indeksem 2 (ktÃ³ry jest indeksem kawaÅ‚ka uÅ¼ywanego po zwolnieniu), co **wycieka adres libc**.
* PoniewaÅ¼ binarka ma zabezpieczenia, aby tylko mallocowaÄ‡ rozmiary wiÄ™ksze niÅ¼ **`global_max_fast`**, wiÄ™c Å¼aden szybki koszyk nie jest uÅ¼ywany, zostanie uÅ¼yty atak na niesortowany koszyk, aby nadpisaÄ‡ zmiennÄ… globalnÄ… `global_max_fast`.
* NastÄ™pnie moÅ¼liwe jest wywoÅ‚anie funkcji edytora z indeksem 2 (wskaÅºnik uÅ¼ywany po zwolnieniu) i nadpisanie wskaÅºnika `bk`, aby wskazywaÅ‚ na `p64(global_max_fast-0x10)`. NastÄ™pnie, tworzÄ…c nowy kawaÅ‚ek, uÅ¼yje wczeÅ›niej skompromitowanego adresu zwolnionego (0x20), co **wyzwoli atak na niesortowany koszyk**, nadpisujÄ…c `global_max_fast`, co jest bardzo duÅ¼Ä… wartoÅ›ciÄ…, co teraz pozwala na tworzenie kawaÅ‚kÃ³w w szybkich koszykach.
* Teraz przeprowadzany jest **atak na szybki koszyk**:
* Przede wszystkim odkryto, Å¼e moÅ¼liwe jest pracowanie z szybkimi **kawaÅ‚kami o rozmiarze 200** w lokalizacji **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* JeÅ›li uda nam siÄ™ uzyskaÄ‡ szybki kawaÅ‚ek o rozmiarze 0x200 w tej lokalizacji, bÄ™dzie moÅ¼liwe nadpisanie wskaÅºnika funkcji, ktÃ³ry zostanie wykonany.
* W tym celu tworzony jest nowy kawaÅ‚ek o rozmiarze `0xfc`, a funkcja merge jest wywoÅ‚ywana z tym wskaÅºnikiem dwukrotnie, w ten sposÃ³b uzyskujemy wskaÅºnik do zwolnionego kawaÅ‚ka o rozmiarze `0xfc*2 = 0x1f8` w szybkim koszyku.
* NastÄ™pnie funkcja edytora jest wywoÅ‚ywana w tym kawaÅ‚ku, aby zmodyfikowaÄ‡ adres **`fd`** tego szybkiego koszyka, aby wskazywaÅ‚ na poprzedniÄ… funkcjÄ™ **`__free_hook`**.
* NastÄ™pnie tworzony jest kawaÅ‚ek o rozmiarze `0x1f8`, aby odzyskaÄ‡ z szybkiego koszyka poprzedni bezuÅ¼yteczny kawaÅ‚ek, wiÄ™c tworzony jest kolejny kawaÅ‚ek o rozmiarze `0x1f8`, aby uzyskaÄ‡ kawaÅ‚ek szybkiego koszyka w **`__free_hook`**, ktÃ³ry jest nadpisywany adresem funkcji **`system`**.
* A na koniec kawaÅ‚ek zawierajÄ…cy ciÄ…g `/bin/sh\x00` jest zwalniany, wywoÅ‚ujÄ…c funkcjÄ™ usuwania, co wyzwala funkcjÄ™ **`__free_hook`**, ktÃ³ra wskazuje na system z `/bin/sh\x00` jako parametrem.
* **CTF** [**https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html**](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw19\_traveller/index.html)
* Inny przykÅ‚ad naduÅ¼ywania przepeÅ‚nienia 1B do konsolidacji kawaÅ‚kÃ³w w niesortowanym koszyku i uzyskania wycieku informacji libc, a nastÄ™pnie przeprowadzenia ataku na szybki koszyk w celu nadpisania haka malloc z adresem jednego gadÅ¼etu.
* [**Robot Factory. BlackHat MEA CTF 2022**](https://7rocky.github.io/en/ctf/other/blackhat-ctf/robot-factory/)
* MoÅ¼emy alokowaÄ‡ tylko kawaÅ‚ki o rozmiarze wiÄ™kszym niÅ¼ `0x100`.
* Nadpisz `global_max_fast` uÅ¼ywajÄ…c ataku na niesortowany koszyk (dziaÅ‚a 1/16 razy z powodu ASLR, poniewaÅ¼ musimy zmodyfikowaÄ‡ 12 bitÃ³w, ale musimy zmodyfikowaÄ‡ 16 bitÃ³w).
* Atak na szybki koszyk w celu modyfikacji globalnej tablicy kawaÅ‚kÃ³w. To daje dowolnÄ… prymitywÄ™ odczytu/zapisu, co pozwala na modyfikacjÄ™ GOT i ustawienie niektÃ³rej funkcji, aby wskazywaÅ‚a na `system`.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}
