# House of Orange

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

### C√≥digo

* Encontre um exemplo em [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* A t√©cnica de explora√ß√£o foi corrigida neste [patch](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) ent√£o isso n√£o est√° mais funcionando (funcionando em vers√µes anteriores a 2.26)
* Mesmo exemplo **com mais coment√°rios** em [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Objetivo

* Abusar da fun√ß√£o `malloc_printerr`

### Requisitos

* Sobrescrever o tamanho do top chunk
* Vazamentos de libc e heap

### Contexto

Algumas informa√ß√µes de fundo necess√°rias dos coment√°rios de [**este exemplo**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

A quest√£o √© que, em vers√µes mais antigas da libc, quando a fun√ß√£o `malloc_printerr` era chamada, ela **iterava atrav√©s de uma lista de structs `_IO_FILE` armazenadas em `_IO_list_all`**, e na verdade **executava** um ponteiro de instru√ß√£o naquela struct.\
Este ataque ir√° forjar uma **struct `_IO_FILE` falsa** que escreveremos em **`_IO_list_all`**, e far√° com que `malloc_printerr` seja executado.\
Ent√£o, ele ir√° **executar qualquer endere√ßo** que tenhamos armazenado na tabela de saltos das structs **`_IO_FILE`**, e obteremos execu√ß√£o de c√≥digo.

### Ataque

O ataque come√ßa conseguindo obter o **top chunk** dentro do **unsorted bin**. Isso √© alcan√ßado chamando `malloc` com um tamanho maior que o tamanho atual do top chunk, mas menor que **`mmp_.mmap_threshold`** (o padr√£o √© 128K), que de outra forma acionaria a aloca√ß√£o `mmap`. Sempre que o tamanho do top chunk √© modificado, √© importante garantir que o **top chunk + seu tamanho** esteja alinhado √† p√°gina e que o bit **prev\_inuse** do top chunk esteja sempre definido.

Para obter o top chunk dentro do unsorted bin, aloque um chunk para criar o top chunk, mude o tamanho do top chunk (com um overflow no chunk alocado) para que **top chunk + tamanho** esteja alinhado √† p√°gina com o bit **prev\_inuse** definido. Em seguida, aloque um chunk maior que o novo tamanho do top chunk. Note que `free` nunca √© chamado para colocar o top chunk no unsorted bin.

O antigo top chunk agora est√° no unsorted bin. Supondo que possamos ler dados dentro dele (possivelmente devido a uma vulnerabilidade que tamb√©m causou o overflow), √© poss√≠vel vazar endere√ßos da libc a partir dele e obter o endere√ßo de **\_IO\_list\_all**.

Um ataque de unsorted bin √© realizado abusando do overflow para escrever `topChunk->bk->fwd = _IO_list_all - 0x10`. Quando um novo chunk √© alocado, o antigo top chunk ser√° dividido, e um ponteiro para o unsorted bin ser√° escrito em **`_IO_list_all`**.

O pr√≥ximo passo envolve reduzir o tamanho do antigo top chunk para caber em um small bin, especificamente definindo seu tamanho para **0x61**. Isso serve a dois prop√≥sitos:

1. **Inser√ß√£o no Small Bin 4**: Quando `malloc` escaneia o unsorted bin e v√™ este chunk, ele tentar√° inseri-lo no small bin 4 devido ao seu pequeno tamanho. Isso faz com que o chunk termine na cabe√ßa da lista do small bin 4, que √© a localiza√ß√£o do ponteiro FD do chunk de **`_IO_list_all`** j√° que escrevemos um endere√ßo pr√≥ximo em **`_IO_list_all`** via ataque de unsorted bin.
2. **Acionando uma Verifica√ß√£o de Malloc**: Essa manipula√ß√£o do tamanho do chunk far√° com que `malloc` execute verifica√ß√µes internas. Quando ele verifica o tamanho do chunk falso de avan√ßo, que ser√° zero, isso aciona um erro e chama `malloc_printerr`.

A manipula√ß√£o do small bin permitir√° que voc√™ controle o ponteiro de avan√ßo do chunk. A sobreposi√ß√£o com **\_IO\_list\_all** √© usada para forjar uma estrutura **\_IO\_FILE** falsa. A estrutura √© cuidadosamente elaborada para incluir campos-chave como `_IO_write_base` e `_IO_write_ptr` definidos para valores que passam nas verifica√ß√µes internas da libc. Al√©m disso, uma tabela de saltos √© criada dentro da estrutura falsa, onde um ponteiro de instru√ß√£o √© definido para o endere√ßo onde c√≥digo arbitr√°rio (por exemplo, a fun√ß√£o `system`) pode ser executado.

Para resumir a parte restante da t√©cnica:

* **Reduzir o Antigo Top Chunk**: Ajustar o tamanho do antigo top chunk para **0x61** para caber em um small bin.
* **Configurar a Estrutura Falsa `_IO_FILE`**: Sobrepor o antigo top chunk com a estrutura falsa **\_IO\_FILE** e definir os campos adequadamente para sequestrar o fluxo de execu√ß√£o.

O pr√≥ximo passo envolve forjar uma estrutura falsa **\_IO\_FILE** que se sobrep√µe ao antigo top chunk atualmente no unsorted bin. Os primeiros bytes desta estrutura s√£o elaborados cuidadosamente para incluir um ponteiro para um comando (por exemplo, "/bin/sh") que ser√° executado.

Campos-chave na estrutura falsa **\_IO\_FILE**, como `_IO_write_base` e `_IO_write_ptr`, s√£o definidos para valores que passam nas verifica√ß√µes internas da libc. Al√©m disso, uma tabela de saltos √© criada dentro da estrutura falsa, onde um ponteiro de instru√ß√£o √© definido para o endere√ßo onde c√≥digo arbitr√°rio pode ser executado. Normalmente, este seria o endere√ßo da fun√ß√£o `system` ou outra fun√ß√£o que pode executar comandos de shell.

O ataque culmina quando uma chamada para `malloc` aciona a execu√ß√£o do c√≥digo atrav√©s da estrutura manipulada **\_IO\_FILE**. Isso efetivamente permite a execu√ß√£o de c√≥digo arbitr√°rio, resultando tipicamente em um shell sendo gerado ou outro payload malicioso sendo executado.

**Resumo do Ataque:**

1. **Configurar o top chunk**: Alocar um chunk e modificar o tamanho do top chunk.
2. **For√ßar o top chunk para o unsorted bin**: Alocar um chunk maior.
3. **Vazar endere√ßos da libc**: Usar a vulnerabilidade para ler do unsorted bin.
4. **Realizar o ataque de unsorted bin**: Escrever em **\_IO\_list\_all** usando um overflow.
5. **Reduzir o antigo top chunk**: Ajustar seu tamanho para caber em um small bin.
6. **Configurar uma estrutura falsa \_IO\_FILE**: Forjar uma estrutura de arquivo falsa para sequestrar o fluxo de controle.
7. **Acionar a execu√ß√£o de c√≥digo**: Alocar um chunk para executar o ataque e rodar c√≥digo arbitr√°rio.

Essa abordagem explora mecanismos de gerenciamento de heap, vazamentos de informa√ß√µes da libc e overflows de heap para alcan√ßar a execu√ß√£o de c√≥digo sem chamar diretamente `free`. Ao elaborar cuidadosamente a estrutura falsa **\_IO\_FILE** e coloc√°-la na localiza√ß√£o correta, o ataque pode sequestrar o fluxo de controle durante opera√ß√µes padr√£o de aloca√ß√£o de mem√≥ria. Isso permite a execu√ß√£o de c√≥digo arbitr√°rio, resultando potencialmente em um shell ou outras atividades maliciosas.

## Refer√™ncias

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
