# Casa de Laranja

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

### C√≥digo

* Encontre um exemplo em [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* A t√©cnica de explora√ß√£o foi corrigida neste [patch](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) ent√£o isso n√£o funciona mais (funciona em vers√µes anteriores a 2.26)
* Mesmo exemplo **com mais coment√°rios** em [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Objetivo

* Abusar da fun√ß√£o `malloc_printerr`

### Requisitos

* Sobrescrever o tamanho do top chunk
* Vazamentos de libc e heap

### Contexto

Algumas informa√ß√µes necess√°rias dos coment√°rios deste [**exemplo**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

A quest√£o √© que, em vers√µes mais antigas da libc, quando a fun√ß√£o `malloc_printerr` era chamada, ela **iterava por uma lista de estruturas `_IO_FILE` armazenadas em `_IO_list_all`**, e realmente **executava** um ponteiro de instru√ß√£o nessa estrutura.\
Este ataque ir√° forjar uma **estrutura `_IO_FILE` falsa** que escreveremos em **`_IO_list_all`**, e causar√° a execu√ß√£o de `malloc_printerr`.\
Ent√£o ele ir√° **executar qualquer endere√ßo** que tivermos armazenado na tabela de saltos das estruturas **`_IO_FILE`**, e conseguiremos a execu√ß√£o de c√≥digo

### Ataque

O ataque come√ßa conseguindo o **top chunk** dentro do **unsorted bin**. Isso √© alcan√ßado chamando `malloc` com um tamanho maior que o tamanho atual do top chunk, mas menor que **`mmp_.mmap_threshold`** (padr√£o √© 128K), o que de outra forma acionaria a aloca√ß√£o `mmap`. Sempre que o tamanho do top chunk √© modificado, √© importante garantir que o **top chunk + seu tamanho** esteja alinhado √† p√°gina e que o bit **prev\_inuse** do top chunk esteja sempre definido.

Para obter o top chunk dentro do unsorted bin, aloque um chunk para criar o top chunk, altere o tamanho do top chunk (com um estouro no chunk alocado) para que **top chunk + tamanho** esteja alinhado √† p√°gina com o bit **prev\_inuse** definido. Em seguida, aloque um chunk maior que o novo tamanho do top chunk. Note que `free` nunca √© chamado para colocar o top chunk no unsorted bin.

O antigo top chunk agora est√° no unsorted bin. Supondo que podemos ler dados dentro dele (possivelmente devido a uma vulnerabilidade que tamb√©m causou o estouro), √© poss√≠vel vazar endere√ßos da libc a partir dele e obter o endere√ßo de **\_IO\_list\_all**.

Um ataque ao unsorted bin √© realizado abusando do estouro para escrever `topChunk->bk->fwd = _IO_list_all - 0x10`. Quando um novo chunk √© alocado, o antigo top chunk ser√° dividido, e um ponteiro para o unsorted bin ser√° escrito em **`_IO_list_all`**.

O pr√≥ximo passo envolve reduzir o tamanho do antigo top chunk para caber em um small bin, especificamente definindo seu tamanho para **0x61**. Isso serve a dois prop√≥sitos:

1. **Inser√ß√£o no Small Bin 4**: Quando `malloc` percorre o unsorted bin e v√™ este chunk, ele tentar√° inseri-lo no small bin 4 devido ao seu tamanho pequeno. Isso faz com que o chunk acabe na cabe√ßa da lista do small bin 4, que √© a localiza√ß√£o do ponteiro FD do chunk de **`_IO_list_all`** j√° que escrevemos um endere√ßo pr√≥ximo em **`_IO_list_all`** via o ataque ao unsorted bin.
2. **Desencadeando uma Verifica√ß√£o de Malloc**: Essa manipula√ß√£o de tamanho do chunk far√° com que `malloc` execute verifica√ß√µes internas. Quando ele verifica o tamanho do chunk falso √† frente, que ser√° zero, ele desencadeia um erro e chama `malloc_printerr`.

A manipula√ß√£o do small bin permitir√° controlar o ponteiro √† frente do chunk. A sobreposi√ß√£o com **\_IO\_list\_all** √© usada para forjar uma estrutura fake **\_IO\_FILE**. A estrutura √© cuidadosamente elaborada para incluir campos-chave como `_IO_write_base` e `_IO_write_ptr` definidos para valores que passam verifica√ß√µes internas na libc. Al√©m disso, uma tabela de saltos √© criada dentro da estrutura falsa, onde um ponteiro de instru√ß√£o √© definido para o endere√ßo onde um c√≥digo arbitr√°rio (por exemplo, a fun√ß√£o `system`) pode ser executado.

Para resumir a parte restante da t√©cnica:

* **Reduza o Antigo Top Chunk**: Ajuste o tamanho do antigo top chunk para **0x61** para encaix√°-lo em um small bin.
* **Configure a Estrutura Fake `_IO_FILE`**: Sobreponha o antigo top chunk com a estrutura fake **\_IO_FILE** e defina os campos apropriadamente para sequestrar o fluxo de execu√ß√£o.

O pr√≥ximo passo envolve forjar uma estrutura fake **\_IO_FILE** que se sobrep√µe ao antigo top chunk atualmente no unsorted bin. Os primeiros bytes desta estrutura s√£o cuidadosamente elaborados para incluir um ponteiro para um comando (por exemplo, "/bin/sh") que ser√° executado.

Campos-chave na estrutura fake **\_IO_FILE**, como `_IO_write_base` e `_IO_write_ptr`, s√£o definidos para valores que passam verifica√ß√µes internas na libc. Al√©m disso, uma tabela de saltos √© criada dentro da estrutura fake, onde um ponteiro de instru√ß√£o √© definido para o endere√ßo onde um c√≥digo arbitr√°rio pode ser executado. Tipicamente, este seria o endere√ßo da fun√ß√£o `system` ou outra fun√ß√£o que pode executar comandos shell.

O ataque culmina quando uma chamada para `malloc` aciona a execu√ß√£o do c√≥digo atrav√©s da estrutura **\_IO\_FILE** manipulada. Isso permite a execu√ß√£o de c√≥digo arbitr√°rio, resultando tipicamente em um shell sendo aberto ou outra carga maliciosa sendo executada.

**Resumo do Ataque:**

1. **Configure o top chunk**: Aloque um chunk e modifique o tamanho do top chunk.
2. **Force o top chunk para o unsorted bin**: Aloque um chunk maior.
3. **Vaze endere√ßos da libc**: Use a vulnerabilidade para ler do unsorted bin.
4. **Execute o ataque ao unsorted bin**: Escreva em **\_IO\_list\_all** usando um estouro.
5. **Reduza o antigo top chunk**: Ajuste seu tamanho para encaix√°-lo em um small bin.
6. **Configure uma estrutura fake \_IO\_FILE**: Forje uma estrutura de arquivo fake para sequestrar o fluxo de controle.
7. **Desencadeie a execu√ß√£o de c√≥digo**: Aloque um chunk para executar o ataque e executar c√≥digo arbitr√°rio.

Esta abordagem explora mecanismos de gerenciamento de heap, vazamentos de informa√ß√µes da libc e estouros de heap para alcan√ßar a execu√ß√£o de c√≥digo sem chamar diretamente `free`. Ao elaborar cuidadosamente a estrutura fake **\_IO\_FILE** e coloc√°-la na localiza√ß√£o correta, o ataque pode sequestrar o fluxo de controle durante opera√ß√µes padr√£o de aloca√ß√£o de mem√≥ria. Isso permite a execu√ß√£o de c√≥digo arbitr√°rio, potencialmente resultando em um shell ou outras atividades maliciosas.
## Refer√™ncias

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
