# House of Orange

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

### Code

* Finde ein Beispiel in [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Die Exploitationstechnik wurde in diesem [Patch](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) behoben, sodass dies nicht mehr funktioniert (funktioniert in Versionen vor 2.26)
* Dasselbe Beispiel **mit mehr Kommentaren** in [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Ziel

* Missbrauch der `malloc_printerr`-Funktion

### Anforderungen

* √úberschreibe die Gr√∂√üe des Top-Chunks
* Libc- und Heap-Leaks

### Hintergrund

Einige ben√∂tigte Hintergr√ºnde aus den Kommentaren zu [**diesem Beispiel**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Die Sache ist, dass in √§lteren Versionen von libc, wenn die `malloc_printerr`-Funktion aufgerufen wurde, sie **durch eine Liste von `_IO_FILE`-Strukturen, die in `_IO_list_all` gespeichert sind, iterierte** und tats√§chlich **einen** Befehlszeiger in dieser Struktur **ausf√ºhrte**.\
Dieser Angriff wird eine **falsche `_IO_FILE`-Struktur** f√§lschen, die wir in **`_IO_list_all`** schreiben werden, und `malloc_printerr` dazu bringen, ausgef√ºhrt zu werden.\
Dann wird es **jede Adresse ausf√ºhren**, die wir in der **Sprungtabelle der `_IO_FILE`**-Strukturen gespeichert haben, und wir werden Codeausf√ºhrung erhalten.

### Angriff

Der Angriff beginnt damit, dass es gelingt, den **Top-Chuck** im **unsortierten Bin** zu erhalten. Dies wird erreicht, indem `malloc` mit einer Gr√∂√üe aufgerufen wird, die gr√∂√üer ist als die aktuelle Top-Chuck-Gr√∂√üe, aber kleiner als **`mmp_.mmap_threshold`** (Standard ist 128K), was andernfalls eine `mmap`-Zuweisung ausl√∂sen w√ºrde. Wann immer die Gr√∂√üe des Top-Chunks ge√§ndert wird, ist es wichtig sicherzustellen, dass die **Top-Chuck + seine Gr√∂√üe** seitenaligned ist und dass das **prev\_inuse**-Bit des Top-Chunks immer gesetzt ist.

Um den Top-Chuck im unsortierten Bin zu erhalten, allokiere einen Chunk, um den Top-Chuck zu erstellen, √§ndere die Gr√∂√üe des Top-Chunks (mit einem √úberlauf im zugewiesenen Chunk), sodass **Top-Chuck + Gr√∂√üe** seitenaligned ist und das **prev\_inuse**-Bit gesetzt ist. Dann allokiere einen Chunk, der gr√∂√üer ist als die neue Top-Chuck-Gr√∂√üe. Beachte, dass `free` niemals aufgerufen wird, um den Top-Chuck in das unsortierte Bin zu bringen.

Der alte Top-Chuck befindet sich jetzt im unsortierten Bin. Vorausgesetzt, wir k√∂nnen Daten darin lesen (m√∂glicherweise aufgrund einer Schwachstelle, die auch den √úberlauf verursacht hat), ist es m√∂glich, libc-Adressen daraus zu leaken und die Adresse von **\_IO\_list\_all** zu erhalten.

Ein Angriff auf das unsortierte Bin wird durchgef√ºhrt, indem der √úberlauf missbraucht wird, um `topChunk->bk->fwd = _IO_list_all - 0x10` zu schreiben. Wenn ein neuer Chunk zugewiesen wird, wird der alte Top-Chuck aufgeteilt, und ein Zeiger auf das unsortierte Bin wird in **`_IO_list_all`** geschrieben.

Der n√§chste Schritt besteht darin, die Gr√∂√üe des alten Top-Chunks zu verringern, um in ein kleines Bin zu passen, indem seine Gr√∂√üe auf **0x61** gesetzt wird. Dies dient zwei Zwecken:

1. **Einf√ºgen in Small Bin 4**: Wenn `malloc` durch das unsortierte Bin scannt und diesen Chunk sieht, wird es versuchen, ihn aufgrund seiner kleinen Gr√∂√üe in Small Bin 4 einzuf√ºgen. Dadurch landet der Chunk am Kopf der Small Bin 4-Liste, die der Standort des FD-Zeigers des Chunks von **`_IO_list_all`** ist, da wir eine nahe Adresse in **`_IO_list_all`** √ºber den Angriff auf das unsortierte Bin geschrieben haben.
2. **Ausl√∂sen einer Malloc-Pr√ºfung**: Diese Manipulation der Chunk-Gr√∂√üe wird dazu f√ºhren, dass `malloc` interne Pr√ºfungen durchf√ºhrt. Wenn es die Gr√∂√üe des falschen Vorw√§rtschunks √ºberpr√ºft, die null sein wird, wird ein Fehler ausgel√∂st und `malloc_printerr` aufgerufen.

Die Manipulation des kleinen Bins erm√∂glicht es dir, den Vorw√§rtszeiger des Chunks zu steuern. Die √úberlappung mit **\_IO\_list\_all** wird verwendet, um eine falsche **\_IO\_FILE**-Struktur zu f√§lschen. Die Struktur wird sorgf√§ltig erstellt, um wichtige Felder wie `_IO_write_base` und `_IO_write_ptr` zu enthalten, die auf Werte gesetzt sind, die interne Pr√ºfungen in libc bestehen. Dar√ºber hinaus wird innerhalb der falschen Struktur eine Sprungtabelle erstellt, in der ein Befehlszeiger auf die Adresse gesetzt wird, an der beliebiger Code (z. B. die `system`-Funktion) ausgef√ºhrt werden kann.

Um den verbleibenden Teil der Technik zusammenzufassen:

* **Verkleinere den alten Top-Chuck**: Passe die Gr√∂√üe des alten Top-Chunks auf **0x61** an, um ihn in ein kleines Bin zu passen.
* **Richte die falsche `_IO_FILE`-Struktur ein**: √úberlappe den alten Top-Chuck mit der falschen **\_IO\_FILE**-Struktur und setze die Felder entsprechend, um den Ausf√ºhrungsfluss zu √ºbernehmen.

Der n√§chste Schritt besteht darin, eine falsche **\_IO\_FILE**-Struktur zu f√§lschen, die mit dem alten Top-Chuck √ºberlappt, der sich derzeit im unsortierten Bin befindet. Die ersten Bytes dieser Struktur werden sorgf√§ltig erstellt, um einen Zeiger auf einen Befehl (z. B. "/bin/sh"), der ausgef√ºhrt werden soll, zu enthalten.

Wichtige Felder in der falschen **\_IO\_FILE**-Struktur, wie `_IO_write_base` und `_IO_write_ptr`, werden auf Werte gesetzt, die interne Pr√ºfungen in libc bestehen. Dar√ºber hinaus wird innerhalb der falschen Struktur eine Sprungtabelle erstellt, in der ein Befehlszeiger auf die Adresse gesetzt wird, an der beliebiger Code ausgef√ºhrt werden kann. Typischerweise w√§re dies die Adresse der `system`-Funktion oder einer anderen Funktion, die Shell-Befehle ausf√ºhren kann.

Der Angriff kulminiert, wenn ein Aufruf an `malloc` die Ausf√ºhrung des Codes √ºber die manipulierte **\_IO\_FILE**-Struktur ausl√∂st. Dies erm√∂glicht effektiv die Ausf√ºhrung beliebigen Codes, was typischerweise dazu f√ºhrt, dass eine Shell gestartet oder eine andere b√∂sartige Nutzlast ausgef√ºhrt wird.

**Zusammenfassung des Angriffs:**

1. **Richte den Top-Chuck ein**: Allokiere einen Chunk und √§ndere die Gr√∂√üe des Top-Chunks.
2. **Zwinge den Top-Chuck in das unsortierte Bin**: Allokiere einen gr√∂√üeren Chunk.
3. **Leake libc-Adressen**: Nutze die Schwachstelle, um aus dem unsortierten Bin zu lesen.
4. **F√ºhre den Angriff auf das unsortierte Bin durch**: Schreibe in **\_IO\_list\_all** mithilfe eines √úberlaufs.
5. **Verkleinere den alten Top-Chuck**: Passe seine Gr√∂√üe an, um in ein kleines Bin zu passen.
6. **Richte eine falsche \_IO\_FILE-Struktur ein**: F√§lsche eine falsche Datei-Struktur, um den Kontrollfluss zu √ºbernehmen.
7. **Trigger die Codeausf√ºhrung**: Allokiere einen Chunk, um den Angriff auszuf√ºhren und beliebigen Code auszuf√ºhren.

Dieser Ansatz nutzt die Mechanismen des Heap-Managements, libc-Informationslecks und Heap-√úberl√§ufe aus, um die Codeausf√ºhrung zu erreichen, ohne direkt `free` aufzurufen. Durch die sorgf√§ltige Erstellung der falschen **\_IO\_FILE**-Struktur und deren Platzierung an der richtigen Stelle kann der Angriff den Kontrollfluss w√§hrend der Standard-Speicherzuweisungsoperationen √ºbernehmen. Dies erm√∂glicht die Ausf√ºhrung beliebigen Codes, was potenziell zu einer Shell oder anderen b√∂sartigen Aktivit√§ten f√ºhren kann.

## Referenzen

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
