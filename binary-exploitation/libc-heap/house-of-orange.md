# House of Orange

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}

## 基本情報

### コード

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)に例があります。
* この[パッチ](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0)で脆弱性が修正されたため、これはもはや機能しません（2.26より前のバージョンでは動作します）。
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)に**より多くのコメント付きの同じ例**があります。

### 目標

* `malloc_printerr`関数を悪用する

### 要件

* トップチャンクサイズを上書きする
* Libcとヒープのリーク

### 背景

[**この例**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)からの必要な背景情報：

古いバージョンのlibcでは、`malloc_printerr`関数が呼び出されると、**`_IO_list_all`に格納された`_IO_FILE`構造体のリストを反復処理し、実際にその構造体内の命令ポインタを実行していました。**\
この攻撃では、**`_IO_list_all`に書き込む**ための**偽の`_IO_FILE`構造体**を作成し、`malloc_printerr`を実行させます。\
その後、**`_IO_FILE`**構造体のジャンプテーブルに格納された**任意のアドレス**を実行し、コード実行を得ることができます。

### 攻撃

攻撃は、**未ソートビン**内の**トップチャンク**を取得することから始まります。これは、現在のトップチャンクサイズより大きいが、**`mmp_.mmap_threshold`**（デフォルトは128K）より小さいサイズで`malloc`を呼び出すことで達成されます。そうしないと、`mmap`割り当てがトリガーされます。トップチャンクサイズが変更されるときは、**トップチャンク + サイズ**がページアラインされていること、そしてトップチャンクの**prev\_inuse**ビットが常に設定されていることを確認することが重要です。

未ソートビン内のトップチャンクを取得するには、トップチャンクを作成するためにチャンクを割り当て、トップチャンクサイズを変更（割り当てられたチャンク内のオーバーフローを使用）して、**トップチャンク + サイズ**がページアラインされ、**prev\_inuse**ビットが設定されるようにします。その後、新しいトップチャンクサイズより大きいチャンクを割り当てます。`free`は未ソートビンにトップチャンクを取得するために決して呼び出されないことに注意してください。

古いトップチャンクは現在未ソートビンにあります。内部のデータを読み取ることができると仮定すると（おそらくオーバーフローを引き起こした脆弱性のため）、そこからlibcアドレスをリークし、**\_IO\_list\_all**のアドレスを取得することが可能です。

未ソートビン攻撃は、オーバーフローを悪用して`topChunk->bk->fwd = _IO_list_all - 0x10`を書き込むことによって実行されます。新しいチャンクが割り当てられると、古いトップチャンクが分割され、未ソートビンへのポインタが**`_IO_list_all`**に書き込まれます。

次のステップは、古いトップチャンクのサイズを小さなビンに収まるように縮小し、サイズを**0x61**に設定することです。これには二つの目的があります：

1. **小さなビン4への挿入**：`malloc`が未ソートビンをスキャンし、このチャンクを見つけると、その小さなサイズのために小さなビン4に挿入しようとします。これにより、チャンクの**`_IO_list_all`**のFDポインタの位置にチャンクが小さなビン4リストの先頭に配置されます。
2. **mallocチェックのトリガー**：このチャンクサイズの操作により、`malloc`が内部チェックを実行します。偽のフォワードチャンクのサイズがゼロであるとき、エラーがトリガーされ、`malloc_printerr`が呼び出されます。

小さなビンの操作により、チャンクのフォワードポインタを制御できるようになります。**\_IO\_list\_all**とのオーバーラップを使用して、偽の**\_IO\_FILE**構造体を作成します。この構造体は、libcの内部チェックを通過するように設定された`_IO_write_base`や`_IO_write_ptr`などの重要なフィールドを含むように慎重に作成されます。さらに、偽の構造体内にジャンプテーブルが作成され、命令ポインタが任意のコード（例：`system`関数）を実行できるアドレスに設定されます。

技術の残りの部分を要約すると：

* **古いトップチャンクを縮小**：古いトップチャンクのサイズを**0x61**に調整して小さなビンに収めます。
* **偽の`_IO_FILE`構造体を設定**：古いトップチャンクと偽の**\_IO\_FILE**構造体をオーバーラップさせ、適切にフィールドを設定して実行フローをハイジャックします。

次のステップは、未ソートビンに現在ある古いトップチャンクとオーバーラップする偽の**\_IO\_FILE**構造体を作成することです。この構造体の最初のバイトは、実行されるコマンド（例："/bin/sh"）へのポインタを含むように慎重に作成されます。

偽の**\_IO\_FILE**構造体の重要なフィールド、例えば`_IO_write_base`や`_IO_write_ptr`は、libcの内部チェックを通過する値に設定されます。さらに、偽の構造体内にジャンプテーブルが作成され、命令ポインタが任意のコードを実行できるアドレスに設定されます。通常、これは`system`関数のアドレスやシェルコマンドを実行できる他の関数のアドレスになります。

攻撃は、`malloc`への呼び出しが操作された**\_IO\_FILE**構造体を通じてコードの実行をトリガーすることで culminates します。これにより、任意のコード実行が可能になり、通常はシェルが生成されるか、他の悪意のあるペイロードが実行されます。

**攻撃の要約：**

1. **トップチャンクを設定**：チャンクを割り当て、トップチャンクサイズを変更します。
2. **トップチャンクを未ソートビンに強制的に入れる**：より大きなチャンクを割り当てます。
3. **libcアドレスをリーク**：脆弱性を使用して未ソートビンから読み取ります。
4. **未ソートビン攻撃を実行**：オーバーフローを使用して**\_IO\_list\_all**に書き込みます。
5. **古いトップチャンクを縮小**：小さなビンに収まるようにサイズを調整します。
6. **偽の\_IO\_FILE構造体を設定**：制御フローをハイジャックするために偽のファイル構造体を作成します。
7. **コード実行をトリガー**：攻撃を実行し、任意のコードを実行するためにチャンクを割り当てます。

このアプローチは、ヒープ管理メカニズム、libc情報リーク、およびヒープオーバーフローを利用して、`free`を直接呼び出すことなくコード実行を達成します。偽の**\_IO\_FILE**構造体を慎重に作成し、適切な位置に配置することで、攻撃は標準のメモリ割り当て操作中に制御フローをハイジャックできます。これにより、任意のコードの実行が可能になり、シェルや他の悪意のある活動が発生する可能性があります。

## 参考文献

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを送信してください。**

</details>
{% endhint %}
