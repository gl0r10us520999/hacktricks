# House of Orange

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### Code

* Find an example in [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Tehnika eksploatacije je ispravljena u ovom [zakrpi](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) tako da ovo vi코e ne funkcioni코e (radi u verzijama pre 2.26)
* Isti primer **sa vi코e komentara** u [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Goal

* Zloupotreba `malloc_printerr` funkcije

### Requirements

* Prepisivanje veli캜ine gornjeg dela
* Libc i heap leak-ovi

### Background

Neki potrebni podaci iz komentara iz [**ovog primera**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

Stvar je u tome da, u starijim verzijama libc, kada je pozvana `malloc_printerr` funkcija, ona bi **iterirala kroz listu `_IO_FILE` struktura sme코tenih u `_IO_list_all`**, i zapravo **izvr코ila** pokaziva캜 instrukcija u toj strukturi.\
Ovaj napad 캖e falsifikovati **la쬹u `_IO_FILE` strukturu** koju 캖emo napisati u **`_IO_list_all`**, i izazvati `malloc_printerr` da se pokrene.\
Zatim 캖e **izvr코iti bilo koju adresu** koju imamo sme코tenu u **`_IO_FILE`** tabeli skakanja, i dobi캖emo izvr코enje koda.

### Attack

Napad po캜inje tako 코to se uspeva dobiti **gornji deo** unutar **nesortiranog bin-a**. To se posti쬰 pozivanjem `malloc` sa veli캜inom ve캖om od trenutne veli캜ine gornjeg dela, ali manjom od **`mmp_.mmap_threshold`** (podrazumevano je 128K), 코to bi ina캜e pokrenulo `mmap` alokaciju. Kada god se veli캜ina gornjeg dela izmeni, va쬹o je osigurati da je **gornji deo + njegova veli캜ina** uskla캠en sa stranicom i da je **prev\_inuse** bit gornjeg dela uvek postavljen.

Da biste dobili gornji deo unutar nesortiranog bin-a, alocirajte deo da biste stvorili gornji deo, promenite veli캜inu gornjeg dela (sa prelivanjem u alociranom delu) tako da **gornji deo + veli캜ina** bude uskla캠en sa stranicom sa postavljenim **prev\_inuse** bitom. Zatim alocirajte deo ve캖i od nove veli캜ine gornjeg dela. Imajte na umu da `free` nikada nije pozvan da bi se gornji deo stavio u nesortirani bin.

Stari gornji deo je sada u nesortiranom bin-u. Pretpostavljaju캖i da mo쬰mo 캜itati podatke unutar njega (mogu캖e zbog ranjivosti koja je tako캠e izazvala prelivanje), mogu캖e je da se leak-uje libc adrese iz njega i dobije adresa **\_IO\_list\_all**.

Napad nesortiranog bin-a se vr코i zloupotrebom prelivanja da bi se napisalo `topChunk->bk->fwd = _IO_list_all - 0x10`. Kada se alocira novi deo, stari gornji deo 캖e biti podeljen, a pokaziva캜 na nesortirani bin 캖e biti napisan u **`_IO_list_all`**.

Slede캖i korak uklju캜uje smanjenje veli캜ine starog gornjeg dela da bi stao u mali bin, konkretno postavljaju캖i njegovu veli캜inu na **0x61**. Ovo slu쬴 dvema svrhama:

1. **Umetanje u Mali Bin 4**: Kada `malloc` skenira nesortirani bin i vidi ovaj deo, poku코a캖e da ga umetne u mali bin 4 zbog njegove male veli캜ine. Ovo 캜ini da deo zavr코i na vrhu liste malog bin-a 4, 코to je lokacija FD pokaziva캜a dela **`_IO_list_all`** jer smo napisali blisku adresu u **`_IO_list_all`** putem napada nesortiranog bin-a.
2. **Pokretanje Malloc Provere**: Ova manipulacija veli캜inom dela 캖e izazvati `malloc` da izvr코i interne provere. Kada proveri veli캜inu la쬹og naprednog dela, koja 캖e biti nula, izaziva gre코ku i poziva `malloc_printerr`.

Manipulacija malim bin-om 캖e vam omogu캖iti da kontroli코ete napredni pokaziva캜 dela. Preklapanje sa **\_IO\_list\_all** se koristi za falsifikovanje la쬹e **\_IO\_FILE** strukture. Struktura je pa쬷jivo oblikovana da uklju캜uje klju캜na polja kao 코to su `_IO_write_base` i `_IO_write_ptr` postavljena na vrednosti koje prolaze interne provere u libc. Pored toga, tabela skakanja se kreira unutar la쬹e strukture, gde je pokaziva캜 instrukcija postavljen na adresu gde se mo쬰 izvr코iti proizvoljan kod (npr. funkcija `system`).

Da rezimiramo preostali deo tehnike:

* **Smanjite Stari Gornji Deo**: Prilagodite veli캜inu starog gornjeg dela na **0x61** da bi stao u mali bin.
* **Postavite La쬹u `_IO_FILE` Strukturu**: Preklopite stari gornji deo sa la쬹om **\_IO\_FILE** strukturom i postavite polja odgovaraju캖e da preuzmete tok izvr코enja.

Slede캖i korak uklju캜uje falsifikovanje la쬹e **\_IO\_FILE** strukture koja se preklapa sa starim gornjim delom koji se trenutno nalazi u nesortiranom bin-u. Prvi bajtovi ove strukture su pa쬷jivo oblikovani da uklju캜uju pokaziva캜 na komandu (npr. "/bin/sh") koja 캖e biti izvr코ena.

Klju캜na polja u la쬹oj **\_IO\_FILE** strukturi, kao 코to su `_IO_write_base` i `_IO_write_ptr`, postavljena su na vrednosti koje prolaze interne provere u libc. Pored toga, tabela skakanja se kreira unutar la쬹e strukture, gde je pokaziva캜 instrukcija postavljen na adresu gde se mo쬰 izvr코iti proizvoljan kod. Obi캜no bi to bila adresa funkcije `system` ili druge funkcije koja mo쬰 izvr코iti shell komande.

Napad kulminira kada poziv `malloc` pokrene izvr코enje koda kroz manipuliranu **\_IO\_FILE** strukturu. Ovo efikasno omogu캖ava izvr코enje proizvoljnog koda, obi캜no rezultiraju캖i pokretanjem shel-a ili izvr코avanjem drugog zlonamernog tereta.

**Sa쬰tak Napada:**

1. **Postavite gornji deo**: Alocirajte deo i izmenite veli캜inu gornjeg dela.
2. **Primorajte gornji deo u nesortirani bin**: Alocirajte ve캖i deo.
3. **Leak-ujte libc adrese**: Iskoristite ranjivost da 캜itate iz nesortiranog bin-a.
4. **Izvr코ite napad nesortiranog bin-a**: Napi코ite u **\_IO\_list\_all** koriste캖i prelivanje.
5. **Smanjite stari gornji deo**: Prilagodite njegovu veli캜inu da stane u mali bin.
6. **Postavite la쬹u \_IO\_FILE strukturu**: Falsifikujte la쬹u strukturu datoteke da preuzmete tok kontrole.
7. **Pokrenite izvr코enje koda**: Alocirajte deo da izvr코ite napad i pokrenete proizvoljan kod.

Ovaj pristup koristi mehanizme upravljanja heap-om, leak-ove informacija iz libc, i prelivanja heap-a da bi postigao izvr코enje koda bez direktnog pozivanja `free`. Pa쬷jivim oblikovanjem la쬹e **\_IO\_FILE** strukture i njenim postavljanjem na pravo mesto, napad mo쬰 preuzeti tok kontrole tokom standardnih operacija alokacije memorije. Ovo omogu캖ava izvr코enje proizvoljnog koda, potencijalno rezultiraju캖i shell-om ili drugim zlonamernim aktivnostima.

## References

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
