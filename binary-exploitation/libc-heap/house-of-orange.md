# House of Orange

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

### Kod

* Bir Ã¶rneÄŸi [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c) adresinde bulabilirsiniz.
* SÃ¶mÃ¼rÃ¼ tekniÄŸi bu [yamanÄ±n](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) iÃ§inde dÃ¼zeltildi, bu nedenle artÄ±k Ã§alÄ±ÅŸmÄ±yor (2.26'dan Ã¶nce Ã§alÄ±ÅŸÄ±yordu).
* Daha fazla yorumla aynÄ± Ã¶rnek [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html) adresinde.

### Hedef

* `malloc_printerr` fonksiyonunu kÃ¶tÃ¼ye kullanmak.

### Gereksinimler

* Ãœst parÃ§a boyutunu geÃ§ersiz kÄ±lmak.
* Libc ve heap leak'leri.

### Arka Plan

[**Bu Ã¶rnekten**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)** bazÄ± gerekli arka plan:**

Esas mesele, eski libc sÃ¼rÃ¼mlerinde `malloc_printerr` fonksiyonu Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda, `_IO_list_all` iÃ§inde saklanan `_IO_FILE` yapÄ±larÄ±na ait bir liste Ã¼zerinden **dÃ¶ngÃ¼ye girmesi** ve aslÄ±nda o yapÄ±da bir talimat iÅŸaretÃ§isini **Ã§alÄ±ÅŸtÄ±rmasÄ±dÄ±r**.\
Bu saldÄ±rÄ±, **`_IO_list_all`**'a yazacaÄŸÄ±mÄ±z **sahte bir `_IO_FILE` yapÄ±sÄ±** oluÅŸturacaktÄ±r ve `malloc_printerr`'in Ã§alÄ±ÅŸmasÄ±na neden olacaktÄ±r.\
Sonra, **`_IO_FILE`** yapÄ±larÄ±na kaydettiÄŸimiz **herhangi bir adresi** Ã§alÄ±ÅŸtÄ±racaktÄ±r ve kod yÃ¼rÃ¼tmesi elde edeceÄŸiz.

### SaldÄ±rÄ±

SaldÄ±rÄ±, **sÄ±ralanmamÄ±ÅŸ kutu** iÃ§indeki **Ã¼st parÃ§ayÄ±** elde etmeyi baÅŸarmakla baÅŸlar. Bu, `malloc`'Ä± mevcut Ã¼st parÃ§a boyutundan daha bÃ¼yÃ¼k ama **`mmp_.mmap_threshold`**'dan (varsayÄ±lan 128K) daha kÃ¼Ã§Ã¼k bir boyutla Ã§aÄŸÄ±rarak elde edilir; aksi takdirde `mmap` tahsisi tetiklenecektir. Ãœst parÃ§a boyutu deÄŸiÅŸtirildiÄŸinde, **Ã¼st parÃ§a + boyut**'un sayfa hizalÄ± olduÄŸundan ve Ã¼st parÃ§anÄ±n **prev\_inuse** bitinin her zaman ayarlandÄ±ÄŸÄ±ndan emin olmak Ã¶nemlidir.

SÄ±ralanmamÄ±ÅŸ kutu iÃ§indeki Ã¼st parÃ§ayÄ± elde etmek iÃ§in, Ã¼st parÃ§ayÄ± oluÅŸturmak iÃ§in bir parÃ§a tahsis edin, Ã¼st parÃ§a boyutunu (tahsis edilen parÃ§ada bir taÅŸma ile) deÄŸiÅŸtirin, bÃ¶ylece **Ã¼st parÃ§a + boyut** sayfa hizalÄ± ve **prev\_inuse** bit ayarlanmÄ±ÅŸ olsun. Sonra, yeni Ã¼st parÃ§a boyutundan daha bÃ¼yÃ¼k bir parÃ§a tahsis edin. Ãœst parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ kutuya almak iÃ§in `free`'in asla Ã§aÄŸrÄ±lmadÄ±ÄŸÄ±nÄ± unutmayÄ±n.

Eski Ã¼st parÃ§a artÄ±k sÄ±ralanmamÄ±ÅŸ kutuda. Ä°Ã§inde veri okuyabiliyorsak (muhtemelen taÅŸmaya neden olan bir zafiyet nedeniyle), libc adreslerini sÄ±zdÄ±rmak ve **\_IO\_list\_all** adresini elde etmek mÃ¼mkÃ¼ndÃ¼r.

SÄ±ralanmamÄ±ÅŸ kutu saldÄ±rÄ±sÄ±, taÅŸmayÄ± kÃ¶tÃ¼ye kullanarak `topChunk->bk->fwd = _IO_list_all - 0x10` yazÄ±larak gerÃ§ekleÅŸtirilir. Yeni bir parÃ§a tahsis edildiÄŸinde, eski Ã¼st parÃ§a bÃ¶lÃ¼necek ve sÄ±ralanmamÄ±ÅŸ kutuya bir iÅŸaretÃ§i yazÄ±lacaktÄ±r.

Sonraki adÄ±m, eski Ã¼st parÃ§anÄ±n boyutunu kÃ¼Ã§Ã¼k bir kutuya sÄ±ÄŸacak ÅŸekilde kÃ¼Ã§Ã¼ltmektir; Ã¶zellikle boyutunu **0x61** olarak ayarlamaktÄ±r. Bu iki amaca hizmet eder:

1. **KÃ¼Ã§Ã¼k Kutular 4'e Ekleme**: `malloc` sÄ±ralanmamÄ±ÅŸ kutuyu taradÄ±ÄŸÄ±nda ve bu parÃ§ayÄ± gÃ¶rdÃ¼ÄŸÃ¼nde, kÃ¼Ã§Ã¼k boyutu nedeniyle onu kÃ¼Ã§Ã¼k kutu 4'e eklemeye Ã§alÄ±ÅŸacaktÄ±r. Bu, parÃ§anÄ±n, **`_IO_list_all`** parÃ§asÄ±nÄ±n FD iÅŸaretÃ§isinin bulunduÄŸu kÃ¼Ã§Ã¼k kutu 4 listesinin baÅŸÄ±na yerleÅŸmesine neden olur; Ã§Ã¼nkÃ¼ sÄ±ralanmamÄ±ÅŸ kutu saldÄ±rÄ±sÄ± yoluyla **`_IO_list_all`**'da yakÄ±n bir adres yazdÄ±k.
2. **Malloc KontrolÃ¼nÃ¼ Tetikleme**: Bu parÃ§a boyutu manipÃ¼lasyonu, `malloc`'Ä±n iÃ§ kontrolleri gerÃ§ekleÅŸtirmesine neden olacaktÄ±r. YanlÄ±ÅŸ ileri parÃ§a boyutunu kontrol ettiÄŸinde, bu sÄ±fÄ±r olacaÄŸÄ±ndan bir hata tetikler ve `malloc_printerr`'i Ã§aÄŸÄ±rÄ±r.

KÃ¼Ã§Ã¼k kutunun manipÃ¼lasyonu, parÃ§anÄ±n ileri iÅŸaretÃ§isini kontrol etmenizi saÄŸlar. **\_IO\_list\_all** ile olan Ã¶rtÃ¼ÅŸme, sahte bir **\_IO\_FILE** yapÄ±sÄ±nÄ± oluÅŸturmak iÃ§in kullanÄ±lÄ±r. YapÄ±, libc'deki iÃ§ kontrolleri geÃ§ecek ÅŸekilde `_IO_write_base` ve `_IO_write_ptr` gibi anahtar alanlarÄ± iÃ§erecek ÅŸekilde dikkatlice hazÄ±rlanÄ±r. AyrÄ±ca, sahte yapÄ±nÄ±n iÃ§inde, keyfi kodun (Ã¶rneÄŸin, `system` fonksiyonu) Ã§alÄ±ÅŸtÄ±rÄ±labileceÄŸi adrese ayarlanmÄ±ÅŸ bir talimat iÅŸaretÃ§isi bulunan bir atlama tablosu oluÅŸturulur.

TekniÄŸin kalan kÄ±smÄ±nÄ± Ã¶zetlemek gerekirse:

* **Eski Ãœst ParÃ§ayÄ± KÃ¼Ã§Ã¼ltÃ¼n**: Eski Ã¼st parÃ§anÄ±n boyutunu **0x61** olarak ayarlayÄ±n, bÃ¶ylece kÃ¼Ã§Ã¼k bir kutuya sÄ±ÄŸsÄ±n.
* **Sahte `_IO_FILE` YapÄ±sÄ±nÄ± Kurun**: Eski Ã¼st parÃ§ayÄ± sahte **\_IO\_FILE** yapÄ±sÄ±yla Ã¶rtÃ¼ÅŸtÃ¼rÃ¼n ve alanlarÄ± uygun ÅŸekilde ayarlayarak yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ± ele geÃ§irin.

Sonraki adÄ±m, sÄ±ralanmamÄ±ÅŸ kutuda bulunan eski Ã¼st parÃ§a ile Ã¶rtÃ¼ÅŸen sahte bir **\_IO\_FILE** yapÄ±sÄ± oluÅŸturmaktÄ±r. Bu yapÄ±nÄ±n ilk baytlarÄ±, Ã§alÄ±ÅŸtÄ±rÄ±lacak bir komuta (Ã¶rneÄŸin, "/bin/sh") iÅŸaret eden bir iÅŸaretÃ§i iÃ§erecek ÅŸekilde dikkatlice hazÄ±rlanÄ±r.

Sahte **\_IO\_FILE** yapÄ±sÄ±ndaki anahtar alanlar, libc'deki iÃ§ kontrolleri geÃ§ecek ÅŸekilde ayarlanÄ±r. AyrÄ±ca, sahte yapÄ±nÄ±n iÃ§inde, keyfi kodun Ã§alÄ±ÅŸtÄ±rÄ±labileceÄŸi adrese ayarlanmÄ±ÅŸ bir talimat iÅŸaretÃ§isi bulunan bir atlama tablosu oluÅŸturulur. Genellikle bu, `system` fonksiyonunun adresi veya shell komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rabilen baÅŸka bir fonksiyonun adresi olacaktÄ±r.

SaldÄ±rÄ±, `malloc` Ã§aÄŸrÄ±sÄ±nÄ±n manipÃ¼le edilmiÅŸ **\_IO\_FILE** yapÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla kodun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± tetiklemesiyle sonuÃ§lanÄ±r. Bu, genellikle bir shell'in baÅŸlatÄ±lmasÄ± veya baÅŸka bir kÃ¶tÃ¼ niyetli yÃ¼kÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±yla sonuÃ§lanan keyfi kod yÃ¼rÃ¼tmesine olanak tanÄ±r.

**SaldÄ±rÄ±nÄ±n Ã–zeti:**

1. **Ãœst parÃ§ayÄ± ayarlayÄ±n**: Bir parÃ§a tahsis edin ve Ã¼st parÃ§a boyutunu deÄŸiÅŸtirin.
2. **Ãœst parÃ§ayÄ± sÄ±ralanmamÄ±ÅŸ kutuya zorlayÄ±n**: Daha bÃ¼yÃ¼k bir parÃ§a tahsis edin.
3. **Libc adreslerini sÄ±zdÄ±rÄ±n**: Zafiyeti kullanarak sÄ±ralanmamÄ±ÅŸ kutudan okuyun.
4. **SÄ±ralanmamÄ±ÅŸ kutu saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirin**: TaÅŸma kullanarak **\_IO\_list\_all**'a yazÄ±n.
5. **Eski Ã¼st parÃ§ayÄ± kÃ¼Ã§Ã¼ltÃ¼n**: Boyutunu kÃ¼Ã§Ã¼k bir kutuya sÄ±ÄŸacak ÅŸekilde ayarlayÄ±n.
6. **Sahte \_IO\_FILE yapÄ±sÄ±nÄ± kurun**: Kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irmek iÃ§in sahte bir dosya yapÄ±sÄ± oluÅŸturun.
7. **Kod yÃ¼rÃ¼tmesini tetikleyin**: SaldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek ve keyfi kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in bir parÃ§a tahsis edin.

Bu yaklaÅŸÄ±m, heap yÃ¶netim mekanizmalarÄ±nÄ±, libc bilgi sÄ±zÄ±ntÄ±larÄ±nÄ± ve heap taÅŸmalarÄ±nÄ± kullanarak kod yÃ¼rÃ¼tmesini elde etmeyi amaÃ§lar. Sahte **\_IO\_FILE** yapÄ±sÄ±nÄ± dikkatlice oluÅŸturarak ve doÄŸru konuma yerleÅŸtirerek, saldÄ±rÄ± standart bellek tahsis iÅŸlemleri sÄ±rasÄ±nda kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irebilir. Bu, keyfi kodun yÃ¼rÃ¼tÃ¼lmesini saÄŸlar ve potansiyel olarak bir shell veya diÄŸer kÃ¶tÃ¼ niyetli faaliyetlerle sonuÃ§lanabilir.

## Referanslar

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
