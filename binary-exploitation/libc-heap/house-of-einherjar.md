# Casa de Einherjar

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos en** **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Informaci칩n B치sica

### C칩digo

* Revisa el ejemplo de [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* O el de [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (puede que necesites llenar el tcache)

### Objetivo

* El objetivo es asignar memoria en casi cualquier direcci칩n espec칤fica.

### Requisitos

* Crear un chunk falso cuando queramos asignar un chunk:
* Establecer punteros para que apunten a s칤 mismos para eludir las verificaciones de sanidad
* Desbordamiento de un byte con un byte nulo de un chunk al siguiente para modificar la bandera `PREV_INUSE`.
* Indicar en el `prev_size` del chunk abusado por el off-by-null la diferencia entre s칤 mismo y el chunk falso
* El tama침o del chunk falso tambi칠n debe haberse establecido al mismo tama침o para eludir las verificaciones de sanidad
* Para construir estos chunks, necesitar치s un leak de heap.

### Ataque

* Se crea un chunk `A` dentro de un chunk controlado por el atacante apuntando con `fd` y `bk` al chunk original para eludir las protecciones
* Se asignan 2 chunks m치s (`B` y `C`)
* Abusando del off by one en el `B`, se limpia el bit `prev in use` y los datos de `prev_size` se sobrescriben con la diferencia entre el lugar donde se asigna el chunk `C`, al chunk falso `A` generado antes
* Este `prev_size` y el tama침o en el chunk falso `A` deben ser los mismos para eludir las verificaciones.
* Luego, se llena el tcache
* Luego, se libera `C` para que se consolide con el chunk falso `A`
* Luego, se crea un nuevo chunk `D` que comenzar치 en el chunk falso `A` y cubrir치 el chunk `B`
* La casa de Einherjar termina aqu칤
* Esto se puede continuar con un ataque de fast bin o envenenamiento de Tcache:
* Libera `B` para agregarlo al fast bin / Tcache
* El `fd` de `B` se sobrescribe haci칠ndolo apuntar a la direcci칩n objetivo abusando del chunk `D` (ya que contiene `B` dentro)&#x20;
* Luego, se realizan 2 mallocs y el segundo va a **asignar la direcci칩n objetivo**

## Referencias y otros ejemplos

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Despu칠s de liberar punteros, no se nulifican, por lo que a칰n es posible acceder a sus datos. Por lo tanto, un chunk se coloca en el bin no ordenado y se filtran los punteros que contiene (leak de libc) y luego se coloca un nuevo heap en el bin no ordenado y se filtra una direcci칩n de heap del puntero que obtiene.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Error de desbordamiento de byte nulo en `strtok`.
* Usa la Casa de Einherjar para obtener una situaci칩n de chunks superpuestos y terminar con el envenenamiento de Tcache para obtener un primitivo de escritura arbitraria.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos en** **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
