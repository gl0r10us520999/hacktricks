# Dom Einherjar

{% hint style="success" %}
Ucz się i praktykuj Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Szkolenie AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz się i praktykuj Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Szkolenie GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wesprzyj HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
{% endhint %}

## Podstawowe informacje

### Kod

* Sprawdź przykład z [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Lub z [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (może być konieczne uzupełnienie tcache)

### Cel

* Celem jest alokacja pamięci praktycznie w dowolnym określonym adresie.

### Wymagania

* Utwórz fałszywy kawałek, gdy chcemy zaalokować kawałek:
* Ustaw wskaźniki tak, aby wskazywały na siebie same, aby ominąć kontrole spójności
* Przepełnij jeden bajt z bajtem null z jednego kawałka do następnego, aby zmodyfikować flagę `PREV_INUSE`.
* Wskaż w `prev_size` nadużywanego kawałka off-by-null różnicę między nim a fałszywym kawałkiem
* Rozmiar fałszywego kawałka musi również być ustawiony na ten sam rozmiar, aby ominąć kontrole spójności
* Do skonstruowania tych kawałków będziesz potrzebować wycieku sterty.

### Atak

* `A` fałszywy kawałek jest tworzony wewnątrz kawałka kontrolowanego przez atakującego, wskazując z `fd` i `bk` na oryginalny kawałek, aby ominąć zabezpieczenia
* Allokowane są 2 inne kawałki (`B` i `C`)
* Wykorzystując off by one w `B`, bit `prev in use` jest czyszczony, a dane `prev_size` są nadpisywane różnicą między miejscem, w którym jest allokowany kawałek `C`, a fałszywym kawałkiem `A` wygenerowanym wcześniej
* Ten `prev_size` i rozmiar w fałszywym kawałku `A` muszą być takie same, aby ominąć kontrole.
* Następnie wypełniany jest tcache
* Następnie, `C` jest zwalniane, aby skonsolidować się z fałszywym kawałkiem `A`
* Następnie tworzony jest nowy kawałek `D`, który będzie zaczynał się w fałszywym kawałku `A` i pokrywał kawałek `B`
* Dom Einherjar kończy się tutaj
* Można kontynuować to atakiem na fast bin lub zatruciem Tcache:
* Zwolnij `B`, aby dodać go do fast bin / Tcache
* Nadpisz `fd` `B`, aby wskazywał na docelowy adres nadużywając kawałka `D` (ponieważ zawiera w sobie `B`)&#x20;
* Następnie wykonuje się 2 alokacje pamięci i druga z nich będzie **alokować docelowy adres**

## Odwołania i inne przykłady

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Po zwolnieniu wskaźników nie są one zerowane, więc wciąż można uzyskać do nich dostęp. Dlatego kawałek jest umieszczany w nieuporządkowanym pojemniku i wyciekane są wskaźniki, które zawiera (wyciek libc), a następnie nowa sterta jest umieszczana w nieuporządkowanym pojemniku i wyciekany jest adres sterty z wskaźnika, który otrzymuje.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Błąd przepełnienia bajtem null w `strtok`.
* Użyj Domu Einherjar, aby uzyskać sytuację nakładających się kawałków i zakończ zatruciem Tcache, aby uzyskać arbitralne pisanie.
