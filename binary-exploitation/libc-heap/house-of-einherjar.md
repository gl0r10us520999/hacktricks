# House of Einherjar

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Podstawowe informacje

### Kod

* Sprawd藕 przykad z [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Lub ten z [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (mo偶esz potrzebowa wypeni tcache)

### Cel

* Celem jest przydzielenie pamici w prawie dowolnym konkretnym adresie.

### Wymagania

* Utw贸rz faszywy kawaek, gdy chcemy przydzieli kawaek:
* Ustaw wska藕niki, aby wskazyway na siebie, aby obej kontrole poprawnoci
* Przepenienie o jeden bajt z bajtem null z jednego kawaka do drugiego, aby zmodyfikowa flag `PREV_INUSE`.
* Wska藕 w `prev_size` faszywego kawaka, r贸偶nic midzy nim a faszywym kawakiem
* Rozmiar faszywego kawaka musi by r贸wnie偶 ustawiony na ten sam rozmiar, aby obej kontrole poprawnoci
* Do konstruowania tych kawak贸w bdziesz potrzebowa wycieku z sterty.

### Atak

* `A` faszywy kawaek jest tworzony wewntrz kawaka kontrolowanego przez atakujcego, wskazujc `fd` i `bk` na oryginalny kawaek, aby obej zabezpieczenia
* Przydzielane s 2 inne kawaki (`B` i `C`)
* Wykorzystujc bd o jeden w kawaku `B`, bit `prev in use` jest czyszczony, a dane `prev_size` s nadpisywane r贸偶nic midzy miejscem, w kt贸rym przydzielany jest kawaek `C`, a faszywym kawakiem `A` utworzonym wczeniej
* Ten `prev_size` i rozmiar w faszywym kawaku `A` musz by takie same, aby obej kontrole.
* Nastpnie, tcache jest wypeniane
* Nastpnie, `C` jest zwalniane, aby skonsolidowa si z faszywym kawakiem `A`
* Nastpnie tworzony jest nowy kawaek `D`, kt贸ry zacznie si w faszywym kawaku `A` i pokryje kawaek `B`
* Dom Einherjar koczy si tutaj
* To mo偶na kontynuowa atakiem na szybki bin lub zatruciem Tcache:
* Zwalniamy `B`, aby doda go do szybkiego bin / Tcache
* `fd` kawaka `B` jest nadpisywany, co sprawia, 偶e wskazuje na docelowy adres, wykorzystujc kawaek `D` (poniewa偶 zawiera `B` wewntrz)&#x20;
* Nastpnie wykonuje si 2 malloci, a drugi z nich bdzie **przydziela docelowy adres**

## Odniesienia i inne przykady

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Po zwolnieniu wska藕nik贸w nie s one ustawiane na null, wic nadal mo偶liwe jest uzyskanie dostpu do ich danych. Dlatego kawaek jest umieszczany w nieposortowanym binie i wycieka wska藕niki, kt贸re zawiera (wyciek libc), a nastpnie nowa sterta jest umieszczana w nieposortowanym binie i wycieka adres sterty z uzyskanego wska藕nika.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Bd przepenienia bajtu null w `strtok`.
* U偶yj House of Einherjar, aby uzyska sytuacj z nakadajcymi si kawakami i zakoczy zatruciem Tcache, aby uzyska dowolny zapis prymitywny.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
