# House of Einherjar

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Grundinformationen

### Code

* √úberpr√ºfe das Beispiel von [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Oder das von [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (du musst m√∂glicherweise den tcache f√ºllen)

### Ziel

* Das Ziel ist es, Speicher an fast jeder spezifischen Adresse zuzuweisen.

### Anforderungen

* Erstelle einen gef√§lschten Chunk, wenn wir einen Chunk zuweisen wollen:
* Setze Zeiger, um auf sich selbst zu zeigen, um Sanity-Checks zu umgehen
* Ein-Byte-√úberlauf mit einem Null-Byte von einem Chunk zum n√§chsten, um das `PREV_INUSE`-Flag zu modifizieren.
* Gib im `prev_size` des durch Null missbrauchten Chunks den Unterschied zwischen sich selbst und dem gef√§lschten Chunk an
* Die Gr√∂√üe des gef√§lschten Chunks muss ebenfalls auf die gleiche Gr√∂√üe gesetzt werden, um Sanity-Checks zu umgehen
* Um diese Chunks zu konstruieren, ben√∂tigst du einen Heap-Leak.

### Angriff

* Ein `A` gef√§lschter Chunk wird innerhalb eines vom Angreifer kontrollierten Chunks erstellt, der mit `fd` und `bk` auf den urspr√ºnglichen Chunk zeigt, um Schutzma√ünahmen zu umgehen
* 2 andere Chunks (`B` und `C`) werden zugewiesen
* Missbrauche den Off-by-One im `B`, um das `prev in use`-Bit zu l√∂schen und die `prev_size`-Daten mit dem Unterschied zwischen dem Ort, an dem der `C`-Chunk zugewiesen wird, und dem zuvor generierten gef√§lschten `A`-Chunk zu √ºberschreiben
* Diese `prev_size` und die Gr√∂√üe im gef√§lschten Chunk `A` m√ºssen gleich sein, um √úberpr√ºfungen zu umgehen.
* Dann wird der tcache gef√ºllt
* Dann wird `C` freigegeben, damit es sich mit dem gef√§lschten Chunk `A` konsolidiert
* Dann wird ein neuer Chunk `D` erstellt, der im gef√§lschten `A`-Chunk beginnt und den `B`-Chunk abdeckt
* Das Haus von Einherjar endet hier
* Dies kann mit einem Fast-Bin-Angriff oder Tcache-Poisoning fortgesetzt werden:
* Freigeben von `B`, um es zum Fast-Bin / Tcache hinzuzuf√ºgen
* `B`'s `fd` wird √ºberschrieben, sodass es auf die Zieladresse zeigt, indem der `D`-Chunk missbraucht wird (da er `B` enth√§lt)&#x20;
* Dann werden 2 Mallocs durchgef√ºhrt, und der zweite wird **die Zieladresse zuweisen**

## Referenzen und andere Beispiele

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Nach dem Freigeben von Zeigern werden diese nicht nullifiziert, sodass es weiterhin m√∂glich ist, auf ihre Daten zuzugreifen. Daher wird ein Chunk in den unsortierten Bin gelegt und die Zeiger, die er enth√§lt, werden geleakt (libc leak), und dann wird ein neuer Heap im unsortierten Bin platziert und eine Heap-Adresse von dem Zeiger, den er erh√§lt, geleakt.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Null-Byte-√úberlauf-Fehler in `strtok`.
* Verwende House of Einherjar, um eine √úberlappung von Chunks zu erreichen und mit Tcache-Poisoning zu enden, um eine willk√ºrliche Schreibprimitive zu erhalten.

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
