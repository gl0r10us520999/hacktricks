# House of Einherjar

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Osnovne informacije

### Kod

* Check the example from [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Or the one from [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (moÅ¾da Ä‡ete morati da popunite tcache)

### Cilj

* Cilj je alocirati memoriju na gotovo bilo kojoj specifiÄnoj adresi.

### Zahtevi

* Kreirati laÅ¾ni chunk kada Å¾elimo da alociramo chunk:
* Postaviti pokazivaÄe da upuÄ‡uju na sebe kako bi zaobiÅ¡li provere
* Prelivanje od jednog bajta sa nul bajtom iz jednog chunk-a u drugi kako bi se izmenila `PREV_INUSE` oznaka.
* NaznaÄiti u `prev_size` laÅ¾nog chunk-a razliku izmeÄ‘u njega i laÅ¾nog chunk-a
* VeliÄina laÅ¾nog chunk-a takoÄ‘e mora biti postavljena na istu veliÄinu kako bi se zaobiÅ¡le provere
* Za konstrukciju ovih chunk-ova, biÄ‡e vam potreban heap leak.

### Napad

* `A` laÅ¾ni chunk se kreira unutar chunk-a koji kontroliÅ¡e napadaÄ, upuÄ‡ujuÄ‡i sa `fd` i `bk` na originalni chunk kako bi se zaobiÅ¡le zaÅ¡tite
* Alociraju se joÅ¡ 2 chunk-a (`B` i `C`)
* ZloupotrebljavajuÄ‡i prelivanje od jedan u `B`, `prev in use` bit se Äisti i `prev_size` podaci se prepisuju sa razlikom izmeÄ‘u mesta gde je alociran `C` chunk, do laÅ¾nog `A` chunk-a generisanog pre
* Ova `prev_size` i veliÄina u laÅ¾nom chunk-u `A` moraju biti iste kako bi se zaobiÅ¡le provere.
* Zatim, tcache se puni
* Zatim, `C` se oslobaÄ‘a kako bi se konsolidovao sa laÅ¾nim chunk-om `A`
* Zatim, kreira se novi chunk `D` koji Ä‡e poÄeti u laÅ¾nom `A` chunk-u i pokrivati `B` chunk
* KuÄ‡a Einherjar se ovde zavrÅ¡ava
* Ovo se moÅ¾e nastaviti brzim bin napadom ili Tcache trovanjem:
* Oslobodite `B` da ga dodate u brzi bin / Tcache
* `B`'s `fd` se prepisuje tako da pokazuje na ciljnu adresu zloupotrebljavajuÄ‡i `D` chunk (poÅ¡to sadrÅ¾i `B` unutar)&#x20;
* Zatim, vrÅ¡e se 2 malloc-a i drugi Ä‡e biti **alociranje ciljne adrese**

## Reference i drugi primeri

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Nakon oslobaÄ‘anja pokazivaÄa, oni nisu postavljeni na null, tako da je joÅ¡ uvek moguÄ‡e pristupiti njihovim podacima. Stoga se chunk postavlja u nesortirani bin i curi pokazivaÄe koje sadrÅ¾i (libc leak) i zatim se novi heap postavlja na nesortirani bin i curi adresu heap-a iz pokazivaÄa koji dobija.
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* Null-byte prelivanje greÅ¡ka u `strtok`.
* Koristite House of Einherjar da dobijete situaciju preklapanja chunk-ova i zavrÅ¡ite sa Tcache trovanjem kako biste dobili proizvoljnu write primitivu.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
