# House of Einherjar

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}

## 基本情報

### コード

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)の例を確認してください。
* または[https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation)のもの（tcacheを埋める必要があるかもしれません）

### 目標

* ほぼ任意の特定のアドレスにメモリを割り当てることが目標です。

### 要件

* チャンクを割り当てたいときにフェイクチャンクを作成すること：
* サニティチェックを回避するためにポインタを自分自身を指すように設定する
* 1バイトのオーバーフローを使用して、1つのチャンクから次のチャンクにヌルバイトを渡し、`PREV_INUSE`フラグを変更する。
* ヌルオフバイの悪用されたチャンクの`prev_size`に、フェイクチャンクとの違いを示す
* フェイクチャンクのサイズもサニティチェックを回避するために同じサイズに設定されている必要があります
* これらのチャンクを構築するには、ヒープリークが必要です。

### 攻撃

* 攻撃者が制御するチャンク内に`A`フェイクチャンクが作成され、`fd`と`bk`が元のチャンクを指すように設定されて保護を回避します
* 2つの他のチャンク（`B`と`C`）が割り当てられます
* `B`のオフバイワンを悪用して`prev in use`ビットがクリアされ、`prev_size`データが`C`チャンクが割り当てられる場所と、前に生成されたフェイク`A`チャンクとの違いで上書きされます
* この`prev_size`とフェイクチャンク`A`のサイズは、チェックを回避するために同じでなければなりません。
* 次に、tcacheが埋められます
* 次に、`C`が解放され、フェイクチャンク`A`と統合されます
* 次に、新しいチャンク`D`が作成され、フェイク`A`チャンクから始まり、`B`チャンクを覆います
* エインヘルヤルの家はここで終了します
* これは、ファストビン攻撃またはTcacheポイズニングで続けることができます：
* `B`を解放してファストビン/Tcacheに追加します
* `B`の`fd`が上書きされ、ターゲットアドレスを指すようにし、`D`チャンクを悪用します（`B`が内部に含まれているため）
* 次に、2つのmallocが行われ、2つ目は**ターゲットアドレスを割り当てることになります**

## 参考文献と他の例

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* **CTF** [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* ポインタを解放した後、それらはヌル化されないため、データにアクセスすることがまだ可能です。したがって、チャンクが未ソートビンに配置され、その中に含まれるポインタをリークし（libc leak）、次に新しいヒープが未ソートビンに配置され、取得したポインタからヒープアドレスをリークします。
* [**baby-talk. DiceCTF 2024**](https://7rocky.github.io/en/ctf/other/dicectf/baby-talk/)
* `strtok`のヌルバイトオーバーフローバグ。
* エインヘルヤルの家を使用してオーバーラッピングチャンクの状況を取得し、Tcacheポイズニングで任意の書き込みプリミティブを取得します。

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}
