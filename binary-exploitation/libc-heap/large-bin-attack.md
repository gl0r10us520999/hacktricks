# Large Bin Attack

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Basic Information

Para mais informa√ß√µes sobre o que √© um large bin, confira esta p√°gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

√â poss√≠vel encontrar um √≥timo exemplo em [**how2heap - large bin attack**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c).

Basicamente, aqui voc√™ pode ver como, na vers√£o "atual" mais recente do glibc (2.35), n√£o √© verificado: **`P->bk_nextsize`** permitindo modificar um endere√ßo arbitr√°rio com o valor de um chunk de large bin se certas condi√ß√µes forem atendidas.

Nesse exemplo, voc√™ pode encontrar as seguintes condi√ß√µes:

* Um chunk grande √© alocado
* Um chunk grande menor que o primeiro, mas no mesmo √≠ndice, √© alocado
* Deve ser menor, ent√£o no bin deve ir primeiro
* (Um chunk para evitar a fus√£o com o chunk superior √© criado)
* Ent√£o, o primeiro chunk grande √© liberado e um novo chunk maior que ele √© alocado -> Chunk1 vai para o large bin
* Ent√£o, o segundo chunk grande √© liberado
* Agora, a vulnerabilidade: O atacante pode modificar `chunk1->bk_nextsize` para `[target-0x20]`
* Ent√£o, um chunk maior que o chunk 2 √© alocado, assim o chunk2 √© inserido no large bin sobrescrevendo o endere√ßo `chunk1->bk_nextsize->fd_nextsize` com o endere√ßo do chunk2

{% hint style="success" %}
Existem outros cen√°rios potenciais, a quest√£o √© adicionar ao large bin um chunk que seja **menor** que um chunk X atual no bin, ent√£o ele precisa ser inserido logo antes dele no bin, e precisamos ser capazes de modificar o **`bk_nextsize`** de X, pois √© l√° que o endere√ßo do chunk menor ser√° escrito.
{% endhint %}

Este √© o c√≥digo relevante do malloc. Coment√°rios foram adicionados para entender melhor como o endere√ßo foi sobrescrito:

{% code overflow="wrap" %}
```c
/* if smaller than smallest, bypass loop below */
assert (chunk_main_arena (bck->bk));
if ((unsigned long) (size) < (unsigned long) chunksize_nomask (bck->bk))
{
fwd = bck; // fwd = p1
bck = bck->bk; // bck = p1->bk

victim->fd_nextsize = fwd->fd; // p2->fd_nextsize = p1->fd (Note that p1->fd is p1 as it's the only chunk)
victim->bk_nextsize = fwd->fd->bk_nextsize; // p2->bk_nextsize = p1->fd->bk_nextsize
fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim; // p1->fd->bk_nextsize->fd_nextsize = p2
}
```
{% endcode %}

Isso pode ser usado para **sobrescrever a vari√°vel global `global_max_fast`** da libc para ent√£o explorar um ataque de fast bin com chunks maiores.

Voc√™ pode encontrar outra √≥tima explica√ß√£o desse ataque em [**guyinatuxedo**](https://guyinatuxedo.github.io/32-largebin\_attack/largebin\_explanation0/index.html).

### Outros exemplos

* [**La casa de papel. HackOn CTF 2024**](https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/)
* Ataque de large bin na mesma situa√ß√£o em que aparece em [**how2heap**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c).
* A primitiva de escrita √© mais complexa, porque `global_max_fast` √© in√∫til aqui.
* FSOP √© necess√°rio para finalizar a explora√ß√£o.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
