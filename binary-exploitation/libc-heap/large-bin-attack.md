# Large Bin Attack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

For more information about what is a large bin check this page:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

It's possible to find a great example in [**how2heap - large bin attack**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c).

Basically here you can see how, in the latest "current" version of glibc (2.35), it's not checked: **`P->bk_nextsize`** allowing to modify an arbitrary address with the value of a large bin chunk if certain conditions are met.

In that example you can find the following conditions:

* ‡§è‡§ï ‡§¨‡§°‡§º‡§æ ‡§ö‡§Ç‡§ï ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
* ‡§è‡§ï ‡§¨‡§°‡§º‡§æ ‡§ö‡§Ç‡§ï ‡§ú‡•ã ‡§™‡§π‡§≤‡•á ‡§µ‡§æ‡§≤‡•á ‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§â‡§∏‡•Ä ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§π‡•à, ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
* ‡§á‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡§æ‡§ï‡§ø ‡§Ø‡§π ‡§¨‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§™‡§π‡§≤‡•á ‡§Ü ‡§∏‡§ï‡•á
* (‡§è‡§ï ‡§ö‡§Ç‡§ï ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§ö‡§Ç‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§µ‡§ø‡§≤‡§Ø ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á)
* ‡§´‡§ø‡§∞, ‡§™‡§π‡§≤‡•á ‡§¨‡§°‡§º‡•á ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ö‡§Ç‡§ï ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à -> Chunk1 ‡§¨‡§°‡§º‡•á ‡§¨‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
* ‡§´‡§ø‡§∞, ‡§¶‡•Ç‡§∏‡§∞‡•á ‡§¨‡§°‡§º‡•á ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
* ‡§Ö‡§¨, ‡§≠‡•á‡§¶‡•ç‡§Ø‡§§‡§æ: ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ `chunk1->bk_nextsize` ‡§ï‡•ã `[target-0x20]` ‡§Æ‡•á‡§Ç ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à
* ‡§´‡§ø‡§∞, ‡§ö‡§Ç‡§ï 2 ‡§∏‡•á ‡§¨‡§°‡§º‡§æ ‡§è‡§ï ‡§ö‡§Ç‡§ï ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§ö‡§Ç‡§ï2 ‡§¨‡§°‡§º‡•á ‡§¨‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ú‡•ã `chunk1->bk_nextsize->fd_nextsize` ‡§ï‡•á ‡§™‡§§‡•á ‡§ï‡•ã ‡§ö‡§Ç‡§ï2 ‡§ï‡•á ‡§™‡§§‡•á ‡§∏‡•á ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à

{% hint style="success" %}
There are other potential scenarios, the thing is to add to the large bin a chunk that is **smaller** than a current X chunk in the bin, so it need to be inserted just before it in the bin, and we need to be able to modify X's **`bk_nextsize`** as thats where the address of the smaller chunk will be written to.
{% endhint %}

This is the relevant code from malloc. Comments have been added to understand better how the address was overwritten:

{% code overflow="wrap" %}
```c
/* if smaller than smallest, bypass loop below */
assert (chunk_main_arena (bck->bk));
if ((unsigned long) (size) < (unsigned long) chunksize_nomask (bck->bk))
{
fwd = bck; // fwd = p1
bck = bck->bk; // bck = p1->bk

victim->fd_nextsize = fwd->fd; // p2->fd_nextsize = p1->fd (Note that p1->fd is p1 as it's the only chunk)
victim->bk_nextsize = fwd->fd->bk_nextsize; // p2->bk_nextsize = p1->fd->bk_nextsize
fwd->fd->bk_nextsize = victim->bk_nextsize->fd_nextsize = victim; // p1->fd->bk_nextsize->fd_nextsize = p2
}
```
{% endcode %}

‡§Ø‡§π **libc ‡§ï‡•á `global_max_fast` ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§ö‡§∞ ‡§ï‡•ã ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡§®‡•á** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§¨‡§°‡§º‡•á ‡§ü‡•Å‡§ï‡§°‡§º‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§§‡•á‡§ú‡§º ‡§¨‡§ø‡§® ‡§π‡§Æ‡§≤‡•á ‡§ï‡§æ ‡§∂‡•ã‡§∑‡§£ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§

‡§Ü‡§™ ‡§á‡§∏ ‡§π‡§Æ‡§≤‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ [**guyinatuxedo**](https://guyinatuxedo.github.io/32-largebin\_attack/largebin\_explanation0/index.html) ‡§Æ‡•á‡§Ç ‡§™‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

### ‡§Ö‡§®‡•ç‡§Ø ‡§â‡§¶‡§æ‡§π‡§∞‡§£

* [**La casa de papel. HackOn CTF 2024**](https://7rocky.github.io/en/ctf/other/hackon-ctf/la-casa-de-papel/)
* ‡§â‡§∏‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§¨‡§°‡§º‡•á ‡§¨‡§ø‡§® ‡§π‡§Æ‡§≤‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç [**how2heap**](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/large\_bin\_attack.c) ‡§Æ‡•á‡§Ç‡•§
* ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§æ‡§á‡§Æ‡§ø‡§ü‡§ø‡§µ ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§ü‡§ø‡§≤ ‡§π‡•à, ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø `global_max_fast` ‡§Ø‡§π‡§æ‡§Å ‡§¨‡•á‡§ï‡§æ‡§∞ ‡§π‡•à‡•§
* ‡§∂‡•ã‡§∑‡§£ ‡§ï‡•ã ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è FSOP ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡•á‡§Ç!
* **üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§**

</details>
{% endhint %}
