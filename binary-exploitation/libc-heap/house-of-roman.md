# Maison de Roman

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Il s'agissait d'une technique tr√®s int√©ressante qui permettait une ex√©cution de code √† distance sans fuites via de faux fastbins, l'attaque unsorted\_bin et des √©crasements relatifs. Cependant, elle a √©t√© [**corrig√©e**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Code

* Vous pouvez trouver un exemple sur [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Objectif

* Ex√©cution de code √† distance en abusant des pointeurs relatifs

### Exigences

* Modifier les pointeurs fastbin et unsorted bin
* 12 bits de hasard doivent √™tre forc√©s (chance de 0,02 %) de fonctionner

## √âtapes de l'attaque

### Partie 1 : Le chunk Fastbin pointe vers \_\_malloc\_hook

Cr√©ez plusieurs chunks :

* `fastbin_victim` (0x60, d√©calage 0) : Chunk UAF pour √©diter plus tard le pointeur du tas pour pointer vers la valeur LibC.
* `chunk2` (0x80, d√©calage 0x70) : Pour un bon alignement
* `main_arena_use` (0x80, d√©calage 0x100)
* `relative_offset_heap` (0x60, d√©calage 0x190) : d√©calage relatif sur le chunk 'main\_arena\_use'

Ensuite, `free(main_arena_use)` placera ce chunk dans la liste non tri√©e et obtiendra un pointeur vers `main_arena + 0x68` dans les pointeurs `fd` et `bk`.

Maintenant, allouez un nouveau chunk `fake_libc_chunk(0x60)` car il contiendra les pointeurs vers `main_arena + 0x68` dans `fd` et `bk`.

Ensuite, `relative_offset_heap` et `fastbin_victim` sont lib√©r√©s.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` a un `fd` pointant vers `relative_offset_heap`
* &#x20;`relative_offset_heap` est un d√©calage de distance depuis `fake_libc_chunk`, qui contient un pointeur vers `main_arena + 0x68`
* En changeant simplement le dernier octet de `fastbin_victim.fd`, il est possible de faire en sorte que `fastbin_victim pointe` vers `main_arena + 0x68`

Pour les actions pr√©c√©dentes, l'attaquant doit √™tre capable de modifier le pointeur fd de `fastbin_victim`.

Ensuite, `main_arena + 0x68` n'est pas si int√©ressant, alors modifions-le pour que le pointeur pointe vers **`__malloc_hook`**.

Notez que `__memalign_hook` commence g√©n√©ralement par `0x7f` et des z√©ros avant, il est donc possible de le falsifier en tant que valeur dans le fast bin `0x70`. Comme les 4 derniers bits de l'adresse sont **al√©atoires**, il y a `2^4=16` possibilit√©s pour que la valeur finisse par pointer l√† o√π nous sommes int√©ress√©s. Une attaque BF est donc effectu√©e ici pour que le chunk se termine comme suit: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Pour plus d'informations sur le reste des octets, consultez l'explication dans l'[exemple how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). Si le BF ne fonctionne pas, le programme plante simplement (donc recommencez jusqu'√† ce que cela fonctionne).

Ensuite, 2 mallocs sont effectu√©s pour supprimer les 2 chunks fast bin initiaux et un troisi√®me est allou√© pour obtenir un chunk dans le **`__malloc_hook:`**
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Partie 2 : Attaque unsorted\_bin

Pour plus d'informations, vous pouvez consulter :

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Mais en gros, cela permet d'√©crire `main_arena + 0x68` √† n'importe quel emplacement sp√©cifi√© dans `chunk->bk`. Et pour l'attaque, nous choisissons `__malloc_hook`. Ensuite, apr√®s l'avoir √©cras√©, nous utiliserons un √©crasement relatif pour pointer vers un `one_gadget`.

Pour cela, nous commen√ßons par obtenir un chunk et le placer dans le **unsorted bin** :
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Utilisez un UAF dans ce chunk pour pointer `unsorted_bin_ptr->bk` vers l'adresse de `__malloc_hook` (nous l'avons d√©j√† bruteforc√©e auparavant).

{% hint style="danger" %}
Notez que cette attaque corrompt le unsorted bin (donc aussi small et large). Nous ne pouvons donc **utiliser que des allocations du fast bin maintenant** (un programme plus complexe pourrait effectuer d'autres allocations et planter), et pour d√©clencher cela, nous devons **allouer la m√™me taille ou le programme plantera.**
{% endhint %}

Ainsi, pour d√©clencher l'√©criture de `main_arena + 0x68` dans `__malloc_hook`, nous devons simplement faire : **`malloc(0x80)`**

### √âtape 3 : D√©finir \_\_malloc\_hook sur system

√Ä l'√©tape un, nous avons fini par contr√¥ler un chunk contenant `__malloc_hook` (dans la variable `malloc_hook_chunk`) et √† la deuxi√®me √©tape, nous avons r√©ussi √† √©crire `main_arena + 0x68` ici.

Maintenant, nous exploitons une √©criture partielle dans `malloc_hook_chunk` pour utiliser l'adresse libc que nous avons √©crite l√† (`main_arena + 0x68`) pour **pointer vers une adresse `one_gadget`**.

C'est ici qu'il est n√©cessaire de **bruteforcer 12 bits de hasard** (plus d'informations dans l'[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ exemple](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Enfin, une fois que l'adresse correcte est √©cras√©e, **appelez `malloc` et d√©clenchez le `one_gadget`**.

## R√©f√©rences

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
