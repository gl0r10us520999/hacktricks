# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì´ê²ƒì€ ê°€ì§œ íŒ¨ìŠ¤íŠ¸ë¹ˆì„ í†µí•œ RCEë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ë§¤ìš° í¥ë¯¸ë¡œìš´ ê¸°ìˆ ì´ì—ˆìœ¼ë©°, unsorted_bin ê³µê²©ê³¼ ìƒëŒ€ì  ì˜¤ë²„ë¼ì´íŠ¸ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ëŠ” [**íŒ¨ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Code

* ì˜ˆì œëŠ” [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Goal

* ìƒëŒ€ í¬ì¸í„°ë¥¼ ì•…ìš©í•˜ì—¬ RCE

### Requirements

* íŒ¨ìŠ¤íŠ¸ë¹ˆ ë° unsorted bin í¬ì¸í„° í¸ì§‘
* 12ë¹„íŠ¸ì˜ ë¬´ì‘ìœ„ì„±ì´ ê°•ì œë¡œ ì‹œë„ë˜ì–´ì•¼ í•¨ (ì‘ë™ í™•ë¥  0.02%)

## Attack Steps

### Part 1: Fastbin Chunk points to \_\_malloc\_hook

ì—¬ëŸ¬ ê°œì˜ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:

* `fastbin_victim` (0x60, offset 0): ë‚˜ì¤‘ì— í™ í¬ì¸í„°ë¥¼ LibC ê°’ìœ¼ë¡œ ê°€ë¦¬í‚¤ë„ë¡ í¸ì§‘í•  UAF ì²­í¬.
* `chunk2` (0x80, offset 0x70): ì¢‹ì€ ì •ë ¬ì„ ìœ„í•´
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): 'main_arena_use' ì²­í¬ì˜ ìƒëŒ€ ì˜¤í”„ì…‹

ê·¸ëŸ° ë‹¤ìŒ `free(main_arena_use)`ë¥¼ í˜¸ì¶œí•˜ë©´ ì´ ì²­í¬ê°€ unsorted ë¦¬ìŠ¤íŠ¸ì— ë°°ì¹˜ë˜ê³  `fd` ë° `bk` í¬ì¸í„° ëª¨ë‘ì—ì„œ `main_arena + 0x68`ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ì–»ê²Œ ë©ë‹ˆë‹¤.

ì´ì œ `fake_libc_chunk(0x60)`ë¼ëŠ” ìƒˆë¡œìš´ ì²­í¬ê°€ í• ë‹¹ë˜ë©°, ì´ëŠ” `fd` ë° `bk`ì—ì„œ `main_arena + 0x68`ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ í¬í•¨í•˜ê²Œ ë©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ `relative_offset_heap`ê³¼ `fastbin_victim`ì´ í•´ì œë©ë‹ˆë‹¤.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`ì€ `relative_offset_heap`ì„ ê°€ë¦¬í‚¤ëŠ” `fd`ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
* &#x20;`relative_offset_heap`ì€ `fake_libc_chunk`ë¡œë¶€í„°ì˜ ê±°ë¦¬ ì˜¤í”„ì…‹ìœ¼ë¡œ, ì—¬ê¸°ì—ëŠ” `main_arena + 0x68`ì— ëŒ€í•œ í¬ì¸í„°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
* `fastbin_victim.fd`ì˜ ë§ˆì§€ë§‰ ë°”ì´íŠ¸ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ `fastbin_victim`ì´ `main_arena + 0x68`ì„ ê°€ë¦¬í‚¤ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ ì‘ì—…ì„ ìœ„í•´ ê³µê²©ìëŠ” `fastbin_victim`ì˜ fd í¬ì¸í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, `main_arena + 0x68`ì€ ê·¸ë¦¬ í¥ë¯¸ë¡­ì§€ ì•Šìœ¼ë¯€ë¡œ í¬ì¸í„°ë¥¼ **`__malloc_hook`**ì„ ê°€ë¦¬í‚¤ë„ë¡ ìˆ˜ì •í•©ì‹œë‹¤.

`__memalign_hook`ì€ ì¼ë°˜ì ìœ¼ë¡œ `0x7f`ë¡œ ì‹œì‘í•˜ê³  ê·¸ ì•ì— 0ì´ ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ `0x70` íŒ¨ìŠ¤íŠ¸ ë¹ˆì˜ ê°’ìœ¼ë¡œ ìœ„ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ì†Œì˜ ë§ˆì§€ë§‰ 4ë¹„íŠ¸ëŠ” **ë¬´ì‘ìœ„**ì´ë¯€ë¡œ, ìš°ë¦¬ê°€ ê´€ì‹¬ ìˆëŠ” ê³³ì„ ê°€ë¦¬í‚¤ë„ë¡ ê°’ì´ ëë‚˜ëŠ” ê²½ìš°ì˜ ìˆ˜ëŠ” `2^4=16`ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ì—¬ê¸°ì„œ BF ê³µê²©ì´ ìˆ˜í–‰ë˜ì–´ ì²­í¬ê°€ ë‹¤ìŒê³¼ ê°™ì´ ëë‚©ë‹ˆë‹¤: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**.

(ë‚˜ë¨¸ì§€ ë°”ì´íŠ¸ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ì˜ˆì œ](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì—ì„œ ì„¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”). BFê°€ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì´ ê·¸ëƒ¥ ì¶©ëŒí•˜ë¯€ë¡œ (ì‘ë™í•  ë•Œê¹Œì§€ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”).

ê·¸ëŸ° ë‹¤ìŒ, 2ê°œì˜ mallocì´ ìˆ˜í–‰ë˜ì–´ 2ê°œì˜ ì´ˆê¸° íŒ¨ìŠ¤íŠ¸ ë¹ˆ ì²­í¬ê°€ ì œê±°ë˜ê³ , ì„¸ ë²ˆì§¸ mallocì´ í• ë‹¹ë˜ì–´ **`__malloc_hook:`**ì—ì„œ ì²­í¬ë¥¼ ì–»ìŠµë‹ˆë‹¤.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Part 2: Unsorted\_bin ê³µê²©

ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

ê¸°ë³¸ì ìœ¼ë¡œ ì´ëŠ” `chunk->bk`ì— ì§€ì •ëœ ìœ„ì¹˜ì— `main_arena + 0x68`ì„ ì“¸ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ê³µê²©ì„ ìœ„í•´ `__malloc_hook`ì„ ì„ íƒí•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, ì´ë¥¼ ë®ì–´ì“´ í›„ ìƒëŒ€ì  ë®ì–´ì“°ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ `one_gadget`ì„ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ ìš°ë¦¬ëŠ” ì²­í¬ë¥¼ ê°€ì ¸ì™€ **unsorted bin**ì— ë„£ê¸° ì‹œì‘í•©ë‹ˆë‹¤:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
ì´ ì²­í¬ì—ì„œ UAFë¥¼ ì‚¬ìš©í•˜ì—¬ `unsorted_bin_ptr->bk`ë¥¼ `__malloc_hook`ì˜ ì£¼ì†Œë¡œ ê°€ë¦¬í‚¤ê²Œ í•©ë‹ˆë‹¤ (ìš°ë¦¬ëŠ” ì´ì „ì— ì´ë¥¼ ë¬´ì‘ìœ„ë¡œ ì‹œë„í–ˆìŠµë‹ˆë‹¤).

{% hint style="danger" %}
ì´ ê³µê²©ì€ ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆì„ ì†ìƒì‹œí‚µë‹ˆë‹¤ (ë”°ë¼ì„œ ì‘ì€ ê²ƒê³¼ í° ê²ƒë„ ë§ˆì°¬ê°€ì§€ì…ë‹ˆë‹¤). ë”°ë¼ì„œ ì´ì œ **ë¹ ë¥¸ ë¹ˆì—ì„œ í• ë‹¹ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** (ë” ë³µì¡í•œ í”„ë¡œê·¸ë¨ì€ ë‹¤ë¥¸ í• ë‹¹ì„ ìˆ˜í–‰í•˜ê³  ì¶©ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤), ì´ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ì„œëŠ” **ê°™ì€ í¬ê¸°ë¡œ í• ë‹¹í•´ì•¼ í•˜ë©°, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì´ ì¶©ëŒí•©ë‹ˆë‹¤.**
{% endhint %}

ë”°ë¼ì„œ `__malloc_hook`ì— `main_arena + 0x68`ì˜ ì“°ê¸°ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•´ `unsorted_bin_ptr->bk`ì— `__malloc_hook`ì„ ì„¤ì •í•œ í›„, ìš°ë¦¬ëŠ” ë‹¨ìˆœíˆ **`malloc(0x80)`**ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

### 3ë‹¨ê³„: \_\_malloc\_hookë¥¼ systemìœ¼ë¡œ ì„¤ì •

1ë‹¨ê³„ì—ì„œ ìš°ë¦¬ëŠ” `__malloc_hook`ë¥¼ í¬í•¨í•˜ëŠ” ì²­í¬ë¥¼ ì œì–´í•˜ê²Œ ë˜ì—ˆê³  (ë³€ìˆ˜ `malloc_hook_chunk`ì—ì„œ) 2ë‹¨ê³„ì—ì„œëŠ” ì—¬ê¸°ì—ì„œ `main_arena + 0x68`ì„ ì“¸ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ì´ì œ ìš°ë¦¬ëŠ” `malloc_hook_chunk`ì—ì„œ ë¶€ë¶„ ë®ì–´ì“°ê¸°ë¥¼ ì•…ìš©í•˜ì—¬ ìš°ë¦¬ê°€ ì“´ libc ì£¼ì†Œ(`main_arena + 0x68`)ë¥¼ **`one_gadget` ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ** í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ **12ë¹„íŠ¸ì˜ ë¬´ì‘ìœ„ì„±ì„ ë¬´ì‘ìœ„ë¡œ ì‹œë„í•´ì•¼** í•©ë‹ˆë‹¤ (ìì„¸í•œ ì •ë³´ëŠ” [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ì˜ˆì œ](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

ë§ˆì§€ë§‰ìœ¼ë¡œ, ì˜¬ë°”ë¥¸ ì£¼ì†Œê°€ ë®ì–´ì“°ì—¬ì§€ë©´, **`malloc`ì„ í˜¸ì¶œí•˜ê³  `one_gadget`ì„ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.**

## References

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter**ì—ì„œ **íŒ”ë¡œìš°**í•˜ì„¸ìš”** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
