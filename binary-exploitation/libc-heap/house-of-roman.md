# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Dies war eine sehr interessante Technik, die RCE ohne leaks √ºber gef√§lschte Fastbins, den unsorted\_bin-Angriff und relative √úberschreibungen erm√∂glichte. Es wurde jedoch [**gepatcht**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Code

* Sie k√∂nnen ein Beispiel unter [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) finden.

### Ziel

* RCE durch Missbrauch relativer Zeiger

### Anforderungen

* Bearbeiten Sie die Zeiger f√ºr Fastbin und unsorted bin
* 12 Bits Zuf√§lligkeit m√ºssen brute-forced werden (0,02% Chance), um zu funktionieren

## Angriffsschritte

### Teil 1: Fastbin Chunk zeigt auf \_\_malloc\_hook

Erstellen Sie mehrere Chunks:

* `fastbin_victim` (0x60, Offset 0): UAF-Chunk, um sp√§ter den Heap-Zeiger zu bearbeiten, um auf den LibC-Wert zu zeigen.
* `chunk2` (0x80, Offset 0x70): F√ºr gute Ausrichtung
* `main_arena_use` (0x80, Offset 0x100)
* `relative_offset_heap` (0x60, Offset 0x190): relativer Offset auf den 'main\_arena\_use'-Chunk

Dann `free(main_arena_use)`, was diesen Chunk in die unsorted-Liste platziert und einen Zeiger auf `main_arena + 0x68` in beiden `fd`- und `bk`-Zeigern erh√§lt.

Jetzt wird ein neuer Chunk `fake_libc_chunk(0x60)` zugewiesen, da er die Zeiger auf `main_arena + 0x68` in `fd` und `bk` enthalten wird.

Dann werden `relative_offset_heap` und `fastbin_victim` freigegeben.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` hat einen `fd`, der auf `relative_offset_heap` zeigt
* &#x20;`relative_offset_heap` ist ein Offset von der Distanz zu `fake_libc_chunk`, das einen Zeiger auf `main_arena + 0x68` enth√§lt
* Durch das √Ñndern des letzten Bytes von `fastbin_victim.fd` ist es m√∂glich, dass `fastbin_victim` auf `main_arena + 0x68` zeigt

F√ºr die vorherigen Aktionen muss der Angreifer in der Lage sein, den fd-Zeiger von `fastbin_victim` zu modifizieren.

Dann ist `main_arena + 0x68` nicht so interessant, also lassen Sie es uns √§ndern, damit der Zeiger auf **`__malloc_hook`** zeigt.

Beachten Sie, dass `__memalign_hook` normalerweise mit `0x7f` beginnt und davor Nullen hat, dann ist es m√∂glich, es als einen Wert im `0x70` Fast Bin zu f√§lschen. Da die letzten 4 Bits der Adresse **zuf√§llig** sind, gibt es `2^4=16` M√∂glichkeiten, dass der Wert dort endet, wo wir interessiert sind. Daher wird hier ein BF-Angriff durchgef√ºhrt, sodass der Chunk endet wie: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(F√ºr weitere Informationen zu den restlichen Bytes √ºberpr√ºfen Sie die Erkl√§rung im [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Beispiel](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)). Wenn der BF nicht funktioniert, st√ºrzt das Programm einfach ab (also starten Sie erneut, bis es funktioniert).

Dann werden 2 Mallocs durchgef√ºhrt, um die 2 initialen Fast Bin Chunks zu entfernen, und ein dritter wird alloziert, um einen Chunk in **`__malloc_hook:`** zu erhalten.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Teil 2: Unsorted\_bin-Angriff

F√ºr weitere Informationen k√∂nnen Sie √ºberpr√ºfen:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Aber im Grunde erm√∂glicht es, `main_arena + 0x68` an einen beliebigen Ort zu schreiben, der in `chunk->bk` angegeben ist. Und f√ºr den Angriff w√§hlen wir `__malloc_hook`. Dann, nachdem wir es √ºberschrieben haben, verwenden wir eine relative √úberschreibung, um auf ein `one_gadget` zu zeigen.

Daf√ºr beginnen wir, einen Chunk zu erhalten und ihn in den **unsorted bin** zu legen:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Verwenden Sie ein UAF in diesem Chunk, um `unsorted_bin_ptr->bk` auf die Adresse von `__malloc_hook` zu zeigen (wir haben dies zuvor brute-forced).

{% hint style="danger" %}
Beachten Sie, dass dieser Angriff den unsortierten Bin (und damit auch den kleinen und gro√üen) besch√§digt. Daher k√∂nnen wir jetzt nur **Allokationen aus dem Fast Bin verwenden** (ein komplexeres Programm k√∂nnte andere Allokationen durchf√ºhren und abst√ºrzen), und um dies auszul√∂sen, m√ºssen wir **die gleiche Gr√∂√üe allokieren, sonst wird das Programm abst√ºrzen.**
{% endhint %}

Um also den Schreibvorgang von `main_arena + 0x68` in `__malloc_hook` auszul√∂sen, f√ºhren wir nach dem Setzen von `__malloc_hook` in `unsorted_bin_ptr->bk` einfach aus: **`malloc(0x80)`**

### Schritt 3: Setzen Sie \_\_malloc\_hook auf system

Im ersten Schritt haben wir einen Chunk kontrolliert, der `__malloc_hook` enth√§lt (in der Variablen `malloc_hook_chunk`), und im zweiten Schritt haben wir es geschafft, `main_arena + 0x68` hier zu schreiben.

Jetzt missbrauchen wir eine partielle √úberschreibung in `malloc_hook_chunk`, um die libc-Adresse, die wir dort geschrieben haben (`main_arena + 0x68`), zu **einer `one_gadget`-Adresse zu zeigen**.

Hier ist es notwendig, **12 Bits Zuf√§lligkeit zu brute-forcen** (weitere Informationen im [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Beispiel](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Schlie√ülich, sobald die korrekte Adresse √ºberschrieben ist, **rufen Sie `malloc` auf und l√∂sen Sie die `one_gadget` aus.**

## Referenzen

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
