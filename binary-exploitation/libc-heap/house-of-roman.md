# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

è¿™æ˜¯ä¸€ç§éå¸¸æœ‰è¶£çš„æŠ€æœ¯ï¼Œå®ƒå…è®¸é€šè¿‡å‡å¿«å—ã€æœªæ’åºå—æ”»å‡»å’Œç›¸å¯¹è¦†ç›–æ¥å®ç° RCEï¼Œè€Œæ— éœ€æ³„æ¼ã€‚ç„¶è€Œï¼Œå®ƒå·²ç»è¢« [**ä¿®è¡¥**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)ã€‚

### ä»£ç 

* ä½ å¯ä»¥åœ¨ [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) æ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹

### ç›®æ ‡

* é€šè¿‡æ»¥ç”¨ç›¸å¯¹æŒ‡é’ˆå®ç° RCE

### è¦æ±‚

* ç¼–è¾‘å¿«å—å’Œæœªæ’åºå—æŒ‡é’ˆ
* å¿…é¡»å¼ºè¡Œç ´è§£ 12 ä½éšæœºæ•°ï¼ˆ0.02% çš„æˆåŠŸç‡ï¼‰

## æ”»å‡»æ­¥éª¤

### ç¬¬ 1 éƒ¨åˆ†ï¼šå¿«å—å—æŒ‡å‘ \_\_malloc\_hook

åˆ›å»ºå‡ ä¸ªå—ï¼š

* `fastbin_victim` (0x60, offset 0): UAF å—ï¼Œç¨åç¼–è¾‘å †æŒ‡é’ˆä»¥æŒ‡å‘ LibC å€¼ã€‚
* `chunk2` (0x80, offset 0x70): ç”¨äºè‰¯å¥½çš„å¯¹é½
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): åœ¨ 'main\_arena\_use' å—ä¸Šçš„ç›¸å¯¹åç§»

ç„¶å `free(main_arena_use)`ï¼Œè¿™å°†æŠŠæ­¤å—æ”¾å…¥æœªæ’åºåˆ—è¡¨ï¼Œå¹¶åœ¨ `fd` å’Œ `bk` æŒ‡é’ˆä¸­è·å–æŒ‡å‘ `main_arena + 0x68` çš„æŒ‡é’ˆã€‚

ç°åœ¨åˆ†é…äº†ä¸€ä¸ªæ–°å— `fake_libc_chunk(0x60)`ï¼Œå› ä¸ºå®ƒå°†åŒ…å«æŒ‡å‘ `main_arena + 0x68` çš„æŒ‡é’ˆåœ¨ `fd` å’Œ `bk` ä¸­ã€‚

ç„¶å `relative_offset_heap` å’Œ `fastbin_victim` è¢«é‡Šæ”¾ã€‚
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` æœ‰ä¸€ä¸ªæŒ‡å‘ `relative_offset_heap` çš„ `fd`
* &#x20;`relative_offset_heap` æ˜¯ä» `fake_libc_chunk` çš„è·ç¦»åç§»é‡ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘ `main_arena + 0x68` çš„æŒ‡é’ˆ
* åªéœ€æ›´æ”¹ `fastbin_victim.fd` çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå°±å¯ä»¥ä½¿ `fastbin_victim` æŒ‡å‘ `main_arena + 0x68`

å¯¹äºä¹‹å‰çš„æ“ä½œï¼Œæ”»å‡»è€…éœ€è¦èƒ½å¤Ÿä¿®æ”¹ `fastbin_victim` çš„ fd æŒ‡é’ˆã€‚

ç„¶åï¼Œ`main_arena + 0x68` å¹¶ä¸æ˜¯é‚£ä¹ˆæœ‰è¶£ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä¿®æ”¹å®ƒï¼Œä½¿æŒ‡é’ˆæŒ‡å‘ **`__malloc_hook`**ã€‚

è¯·æ³¨æ„ï¼Œ`__memalign_hook` é€šå¸¸ä»¥ `0x7f` å¼€å¤´ï¼Œå‰é¢æ˜¯é›¶ï¼Œå› æ­¤å¯ä»¥å°†å…¶ä¼ªè£…ä¸º `0x70` å¿«é€Ÿå †çš„ä¸€ä¸ªå€¼ã€‚ç”±äºåœ°å€çš„æœ€å 4 ä½æ˜¯ **éšæœº** çš„ï¼Œå› æ­¤æœ‰ `2^4=16` ç§å¯èƒ½æ€§ä½¿å€¼æœ€ç»ˆæŒ‡å‘æˆ‘ä»¬æ„Ÿå…´è¶£çš„åœ°æ–¹ã€‚å› æ­¤åœ¨è¿™é‡Œæ‰§è¡Œ BF æ”»å‡»ï¼Œä½¿å¾—å—æœ€ç»ˆå˜æˆï¼š**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`ã€‚**

ï¼ˆæœ‰å…³å…¶ä½™å­—èŠ‚çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ç¤ºä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) ä¸­çš„è§£é‡Šï¼‰ã€‚å¦‚æœ BF ä¸èµ·ä½œç”¨ï¼Œç¨‹åºå°±ä¼šå´©æºƒï¼ˆæ‰€ä»¥ä»å¤´å¼€å§‹ï¼Œç›´åˆ°å®ƒæœ‰æ•ˆï¼‰ã€‚

ç„¶åï¼Œæ‰§è¡Œ 2 æ¬¡ malloc ä»¥ç§»é™¤ 2 ä¸ªåˆå§‹å¿«é€Ÿå †å—ï¼Œå¹¶åˆ†é…ç¬¬ä¸‰ä¸ªä»¥è·å–ä¸€ä¸ªåœ¨ **`__malloc_hook:`** ä¸­çš„å—ã€‚
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Part 2: Unsorted\_bin æ”»å‡»

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ï¼š

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

ä½†åŸºæœ¬ä¸Šï¼Œå®ƒå…è®¸å°† `main_arena + 0x68` å†™å…¥ `chunk->bk` æŒ‡å®šçš„ä»»ä½•ä½ç½®ã€‚å¯¹äºæ”»å‡»ï¼Œæˆ‘ä»¬é€‰æ‹© `__malloc_hook`ã€‚ç„¶åï¼Œåœ¨è¦†ç›–å®ƒä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç›¸å¯¹è¦†ç›–æ¥æŒ‡å‘ `one_gadget`ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¼€å§‹è·å–ä¸€ä¸ª chunk å¹¶å°†å…¶æ”¾å…¥ **unsorted bin**ï¼š
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
ä½¿ç”¨ UAF åœ¨è¿™ä¸ªå—ä¸­å°† `unsorted_bin_ptr->bk` æŒ‡å‘ `__malloc_hook` çš„åœ°å€ï¼ˆæˆ‘ä»¬ä¹‹å‰å·²ç»æš´åŠ›ç ´è§£è¿‡è¿™ä¸ªï¼‰ã€‚

{% hint style="danger" %}
è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ”»å‡»ä¼šç ´åæœªæ’åºçš„ binï¼ˆå› æ­¤å°å’Œå¤§ä¹Ÿä¼šå—åˆ°å½±å“ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨åªèƒ½**ä½¿ç”¨æ¥è‡ªå¿«é€Ÿ bin çš„åˆ†é…**ï¼ˆä¸€ä¸ªæ›´å¤æ‚çš„ç¨‹åºå¯èƒ½ä¼šè¿›è¡Œå…¶ä»–åˆ†é…å¹¶å´©æºƒï¼‰ï¼Œå¹¶ä¸”ä¸ºäº†è§¦å‘è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»**åˆ†é…ç›¸åŒçš„å¤§å°ï¼Œå¦åˆ™ç¨‹åºå°†å´©æºƒã€‚**
{% endhint %}

å› æ­¤ï¼Œä¸ºäº†è§¦å‘ `__malloc_hook` ä¸­ `main_arena + 0x68` çš„å†™å…¥ï¼Œæˆ‘ä»¬åœ¨å°† `__malloc_hook` è®¾ç½®åœ¨ `unsorted_bin_ptr->bk` åï¼Œåªéœ€æ‰§è¡Œï¼š**`malloc(0x80)`**

### ç¬¬ 3 æ­¥ï¼šå°† \_\_malloc\_hook è®¾ç½®ä¸º system

åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬æ§åˆ¶äº†ä¸€ä¸ªåŒ…å« `__malloc_hook` çš„å—ï¼ˆåœ¨å˜é‡ `malloc_hook_chunk` ä¸­ï¼‰ï¼Œåœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸåœ°åœ¨è¿™é‡Œå†™å…¥äº† `main_arena + 0x68`ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ©ç”¨ `malloc_hook_chunk` ä¸­çš„éƒ¨åˆ†è¦†ç›–ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨é‚£é‡Œå†™å…¥çš„ libc åœ°å€ï¼ˆ`main_arena + 0x68`ï¼‰æ¥**æŒ‡å‘ä¸€ä¸ª `one_gadget` åœ°å€**ã€‚

åœ¨è¿™é‡Œéœ€è¦**æš´åŠ›ç ´è§£ 12 ä½éšæœºæ•°**ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚è§ [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ç¤ºä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ï¼‰ã€‚

æœ€åï¼Œä¸€æ—¦æ­£ç¡®çš„åœ°å€è¢«è¦†ç›–ï¼Œ**è°ƒç”¨ `malloc` å¹¶è§¦å‘ `one_gadget`**ã€‚

## å‚è€ƒ

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
