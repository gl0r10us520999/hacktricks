# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ã“ã‚Œã¯ã€ãƒ•ã‚§ã‚¤ã‚¯ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã€ã‚¢ãƒ³ã‚½ãƒ¼ãƒˆãƒ“ãƒ³æ”»æ’ƒã€ç›¸å¯¾çš„ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒˆã‚’ä»‹ã—ã¦ãƒªãƒ¼ã‚¯ãªã—ã§RCEã‚’å¯èƒ½ã«ã™ã‚‹éå¸¸ã«èˆˆå‘³æ·±ã„æŠ€è¡“ã§ã—ãŸã€‚ã—ã‹ã—ã€ã“ã‚Œã¯[**ãƒ‘ãƒƒãƒãŒå½“ã¦ã‚‰ã‚Œã¾ã—ãŸ**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)ã€‚

### ã‚³ãƒ¼ãƒ‰

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã«ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚

### ç›®æ¨™

* ç›¸å¯¾ãƒã‚¤ãƒ³ã‚¿ã‚’æ‚ªç”¨ã—ã¦RCEã‚’å®Ÿç¾ã™ã‚‹ã“ã¨

### è¦ä»¶

* ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã¨ã‚¢ãƒ³ã‚½ãƒ¼ãƒˆãƒ“ãƒ³ãƒã‚¤ãƒ³ã‚¿ã‚’ç·¨é›†ã™ã‚‹ã“ã¨
* 12ãƒ“ãƒƒãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæˆåŠŸã™ã‚‹ç¢ºç‡ã¯0.02%ï¼‰

## æ”»æ’ƒæ‰‹é †

### ãƒ‘ãƒ¼ãƒˆ1: Fastbinãƒãƒ£ãƒ³ã‚¯ãŒ\_\_malloc\_hookã‚’æŒ‡ã™

ã„ãã¤ã‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã™ï¼š

* `fastbin_victim` (0x60, ã‚ªãƒ•ã‚»ãƒƒãƒˆ 0): å¾Œã§ãƒ’ãƒ¼ãƒ—ãƒã‚¤ãƒ³ã‚¿ã‚’LibCå€¤ã‚’æŒ‡ã™ã‚ˆã†ã«ç·¨é›†ã™ã‚‹UAFãƒãƒ£ãƒ³ã‚¯ã€‚
* `chunk2` (0x80, ã‚ªãƒ•ã‚»ãƒƒãƒˆ 0x70): è‰¯å¥½ãªã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã®ãŸã‚
* `main_arena_use` (0x80, ã‚ªãƒ•ã‚»ãƒƒãƒˆ 0x100)
* `relative_offset_heap` (0x60, ã‚ªãƒ•ã‚»ãƒƒãƒˆ 0x190): 'main\_arena\_use'ãƒãƒ£ãƒ³ã‚¯ã®ç›¸å¯¾ã‚ªãƒ•ã‚»ãƒƒãƒˆ

æ¬¡ã«ã€`free(main_arena_use)`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚¢ãƒ³ã‚½ãƒ¼ãƒˆãƒªã‚¹ãƒˆã«é…ç½®ã•ã‚Œã€`fd`ã¨`bk`ãƒã‚¤ãƒ³ã‚¿ã®ä¸¡æ–¹ã«`main_arena + 0x68`ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

ä»Šã€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯`fake_libc_chunk(0x60)`ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€`fd`ã¨`bk`ã«`main_arena + 0x68`ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚€ãŸã‚ã§ã™ã€‚

ãã®å¾Œã€`relative_offset_heap`ã¨`fastbin_victim`ãŒè§£æ”¾ã•ã‚Œã¾ã™ã€‚
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` ã¯ `relative_offset_heap` ã‚’æŒ‡ã™ `fd` ã‚’æŒã£ã¦ã„ã¾ã™
* &#x20;`relative_offset_heap` ã¯ `fake_libc_chunk` ã‹ã‚‰ã®è·é›¢ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã§ã€`main_arena + 0x68` ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚“ã§ã„ã¾ã™
* `fastbin_victim.fd` ã®æœ€å¾Œã®ãƒã‚¤ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€`fastbin_victim` ãŒ `main_arena + 0x68` ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™

å‰è¿°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã«ã¯ã€æ”»æ’ƒè€…ã¯ `fastbin_victim` ã® fd ãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ¬¡ã«ã€`main_arena + 0x68` ã¯ãã‚Œã»ã©èˆˆå‘³æ·±ããªã„ã®ã§ã€ãƒã‚¤ãƒ³ã‚¿ã‚’ **`__malloc_hook`** ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

`__memalign_hook` ã¯é€šå¸¸ `0x7f` ã§å§‹ã¾ã‚Šã€ãã®å‰ã«ã‚¼ãƒ­ãŒç¶šããŸã‚ã€`0x70` ã®ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³å†…ã®å€¤ã¨ã—ã¦å½è£…ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æœ€å¾Œã®4ãƒ“ãƒƒãƒˆã¯ **ãƒ©ãƒ³ãƒ€ãƒ ** ã§ã‚ã‚‹ãŸã‚ã€èˆˆå‘³ã®ã‚ã‚‹å ´æ‰€ã‚’æŒ‡ã™å€¤ã®å¯èƒ½æ€§ã¯ `2^4=16` ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã“ã§ BF æ”»æ’ƒãŒè¡Œã‚ã‚Œã€ãƒãƒ£ãƒ³ã‚¯ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**ã€‚

(æ®‹ã‚Šã®ãƒã‚¤ãƒˆã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ã®ä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã®èª¬æ˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„)ã€‚BF ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯å˜ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ï¼ˆæ©Ÿèƒ½ã™ã‚‹ã¾ã§å†è©¦è¡Œã—ã¦ãã ã•ã„ï¼‰ã€‚

ãã®å¾Œã€2ã¤ã® malloc ãŒå®Ÿè¡Œã•ã‚Œã€æœ€åˆã®2ã¤ã®ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ãŒå‰Šé™¤ã•ã‚Œã€3ã¤ç›®ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ **`__malloc_hook:`** ã«ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Part 2: Unsorted\_binæ”»æ’ƒ

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã™ï¼š

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

åŸºæœ¬çš„ã«ã¯ã€`chunk->bk`ã§æŒ‡å®šã•ã‚ŒãŸä»»æ„ã®å ´æ‰€ã«`main_arena + 0x68`ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ãã—ã¦ã€æ”»æ’ƒã®ãŸã‚ã«`__malloc_hook`ã‚’é¸æŠã—ã¾ã™ã€‚ãã®å¾Œã€ä¸Šæ›¸ãã—ãŸå¾Œã«ç›¸å¯¾çš„ãªä¸Šæ›¸ãã‚’ä½¿ç”¨ã—ã¦`one_gadget`ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã‚Œã‚’è¡Œã†ãŸã‚ã«ã€ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã€**unsorted bin**ã«å…¥ã‚Œå§‹ã‚ã¾ã™ï¼š
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
ã“ã®ãƒãƒ£ãƒ³ã‚¯ã§UAFã‚’ä½¿ç”¨ã—ã¦ã€`unsorted_bin_ptr->bk`ã‚’`__malloc_hook`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒã‚¤ãƒ³ãƒˆã•ã›ã¾ã™ï¼ˆã“ã‚Œã¯ä»¥å‰ã«ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¾ã—ãŸï¼‰ã€‚

{% hint style="danger" %}
ã“ã®æ”»æ’ƒã¯æœªæ•´ç†ãƒ“ãƒ³ã‚’ç ´æã•ã›ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼ˆã—ãŸãŒã£ã¦å°ã¨å¤§ã‚‚ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€**ä»Šã¯ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã‹ã‚‰ã®å‰²ã‚Šå½“ã¦ã®ã¿ã‚’ä½¿ç”¨ã§ãã¾ã™**ï¼ˆã‚ˆã‚Šè¤‡é›‘ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ä»–ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã„ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€ã“ã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã«ã¯ã€**åŒã˜ã‚µã‚¤ã‚ºã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‚ãªã‘ã‚Œã°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚**
{% endhint %}

ã—ãŸãŒã£ã¦ã€`__malloc_hook`ã«`main_arena + 0x68`ã®æ›¸ãè¾¼ã¿ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«ã€`unsorted_bin_ptr->bk`ã«`__malloc_hook`ã‚’è¨­å®šã—ãŸå¾Œã«è¡Œã†å¿…è¦ãŒã‚ã‚‹ã®ã¯ã€**`malloc(0x80)`**ã§ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: \_\_malloc\_hookã‚’systemã«è¨­å®š

ã‚¹ãƒ†ãƒƒãƒ—1ã§ã¯ã€`__malloc_hook`ã‚’å«ã‚€ãƒãƒ£ãƒ³ã‚¯ï¼ˆå¤‰æ•°`malloc_hook_chunk`ï¼‰ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã«æˆåŠŸã—ã€ã‚¹ãƒ†ãƒƒãƒ—2ã§ã¯ã“ã“ã«`main_arena + 0x68`ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä»Šã€`malloc_hook_chunk`ã®éƒ¨åˆ†çš„ãªä¸Šæ›¸ãã‚’æ‚ªç”¨ã—ã¦ã€ãã“ã«æ›¸ãè¾¼ã‚“ã libcã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ`main_arena + 0x68`ï¼‰ã‚’**`one_gadget`ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒã‚¤ãƒ³ãƒˆã•ã›ã¾ã™**ã€‚

ã“ã“ã§å¿…è¦ãªã®ã¯ã€**12ãƒ“ãƒƒãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã“ã¨**ã§ã™ï¼ˆè©³ç´°ã¯[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ã®ä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼‰ã€‚

æœ€å¾Œã«ã€æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸Šæ›¸ãã•ã‚ŒãŸã‚‰ã€**`malloc`ã‚’å‘¼ã³å‡ºã—ã¦`one_gadget`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™**ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
