# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

‡§Ø‡§π ‡§è‡§ï ‡§¨‡§π‡•Å‡§§ ‡§π‡•Ä ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§•‡•Ä ‡§ú‡§ø‡§∏‡§®‡•á ‡§®‡§ï‡§≤‡•Ä ‡§´‡§æ‡§∏‡•ç‡§ü‡§¨‡§ø‡§®, ‡§Ö‡§®‡§∏‡•â‡§∞‡•ç‡§ü‡•á‡§°\_‡§¨‡§ø‡§® ‡§π‡§Æ‡§≤‡•á ‡§î‡§∞ ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á RCE ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•Ä‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø ‡§á‡§∏‡•á [**‡§™‡•à‡§ö ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)‡•§

### Code

* You can find an example in [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)

### Goal

* ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§™‡•â‡§á‡§Ç‡§ü‡§∞‡•ç‡§∏ ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á RCE ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡§æ

### Requirements

* ‡§´‡§æ‡§∏‡•ç‡§ü‡§¨‡§ø‡§® ‡§î‡§∞ ‡§Ö‡§®‡§∏‡•â‡§∞‡•ç‡§ü‡•á‡§° ‡§¨‡§ø‡§® ‡§™‡•â‡§á‡§Ç‡§ü‡§∞‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
* 12 ‡§¨‡§ø‡§ü ‡§ï‡•Ä ‡§Ø‡§æ‡§¶‡•É‡§ö‡•ç‡§õ‡§ø‡§ï‡§§‡§æ ‡§ï‡•ã ‡§¨‡•ç‡§∞‡•Ç‡§ü ‡§´‡•ã‡§∞‡•ç‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è (‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä 0.02% ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ)

## Attack Steps

### Part 1: Fastbin Chunk points to \_\_malloc\_hook

‡§ï‡§à ‡§ö‡§Ç‡§ï‡•ç‡§∏ ‡§¨‡§®‡§æ‡§è‡§Ç:

* `fastbin_victim` (0x60, offset 0): UAF ‡§ö‡§Ç‡§ï ‡§ú‡§ø‡§∏‡•á ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§π‡•Ä‡§™ ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ ‡§ï‡•ã LibC ‡§Æ‡§æ‡§® ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§Ç‡§ó‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
* `chunk2` (0x80, offset 0x70): ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§∏‡§Ç‡§∞‡•á‡§ñ‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): 'main\_arena\_use' ‡§ö‡§Ç‡§ï ‡§™‡§∞ ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§ë‡§´‡§∏‡•á‡§ü

‡§´‡§ø‡§∞ `free(main_arena_use)` ‡§ï‡§∞‡•á‡§Ç ‡§ú‡•ã ‡§á‡§∏ ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§Ö‡§®‡§∏‡•â‡§∞‡•ç‡§ü‡•á‡§° ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡•á‡§ó‡§æ ‡§î‡§∞ `fd` ‡§î‡§∞ `bk` ‡§™‡•â‡§á‡§Ç‡§ü‡§∞‡•ç‡§∏ ‡§Æ‡•á‡§Ç `main_arena + 0x68` ‡§ï‡§æ ‡§è‡§ï ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§ó‡§æ‡•§

‡§Ö‡§¨ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ö‡§Ç‡§ï `fake_libc_chunk(0x60)` ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§á‡§∏‡§Æ‡•á‡§Ç `fd` ‡§î‡§∞ `bk` ‡§Æ‡•á‡§Ç `main_arena + 0x68` ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•â‡§á‡§Ç‡§ü‡§∞‡•ç‡§∏ ‡§π‡•ã‡§Ç‡§ó‡•á‡•§

‡§´‡§ø‡§∞ `relative_offset_heap` ‡§î‡§∞ `fastbin_victim` ‡§ï‡•ã ‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` ‡§ï‡§æ `fd` `relative_offset_heap` ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
* &#x20;`relative_offset_heap` `fake_libc_chunk` ‡§∏‡•á ‡§¶‡•Ç‡§∞‡•Ä ‡§ï‡§æ ‡§è‡§ï ‡§ë‡§´‡§∏‡•á‡§ü ‡§π‡•à, ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç `main_arena + 0x68` ‡§ï‡•Ä ‡§ì‡§∞ ‡§è‡§ï ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ ‡§π‡•ã‡§§‡§æ ‡§π‡•à
* ‡§¨‡§∏ `fastbin_victim.fd` ‡§ï‡•á ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡§æ‡§á‡§ü ‡§ï‡•ã ‡§¨‡§¶‡§≤‡§ï‡§∞, `fastbin_victim points` ‡§ï‡•ã `main_arena + 0x68` ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à

‡§™‡§ø‡§õ‡§≤‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã `fastbin_victim` ‡§ï‡•á fd ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§

‡§´‡§ø‡§∞, `main_arena + 0x68` ‡§á‡§§‡§®‡§æ ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§á‡§∏‡§≤‡§ø‡§è ‡§á‡§∏‡•á ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ **`__malloc_hook`** ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡•á‡•§

‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø `__memalign_hook` ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ `0x7f` ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡§ï‡•á ‡§™‡§π‡§≤‡•á ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§´‡§ø‡§∞ ‡§á‡§∏‡•á `0x70` ‡§´‡§æ‡§∏‡•ç‡§ü ‡§¨‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Æ‡§æ‡§® ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§´‡•á‡§ï ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§™‡§§‡•á ‡§ï‡•á ‡§Ö‡§Ç‡§§‡§ø‡§Æ 4 ‡§¨‡§ø‡§ü **‡§∞‡•à‡§Ç‡§°‡§Æ** ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Æ‡§æ‡§® ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è `2^4=16` ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ‡§è‡§Å ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Ç ‡§è‡§ï BF ‡§π‡§Æ‡§≤‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§ö‡§Ç‡§ï ‡§á‡§∏ ‡§§‡§∞‡§π ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`‡•§**

(‡§¨‡§æ‡§ï‡•Ä ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ‡§â‡§¶‡§æ‡§π‡§∞‡§£](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) ‡§Æ‡•á‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç)‡•§ ‡§Ø‡§¶‡§ø BF ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§¨‡§∏ ‡§ï‡•ç‡§∞‡•à‡§∂ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à (‡§á‡§∏‡§≤‡§ø‡§è ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ ‡§§‡§ï ‡§Ø‡§π ‡§ï‡§æ‡§Æ ‡§® ‡§ï‡§∞‡•á)‡•§

‡§´‡§ø‡§∞, 2 mallocs ‡§ï‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø 2 ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§´‡§æ‡§∏‡•ç‡§ü ‡§¨‡§ø‡§® ‡§ö‡§Ç‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á ‡§î‡§∞ ‡§è‡§ï ‡§§‡•Ä‡§∏‡§∞‡§æ ‡§Ü‡§µ‡§Ç‡§ü‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø **`__malloc_hook:`** ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ö‡§Ç‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Part 2: Unsorted\_bin ‡§π‡§Æ‡§≤‡§æ

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

‡§≤‡•á‡§ï‡§ø‡§® ‡§Æ‡•Ç‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ø‡§π `chunk->bk` ‡§Æ‡•á‡§Ç ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ `main_arena + 0x68` ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§ ‡§î‡§∞ ‡§π‡§Æ‡§≤‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ `__malloc_hook` ‡§ö‡•Å‡§®‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§´‡§ø‡§∞, ‡§á‡§∏‡•á ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶, ‡§π‡§Æ ‡§è‡§ï ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á) ‡§è‡§ï `one_gadget` ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è‡•§

‡§á‡§∏‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ ‡§è‡§ï ‡§ö‡§Ç‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§á‡§∏‡•á **unsorted bin** ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡§§‡•á ‡§π‡•à‡§Ç:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (‡§π‡§Æ‡§®‡•á ‡§á‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§¨‡•ç‡§∞‡•Ç‡§ü ‡§´‡•ã‡§∞‡•ç‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§•‡§æ)‡•§

{% hint style="danger" %}
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§Ö‡§®‡§∏‡•â‡§∞‡•ç‡§ü‡•á‡§° ‡§¨‡§ø‡§® ‡§ï‡•ã ‡§≠‡•ç‡§∞‡§∑‡•ç‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à (‡§á‡§∏‡§≤‡§ø‡§è ‡§õ‡•ã‡§ü‡•á ‡§î‡§∞ ‡§¨‡§°‡§º‡•á ‡§≠‡•Ä)‡•§ ‡§á‡§∏‡§≤‡§ø‡§è ‡§π‡§Æ ‡§ï‡•á‡§µ‡§≤ **‡§Ö‡§¨ ‡§´‡§æ‡§∏‡•ç‡§ü ‡§¨‡§ø‡§® ‡§∏‡•á ‡§Ü‡§µ‡§Ç‡§ü‡§® ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** (‡§è‡§ï ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§ü‡§ø‡§≤ ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§µ‡§Ç‡§ü‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡•ç‡§∞‡•à‡§∂ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à), ‡§î‡§∞ ‡§á‡§∏‡•á ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§Æ‡•á‡§Ç **‡§â‡§∏‡•Ä ‡§Ü‡§ï‡§æ‡§∞ ‡§ï‡§æ ‡§Ü‡§µ‡§Ç‡§ü‡§® ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ ‡§Ø‡§æ ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§ï‡•ç‡§∞‡•à‡§∂ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§**
{% endhint %}

‡§§‡•ã, `__malloc_hook` ‡§Æ‡•á‡§Ç `main_arena + 0x68` ‡§ï‡•á ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•ã ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ `unsorted_bin_ptr->bk` ‡§Æ‡•á‡§Ç `__malloc_hook` ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¨‡§∏ ‡§Ø‡§π ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à: **`malloc(0x80)`**

### Step 3: Set \_\_malloc\_hook to system

‡§™‡§π‡§≤‡•á ‡§ö‡§∞‡§£ ‡§Æ‡•á‡§Ç, ‡§π‡§Æ `__malloc_hook` ‡§µ‡§æ‡§≤‡•á ‡§è‡§ï ‡§ö‡§Ç‡§ï ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤ ‡§∞‡§π‡•á (‡§ö‡§∞ `malloc_hook_chunk` ‡§Æ‡•á‡§Ç) ‡§î‡§∞ ‡§¶‡•Ç‡§∏‡§∞‡•á ‡§ö‡§∞‡§£ ‡§Æ‡•á‡§Ç, ‡§π‡§Æ ‡§Ø‡§π‡§æ‡§Ç `main_arena + 0x68` ‡§≤‡§ø‡§ñ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤ ‡§∞‡§π‡•á‡•§

‡§Ö‡§¨, ‡§π‡§Æ `malloc_hook_chunk` ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§Ü‡§Ç‡§∂‡§ø‡§ï ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§π‡§Æ ‡§µ‡§π‡§æ‡§Ç ‡§≤‡§ø‡§ñ‡•á ‡§ó‡§è libc ‡§™‡§§‡•á (`main_arena + 0x68`) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á **‡§è‡§ï `one_gadget` ‡§™‡§§‡•á ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç**‡•§

‡§Ø‡§π‡§æ‡§Ç **12 ‡§¨‡§ø‡§ü ‡§ï‡•Ä ‡§Ø‡§æ‡§¶‡•É‡§ö‡•ç‡§õ‡§ø‡§ï‡§§‡§æ ‡§ï‡•ã ‡§¨‡•ç‡§∞‡•Ç‡§ü‡§´‡•ã‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à** (‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ ‡§â‡§¶‡§æ‡§π‡§∞‡§£](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c))‡•§

‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç, ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§∏‡§π‡•Ä ‡§™‡§§‡§æ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§®‡•á ‡§™‡§∞, **`malloc` ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ `one_gadget` ‡§ï‡•ã ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡•á‡§Ç**‡•§

## References

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
