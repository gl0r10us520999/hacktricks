# House of Roman

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

Bu, sahte fastbinler, sÄ±ralanmamÄ±ÅŸ\_bin saldÄ±rÄ±sÄ± ve gÃ¶reli yazmalar aracÄ±lÄ±ÄŸÄ±yla sÄ±zma olmadan RCE'ye izin veren Ã§ok ilginÃ§ bir teknikti. Ancak bu [**yamanmÄ±ÅŸtÄ±r**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Kod

* Bir Ã¶rneÄŸi [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) adresinde bulabilirsiniz.

### Hedef

* GÃ¶reli iÅŸaretÃ§ileri kÃ¶tÃ¼ye kullanarak RCE

### Gereksinimler

* Fastbin ve sÄ±ralanmamÄ±ÅŸ bin iÅŸaretÃ§ilerini dÃ¼zenleyin
* 12 bit rastgelelik zorla kÄ±rÄ±lmalÄ±dÄ±r (Ã§alÄ±ÅŸma olasÄ±lÄ±ÄŸÄ± %0.02)

## SaldÄ±rÄ± AdÄ±mlarÄ±

### BÃ¶lÃ¼m 1: Fastbin Chunk \_\_malloc\_hook'a iÅŸaret ediyor

BirÃ§ok chunk oluÅŸturun:

* `fastbin_victim` (0x60, offset 0): YÄ±ÄŸÄ±n iÅŸaretÃ§isini daha sonra LibC deÄŸerine iÅŸaret edecek ÅŸekilde dÃ¼zenlemek iÃ§in UAF chunk.
* `chunk2` (0x80, offset 0x70): Ä°yi hizalama iÃ§in
* `main_arena_use` (0x80, offset 0x100)
* `relative_offset_heap` (0x60, offset 0x190): 'main\_arena\_use' chunk'Ä±ndaki gÃ¶reli offset

Sonra `free(main_arena_use)` yapÄ±n, bu chunk'Ä± sÄ±ralanmamÄ±ÅŸ listeye yerleÅŸtirecek ve hem `fd` hem de `bk` iÅŸaretÃ§elerinde `main_arena + 0x68`'e bir iÅŸaretÃ§i alacaktÄ±r.

ArtÄ±k `fd` ve `bk`'de `main_arena + 0x68`'e iÅŸaret eden iÅŸaretÃ§ileri iÃ§ereceÄŸi iÃ§in yeni bir chunk `fake_libc_chunk(0x60)` tahsis edilmiÅŸtir.

Sonra `relative_offset_heap` ve `fastbin_victim` serbest bÄ±rakÄ±lÄ±r.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim` bir `fd`'ye sahip ve bu `relative_offset_heap`'e iÅŸaret ediyor
* &#x20;`relative_offset_heap`, `main_arena + 0x68`'e iÅŸaret eden bir iÅŸaretÃ§i iÃ§eren `fake_libc_chunk`'ten uzaklÄ±k ofsetidir
* `fastbin_victim.fd`'nin son baytÄ±nÄ± deÄŸiÅŸtirmek, `fastbin_victim`'in `main_arena + 0x68`'e iÅŸaret etmesini saÄŸlamak mÃ¼mkÃ¼ndÃ¼r

Ã–nceki eylemler iÃ§in, saldÄ±rganÄ±n `fastbin_victim`'in fd iÅŸaretÃ§isini deÄŸiÅŸtirebilme yeteneÄŸine sahip olmasÄ± gerekir.

Sonra, `main_arena + 0x68` o kadar ilginÃ§ deÄŸil, bu yÃ¼zden iÅŸaretÃ§iyi **`__malloc_hook`**'a iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirelim.

`__memalign_hook` genellikle `0x7f` ile baÅŸlar ve Ã¶ncesinde sÄ±fÄ±rlar vardÄ±r, bu nedenle bunu `0x70` hÄ±zlÄ± bin iÃ§inde bir deÄŸer olarak sahteleyebiliriz. Adresin son 4 biti **rastgele** olduÄŸundan, ilginÃ§ olduÄŸumuz yere iÅŸaret edecek deÄŸerin sonlanmasÄ± iÃ§in `2^4=16` olasÄ±lÄ±k vardÄ±r. Bu nedenle burada bir BF saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirilir, bÃ¶ylece parÃ§a ÅŸu ÅŸekilde sona erer: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(DiÄŸer baytlar hakkÄ±nda daha fazla bilgi iÃ§in [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Ã¶rneÄŸindeki](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c) aÃ§Ä±klamayÄ± kontrol edin). BF Ã§alÄ±ÅŸmazsa program sadece Ã§Ã¶kebilir (bu yÃ¼zden Ã§alÄ±ÅŸana kadar tekrar deneyin).

Sonra, 2 malloc iÅŸlemi gerÃ§ekleÅŸtirilir, bÃ¶ylece 2 baÅŸlangÄ±Ã§ hÄ±zlÄ± bin parÃ§asÄ± kaldÄ±rÄ±lÄ±r ve **`__malloc_hook:`** iÃ§inde bir parÃ§a almak iÃ§in Ã¼Ã§Ã¼ncÃ¼ bir tane tahsis edilir.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### BÃ¶lÃ¼m 2: Unsorted\_bin saldÄ±rÄ±sÄ±

Daha fazla bilgi iÃ§in kontrol edebilirsiniz:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

Ama temelde, `chunk->bk` iÃ§inde belirtilen herhangi bir konuma `main_arena + 0x68` yazmayÄ± saÄŸlar. Ve saldÄ±rÄ± iÃ§in `__malloc_hook` seÃ§iyoruz. Sonra, onu geÃ§ersiz kÄ±ldÄ±ktan sonra, bir `one_gadget`'e iÅŸaret etmek iÃ§in gÃ¶reli bir geÃ§ersiz kÄ±lma kullanacaÄŸÄ±z.

Bunun iÃ§in bir chunk alarak **unsorted bin**'e koymaya baÅŸlÄ±yoruz:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Bir UAF kullanarak bu parÃ§ayÄ± `unsorted_bin_ptr->bk`'yi `__malloc_hook` adresine iÅŸaret edecek ÅŸekilde ayarlayÄ±n (bunu daha Ã¶nce brute force ile bulmuÅŸtuk).

{% hint style="danger" %}
Bu saldÄ±rÄ±nÄ±n unsorted bin'i bozduÄŸunu (dolayÄ±sÄ±yla kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k olanlarÄ± da) unutmayÄ±n. Bu nedenle, **ÅŸimdi yalnÄ±zca hÄ±zlÄ± bin'den tahsisat kullanabiliriz** (daha karmaÅŸÄ±k bir program baÅŸka tahsisatlar yapabilir ve Ã§Ã¶kebilir) ve bunu tetiklemek iÃ§in **aynÄ± boyutta tahsisat yapmalÄ±yÄ±z yoksa program Ã§Ã¶kebilir.**
{% endhint %}

DolayÄ±sÄ±yla, `__malloc_hook`'ta `main_arena + 0x68` yazÄ±mÄ±nÄ± tetiklemek iÃ§in `__malloc_hook`'u `unsorted_bin_ptr->bk`'de ayarladÄ±ktan sonra sadece ÅŸunu yapmamÄ±z gerekiyor: **`malloc(0x80)`**

### AdÄ±m 3: \_\_malloc\_hook'u system olarak ayarlayÄ±n

Birinci adÄ±mda `__malloc_hook`'u iÃ§eren bir parÃ§ayÄ± kontrol etmeyi baÅŸardÄ±k (deÄŸiÅŸken `malloc_hook_chunk` iÃ§inde) ve ikinci adÄ±mda burada `main_arena + 0x68` yazmayÄ± baÅŸardÄ±k.

Åimdi, `malloc_hook_chunk`'ta kÄ±smi bir yazma iÅŸlemi suistimal ederek oraya yazdÄ±ÄŸÄ±mÄ±z libc adresini (`main_arena + 0x68`) **bir `one_gadget` adresine iÅŸaret etmek iÃ§in** kullanÄ±yoruz.

Burada **12 bit rastgeleliÄŸi brute force ile bulmak** gerekiyor (daha fazla bilgi iÃ§in [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)[ Ã¶rneÄŸi](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)).

Son olarak, doÄŸru adres yazÄ±ldÄ±ÄŸÄ±nda, **`malloc` Ã§aÄŸÄ±rÄ±n ve `one_gadget`'i tetikleyin.**

## Referanslar

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
