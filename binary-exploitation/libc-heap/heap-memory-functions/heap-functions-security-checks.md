# Heap Functions Security Checks

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## unlink

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="unlink.md" %}
[unlink.md](unlink.md)
{% endcontent-ref %}

è¿™æ˜¯æ‰§è¡Œæ£€æŸ¥çš„æ€»ç»“ï¼š

* æ£€æŸ¥å—çš„æŒ‡ç¤ºå¤§å°æ˜¯å¦ä¸ä¸‹ä¸€ä¸ªå—ä¸­æŒ‡ç¤ºçš„ `prev_size` ç›¸åŒ
* é”™è¯¯ä¿¡æ¯ï¼š`corrupted size vs. prev_size`
* è¿˜è¦æ£€æŸ¥ `P->fd->bk == P` å’Œ `P->bk->fw == P`
* é”™è¯¯ä¿¡æ¯ï¼š`corrupted double-linked list`
* å¦‚æœå—ä¸å°ï¼Œæ£€æŸ¥ `P->fd_nextsize->bk_nextsize == P` å’Œ `P->bk_nextsize->fd_nextsize == P`
* é”™è¯¯ä¿¡æ¯ï¼š`corrupted double-linked list (not small)`

## \_int\_malloc

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](malloc-and-sysmalloc.md)
{% endcontent-ref %}

* **å¿«é€Ÿ bin æœç´¢æœŸé—´çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): unaligned fastbin chunk detected 2`
* å¦‚æœå‰å‘å—æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): unaligned fastbin chunk detected`
* å¦‚æœè¿”å›çš„å—çš„å¤§å°å› å…¶åœ¨å¿«é€Ÿ bin ä¸­çš„ç´¢å¼•è€Œä¸æ­£ç¡®ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): memory corruption (fast)`
* å¦‚æœç”¨äºå¡«å…… tcache çš„ä»»ä½•å—æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): unaligned fastbin chunk detected 3`
* **å° bin æœç´¢æœŸé—´çš„æ£€æŸ¥ï¼š**
* å¦‚æœ `victim->bk->fd != victim`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): smallbin double linked list corrupted`
* **åœ¨æ¯ä¸ªå¿«é€Ÿ bin å—ä¸Šæ‰§è¡Œçš„åˆå¹¶æ£€æŸ¥ï¼š**
* å¦‚æœå—æœªå¯¹é½è§¦å‘ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc_consolidate(): unaligned fastbin chunk detected`
* å¦‚æœå—çš„å¤§å°ä¸å…¶æ‰€åœ¨ç´¢å¼•åº”æœ‰çš„å¤§å°ä¸åŒï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc_consolidate(): invalid chunk size`
* å¦‚æœå‰ä¸€ä¸ªå—æœªä½¿ç”¨ä¸”å‰ä¸€ä¸ªå—çš„å¤§å°ä¸ prev\_chunk æŒ‡ç¤ºçš„å¤§å°ä¸åŒï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`corrupted size vs. prev_size in fastbins`
* **åœ¨æœªæ’åº bin æœç´¢æœŸé—´çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—å¤§å°å¼‚å¸¸ï¼ˆå¤ªå°æˆ–å¤ªå¤§ï¼‰ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): invalid size (unsorted)`
* å¦‚æœä¸‹ä¸€ä¸ªå—å¤§å°å¼‚å¸¸ï¼ˆå¤ªå°æˆ–å¤ªå¤§ï¼‰ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): invalid next size (unsorted)`
* å¦‚æœä¸‹ä¸€ä¸ªå—æŒ‡ç¤ºçš„å‰ä¸€ä¸ªå¤§å°ä¸å—çš„å¤§å°ä¸åŒï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): mismatching next->prev_size (unsorted)`
* å¦‚æœä¸æ˜¯ `victim->bck->fd == victim` æˆ–ä¸æ˜¯ `victim->fd == av (arena)`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): unsorted double linked list corrupted`
* ç”±äºæˆ‘ä»¬å§‹ç»ˆæ£€æŸ¥æœ€åä¸€ä¸ªï¼Œå®ƒçš„ fd åº”å§‹ç»ˆæŒ‡å‘ arena ç»“æ„ã€‚
* å¦‚æœä¸‹ä¸€ä¸ªå—æœªæŒ‡ç¤ºå‰ä¸€ä¸ªå—æ­£åœ¨ä½¿ç”¨ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): invalid next->prev_inuse (unsorted)`
* å¦‚æœ `fwd->bk_nextsize->fd_nextsize != fwd`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): largebin double linked list corrupted (nextsize)`
* å¦‚æœ `fwd->bk->fd != fwd`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): largebin double linked list corrupted (bk)`
* **æŒ‰ç´¢å¼•æœç´¢å¤§ bin çš„æ£€æŸ¥ï¼š**
* `bck->fd-> bk != bck`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): corrupted unsorted chunks`
* **æŒ‰ä¸‹ä¸€ä¸ªæ›´å¤§å—æœç´¢å¤§ bin çš„æ£€æŸ¥ï¼š**
* `bck->fd-> bk != bck`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): corrupted unsorted chunks2`
* **åœ¨ Top chunk ä½¿ç”¨æœŸé—´çš„æ£€æŸ¥ï¼š**
* `chunksize(av->top) > av->system_mem`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): corrupted top size`

## `tcache_get_n`

* **åœ¨ `tcache_get_n` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc(): unaligned tcache chunk detected`

## `tcache_thread_shutdown`

* **åœ¨ `tcache_thread_shutdown` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`tcache_thread_shutdown(): unaligned tcache chunk detected`

## `__libc_realloc`

* **åœ¨ `__libc_realloc` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœæ—§æŒ‡é’ˆæœªå¯¹é½æˆ–å¤§å°ä¸æ­£ç¡®ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`realloc(): invalid pointer`

## `_int_free`

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š

{% content-ref url="free.md" %}
[free.md](free.md)
{% endcontent-ref %}

* **åœ¨ `_int_free` å¼€å§‹æ—¶çš„æ£€æŸ¥ï¼š**
* æŒ‡é’ˆå·²å¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): invalid pointer`
* å¤§å°å¤§äº `MINSIZE` ä¸”å¤§å°ä¹Ÿå·²å¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): invalid size`
* **åœ¨ `_int_free` tcache ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœæ¡ç›®è¶…è¿‡ `mp_.tcache_count`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): too many chunks detected in tcache`
* å¦‚æœæ¡ç›®æœªå¯¹é½ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): unaligned chunk detected in tcache 2`
* å¦‚æœå·²é‡Šæ”¾çš„å—å·²ç»è¢«é‡Šæ”¾å¹¶ä½œä¸ºå—å­˜åœ¨äº tcache ä¸­ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): double free detected in tcache 2`
* **åœ¨ `_int_free` å¿«é€Ÿ bin ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—çš„å¤§å°æ— æ•ˆï¼ˆå¤ªå¤§æˆ–å¤ªå°ï¼‰è§¦å‘ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): invalid next size (fast)`
* å¦‚æœæ·»åŠ çš„å—å·²ç»æ˜¯å¿«é€Ÿ bin çš„é¡¶éƒ¨ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`double free or corruption (fasttop)`
* å¦‚æœé¡¶éƒ¨å—çš„å¤§å°ä¸æˆ‘ä»¬æ·»åŠ çš„å—çš„å¤§å°ä¸åŒï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`invalid fastbin entry (free)`

## **`_int_free_merge_chunk`**

* **åœ¨ `_int_free_merge_chunk` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœå—æ˜¯é¡¶éƒ¨å—ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`double free or corruption (top)`
* å¦‚æœä¸‹ä¸€ä¸ªå—è¶…å‡º arena çš„è¾¹ç•Œï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`double free or corruption (out)`
* å¦‚æœå—æœªæ ‡è®°ä¸ºä½¿ç”¨ï¼ˆåœ¨ä¸‹ä¸€ä¸ªå—çš„ prev\_inuse ä¸­ï¼‰ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`double free or corruption (!prev)`
* å¦‚æœä¸‹ä¸€ä¸ªå—çš„å¤§å°å¤ªå°æˆ–å¤ªå¤§ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): invalid next size (normal)`
* å¦‚æœå‰ä¸€ä¸ªå—æœªä½¿ç”¨ï¼Œå®ƒå°†å°è¯•åˆå¹¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœ `prev_size` ä¸å‰ä¸€ä¸ªå—æŒ‡ç¤ºçš„å¤§å°ä¸åŒï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`corrupted size vs. prev_size while consolidating`

## **`_int_free_create_chunk`**

* **åœ¨ `_int_free_create_chunk` ä¸­çš„æ£€æŸ¥ï¼š**
* å°†å—æ·»åŠ åˆ°æœªæ’åº binï¼Œæ£€æŸ¥ `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`free(): corrupted unsorted chunks`

## `do_check_malloc_state`

* **åœ¨ `do_check_malloc_state` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœæœªå¯¹é½çš„å¿«é€Ÿ bin å—ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`do_check_malloc_state(): unaligned fastbin chunk detected`

## `malloc_consolidate`

* **åœ¨ `malloc_consolidate` ä¸­çš„æ£€æŸ¥ï¼š**
* å¦‚æœæœªå¯¹é½çš„å¿«é€Ÿ bin å—ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc_consolidate(): unaligned fastbin chunk detected`
* å¦‚æœå¿«é€Ÿ bin å—å¤§å°ä¸æ­£ç¡®ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`malloc_consolidate(): invalid chunk size`

## `_int_realloc`

* **åœ¨ `_int_realloc` ä¸­çš„æ£€æŸ¥ï¼š**
* å¤§å°å¤ªå¤§æˆ–å¤ªå°ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`realloc(): invalid old size`
* ä¸‹ä¸€ä¸ªå—çš„å¤§å°å¤ªå¤§æˆ–å¤ªå°ï¼š
* é”™è¯¯ä¿¡æ¯ï¼š`realloc(): invalid next size`

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
