# ヒープ関数のセキュリティチェック

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

## unlink

詳細については次を確認してください:

{% content-ref url="unlink.md" %}
[unlink.md](unlink.md)
{% endcontent-ref %}

これは実行されたチェックの要約です:

* チャンクの指定されたサイズが、次のチャンクに指定された`prev_size`と同じかどうかを確認します
* エラーメッセージ: `corrupted size vs. prev_size`
* `P->fd->bk == P`および`P->bk->fw == P`も確認します
* エラーメッセージ: `corrupted double-linked list`
* チャンクが小さくない場合、`P->fd_nextsize->bk_nextsize == P`および`P->bk_nextsize->fd_nextsize == P`を確認します
* エラーメッセージ: `corrupted double-linked list (not small)`

## \_int\_malloc

詳細については次を確認してください:

{% content-ref url="malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](malloc-and-sysmalloc.md)
{% endcontent-ref %}

* **ファストビン検索中のチェック:**
* チャンクがアラインメントされていない場合:
* エラーメッセージ: `malloc(): unaligned fastbin chunk detected 2`
* フォワードチャンクがアラインメントされていない場合:
* エラーメッセージ: `malloc(): unaligned fastbin chunk detected`
* ファストビン内のインデックスによってサイズが正しくない返されたチャンクの場合:
* エラーメッセージ: `malloc(): memory corruption (fast)`
* Tcacheを埋めるために使用される任意のチャンクがアラインメントされていない場合:
* エラーメッセージ: `malloc(): unaligned fastbin chunk detected 3`
* **スモールビン検索中のチェック:**
* `victim->bk->fd != victim`の場合:
* エラーメッセージ: `malloc(): smallbin double linked list corrupted`
* **コンソリデート中のチェック** ファストビンチャンクごとに実行されます:&#x20;
* チャンクがアラインメントされていない場合:
* エラーメッセージ: `malloc_consolidate(): unaligned fastbin chunk detected`
* インデックスによって正しいサイズでない場合:
* エラーメッセージ: `malloc_consolidate(): invalid chunk size`
* 前のチャンクが使用されておらず、前のチャンクのサイズがprev\_chunkによって指定されたサイズと異なる場合:
* エラーメッセージ: `corrupted size vs. prev_size in fastbins`
* **アンソートビン検索中のチェック**:
* チャンクサイズが奇妙な場合（小さすぎるか大きすぎるか）:&#x20;
* エラーメッセージ: `malloc(): invalid size (unsorted)`
* 次のチャンクサイズが奇妙な場合（小さすぎるか大きすぎるか）:
* エラーメッセージ: `malloc(): invalid next size (unsorted)`
* 次のチャンクによって指定された前のサイズがチャンクのサイズと異なる場合:
* エラーメッセージ: `malloc(): mismatching next->prev_size (unsorted)`
* `victim->bck->fd == victim`または`victim->fd == av (arena)`でない場合:
* エラーメッセージ: `malloc(): unsorted double linked list corrupted`
* 常に最後のものをチェックしているため、そのfdは常にアリーナ構造体を指している必要があります。
* 次のチャンクが前のチャンクが使用中であることを示していない場合:
* エラーメッセージ: `malloc(): invalid next->prev_inuse (unsorted)`
* `fwd->bk_nextsize->fd_nextsize != fwd`の場合:
* エラーメッセージ: `malloc(): largebin double linked list corrupted (nextsize)`
* `fwd->bk->fd != fwd`の場合:
* エラーメッセージ: `malloc(): largebin double linked list corrupted (bk)`
* **大きなビン（インデックス別）検索中のチェック:**
* `bck->fd-> bk != bck`の場合:
* エラーメッセージ: `malloc(): corrupted unsorted chunks`
* **大きなビン（次の大きなもの）検索中のチェック:**
* `bck->fd-> bk != bck`の場合:
* エラーメッセージ: `malloc(): corrupted unsorted chunks2`
* **トップチャンク使用中のチェック:**
* `chunksize(av->top) > av->system_mem`の場合:
* エラーメッセージ: `malloc(): corrupted top size`

## `tcache_get_n`

* **`tcache_get_n`でのチェック:**
* チャンクがアラインメントされていない場合:
* エラーメッセージ: `malloc(): unaligned tcache chunk detected`

## `tcache_thread_shutdown`

* **`tcache_thread_shutdown`でのチェック:**
* チャンクがアラインメントされていない場合:
* エラーメッセージ: `tcache_thread_shutdown(): unaligned tcache chunk detected`

## `__libc_realloc`

* **`__libc_realloc`でのチェック:**
* 古いポインタがアラインメントされていないかサイズが正しくない場合:
* エラーメッセージ: `realloc(): invalid pointer`

## `_int_free`

詳細については次を確認してください:

{% content-ref url="free.md" %}
[free.md](free.md)
{% endcontent-ref %}

* **`_int_free`の開始時のチェック:**
* ポインタがアラインメントされている:
* エラーメッセージ: `free(): invalid pointer`
* `MINSIZE`より大きいサイズで、かつサイズもアラインメントされている:
* エラーメッセージ: `free(): invalid size`
* **`_int_free` tcacheでのチェック:**
* `mp_.tcache_count`よりもエントリが多い場合:
* エラーメッセージ: `free(): too many chunks detected in tcache`
* エントリがアラインメントされていない場合:
* エラーメッセージ: `free(): unaligned chunk detected in tcache 2`
* 解放されたチャンクがすでに解放されており、tcache内のチャンクとして存在する場合:
* エラーメッセージ: `free(): double free detected in tcache 2`
* **`_int_free`ファストビンでのチェック:**
* チャンクのサイズが無効（大きすぎるか小さすぎる）の場合:
* エラーメッセージ: `free(): invalid next size (fast)`
* 追加されたチャンクがすでにファストビンのトップにある場合:
* エラーメッセージ: `double free or corruption (fasttop)`
* トップのチャンクのサイズが追加しているチャンクのサイズと異なる場合:
* エラーメッセージ: `invalid fastbin entry (free)`
## **`_int_free_merge_chunk`**

* **`_int_free_merge_chunk`でのチェック:**
* チャンクがトップチャンクである場合:
* エラーメッセージ: `double free or corruption (top)`
* 次のチャンクがアリーナの境界外にある場合:
* エラーメッセージ: `double free or corruption (out)`
* チャンクが使用中としてマークされていない場合（次のチャンクの`prev_inuse`による）:
* エラーメッセージ: `double free or corruption (!prev)`
* 次のチャンクがサイズが小さすぎるか大きすぎる場合:
* エラーメッセージ: `free(): invalid next size (normal)`
* 前のチャンクが使用中でない場合、統合を試みます。ただし、`prev_size`が前のチャンクで示されているサイズと異なる場合:
* エラーメッセージ: `corrupted size vs. prev_size while consolidating`

## **`_int_free_create_chunk`**

* **`_int_free_create_chunk`でのチェック:**
* 未整列ビンにチャンクを追加する際、`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`をチェックします:
* エラーメッセージ: `free(): corrupted unsorted chunks`

## `do_check_malloc_state`

* **`do_check_malloc_state`でのチェック:**
* アラインメントが間違った高速ビンチャンクの場合:
* エラーメッセージ: `do_check_malloc_state(): unaligned fastbin chunk detected`

## `malloc_consolidate`

* **`malloc_consolidate`でのチェック:**
* アラインメントが間違った高速ビンチャンクの場合:
* エラーメッセージ: `malloc_consolidate(): unaligned fastbin chunk detected`
* 不正な高速ビンチャンクサイズの場合:
* エラーメッセージ: `malloc_consolidate(): invalid chunk size`

## `_int_realloc`

* **`_int_realloc`でのチェック:**
* サイズが大きすぎるか小さすぎる場合:
* エラーメッセージ: `realloc(): invalid old size`
* 次のチャンクのサイズが大きすぎるか小さすぎる場合:
* エラーメッセージ: `realloc(): invalid next size`
