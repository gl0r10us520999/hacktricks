# Comprobaciones de Seguridad de Funciones de Heap

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## unlink

Para m치s informaci칩n consulta:

{% content-ref url="unlink.md" %}
[unlink.md](unlink.md)
{% endcontent-ref %}

Este es un resumen de las comprobaciones realizadas:

* Verifica si el tama침o indicado del chunk es el mismo que el `prev_size` indicado en el siguiente chunk
* Mensaje de error: `corrupted size vs. prev_size`
* Verifica tambi칠n que `P->fd->bk == P` y `P->bk->fw == P`
* Mensaje de error: `corrupted double-linked list`
* Si el chunk no es peque침o, verifica que `P->fd_nextsize->bk_nextsize == P` y `P->bk_nextsize->fd_nextsize == P`
* Mensaje de error: `corrupted double-linked list (not small)`

## \_int\_malloc

Para m치s informaci칩n consulta:

{% content-ref url="malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](malloc-and-sysmalloc.md)
{% endcontent-ref %}

* **Comprobaciones durante la b칰squeda en fast bin:**
* Si el chunk est치 desalineado:
* Mensaje de error: `malloc(): unaligned fastbin chunk detected 2`
* Si el chunk hacia adelante est치 desalineado:
* Mensaje de error: `malloc(): unaligned fastbin chunk detected`
* Si el chunk devuelto tiene un tama침o que no es correcto debido a su 칤ndice en el fast bin:
* Mensaje de error: `malloc(): memory corruption (fast)`
* Si alg칰n chunk utilizado para llenar el tcache est치 desalineado:
* Mensaje de error: `malloc(): unaligned fastbin chunk detected 3`
* **Comprobaciones durante la b칰squeda en small bin:**
* Si `victim->bk->fd != victim`:
* Mensaje de error: `malloc(): smallbin double linked list corrupted`
* **Comprobaciones durante la consolidaci칩n** realizadas para cada chunk de fast bin:&#x20;
* Si el chunk est치 desalineado, activa:
* Mensaje de error: `malloc_consolidate(): unaligned fastbin chunk detected`
* Si el chunk tiene un tama침o diferente al que deber칤a debido al 칤ndice en el que se encuentra:
* Mensaje de error: `malloc_consolidate(): invalid chunk size`
* Si el chunk anterior no est치 en uso y el chunk anterior tiene un tama침o diferente al indicado por prev\_chunk:
* Mensaje de error: `corrupted size vs. prev_size in fastbins`
* **Comprobaciones durante la b칰squeda en unsorted bin**:
* Si el tama침o del chunk es extra침o (demasiado peque침o o demasiado grande):&#x20;
* Mensaje de error: `malloc(): invalid size (unsorted)`
* Si el tama침o del siguiente chunk es extra침o (demasiado peque침o o demasiado grande):
* Mensaje de error: `malloc(): invalid next size (unsorted)`
* Si el tama침o anterior indicado por el siguiente chunk difiere del tama침o del chunk:
* Mensaje de error: `malloc(): mismatching next->prev_size (unsorted)`
* Si no `victim->bck->fd == victim` o no `victim->fd == av (arena)`:
* Mensaje de error: `malloc(): unsorted double linked list corrupted`
* Como siempre estamos verificando el 칰ltimo, su fd deber칤a estar apuntando siempre a la estructura de arena.
* Si el siguiente chunk no indica que el anterior est치 en uso:
* Mensaje de error: `malloc(): invalid next->prev_inuse (unsorted)`
* Si `fwd->bk_nextsize->fd_nextsize != fwd`:
* Mensaje de error: `malloc(): largebin double linked list corrupted (nextsize)`
* Si `fwd->bk->fd != fwd`:
* Mensaje de error: `malloc(): largebin double linked list corrupted (bk)`
* **Comprobaciones durante la b칰squeda en large bin (por 칤ndice):**
* `bck->fd-> bk != bck`:
* Mensaje de error: `malloc(): corrupted unsorted chunks`
* **Comprobaciones durante la b칰squeda en large bin (siguiente m치s grande):**
* `bck->fd-> bk != bck`:
* Mensaje de error: `malloc(): corrupted unsorted chunks2`
* **Comprobaciones durante el uso del Top chunk:**
* `chunksize(av->top) > av->system_mem`:
* Mensaje de error: `malloc(): corrupted top size`

## `tcache_get_n`

* **Comprobaciones en `tcache_get_n`:**
* Si el chunk est치 desalineado:
* Mensaje de error: `malloc(): unaligned tcache chunk detected`

## `tcache_thread_shutdown`

* **Comprobaciones en `tcache_thread_shutdown`:**
* Si el chunk est치 desalineado:
* Mensaje de error: `tcache_thread_shutdown(): unaligned tcache chunk detected`

## `__libc_realloc`

* **Comprobaciones en `__libc_realloc`:**
* Si el puntero antiguo est치 desalineado o el tama침o era incorrecto:
* Mensaje de error: `realloc(): invalid pointer`

## `_int_free`

Para m치s informaci칩n consulta:

{% content-ref url="free.md" %}
[free.md](free.md)
{% endcontent-ref %}

* **Comprobaciones al inicio de `_int_free`:**
* El puntero est치 alineado:
* Mensaje de error: `free(): invalid pointer`
* Tama침o mayor que `MINSIZE` y tama침o tambi칠n alineado:
* Mensaje de error: `free(): invalid size`
* **Comprobaciones en `_int_free` tcache:**
* Si hay m치s entradas que `mp_.tcache_count`:
* Mensaje de error: `free(): too many chunks detected in tcache`
* Si la entrada no est치 alineada:
* Mensaje de error: `free(): unaligned chunk detected in tcache 2`
* Si el chunk liberado ya fue liberado y est치 presente como chunk en el tcache:
* Mensaje de error: `free(): double free detected in tcache 2`
* **Comprobaciones en `_int_free` fast bin:**
* Si el tama침o del chunk es inv치lido (demasiado grande o peque침o) activa:
* Mensaje de error: `free(): invalid next size (fast)`
* Si el chunk agregado ya era el top del fast bin:
* Mensaje de error: `double free or corruption (fasttop)`
* Si el tama침o del chunk en la parte superior tiene un tama침o diferente al del chunk que estamos agregando:
* Mensaje de error: `invalid fastbin entry (free)`

## **`_int_free_merge_chunk`**

* **Comprobaciones en `_int_free_merge_chunk`:**
* Si el chunk es el top chunk:
* Mensaje de error: `double free or corruption (top)`
* Si el siguiente chunk est치 fuera de los l칤mites de la arena:
* Mensaje de error: `double free or corruption (out)`
* Si el chunk no est치 marcado como usado (en el prev\_inuse del siguiente chunk):
* Mensaje de error: `double free or corruption (!prev)`
* Si el siguiente chunk tiene un tama침o demasiado peque침o o demasiado grande:
* Mensaje de error: `free(): invalid next size (normal)`
* Si el chunk anterior no est치 en uso, intentar치 consolidar. Pero, si el `prev_size` difiere del tama침o indicado en el chunk anterior:
* Mensaje de error: `corrupted size vs. prev_size while consolidating`

## **`_int_free_create_chunk`**

* **Comprobaciones en `_int_free_create_chunk`:**
* Al agregar un chunk en el unsorted bin, verifica si `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`:
* Mensaje de error: `free(): corrupted unsorted chunks`

## `do_check_malloc_state`

* **Comprobaciones en `do_check_malloc_state`:**
* Si el chunk de fast bin est치 desalineado:
* Mensaje de error: `do_check_malloc_state(): unaligned fastbin chunk detected`

## `malloc_consolidate`

* **Comprobaciones en `malloc_consolidate`:**
* Si el chunk de fast bin est치 desalineado:
* Mensaje de error: `malloc_consolidate(): unaligned fastbin chunk detected`
* Si el tama침o del chunk de fast bin es incorrecto:
* Mensaje de error: `malloc_consolidate(): invalid chunk size`

## `_int_realloc`

* **Comprobaciones en `_int_realloc`:**
* El tama침o es demasiado grande o demasiado peque침o:
* Mensaje de error: `realloc(): invalid old size`
* El tama침o del siguiente chunk es demasiado grande o demasiado peque침o:
* Mensaje de error: `realloc(): invalid next size`

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
