# Kontrole bezpiecze켻stwa funkcji sterty

{% hint style="success" %}
Ucz si캧 i 캖wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si캧 i 캖wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd콬 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do켹캔cz do** 游눫 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **콑led콬** nas na **Twitterze** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si캧 sztuczkami hackingowymi, przesy켹aj캔c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori칩w github.

</details>
{% endhint %}

## unlink

Aby uzyska캖 wi캧cej informacji, sprawd콬:

{% content-ref url="unlink.md" %}
[unlink.md](unlink.md)
{% endcontent-ref %}

To jest podsumowanie przeprowadzonych kontroli:

* Sprawd콬, czy wskazany rozmiar kawa켹ka jest taki sam jak `prev_size` wskazany w nast캧pnym kawa켹ku
* Komunikat o b켹캧dzie: `corrupted size vs. prev_size`
* Sprawd콬 r칩wnie콮, czy `P->fd->bk == P` i `P->bk->fw == P`
* Komunikat o b켹캧dzie: `corrupted double-linked list`
* Je콑li kawa켹ek nie jest ma켹y, sprawd콬, czy `P->fd_nextsize->bk_nextsize == P` i `P->bk_nextsize->fd_nextsize == P`
* Komunikat o b켹캧dzie: `corrupted double-linked list (not small)`

## \_int\_malloc

Aby uzyska캖 wi캧cej informacji, sprawd콬:

{% content-ref url="malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](malloc-and-sysmalloc.md)
{% endcontent-ref %}

* **Kontrole podczas szybkiego wyszukiwania binarnego:**
* Je콑li kawa켹ek jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `malloc(): unaligned fastbin chunk detected 2`
* Je콑li kawa켹ek do przodu jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `malloc(): unaligned fastbin chunk detected`
* Je콑li zwr칩cony kawa켹ek ma rozmiar, kt칩ry nie jest poprawny z powodu jego indeksu w szybkim binie:
* Komunikat o b켹캧dzie: `malloc(): memory corruption (fast)`
* Je콑li jakikolwiek kawa켹ek u콮yty do wype켹nienia tcache jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `malloc(): unaligned fastbin chunk detected 3`
* **Kontrole podczas wyszukiwania ma켹ych bin칩w:**
* Je콑li `victim->bk->fd != victim`:
* Komunikat o b켹캧dzie: `malloc(): smallbin double linked list corrupted`
* **Kontrole podczas konsolidacji** przeprowadzane dla ka콮dego kawa켹ka szybkiego binu:&#x20;
* Je콑li kawa켹ek jest 콬le wyr칩wnany, wyzw칩l:
* Komunikat o b켹캧dzie: `malloc_consolidate(): unaligned fastbin chunk detected`
* Je콑li kawa켹ek ma inny rozmiar ni콮 ten, kt칩ry powinien mie캖 z powodu indeksu, w kt칩rym si캧 znajduje:
* Komunikat o b켹캧dzie: `malloc_consolidate(): invalid chunk size`
* Je콑li poprzedni kawa켹ek nie jest u콮ywany, a poprzedni kawa켹ek ma rozmiar r칩콮ny od tego wskazanego przez prev\_chunk:
* Komunikat o b켹캧dzie: `corrupted size vs. prev_size in fastbins`
* **Kontrole podczas wyszukiwania nieposortowanego binu**:
* Je콑li rozmiar kawa켹ka jest dziwny (za ma켹y lub za du콮y):&#x20;
* Komunikat o b켹캧dzie: `malloc(): invalid size (unsorted)`
* Je콑li rozmiar nast캧pnego kawa켹ka jest dziwny (za ma켹y lub za du콮y):
* Komunikat o b켹캧dzie: `malloc(): invalid next size (unsorted)`
* Je콑li poprzedni rozmiar wskazany przez nast캧pny kawa켹ek r칩콮ni si캧 od rozmiaru kawa켹ka:
* Komunikat o b켹캧dzie: `malloc(): mismatching next->prev_size (unsorted)`
* Je콑li nie `victim->bck->fd == victim` lub nie `victim->fd == av (arena)`:
* Komunikat o b켹캧dzie: `malloc(): unsorted double linked list corrupted`
* Poniewa콮 zawsze sprawdzamy ostatni, jego fd powinno zawsze wskazywa캖 na struktur캧 areny.
* Je콑li nast캧pny kawa켹ek nie wskazuje, 콮e poprzedni jest u콮ywany:
* Komunikat o b켹캧dzie: `malloc(): invalid next->prev_inuse (unsorted)`
* Je콑li `fwd->bk_nextsize->fd_nextsize != fwd`:
* Komunikat o b켹캧dzie: `malloc(): largebin double linked list corrupted (nextsize)`
* Je콑li `fwd->bk->fd != fwd`:
* Komunikat o b켹캧dzie: `malloc(): largebin double linked list corrupted (bk)`
* **Kontrole podczas wyszukiwania du콮ego binu (wed켹ug indeksu):**
* `bck->fd-> bk != bck`:
* Komunikat o b켹캧dzie: `malloc(): corrupted unsorted chunks`
* **Kontrole podczas wyszukiwania du콮ego binu (nast캧pny wi캧kszy):**
* `bck->fd-> bk != bck`:
* Komunikat o b켹캧dzie: `malloc(): corrupted unsorted chunks2`
* **Kontrole podczas u콮ycia Top chunk:**
* `chunksize(av->top) > av->system_mem`:
* Komunikat o b켹캧dzie: `malloc(): corrupted top size`

## `tcache_get_n`

* **Kontrole w `tcache_get_n`:**
* Je콑li kawa켹ek jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `malloc(): unaligned tcache chunk detected`

## `tcache_thread_shutdown`

* **Kontrole w `tcache_thread_shutdown`:**
* Je콑li kawa켹ek jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `tcache_thread_shutdown(): unaligned tcache chunk detected`

## `__libc_realloc`

* **Kontrole w `__libc_realloc`:**
* Je콑li stary wska콬nik jest 콬le wyr칩wnany lub rozmiar by켹 niepoprawny:
* Komunikat o b켹캧dzie: `realloc(): invalid pointer`

## `_int_free`

Aby uzyska캖 wi캧cej informacji, sprawd콬:

{% content-ref url="free.md" %}
[free.md](free.md)
{% endcontent-ref %}

* **Kontrole na pocz캔tku `_int_free`:**
* Wska콬nik jest wyr칩wnany:
* Komunikat o b켹캧dzie: `free(): invalid pointer`
* Rozmiar wi캧kszy ni콮 `MINSIZE` i rozmiar r칩wnie콮 wyr칩wnany:
* Komunikat o b켹캧dzie: `free(): invalid size`
* **Kontrole w `_int_free` tcache:**
* Je콑li jest wi캧cej wpis칩w ni콮 `mp_.tcache_count`:
* Komunikat o b켹캧dzie: `free(): too many chunks detected in tcache`
* Je콑li wpis nie jest wyr칩wnany:
* Komunikat o b켹캧dzie: `free(): unaligned chunk detected in tcache 2`
* Je콑li zwolniony kawa켹ek by켹 ju콮 zwolniony i jest obecny jako kawa켹ek w tcache:
* Komunikat o b켹캧dzie: `free(): double free detected in tcache 2`
* **Kontrole w `_int_free` szybkim binie:**
* Je콑li rozmiar kawa켹ka jest niepoprawny (za du콮y lub za ma켹y), wyzw칩l:
* Komunikat o b켹캧dzie: `free(): invalid next size (fast)`
* Je콑li dodany kawa켹ek by켹 ju콮 na szczycie szybkiego binu:
* Komunikat o b켹캧dzie: `double free or corruption (fasttop)`
* Je콑li rozmiar kawa켹ka na szczycie ma inny rozmiar ni콮 kawa켹ek, kt칩ry dodajemy:
* Komunikat o b켹캧dzie: `invalid fastbin entry (free)`

## **`_int_free_merge_chunk`**

* **Kontrole w `_int_free_merge_chunk`:**
* Je콑li kawa켹ek jest kawa켹kiem szczytowym:
* Komunikat o b켹캧dzie: `double free or corruption (top)`
* Je콑li nast캧pny kawa켹ek jest poza granicami areny:
* Komunikat o b켹캧dzie: `double free or corruption (out)`
* Je콑li kawa켹ek nie jest oznaczony jako u콮ywany (w prev\_inuse z nast캧puj캔cego kawa켹ka):
* Komunikat o b켹캧dzie: `double free or corruption (!prev)`
* Je콑li nast캧pny kawa켹ek ma zbyt ma켹y lub zbyt du콮y rozmiar:
* Komunikat o b켹캧dzie: `free(): invalid next size (normal)`
* Je콑li poprzedni kawa켹ek nie jest u콮ywany, spr칩buje skonsolidowa캖. Ale je콑li `prev_size` r칩콮ni si캧 od rozmiaru wskazanego w poprzednim kawa켹ku:
* Komunikat o b켹캧dzie: `corrupted size vs. prev_size while consolidating`

## **`_int_free_create_chunk`**

* **Kontrole w `_int_free_create_chunk`:**
* Dodaj캔c kawa켹ek do nieposortowanego binu, sprawd콬, czy `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`:
* Komunikat o b켹캧dzie: `free(): corrupted unsorted chunks`

## `do_check_malloc_state`

* **Kontrole w `do_check_malloc_state`:**
* Je콑li kawa켹ek szybkiego binu jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `do_check_malloc_state(): unaligned fastbin chunk detected`

## `malloc_consolidate`

* **Kontrole w `malloc_consolidate`:**
* Je콑li kawa켹ek szybkiego binu jest 콬le wyr칩wnany:
* Komunikat o b켹캧dzie: `malloc_consolidate(): unaligned fastbin chunk detected`
* Je콑li rozmiar kawa켹ka szybkiego binu jest niepoprawny:
* Komunikat o b켹캧dzie: `malloc_consolidate(): invalid chunk size`

## `_int_realloc`

* **Kontrole w `_int_realloc`:**
* Rozmiar jest za du콮y lub za ma켹y:
* Komunikat o b켹캧dzie: `realloc(): invalid old size`
* Rozmiar nast캧pnego kawa켹ka jest za du콮y lub za ma켹y:
* Komunikat o b켹캧dzie: `realloc(): invalid next size`

{% hint style="success" %}
Ucz si캧 i 캖wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si캧 i 캖wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd콬 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do켹캔cz do** 游눫 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **콑led콬** nas na **Twitterze** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si캧 sztuczkami hackingowymi, przesy켹aj캔c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori칩w github.

</details>
{% endhint %}
