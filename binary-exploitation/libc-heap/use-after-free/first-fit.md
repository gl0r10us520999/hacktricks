# First Fit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **First Fit**

Kada oslobodite memoriju u programu koristeÄ‡i glibc, razliÄiti "bins" se koriste za upravljanje delovima memorije. Evo pojednostavljenog objaÅ¡njenja dva uobiÄajena scenarija: nesortirani bins i fastbins.

### Nesortirani Bins

Kada oslobodite deo memorije koji nije fast chunk, on ide u nesortirani bin. Ovaj bin deluje kao lista gde se novi osloboÄ‘eni delovi dodaju na poÄetak (na "glavu"). Kada zatraÅ¾ite novi deo memorije, alokator gleda u nesortirani bin od pozadi (na "rep") da pronaÄ‘e deo koji je dovoljno velik. Ako je deo iz nesortiranog bina veÄ‡i od onoga Å¡to vam treba, on se deli, pri Äemu se prednji deo vraÄ‡a, a preostali deo ostaje u binu.

Primer:

* Alocirate 300 bajtova (`a`), zatim 250 bajtova (`b`), oslobodite `a` i ponovo zatraÅ¾ite 250 bajtova (`c`).
* Kada oslobodite `a`, on ide u nesortirani bin.
* Ako zatim ponovo zatraÅ¾ite 250 bajtova, alokator pronalazi `a` na repu i deli ga, vraÄ‡ajuÄ‡i deo koji odgovara vaÅ¡em zahtevu i zadrÅ¾avajuÄ‡i ostatak u binu.
* `c` Ä‡e pokazivati na prethodni `a` i biti ispunjen `a's`.
```c
char *a = malloc(300);
char *b = malloc(250);
free(a);
char *c = malloc(250);
```
### Fastbins

Fastbins se koriste za male delove memorije. Za razliku od nesortiranih binova, fastbins dodaju nove delove na poÄetak, stvarajuÄ‡i ponaÅ¡anje poslednji unutra - prvi napolju (LIFO). Ako zatraÅ¾ite mali deo memorije, alokator Ä‡e uzeti iz vrha fastbina.

Primer:

* Alocirate Äetiri dela od po 20 bajtova (`a`, `b`, `c`, `d`).
* Kada ih oslobodite u bilo kom redosledu, osloboÄ‘eni delovi se dodaju na vrh fastbina.
* Ako zatim zatraÅ¾ite deo od 20 bajtova, alokator Ä‡e vratiti najnovije osloboÄ‘eni deo iz vrha fastbina.
```c
char *a = malloc(20);
char *b = malloc(20);
char *c = malloc(20);
char *d = malloc(20);
free(a);
free(b);
free(c);
free(d);
a = malloc(20);   // d
b = malloc(20);   // c
c = malloc(20);   // b
d = malloc(20);   // a
```
## Ostale reference i primeri

* [**https://heap-exploitation.dhavalkapil.com/attacks/first\_fit**](https://heap-exploitation.dhavalkapil.com/attacks/first\_fit)
* [**https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/**](https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/)
* ARM64. KorisniÄka upotreba nakon oslobaÄ‘anja: GeneriÅ¡ite korisniÄki objekat, oslobodite ga, generiÅ¡ite objekat koji dobija osloboÄ‘eni deo i omoguÄ‡ite pisanje u njega, **prepisujuÄ‡i poziciju user->password** iz prethodnog. Ponovno koristite korisnika da **obiÄ‘ete proveru lozinke**
* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example)
* Program omoguÄ‡ava kreiranje beleÅ¡ki. BeleÅ¡ka Ä‡e imati informacije o beleÅ¡ci u malloc(8) (sa pokazivaÄem na funkciju koja moÅ¾e biti pozvana) i pokazivaÄ na drugi malloc(\<size>) sa sadrÅ¾ajem beleÅ¡ke.
* Napad bi bio da se kreiraju 2 beleÅ¡ke (note0 i note1) sa veÄ‡im malloc sadrÅ¾ajem od veliÄine informacija o beleÅ¡ci i zatim ih osloboditi kako bi uÅ¡le u brzi bin (ili tcache).
* Zatim, kreirajte joÅ¡ jednu beleÅ¡ku (note2) sa veliÄinom sadrÅ¾aja 8. SadrÅ¾aj Ä‡e biti u note1 jer Ä‡e se deo ponovo koristiti, gde bismo mogli da modifikujemo pokazivaÄ funkcije da pokazuje na win funkciju i zatim Use-After-Free note1 da pozovemo novi pokazivaÄ funkcije.
* [**https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html)
* MoguÄ‡e je alocirati neku memoriju, napisati Å¾eljenu vrednost, osloboditi je, ponovo alocirati i poÅ¡to su prethodni podaci joÅ¡ uvek tu, biÄ‡e tretirani prema novoj oÄekivanoj strukturi u delu, Å¡to omoguÄ‡ava postavljanje vrednosti za dobijanje zastavice.
* [**https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html)
* U ovom sluÄaju potrebno je napisati 4 unutar specifiÄnog dela koji je prvi koji se alocira (Äak i nakon prisilnog oslobaÄ‘anja svih njih). Na svakom novom alociranom delu, njegov broj u indeksu niza se Äuva. Zatim, alocirajte 4 dela (+ inicijalno alocirani), poslednji Ä‡e imati 4 unutar njega, oslobodite ih i prisilite ponovnu alokaciju prvog, koji Ä‡e koristiti poslednji osloboÄ‘eni deo koji je onaj sa 4 unutar njega.
