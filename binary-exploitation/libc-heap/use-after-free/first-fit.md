# First Fit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **First Fit**

í”„ë¡œê·¸ë¨ì—ì„œ glibcë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•  ë•Œ, ì„œë¡œ ë‹¤ë¥¸ "ë¹ˆ"ì´ ë©”ëª¨ë¦¬ ì²­í¬ë¥¼ ê´€ë¦¬í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ë‹¤ìŒì€ ë‘ ê°€ì§€ ì¼ë°˜ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì…ë‹ˆë‹¤: ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆê³¼ íŒ¨ìŠ¤íŠ¸ ë¹ˆ.

### ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆ

íŒ¨ìŠ¤íŠ¸ ì²­í¬ê°€ ì•„ë‹Œ ë©”ëª¨ë¦¬ ì²­í¬ë¥¼ í•´ì œí•˜ë©´ ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ì´ ë¹ˆì€ ìƒˆë¡œ í•´ì œëœ ì²­í¬ê°€ ì•ìª½(â€œí—¤ë“œâ€)ì— ì¶”ê°€ë˜ëŠ” ëª©ë¡ì²˜ëŸ¼ ì‘ìš©í•©ë‹ˆë‹¤. ìƒˆ ë©”ëª¨ë¦¬ ì²­í¬ë¥¼ ìš”ì²­í•  ë•Œ, í• ë‹¹ìëŠ” ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆì˜ ë’¤ìª½(â€œí…Œì¼â€)ì—ì„œ ì¶©ë¶„íˆ í° ì²­í¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤. ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆì˜ ì²­í¬ê°€ í•„ìš”í•œ ê²ƒë³´ë‹¤ í¬ë©´, ì•ë¶€ë¶„ì´ ë°˜í™˜ë˜ê³  ë‚˜ë¨¸ì§€ ë¶€ë¶„ì€ ë¹ˆì— ë‚¨ìŠµë‹ˆë‹¤.

ì˜ˆì‹œ:

* 300 ë°”ì´íŠ¸(`a`)ë¥¼ í• ë‹¹í•œ í›„ 250 ë°”ì´íŠ¸(`b`)ë¥¼ í• ë‹¹í•˜ê³  `a`ë¥¼ í•´ì œí•œ í›„ ë‹¤ì‹œ 250 ë°”ì´íŠ¸(`c`)ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
* `a`ë¥¼ í•´ì œí•˜ë©´ ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
* ê·¸ í›„ ë‹¤ì‹œ 250 ë°”ì´íŠ¸ë¥¼ ìš”ì²­í•˜ë©´, í• ë‹¹ìëŠ” í…Œì¼ì—ì„œ `a`ë¥¼ ì°¾ì•„ ë¶„í• í•˜ì—¬ ìš”ì²­ì— ë§ëŠ” ë¶€ë¶„ì„ ë°˜í™˜í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë¹ˆì— ë‚¨ê¹ë‹ˆë‹¤.
* `c`ëŠ” ì´ì „ì˜ `a`ë¥¼ ê°€ë¦¬í‚¤ë©° `a`ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
```c
char *a = malloc(300);
char *b = malloc(250);
free(a);
char *c = malloc(250);
```
### Fastbins

Fastbinsì€ ì‘ì€ ë©”ëª¨ë¦¬ ì²­í¬ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆê³¼ ë‹¬ë¦¬, fastbinsì€ ìƒˆë¡œìš´ ì²­í¬ë¥¼ í—¤ë“œì— ì¶”ê°€í•˜ì—¬ í›„ì…ì„ ì¶œ(LIFO) ë™ì‘ì„ ìƒì„±í•©ë‹ˆë‹¤. ì‘ì€ ë©”ëª¨ë¦¬ ì²­í¬ë¥¼ ìš”ì²­í•˜ë©´, í• ë‹¹ìëŠ” fastbinì˜ í—¤ë“œì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.

Example:

* 20ë°”ì´íŠ¸ í¬ê¸°ì˜ ì²­í¬ë¥¼ ë„¤ ê°œ í• ë‹¹í•©ë‹ˆë‹¤(`a`, `b`, `c`, `d`).
* ì–´ë–¤ ìˆœì„œë¡œ í•´ì œí•˜ë“  í•´ì œëœ ì²­í¬ëŠ” fastbinì˜ í—¤ë“œì— ì¶”ê°€ë©ë‹ˆë‹¤.
* ê·¸ í›„ 20ë°”ì´íŠ¸ ì²­í¬ë¥¼ ìš”ì²­í•˜ë©´, í• ë‹¹ìëŠ” fastbinì˜ í—¤ë“œì—ì„œ ê°€ì¥ ìµœê·¼ì— í•´ì œëœ ì²­í¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
```c
char *a = malloc(20);
char *b = malloc(20);
char *c = malloc(20);
char *d = malloc(20);
free(a);
free(b);
free(c);
free(d);
a = malloc(20);   // d
b = malloc(20);   // c
c = malloc(20);   // b
d = malloc(20);   // a
```
## ê¸°íƒ€ ì°¸ê³ ìë£Œ ë° ì˜ˆì œ

* [**https://heap-exploitation.dhavalkapil.com/attacks/first\_fit**](https://heap-exploitation.dhavalkapil.com/attacks/first\_fit)
* [**https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/**](https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/)
* ARM64. Use after free: ì‚¬ìš©ì ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ í•´ì œí•œ í›„, í•´ì œëœ ì²­í¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì´ë¥¼ ì“¸ ìˆ˜ ìˆë„ë¡ í•˜ì—¬, **ì´ì „ì˜ user->password ìœ„ì¹˜ë¥¼ ë®ì–´ì”Œì›ë‹ˆë‹¤.** ì‚¬ìš©ìë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ **ë¹„ë°€ë²ˆí˜¸ ê²€ì‚¬ë¥¼ ìš°íšŒí•©ë‹ˆë‹¤.**
* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example)
* í”„ë¡œê·¸ë¨ì€ ë…¸íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë…¸íŠ¸ëŠ” malloc(8)ì—ì„œ ë…¸íŠ¸ ì •ë³´ì™€ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ê°€ì§€ë©°, ë…¸íŠ¸ì˜ ë‚´ìš©ì„ ê°€ì§„ ë‹¤ë¥¸ malloc(\<size>)ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
* ê³µê²©ì€ ë…¸íŠ¸ ì •ë³´ í¬ê¸°ë³´ë‹¤ í° malloc ë‚´ìš©ì„ ê°€ì§„ 2ê°œì˜ ë…¸íŠ¸(note0 ë° note1)ë¥¼ ìƒì„±í•œ í›„, ì´ë¥¼ í•´ì œí•˜ì—¬ ë¹ ë¥¸ ë¹ˆ(fast bin) ë˜ëŠ” tcacheì— ë“¤ì–´ê°€ê²Œ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, ë‚´ìš© í¬ê¸°ê°€ 8ì¸ ë˜ ë‹¤ë¥¸ ë…¸íŠ¸(note2)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë‚´ìš©ì€ note1ì— ìˆì„ ê²ƒì´ë©°, ì²­í¬ê°€ ì¬ì‚¬ìš©ë˜ë¯€ë¡œ í•¨ìˆ˜ í¬ì¸í„°ë¥¼ win í•¨ìˆ˜ë¡œ ê°€ë¦¬í‚¤ë„ë¡ ìˆ˜ì •í•  ìˆ˜ ìˆê³ , ì´í›„ note1ì„ Use-After-Freeí•˜ì—¬ ìƒˆë¡œìš´ í•¨ìˆ˜ í¬ì¸í„°ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
* [**https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html)
* ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê³  ì›í•˜ëŠ” ê°’ì„ ì“°ê³ , í•´ì œí•œ í›„ ì¬í• ë‹¹í•  ìˆ˜ ìˆìœ¼ë©°, ì´ì „ ë°ì´í„°ê°€ ì—¬ì „íˆ ì¡´ì¬í•˜ë¯€ë¡œ ì²­í¬ì˜ ìƒˆë¡œìš´ ì˜ˆìƒ êµ¬ì¡°ì— ë”°ë¼ ì²˜ë¦¬ë˜ì–´ ê°’ì„ ì„¤ì •í•˜ê±°ë‚˜ í”Œë˜ê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [**https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html)
* ì´ ê²½ìš°, íŠ¹ì • ì²­í¬ì— 4ë¥¼ ì¨ì•¼ í•˜ë©°, ì´ëŠ” í• ë‹¹ëœ ì²« ë²ˆì§¸ ì²­í¬ì…ë‹ˆë‹¤(ëª¨ë“  ì²­í¬ë¥¼ ê°•ì œë¡œ í•´ì œí•œ í›„ì—ë„). ê° ìƒˆë¡œ í• ë‹¹ëœ ì²­í¬ì˜ ë°°ì—´ ì¸ë±ìŠ¤ì— ë²ˆí˜¸ê°€ ì €ì¥ë©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ 4ê°œì˜ ì²­í¬(+ ì²˜ìŒ í• ë‹¹ëœ ì²­í¬)ë¥¼ í• ë‹¹í•˜ê³ , ë§ˆì§€ë§‰ ì²­í¬ì—ëŠ” 4ê°€ ë“¤ì–´ ìˆìœ¼ë©°, ì´ë¥¼ í•´ì œí•˜ê³  ì²« ë²ˆì§¸ ì²­í¬ì˜ ì¬í• ë‹¹ì„ ê°•ì œë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì´ë•Œ ë§ˆì§€ë§‰ìœ¼ë¡œ í•´ì œëœ ì²­í¬ê°€ 4ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.
