# First Fit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **First Fit**

glibcã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã®ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾ã™ã‚‹ã¨ã€ç•°ãªã‚‹ã€Œãƒ“ãƒ³ã€ãŒãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ã€ä¸€èˆ¬çš„ãª2ã¤ã®ã‚·ãƒŠãƒªã‚ªï¼šæœªæ•´åˆ—ãƒ“ãƒ³ã¨ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã®ç°¡ç•¥åŒ–ã•ã‚ŒãŸèª¬æ˜ã‚’ç¤ºã—ã¾ã™ã€‚

### æœªæ•´åˆ—ãƒ“ãƒ³

ãƒ•ã‚¡ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯ã§ãªã„ãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹ã¨ã€ãã‚Œã¯æœªæ•´åˆ—ãƒ“ãƒ³ã«å…¥ã‚Šã¾ã™ã€‚ã“ã®ãƒ“ãƒ³ã¯ã€æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒå‰æ–¹ï¼ˆã€Œãƒ˜ãƒƒãƒ‰ã€ï¼‰ã«è¿½åŠ ã•ã‚Œã‚‹ãƒªã‚¹ãƒˆã®ã‚ˆã†ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚æ–°ã—ã„ãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’è¦æ±‚ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯æœªæ•´åˆ—ãƒ“ãƒ³ã®å¾Œæ–¹ï¼ˆã€Œãƒ†ã‚¤ãƒ«ã€ï¼‰ã‚’è¦‹ã¦ã€ååˆ†ãªå¤§ãã•ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æ¢ã—ã¾ã™ã€‚æœªæ•´åˆ—ãƒ“ãƒ³ã®ãƒãƒ£ãƒ³ã‚¯ãŒå¿…è¦ãªã‚µã‚¤ã‚ºã‚ˆã‚Šå¤§ãã„å ´åˆã€ãã‚Œã¯åˆ†å‰²ã•ã‚Œã€å‰ã®éƒ¨åˆ†ãŒè¿”ã•ã‚Œã€æ®‹ã‚Šã®éƒ¨åˆ†ã¯ãƒ“ãƒ³ã«æ®‹ã‚Šã¾ã™ã€‚

ä¾‹ï¼š

* 300ãƒã‚¤ãƒˆï¼ˆ`a`ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã€æ¬¡ã«250ãƒã‚¤ãƒˆï¼ˆ`b`ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã€`a`ã‚’è§£æ”¾ã—ã€å†åº¦250ãƒã‚¤ãƒˆï¼ˆ`c`ï¼‰ã‚’è¦æ±‚ã—ã¾ã™ã€‚
* `a`ã‚’è§£æ”¾ã™ã‚‹ã¨ã€ãã‚Œã¯æœªæ•´åˆ—ãƒ“ãƒ³ã«å…¥ã‚Šã¾ã™ã€‚
* ãã®å¾Œã€å†åº¦250ãƒã‚¤ãƒˆã‚’è¦æ±‚ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯ãƒ†ã‚¤ãƒ«ã«ã‚ã‚‹`a`ã‚’è¦‹ã¤ã‘ã¦åˆ†å‰²ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åˆã†éƒ¨åˆ†ã‚’è¿”ã—ã€æ®‹ã‚Šã‚’ãƒ“ãƒ³ã«ä¿æŒã—ã¾ã™ã€‚
* `c`ã¯ä»¥å‰ã®`a`ã‚’æŒ‡ã—ã€`a`ã®å†…å®¹ã§åŸ‹ã‚ã‚‰ã‚Œã¾ã™ã€‚
```c
char *a = malloc(300);
char *b = malloc(250);
free(a);
char *c = malloc(250);
```
### Fastbins

Fastbinsã¯å°ã•ãªãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æœªã‚½ãƒ¼ãƒˆãƒ“ãƒ³ã¨ã¯ç•°ãªã‚Šã€fastbinsã¯æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’å…ˆé ­ã«è¿½åŠ ã—ã€å¾Œå…¥ã‚Œå…ˆå‡ºã—ï¼ˆLIFOï¼‰å‹•ä½œã‚’ä½œæˆã—ã¾ã™ã€‚å°ã•ãªãƒ¡ãƒ¢ãƒªãƒãƒ£ãƒ³ã‚¯ã‚’è¦æ±‚ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯fastbinã®å…ˆé ­ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚

Example:

* ã‚ãªãŸã¯ãã‚Œãã‚Œ20ãƒã‚¤ãƒˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’4ã¤ï¼ˆ`a`ã€`b`ã€`c`ã€`d`ï¼‰å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
* ãã‚Œã‚‰ã‚’ä»»æ„ã®é †åºã§è§£æ”¾ã™ã‚‹ã¨ã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯fastbinã®å…ˆé ­ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
* ãã®å¾Œã€20ãƒã‚¤ãƒˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’è¦æ±‚ã™ã‚‹ã¨ã€ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯fastbinã®å…ˆé ­ã‹ã‚‰æœ€ã‚‚æœ€è¿‘è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’è¿”ã—ã¾ã™ã€‚
```c
char *a = malloc(20);
char *b = malloc(20);
char *c = malloc(20);
char *d = malloc(20);
free(a);
free(b);
free(c);
free(d);
a = malloc(20);   // d
b = malloc(20);   // c
c = malloc(20);   // b
d = malloc(20);   // a
```
## ãã®ä»–ã®å‚è€ƒæ–‡çŒ®ã¨ä¾‹

* [**https://heap-exploitation.dhavalkapil.com/attacks/first\_fit**](https://heap-exploitation.dhavalkapil.com/attacks/first\_fit)
* [**https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/**](https://8ksec.io/arm64-reversing-and-exploitation-part-2-use-after-free/)
* ARM64. Use after free: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã€ãã‚Œã‚’è§£æ”¾ã—ã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã¦æ›¸ãè¾¼ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã€**å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®user->passwordã®ä½ç½®ã‚’ä¸Šæ›¸ã**ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å†åˆ©ç”¨ã—ã¦**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹**ã—ã¾ã™ã€‚
* [**https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example**](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/use\_after\_free/#example)
* ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¾ã™ã€‚ãƒãƒ¼ãƒˆã«ã¯ã€malloc(8)å†…ã«ãƒãƒ¼ãƒˆæƒ…å ±ãŒã‚ã‚Šï¼ˆå‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹é–¢æ•°ã¸ã®ãƒã‚¤ãƒ³ã‚¿ä»˜ãï¼‰ã€ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’æŒã¤åˆ¥ã®malloc(\<size>)ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚
* æ”»æ’ƒã¯ã€ãƒãƒ¼ãƒˆæƒ…å ±ã‚µã‚¤ã‚ºã‚ˆã‚Šã‚‚å¤§ããªmallocå†…å®¹ã‚’æŒã¤2ã¤ã®ãƒãƒ¼ãƒˆï¼ˆnote0ã¨note1ï¼‰ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’è§£æ”¾ã—ã¦ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ï¼ˆã¾ãŸã¯tcacheï¼‰ã«å…¥ã‚Œã‚‹ã“ã¨ã§ã™ã€‚
* æ¬¡ã«ã€å†…å®¹ã‚µã‚¤ã‚º8ã®åˆ¥ã®ãƒãƒ¼ãƒˆï¼ˆnote2ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚å†…å®¹ã¯note1ã«ã‚ã‚Šã€ãƒãƒ£ãƒ³ã‚¯ãŒå†åˆ©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’winé–¢æ•°ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã€ãã®å¾Œnote1ã‚’Use-After-Freeã—ã¦æ–°ã—ã„é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
* [**https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/pico\_areyouroot/index.html)
* ãƒ¡ãƒ¢ãƒªã‚’å‰²ã‚Šå½“ã¦ã€å¸Œæœ›ã®å€¤ã‚’æ›¸ãè¾¼ã¿ã€ãã‚Œã‚’è§£æ”¾ã—ã€å†å‰²ã‚Šå½“ã¦ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãã“ã«ã‚ã‚‹ãŸã‚ã€ãƒãƒ£ãƒ³ã‚¯å†…ã®æ–°ã—ã„æœŸå¾…ã•ã‚Œã‚‹æ§‹é€ ã«å¾“ã£ã¦å‡¦ç†ã•ã‚Œã€å€¤ã‚’è¨­å®šã—ã¦ãƒ•ãƒ©ã‚°ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
* [**https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html**](https://guyinatuxedo.github.io/26-heap\_grooming/swamp19\_heapgolf/index.html)
* ã“ã®å ´åˆã€ç‰¹å®šã®ãƒãƒ£ãƒ³ã‚¯å†…ã«4ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯æœ€åˆã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚‚ã®ã§ã‚ã‚Šï¼ˆã™ã¹ã¦ã‚’å¼·åˆ¶çš„ã«è§£æ”¾ã—ãŸå¾Œã§ã‚‚ï¼‰ã€æ–°ã—ãå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå„ãƒãƒ£ãƒ³ã‚¯ã®é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†…ã®ç•ªå·ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚æ¬¡ã«ã€4ã¤ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆæœ€åˆã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚‚ã®ã‚’å«ã‚€ï¼‰ã‚’å‰²ã‚Šå½“ã¦ã€æœ€å¾Œã®ã‚‚ã®ã«ã¯4ãŒå«ã¾ã‚Œã€ãã®å¾Œãã‚Œã‚‰ã‚’è§£æ”¾ã—ã€æœ€åˆã®ã‚‚ã®ã®å†å‰²ã‚Šå½“ã¦ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æœ€å¾Œã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ã•ã‚Œã€ãã®ä¸­ã«4ãŒå«ã¾ã‚Œã¾ã™ã€‚
