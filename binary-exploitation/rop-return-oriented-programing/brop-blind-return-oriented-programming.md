# BROP - Blind Return Oriented Programming

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

æ­¤æ”»å‡»çš„ç›®æ ‡æ˜¯èƒ½å¤Ÿ**é€šè¿‡ç¼“å†²åŒºæº¢å‡ºæ»¥ç”¨ ROPï¼Œè€Œæ— éœ€ä»»ä½•å…³äºæ˜“å—æ”»å‡»äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¿¡æ¯**ã€‚\
æ­¤æ”»å‡»åŸºäºä»¥ä¸‹åœºæ™¯ï¼š

* ä¸€ä¸ªæ ˆæ¼æ´å’Œè§¦å‘å®ƒçš„çŸ¥è¯†ã€‚
* ä¸€ä¸ªåœ¨å´©æºƒåé‡å¯çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚

## æ”»å‡»

### **1. æ‰¾åˆ°æ˜“å—æ”»å‡»çš„åç§»** å‘é€ä¸€ä¸ªå­—ç¬¦ï¼Œç›´åˆ°æ£€æµ‹åˆ°æœåŠ¡å™¨æ•…éšœ

### **2. æš´åŠ›ç ´è§£ canary** ä»¥æ³„éœ²å®ƒ

### **3. æš´åŠ›ç ´è§£å­˜å‚¨çš„ RBP å’Œ RIP** åœ°å€ä»¥æ³„éœ²å®ƒä»¬

æ‚¨å¯ä»¥åœ¨ [è¿™é‡Œ (BF Forked & Threaded Stack Canaries)](../common-binary-protections-and-bypasses/stack-canaries/bf-forked-stack-canaries.md) å’Œ [è¿™é‡Œ (BF Addresses in the Stack)](../common-binary-protections-and-bypasses/pie/bypassing-canary-and-pie.md) æ‰¾åˆ°æœ‰å…³è¿™äº›è¿‡ç¨‹çš„æ›´å¤šä¿¡æ¯ã€‚

### **4. æ‰¾åˆ°åœæ­¢ gadget**

è¿™ä¸ª gadget åŸºæœ¬ä¸Šå…è®¸ç¡®è®¤ ROP gadget æ‰§è¡Œäº†æŸäº›æœ‰è¶£çš„å†…å®¹ï¼Œå› ä¸ºæ‰§è¡Œæ²¡æœ‰å´©æºƒã€‚é€šå¸¸ï¼Œè¿™ä¸ª gadget å°†æ˜¯**åœæ­¢æ‰§è¡Œ**çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨å¯»æ‰¾ ROP gadget æ—¶ä½äº ROP é“¾çš„æœ«å°¾ï¼Œä»¥ç¡®è®¤ç‰¹å®šçš„ ROP gadget è¢«æ‰§è¡Œã€‚

### **5. æ‰¾åˆ° BROP gadget**

æ­¤æŠ€æœ¯ä½¿ç”¨ [**ret2csu**](ret2csu.md) gadgetã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæ‚¨åœ¨æŸäº›æŒ‡ä»¤ä¸­é—´è®¿é—®æ­¤ gadgetï¼Œæ‚¨å°†è·å¾—æ§åˆ¶**`rsi`**å’Œ**`rdi`**çš„ gadgetï¼š

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="278"><figcaption><p><a href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">https://www.scs.stanford.edu/brop/bittau-brop.pdf</a></p></figcaption></figure>

è¿™äº›å°†æ˜¯ gadgetï¼š

* `pop rsi; pop r15; ret`
* `pop rdi; ret`

æ³¨æ„ï¼Œé€šè¿‡è¿™äº› gadget å¯ä»¥**æ§åˆ¶ 2 ä¸ªå‚æ•°**çš„å‡½æ•°è°ƒç”¨ã€‚

æ­¤å¤–ï¼Œè¯·æ³¨æ„ ret2csu gadget å…·æœ‰**éå¸¸ç‹¬ç‰¹çš„ç­¾å**ï¼Œå› ä¸ºå®ƒå°†ä»æ ˆä¸­å¼¹å‡º 6 ä¸ªå¯„å­˜å™¨ã€‚å› æ­¤ï¼Œå‘é€ä¸€ä¸ªé“¾å¦‚ï¼š

`'A' * offset + canary + rbp + ADDR + 0xdead * 6 + STOP`

å¦‚æœ**STOP è¢«æ‰§è¡Œ**ï¼Œè¿™åŸºæœ¬ä¸Šæ„å‘³ç€ä½¿ç”¨äº†ä¸€ä¸ª**ä»æ ˆä¸­å¼¹å‡º 6 ä¸ªå¯„å­˜å™¨çš„åœ°å€**ã€‚æˆ–è€…ä½¿ç”¨çš„åœ°å€ä¹Ÿæ˜¯ä¸€ä¸ª STOP åœ°å€ã€‚

ä¸ºäº†**æ¶ˆé™¤è¿™ä¸ªæœ€åçš„é€‰é¡¹**ï¼Œæ‰§è¡Œä¸€ä¸ªæ–°çš„é“¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¹¶ä¸”å®ƒå¿…é¡»ä¸æ‰§è¡Œ STOP gadget ä»¥ç¡®è®¤å‰ä¸€ä¸ªç¡®å®å¼¹å‡ºäº† 6 ä¸ªå¯„å­˜å™¨ï¼š

`'A' * offset + canary + rbp + ADDR`

çŸ¥é“ ret2csu gadget çš„åœ°å€ï¼Œå¯ä»¥**æ¨æ–­å‡ºæ§åˆ¶ `rsi` å’Œ `rdi` çš„ gadget çš„åœ°å€**ã€‚

### 6. æ‰¾åˆ° PLT

PLT è¡¨å¯ä»¥ä» 0x400000 æˆ–ä»æ ˆä¸­**æ³„éœ²çš„ RIP åœ°å€**è¿›è¡Œæœç´¢ï¼ˆå¦‚æœ**PIE**æ­£åœ¨ä½¿ç”¨ï¼‰ã€‚è¡¨çš„**æ¡ç›®**æ˜¯**æ¯ 16B åˆ†éš”**ï¼ˆ0x10Bï¼‰ï¼Œå½“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå³ä½¿å‚æ•°ä¸æ­£ç¡®ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šå´©æºƒã€‚æ­¤å¤–ï¼Œæ£€æŸ¥ä¸€ä¸ªæ¡ç›®çš„åœ°å€åœ¨**PLT + 6B ä¹Ÿä¸ä¼šå´©æºƒ**ï¼Œå› ä¸ºè¿™æ˜¯æ‰§è¡Œçš„ç¬¬ä¸€æ®µä»£ç ã€‚

å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ä»¥ä¸‹è¡Œä¸ºæ‰¾åˆ° PLT è¡¨ï¼š

* `'A' * offset + canary + rbp + ADDR + STOP` -> ä¸å´©æºƒ
* `'A' * offset + canary + rbp + (ADDR + 0x6) + STOP` -> ä¸å´©æºƒ
* `'A' * offset + canary + rbp + (ADDR + 0x10) + STOP` -> ä¸å´©æºƒ

### 7. æ‰¾åˆ° strcmp

**`strcmp`** å‡½æ•°å°†å¯„å­˜å™¨ **`rdx`** è®¾ç½®ä¸ºæ­£åœ¨æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œ**`rdx`** æ˜¯**ç¬¬ä¸‰ä¸ªå‚æ•°**ï¼Œæˆ‘ä»¬éœ€è¦å®ƒ**å¤§äº 0**ï¼Œä»¥ä¾¿ç¨åä½¿ç”¨ `write` æ¥æ³„éœ²ç¨‹åºã€‚

å¯ä»¥æ ¹æ®å…¶è¡Œä¸ºåœ¨ PLT ä¸­æ‰¾åˆ° **`strcmp`** çš„ä½ç½®ï¼Œåˆ©ç”¨æˆ‘ä»¬ç°åœ¨å¯ä»¥æ§åˆ¶å‡½æ•°çš„å‰ä¸¤ä¸ªå‚æ•°çš„äº‹å®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> ä¸å´©æºƒ

å¯ä»¥é€šè¿‡è°ƒç”¨ PLT è¡¨çš„æ¯ä¸ªæ¡ç›®æˆ–ä½¿ç”¨**PLT æ…¢è·¯å¾„**æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œæ…¢è·¯å¾„åŸºæœ¬ä¸Šæ˜¯**è°ƒç”¨ PLT è¡¨ä¸­çš„ä¸€ä¸ªæ¡ç›® + 0xb**ï¼ˆè¿™ä¼šè°ƒç”¨**`dlresolve`**ï¼‰ï¼Œç„¶ååœ¨æ ˆä¸­è·Ÿéš**å¸Œæœ›æ¢æµ‹çš„æ¡ç›®ç¼–å·**ï¼ˆä»é›¶å¼€å§‹ï¼‰ä»¥æ‰«ææ‰€æœ‰ PLT æ¡ç›®ï¼š

* strcmp(\<éè¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0x300) + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP` -> å°†å´©æºƒ
* strcmp(\<è¯»å–åœ°å€>, \<éè¯»å–åœ°å€>) -> å´©æºƒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + p64(0x300) + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`
* strcmp(\<è¯»å–åœ°å€>, \<è¯»å–åœ°å€>) -> ä¸å´©æºƒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`

è¯·è®°ä½ï¼š

* BROP + 0x7 æŒ‡å‘ **`pop RSI; pop R15; ret;`**
* BROP + 0x9 æŒ‡å‘ **`pop RDI; ret;`**
* PLT + 0xb æŒ‡å‘å¯¹ **dl\_resolve** çš„è°ƒç”¨ã€‚

æ‰¾åˆ° `strcmp` åï¼Œå¯ä»¥å°† **`rdx`** è®¾ç½®ä¸ºå¤§äº 0 çš„å€¼ã€‚

{% hint style="success" %}
è¯·æ³¨æ„ï¼Œé€šå¸¸ `rdx` ä¼šå·²ç»åŒ…å«ä¸€ä¸ªå¤§äº 0 çš„å€¼ï¼Œå› æ­¤è¿™ä¸€æ­¥å¯èƒ½ä¸æ˜¯å¿…è¦çš„ã€‚
{% endhint %}

### 8. æ‰¾åˆ° Write æˆ–ç­‰æ•ˆå‡½æ•°

æœ€åï¼Œéœ€è¦ä¸€ä¸ª gadget æ¥å¤–æ³„æ•°æ®ï¼Œä»¥ä¾¿å¤–æ³„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚åœ¨æ­¤æ—¶ï¼Œå¯ä»¥**æ§åˆ¶ 2 ä¸ªå‚æ•°å¹¶å°† `rdx` è®¾ç½®ä¸ºå¤§äº 0**ã€‚

æœ‰ 3 ä¸ªå¸¸è§çš„å‡½æ•°å¯ä»¥è¢«æ»¥ç”¨ï¼š

* `puts(data)`
* `dprintf(fd, data)`
* `write(fd, data, len(data)`

ç„¶è€Œï¼ŒåŸå§‹è®ºæ–‡åªæåˆ°**`write`**ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è°ˆè°ˆå®ƒï¼š

å½“å‰çš„é—®é¢˜æ˜¯æˆ‘ä»¬ä¸çŸ¥é“**write å‡½æ•°åœ¨ PLT ä¸­çš„ä½ç½®**ï¼Œä¹Ÿä¸çŸ¥é“**å‘é€æ•°æ®åˆ°æˆ‘ä»¬å¥—æ¥å­—çš„ fd å·ç **ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬çŸ¥é“**PLT è¡¨çš„ä½ç½®**ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®å…¶**è¡Œä¸º**æ‰¾åˆ° writeã€‚æˆ‘ä»¬å¯ä»¥ä¸æœåŠ¡å™¨åˆ›å»º**å¤šä¸ªè¿æ¥**ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª**é«˜ FD**ï¼Œå¸Œæœ›å®ƒä¸æˆ‘ä»¬çš„ä¸€äº›è¿æ¥åŒ¹é…ã€‚

æ‰¾åˆ°è¿™äº›å‡½æ•°çš„è¡Œä¸ºç­¾åï¼š

* `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0) + p64(0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> å¦‚æœæœ‰æ•°æ®æ‰“å°ï¼Œåˆ™æ‰¾åˆ°äº† puts
* `'A' * offset + canary + rbp + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> å¦‚æœæœ‰æ•°æ®æ‰“å°ï¼Œåˆ™æ‰¾åˆ°äº† dprintf
* `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + (RIP + 0x1) + p64(0x0) + (PLT + 0xb ) + p64(STRCMP ENTRY) + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> å¦‚æœæœ‰æ•°æ®æ‰“å°ï¼Œåˆ™æ‰¾åˆ°äº† write

## è‡ªåŠ¨åˆ©ç”¨

* [https://github.com/Hakumarachi/Bropper](https://github.com/Hakumarachi/Bropper)

## å‚è€ƒæ–‡çŒ®

* åŸå§‹è®ºæ–‡ï¼š[https://www.scs.stanford.edu/brop/bittau-brop.pdf](https://www.scs.stanford.edu/brop/bittau-brop.pdf)
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
