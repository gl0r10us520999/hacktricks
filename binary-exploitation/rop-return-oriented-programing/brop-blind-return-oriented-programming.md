# BROP - Blind Return Oriented Programming

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

ì´ ê³µê²©ì˜ ëª©í‘œëŠ” **ì·¨ì•½í•œ ë°”ì´ë„ˆë¦¬ì— ëŒ€í•œ ì •ë³´ ì—†ì´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ í†µí•´ ROPë¥¼ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥**ì…ë‹ˆë‹¤.\
ì´ ê³µê²©ì€ ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤:

* ìŠ¤íƒ ì·¨ì•½ì ê³¼ ì´ë¥¼ ìœ ë°œí•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì§€ì‹.
* ì¶©ëŒ í›„ ì¬ì‹œì‘ë˜ëŠ” ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜.

## ê³µê²©

### **1. ì·¨ì•½í•œ ì˜¤í”„ì…‹ ì°¾ê¸°** ì„œë²„ì˜ ì˜¤ì‘ë™ì´ ê°ì§€ë  ë•Œê¹Œì§€ í•œ ë¬¸ìë¥¼ ë” ë³´ë‚´ê¸°

### **2. ì¹´ë‚˜ë¦¬ ë¬´ì°¨ë³„ ëŒ€ì…** ì´ë¥¼ ìœ ì¶œí•˜ê¸° ìœ„í•´

### **3. ìŠ¤íƒì—ì„œ ì €ì¥ëœ RBP ë° RIP** ì£¼ì†Œë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í•˜ì—¬ ìœ ì¶œí•˜ê¸°

ì´ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” [ì—¬ê¸° (BF Forked & Threaded Stack Canaries)](../common-binary-protections-and-bypasses/stack-canaries/bf-forked-stack-canaries.md)ì™€ [ì—¬ê¸° (BF Addresses in the Stack)](../common-binary-protections-and-bypasses/pie/bypassing-canary-and-pie.md)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### **4. ì •ì§€ ê°€ì ¯ ì°¾ê¸°**

ì´ ê°€ì ¯ì€ ê¸°ë³¸ì ìœ¼ë¡œ ROP ê°€ì ¯ì— ì˜í•´ í¥ë¯¸ë¡œìš´ ê²ƒì´ ì‹¤í–‰ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì‹¤í–‰ì´ ì¶©ëŒí•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ê°€ì ¯ì€ **ì‹¤í–‰ì„ ì¤‘ì§€í•˜ëŠ”** ê²ƒì´ë©°, íŠ¹ì • ROP ê°€ì ¯ì´ ì‹¤í–‰ë˜ì—ˆìŒì„ í™•ì¸í•˜ê¸° ìœ„í•´ ROP ì²´ì¸ì˜ ëì— ìœ„ì¹˜í•©ë‹ˆë‹¤.

### **5. BROP ê°€ì ¯ ì°¾ê¸°**

ì´ ê¸°ìˆ ì€ [**ret2csu**](ret2csu.md) ê°€ì ¯ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” ì´ ê°€ì ¯ì— ì ‘ê·¼í•˜ë©´ **`rsi`**ì™€ **`rdi`**ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” ê°€ì ¯ì„ ì–»ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="278"><figcaption><p><a href="https://www.scs.stanford.edu/brop/bittau-brop.pdf">https://www.scs.stanford.edu/brop/bittau-brop.pdf</a></p></figcaption></figure>

ì´ê²ƒë“¤ì´ ê°€ì ¯ì…ë‹ˆë‹¤:

* `pop rsi; pop r15; ret`
* `pop rdi; ret`

ì´ ê°€ì ¯ì„ ì‚¬ìš©í•˜ë©´ í•¨ìˆ˜ í˜¸ì¶œì˜ **2ê°œì˜ ì¸ìë¥¼ ì œì–´í•  ìˆ˜** ìˆìŒì„ ì£¼ëª©í•˜ì„¸ìš”.

ë˜í•œ, ret2csu ê°€ì ¯ì€ **ë§¤ìš° ë…íŠ¹í•œ ì„œëª…**ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ ìŠ¤íƒì—ì„œ 6ê°œì˜ ë ˆì§€ìŠ¤í„°ë¥¼ íŒí•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì²´ì¸ì„ ë³´ë‚´ë©´:

`'A' * offset + canary + rbp + ADDR + 0xdead * 6 + STOP`

**STOPì´ ì‹¤í–‰ë˜ë©´**, ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **ìŠ¤íƒì—ì„œ 6ê°œì˜ ë ˆì§€ìŠ¤í„°ë¥¼ íŒí•˜ëŠ” ì£¼ì†Œ**ê°€ ì‚¬ìš©ë˜ì—ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë˜ëŠ” ì‚¬ìš©ëœ ì£¼ì†Œê°€ ë˜í•œ STOP ì£¼ì†Œì˜€ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì´ ë§ˆì§€ë§‰ ì˜µì…˜ì„ **ì œê±°í•˜ê¸° ìœ„í•´** ë‹¤ìŒê³¼ ê°™ì€ ìƒˆë¡œìš´ ì²´ì¸ì´ ì‹¤í–‰ë˜ë©°, ì´ì „ ê²ƒì´ 6ê°œì˜ ë ˆì§€ìŠ¤í„°ë¥¼ íŒí–ˆìŒì„ í™•ì¸í•˜ê¸° ìœ„í•´ STOP ê°€ì ¯ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤:

`'A' * offset + canary + rbp + ADDR`

ret2csu ê°€ì ¯ì˜ ì£¼ì†Œë¥¼ ì•Œë©´ **`rsi`ì™€ `rdi`ë¥¼ ì œì–´í•  ê°€ì ¯ì˜ ì£¼ì†Œë¥¼ ìœ ì¶”í•  ìˆ˜** ìˆìŠµë‹ˆë‹¤.

### 6. PLT ì°¾ê¸°

PLT í…Œì´ë¸”ì€ 0x400000 ë˜ëŠ” ìŠ¤íƒì—ì„œ **ìœ ì¶œëœ RIP ì£¼ì†Œ**ì—ì„œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë§Œì•½ **PIE**ê°€ ì‚¬ìš©ë˜ê³  ìˆë‹¤ë©´). í…Œì´ë¸”ì˜ **í•­ëª©**ì€ **16B** (0x10B)ë¡œ êµ¬ë¶„ë˜ì–´ ìˆìœ¼ë©°, í•˜ë‚˜ì˜ í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œ ì„œë²„ëŠ” ì¸ìê°€ ì˜¬ë°”ë¥´ì§€ ì•Šë”ë¼ë„ ì¶©ëŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë˜í•œ, **PLT + 6Bì˜ ì£¼ì†Œë¥¼ í™•ì¸í•´ë„ ì¶©ëŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ì´ëŠ” ì²« ë²ˆì§¸ ì½”ë“œê°€ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ë‹¤ìŒ ë™ì‘ì„ í™•ì¸í•˜ì—¬ PLT í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* `'A' * offset + canary + rbp + ADDR + STOP` -> ì¶©ëŒ ì—†ìŒ
* `'A' * offset + canary + rbp + (ADDR + 0x6) + STOP` -> ì¶©ëŒ ì—†ìŒ
* `'A' * offset + canary + rbp + (ADDR + 0x10) + STOP` -> ì¶©ëŒ ì—†ìŒ

### 7. strcmp ì°¾ê¸°

**`strcmp`** í•¨ìˆ˜ëŠ” ë¹„êµë˜ëŠ” ë¬¸ìì—´ì˜ ê¸¸ì´ë¥¼ ë ˆì§€ìŠ¤í„° **`rdx`**ì— ì„¤ì •í•©ë‹ˆë‹¤. **`rdx`**ëŠ” **ì„¸ ë²ˆì§¸ ì¸ì**ì´ë©°, ë‚˜ì¤‘ì— `write`ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œê·¸ë¨ì„ ìœ ì¶œí•˜ê¸° ìœ„í•´ **0ë³´ë‹¤ ì»¤ì•¼** í•©ë‹ˆë‹¤.

ì´ì œ í•¨ìˆ˜ì˜ ì²« ë‘ ì¸ìë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” ì‚¬ì‹¤ì„ ë°”íƒ•ìœ¼ë¡œ PLTì—ì„œ **`strcmp`**ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* strcmp(\<non read addr>, \<non read addr>) -> ì¶©ëŒ
* strcmp(\<non read addr>, \<read addr>) -> ì¶©ëŒ
* strcmp(\<read addr>, \<non read addr>) -> ì¶©ëŒ
* strcmp(\<read addr>, \<read addr>) -> ì¶©ëŒ ì—†ìŒ

PLT í…Œì´ë¸”ì˜ ê° í•­ëª©ì„ í˜¸ì¶œí•˜ê±°ë‚˜ **PLT ëŠë¦° ê²½ë¡œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **PLT í…Œì´ë¸”ì˜ í•­ëª© + 0xb** (ì´ëŠ” **`dlresolve`**ë¥¼ í˜¸ì¶œí•¨) í›„ ìŠ¤íƒì— **íƒìƒ‰í•˜ê³ ì í•˜ëŠ” í•­ëª© ë²ˆí˜¸** (0ë¶€í„° ì‹œì‘)ë¥¼ ë°°ì¹˜í•˜ì—¬ ëª¨ë“  PLT í•­ëª©ì„ ìŠ¤ìº”í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

* strcmp(\<non read addr>, \<read addr>) -> ì¶©ëŒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0x300) + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP` -> ì¶©ëŒ
* strcmp(\<read addr>, \<non read addr>) -> ì¶©ëŒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + p64(0x300) + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`
* strcmp(\<read addr>, \<read addr>) -> ì¶©ëŒ ì—†ìŒ
* `b'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb ) + p64(ENTRY) + STOP`

ê¸°ì–µí•˜ì„¸ìš”:

* BROP + 0x7ëŠ” **`pop RSI; pop R15; ret;`**ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.
* BROP + 0x9ëŠ” **`pop RDI; ret;`**ë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤.
* PLT + 0xbëŠ” **dl\_resolve** í˜¸ì¶œì„ ê°€ë¦¬í‚µë‹ˆë‹¤.

`strcmp`ë¥¼ ì°¾ìœ¼ë©´ **`rdx`**ë¥¼ 0ë³´ë‹¤ í° ê°’ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="success" %}
ì¼ë°˜ì ìœ¼ë¡œ `rdx`ëŠ” ì´ë¯¸ 0ë³´ë‹¤ í° ê°’ì„ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ ì´ ë‹¨ê³„ëŠ” í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### 8. Write ë˜ëŠ” ë™ë“±í•œ ê²ƒ ì°¾ê¸°

ë§ˆì§€ë§‰ìœ¼ë¡œ, ë°”ì´ë„ˆë¦¬ë¥¼ ìœ ì¶œí•˜ê¸° ìœ„í•´ ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ëŠ” ê°€ì ¯ì´ í•„ìš”í•©ë‹ˆë‹¤. ì´ ì‹œì ì—ì„œ **2ê°œì˜ ì¸ìë¥¼ ì œì–´í•˜ê³  `rdx`ë¥¼ 0ë³´ë‹¤ í¬ê²Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ì´ë¥¼ ìœ„í•´ ì•…ìš©í•  ìˆ˜ ìˆëŠ” ì¼ë°˜ì ì¸ í•¨ìˆ˜ëŠ” 3ê°œê°€ ìˆìŠµë‹ˆë‹¤:

* `puts(data)`
* `dprintf(fd, data)`
* `write(fd, data, len(data)`

ê·¸ëŸ¬ë‚˜ ì›ë³¸ ë…¼ë¬¸ì—ì„œëŠ” **`write`** í•¨ìˆ˜ë§Œ ì–¸ê¸‰í•˜ë¯€ë¡œ ì´ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê² ìŠµë‹ˆë‹¤:

í˜„ì¬ ë¬¸ì œëŠ” **PLT ë‚´ì—ì„œ write í•¨ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ ëª¨ë¥¸ë‹¤ëŠ” ê²ƒ**ê³¼ **ë°ì´í„°ë¥¼ ì†Œì¼“ìœ¼ë¡œ ì „ì†¡í•  fd ë²ˆí˜¸ë¥¼ ëª¨ë¥¸ë‹¤ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ **PLT í…Œì´ë¸”ì˜ ìœ„ì¹˜ëŠ” ì•Œê³  ìˆìœ¼ë©°**, ê·¸ **í–‰ë™**ì„ ê¸°ë°˜ìœ¼ë¡œ writeë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  **ì—¬ëŸ¬ ì—°ê²°**ì„ ì„œë²„ì™€ ìƒì„±í•˜ê³  **ë†’ì€ FD**ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ì˜ ì—°ê²° ì¤‘ í•˜ë‚˜ì™€ ì¼ì¹˜í•˜ê¸°ë¥¼ í¬ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ í•¨ìˆ˜ë“¤ì„ ì°¾ê¸° ìœ„í•œ í–‰ë™ ì„œëª…:

* `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + p64(0) + p64(0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> ë°ì´í„°ê°€ ì¶œë ¥ë˜ë©´, putsê°€ ë°œê²¬ëœ ê²ƒì…ë‹ˆë‹¤.
* `'A' * offset + canary + rbp + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> ë°ì´í„°ê°€ ì¶œë ¥ë˜ë©´, dprintfê°€ ë°œê²¬ëœ ê²ƒì…ë‹ˆë‹¤.
* `'A' * offset + canary + rbp + (BROP + 0x9) + RIP + (BROP + 0x7) + (RIP + 0x1) + p64(0x0) + (PLT + 0xb ) + p64(STRCMP ENTRY) + (BROP + 0x9) + FD + (BROP + 0x7) + RIP + p64(0x0) + (PLT + 0xb) + p64(ENTRY) + STOP` -> ë°ì´í„°ê°€ ì¶œë ¥ë˜ë©´, writeê°€ ë°œê²¬ëœ ê²ƒì…ë‹ˆë‹¤.

## ìë™ ìµìŠ¤í”Œë¡œì‡

* [https://github.com/Hakumarachi/Bropper](https://github.com/Hakumarachi/Bropper)

## ì°¸ê³  ë¬¸í—Œ

* ì›ë³¸ ë…¼ë¬¸: [https://www.scs.stanford.edu/brop/bittau-brop.pdf](https://www.scs.stanford.edu/brop/bittau-brop.pdf)
* [https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop](https://www.ctfrecipes.com/pwn/stack-exploitation/arbitrary-code-execution/code-reuse-attack/blind-return-oriented-programming-brop)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
