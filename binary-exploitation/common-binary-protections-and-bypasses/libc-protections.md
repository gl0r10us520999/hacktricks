# Libc Protections

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Chunk Alignment Enforcement

**Malloc** alocira memoriju u **8-bajtnih (32-bitnih) ili 16-bajtnih (64-bitnih) grupama**. To zna캜i da se kraj chunk-ova u 32-bitnim sistemima treba uskladiti sa **0x8**, a u 64-bitnim sistemima sa **0x0**. Bezbednosna funkcija proverava da li se svaki chunk **ispravno uskla캠uje** na ovim specifi캜nim mestima pre nego 코to koristi pokaziva캜 iz bin-a.

### Security Benefits

Sprovo캠enje uskla캠ivanja chunk-ova u 64-bitnim sistemima zna캜ajno pobolj코ava bezbednost Malloc-a tako 코to **ograni캜ava postavljanje la쬹ih chunk-ova na samo 1 od svake 16 adresa**. To ote쬬va napade, posebno u scenarijima gde korisnik ima ograni캜enu kontrolu nad ulaznim vrednostima, 캜ine캖i napade slo쬰nijim i te쬰 izvodivim.

* **Fastbin Attack on \_\_malloc\_hook**

Nova pravila uskla캠ivanja u Malloc-u tako캠e spre캜avaju klasi캜an napad koji uklju캜uje `__malloc_hook`. Prethodno su napada캜i mogli manipulisati veli캜inama chunk-ova da **prepi코u ovaj pokaziva캜 funkcije** i dobiju **izvr코enje koda**. Sada, strogi zahtevi za uskla캠ivanje osiguravaju da takve manipulacije vi코e nisu mogu캖e, zatvaraju캖i uobi캜ajeni put za eksploataciju i pobolj코avaju캖i ukupnu bezbednost.

## Pointer Mangling on fastbins and tcache

**Pointer Mangling** je bezbednosno pobolj코anje koje se koristi za za코titu **fastbin i tcache Fd pokaziva캜a** u operacijama upravljanja memorijom. Ova tehnika poma쬰 u spre캜avanju odre캠enih vrsta taktika eksploatacije memorije, posebno onih koje ne zahtevaju informacije o propu코tenoj memoriji ili koje direktno manipuli코u lokacijama memorije u odnosu na poznate pozicije (relativni **prepisivanja**).

Osnova ove tehnike je formula za obfuscation:

**`New_Ptr = (L >> 12) XOR P`**

* **L** je **lokacija skladi코tenja** pokaziva캜a.
* **P** je stvarni **fastbin/tcache Fd pokaziva캜**.

Razlog za pomeranje lokacije skladi코tenja (L) za 12 bita udesno pre XOR operacije je kriti캜an. Ova manipulacija se bavi ranjivo코캖u koja je inherentna deterministi캜koj prirodi najmanje zna캜ajnih 12 bita adresa memorije, koje su obi캜no predvidljive zbog ograni캜enja arhitekture sistema. Pomeraanjem bitova, predvidljivi deo se izbacuje iz jedna캜ine, pove캖avaju캖i nasumi캜nost novog, izmenjenog pokaziva캜a i time 코tite캖i od eksploatacija koje se oslanjaju na predvidljivost ovih bitova.

Ovaj izmenjeni pokaziva캜 koristi postoje캖u nasumi캜nost koju pru쬬 **Randomizacija rasporeda adresa (ASLR)**, koja randomizuje adrese koje koriste programi kako bi ote쬬la napada캜ima da predvi캠aju raspored memorije procesa.

**Demangling** pokaziva캜a za vra캖anje originalne adrese uklju캜uje kori코캖enje iste XOR operacije. Ovde se izmenjeni pokaziva캜 tretira kao P u formuli, a kada se XOR-uje sa nepromenjenom lokacijom skladi코tenja (L), rezultira otkrivanjem originalnog pokaziva캜a. Ova simetrija u izmeni i vra캖anju osigurava da sistem mo쬰 efikasno kodirati i dekodirati pokaziva캜e bez zna캜ajnog preoptere캖enja, dok zna캜ajno pove캖ava bezbednost protiv napada koji manipuli코u pokaziva캜ima memorije.

### Security Benefits

Izmena pokaziva캜a ima za cilj da **spre캜i delimi캜na i potpuna prepisivanja pokaziva캜a u heap-u**, 코to je zna캜ajno pobolj코anje u bezbednosti. Ova funkcija uti캜e na tehnike eksploatacije na nekoliko na캜ina:

1. **Spre캜avanje Bye Byte Relativnih Prepisivanja**: Prethodno su napada캜i mogli promeniti deo pokaziva캜a da **preusmere heap chunk-ove na razli캜ite lokacije bez poznavanja ta캜nih adresa**, tehnika koja je o캜igledna u eksploataciji bez propu코tanja **House of Roman**. Sa izmenom pokaziva캜a, takva relativna prepisivanja **bez propu코tanja heap-a sada zahtevaju brute forcing**, drasti캜no smanjuju캖i verovatno캖u uspeha.
2. **Pove캖ana Te쬴na Tcache Bin/Fastbin Napada**: Uobi캜ajeni napadi koji prepisuju pokaziva캜e funkcija (poput `__malloc_hook`) manipulacijom fastbin ili tcache unosa su ote쬬ni. Na primer, napad bi mogao uklju캜ivati propu코tanje LibC adrese, osloba캠anje chunk-a u tcache bin, a zatim prepisivanje Fd pokaziva캜a da ga preusmeri na `__malloc_hook` za proizvoljno izvr코enje koda. Sa izmenom pokaziva캜a, ovi pokaziva캜i moraju biti ispravno izmenjeni, **코to zahteva propu코tanje heap-a za ta캜nu manipulaciju**, 캜ime se pove캖ava barijera za eksploataciju.
3. **Zahtev za Propu코tanjem Heap-a u Ne-Heap Lokacijama**: Kreiranje la쬹og chunk-a u ne-heap oblastima (poput steka, .bss sekcije ili PLT/GOT) sada tako캠e **zahteva propu코tanje heap-a** zbog potrebe za izmenom pokaziva캜a. Ovo produ쬬va slo쬰nost eksploatacije ovih oblasti, sli캜no zahtevu za manipulaciju LibC adresama.
4. **Propu코tanje Heap Adresa Postaje Te쬰**: Izmena pokaziva캜a ograni캜ava korisnost Fd pokaziva캜a u fastbin i tcache bin-ovima kao izvora za propu코tanje adresa heap-a. Me캠utim, pokaziva캜i u nesortiranim, malim i velikim bin-ovima ostaju neizmenjeni, pa su i dalje upotrebljivi za propu코tanje adresa. Ova promena podsti캜e napada캜e da istra쬿ju ove bin-ove za eksploatabilne informacije, iako neke tehnike mogu i dalje omogu캖iti vra캖anje pokaziva캜a pre propu코tanja, iako sa ograni캜enjima.

### **Demangling Pointers with a Heap Leak**

{% hint style="danger" %}
For a better explanation of the process [**check the original post from here**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Algorithm Overview

Formula koja se koristi za izmenu i vra캖anje pokaziva캜a je:&#x20;

**`New_Ptr = (L >> 12) XOR P`**

Gde je **L** lokacija skladi코tenja, a **P** Fd pokaziva캜. Kada se **L** pomeri udesno za 12 bita, izla쬰 najzna캜ajnije bitove **P**, zbog prirode **XOR**, koja daje 0 kada se bitovi XOR-uju sami sa sobom.

**Key Steps in the Algorithm:**

1. **Po캜etno Propu코tanje Najzna캜ajnijih Bitova**: XOR-ovanjem pomerene **L** sa **P**, efikasno dobijate gornjih 12 bitova **P** jer 캖e pomerena deo **L** biti nula, ostavljaju캖i odgovaraju캖e bitove **P** nepromenjenim.
2. **Obnova Bitova Pokaziva캜a**: Po코to je XOR reverzibilan, poznavanje rezultata i jednog od operanada omogu캖ava vam da izra캜unate drugi operand. Ova osobina se koristi za dedukciju celog skupa bitova za **P** sukcesivnim XOR-ovanjem poznatih skupova bitova sa delovima izmenjenog pokaziva캜a.
3. **Iterativno Vra캖anje**: Proces se ponavlja, svaki put koriste캖i novo otkrivene bitove **P** iz prethodnog koraka za dekodiranje slede캖eg segmenta izmenjenog pokaziva캜a, sve dok se svi bitovi ne obnove.
4. **Rukovanje Deterministi캜kim Bitovima**: Poslednjih 12 bitova **L** se gubi zbog pomeranja, ali su deterministi캜ki i mogu se rekonstruisati nakon procesa.

Mo쬰te prona캖i implementaciju ovog algoritma ovde: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)

## Pointer Guard

Pointer guard je tehnika mitigacije eksploatacije koja se koristi u glibc-u za za코titu skladi코tenih pokaziva캜a funkcija, posebno onih registrovanih pozivima biblioteka kao 코to je `atexit()`. Ova za코tita uklju캜uje me코anje pokaziva캜a XOR-ovanjem sa tajnom koja se 캜uva u podacima niti (`fs:0x30`) i primenom bitovne rotacije. Ovaj mehanizam ima za cilj da spre캜i napada캜e da preuzmu kontrolu nad tokom izvr코enja prepisivanjem pokaziva캜a funkcija.

### **Bypassing Pointer Guard with a leak**

1. **Razumevanje Operacija Pointer Guard-a:** Me코anje (izmena) pokaziva캜a se vr코i kori코캖enjem makroa `PTR_MANGLE` koji XOR-uje pokaziva캜 sa 64-bitnom tajnom i zatim vr코i levu rotaciju od 0x11 bitova. Obrnuta operacija za vra캖anje originalnog pokaziva캜a se obavlja pomo캖u `PTR_DEMANGLE`.
2. **Strategija Napada:** Napad se zasniva na pristupu poznatom plaintext-u, gde napada캜 treba da zna i originalne i izmenjene verzije pokaziva캜a da bi dedukovao tajnu kori코캖enu za izmenu.
3. **Eksploatacija Poznatih Plaintext-a:**
* **Identifikacija Fiksnih Pokaziva캜a Funkcija:** Istra쬿ju캖i izvorni kod glibc-a ili inicijalizovane tabele pokaziva캜a funkcija (poput `__libc_pthread_functions`), napada캜 mo쬰 prona캖i predvidljive pokaziva캜e funkcija.
* **Izra캜unavanje Tajne:** Koriste캖i poznati pokaziva캜 funkcije kao 코to je `__pthread_attr_destroy` i njegovu izmenjenu verziju iz tabele pokaziva캜a funkcija, tajna se mo쬰 izra캜unati obrnuto rotiraju캖i (desno rotiraju캖i) izmenjeni pokaziva캜 i zatim XOR-uju캖i ga sa adresom funkcije.
4. **Alternativni Plaintext-i:** Napada캜 mo쬰 tako캠e eksperimentisati sa izmenom pokaziva캜a sa poznatim vrednostima kao 코to su 0 ili -1 da vidi da li ove proizvode prepoznatljive obrasce u memoriji, potencijalno otkrivaju캖i tajnu kada se ovi obrasci prona캠u u dump-ovima memorije.
5. **Prakti캜na Primena:** Nakon izra캜unavanja tajne, napada캜 mo쬰 manipulirati pokaziva캜ima na kontrolisan na캜in, su코tinski zaobilaze캖i za코titu Pointer Guard u vi코edretvenoj aplikaciji sa znanjem o osnovnoj adresi libc-a i sposobno코캖u 캜itanja proizvoljnih lokacija memorije.

## References

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
