# Libc Koruma

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## ParÃ§a Hizalama ZorunluluÄŸu

**Malloc**, belleÄŸi **8 bayt (32-bit) veya 16 bayt (64-bit) gruplar halinde** ayÄ±rÄ±r. Bu, 32-bit sistemlerde parÃ§alarÄ±n sonunun **0x8** ile, 64-bit sistemlerde ise **0x0** ile hizalanmasÄ± gerektiÄŸi anlamÄ±na gelir. GÃ¼venlik Ã¶zelliÄŸi, her parÃ§anÄ±n bir bin'den bir iÅŸaretÃ§i kullanmadan Ã¶nce bu belirli konumlarda **doÄŸru hizalandÄ±ÄŸÄ±nÄ±** kontrol eder.

### GÃ¼venlik FaydalarÄ±

64-bit sistemlerde parÃ§a hizalama zorunluluÄŸu, Malloc'un gÃ¼venliÄŸini Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rarak **sahte parÃ§alarÄ±n yerleÅŸtirilmesini yalnÄ±zca her 16 adresten 1'ine sÄ±nÄ±rlamaktadÄ±r**. Bu, Ã¶zellikle kullanÄ±cÄ±nÄ±n girdi deÄŸerleri Ã¼zerinde sÄ±nÄ±rlÄ± kontrolÃ¼ olduÄŸu senaryolarda istismar Ã§abalarÄ±nÄ± karmaÅŸÄ±klaÅŸtÄ±rÄ±r ve saldÄ±rÄ±larÄ± daha karmaÅŸÄ±k ve baÅŸarÄ±lÄ± bir ÅŸekilde gerÃ§ekleÅŸtirilmesi zor hale getirir.

* **\_\_malloc\_hook Ãœzerinde Fastbin SaldÄ±rÄ±sÄ±**

Malloc'daki yeni hizalama kurallarÄ±, `__malloc_hook` ile ilgili klasik bir saldÄ±rÄ±yÄ± da engeller. Ã–nceden, saldÄ±rganlar parÃ§a boyutlarÄ±nÄ± manipÃ¼le ederek **bu iÅŸlev iÅŸaretÃ§isini** geÃ§ersiz kÄ±labilir ve **kod yÃ¼rÃ¼tme** elde edebilirlerdi. ArtÄ±k, katÄ± hizalama gereksinimi, bu tÃ¼r manipÃ¼lasyonlarÄ±n geÃ§erli olmamasÄ±nÄ± saÄŸlar, yaygÄ±n bir istismar yolunu kapatÄ±r ve genel gÃ¼venliÄŸi artÄ±rÄ±r.

## Fastbin ve Tcache Ãœzerinde Ä°ÅŸaretÃ§i KarÄ±ÅŸtÄ±rma

**Ä°ÅŸaretÃ§i KarÄ±ÅŸtÄ±rma**, bellek yÃ¶netim iÅŸlemlerinde **fastbin ve tcache Fd iÅŸaretÃ§ilerini** korumak iÃ§in kullanÄ±lan bir gÃ¼venlik geliÅŸtirmesidir. Bu teknik, sÄ±zdÄ±rÄ±lmÄ±ÅŸ bellek bilgisi gerektirmeyen veya bilinen konumlara gÃ¶re doÄŸrudan bellek konumlarÄ±nÄ± manipÃ¼le eden belirli bellek istismar taktiklerini Ã¶nlemeye yardÄ±mcÄ± olur (gÃ¶reli **geÃ§ersiz kÄ±lmalar**).

Bu tekniÄŸin Ã¶zÃ¼ bir obfuscation formÃ¼lÃ¼dÃ¼r:

**`New_Ptr = (L >> 12) XOR P`**

* **L**, iÅŸaretÃ§inin **Depolama Yeri**dir.
* **P**, gerÃ§ek **fastbin/tcache Fd Ä°ÅŸaretÃ§isidir**.

XOR iÅŸlemi Ã¶ncesinde depolama yerinin (L) 12 bit saÄŸa kaydÄ±rÄ±lmasÄ±nÄ±n nedeni kritiktir. Bu manipÃ¼lasyon, bellek adreslerinin en az anlamlÄ± 12 bitinin belirleyici doÄŸasÄ±nda var olan bir zayÄ±flÄ±ÄŸÄ± ele alÄ±r; bu bitler genellikle sistem mimarisi kÄ±sÄ±tlamalarÄ± nedeniyle tahmin edilebilir. Bitleri kaydÄ±rarak, tahmin edilebilir kÄ±sÄ±m denklemin dÄ±ÅŸÄ±na Ã§Ä±kar, yeni, karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§inin rastgeleliÄŸini artÄ±rÄ±r ve bÃ¶ylece bu bitlerin tahmin edilebilirliÄŸine dayanan istismarlarÄ±n Ã¶nÃ¼ne geÃ§er.

Bu karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§i, programlarÄ±n kullandÄ±ÄŸÄ± adresleri rastgeleleÅŸtiren **Adres AlanÄ± DÃ¼zeni RastgeleleÅŸtirmesi (ASLR)** tarafÄ±ndan saÄŸlanan mevcut rastgeleliÄŸi kullanÄ±r, bu da saldÄ±rganlarÄ±n bir sÃ¼recin bellek dÃ¼zenini tahmin etmesini zorlaÅŸtÄ±rÄ±r.

**Demangling** iÅŸlemi, orijinal adresi geri almak iÃ§in aynÄ± XOR iÅŸlemini kullanmayÄ± iÃ§erir. Burada, karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§i formÃ¼lde P olarak ele alÄ±nÄ±r ve deÄŸiÅŸmemiÅŸ depolama yeri (L) ile XORlandÄ±ÄŸÄ±nda, orijinal iÅŸaretÃ§i ortaya Ã§Ä±kar. KarÄ±ÅŸtÄ±rma ve demangling'deki bu simetri, sistemin iÅŸaretÃ§ileri Ã¶nemli bir ek yÃ¼k olmadan verimli bir ÅŸekilde kodlayÄ±p Ã§Ã¶zmesini saÄŸlar ve bellek iÅŸaretÃ§ilerini manipÃ¼le eden saldÄ±rÄ±lara karÅŸÄ± gÃ¼venliÄŸi Ã¶nemli Ã¶lÃ§Ã¼de artÄ±rÄ±r.

### GÃ¼venlik FaydalarÄ±

Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma, yÄ±ÄŸÄ±n yÃ¶netiminde **kÄ±smi ve tam iÅŸaretÃ§i geÃ§ersiz kÄ±lmalarÄ±nÄ± Ã¶nlemeyi** amaÃ§lar, bu da gÃ¼venlikte Ã¶nemli bir geliÅŸtirmedir. Bu Ã¶zellik, istismar tekniklerini birkaÃ§ ÅŸekilde etkiler:

1. **Bayt GÃ¶reli GeÃ§ersiz KÄ±lmalarÄ±n Ã–nlenmesi**: Ã–nceden, saldÄ±rganlar bir iÅŸaretÃ§inin bir kÄ±smÄ±nÄ± deÄŸiÅŸtirerek **yÄ±ÄŸÄ±n parÃ§alarÄ±nÄ± farklÄ± konumlara yÃ¶nlendirebilirlerdi**, bu teknik sÄ±zdÄ±rmasÄ±z **Roman Evi** istismarÄ±nda belirgindi. Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma ile, bÃ¶yle gÃ¶reli geÃ§ersiz kÄ±lmalar **ÅŸimdi bir yÄ±ÄŸÄ±n sÄ±zÄ±ntÄ±sÄ± gerektiriyor**, baÅŸarÄ± olasÄ±lÄ±klarÄ±nÄ± Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±yor.
2. **Tcache Bin/Fastbin SaldÄ±rÄ±larÄ±n ZorluÄŸunun ArtmasÄ±**: Fastbin veya tcache giriÅŸlerini manipÃ¼le ederek iÅŸlev iÅŸaretÃ§ilerini (Ã¶rneÄŸin, `__malloc_hook`) geÃ§ersiz kÄ±lmaya yÃ¶nelik yaygÄ±n saldÄ±rÄ±lar engellenir. Ã–rneÄŸin, bir saldÄ±rÄ±, bir LibC adresini sÄ±zdÄ±rmayÄ±, bir parÃ§ayÄ± tcache bin'ine serbest bÄ±rakmayÄ± ve ardÄ±ndan Fd iÅŸaretÃ§isini `__malloc_hook`'a yÃ¶nlendirmek iÃ§in geÃ§ersiz kÄ±lmayÄ± iÃ§erebilir. Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma ile, bu iÅŸaretÃ§ilerin doÄŸru bir ÅŸekilde karÄ±ÅŸtÄ±rÄ±lmasÄ± gerekir, **doÄŸru manipÃ¼lasyon iÃ§in bir yÄ±ÄŸÄ±n sÄ±zÄ±ntÄ±sÄ± gerektirir**, bÃ¶ylece istismar engelini yÃ¼kseltir.
3. **YÄ±ÄŸÄ±n DÄ±ÅŸÄ± Konumlarda YÄ±ÄŸÄ±n SÄ±zÄ±ntÄ±larÄ± Gereksinimi**: YÄ±ÄŸÄ±n dÄ±ÅŸÄ± alanlarda (yÄ±ÄŸÄ±n, .bss bÃ¶lÃ¼mÃ¼ veya PLT/GOT gibi) sahte bir parÃ§a oluÅŸturmak da **iÅŸaretÃ§i karÄ±ÅŸtÄ±rma gereksinimi nedeniyle bir yÄ±ÄŸÄ±n sÄ±zÄ±ntÄ±sÄ± gerektirir**. Bu, bu alanlarÄ± istismar etmenin karmaÅŸÄ±klÄ±ÄŸÄ±nÄ± artÄ±rÄ±r, LibC adreslerini manipÃ¼le etme gereksinimiyle benzerlik gÃ¶sterir.
4. **YÄ±ÄŸÄ±n Adreslerini SÄ±zdÄ±rmak Daha Zor Hale Gelir**: Ä°ÅŸaretÃ§i karÄ±ÅŸtÄ±rma, fastbin ve tcache binlerindeki Fd iÅŸaretÃ§ilerinin yÄ±ÄŸÄ±n adres sÄ±zÄ±ntÄ±larÄ± iÃ§in kaynak olarak kullanÄ±labilirliÄŸini kÄ±sÄ±tlar. Ancak, sÄ±ralanmamÄ±ÅŸ, kÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k binlerdeki iÅŸaretÃ§iler karÄ±ÅŸtÄ±rÄ±lmamÄ±ÅŸ kalÄ±r, bu nedenle adres sÄ±zdÄ±rmak iÃ§in hala kullanÄ±labilir. Bu deÄŸiÅŸim, saldÄ±rganlarÄ± istismar edilebilir bilgi iÃ§in bu binleri keÅŸfetmeye yÃ¶nlendirir, ancak bazÄ± teknikler hala bir sÄ±zÄ±ntÄ±dan Ã¶nce iÅŸaretÃ§ileri demangling yapmaya izin verebilir, ancak kÄ±sÄ±tlamalarla birlikte.

### **YÄ±ÄŸÄ±n SÄ±zÄ±ntÄ±sÄ± ile Ä°ÅŸaretÃ§ileri Demangling**

{% hint style="danger" %}
SÃ¼recin daha iyi bir aÃ§Ä±klamasÄ± iÃ§in [**orijinal gÃ¶nderiyi buradan kontrol edin**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Algoritma Genel GÃ¶rÃ¼nÃ¼mÃ¼

Ä°ÅŸaretÃ§ileri karÄ±ÅŸtÄ±rma ve demangling iÃ§in kullanÄ±lan formÃ¼l:&#x20;

**`New_Ptr = (L >> 12) XOR P`**

Burada **L** depolama yeri ve **P** Fd iÅŸaretÃ§isidir. **L** 12 bit saÄŸa kaydÄ±rÄ±ldÄ±ÄŸÄ±nda, **P**'nin en anlamlÄ± bitlerini aÃ§Ä±ÄŸa Ã§Ä±karÄ±r, Ã§Ã¼nkÃ¼ **XOR** iÅŸlemi, bitler kendileriyle XORlandÄ±ÄŸÄ±nda 0 Ã§Ä±ktÄ±sÄ± verir.

**Algoritmadaki Ana AdÄ±mlar:**

1. **En AnlamlÄ± Bitlerin Ä°lk SÄ±zÄ±ntÄ±sÄ±**: KaydÄ±rÄ±lmÄ±ÅŸ **L** ile **P**'yi XORlayarak, etkili bir ÅŸekilde **P**'nin en Ã¼st 12 bitini elde edersiniz Ã§Ã¼nkÃ¼ kaydÄ±rÄ±lan **L** kÄ±smÄ± sÄ±fÄ±r olacak ve **P**'nin karÅŸÄ±lÄ±k gelen bitleri deÄŸiÅŸmeyecektir.
2. **Ä°ÅŸaretÃ§i Bitlerinin Geri KazanÄ±mÄ±**: XOR iÅŸlemi tersinir olduÄŸundan, sonucu ve operandlardan birini bilmek diÄŸer operandÄ± hesaplamanÄ±zÄ± saÄŸlar. Bu Ã¶zellik, bilinen bit setlerini karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§inin parÃ§alarÄ±yla ardÄ±ÅŸÄ±k olarak XORlayarak **P** iÃ§in tÃ¼m bit setini Ã§Ä±karmak iÃ§in kullanÄ±lÄ±r.
3. **Ä°teratif Demangling**: SÃ¼reÃ§ tekrarlanÄ±r, her seferinde bir Ã¶nceki adÄ±mdan elde edilen **P**'nin yeni keÅŸfedilen bitlerini kullanarak karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§inin bir sonraki segmentini Ã§Ã¶zmek iÃ§in, tÃ¼m bitler geri kazanÄ±lana kadar.
4. **Belirleyici Bitlerin Ä°ÅŸlenmesi**: **L**'nin son 12 biti kaybolur, ancak bunlar belirleyicidir ve iÅŸlem sonrasÄ± yeniden inÅŸa edilebilir.

Bu algoritmanÄ±n bir uygulamasÄ±nÄ± burada bulabilirsiniz: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)

## Ä°ÅŸaretÃ§i Koruma

Ä°ÅŸaretÃ§i koruma, glibc'de saklanan iÅŸlev iÅŸaretÃ§ilerini korumak iÃ§in kullanÄ±lan bir istismar azaltma tekniÄŸidir, Ã¶zellikle `atexit()` gibi kÃ¼tÃ¼phane Ã§aÄŸrÄ±larÄ±yla kaydedilenler. Bu koruma, iÅŸaretÃ§ileri bir sÄ±r ile XORlayarak ve bit kaydÄ±rma uygulayarak karÄ±ÅŸtÄ±rmayÄ± iÃ§erir. Bu mekanizma, saldÄ±rganlarÄ±n iÅŸlev iÅŸaretÃ§ilerini geÃ§ersiz kÄ±larak kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irmesini Ã¶nlemeyi amaÃ§lar.

### **Bir sÄ±zÄ±ntÄ± ile Ä°ÅŸaretÃ§i KorumasÄ±nÄ± AÅŸma**

1. **Ä°ÅŸaretÃ§i Koruma Ä°ÅŸlemlerini Anlamak:** Ä°ÅŸaretÃ§ilerin karÄ±ÅŸtÄ±rÄ±lmasÄ± (mangling), iÅŸaretÃ§iyi 64-bit bir sÄ±r ile XORlayarak ve ardÄ±ndan 0x11 bit sola kaydÄ±rarak yapÄ±lan `PTR_MANGLE` makrosu kullanÄ±larak gerÃ§ekleÅŸtirilir. Orijinal iÅŸaretÃ§iyi geri kazanmak iÃ§in ters iÅŸlem `PTR_DEMANGLE` ile yapÄ±lÄ±r.
2. **SaldÄ±rÄ± Stratejisi:** SaldÄ±rÄ±, saldÄ±rganÄ±n karÄ±ÅŸtÄ±rma iÃ§in kullanÄ±lan sÄ±rrÄ± Ã§Ä±karmak iÃ§in hem orijinal hem de karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§ilerin bilinmesi gereken bir bilinen-dÃ¼z metin yaklaÅŸÄ±mÄ±na dayanÄ±r.
3. **Bilinen DÃ¼z Metinleri Ä°stismar Etme:**
* **Sabit Ä°ÅŸlev Ä°ÅŸaretÃ§ilerini Belirleme:** glibc kaynak kodunu veya baÅŸlatÄ±lmÄ±ÅŸ iÅŸlev iÅŸaretÃ§i tablolarÄ±nÄ± (Ã¶rneÄŸin, `__libc_pthread_functions`) inceleyerek, bir saldÄ±rgan tahmin edilebilir iÅŸlev iÅŸaretÃ§ilerini bulabilir.
* **SÄ±rrÄ± Hesaplama:** `__pthread_attr_destroy` gibi bilinen bir iÅŸlev iÅŸaretÃ§isi ve iÅŸlev iÅŸaretÃ§i tablosundaki karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ versiyonu kullanÄ±larak, sÄ±r, karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ iÅŸaretÃ§iyi ters kaydÄ±rarak (saÄŸa kaydÄ±rma) ve ardÄ±ndan iÅŸlevin adresi ile XORlayarak hesaplanabilir.
4. **Alternatif DÃ¼z Metinler:** SaldÄ±rgan, 0 veya -1 gibi bilinen deÄŸerlerle iÅŸaretÃ§ileri karÄ±ÅŸtÄ±rmayÄ± deneyerek, bunlarÄ±n bellek iÃ§inde tanÄ±nabilir desenler Ã¼retip Ã¼retmediÄŸini gÃ¶rmek iÃ§in deney yapabilir, bu desenler bellek dÃ¶kÃ¼mlerinde bulunduÄŸunda sÄ±rrÄ± aÃ§Ä±ÄŸa Ã§Ä±karabilir.
5. **Pratik Uygulama:** SÄ±rrÄ± hesapladÄ±ktan sonra, bir saldÄ±rgan iÅŸaretÃ§ileri kontrollÃ¼ bir ÅŸekilde manipÃ¼le edebilir, bu da libc temel adresi bilgisi ve rastgele bellek konumlarÄ±nÄ± okuma yeteneÄŸi ile Ã§oklu iÅŸ parÃ§acÄ±klÄ± bir uygulamada Ä°ÅŸaretÃ§i Koruma korumasÄ±nÄ± aÅŸmayÄ± saÄŸlar.

## Referanslar

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
