# Ochrony Libc

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Egzekwowanie Wyr贸wnania Kawak贸w

**Malloc** przydziela pami w **grupach 8-bajtowych (32-bitowych) lub 16-bajtowych (64-bitowych)**. Oznacza to, 偶e koniec kawak贸w w systemach 32-bitowych powinien by wyr贸wnany do **0x8**, a w systemach 64-bitowych do **0x0**. Funkcja zabezpiecze sprawdza, czy ka偶dy kawaek **jest poprawnie wyr贸wnany** w tych konkretnych lokalizacjach przed u偶yciem wska藕nika z bin.

### Korzyci Zabezpiecze

Egzekwowanie wyr贸wnania kawak贸w w systemach 64-bitowych znacznie zwiksza bezpieczestwo Malloc, **ograniczajc umiejscowienie faszywych kawak贸w do tylko 1 na ka偶de 16 adres贸w**. To komplikuje wysiki zwizane z eksploatacj, szczeg贸lnie w scenariuszach, w kt贸rych u偶ytkownik ma ograniczon kontrol nad wartociami wejciowymi, co sprawia, 偶e ataki s bardziej zo偶one i trudniejsze do skutecznego przeprowadzenia.

* **Atak Fastbin na \_\_malloc\_hook**

Nowe zasady wyr贸wnania w Malloc r贸wnie偶 uniemo偶liwiaj klasyczny atak zwizany z `__malloc_hook`. Wczeniej napastnicy mogli manipulowa rozmiarami kawak贸w, aby **nadpisa ten wska藕nik funkcji** i uzyska **wykonanie kodu**. Teraz surowe wymagania dotyczce wyr贸wnania zapewniaj, 偶e takie manipulacje nie s ju偶 mo偶liwe, zamykajc powszechn drog eksploatacji i zwikszajc og贸lne bezpieczestwo.

## Zmiana Wska藕nik贸w na fastbins i tcache

**Zmiana Wska藕nik贸w** to ulepszenie zabezpiecze stosowane w celu ochrony **wska藕nik贸w Fd fastbin i tcache** w operacjach zarzdzania pamici. Technika ta pomaga zapobiega pewnym rodzajom taktyk eksploatacji pamici, szczeg贸lnie tym, kt贸re nie wymagaj wyciek贸w informacji o pamici lub kt贸re manipuluj lokalizacjami pamici bezporednio w odniesieniu do znanych pozycji (relatywne **nadpisania**).

Sednem tej techniki jest formua obfuskacji:

**`New_Ptr = (L >> 12) XOR P`**

* **L** to **Lokalizacja Przechowywania** wska藕nika.
* **P** to rzeczywisty **wska藕nik Fd fastbin/tcache**.

Pow贸d przesunicia bitowego lokalizacji przechowywania (L) o 12 bit贸w w prawo przed operacj XOR jest kluczowy. Ta manipulacja odnosi si do podatnoci inherentnej w deterministycznej naturze 12 najmniej znaczcych bit贸w adres贸w pamici, kt贸re s zazwyczaj przewidywalne z powodu ogranicze architektury systemu. Przesuwajc bity, przewidywalna cz jest usuwana z r贸wnania, zwikszajc losowo nowego, zmienionego wska藕nika i tym samym chronic przed eksploatacjami, kt贸re polegaj na przewidywalnoci tych bit贸w.

Ten zmieniony wska藕nik wykorzystuje istniejc losowo zapewnian przez **Losowe Rozmieszczenie Przestrzeni Adresowej (ASLR)**, kt贸re losowo rozmieszcza adresy u偶ywane przez programy, aby utrudni napastnikom przewidywanie ukadu pamici procesu.

**Demangling** wska藕nika w celu odzyskania oryginalnego adresu polega na u偶yciu tej samej operacji XOR. Tutaj zmieniony wska藕nik traktowany jest jako P w formule, a po XOR z niezmienion lokalizacj przechowywania (L) ujawnia oryginalny wska藕nik. Ta symetria w zmienianiu i demanglingu zapewnia, 偶e system mo偶e efektywnie kodowa i dekodowa wska藕niki bez znaczcego narzutu, jednoczenie znacznie zwikszajc bezpieczestwo przed atakami, kt贸re manipuluj wska藕nikami pamici.

### Korzyci Zabezpiecze

Zmiana wska藕nik贸w ma na celu **zapobieganie czciowym i penym nadpisaniom wska藕nik贸w w zarzdzaniu stert**, co stanowi znaczce ulepszenie w zakresie bezpieczestwa. Ta funkcja wpywa na techniki eksploatacji na kilka sposob贸w:

1. **Zapobieganie Relatywnym Nadpisaniom Byte Byte**: Wczeniej napastnicy mogli zmienia cz wska藕nika, aby **przekierowa kawaki sterty do r贸偶nych lokalizacji bez znajomoci dokadnych adres贸w**, technika widoczna w bezwyciekowym **House of Roman** exploit. Dziki zmianie wska藕nik贸w, takie relatywne nadpisania **bez wycieku sterty teraz wymagaj brutalnego wymuszania**, co drastycznie zmniejsza ich prawdopodobiestwo sukcesu.
2. **Zwikszona Trudno Atak贸w na Tcache Bin/Fastbin**: Powszechne ataki, kt贸re nadpisuj wska藕niki funkcji (jak `__malloc_hook`) poprzez manipulacj wpisami fastbin lub tcache, s utrudnione. Na przykad atak mo偶e polega na wycieku adresu LibC, zwolnieniu kawaka do bin tcache, a nastpnie nadpisaniu wska藕nika Fd, aby przekierowa go do `__malloc_hook` w celu wykonania dowolnego kodu. Dziki zmianie wska藕nik贸w, te wska藕niki musz by poprawnie zmienione, **co wymaga wycieku sterty do dokadnej manipulacji**, podnoszc tym samym barier eksploatacji.
3. **Wym贸g Wycieku Sterty w Lokalizacjach Niezwizanych ze Stert**: Tworzenie faszywego kawaka w obszarach niezwizanych ze stert (jak stos, sekcja .bss lub PLT/GOT) teraz r贸wnie偶 **wymaga wycieku sterty** z powodu potrzeby zmiany wska藕nik贸w. To zwiksza zo偶ono eksploatacji tych obszar贸w, podobnie jak wym贸g manipulacji adresami LibC.
4. **Wyciek Adres贸w Sterty Staje si Bardziej Wyzwanie**: Zmiana wska藕nik贸w ogranicza u偶yteczno wska藕nik贸w Fd w fastbin i tcache jako 藕r贸de wyciek贸w adres贸w sterty. Jednak wska藕niki w nieposortowanych, maych i du偶ych binach pozostaj niezmienione, wic nadal mog by u偶ywane do wyciek贸w adres贸w. Ta zmiana zmusza napastnik贸w do badania tych bin w poszukiwaniu informacji do eksploatacji, chocia偶 niekt贸re techniki mog nadal pozwala na demangling wska藕nik贸w przed wyciekiem, chocia偶 z ograniczeniami.

### **Demangling Wska藕nik贸w z Wyciekem Sterty**

{% hint style="danger" %}
Aby lepiej zrozumie proces [**sprawd藕 oryginalny post std**](https://maxwelldulin.com/BlogPost?post=5445977088).
{% endhint %}

### Przegld Algorytmu

Formua u偶ywana do zmiany i demanglingu wska藕nik贸w to:&#x20;

**`New_Ptr = (L >> 12) XOR P`**

Gdzie **L** to lokalizacja przechowywania, a **P** to wska藕nik Fd. Gdy **L** jest przesuwany w prawo o 12 bit贸w, ujawnia najbardziej znaczce bity **P**, z powodu natury **XOR**, kt贸ra zwraca 0, gdy bity s XORowane ze sob.

**Kluczowe Kroki w Algorytmie:**

1. **Pocztkowy Wyciek Najbardziej Znaczcych Bit贸w**: XORujc przesunite **L** z **P**, efektywnie uzyskujesz g贸rne 12 bit贸w **P**, poniewa偶 przesunita cz **L** bdzie zerowa, pozostawiajc odpowiadajce bity **P** niezmienione.
2. **Odzyskiwanie Bit贸w Wska藕nika**: Poniewa偶 XOR jest odwracalny, znajomo wyniku i jednego z operand贸w pozwala obliczy drugi operand. Ta waciwo jest u偶ywana do dedukcji caego zestawu bit贸w dla **P** poprzez sukcesywne XORowanie znanych zestaw贸w bit贸w z czciami zmienionego wska藕nika.
3. **Iteracyjne Demangling**: Proces jest powtarzany, za ka偶dym razem u偶ywajc nowo odkrytych bit贸w **P** z poprzedniego kroku do dekodowania nastpnego segmentu zmienionego wska藕nika, a偶 wszystkie bity zostan odzyskane.
4. **Obsuga Bit贸w Deterministycznych**: Ostatnie 12 bit贸w **L** jest tracone z powodu przesunicia, ale s one deterministyczne i mog by odbudowane po procesie.

Mo偶esz znale藕 implementacj tego algorytmu tutaj: [https://github.com/mdulin2/mangle](https://github.com/mdulin2/mangle)

## Ochrona Wska藕nik贸w

Ochrona wska藕nik贸w to technika agodzenia eksploatacji stosowana w glibc w celu ochrony przechowywanych wska藕nik贸w funkcji, szczeg贸lnie tych rejestrowanych przez wywoania biblioteczne, takie jak `atexit()`. Ta ochrona polega na zamieszaniu wska藕nik贸w poprzez XORowanie ich z tajnym kluczem przechowywanym w danych wtku (`fs:0x30`) i zastosowaniu rotacji bitowej. Mechanizm ten ma na celu zapobieganie przejmowaniu kontroli nad przepywem przez napastnik贸w poprzez nadpisywanie wska藕nik贸w funkcji.

### **Obchodzenie Ochrony Wska藕nik贸w z wyciekiem**

1. **Zrozumienie Operacji Ochrony Wska藕nik贸w:** Zamieszanie (zmiana) wska藕nik贸w odbywa si za pomoc makra `PTR_MANGLE`, kt贸re XORuje wska藕nik z 64-bitowym sekretem, a nastpnie wykonuje lew rotacj o 0x11 bit贸w. Operacja odwrotna do odzyskania oryginalnego wska藕nika jest obsugiwana przez `PTR_DEMANGLE`.
2. **Strategia Ataku:** Atak opiera si na podejciu znanego tekstu jawnego, gdzie napastnik musi zna zar贸wno oryginaln, jak i zmienion wersj wska藕nika, aby wydedukowa sekret u偶yty do zmiany.
3. **Wykorzystywanie Znanych Tekst贸w Jawnych:**
* **Identyfikacja Staych Wska藕nik贸w Funkcji:** Przez badanie kodu 藕r贸dowego glibc lub zainicjowanych tabel wska藕nik贸w funkcji (jak `__libc_pthread_functions`), napastnik mo偶e znale藕 przewidywalne wska藕niki funkcji.
* **Obliczanie Sekretu:** U偶ywajc znanego wska藕nika funkcji, takiego jak `__pthread_attr_destroy`, oraz jego zmienionej wersji z tabeli wska藕nik贸w funkcji, sekret mo偶na obliczy, wykonujc rotacj w prawo zmienionego wska藕nika, a nastpnie XORujc go z adresem funkcji.
4. **Alternatywne Teksty Jawne:** Napastnik mo偶e r贸wnie偶 eksperymentowa z zamian wska藕nik贸w z znanymi wartociami, takimi jak 0 lub -1, aby sprawdzi, czy te generuj rozpoznawalne wzory w pamici, potencjalnie ujawniajc sekret, gdy te wzory zostan znalezione w zrzutach pamici.
5. **Praktyczne Zastosowanie:** Po obliczeniu sekretu, napastnik mo偶e manipulowa wska藕nikami w kontrolowany spos贸b, zasadniczo obchodzc ochron Ochrony Wska藕nik贸w w aplikacji wielowtkowej, majc wiedz o adresie bazowym libc i mo偶liwo odczytu dowolnych lokalizacji pamici.

## 殴r贸da

* [https://maxwelldulin.com/BlogPost?post=5445977088](https://maxwelldulin.com/BlogPost?post=5445977088)
* [https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1](https://blog.infosectcbr.com.au/2020/04/bypassing-pointer-guard-in-linuxs-glibc.html?m=1)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
