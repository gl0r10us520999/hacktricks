# CET & Shadow Stack

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Control Flow Enforcement Technology (CET)

**CET** √© um recurso de seguran√ßa implementado no n√≠vel de hardware, projetado para frustrar ataques comuns de sequestro de fluxo de controle, como **Return-Oriented Programming (ROP)** e **Jump-Oriented Programming (JOP)**. Esses tipos de ataques manipulam o fluxo de execu√ß√£o de um programa para executar c√≥digo malicioso ou para encadear peda√ßos de c√≥digo benigno de uma maneira que realiza uma a√ß√£o maliciosa.

CET introduz duas caracter√≠sticas principais: **Indirect Branch Tracking (IBT)** e **Shadow Stack**.

* **IBT** garante que saltos e chamadas indiretas sejam feitos para alvos v√°lidos, que s√£o marcados explicitamente como destinos legais para ramifica√ß√µes indiretas. Isso √© alcan√ßado por meio do uso de um novo conjunto de instru√ß√µes que marca alvos v√°lidos, impedindo assim que atacantes desviem o fluxo de controle para locais arbitr√°rios.
* **Shadow Stack** √© um mecanismo que fornece integridade para endere√ßos de retorno. Ele mant√©m uma c√≥pia segura e oculta dos endere√ßos de retorno separada da pilha de chamadas regular. Quando uma fun√ß√£o retorna, o endere√ßo de retorno √© validado em rela√ß√£o √† pilha sombra, impedindo que atacantes sobrescrevam endere√ßos de retorno na pilha para sequestrar o fluxo de controle.

## Shadow Stack

A **shadow stack** √© uma **pilha dedicada usada exclusivamente para armazenar endere√ßos de retorno**. Ela funciona ao lado da pilha regular, mas √© protegida e oculta da execu√ß√£o normal do programa, tornando dif√≠cil para os atacantes interferirem. O objetivo principal da shadow stack √© garantir que quaisquer modifica√ß√µes aos endere√ßos de retorno na pilha convencional sejam detectadas antes que possam ser usadas, mitigando efetivamente os ataques ROP.

## Como CET e Shadow Stack Previnem Ataques

Os **ataques ROP e JOP** dependem da capacidade de sequestrar o fluxo de controle de uma aplica√ß√£o aproveitando vulnerabilidades que permitem sobrescrever ponteiros ou endere√ßos de retorno na pilha. Ao direcionar o fluxo para sequ√™ncias de gadgets de c√≥digo existentes ou gadgets orientados a retorno, os atacantes podem executar c√≥digo arbitr√°rio.

* O recurso **IBT** do CET torna esses ataques significativamente mais dif√≠ceis, garantindo que ramifica√ß√µes indiretas s√≥ possam saltar para endere√ßos que foram explicitamente marcados como alvos v√°lidos. Isso torna imposs√≠vel para os atacantes executarem gadgets arbitr√°rios espalhados pelo bin√°rio.
* A **shadow stack**, por outro lado, garante que mesmo que um atacante consiga sobrescrever um endere√ßo de retorno na pilha normal, a **discrep√¢ncia ser√° detectada** ao comparar o endere√ßo corrompido com a c√≥pia segura armazenada na shadow stack ao retornar de uma fun√ß√£o. Se os endere√ßos n√£o coincidirem, o programa pode ser encerrado ou tomar outras medidas de seguran√ßa, impedindo que o ataque tenha sucesso.

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
