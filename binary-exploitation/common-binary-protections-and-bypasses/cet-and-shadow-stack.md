# CET & Shadow Stack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Control Flow Enforcement Technology (CET)

**CET** es una caracter칤stica de seguridad implementada a nivel de hardware, dise침ada para frustrar ataques comunes de secuestro de flujo de control como **Return-Oriented Programming (ROP)** y **Jump-Oriented Programming (JOP)**. Estos tipos de ataques manipulan el flujo de ejecuci칩n de un programa para ejecutar c칩digo malicioso o encadenar piezas de c칩digo benigno de una manera que realice una acci칩n maliciosa.

CET introduce dos caracter칤sticas principales: **Indirect Branch Tracking (IBT)** y **Shadow Stack**.

* **IBT** asegura que los saltos y llamadas indirectas se realicen a destinos v치lidos, que est치n marcados expl칤citamente como destinos legales para ramas indirectas. Esto se logra mediante el uso de un nuevo conjunto de instrucciones que marca destinos v치lidos, evitando as칤 que los atacantes desv칤en el flujo de control a ubicaciones arbitrarias.
* **Shadow Stack** es un mecanismo que proporciona integridad para las direcciones de retorno. Mantiene una copia segura y oculta de las direcciones de retorno separada de la pila de llamadas regular. Cuando una funci칩n retorna, la direcci칩n de retorno se valida contra la pila sombra, evitando que los atacantes sobrescriban las direcciones de retorno en la pila para secuestrar el flujo de control.

## Shadow Stack

La **shadow stack** es una **pila dedicada utilizada 칰nicamente para almacenar direcciones de retorno**. Funciona junto con la pila regular, pero est치 protegida y oculta de la ejecuci칩n normal del programa, lo que dificulta que los atacantes la manipulen. El objetivo principal de la pila sombra es asegurar que cualquier modificaci칩n a las direcciones de retorno en la pila convencional sea detectada antes de que puedan ser utilizadas, mitigando efectivamente los ataques ROP.

## C칩mo CET y Shadow Stack Previenen Ataques

Los **ataques ROP y JOP** dependen de la capacidad de secuestrar el flujo de control de una aplicaci칩n aprovechando vulnerabilidades que les permiten sobrescribir punteros o direcciones de retorno en la pila. Al dirigir el flujo a secuencias de gadgets de c칩digo existentes o gadgets orientados a retorno, los atacantes pueden ejecutar c칩digo arbitrario.

* La caracter칤stica **IBT** de CET hace que estos ataques sean significativamente m치s dif칤ciles al asegurar que las ramas indirectas solo puedan saltar a direcciones que han sido marcadas expl칤citamente como destinos v치lidos. Esto hace que sea imposible para los atacantes ejecutar gadgets arbitrarios dispersos por el binario.
* La **shadow stack**, por otro lado, asegura que incluso si un atacante puede sobrescribir una direcci칩n de retorno en la pila normal, la **discrepancia ser치 detectada** al comparar la direcci칩n corrupta con la copia segura almacenada en la pila sombra al retornar de una funci칩n. Si las direcciones no coinciden, el programa puede terminar o tomar otras medidas de seguridad, evitando que el ataque tenga 칠xito.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
