# CET & Shadow Stack

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}

## Control Flow Enforcement Technology (CET)

**CET**はハードウェアレベルで実装されたセキュリティ機能であり、**Return-Oriented Programming (ROP)**や**Jump-Oriented Programming (JOP)**などの一般的な制御フローのハイジャック攻撃を防ぐよう設計されています。これらの攻撃タイプは、プログラムの実行フローを操作して悪意のあるコードを実行したり、悪意のないコードの断片を連結して悪意のあるアクションを実行することを目的としています。

CETには**Indirect Branch Tracking (IBT)**と**Shadow Stack**という2つの主要な機能が導入されています。

* **IBT**は、間接的なジャンプやコールが有効なターゲットに行われることを確認し、間接的なブランチのための有効な宛先として明示的にマークされたものにのみジャンプできるようにします。これは、有効なターゲットをマークする新しい命令セットを使用して達成され、攻撃者が制御フローを任意の場所に逸らすのを防ぎます。
* **Shadow Stack**は、リターンアドレスの整合性を提供するメカニズムです。通常のコールスタックから別個に保護された、隠されたリターンアドレスのコピーを保持します。関数がリターンするとき、リターンアドレスはシャドウスタックと照合され、攻撃者がコントロールフローをハイジャックするためにスタック上のリターンアドレスを上書きするのを防ぎます。

## Shadow Stack

**シャドウスタック**は、**リターンアドレスを保存するためだけに使用される専用スタック**です。通常のスタックと一緒に動作しますが、通常のプログラムの実行から保護され、隠されているため、攻撃者が不正に干渉するのが難しくなります。シャドウスタックの主な目的は、通常のスタック上のリターンアドレスへの変更が使用される前に検出されることを確認し、効果的にROP攻撃を緩和することです。

## CETとShadow Stackが攻撃を防ぐ方法

**ROPおよびJOP攻撃**は、アプリケーションの制御フローをハイジャックする能力に依存しており、ポインタやスタック上のリターンアドレスを上書きすることを可能にする脆弱性を利用しています。既存のコードガジェットやリターン指向プログラミングガジェットのシーケンスにフローを誘導することで、攻撃者は任意のコードを実行できます。

* **CETのIBT**機能により、これらの攻撃は間接的なブランチが明示的に有効なターゲットにのみジャンプできるようになるため、大幅に困難になります。これにより、攻撃者がバイナリ全体にわたって任意のガジェットを実行することが不可能になります。
* 一方、**シャドウスタック**は、攻撃者が通常のスタック上のリターンアドレスを上書きできたとしても、関数から戻る際にシャドウスタックに保存されたセキュアコピーと照合することで**不整合が検出**されます。アドレスが一致しない場合、プログラムは終了したり他のセキュリティ対策を取ったりして、攻撃が成功しないようにします。 

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
{% endhint %}
