# Stack Canaries

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## **StackGuard i StackShield**

**StackGuard** wstawia specjaln warto znan jako **canary** przed **EIP (Extended Instruction Pointer)**, konkretnie `0x000aff0d` (reprezentujcy null, newline, EOF, carriage return), aby chroni przed przepenieniem bufora. Jednak funkcje takie jak `recv()`, `memcpy()`, `read()`, i `bcopy()` pozostaj podatne, a ochrona nie obejmuje **EBP (Base Pointer)**.

**StackShield** przyjmuje bardziej zaawansowane podejcie ni偶 StackGuard, utrzymujc **Global Return Stack**, kt贸ry przechowuje wszystkie adresy powrotu (**EIPs**). Ta konfiguracja zapewnia, 偶e ka偶de przepenienie nie powoduje szk贸d, poniewa偶 pozwala na por贸wnanie przechowywanych i rzeczywistych adres贸w powrotu w celu wykrycia wystpie przepenienia. Dodatkowo, StackShield mo偶e sprawdzi adres powrotu w stosunku do wartoci granicznej, aby wykry, czy **EIP** wskazuje poza oczekiwan przestrze danych. Jednak ta ochrona mo偶e by obejciem za pomoc technik takich jak Return-to-libc, ROP (Return-Oriented Programming) lub ret2ret, co wskazuje, 偶e StackShield r贸wnie偶 nie chroni zmiennych lokalnych.

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

Ten mechanizm umieszcza **canary** przed **EBP** i reorganizuje zmienne lokalne, aby umieci bufory na wy偶szych adresach pamici, zapobiegajc ich nadpisywaniu innych zmiennych. Bezpiecznie kopiuje r贸wnie偶 argumenty przekazywane na stosie powy偶ej zmiennych lokalnych i u偶ywa tych kopii jako argument贸w. Jednak nie chroni tablic z mniej ni偶 8 elementami ani bufor贸w w strukturze u偶ytkownika.

**Canary** to losowa liczba pochodzca z `/dev/urandom` lub domylna warto `0xff0a0000`. Jest przechowywana w **TLS (Thread Local Storage)**, co pozwala na wsp贸dzielenie przestrzeni pamici midzy wtkami, aby miay one specyficzne dla wtku zmienne globalne lub statyczne. Te zmienne s pocztkowo kopiowane z procesu macierzystego, a procesy potomne mog zmienia swoje dane bez wpywu na rodzica lub rodzestwo. Niemniej jednak, jeli **`fork()` jest u偶ywane bez tworzenia nowego canary, wszystkie procesy (rodzic i dzieci) dziel ten sam canary**, co czyni go podatnym. W architekturze **i386** canary jest przechowywane w `gs:0x14`, a w **x86\_64**, w `fs:0x28`.

Ta lokalna ochrona identyfikuje funkcje z buforami podatnymi na ataki i wstrzykuje kod na pocztku tych funkcji, aby umieci canary, a na kocu, aby zweryfikowa jego integralno.

Gdy serwer internetowy u偶ywa `fork()`, umo偶liwia to atak brute-force w celu odgadnicia bajtu canary po bajcie. Jednak u偶ycie `execve()` po `fork()` nadpisuje przestrze pamici, niweczc atak. `vfork()` pozwala procesowi potomnemu na wykonanie bez duplikacji, a偶 spr贸buje zapisa, w kt贸rym momencie tworzona jest duplikacja, oferujc inne podejcie do tworzenia proces贸w i zarzdzania pamici.

### Dugoci

W binariach `x64`, cookie canary to **`0x8`** bajtowy qword. **Pierwsze siedem bajt贸w jest losowych**, a ostatni bajt to **null byte.**

W binariach `x86`, cookie canary to **`0x4`** bajtowy dword. **Pierwsze trzy bajty s losowe**, a ostatni bajt to **null byte.**

{% hint style="danger" %}
Najmniej znaczcy bajt obu canary to null byte, poniewa偶 bdzie pierwszym na stosie pochodzcym z ni偶szych adres贸w i dlatego **funkcje, kt贸re odczytuj cigi, zatrzymaj si przed jego odczytaniem**.
{% endhint %}

## Obejcia

**Wyciekanie canary** i nastpnie nadpisywanie go (np. przepenienie bufora) jego wasn wartoci.

* Jeli **canary jest forkowany w procesach potomnych**, mo偶e by mo偶liwe **brute-force** go jeden bajt na raz:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Jeli w binarnym kodzie wystpuje interesujce **wyciekanie lub podatno na dowolne odczyty**, mo偶e by mo偶liwe jego wyciekanie:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **Nadpisywanie wska藕nik贸w przechowywanych na stosie**

Stos podatny na przepenienie stosu mo偶e **zawiera adresy do cig贸w lub funkcji, kt贸re mo偶na nadpisa**, aby wykorzysta podatno bez potrzeby dotarcia do canary. Sprawd藕:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **Modyfikacja zar贸wno master, jak i thread canary**

Przepenienie bufora **w funkcji wtkowej** chronionej canary mo偶e by u偶yte do **modyfikacji master canary w wtku**. W rezultacie, agodzenie jest bezu偶yteczne, poniewa偶 sprawdzenie jest u偶ywane z dwoma canary, kt贸re s takie same (cho zmodyfikowane).

Ponadto, przepenienie bufora **w funkcji wtkowej** chronionej canary mogoby by u偶yte do **modyfikacji master canary przechowywanego w TLS**. Dzieje si tak, poniewa偶 mo偶e by mo偶liwe dotarcie do pozycji pamici, w kt贸rej przechowywane jest TLS (a tym samym canary) za pomoc **bof na stosie** wtku.\
W rezultacie, agodzenie jest bezu偶yteczne, poniewa偶 sprawdzenie jest u偶ywane z dwoma canary, kt贸re s takie same (cho zmodyfikowane).\
Ten atak jest opisany w artykule: [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

Sprawd藕 r贸wnie偶 prezentacj [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015), kt贸ra wspomina, 偶e zazwyczaj **TLS** jest przechowywane przez **`mmap`**, a gdy **stos** **wtku** jest tworzony, jest r贸wnie偶 generowany przez `mmap`, co mo偶e umo偶liwi przepenienie, jak pokazano w poprzednim artykule.

* **Modyfikacja wpisu GOT `__stack_chk_fail`**

Jeli binarny kod ma Partial RELRO, mo偶na u偶y dowolnego zapisu, aby zmodyfikowa **wpis GOT `__stack_chk_fail`** na funkcj zastpcz, kt贸ra nie blokuje programu, jeli canary zostanie zmodyfikowane.

Ten atak jest opisany w artykule: [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

## Referencje

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
