# Stack Canaries

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **StackGuard å’Œ StackShield**

**StackGuard** åœ¨ **EIP (æ‰©å±•æŒ‡ä»¤æŒ‡é’ˆ)** ä¹‹å‰æ’å…¥ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œç§°ä¸º **canary**ï¼Œå…·ä½“ä¸º `0x000aff0d`ï¼ˆè¡¨ç¤ºç©ºå€¼ã€æ¢è¡Œç¬¦ã€EOFã€å›è½¦ï¼‰ä»¥é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€‚ç„¶è€Œï¼Œåƒ `recv()`ã€`memcpy()`ã€`read()` å’Œ `bcopy()` è¿™æ ·çš„å‡½æ•°ä»ç„¶æ˜“å—æ”»å‡»ï¼Œå¹¶ä¸”å®ƒä¸ä¿æŠ¤ **EBP (åŸºæŒ‡é’ˆ)**ã€‚

**StackShield** é‡‡ç”¨æ¯” StackGuard æ›´å¤æ‚çš„æ–¹æ³•ï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ª **å…¨å±€è¿”å›æ ˆ**ï¼Œå­˜å‚¨æ‰€æœ‰è¿”å›åœ°å€ (**EIPs**)ã€‚è¿™ç§è®¾ç½®ç¡®ä¿ä»»ä½•æº¢å‡ºä¸ä¼šé€ æˆä¼¤å®³ï¼Œå› ä¸ºå®ƒå…è®¸æ¯”è¾ƒå­˜å‚¨çš„å’Œå®é™…çš„è¿”å›åœ°å€ä»¥æ£€æµ‹æº¢å‡ºå‘ç”Ÿã€‚æ­¤å¤–ï¼ŒStackShield å¯ä»¥æ£€æŸ¥è¿”å›åœ°å€ä¸è¾¹ç•Œå€¼ï¼Œä»¥æ£€æµ‹ **EIP** æ˜¯å¦æŒ‡å‘é¢„æœŸæ•°æ®ç©ºé—´ä¹‹å¤–ã€‚ç„¶è€Œï¼Œè¿™ç§ä¿æŠ¤å¯ä»¥é€šè¿‡ Return-to-libcã€ROPï¼ˆè¿”å›å¯¼å‘ç¼–ç¨‹ï¼‰æˆ– ret2ret ç­‰æŠ€æœ¯ç»•è¿‡ï¼Œè¿™è¡¨æ˜ StackShield ä¹Ÿä¸ä¿æŠ¤å±€éƒ¨å˜é‡ã€‚

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

è¯¥æœºåˆ¶åœ¨ **EBP** ä¹‹å‰æ”¾ç½®ä¸€ä¸ª **canary**ï¼Œå¹¶é‡æ–°ç»„ç»‡å±€éƒ¨å˜é‡ä»¥å°†ç¼“å†²åŒºæ”¾ç½®åœ¨æ›´é«˜çš„å†…å­˜åœ°å€ï¼Œé˜²æ­¢å®ƒä»¬è¦†ç›–å…¶ä»–å˜é‡ã€‚å®ƒè¿˜å®‰å…¨åœ°å¤åˆ¶ä¼ é€’åˆ°å±€éƒ¨å˜é‡ä¸Šæ–¹çš„å †æ ˆå‚æ•°ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‰¯æœ¬ä½œä¸ºå‚æ•°ã€‚ç„¶è€Œï¼Œå®ƒä¸ä¿æŠ¤å°‘äº 8 ä¸ªå…ƒç´ çš„æ•°ç»„æˆ–ç”¨æˆ·ç»“æ„ä¸­çš„ç¼“å†²åŒºã€‚

**canary** æ˜¯ä» `/dev/urandom` æ´¾ç”Ÿçš„éšæœºæ•°æˆ–é»˜è®¤å€¼ `0xff0a0000`ã€‚å®ƒå­˜å‚¨åœ¨ **TLS (çº¿ç¨‹å±€éƒ¨å­˜å‚¨)** ä¸­ï¼Œå…è®¸è·¨çº¿ç¨‹å…±äº«å†…å­˜ç©ºé—´å…·æœ‰çº¿ç¨‹ç‰¹å®šçš„å…¨å±€æˆ–é™æ€å˜é‡ã€‚è¿™äº›å˜é‡æœ€åˆä»çˆ¶è¿›ç¨‹å¤åˆ¶ï¼Œå­è¿›ç¨‹å¯ä»¥åœ¨ä¸å½±å“çˆ¶è¿›ç¨‹æˆ–å…„å¼Ÿè¿›ç¨‹çš„æƒ…å†µä¸‹æ›´æ”¹å…¶æ•°æ®ã€‚ç„¶è€Œï¼Œå¦‚æœ **`fork()` åœ¨ä¸åˆ›å»ºæ–° canary çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œæ‰€æœ‰è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ï¼‰å…±äº«ç›¸åŒçš„ canary**ï¼Œä½¿å…¶æ˜“å—æ”»å‡»ã€‚åœ¨ **i386** æ¶æ„ä¸­ï¼Œcanary å­˜å‚¨åœ¨ `gs:0x14`ï¼Œåœ¨ **x86\_64** ä¸­ï¼Œå­˜å‚¨åœ¨ `fs:0x28`ã€‚

è¿™ç§æœ¬åœ°ä¿æŠ¤è¯†åˆ«å…·æœ‰æ˜“å—æ”»å‡»ç¼“å†²åŒºçš„å‡½æ•°ï¼Œå¹¶åœ¨è¿™äº›å‡½æ•°çš„å¼€å§‹å¤„æ³¨å…¥ä»£ç ä»¥æ”¾ç½® canaryï¼Œåœ¨ç»“æŸæ—¶éªŒè¯å…¶å®Œæ•´æ€§ã€‚

å½“ Web æœåŠ¡å™¨ä½¿ç”¨ `fork()` æ—¶ï¼Œå®ƒå…è®¸é€šè¿‡é€å­—èŠ‚çŒœæµ‹ canary å­—èŠ‚è¿›è¡Œæš´åŠ›æ”»å‡»ã€‚ç„¶è€Œï¼Œåœ¨ `fork()` åä½¿ç”¨ `execve()` ä¼šè¦†ç›–å†…å­˜ç©ºé—´ï¼Œä»è€Œæ¶ˆé™¤æ”»å‡»ã€‚`vfork()` å…è®¸å­è¿›ç¨‹åœ¨å°è¯•å†™å…¥ä¹‹å‰æ‰§è¡Œè€Œä¸è¿›è¡Œå¤åˆ¶ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œæä¾›äº†ä¸€ç§ä¸åŒçš„è¿›ç¨‹åˆ›å»ºå’Œå†…å­˜å¤„ç†æ–¹æ³•ã€‚

### é•¿åº¦

åœ¨ `x64` äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookie æ˜¯ä¸€ä¸ª **`0x8`** å­—èŠ‚çš„ qwordã€‚**å‰ä¸ƒä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯ **ç©ºå­—èŠ‚**ã€‚

åœ¨ `x86` äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œcanary cookie æ˜¯ä¸€ä¸ª **`0x4`** å­—èŠ‚çš„ dwordã€‚**å‰ä¸‰ä¸ªå­—èŠ‚æ˜¯éšæœºçš„**ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯ **ç©ºå­—èŠ‚**ã€‚

{% hint style="danger" %}
ä¸¤ä¸ª canary çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚æ˜¯ç©ºå­—èŠ‚ï¼Œå› ä¸ºå®ƒå°†æ˜¯æ¥è‡ªè¾ƒä½åœ°å€çš„å †æ ˆä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå› æ­¤ **è¯»å–å­—ç¬¦ä¸²çš„å‡½æ•°å°†åœ¨è¯»å–ä¹‹å‰åœæ­¢**ã€‚
{% endhint %}

## ç»•è¿‡

**æ³„éœ² canary** ç„¶åç”¨å…¶è‡ªèº«çš„å€¼è¦†ç›–å®ƒï¼ˆä¾‹å¦‚ï¼Œç¼“å†²åŒºæº¢å‡ºï¼‰ã€‚

* å¦‚æœ **canary åœ¨å­è¿›ç¨‹ä¸­è¢« fork**ï¼Œå¯èƒ½å¯ä»¥é€å­—èŠ‚ **æš´åŠ›ç ´è§£** å®ƒï¼š

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ä¸€äº›æœ‰è¶£çš„ **æ³„éœ²æˆ–ä»»æ„è¯»å–æ¼æ´**ï¼Œå¯èƒ½å¯ä»¥æ³„éœ²å®ƒï¼š

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **è¦†ç›–å †æ ˆå­˜å‚¨æŒ‡é’ˆ**

æ˜“å—å †æ ˆæº¢å‡ºå½±å“çš„å †æ ˆå¯èƒ½ **åŒ…å«å¯ä»¥è¢«è¦†ç›–çš„å­—ç¬¦ä¸²æˆ–å‡½æ•°åœ°å€**ï¼Œä»¥åˆ©ç”¨è¯¥æ¼æ´è€Œæ— éœ€åˆ°è¾¾å †æ ˆ canaryã€‚æ£€æŸ¥ï¼š

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **ä¿®æ”¹ä¸» canary å’Œçº¿ç¨‹ canary**

åœ¨å— canary ä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­ **ç¼“å†²åŒºæº¢å‡º** å¯ä»¥ç”¨æ¥ **ä¿®æ”¹çº¿ç¨‹çš„ä¸» canary**ã€‚å› æ­¤ï¼Œç¼“è§£æªæ–½æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªç›¸åŒçš„ canaryï¼ˆå°½ç®¡å·²è¢«ä¿®æ”¹ï¼‰ã€‚

æ­¤å¤–ï¼Œåœ¨å— canary ä¿æŠ¤çš„çº¿ç¨‹å‡½æ•°ä¸­ **ç¼“å†²åŒºæº¢å‡º** å¯ä»¥ç”¨æ¥ **ä¿®æ”¹å­˜å‚¨åœ¨ TLS ä¸­çš„ä¸» canary**ã€‚è¿™æ˜¯å› ä¸ºï¼Œå¯èƒ½é€šè¿‡çº¿ç¨‹çš„ **å †æ ˆä¸­çš„ bof** åˆ°è¾¾å­˜å‚¨ TLS çš„å†…å­˜ä½ç½®ï¼ˆå› æ­¤ï¼Œcanaryï¼‰ã€‚\
å› æ­¤ï¼Œç¼“è§£æªæ–½æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºæ£€æŸ¥ä½¿ç”¨çš„æ˜¯ä¸¤ä¸ªç›¸åŒçš„ canaryï¼ˆå°½ç®¡å·²è¢«ä¿®æ”¹ï¼‰ã€‚\
æ­¤æ”»å‡»åœ¨ä»¥ä¸‹å†™ä½œä¸­è¿›è¡Œï¼š[http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)

è¿˜å¯ä»¥æŸ¥çœ‹ [https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015](https://www.slideshare.net/codeblue\_jp/master-canary-forging-by-yuki-koike-code-blue-2015) çš„æ¼”ç¤ºï¼Œå…¶ä¸­æåˆ°é€šå¸¸ **TLS** æ˜¯é€šè¿‡ **`mmap`** å­˜å‚¨çš„ï¼Œå½“ **çº¿ç¨‹** çš„ **å †æ ˆ** è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¹Ÿæ˜¯é€šè¿‡ `mmap` ç”Ÿæˆçš„ï¼Œè¿™å¯èƒ½å…è®¸å¦‚å‰æ‰€è¿°çš„æº¢å‡ºã€‚

* **ä¿®æ”¹ `__stack_chk_fail` çš„ GOT æ¡ç›®**

å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰éƒ¨åˆ† RELROï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»»æ„å†™å…¥æ¥ä¿®æ”¹ **`__stack_chk_fail` çš„ GOT æ¡ç›®**ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªä¸ä¼šåœ¨ canary è¢«ä¿®æ”¹æ—¶é˜»æ­¢ç¨‹åºçš„è™šæ‹Ÿå‡½æ•°ã€‚

æ­¤æ”»å‡»åœ¨ä»¥ä¸‹å†™ä½œä¸­è¿›è¡Œï¼š[https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

## å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
