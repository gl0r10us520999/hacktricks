# Memory Tagging Extension (MTE)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Memory Tagging Extension (MTE)**, bellekle ilgili hatalarÄ±, Ã¶rneÄŸin tampon taÅŸmalarÄ± ve kullanÄ±mdan sonra serbest bÄ±rakma gÃ¼venlik aÃ§Ä±klarÄ±nÄ± **tespit etmek ve Ã¶nlemek** amacÄ±yla yazÄ±lÄ±m gÃ¼venilirliÄŸini ve gÃ¼venliÄŸini artÄ±rmak iÃ§in tasarlanmÄ±ÅŸtÄ±r. MTE, **ARM** mimarisinin bir parÃ§asÄ± olarak, her bellek tahsisine **kÃ¼Ã§Ã¼k bir etiket eklemek** ve o belleÄŸi referans alan her iÅŸaretÃ§iye **karÅŸÄ±lÄ±k gelen bir etiket** saÄŸlamak iÃ§in bir mekanizma sunar. Bu yaklaÅŸÄ±m, Ã§alÄ±ÅŸma zamanÄ±nda yasadÄ±ÅŸÄ± bellek eriÅŸimlerinin tespit edilmesine olanak tanÄ±r ve bu tÃ¼r gÃ¼venlik aÃ§Ä±klarÄ±nÄ±n rastgele kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in istismar edilme riskini Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.

### **How Memory Tagging Extension Works**

MTE, **belleÄŸi kÃ¼Ã§Ã¼k, sabit boyutlu bloklara bÃ¶lerek Ã§alÄ±ÅŸÄ±r; her blok bir etiketle atanÄ±r,** genellikle birkaÃ§ bit boyutundadÄ±r.&#x20;

Bir iÅŸaretÃ§i o belleÄŸi iÅŸaret etmek iÃ§in oluÅŸturulduÄŸunda, aynÄ± etiketi alÄ±r. Bu etiket, **bir bellek iÅŸaretÃ§isinin kullanÄ±lmayan bitlerinde** saklanÄ±r ve iÅŸaretÃ§iyi karÅŸÄ±lÄ±k gelen bellek bloÄŸuna etkili bir ÅŸekilde baÄŸlar.

<figure><img src="../../.gitbook/assets/image (1202).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bir program bir iÅŸaretÃ§i aracÄ±lÄ±ÄŸÄ±yla belleÄŸe eriÅŸtiÄŸinde, MTE donanÄ±mÄ± **iÅŸaretÃ§inin etiketi ile bellek bloÄŸunun etiketinin eÅŸleÅŸip eÅŸleÅŸmediÄŸini** kontrol eder. EÄŸer etiketler **eÅŸleÅŸmiyorsa**, bu bir **yasadÄ±ÅŸÄ± bellek eriÅŸimi** olduÄŸunu gÃ¶sterir.

### MTE Pointer Tags

Bir iÅŸaretÃ§i iÃ§indeki etiketler, en Ã¼st byte iÃ§inde 4 bit olarak saklanÄ±r:

<figure><img src="../../.gitbook/assets/image (1203).png" alt=""><figcaption><p><a href="https://www.youtube.com/watch?v=UwMt0e_dC_Q">https://www.youtube.com/watch?v=UwMt0e_dC_Q</a></p></figcaption></figure>

Bu nedenle, bu **16 farklÄ± etiket deÄŸeri** olmasÄ±na olanak tanÄ±r.

### MTE Memory Tags

Her **16B fiziksel bellek** iÃ§in karÅŸÄ±lÄ±k gelen bir **bellek etiketi** vardÄ±r.

Bellek etiketleri, **normal kullanÄ±m iÃ§in eriÅŸilemeyen** bir **Ã¶zel RAM bÃ¶lgesinde** saklanÄ±r. Her 16B bellek etiketi iÃ§in 4 bit etiket olmasÄ±, RAM'in %3'Ã¼ne kadar Ã§Ä±kabilir.

ARM, bu etiketleri Ã¶zel RAM belleÄŸinde iÅŸlemek iÃ§in aÅŸaÄŸÄ±daki talimatlarÄ± tanÄ±tÄ±r:
```
STG [<Xn/SP>], #<simm>    Store Allocation (memory) Tag
LDG <Xt>, [<Xn/SP>]       Load Allocatoin (memory) Tag
IRG <Xd/SP>, <Xn/SP>      Insert Random [pointer] Tag
...
```
## Kontrol ModlarÄ±

### Senkron

CPU, etiketleri **talimat yÃ¼rÃ¼tÃ¼lÃ¼rken** kontrol eder, eÄŸer bir uyumsuzluk varsa, bir istisna oluÅŸturur.\
Bu en yavaÅŸ ve en gÃ¼venli olanÄ±dÄ±r.

### Asenkron

CPU, etiketleri **asenkron olarak** kontrol eder ve bir uyumsuzluk bulunduÄŸunda, sistem kayÄ±tlarÄ±ndan birinde bir istisna biti ayarlar. Bu, Ã¶nceki yÃ¶ntemden **daha hÄ±zlÄ±dÄ±r** ancak uyumsuzluÄŸa neden olan tam talimatÄ± **belirleyemez** ve istisnayÄ± hemen oluÅŸturmaz, saldÄ±rgana saldÄ±rÄ±sÄ±nÄ± tamamlama sÃ¼resi tanÄ±r.

### KarÄ±ÅŸÄ±k

???

## Uygulama ve Tespit Ã–rnekleri

DonanÄ±m Etiket TabanlÄ± KASAN, MTE tabanlÄ± KASAN veya Ã§ekirdek iÃ§i MTE olarak adlandÄ±rÄ±lÄ±r.\
Ã‡ekirdek ayÄ±rÄ±cÄ±larÄ± (Ã¶rneÄŸin `kmalloc`), kullanÄ±lacak etiketi hazÄ±rlamak iÃ§in **bu modÃ¼lÃ¼ Ã§aÄŸÄ±rÄ±r** (rastgele) ve bunu ayrÄ±lan Ã§ekirdek alanÄ±na ve dÃ¶ndÃ¼rÃ¼len iÅŸaretÃ§iye ekler.

Talep edilen boyut iÃ§in **yeterli bellek granÃ¼llerini** (her biri 16B) **sadece iÅŸaretleyecektir**. Yani, talep edilen boyut 35 ise ve 60B'lik bir slab verilmiÅŸse, bu etiketle ilk 16\*3 = 48B'yi iÅŸaretleyecek ve **geri kalan** **geÃ§ersiz etiket (0xE)** ile **iÅŸaretlenecektir**.

Etiket **0xF**, **tÃ¼m iÅŸaretÃ§ileri eÅŸleÅŸtiren** etikettir. Bu iÅŸaretÃ§iye sahip bir bellek, belleÄŸine eriÅŸmek iÃ§in **herhangi bir etiketin kullanÄ±lmasÄ±na** izin verir (uyumsuzluk yok). Bu, bu etiketin saldÄ±rÄ±ya uÄŸramÄ±ÅŸ bellek iÃ§inde kullanÄ±lmasÄ± durumunda MET'in bir saldÄ±rÄ±yÄ± tespit etmesini engelleyebilir.

Bu nedenle, 0xE ve 0xF rezerve edildiÄŸinden, etiket oluÅŸturmak iÃ§in yalnÄ±zca **14 deÄŸer** kullanÄ±labilir, bu da etiketlerin **yeniden kullanÄ±lma** olasÄ±lÄ±ÄŸÄ±nÄ± 1/17 -> yaklaÅŸÄ±k **%7** yapar.

EÄŸer Ã§ekirdek **geÃ§ersiz etiket granÃ¼lÃ¼ne** eriÅŸirse, **uyumsuzluk** **tespit edilir**. EÄŸer baÅŸka bir bellek konumuna eriÅŸirse, eÄŸer **bellek farklÄ± bir etikete** (veya geÃ§ersiz etikete) sahipse, uyumsuzluk **tespit edilir**. EÄŸer saldÄ±rgan ÅŸanslÄ±ysa ve bellek aynÄ± etiketi kullanÄ±yorsa, bu tespit edilmez. OlasÄ±lÄ±klar yaklaÅŸÄ±k %7'dir.

BaÅŸka bir hata, ayrÄ±lan belleÄŸin **son granÃ¼lÃ¼nde** meydana gelir. EÄŸer uygulama 35B talep ettiyse, 32'den 48'e kadar olan granÃ¼l verilmiÅŸtir. Bu nedenle, **36'dan 47'ye kadar olan baytlar aynÄ± etiketi kullanmaktadÄ±r** ancak bunlar talep edilmemiÅŸtir. EÄŸer saldÄ±rgan **bu ekstra baytlara eriÅŸirse, bu tespit edilmez**.

**`kfree()`** Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, bellek geÃ§ersiz bellek etiketi ile yeniden etiketlenir, bu nedenle bir **kullanÄ±m-sonrasÄ±-serbest** durumunda, bellek tekrar eriÅŸildiÄŸinde, **uyumsuzluk tespit edilir**.

Ancak, bir kullanÄ±m-sonrasÄ±-serbest durumunda, eÄŸer aynÄ± **parÃ§a, daha Ã¶nceki ile AYNI etiketle** yeniden tahsis edilirse, bir saldÄ±rgan bu eriÅŸimi kullanabilir ve bu tespit edilmez (yaklaÅŸÄ±k %7 ÅŸans).

AyrÄ±ca, yalnÄ±zca **`slab` ve `page_alloc`** etiketli belleÄŸi kullanÄ±r, ancak gelecekte bu `vmalloc`, `stack` ve `globals` iÃ§inde de kullanÄ±lacaktÄ±r (videonun Ã§ekildiÄŸi anda bunlar hala kÃ¶tÃ¼ye kullanÄ±labilir).

Bir **uyumsuzluk tespit edildiÄŸinde**, Ã§ekirdek daha fazla istismar ve istismar denemelerini Ã¶nlemek iÃ§in **panik yapacaktÄ±r** (MTE'nin yanlÄ±ÅŸ pozitifleri yoktur).

## Referanslar

* [https://www.youtube.com/watch?v=UwMt0e\_dC\_Q](https://www.youtube.com/watch?v=UwMt0e\_dC\_Q)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
