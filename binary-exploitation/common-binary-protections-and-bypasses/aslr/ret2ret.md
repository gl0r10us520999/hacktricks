# Ret2ret & Ret2pop

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングテクニックを共有**してください。

</details>
{% endhint %}

## Ret2ret

この技術の主な**目的**は、**スタック内の既存のポインタを悪用してASLRをバイパスしようとする**ことです。

基本的に、スタックオーバーフローは通常、文字列によって引き起こされ、**文字列はメモリ内で末尾にヌルバイトで終わります**。これにより、スタック内の既存のポインタが指す場所を減らすことができます。したがって、スタックに`0xbfffffdd`が含まれている場合、このオーバーフローはそれを`0xbfffff00`に変換できます（最後のゼロバイトに注意）。

そのアドレスがスタック内のシェルコードを指す場合、**`ret`命令にアドレスを追加**して、このアドレスに到達するまでフローを到達させることが可能です。

したがって、攻撃は次のようになります:

* NOPスレッド
* シェルコード
* スタックをEIPから**`ret`へのアドレスで上書き**する（RETスレッド）
* ストリングによって`0x00`が追加され、スタック内のアドレスがNOPスレッドを指すように変更される

[**このリンク**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2ret.c)を参照すると、脆弱なバイナリの例と[**このリンク**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2retexploit.c)でエクスプロイトが確認できます。

## Ret2pop

スタック内で**変更したくない完璧なポインタを見つける**ことができる場合（`ret2ret`では最終的な最下位バイトを`0x00`に変更しました）、同じ`ret2ret`攻撃を実行できますが、**RETスレッドの長さを1つ短くする必要があります**（最終的な`0x00`が完璧なポインタの直前のデータを上書きするため）、そして**RETスレッドの最後の**アドレスは**`pop <reg>; ret`**を指す必要があります。\
この方法で、**完璧なポインタの前のデータがスタックから削除**されます（これは`0x00`によって影響を受けるデータです）、そして**最終的な`ret`は変更なしでスタック内の完璧なアドレスを指す**ようになります。

[**このリンク**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2pop.c)を参照すると、脆弱なバイナリの例と[**このリンク**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/ASLR%20Smack%20and%20Laugh%20reference%20-%20Tilo%20Mueller/ret2popexploit.c)でエクスプロイトが確認できます。

## 参考文献

* [https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md)

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して**ハッキングテクニックを共有**してください。

</details>
{% endhint %}
