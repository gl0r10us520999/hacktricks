# Metodologia B√°sica de Explora√ß√£o Bin√°ria

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas sobre ELF

Antes de come√ßar a explorar qualquer coisa, √© interessante entender parte da estrutura de um **bin√°rio ELF**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Ferramentas de Explora√ß√£o

{% content-ref url="tools/" %}
[ferramentas](tools/)
{% endcontent-ref %}

## Metodologia de Estouro de Pilha

Com tantas t√©cnicas, √© bom ter um esquema de quando cada t√©cnica ser√° √∫til. Note que as mesmas prote√ß√µes afetar√£o diferentes t√©cnicas. Voc√™ pode encontrar maneiras de contornar as prote√ß√µes em cada se√ß√£o de prote√ß√£o, mas n√£o nesta metodologia.

## Controlando o Fluxo

Existem diferentes maneiras de controlar o fluxo de um programa:

* [**Estouros de Pilha**](../stack-overflow/) sobrescrevendo o ponteiro de retorno da pilha ou o EBP -> ESP -> EIP.
* Pode ser necess√°rio abusar de um [**Estouro de Inteiro**](../integer-overflow.md) para causar o estouro
* Ou via **Grava√ß√£o Arbitr√°ria + Escrever Onde para Executar**
* [**Strings de Formato**](../format-strings/)**:** Abusar do `printf` para escrever conte√∫do arbitr√°rio em endere√ßos arbitr√°rios.
* [**Indexa√ß√£o de Arrays**](../array-indexing.md): Abusar de uma indexa√ß√£o mal projetada para poder controlar alguns arrays e obter uma grava√ß√£o arbitr√°ria.
* Pode ser necess√°rio abusar de um [**Estouro de Inteiro**](../integer-overflow.md) para causar o estouro
* **bof para WWW via ROP**: Abusar de um estouro de buffer para construir um ROP e ser capaz de obter um WWW.

Voc√™ pode encontrar as t√©cnicas de **Escrever Onde para Executar** em:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## La√ßos Eternos

Algo a se ter em conta √© que geralmente **apenas uma explora√ß√£o de uma vulnerabilidade pode n√£o ser suficiente** para executar com sucesso um exploit, especialmente algumas prote√ß√µes precisam ser contornadas. Portanto, √© interessante discutir algumas op√ß√µes para **tornar uma √∫nica vulnerabilidade explor√°vel v√°rias vezes** na mesma execu√ß√£o do bin√°rio:

* Escrever em uma cadeia **ROP** o endere√ßo da fun√ß√£o **`main`** ou para o endere√ßo onde a **vulnerabilidade** est√° ocorrendo.
* Controlando uma cadeia ROP apropriada, voc√™ pode ser capaz de realizar todas as a√ß√µes nessa cadeia
* Escrever no endere√ßo **`exit` na GOT** (ou em qualquer outra fun√ß√£o usada pelo bin√°rio antes de terminar) o endere√ßo para voltar √† vulnerabilidade
* Como explicado em [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** armazene 2 fun√ß√µes aqui, uma para chamar a vulnerabilidade novamente e outra para chamar**`__libc_csu_fini`** que chamar√° novamente a fun√ß√£o de `.fini_array`.

## Objetivos de Explora√ß√£o

### Objetivo: Chamar uma fun√ß√£o Existente

* [**ret2win**](./#ret2win): Existe uma fun√ß√£o no c√≥digo que voc√™ precisa chamar (talvez com alguns par√¢metros espec√≠ficos) para obter a flag.
* Em um **bof regular sem** [**PIE**](../common-binary-protections-and-bypasses/pie/) **e** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), voc√™ s√≥ precisa escrever o endere√ßo no endere√ßo de retorno armazenado na pilha.
* Em um bof com [**PIE**](../common-binary-protections-and-bypasses/pie/), voc√™ precisar√° contorn√°-lo
* Em um bof com [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), voc√™ precisar√° contorn√°-lo
* Se voc√™ precisar definir v√°rios par√¢metros para chamar corretamente a fun√ß√£o **ret2win**, voc√™ pode usar:
* Uma cadeia [**ROP**](./#rop-and-ret2...-techniques) **se houver gadgets suficientes** para preparar todos os par√¢metros
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (caso possa chamar essa chamada de sistema) para controlar muitos registradores
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) e [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar v√°rios registradores
* Atrav√©s de um [**Escrever Onde para Executar**](../arbitrary-write-2-exec/) voc√™ poderia abusar de outras vulnerabilidades (n√£o bof) para chamar a fun√ß√£o **`win`**.
* [**Redirecionamento de Ponteiros**](../stack-overflow/pointer-redirecting.md): Caso a pilha contenha ponteiros para uma fun√ß√£o que ser√° chamada ou para uma string que ser√° usada por uma fun√ß√£o interessante (system ou printf), √© poss√≠vel sobrescrever esse endere√ßo.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) podem afetar os endere√ßos.
* [**Vari√°veis n√£o inicializadas**](../stack-overflow/uninitialized-variables.md): Voc√™ nunca sabe.

### Objetivo: RCE

#### Via shellcode, se nx desativado ou misturando shellcode com ROP:

* [**(Stack) Shellcode**](./#stack-shellcode): Isso √© √∫til para armazenar um shellcode na pilha antes ou depois de sobrescrever o ponteiro de retorno e ent√£o **pular para ele** para execut√°-lo:
* **De qualquer forma, se houver um** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** em um bof regular voc√™ precisar√° contorn√°-lo (vazar)
* **Sem** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **e** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) √© poss√≠vel pular para o endere√ßo da pilha, pois ele nunca mudar√°
* **Com** [**ASLR**](../common-binary-protections-and-bypasses/aslr/), voc√™ precisar√° de t√©cnicas como [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) para pular para ele
* **Com** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), voc√™ precisar√° usar algum [**ROP**](../rop-return-oriented-programing/) **para chamar `memprotect`** e tornar alguma p√°gina `rwx`, para ent√£o **armazenar o shellcode l√°** (chamando read, por exemplo) e ent√£o pular para l√°.
* Isso misturar√° shellcode com uma cadeia ROP.
#### Via syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): √ötil para chamar `execve` e executar comandos arbitr√°rios. √â necess√°rio encontrar os **gadgets para chamar a syscall espec√≠fica com os par√¢metros**.
* Se o [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) estiverem ativados, ser√° necess√°rio derrot√°-los **para usar os gadgets ROP** do bin√°rio ou bibliotecas.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) pode ser √∫til para preparar o **ret2execve**
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) e [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar v√°rios registradores

#### Via libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): √ötil para chamar uma fun√ß√£o de uma biblioteca (geralmente da **`libc`**) como **`system`** com alguns argumentos preparados (por exemplo, `'/bin/sh'`). √â necess√°rio que o bin√°rio **carregue a biblioteca** com a fun√ß√£o que deseja chamar (geralmente libc).
* Se **compilado estaticamente e sem** [**PIE**](../common-binary-protections-and-bypasses/pie/), o **endere√ßo** de `system` e `/bin/sh` n√£o v√£o mudar, ent√£o √© poss√≠vel us√°-los estaticamente.
* **Sem** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **e conhecendo a vers√£o da libc** carregada, o **endere√ßo** de `system` e `/bin/sh` n√£o v√£o mudar, ent√£o √© poss√≠vel us√°-los estaticamente.
* Com [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **mas sem** [**PIE**](../common-binary-protections-and-bypasses/pie/), conhecendo a libc e com o bin√°rio usando a fun√ß√£o `system` √© poss√≠vel **`ret` para o endere√ßo de system no GOT** com o endere√ßo de `'/bin/sh'` nos par√¢metros (voc√™ precisar√° descobrir isso).
* Com [ASLR](../common-binary-protections-and-bypasses/aslr/) mas sem [PIE](../common-binary-protections-and-bypasses/pie/), conhecendo a libc e **sem o bin√°rio usando o `system`**:
* Use [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) para resolver o endere√ßo de `system` e cham√°-lo&#x20;
* **Burlar** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) e calcular o endere√ßo de `system` e `'/bin/sh'` na mem√≥ria.
* **Com** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **e** [**PIE**](../common-binary-protections-and-bypasses/pie/) **e sem conhecer a libc**: √â necess√°rio:
* Burlar [**PIE**](../common-binary-protections-and-bypasses/pie/)
* Encontrar a **vers√£o da libc** usada (vazar alguns endere√ßos de fun√ß√µes)
* Verificar os **cen√°rios anteriores com ASLR** para continuar.

#### Via EBP/RBP

* [**Stack Pivoting / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Controlar o ESP para controlar o RET atrav√©s do EBP armazenado na pilha.
* √ötil para **estouros de pilha off-by-one**
* √ötil como uma maneira alternativa de controlar o EIP enquanto abusa do EIP para construir a carga na mem√≥ria e ent√£o pular para ela via EBP

#### Misc

* [**Redirecionamento de Ponteiros**](../stack-overflow/pointer-redirecting.md): Caso a pilha contenha ponteiros para uma fun√ß√£o que ser√° chamada ou para uma string que ser√° usada por uma fun√ß√£o interessante (system ou printf), √© poss√≠vel sobrescrever esse endere√ßo.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) podem afetar os endere√ßos.
* [**Vari√°veis n√£o inicializadas**](../stack-overflow/uninitialized-variables.md): Nunca se sabe

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
