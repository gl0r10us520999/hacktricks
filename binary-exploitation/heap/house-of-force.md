# Huis van Krag

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

### Kode

* Hierdie tegniek is gepatch ([**hier**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=30a17d8c95fbfb15c52d1115803b63aaa73a285c)) en veroorsaak hierdie fout: `malloc(): corrupted top size`
* Jy kan die [**kode van hier**](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html) probeer om dit te toets as jy wil.

### Doel

* Die doel van hierdie aanval is om 'n blok in 'n spesifieke adres toe te ken.

### Vereistes

* 'n Oorvloei wat toelaat om die grootte van die boonste blokkop te oorskryf (bv. -1).
* Moet die grootte van die heap-toewysing kan beheer

### Aanval

As 'n aanvaller 'n blok in die adres P wil toeken om 'n waarde hier te oorskryf. Hy begin deur die grootte van die boonste blok met `-1` te oorskryf (miskien met 'n oorvloei). Dit verseker dat malloc nie mmap sal gebruik vir enige toewysing nie, aangesien die Boonste blok altyd genoeg spasie sal h√™.

Bereken dan die afstand tussen die adres van die boonste blok en die teiken spasie om toe te ken. Dit is omdat 'n malloc met daardie grootte uitgevoer sal word om die boonste blok na daardie posisie te skuif. Dit is hoe die verskil/grootte maklik bereken kan word:
```c
// From https://github.com/shellphish/how2heap/blob/master/glibc_2.27/house_of_force.c#L59C2-L67C5
/*
* The evil_size is calulcated as (nb is the number of bytes requested + space for metadata):
* new_top = old_top + nb
* nb = new_top - old_top
* req + 2sizeof(long) = new_top - old_top
* req = new_top - old_top - 2sizeof(long)
* req = target - 2sizeof(long) - old_top - 2sizeof(long)
* req = target - old_top - 4*sizeof(long)
*/
```
Daarom, deur 'n grootte van `teiken - ou_top - 4*sizeof(long)` toe te ken (die 4 longs is as gevolg van die metadata van die boonste brokkie en van die nuwe brokkie wanneer dit toegewys word) sal die boonste brokkie na die adres skuif wat ons wil oorskryf. Dan, doen nog 'n malloc om 'n brokkie te kry wat die aan die begin van die data bevat om die teiken adres te skryf.

### Verwysings & Ander Voorbeelde

* [https://github.com/shellphish/how2heap/tree/master](https://github.com/shellphish/how2heap/tree/master?tab=readme-ov-file)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/)
* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_force)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.27/house\_of\_force.c)
* [https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/house\_force\_exp/index.html)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#hitcon-training-lab-11)
* Die doel van hierdie scenario is 'n ret2win waar ons die adres van 'n funksie wat deur die ret2win funksie geroep gaan word, moet wysig
* Die bin√™re het 'n oorvloei wat misbruik kan word om die boonste brokkie grootte te wysig, wat gewysig word na -1 of p64(0xffffffffffffffff)
* Dan word die adres na die plek waar die wysiger se wysiger bestaan, bereken, en die verskil vanaf die huidige posisie van die boonste brokkie tot daar word toegewys met `malloc`
* Laastens word 'n nuwe brokkie toegewys wat hierdie gewenste teiken binne sal bevat wat oorskryf word deur die ret2win funksie
* [https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp](https://shift--crops-hatenablog-com.translate.goog/entry/2016/03/21/171249?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=en&\_x\_tr\_pto=wapp)
* In die `Voer jou naam in:` is daar 'n aanvanklike kwesbaarheid wat toelaat om 'n adres van die heap te lek
* Dan in die `Org:` en `Host:` funksionaliteit is dit moontlik om die 64B van die `s` wysiger te vul wanneer gevra word vir die **org naam**, wat in die stap gevolg word deur die adres van v2, wat dan gevolg word deur die aangeduide **host naam**. Aangesien dan, gaan strcpy die inhoud van s kopieer na 'n brokkie van grootte 64B, is dit moontlik om **die grootte van die boonste brokkie te oorskryf** met die data wat binne die **host naam** geplaas is.
* Nou dat arbit√™re skryf moontlik is, is die `atoi` se GOT oorskryf na die adres van printf. dit is moontlik om die adres van `IO_2_1_stderr` te lek _met_ `%24$p`. En met hierdie libc lek was dit moontlik om `atoi` se GOT weer te oorskryf met die adres na `system` en dit te roep deur `/bin/sh` as parameter te gee
* 'n Alternatiewe metode [voorgestel in hierdie ander skrywe](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_force/#2016-bctf-bcloud), is om `free` te oorskryf met `puts`, en dan die adres van `atoi@got` by te voeg, in die wysiger wat later vrygelaat sal word sodat dit gelek word en met hierdie lek weer `atoi@got` oorskryf met `system` en dit met `/bin/sh` roep.
* [https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)
* Daar is 'n UAF wat toelaat om 'n brokkie wat vrygelaat is sonder om die wysiger skoon te maak, hergebruik. Omdat daar 'n paar leesmetodes is, is dit moontlik om 'n libc adres te lek deur 'n wysiger na die vry funksie in die GOT hier te skryf en dan die leesfunksie te roep.
* Daarna is House of force gebruik (deur die UAF te misbruik) om die grootte van die oorblywende spasie met 'n -1 te oorskryf, 'n brokkie groot genoeg toe te ken om by die vry haak te kom, en dan 'n ander brokkie toe te ken wat die vry haak sal bevat. Skryf dan in die haak die adres van `system`, skryf in 'n brokkie `"/bin/sh"` en vry uiteindelik die brokkie met daardie string inhoud.

<details>

<summary><strong>Leer AWS hak van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
