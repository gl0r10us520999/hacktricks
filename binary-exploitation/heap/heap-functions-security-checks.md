# ヒープ関数のセキュリティチェック

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## unlink

この関数は、ダブルリンクリストからチャンクを削除します。一般的なチェックにより、チャンクをアンリンクする際にリンクリスト構造が一貫性を保つようにします。

* **一貫性チェック**:
* `P->fd->bk == P` および `P->bk->fd == P` が成立しているかを確認します。
* エラーメッセージ: `corrupted double-linked list`

## \_int\_malloc

この関数はヒープからメモリを割り当てる責務を持ちます。ここでのチェックにより、割り当て中にメモリが破損しないようにします。

* **Fastbinサイズチェック**:
* Fastbinからチャンクを削除する際、チャンクのサイズがFastbinの範囲内にあることを確認します。
* エラーメッセージ: `malloc(): memory corruption (fast)`
* **Smallbin一貫性チェック**:
* Smallbinからチャンクを削除する際、ダブルリンクリスト内の前後のリンクが一貫していることを確認します。
* エラーメッセージ: `malloc(): smallbin double linked list corrupted`
* **Unsorted Binメモリ範囲チェック**:
* アンソートされたビン内のチャンクのサイズが最小値と最大値の範囲内にあることを確認します。
* エラーメッセージ: `malloc(): memory corruption | malloc(): invalid next size (unsorted)`
* **Unsorted Bin一貫性チェック（第1シナリオ）**:
* 残りのチャンクをアンソートされたビンに挿入する際、`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` が成立しているかを確認します。
* エラーメッセージ: `malloc(): corrupted unsorted chunks`
* **Unsorted Bin一貫性チェック（第2シナリオ）**:
* 前のチェックと同様ですが、ファストまたはスモールチャンクを分割して挿入した後にトリガーされます。
* エラーメッセージ: `malloc(): corrupted unsorted chunks 2`

## \_int\_free

この関数は以前に割り当てられたメモリを解放します。ここでのチェックは、適切なメモリ解放を確認し、メモリの破損を防ぎます。

* **ポインタ境界チェック**:
* 解放されるポインタがメモリを周回していないことを確認します。
* エラーメッセージ: `free(): invalid pointer`
* **サイズチェック**:
* 解放されるチャンクのサイズが少なくとも `MINSIZE` または `MALLOC_ALIGNMENT` の倍数であることを確認します。
* エラーメッセージ: `free(): invalid size`
* **Fastbinサイズチェック**:
* Fastbinチャンクの場合、次のチャンクのサイズが最小値と最大値の範囲内にあることを確認します。
* エラーメッセージ: `free(): invalid next size (fast)`
* **Fastbinダブルフリーチェック**:
* Fastbinにチャンクを挿入する際、ヘッドのチャンクが挿入されるチャンクと同じでないことを確認します。
* エラーメッセージ: `double free or corruption (fasttop)`
* **Fastbin一貫性チェック**:
* Fastbinに挿入する際、ヘッドチャンクと挿入されるチャンクのサイズが同じであることを確認します。
* エラーメッセージ: `invalid fastbin entry (free)`
* **Top Chunk一貫性チェック**:
* Fastbinチャンク以外の場合、チャンクがトップチャンクと同じでないことを確認します。
* エラーメッセージ: `double free or corruption (top)`
* **メモリ境界チェック**:
* メモリの次のチャンクがアリーナの境界内にあることを確認します。
* エラーメッセージ: `double free or corruption (out)`
* **Prev\_inuseビットチェック**:
* 次のチャンクの前の使用ビットがマークされていることを確認します。
* エラーメッセージ: `double free or corruption (!prev)`
* **通常のサイズチェック**:
* 次のチャンクのサイズが有効な範囲内にあることを確認します。
* エラーメッセージ: `free(): invalid next size (normal)`
* **Unsorted Bin一貫性チェック**:
* 統合されたチャンクをアンソートされたビンに挿入する際、`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` が成立しているかを確認します。
* エラーメッセージ: `free(): corrupted unsorted chunks`

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
