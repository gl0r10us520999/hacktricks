# House of Einherjar

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちをフォローする [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## 基本情報

### コード

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)から例を確認してください
* または[https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation)から（tcacheを埋める必要があるかもしれません）

### ゴール

* ほぼ任意の特定のアドレスにメモリを割り当てることです。

### 必要条件

* チャンクを割り当てるときに偽のチャンクを作成します：
* サニティチェックをバイパスするためにポインタを自分自身を指すように設定します
* 1つのチャンクからもう1つのチャンクへのオフバイワンを悪用して、前に使用されたものを変更します
* オフバイワンを悪用したチャンクの`prev_size`に、自身と偽のチャンクの間の差を示します
* 偽のチャンクのサイズもサニティチェックをバイパスするために同じサイズに設定されている必要があります
* これらのチャンクを構築するには、ヒープリークが必要です。

### 攻撃

* 攻撃者が制御するチャンク内に`A`偽のチャンクが作成され、元のチャンクを指す`fd`と`bk`で保護をバイパスします
* 他の2つのチャンク（`B`と`C`）が割り当てられます
* `B`のオフバイワンを悪用して、`prev in use`ビットがクリアされ、`C`チャンクが割り当てられた場所から前に使用されたデータが偽の`A`チャンクまでの差で上書きされます
* この`prev_size`と偽のチャンク`A`のサイズはチェックをバイパスするために同じである必要があります。
* 次に、tcacheが埋められます
* 次に、`C`が解放され、偽のチャンク`A`と統合されます
* 次に、偽の`A`チャンクから始まり、`B`チャンクをカバーする新しいチャンク`D`が作成されます
* Einherjarの家はここで終わります
* これはファストビン攻撃で続けることができます：
* `B`を解放してファストビンに追加します
* `B`の`fd`を上書きして、`D`チャンクを悪用してターゲットアドレスを指すようにします（`B`を含むため）
* 次に、2つのmallocが行われ、2番目のmallocは**ターゲットアドレスを割り当てる**ことになります

## 参考文献と他の例

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* ポインタを解放した後、それらがヌル化されないため、まだデータにアクセスできる可能性があります。したがって、チャンクをアンソートされたビンに配置し、それが含むポインタをリークします（libcリーク）、次に新しいヒープをアンソートされたビンに配置し、それが取得するポインタからヒープアドレスをリークします。
