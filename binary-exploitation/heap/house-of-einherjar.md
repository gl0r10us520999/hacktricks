# Casa de Einherjar

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

### C√≥digo

* Revisa el ejemplo en [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* O el de [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (puede ser necesario llenar la tcache)

### Objetivo

* El objetivo es asignar memoria en casi cualquier direcci√≥n espec√≠fica.

### Requisitos

* Crear un chunk falso cuando queremos asignar un chunk:
* Establecer punteros para que apunten a s√≠ mismos y evadir las comprobaciones de integridad
* Desbordar por uno de un chunk a otro para modificar el previo en uso
* Indicar en el `prev_size` del chunk abusado por desbordamiento por uno la diferencia entre √©l mismo y el chunk falso
* El tama√±o del chunk falso tambi√©n debe haber sido establecido con el mismo tama√±o para evadir las comprobaciones de integridad
* Para construir estos chunks, necesitar√°s una fuga de heap.

### Ataque

* Se crea un chunk falso dentro de un chunk controlado por el atacante apuntando con `fd` y `bk` al chunk original para evadir protecciones
* Se asignan 2 otros chunks (`B` y `C`)
* Abusando del desbordamiento por uno en el chunk `B`, se limpia el bit `prev in use` y se sobrescribe los datos de `prev_size` con la diferencia entre el lugar donde se asigna el chunk `C`, al chunk falso `A` generado antes
* Este `prev_size` y el tama√±o en el chunk falso `A` deben ser iguales para evadir las comprobaciones.
* Luego, se llena la tcache
* Luego, se libera `C` para que se consolide con el chunk falso `A`
* Luego, se crea un nuevo chunk `D` que comenzar√° en el chunk falso `A` y cubrir√° el chunk `B`
* La casa de Einherjar termina aqu√≠
* Esto puede continuar con un ataque de fast bin:
* Liberar `B` para agregarlo al fast bin
* Se sobrescribe el `fd` de `B` haciendo que apunte a la direcci√≥n objetivo abusando del chunk `D` (ya que contiene a `B` dentro)&#x20;
* Luego, se realizan 2 mallocs y el segundo va a estar **asignando la direcci√≥n objetivo**

## Referencias y otros ejemplos

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Despu√©s de liberar punteros, no se anulan, por lo que a√∫n es posible acceder a sus datos. Por lo tanto, se coloca un chunk en el bin no ordenado y se filtran los punteros que contiene (fuga de libc) y luego se coloca un nuevo heap en el bin no ordenado y se filtra una direcci√≥n de heap a partir del puntero que se obtiene.
