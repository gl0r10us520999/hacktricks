# Dom Einherjar

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakowania, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe informacje

### Kod

* Sprawdź przykład z [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* Lub z [https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation](https://guyinatuxedo.github.io/42-house\_of\_einherjar/house\_einherjar\_exp/index.html#house-of-einherjar-explanation) (może być konieczne uzupełnienie tcache)

### Cel

* Celem jest alokacja pamięci praktycznie w dowolnym określonym adresie.

### Wymagania

* Utwórz fałszywy kawałek, gdy chcemy zaalokować kawałek:
* Ustaw wskaźniki tak, aby wskazywały na siebie same, aby ominąć kontrole spójności
* Przesunięcie o jeden kawałek do innego w celu zmodyfikowania poprzedniego w użyciu
* Wskaż w `prev_size` nadużywanego kawałka o jeden różnicę między nim a fałszywym kawałkiem
* Rozmiar fałszywego kawałka musi również być ustawiony na ten sam rozmiar, aby ominąć kontrole spójności
* Do skonstruowania tych kawałków będziesz potrzebować wycieku sterty.

### Atak

* `A` fałszywy kawałek jest tworzony wewnątrz kawałka kontrolowanego przez atakującego, wskazując z `fd` i `bk` na oryginalny kawałek, aby ominąć zabezpieczenia
* Alokowane są 2 inne kawałki (`B` i `C`)
* Wykorzystując przesunięcie o jeden w kawałku `B`, bit `prev in use` jest czyszczony, a dane `prev_size` są nadpisywane różnicą między miejscem, w którym jest alokowany kawałek `C`, a fałszywym kawałkiem `A` wygenerowanym wcześniej
* Ten `prev_size` oraz rozmiar w fałszywym kawałku `A` muszą być takie same, aby ominąć kontrole.
* Następnie wypełniana jest tcache
* Następnie `C` jest zwalniane, aby skonsolidowało się z fałszywym kawałkiem `A`
* Następnie tworzony jest nowy kawałek `D`, który będzie zaczynał się w fałszywym kawałku `A` i pokrywał kawałek `B`
* Dom Einherjar kończy się tutaj
* Można kontynuować to atakiem na fast bin:
* Zwolnij `B`, aby dodać go do fast bin
* Nadpisz `fd` `B`, aby wskazywał na docelowy adres nadużywając kawałek `D` (ponieważ zawiera w sobie `B`)&#x20;
* Następnie wykonuje się 2 alokacje i druga z nich będzie **alokować docelowy adres**

## Odwołania i inne przykłady

* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.35/house\_of\_einherjar.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_einherjar/#2016-seccon-tinypad)
* Po zwolnieniu wskaźników nie są one zerowane, więc wciąż można uzyskać do nich dostęp. Dlatego kawałek jest umieszczany w nieposortowanym pojemniku i wyciekane są wskaźniki, które zawiera (wyciek libc), a następnie nowa sterta jest umieszczana w nieposortowanym pojemniku i wyciekany jest adres sterty z wskaźnika, który otrzymuje.
*
