# Casa de Orange

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

### C칩digo

* Encuentra un ejemplo en [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* La t칠cnica de explotaci칩n fue corregida en este [parche](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) por lo que esto ya no funciona (funciona en versiones anteriores a 2.26)
* Mismo ejemplo **con m치s comentarios** en [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Objetivo

* Abusar de la funci칩n `malloc_printerr`

### Requisitos

* Sobrescribir el tama침o del top chunk
* Fugas de libc y heap

### Antecedentes

Algunos antecedentes necesarios de los comentarios de [**este ejemplo**](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)**:**

La cuesti칩n es que, en versiones antiguas de libc, cuando se llamaba a la funci칩n `malloc_printerr`, **iteraba a trav칠s de una lista de estructuras `_IO_FILE` almacenadas en `_IO_list_all`**, y realmente **ejecutaba** un puntero de instrucci칩n en esa estructura.\
Este ataque forjar치 una **estructura `_IO_FILE` falsa** que escribiremos en **`_IO_list_all`**, y provocar치 que se ejecute `malloc_printerr`.\
Luego **ejecutar치 cualquier direcci칩n** que tengamos almacenada en la tabla de saltos de las estructuras **`_IO_FILE`**, y obtendremos ejecuci칩n de c칩digo

### Ataque

El ataque comienza logrando obtener el **top chunk** dentro del **unsorted bin**. Esto se logra llamando a `malloc` con un tama침o mayor al tama침o actual del top chunk pero menor que **`mmp_.mmap_threshold`** (por defecto es 128K), lo que de otro modo activar칤a la asignaci칩n de `mmap`. Siempre que se modifique el tama침o del top chunk, es importante asegurarse de que el **top chunk + su tama침o** est칠 alineado a p치gina y que el bit **prev\_inuse** del top chunk est칠 siempre establecido.

Para obtener el top chunk dentro del unsorted bin, asigna un chunk para crear el top chunk, cambia el tama침o del top chunk (con un desbordamiento en el chunk asignado) de modo que **top chunk + tama침o** est칠 alineado a p치gina con el bit **prev\_inuse** establecido. Luego asigna un chunk m치s grande que el nuevo tama침o del top chunk. Ten en cuenta que `free` nunca se llama para colocar el top chunk en el unsorted bin.

El antiguo top chunk est치 ahora en el unsorted bin. Suponiendo que podemos leer datos dentro de 칠l (posiblemente debido a una vulnerabilidad que tambi칠n caus칩 el desbordamiento), es posible filtrar direcciones de libc desde 칠l y obtener la direcci칩n de **\_IO\_list\_all**.

Se realiza un ataque al unsorted bin abusando del desbordamiento para escribir `topChunk->bk->fwd = _IO_list_all - 0x10`. Cuando se asigna un nuevo chunk, el antiguo top chunk se dividir치, y se escribir치 un puntero al unsorted bin en **`_IO_list_all`**.

El siguiente paso implica reducir el tama침o del antiguo top chunk para que quepa en un bin peque침o, estableciendo espec칤ficamente su tama침o en **0x61**. Esto sirve para dos prop칩sitos:

1. **Inserci칩n en Small Bin 4**: Cuando `malloc` escanea el unsorted bin y ve este chunk, intentar치 insertarlo en el small bin 4 debido a su tama침o peque침o. Esto hace que el chunk termine en la cabeza de la lista del small bin 4 que es la ubicaci칩n del puntero FD del chunk de **`_IO_list_all`** ya que escribimos una direcci칩n cercana en **`_IO_list_all`** a trav칠s del ataque al unsorted bin.
2. **Desencadenar una Verificaci칩n de Malloc**: Esta manipulaci칩n del tama침o del chunk causar치 que `malloc` realice verificaciones internas. Cuando comprueba el tama침o del chunk falso hacia adelante, que ser치 cero, desencadena un error y llama a `malloc_printerr`.

La manipulaci칩n del bin peque침o te permitir치 controlar el puntero hacia adelante del chunk. La superposici칩n con **\_IO\_list\_all** se utiliza para forjar una estructura falsa de **\_IO\_FILE**. La estructura se crea cuidadosamente para incluir campos clave como `_IO_write_base` y `_IO_write_ptr` establecidos en valores que pasan las verificaciones internas en libc. Adem치s, se crea una tabla de saltos dentro de la estructura falsa, donde se establece un puntero de instrucci칩n en la direcci칩n donde se puede ejecutar c칩digo arbitrario (por ejemplo, la funci칩n `system`).

Para resumir la parte restante de la t칠cnica:

* **Reducir el Antiguo Top Chunk**: Ajustar el tama침o del antiguo top chunk a **0x61** para que quepa en un bin peque침o.
* **Configurar la Estructura Falsa de `_IO_FILE`**: Superponer el antiguo top chunk con la falsa estructura de **\_IO\_FILE** y establecer los campos adecuadamente para secuestrar el flujo de ejecuci칩n.

El siguiente paso implica forjar una falsa estructura de **\_IO\_FILE** que se superpone con el antiguo top chunk actualmente en el unsorted bin. Los primeros bytes de esta estructura se crean cuidadosamente para incluir un puntero a un comando (por ejemplo, "/bin/sh") que se ejecutar치.

Los campos clave en la falsa estructura de **\_IO\_FILE**, como `_IO_write_base` y `_IO_write_ptr`, se establecen en valores que pasan las verificaciones internas en libc. Adem치s, se crea una tabla de saltos dentro de la estructura falsa, donde se establece un puntero de instrucci칩n en la direcci칩n donde se puede ejecutar c칩digo arbitrario. Normalmente, esta ser칤a la direcci칩n de la funci칩n `system` u otra funci칩n que pueda ejecutar comandos de shell.

El ataque culmina cuando una llamada a `malloc` desencadena la ejecuci칩n del c칩digo a trav칠s de la estructura manipulada de **\_IO\_FILE**. Esto permite la ejecuci칩n de c칩digo arbitrario, lo que generalmente resulta en el inicio de un shell u otra carga maliciosa.

**Resumen del Ataque:**

1. **Configurar el top chunk**: Asignar un chunk y modificar el tama침o del top chunk.
2. **Forzar el top chunk en el unsorted bin**: Asignar un chunk m치s grande.
3. **Fugas de direcciones de libc**: Utilizar la vulnerabilidad para leer desde el unsorted bin.
4. **Realizar el ataque al unsorted bin**: Escribir en **\_IO\_list\_all** utilizando un desbordamiento.
5. **Reducir el antiguo top chunk**: Ajustar su tama침o para que quepa en un bin peque침o.
6. **Configurar una estructura falsa de \_IO\_FILE**: Forjar una estructura de archivo falsa para secuestrar el flujo de control.
7. **Desencadenar la ejecuci칩n de c칩digo**: Asignar un chunk para ejecutar el ataque y ejecutar c칩digo arbitrario.

Este enfoque explota los mecanismos de gesti칩n de heap, las fugas de informaci칩n de libc y los desbordamientos de heap para lograr la ejecuci칩n de c칩digo sin llamar directamente a `free`. Al crear cuidadosamente la falsa estructura de **\_IO\_FILE** y colocarla en la ubicaci칩n correcta, el ataque puede secuestrar el flujo de control durante las operaciones est치ndar de asignaci칩n de memoria. Esto permite la ejecuci칩n de c칩digo arbitrario, lo que potencialmente resulta en un shell u otras actividades maliciosas.
## Referencias

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
