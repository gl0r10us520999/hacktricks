# Huis van Oranje

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

### Kode

* Vind 'n voorbeeld in [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_orange.c)
* Die uitbuitingstegniek is reggestel in hierdie [patch](https://sourceware.org/git/?p=glibc.git;a=blobdiff;f=stdlib/abort.c;h=117a507ff88d862445551f2c07abb6e45a716b75;hp=19882f3e3dc1ab830431506329c94dcf1d7cc252;hb=91e7cf982d0104f0e71770f5ae8e3faf352dea9f;hpb=0c25125780083cbba22ed627756548efe282d1a0) sodat dit nie meer werk nie (werk in vroe√´r as 2.26)
* Dieselfde voorbeeld **met meer kommentaar** in [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

### Doel

* Misbruik die `malloc_printerr`-funksie

### Vereistes

* Oorskryf die boonste brokkie grootte
* Libc en heap lekke

### Agtergrond

Sekere nodige agtergrond uit die kommentaar van **hierdie voorbeeld**:

Ding is, in ouer weergawes van libc, toe die `malloc_printerr`-funksie geroep is, sou dit **deur 'n lys van `_IO_FILE`-strukture wat in `_IO_list_all` gestoor is, blaai**, en eintlik 'n instruksie-aanwysers in daardie struktuur **uitvoer**.\
Hierdie aanval sal 'n **vals `_IO_FILE`-struktuur** vervals wat ons na **`_IO_list_all`** sal skryf, en veroorsaak dat `malloc_printerr` loop.\
Dan sal dit **uitvoer watookal adres** ons in die **`_IO_FILE`**-strukture se springtabel gestoor het, en ons sal kode-uitvoering kry

### Aanval

Die aanval begin deur die **boonste brokkie** binne die **ongesorteerde bin** te bestuur. Dit word bereik deur `malloc` te roep met 'n groter grootte as die huidige boonste brokkie grootte maar kleiner as **`mmp_.mmap_threshold`** (standaard is 128K), wat andersins `mmap` toekenning sou veroorsaak. Wanneer die boonste brokkie grootte gewysig word, is dit belangrik om te verseker dat die **boonste brokkie + sy grootte** bladsy-uitgelyn is en dat die **prev\_inuse**-bit van die boonste brokkie altyd ingestel is.

Om die boonste brokkie binne die ongesorteerde bin te kry, allokeer 'n brokkie om die boonste brokkie te skep, verander die boonste brokkie grootte (met 'n oorvloei in die toegedeelde brokkie) sodat **boonste brokkie + grootte** bladsy-uitgelyn is met die **prev\_inuse**-bit wat ingestel is. Allokeer dan 'n brokkie groter as die nuwe boonste brokkie grootte. Let daarop dat `free` nooit geroep word om die boonste brokkie in die ongesorteerde bin te kry.

Die ou boonste brokkie is nou in die ongesorteerde bin. Mits ons data binne-in dit kan lees (moontlik as gevolg van 'n kwesbaarheid wat ook die oorvloei veroorsaak het), is dit moontlik om libc-adresse daaruit te lek en die adres van **\_IO\_list\_all** te kry.

'n Ongeordende bin-aanval word uitgevoer deur die oorvloei te misbruik om `topChunk->bk->fwd = _IO_list_all - 0x10` te skryf. Wanneer 'n nuwe brokkie toegewys word, sal die ou boonste brokkie verdeel word, en 'n aanwysing na die ongesorteerde bin sal in **`_IO_list_all`** geskryf word.

Die volgende stap behels die verkleining van die grootte van die ou boonste brokkie om in 'n klein bin te pas, spesifiek deur sy grootte na **0x61** in te stel. Dit dien twee doeleindes:

1. **Invoeging in Klein Bin 4**: Wanneer `malloc` deur die ongesorteerde bin skandeer en hierdie brokkie sien, sal dit probeer om dit in klein bin 4 in te voeg weens sy klein grootte. Dit maak dat die brokkie aan die kop van die klein bin 4-lys beland wat die ligging van die FD-aanwyser van die brokkie van **`_IO_list_all`** is aangesien ons 'n naby adres in **`_IO_list_all`** geskryf het via die ongesorteerde bin-aanval.
2. **Aanroeping van 'n Malloc Kontrole**: Hierdie brokkie grootte-manipulasie sal veroorsaak dat `malloc` interne kontroles uitvoer. Wanneer dit die grootte van die valse voorwaartse brokkie nagaan, wat nul sal wees, veroorsaak dit 'n fout en roep `malloc_printerr` aan.

Die manipulasie van die klein bin sal jou in staat stel om die voorwaartse aanwyser van die brokkie te beheer. Die oorvleuel met **\_IO\_list\_all** word gebruik om 'n vals **\_IO\_FILE**-struktuur te vervals. Die struktuur word sorgvuldig saamgestel om sleutelvelde soos `_IO_write_base` en `_IO_write_ptr` in te sluit wat ingestel is op waardes wat interne kontroles in libc slaag. Daarbenewens word 'n springtabel binne die valse struktuur geskep, waar 'n instruksie-aanwyser na die adres waar arbitr√™re kode (bv., die `system`-funksie) uitgevoer kan word, ingestel is.

Om die res van die tegniek saam te vat:

* **Verklein die Ou Boonste Brokkie**: Pas die grootte van die ou boonste brokkie aan na **0x61** om dit in 'n klein bin te pas.
* **Stel die Valse `_IO_FILE`-Struktuur op**: Oorvleuel die ou boonste brokkie met die valse **\_IO\_FILE**-struktuur en stel velde toepaslik in om beheervloei te kap.
  
Die volgende stap behels die vervalsing van 'n valse **\_IO\_FILE**-struktuur wat oorvleuel met die ou boonste brokkie wat tans in die ongesorteerde bin is. Die eerste bytes van hierdie struktuur word sorgvuldig saamgestel om 'n aanwyser na 'n bevel (bv., "/bin/sh") wat uitgevoer sal word, in te sluit.

Sleutelvelde in die valse **\_IO\_FILE**-struktuur, soos `_IO_write_base` en `_IO_write_ptr`, word ingestel op waardes wat interne kontroles in libc slaag. Daarbenewens word 'n springtabel binne die valse struktuur geskep, waar 'n instruksie-aanwyser na die adres waar arbitr√™re kode uitgevoer kan word, ingestel is. Tipies sal dit die adres van die `system`-funksie of 'n ander funksie wees wat skelmkommando's kan uitvoer.

Die aanval bereik 'n hoogtepunt wanneer 'n oproep na `malloc` die uitvoering van die kode deur die gemanipuleerde **\_IO\_FILE**-struktuur veroorsaak. Dit maak dit moontlik vir arbitr√™re kode-uitvoering, wat tipies lei tot 'n skul of 'n ander skadelike lading wat uitgevoer word.

**Opsomming van die Aanval:**

1. **Stel die boonste brokkie op**: Allokeer 'n brokkie en wysig die boonste brokkie grootte.
2. **Dwing die boonste brokkie in die ongesorteerde bin**: Allokeer 'n groter brokkie.
3. **Lek libc-adresse**: Gebruik die kwesbaarheid om uit die ongesorteerde bin te lees.
4. **Voer die ongesorteerde bin-aanval uit**: Skryf na **\_IO\_list\_all** deur 'n oorvloei.
5. **Verklein die ou boonste brokkie**: Pas sy grootte aan om in 'n klein bin te pas.
6. **Stel 'n valse \_IO\_FILE-struktuur op**: Vervals 'n valse l√™erstruktuur om beheervloei te kap.
7. **Trigger kode-uitvoering**: Allokeer 'n brokkie om die aanval uit te voer en arbitr√™re kode uit te voer.

Hierdie benadering maak gebruik van hoopbestuursmeganismes, libc-inligtingslekkasies, en hoopoorvloei om kode-uitvoering te bereik sonder om direk `free` te roep. Deur die valse **\_IO\_FILE**-struktuur sorgvuldig saam te stel en dit op die regte plek te plaas, kan die aanval die beheervloei tydens standaard geheue-toekenningsoperasies kap. Dit maak die uitvoering van arbitr√™re kode moontlik, wat moontlik lei tot 'n skul of ander skadelike aktiwiteite.
## Verwysings

* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_orange/)
* [https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html](https://guyinatuxedo.github.io/43-house\_of\_orange/house\_orange\_exp/index.html)

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag. 

</details>
