# Ataque ao Tcache Bin

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Para mais informa√ß√µes sobre o que √© um tcache bin, confira esta p√°gina:

{% content-ref url="bins-and-memory-allocations.md" %}
[bins-and-memory-allocations.md](bins-and-memory-allocations.md)
{% endcontent-ref %}

Em primeiro lugar, observe que o Tcache foi introduzido na vers√£o 2.26 do glibc.

O ataque **Tcache** proposto na [**p√°gina guyinatuxido**](https://guyinatuxedo.github.io/29-tcache/tcache\_explanation/index.html) √© muito semelhante ao ataque fast bin, onde o objetivo √© sobrescrever o ponteiro para o pr√≥ximo chunk no bin dentro de um chunk liberado para um endere√ßo arbitr√°rio, para posteriormente ser poss√≠vel **alocar esse endere√ßo espec√≠fico e potencialmente sobrescrever ponteiros**.

No entanto, atualmente, se voc√™ executar o c√≥digo mencionado, receber√° o erro: **`malloc(): unaligned tcache chunk detected`**. Portanto, √© necess√°rio escrever um endere√ßo alinhado no novo ponteiro (ou executar o bin√°rio v√°rias vezes para que o endere√ßo escrito esteja realmente alinhado).

### Ataque aos √≠ndices do Tcache

Normalmente √© poss√≠vel encontrar no in√≠cio do heap um chunk contendo a **quantidade de chunks por √≠ndice** dentro do tcache e o endere√ßo do **chunk principal de cada √≠ndice do tcache**. Se, por algum motivo, for poss√≠vel modificar essas informa√ß√µes, seria poss√≠vel **fazer o chunk principal de algum √≠ndice apontar para um endere√ßo desejado** (como o malloc hook) para ent√£o alocar um chunk do tamanho do √≠ndice e sobrescrever o conte√∫do do malloc hook neste caso.

## Exemplos

* CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19\_babyheap/index.html)
* **Vazamento de informa√ß√µes do Libc**: √â poss√≠vel preencher os tcaches, adicionar um chunk na lista n√£o ordenada, esvaziar o tcache e **realocar o chunk da lista n√£o ordenada** sobrescrevendo apenas os primeiros 8B, deixando o **segundo endere√ßo para o Libc do chunk intacto para que possamos l√™-lo**.
* **Ataque ao Tcache**: O bin√°rio √© vulner√°vel a um overflow de heap de 1B. Isso ser√° abusado para alterar o **cabe√ßalho de tamanho** de um chunk alocado, tornando-o maior. Em seguida, este chunk ser√° **liberado**, adicionando-o ao tcache de chunks do tamanho falso. Em seguida, alocaremos um chunk com o tamanho falsificado, e o chunk anterior ser√° **retornado sabendo que este chunk era realmente menor** e isso nos d√° a oportunidade de **sobrescrever o pr√≥ximo chunk na mem√≥ria**.\
Vamos abusar disso para **sobrescrever o ponteiro FD do pr√≥ximo chunk** para apontar para **`malloc_hook`**, ent√£o √© poss√≠vel alocar 2 ponteiros: primeiro o ponteiro leg√≠timo que acabamos de modificar e, em seguida, a segunda aloca√ß√£o retornar√° um chunk em **`malloc_hook`** que pode ser abusado para escrever um **one gadget**.
* CTF [https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19\_cpp/index.html)
* **Vazamento de informa√ß√µes do Libc**: H√° um uso ap√≥s free e um double free. Neste writeup, o autor vazou um endere√ßo do Libc lendo o endere√ßo de um chunk colocado em um bin pequeno (como vazando-o do bin n√£o ordenado, mas do pequeno).
* **Ataque ao Tcache**: Um Tcache √© realizado via um **double free**. O mesmo chunk √© liberado duas vezes, ent√£o dentro do Tcache o chunk apontar√° para si mesmo. Em seguida, ele √© alocado, seu ponteiro FD √© modificado para apontar para o **free hook** e ent√£o √© alocado novamente para que o pr√≥ximo chunk na lista esteja no free hook. Em seguida, isso tamb√©m √© alocado e √© poss√≠vel escrever o endere√ßo do `system` aqui, ent√£o quando um malloc contendo `"/bin/sh"` √© liberado, obtemos um shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps0/index.html)
* A principal vulnerabilidade aqui √© a capacidade de `liberar` qualquer endere√ßo no heap indicando seu deslocamento
* **Ataque aos √≠ndices do Tcache**: √â poss√≠vel alocar e liberar um chunk de um tamanho que, quando armazenado dentro do chunk do tcache (o chunk com as informa√ß√µes dos bins do tcache), gerar√° um **endere√ßo com o valor 0x100**. Isso ocorre porque o tcache armazena a quantidade de chunks em cada bin em bytes diferentes, portanto um chunk em um √≠ndice espec√≠fico gera o valor 0x100.
* Em seguida, esse valor parece que h√° um chunk de tamanho 0x100. Permitindo abusar disso ao `liberar` este endere√ßo. Isso ir√° **adicionar esse endere√ßo ao √≠ndice de chunks de tamanho 0x100 no tcache**.
* Em seguida, **alocando** um chunk de tamanho **0x100**, o endere√ßo anterior ser√° retornado como um chunk, permitindo sobrescrever outros √≠ndices do tcache.\
Por exemplo, colocar o endere√ßo do malloc hook em um deles e alocar um chunk do tamanho desse √≠ndice conceder√° um chunk no calloc hook, o que permite escrever um one gadget para obter um shell.
* CTF [https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html](https://guyinatuxedo.github.io/44-more\_tcache/csaw19\_popping\_caps1/index.html)
* Mesma vulnerabilidade que antes com uma restri√ß√£o extra
* **Ataque aos √≠ndices do Tcache**: Ataque semelhante ao anterior, mas usando menos etapas ao **liberar o chunk que cont√©m as informa√ß√µes do tcache** para que seu endere√ßo seja adicionado ao √≠ndice do tcache de seu tamanho, permitindo alocar esse tamanho e obter as informa√ß√µes do chunk do tcache como um chunk, o que permite adicionar o free hook como o endere√ßo de um √≠ndice, aloc√°-lo e escrever um one gadget nele.

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
