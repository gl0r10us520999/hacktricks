# WWW2Exec - .dtors & .fini\_array

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## .dtors

{% hint style="danger" %}
De nos jours, il est tr√®s **√©trange de trouver un binaire avec une section .dtors !**
{% endhint %}

Les destructeurs sont des fonctions qui sont **ex√©cut√©es avant la fin du programme** (apr√®s le retour de la fonction `main`).\
Les adresses de ces fonctions sont stock√©es √† l'int√©rieur de la section **`.dtors`** du binaire et donc, si vous parvenez √† **√©crire** l'**adresse** d'un **shellcode** dans **`__DTOR_END__`**, cela sera **ex√©cut√©** avant la fin des programmes.

Obtenez l'adresse de cette section avec :
```bash
objdump -s -j .dtors /exec
rabin -s /exec | grep ‚Äú__DTOR‚Äù
```
G√©n√©ralement, vous trouverez les marqueurs **DTOR** **entre** les valeurs `ffffffff` et `00000000`. Donc si vous voyez juste ces valeurs, cela signifie qu'**aucune fonction n'est enregistr√©e**. **√âcrasez** donc le **`00000000`** avec l'**adresse** du **shellcode** pour l'ex√©cuter.

{% hint style="warning" %}
Bien s√ªr, vous devez d'abord trouver un **endroit pour stocker le shellcode** afin de pouvoir l'appeler ult√©rieurement.
{% endhint %}

## **.fini\_array**

Essentiellement, il s'agit d'une structure avec des **fonctions qui seront appel√©es** avant la fin du programme, comme les **`.dtors`**. C'est int√©ressant si vous pouvez appeler votre **shellcode en sautant √† une adresse**, ou dans des cas o√π vous devez retourner √† **`main`** pour **exploiter la vuln√©rabilit√© une deuxi√®me fois**.
```bash
objdump -s -j .fini_array ./greeting

./greeting:     file format elf32-i386

Contents of section .fini_array:
8049934 a0850408

#Put your address in 0x8049934
```
Notez que lorsque qu'une fonction de **`.fini_array`** est ex√©cut√©e, elle passe √† la suivante, donc elle ne sera pas ex√©cut√©e plusieurs fois (√©vitant les boucles infinies), mais elle vous donnera √©galement seulement **1 ex√©cution de la fonction** plac√©e ici.

Notez que les entr√©es dans `.fini_array` sont appel√©es dans l'ordre **inverse**, donc vous voudrez probablement commencer √† √©crire √† partir de la derni√®re.

#### Boucle infinie

Pour abuser de **`.fini_array`** pour obtenir une boucle infinie, vous pouvez [**v√©rifier ce qui a √©t√© fait ici**](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)**:** Si vous avez au moins 2 entr√©es dans **`.fini_array`**, vous pouvez :

* Utiliser votre premier write pour **appeler √† nouveau la fonction d'√©criture arbitraire vuln√©rable**
* Ensuite, calculer l'adresse de retour dans la pile stock√©e par **`__libc_csu_fini`** (la fonction qui appelle toutes les fonctions `.fini_array`) et y mettre l'**adresse de `__libc_csu_fini`**
* Cela fera que **`__libc_csu_fini`** s'appelle lui-m√™me √† nouveau en ex√©cutant les fonctions **`.fini_array`** √† nouveau, ce qui appellera la fonction WWW vuln√©rable 2 fois : une pour **l'√©criture arbitraire** et une autre pour √©craser √† nouveau l'**adresse de retour de `__libc_csu_fini`** sur la pile pour s'appeler √† nouveau.

{% hint style="danger" %}
Notez qu'avec [**Full RELRO**](../common-binary-protections-and-bypasses/relro.md)**,** la section **`.fini_array`** est rendue **en lecture seule**.
Dans les versions plus r√©centes, m√™me avec [**Partial RELRO**], la section **`.fini_array`** est √©galement rendue **en lecture seule**.
{% endhint %}

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
