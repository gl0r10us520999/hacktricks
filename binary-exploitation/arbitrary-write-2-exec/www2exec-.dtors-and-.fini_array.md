# WWW2Exec - .dtors & .fini\_array

{% hint style="success" %}
AWSハッキングの学習と練習:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と練習: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加**または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して**ハッキングテクニックを共有**してください。

</details>
{% endhint %}

## .dtors

{% hint style="danger" %}
現在、**.dtorsセクションを持つバイナリを見つけるのは非常に珍しいです！**
{% endhint %}

デストラクタは、**`main`関数が返る後に実行される関数**です。\
これらの関数のアドレスは、バイナリの**`.dtors`**セクションに格納されており、したがって、**`__DTOR_END__`**に**シェルコードのアドレスを書き込む**ことができれば、それはプログラムが終了する前に**実行**されます。

このセクションのアドレスを取得するには、次のコマンドを使用します:
```bash
objdump -s -j .dtors /exec
rabin -s /exec | grep “__DTOR”
```
通常、**DTOR** マーカーは値 `ffffffff` と `00000000` の間にあります。したがって、これらの値だけを見ると、**登録された関数がない**ことを意味します。そのため、**`00000000`** を **シェルコードのアドレス** で上書きして、それを実行します。

{% hint style="warning" %}
もちろん、後でそれを呼び出すために **シェルコードを保存する場所を見つける** 必要があります。
{% endhint %}

## **.fini\_array**

基本的に、これはプログラムが終了する前に呼び出される**関数のセット**であり、**`.dtors`** のようなものです。これは、**アドレスにジャンプしてシェルコードを呼び出す**ことができる場合や、**脆弱性を2回目に悪用するために再び `main` に戻る**必要がある場合に興味深いです。
```bash
objdump -s -j .fini_array ./greeting

./greeting:     file format elf32-i386

Contents of section .fini_array:
8049934 a0850408

#Put your address in 0x8049934
```
#### エターナルループ

**`.fini_array`** からの関数が実行されると、次の関数に移動するため、複数回実行されることはありません（永遠のループを防ぎます）。ただし、ここに配置された**関数の実行**は1回だけ行われます。

**`.fini_array`** のエントリは**逆順**で呼び出されるため、おそらく最後のエントリから書き始めたいと思うでしょう。

**`.fini_array`** を悪用してエターナルループを作成するには、[**ここで行われた内容を確認してください**](https://guyinatuxedo.github.io/17-stack\_pivot/insomnihack18\_onewrite/index.html)**:** **`.fini_array`** に少なくとも2つのエントリがある場合、次のようにすることができます：

- 最初の書き込みを使用して、**脆弱な任意の書き込み関数**を再度呼び出す
- 次に、**`__libc_csu_fini`** によって保存されたスタック内のリターンアドレスを計算し、そこに**`__libc_csu_fini`** のアドレスを配置する
- これにより、**`__libc_csu_fini`** が自身を再度呼び出し、**`.fini_array`** 関数が再度実行され、脆弱なWWW関数が2回呼び出されます：**任意の書き込み**用に1回、そして**`__libc_csu_fini`** のリターンアドレスを再度上書きして自身を再度呼び出すためのもう1回。

{% hint style="danger" %}
[**Full RELRO**](../common-binary-protections-and-bypasses/relro.md)****を使用すると、**`.fini_array`** セクションは**読み取り専用**になります。
新しいバージョンでは、[**Partial RELRO**] を使用しても、**`.fini_array`** セクションは**読み取り専用**になります。
{% endhint %}

{% hint style="success" %}
AWSハッキングの学習と実践：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングの学習と実践：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksのサポート</summary>

- [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェック！
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
- **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、ハッキングトリックを共有してください。

</details>
{% endhint %}
