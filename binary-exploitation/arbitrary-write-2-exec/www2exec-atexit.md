# WWW2Exec - atexit(), TLS Storage & Other mangled Pointers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **\_\_atexit Structures**

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдЗрд╕реЗ **рд╢реЛрд╖рдг рдХрд░рдирд╛ рдмрд╣реБрдд рдЕрдЬреАрдм рд╣реИ!**
{% endhint %}

**`atexit()`** рдПрдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЕрдиреНрдп рдлрд╝рдВрдХреНрд╢рди рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред** рдпреЗ **рдлрд╝рдВрдХреНрд╢рди** рддрдм **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рд╣реЛрдВрдЧреЗ рдЬрдм **`exit()`** рдпрд╛ **main** рдХрд╛ **рд░рд┐рдЯрд░реНрди** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдпрджрд┐ рдЖрдк рдЗрди **рдлрд╝рдВрдХреНрд╢рдиреЛрдВ** рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдХреЗ **рдкрддреЗ** рдХреЛ рдПрдХ рд╢реЗрд▓рдХреЛрдб рдХреА рдУрд░ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдкрд░ **рдирд┐рдпрдВрддреНрд░рдг** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИред\
рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ **рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ** рдХрдИ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкреАрдЫреЗ **рдЫрд┐рдкреЗ** рд╣реБрдП рд╣реИрдВ рдФрд░ рдЕрдВрддрддрдГ рдЬрд┐рд╕ рдкрддреЗ рдХреА рдУрд░ рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ рдирд╣реАрдВ рд╣реИрдВ, рдмрд▓реНрдХрд┐ **XOR** рдФрд░ рдПрдХ **рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде рд╡рд┐рд╕реНрдерд╛рдкрдиреЛрдВ рдХреЗ рд╕рд╛рде **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдпрд╣ рд╣рдорд▓рд╛ рд╡реЗрдХреНрдЯрд░ **рдХрдо рд╕реЗ рдХрдо x86** рдФрд░ **x64\_86** рдкрд░ **рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реИред**\
**рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдлрд╝рдВрдХреНрд╢рди** **`PTR_MANGLE`** рд╣реИред **рдЕрдиреНрдп рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░** рдЬреИрд╕реЗ m68k, mips32, mips64, aarch64, arm, hppa... **рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди** рдлрд╝рдВрдХреНрд╢рди рдХреЛ **рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рд╡рд╣реА рд▓реМрдЯрд╛рддрд╛ рд╣реИ** рдЬреЛ рдЗрд╕реЗ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдорд┐рд▓рд╛ред рдЗрд╕рд▓рд┐рдП рдпреЗ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдЗрд╕ рд╡реЗрдХреНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдВрдЧреЗред

рдЖрдк рдЗрд╕ рдкрд░ рдЧрд╣рди рд╡реНрдпрд╛рдЦреНрдпрд╛ [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## link\_map

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure) рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо `return` рдпрд╛ `exit()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ `__run_exit_handlers()` рдХреЛ рдЪрд▓рд╛рдПрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рдбреЗрд╕реНрдЯреНрд░рдХреНрдЯрд░реНрд╕ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

{% hint style="danger" %}
рдпрджрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо **`_exit()`** рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`exit` syscall** рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рдирд┐рдХрд╛рд╕реА рд╣реИрдВрдбрд▓рд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП, рдпрд╣ рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ `__run_exit_handlers()` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЖрдк рдЙрд╕ рдкрд░ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХреЛрдб рд╣реИ ([source](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ `map -> l_addr + fini_array -> d_un.d_ptr` рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕реНрдерд╛рди** рдХреА **рдЧрдгрдирд╛** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ **рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреЗ рдХреЙрд▓ рдХреЗ рд▓рд┐рдП**ред

рдХреБрдЫ **рд╡рд┐рдХрд▓реНрдк** рд╣реИрдВ:

* `map->l_addr` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рдПрдХ **рдирдХрд▓реА `fini_array`** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗ рдЬрд┐рд╕рдореЗрдВ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢ рд╣реЛрдВред
* `l_info[DT_FINI_ARRAY]` рдФрд░ `l_info[DT_FINI_ARRAYSZ]` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ (рдЬреЛ рдЕрдзрд┐рдХ рдпрд╛ рдХрдо рдореЗрдореЛрд░реА рдореЗрдВ рд▓рдЧрд╛рддрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ), рддрд╛рдХрд┐ рд╡реЗ **рдПрдХ рдЬрд╛рд▓реА `Elf64_Dyn`** рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗрдВ рдЬреЛ рдлрд┐рд░ рд╕реЗ **`array` рдХреЛ рдПрдХ рдореЗрдореЛрд░реА** рдХреНрд╖реЗрддреНрд░ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗрдЧрд╛ рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ред&#x20;
* [**рдпрд╣ рд▓реЗрдЦ**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) `l_info[DT_FINI_ARRAY]` рдХреЛ `.bss` рдореЗрдВ рдирд┐рдпрдВрддреНрд░рд┐рдд рдореЗрдореЛрд░реА рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдирдХрд▓реА `fini_array` рд╣реИред рдпрд╣ рдирдХрд▓реА рдРрд░реЗ **рдкрд╣рд▓реЗ рдПрдХ** [**рдПрдХ рдЧреЗрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **рдкрддрд╛** рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд┐рд░ рдЗрд╕ **рдирдХрд▓реА рдРрд░реЗ** рдХреЗ рдкрддреЗ рдФрд░ **`map->l_addr`** рдХреЗ рдорд╛рди рдХреЗ рдмреАрдЪ рдХрд╛ **рдЕрдВрддрд░** рддрд╛рдХрд┐ `*array` рдирдХрд▓реА рдРрд░реЗ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗред
* рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдореБрдЦреНрдп рдкреЛрд╕реНрдЯ рдФрд░ [**рдЗрд╕ рд▓реЗрдЦ**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) рдХреЗ рдЕрдиреБрд╕рд╛рд░ ld.so рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рдЫреЛрдбрд╝рддрд╛ рд╣реИ рдЬреЛ ld.so рдореЗрдВ рдмрд╛рдЗрдирд░реА `link_map` рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИред рдПрдХ рдордирдорд╛рдиреЗ рд▓реЗрдЦрди рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХ рдирдХрд▓реА `fini_array` рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ [**рдПрдХ рдЧреЗрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) рдХрд╛ рдкрддрд╛ рд╣реЛ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред

рдкрд┐рдЫрд▓реЗ рдХреЛрдб рдХреЗ рдмрд╛рдж рдЖрдк рдХреЛрдб рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рджрд┐рд▓рдЪрд╕реНрдк рдЕрдиреБрднрд╛рдЧ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `map->l_info[DT_FINI]` рдХреЗ рдорд╛рди рдХреЛ рдПрдХ рдЬрд╛рд▓реА `ElfW(Dyn)` рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред [**рдпрд╣рд╛рдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure).

## TLS-Storage dtor\_list рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ **`__run_exit_handlers`** рдореЗрдВ

рдЬреИрд╕рд╛ рдХрд┐ [**рдпрд╣рд╛рдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), рдпрджрд┐ рдХреЛрдИ рдкреНрд░реЛрдЧреНрд░рд╛рдо `return` рдпрд╛ `exit()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`__run_exit_handlers()`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ рдХрд┐рд╕реА рднреА рдкрдВрдЬреАрдХреГрдд рдбреЗрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

`_run_exit_handlers()` рд╕реЗ рдХреЛрдб:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
**`__call_tls_dtors()`** рдХрд╛ рдХреЛрдб:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдЬреАрдХреГрдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП **`tls_dtor_list`**, рдпрд╣ **`cur->func`** рд╕реЗ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдбрд┐рдореИрдВрдЧрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ рддрд░реНрдХ **`cur->obj`** рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ [**GEF рдХреЗ рдлреЛрд░реНрдХ**](https://github.com/bata24/gef) рд╕реЗ **`tls`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдпрд╣ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`dtor_list`** **stack canary** рдФрд░ **PTR_MANGLE cookie** рдХреЗ рдмрд╣реБрдд **рдХрд░реАрдм** рд╣реИред рдЗрд╕рд▓рд┐рдП, рдЗрд╕рдХреЗ рдУрд╡рд░рдлреНрд▓реЛ рдХреЗ рд╕рд╛рде **cookie** рдФрд░ **stack canary** рдХреЛ **overwrite** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ред\
PTR_MANGLE cookie рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддреЗ рд╣реБрдП, **`PTR_DEMANLE` рдлрд╝рдВрдХреНрд╢рди** рдХреЛ 0x00 рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ **bypass** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ **`xor`** рдХреЗрд╡рд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрддрд╛ рд╣реИред рдлрд┐рд░, **`dtor_list`** рдкрд░ рд▓рд┐рдЦрдХрд░, **рдХрдИ рдлрд╝рдВрдХреНрд╢рдВрд╕** рдХреЛ рдлрд╝рдВрдХреНрд╢рди **рдкрддреЗ** рдФрд░ рдЗрд╕рдХреЗ **рддрд░реНрдХ** рдХреЗ рд╕рд╛рде **рдЪреЗрди** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рдЕрдВрдд рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕рдВрдЧреНрд░рд╣реАрдд рдкреЙрдЗрдВрдЯрд░ рдХреЗрд╡рд▓ cookie рдХреЗ рд╕рд╛рде xored рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдмрд▓реНрдХрд┐ 17 рдмрд┐рдЯреНрд╕ рднреА рдШреБрдорд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдПрдХ рдирдпрд╛ рдкрддрд╛ рдЬреЛрдбрд╝рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЗрд╕реЗ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред

[**рдореВрд▓ рдкреЛрд╕реНрдЯ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) рдореЗрдВ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдЦреЛрдЬреЗрдВред

## рдЕрдиреНрдп рдордВрдЧрд▓реЗ рд╣реБрдП рдкреЙрдЗрдВрдЯрд░реНрд╕ **`__run_exit_handlers`** рдореЗрдВ

рдпрд╣ рддрдХрдиреАрдХ [**рдпрд╣рд╛рдВ рд╕рдордЭрд╛рдИ рдЧрдИ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) рдФрд░ рдлрд┐рд░ рд╕реЗ рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ рдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо **`return` рдпрд╛ `exit()`** рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╕рдордп рд╕рдорд╛рдкреНрдд рд╣реЛ рд░рд╣рд╛ рд╣реИ рддрд╛рдХрд┐ **`__run_exit_handlers()`** рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЖрдЗрдП рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЕрдзрд┐рдХ рдХреЛрдб рджреЗрдЦреЗрдВ:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
The variable `f` **`initial`** рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ `f->flavor` рдХреЗ рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп рдХрд╛ рдкрддрд╛ рдПрдХ рдЕрд▓рдЧ рд╕реНрдерд╛рди рдкрд░ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рд╣рдореЗрд╢рд╛ **demangled** рд╣реЛрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╡рд┐рдХрд▓реНрдк **`ef_on`** рдФрд░ **`ef_cxa`** рдореЗрдВ рдПрдХ **argument** рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рднреА рд╕рдВрднрд╡ рд╣реИред

рдЖрдк **`initial` рд╕рдВрд░рдЪрдирд╛** рдХреЛ GEF рдХреЗ рд╕рд╛рде рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕рддреНрд░ рдореЗрдВ **`gef> p initial`** рдХреЗ рд╕рд╛рде рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдпрд╛ рддреЛ **leak рдпрд╛ `PTR_MANGLE`cookie** рдХреЛ рдорд┐рдЯрд╛рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдлрд┐рд░ `system('/bin/sh')` рдХреЗ рд╕рд╛рде `initial` рдореЗрдВ рдПрдХ `cxa` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдЖрдк рдЗрд╕реЗ [**рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) рдореЗрдВ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
