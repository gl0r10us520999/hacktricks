# WWW2Exec - atexit(), TLSã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ & ãã®ä»–ã®æ··ä¹±ã—ãŸãƒã‚¤ãƒ³ã‚¿

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## **\_\_atexitæ§‹é€ ä½“**

{% hint style="danger" %}
ç¾åœ¨ã€ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã®ã¯éå¸¸ã«**å¥‡å¦™ã§ã™ï¼**
{% endhint %}

**`atexit()`**ã¯ã€**ä»–ã®é–¢æ•°ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹**é–¢æ•°ã§ã™ã€‚ã“ã‚Œã‚‰ã®**é–¢æ•°**ã¯ã€**`exit()`**ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€**main**ã®**æˆ»ã‚Š**æ™‚ã«**å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚\
ã‚‚ã—ã“ã‚Œã‚‰ã®**é–¢æ•°**ã®**ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãªã©ã‚’æŒ‡ã™ã‚ˆã†ã«**å¤‰æ›´**ã§ãã‚Œã°ã€**ãƒ—ãƒ­ã‚»ã‚¹**ã‚’**åˆ¶å¾¡**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ç¾åœ¨ã¯ã“ã‚ŒãŒã‚ˆã‚Šè¤‡é›‘ã§ã™ã€‚\
ç¾åœ¨ã€å®Ÿè¡Œã•ã‚Œã‚‹**é–¢æ•°ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ã¯ã€ã„ãã¤ã‹ã®æ§‹é€ ã®èƒŒå¾Œã«**éš ã•ã‚Œã¦ãŠã‚Š**ã€æœ€çµ‚çš„ã«æŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ãªãã€**XORã§æš—å·åŒ–ã•ã‚Œ**ã€**ãƒ©ãƒ³ãƒ€ãƒ ã‚­ãƒ¼**ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ç¾åœ¨ã“ã®æ”»æ’ƒãƒ™ã‚¯ã‚¿ãƒ¼ã¯**x86**ãŠã‚ˆã³**x64\_86**ã§ã¯ã‚ã¾ã‚Šå½¹ã«ç«‹ã¡ã¾ã›ã‚“ã€‚\
**æš—å·åŒ–é–¢æ•°**ã¯**`PTR_MANGLE`**ã§ã™ã€‚**m68kã€mips32ã€mips64ã€aarch64ã€armã€hppa**ãªã©ã®**ä»–ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¯ã€**å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã£ãŸã‚‚ã®ã¨åŒã˜**ã‚’è¿”ã™ãŸã‚ã€**æš—å·åŒ–**é–¢æ•°ã‚’**å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“**ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã“ã®ãƒ™ã‚¯ã‚¿ãƒ¼ã§æ”»æ’ƒå¯èƒ½ã§ã™ã€‚

ã“ã®ä»•çµ„ã¿ã®è©³ç´°ãªèª¬æ˜ã¯[https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## link\_map

[**ã“ã®æŠ•ç¨¿**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ`return`ã¾ãŸã¯`exit()`ã‚’ä½¿ç”¨ã—ã¦çµ‚äº†ã™ã‚‹ã¨ã€`__run_exit_handlers()`ãŒå®Ÿè¡Œã•ã‚Œã€ç™»éŒ²ã•ã‚ŒãŸãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

{% hint style="danger" %}
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ**`_exit()`**é–¢æ•°ã‚’ä»‹ã—ã¦çµ‚äº†ã™ã‚‹ã¨ã€**`exit`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«**ãŒå‘¼ã³å‡ºã•ã‚Œã€çµ‚äº†ãƒãƒ³ãƒ‰ãƒ©ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€`__run_exit_handlers()`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã§ãã¾ã™ã€‚
{% endhint %}

é‡è¦ãªã‚³ãƒ¼ãƒ‰ã¯([source](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
`map -> l_addr + fini_array -> d_un.d_ptr` ã‚’ä½¿ç”¨ã—ã¦ã€**å‘¼ã³å‡ºã™é–¢æ•°ã®é…åˆ—ã®ä½ç½®ã‚’è¨ˆç®—**ã™ã‚‹æ–¹æ³•ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

**ã„ãã¤ã‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ãŒã‚ã‚Šã¾ã™ï¼š

* `map->l_addr` ã®å€¤ã‚’ä¸Šæ›¸ãã—ã¦ã€ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®**å½ã® `fini_array`**ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
* `l_info[DT_FINI_ARRAY]` ã¨ `l_info[DT_FINI_ARRAYSZ]` ã‚¨ãƒ³ãƒˆãƒªï¼ˆãƒ¡ãƒ¢ãƒªå†…ã§ã»ã¼é€£ç¶šã—ã¦ã„ã¾ã™ï¼‰ã‚’ä¸Šæ›¸ãã—ã¦ã€**å½ã® `Elf64_Dyn`** æ§‹é€ ä½“ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å†ã³ **`array` ãŒæ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ãƒ¡ãƒ¢ãƒª**é ˜åŸŸã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚&#x20;
* [**ã“ã®è§£èª¬**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) ã¯ã€`.bss` å†…ã®åˆ¶å¾¡ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ `l_info[DT_FINI_ARRAY]` ã‚’ä¸Šæ›¸ãã—ã€å½ã® `fini_array` ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ã“ã®å½ã®é…åˆ—ã«ã¯ã€**æœ€åˆã«** [**one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã‚ŒãŒå®Ÿè¡Œã•ã‚Œã€ãã®å¾Œã«ã“ã®**å½ã®é…åˆ—**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ `map->l_addr` ã®**å€¤**ã®é–“ã®**å·®**ãŒç¶šãã€`*array` ãŒå½ã®é…åˆ—ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
* ã“ã®æŠ€è¡“ã®ä¸»ãªæŠ•ç¨¿ã¨ [**ã“ã®è§£èª¬**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) ã«ã‚ˆã‚‹ã¨ã€ld.so ã¯ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ãƒã‚¤ãƒŠãƒª `link_map` ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ã‚’æ®‹ã—ã¾ã™ã€‚ä»»æ„ã®æ›¸ãè¾¼ã¿ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚’ä¸Šæ›¸ãã—ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹å½ã® `fini_array` ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ã€[**one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å‰ã®ã‚³ãƒ¼ãƒ‰ã«ç¶šã„ã¦ã€èˆˆå‘³æ·±ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼š
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
ã“ã®å ´åˆã€å½é€ ã•ã‚ŒãŸ `ElfW(Dyn)` æ§‹é€ ä½“ã‚’æŒ‡ã™ `map->l_info[DT_FINI]` ã®å€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚[**ã“ã¡ã‚‰ã«è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã™**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure)ã€‚

## TLS-Storage dtor\_list ã®ä¸Šæ›¸ã in **`__run_exit_handlers`**

[**ã“ã¡ã‚‰ã«èª¬æ˜ãŒã‚ã‚Šã¾ã™**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ `return` ã¾ãŸã¯ `exit()` ã‚’ä»‹ã—ã¦çµ‚äº†ã™ã‚‹ã¨ã€**`__run_exit_handlers()`** ãŒå®Ÿè¡Œã•ã‚Œã€ç™»éŒ²ã•ã‚ŒãŸãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

`_run_exit_handlers()` ã®ã‚³ãƒ¼ãƒ‰:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
**`__call_tls_dtors()`** ã®ã‚³ãƒ¼ãƒ‰:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
å„ç™»éŒ²ã•ã‚ŒãŸé–¢æ•°ã¯ **`tls_dtor_list`** ã«ãŠã„ã¦ã€**`cur->func`** ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ã‚’ãƒ‡ãƒãƒ³ãƒ–ãƒ«ã—ã€å¼•æ•° **`cur->obj`** ã§å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã“ã® [**GEFã®ãƒ•ã‚©ãƒ¼ã‚¯**](https://github.com/bata24/gef) ã‹ã‚‰ã® **`tls`** é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å®Ÿéš›ã« **`dtor_list`** ãŒ **ã‚¹ã‚¿ãƒƒã‚¯ã‚«ãƒŠãƒªã‚¢** ã¨ **PTR_MANGLEã‚¯ãƒƒã‚­ãƒ¼** ã«éå¸¸ã« **è¿‘ã„** ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã«å¯¾ã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒã‚ã‚Œã°ã€**ã‚¯ãƒƒã‚­ãƒ¼** ã¨ **ã‚¹ã‚¿ãƒƒã‚¯ã‚«ãƒŠãƒªã‚¢** ã‚’ **ä¸Šæ›¸ã** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚\
PTR_MANGLEã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã€**`PTR_DEMANLE` é–¢æ•°ã‚’ãƒã‚¤ãƒ‘ã‚¹** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã€0x00ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€**å®Ÿéš›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ `xor`** ã¯è¨­å®šã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã ã‘ã«ãªã‚Šã¾ã™ã€‚æ¬¡ã«ã€**`dtor_list`** ã«æ›¸ãè¾¼ã‚€ã“ã¨ã§ã€é–¢æ•°ã® **ã‚¢ãƒ‰ãƒ¬ã‚¹** ã¨ãã® **å¼•æ•°** ã‚’æŒã¤ **è¤‡æ•°ã®é–¢æ•°ã‚’ãƒã‚§ãƒ¼ãƒ³** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

æœ€å¾Œã«ã€ä¿å­˜ã•ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ã¯ã‚¯ãƒƒã‚­ãƒ¼ã¨xoredã•ã‚Œã‚‹ã ã‘ã§ãªãã€17ãƒ“ãƒƒãƒˆå›è»¢ã•ã‚Œã‚‹ã“ã¨ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
æ–°ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹å‰ã«ã€ã“ã‚Œã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[**å…ƒã®æŠ•ç¨¿**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ã§ä¾‹ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚

## **`__run_exit_handlers`**å†…ã®ä»–ã®ãƒãƒ³ã‚°ãƒ«ãƒã‚¤ãƒ³ã‚¿

ã“ã®æŠ€è¡“ã¯[**ã“ã“ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ**`return`ã¾ãŸã¯`exit()`ã‚’å‘¼ã³å‡ºã—ã¦çµ‚äº†ã™ã‚‹**ã“ã¨ã«å†ã³ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€**`__run_exit_handlers()`**ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

ã“ã®é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’ã•ã‚‰ã«ç¢ºèªã—ã¾ã—ã‚‡ã†:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
å¤‰æ•° `f` ã¯ **`initial`** æ§‹é€ ä½“ã‚’æŒ‡ã—ã¦ãŠã‚Šã€`f->flavor` ã®å€¤ã«å¿œã˜ã¦ç•°ãªã‚‹é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚\
å€¤ã«å¿œã˜ã¦ã€å‘¼ã³å‡ºã™é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç•°ãªã‚‹å ´æ‰€ã«ã‚ã‚Šã¾ã™ãŒã€å¸¸ã« **demangled** ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã•ã‚‰ã«ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ **`ef_on`** ã¨ **`ef_cxa`** ã§ã¯ **å¼•æ•°** ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ãƒ‡ãƒãƒƒã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ GEF ã‚’å®Ÿè¡Œã—ã¦ **`gef> p initial`** ã§ **`initial` æ§‹é€ ä½“** ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€`PTR_MANGLE` ã‚¯ãƒƒã‚­ãƒ¼ã‚’ **leak** ã™ã‚‹ã‹æ¶ˆå»ã—ã€ãã®å¾Œ `system('/bin/sh')` ã§åˆæœŸã® `cxa` ã‚¨ãƒ³ãƒˆãƒªã‚’ä¸Šæ›¸ãã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã“ã®ä¾‹ã¯ [**æŠ€è¡“ã«é–¢ã™ã‚‹å…ƒã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
