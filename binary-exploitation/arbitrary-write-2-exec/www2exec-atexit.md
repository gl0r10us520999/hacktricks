# WWW2Exec - atexit(), TLS Storage рдФрд░ рдЕрдиреНрдп рдореИрдВрдЧрд▓реНрдб рдкреЙрдЗрдВрдЯрд░реНрд╕

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
{% endhint %}

## **\_\_atexit рд╕рдВрд░рдЪрдирд╛рдПрдБ**

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдЗрд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░рдирд╛ рдмрд╣реБрдд **рдЕрдЬреАрдм** рд╣реИ!
{% endhint %}

**`atexit()`** рдПрдХ **рдХрд╛рд░реНрдп** рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпреЗ **рдХрд╛рд░реНрдп** рдПрдХ **`exit()`** рдпрд╛ **рдореБрдЦреНрдп** рдХреЗ **рд╡рд╛рдкрд╕реА** рдХреЛ **рдЪрд▓рд╛рдП**рдЧрд╛ред\
рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рднреА рдЗрди **рдХрд╛рд░реНрдпреЛрдВ** рдХреЗ **рдкрддреЗ** рдХреЛ рдПрдХ рд╢реИрд▓рдХреЛрдб рдкрд░ рдкреЙрдЗрдВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХрд╛ **рдирд┐рдпрдВрддреНрд░рдг** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИред\
рд╡рд░реНрддрдорд╛рди рдореЗрдВ **рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдкрддреЛрдВ** рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдИ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкреАрдЫреЗ **рдЫрд┐рдкрд╛ рд╣реБрдЖ рд╣реИ** рдФрд░ рдЕрдВрдд рдореЗрдВ рдЬрд┐рд╕ рдкрддреЗ рдкрд░ рдпрд╣ рдкреЙрдЗрдВрдЯ рдХрд░рддрд╛ рд╣реИ, рд╡рд╣ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдкрддреЛрдВ рдХреЗ рдкрддреЗ рдирд╣реАрдВ рд╣реИрдВ, рдмрд▓реНрдХрд┐ **XOR** рдФрд░ рдПрдХ **рд░реИрдВрдбрдо рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдпрд╣ рд╣рдорд▓рд╛ рд╡реЗрдХреНрдЯрд░ **рдХрдо рдЙрдкрдпреЛрдЧреА рд╣реИ рдХрдо рд╕реЗ рдХрдо x86** рдФрд░ **x64\_86** рдкрд░ред\
**рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХрд╛рд░реНрдп** рд╣реИ **`PTR_MANGLE`**ред **рдЕрдиреНрдп рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░** рдЬреИрд╕реЗ m68k, mips32, mips64, aarch64, arm, hppa... **рдЗрд╕ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди** рдХрд╛рд░реНрдп рдХреЛ **рд▓рд╛рдЧреВ рдирд╣реАрдВ рдХрд░рддреЗ** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рд╡рд╣реА рд╡рд╛рдкрд╕** рдЙрд╕реЗ рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ рдЬреИрд╕рд╛ рдЗрдирдкреБрдЯ рдерд╛ред рдЗрд╕рд▓рд┐рдП рдЗрди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░реНрд╕ рдкрд░ рдпрд╣ рд╡реЗрдХреНрдЯрд░ рд╕реЗ рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЖрдк рдЗрд╕рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЧрд╣рд░рд╛рдИ рдореЗрдВ рд╡реНрдпрд╛рдЦреНрдпрд╛ [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## link\_map

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure) рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо `return` рдпрд╛ `exit()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ `__run_exit_handlers()` рдХреЛ рдЪрд▓рд╛рдПрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рдирд╛рд╢рдХреЛрдВ рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ред

{% hint style="danger" %}
рдпрджрд┐ рдХрд╛рд░реНрдпрдХреНрд░рдо **`_exit()`** рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`exit` рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓** рдХреЛ рдмреБрд▓рд╛рдПрдЧрд╛ рдФрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд╕ рд╣реИрдВрдбрд▓рд░ рдирд╣реАрдВ рдЪрд▓рд╛рдПрдЧрд╛ред рдЗрд╕рд▓рд┐рдП, `__run_exit_handlers()` рдХреЛ рдЪрд▓рд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЗрд╕ рдкрд░ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХреЛрдб рд╣реИ ([рд╕реНрд░реЛрдд](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ `map -> l_addr + fini_array -> d_un.d_ptr` рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЧрдгрдирд╛** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ **рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдПрд░реЗ** рдХрд╛ рд╕реНрдерд╛рди рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдХреБрдЫ **рд╡рд┐рдХрд▓реНрдк** рд╣реИрдВ:

* `map->l_addr` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдпрд╣ рдПрдХ **рдирдХрд▓реА `fini_array`** рдХреА рдУрд░ рдкреНрд╡рд╛рдЗрдВрдЯ рдХрд░реЗ рдЬрд┐рд╕рдореЗрдВ рдЕрд░реНрдмрд┐рдЯреНрд░реЗрд░реА рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рдирд┐рд░реНрджреЗрд╢ рд╣реЛрдВ
* `l_info[DT_FINI_ARRAY]` рдФрд░ `l_info[DT_FINI_ARRAYSZ]` рдПрдВрдЯреНрд░реА рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВ (рдЬреЛ рд╕реНрдореГрддрд┐ рдореЗрдВ рдЕрдзрд┐рдХрд╛рдВрд╢рдд: рдПрдХ рд╕рд╛рде рд╣реЛрддреЗ рд╣реИрдВ), рддрд╛рдХрд┐ рд╡реЗ рдлрд┐рд░ рд╕реЗ рдПрдХ рдЬрд╛рд▓реА `Elf64_Dyn` рд╕рдВрд░рдЪрдирд╛ рдХреА рдУрд░ рдкреНрд╡рд╛рдЗрдВрдЯ рдХрд░реЗрдВ рдЬреЛ рдлрд┐рд░ рд╕реЗ **`array` рдХреЛ рдПрдХ рд╕реНрдореГрддрд┐** рдХреНрд╖реЗрддреНрд░ рдкрд░ рдкреНрд╡рд╛рдЗрдВрдЯ рдХрд░реЗрдЧреА рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред
* [**рдЗрд╕ рд╡реНрд░рд┐рдЯрдЕрдк**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) `l_info[DT_FINI_ARRAY]` рдХреЛ рдПрдХ рдирд┐рдпрдВрддреНрд░рд┐рдд рд╕реНрдореГрддрд┐ рдореЗрдВ рд╕реНрдерд┐рдд `.bss` рдореЗрдВ рдПрдХ рдЬрд╛рд▓реА `fini_array` рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЬрд╛рд▓реА рдЕрд░реНрд░реЗ рдореЗрдВ **рдкрд╣рд▓реЗ рдПрдХ** [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **рдкрддрд╛** рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд┐рд░ **рдЗрд╕ рдЬрд╛рд▓реА рдЕрд░реНрд░реЗ** рдФрд░ `map->l_addr` рдХреЗ рдорд╛рди рдХреЗ рдмреАрдЪ рдХрд╛ **рдЕрдВрддрд░** рдЬрд┐рд╕рд╕реЗ `*array` рдирдХрд▓реА рдЕрд░реНрд░реЗ рдкрд░ рдкреНрд╡рд╛рдЗрдВрдЯ рдХрд░реЗрдЧрд╛ред
* рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдореБрдЦреНрдп рдкреЛрд╕реНрдЯ рдФрд░ [**рдЗрд╕ рд╡реНрд░рд┐рдЯрдЕрдк**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) рдХреЗ рдЕрдиреБрд╕рд╛рд░ ld.so рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рдЫреЛрдбрд╝ рджреЗрддрд╛ рд╣реИ рдЬреЛ ld.so рдореЗрдВ рдмрд╛рдЗрдирд░реА `link_map` рдХреА рдУрд░ рдкреЙрдЗрдВрдЯ рдХрд░рддрд╛ рд╣реИред рдПрдХ рдЕрд░реНрдмрд┐рдЯреНрд░реЗрд░реА рд░рд╛рдЗрдЯ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирдХрд▓реА `fini_array` рдХреА рдУрд░ рдкреЙрдЗрдВрдЯ рдХрд░рдирд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ [**рд╡рди рдЧреИрдЬреЗрдЯ**](../rop-return-oriented-programing/ret2lib/one-gadget.md) рдХреЗ рдкрддреЗ рдХреЛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред

рдкрд┐рдЫрд▓реЗ рдХреЛрдб рдХреЗ рдЕрдиреБрд╕рд░рдг рдореЗрдВ рдЖрдк рдПрдХ рдФрд░ рджрд┐рд▓рдЪрд╕реНрдк рдЦрдВрдб рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдХреЛрдб рд╣реИ:
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `map->l_info[DT_FINI]` рдХреЗ рдорд╛рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдЬреЛ рдПрдХ рдЬрд╛рд▓реА `ElfW(Dyn)` рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред [**рдпрд╣рд╛рдБ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure).

## TLS-Storage dtor\_list overwrite in **`__run_exit_handlers`**

рдЬреИрд╕рд╛ [**рдпрд╣рд╛рдБ рд╕реНрдкрд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), рдпрджрд┐ рдХреЛрдИ рдкреНрд░реЛрдЧреНрд░рд╛рдо `return` рдпрд╛ `exit()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрдВрдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`__run_exit_handlers()`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ рдХрд┐рд╕реА рднреА рдирд╛рд╢рдХ рдХрд╛рд░реНрдп рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ рдЬреЛ рдкрдВрдЬреАрдХреГрдд рд╣реИред

рдХреЛрдб `_run_exit_handlers()` рд╕реЗ:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
рдХреЛрдб рд╕реЗ **`__call_tls_dtors()`**:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
рд╣рд░ **`tls_dtor_list`** рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП, рдпрд╣ **`cur->func`** рд╕реЗ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдбреАрдореИрдВрдЧрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ **`cur->obj`** рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ [**GEF рдХреЗ fork**](https://github.com/bata24/gef) рд╕реЗ **`tls`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдпрд╣ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`dtor_list`** рдмрд╣реБрдд **рдХрд░реАрдм** рд╣реИ **stack canary** рдФрд░ **PTR\_MANGLE cookie** рдХреЗред рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рдкрд░ рдУрд╡рд░рдлрд╝реНрд▓реЛ рд╣реЛрдиреЗ рдкрд░ **cookie** рдФрд░ **stack canary** рдХреЛ **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред\
PTR\_MANGLE рдХреБрдХреА рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рд╕реЗ, рдЗрд╕реЗ 0x00 рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ **`PTR_DEMANLE` рдлрд╝рдВрдХреНрд╢рди** рдХреЛ **рдмрд╛рдИрдкрд╛рд╕** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ **`xor`** рдХреЗрд╡рд▓ рдкрддрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред рдлрд┐рд░, **`dtor_list`** рдкрд░ рд▓рд┐рдЦрдХрд░ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдлрд╝рдВрдХреНрд╢рди **рдкрддрд╛** рдФрд░ рдЗрд╕рдХрд╛ **рд╡рд┐рд╡рд╛рдж** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЕрдВрдд рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реНрдЯреЛрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкреЙрдЗрдВрдЯрд░ рдХреЗрд╡рд▓ рдХреБрдХреА рдХреЗ рд╕рд╛рде xored рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ рдмрд▓реНрдХрд┐ 17 рдмрд┐рдЯ рднреА рдШреБрдорд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
So you need to take this into account before adding a new address.

Find an example in the [**original post**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite).

## **`__run_exit_handlers`** рдореЗрдВ рдЕрдиреНрдп рдореИрдВрдЧрд▓реНрдб рдкреЙрдЗрдВрдЯрд░

рдпрд╣ рддрдХрдиреАрдХ [**рдпрд╣рд╛рдБ рд╕рдордЭрд╛рдИ рдЧрдИ рд╣реИ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) рдФрд░ рдлрд┐рд░ рд╕реЗ рдХрд╛рд░реНрдпрдХреНрд░рдо **`return` рдпрд╛ `exit()` рдХреЛ рдмреБрд▓рд╛рдХрд░ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реИ** рддрд╛рдХрд┐ **`__run_exit_handlers()`** рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПред

рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рдХреЛрдб рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
рдЪрд░ `f` **`initial`** рд╕рдВрд░рдЪрдирд╛ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдФрд░ `f->flavor` рдХреЗ рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдорд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╕реНрдерд╛рди рдкрд░ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рд╣рдореЗрд╢рд╛ **demangled** рд╣реЛрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╡рд┐рдХрд▓реНрдкреЛрдВ **`ef_on`** рдФрд░ **`ef_cxa`** рдореЗрдВ рдПрдХ **рд╡рд┐рдзрд╛рди** рдХреЛ рднреА рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбреАрдмрдЧрд┐рдВрдЧ рд╕рддреНрд░ рдореЗрдВ **GEF** рдЪрд▓рд╛рддреЗ рд╕рдордп **`gef> p initial`** рдХреЗ рд╕рд╛рде **`initial` рд╕рдВрд░рдЪрдирд╛** рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдпрд╛ рддреЛ **`PTR_MANGLE` рдХреБрдХреА рдХреЛ рд▓реАрдХ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдпрд╛ рдорд┐рдЯрд╛рдирд╛ рд╣реЛрдЧрд╛** рдФрд░ рдлрд┐рд░ `system('/bin/sh')` рдХреЗ рд╕рд╛рде `cxa` рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред\
рдЖрдк рдЗрд╕рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг [**рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
