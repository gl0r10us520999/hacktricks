# WWW2Exec - atexit(), –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è TLS —Ç–∞ —ñ–Ω—à—ñ –∑–º—ñ—à–∞–Ω—ñ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**–®–∫–æ–ª–∞ —Ö–∞–∫—ñ–Ω–≥—É HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## **\_\_–°—Ç—Ä—É–∫—Ç—É—Ä–∏ atexit**

{% hint style="danger" %}
–°—å–æ–≥–æ–¥–Ω—ñ –¥—É–∂–µ **–¥–∏–≤–Ω–æ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ —Ü–µ!**
{% endhint %}

**`atexit()`** - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, –¥–æ —è–∫–æ—ó **–ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ —è–∫–æ—Å—Ç—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.** –¶—ñ **—Ñ—É–Ω–∫—Ü—ñ—ó** –±—É–¥—É—Ç—å **–≤–∏–∫–æ–Ω–∞–Ω—ñ** –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ **`exit()`** –∞–±–æ **–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ** –∑ **–≥–æ–ª–æ–≤–Ω–æ—ó** —Ñ—É–Ω–∫—Ü—ñ—ó.\
–Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–º—ñ–Ω–∏—Ç–∏** **–∞–¥—Ä–µ—Å—É** –±—É–¥—å-—è–∫–æ—ó –∑ —Ü–∏—Ö **—Ñ—É–Ω–∫—Ü—ñ–π**, —â–æ–± –≤–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ shellcode, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏ **–æ—Ç—Ä–∏–º–∞—î—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ **–ø—Ä–æ—Ü–µ—Å–æ–º**, –∞–ª–µ –∑–∞—Ä–∞–∑ —Ü–µ —Å–∫–ª–∞–¥–Ω—ñ—à–µ.\
–ù–∞—Ä–∞–∑—ñ **–∞–¥—Ä–µ—Å–∏ —Ñ—É–Ω–∫—Ü—ñ–π**, —è–∫—ñ –º–∞—é—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ, **–ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ** –∑–∞ –¥–µ–∫—ñ–ª—å–∫–æ–º–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏, —ñ, –Ω–∞—Ä–µ—à—Ç—ñ, –∞–¥—Ä–µ—Å–∞, –Ω–∞ —è–∫—É –≤–æ–Ω–∏ –≤–∫–∞–∑—É—é—Ç—å, –Ω–µ —î –∞–¥—Ä–µ—Å–∞–º–∏ —Ñ—É–Ω–∫—Ü—ñ–π, –∞ **—à–∏—Ñ—Ä—É—é—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é XOR** —Ç–∞ –∑—Å—É–≤—ñ–≤ –∑ **–≤–∏–ø–∞–¥–∫–æ–≤–∏–º –∫–ª—é—á–µ–º**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –Ω–∞—Ä–∞–∑—ñ —Ü–µ–π –≤–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏ **–Ω–µ —î –¥—É–∂–µ –∫–æ—Ä–∏—Å–Ω–∏–º –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –Ω–∞ x86** —Ç–∞ **x64\_86**.\
–§—É–Ω–∫—Ü—ñ—è **—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è** - **`PTR_MANGLE`**. **–Ü–Ω—à—ñ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏**, —Ç–∞–∫—ñ —è–∫ m68k, mips32, mips64, aarch64, arm, hppa... **–Ω–µ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ **–ø–æ–≤–µ—Ä—Ç–∞—î —Ç–µ —Å–∞–º–µ**, —â–æ –æ—Ç—Ä–∏–º–∞–ª–∞ –Ω–∞ –≤—Ö–æ–¥—ñ. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, —Ü—ñ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –º–æ–∂–Ω–∞ –∞—Ç–∞–∫—É–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞.

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –¥–æ–∫–ª–∞–¥–Ω–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Ç–æ–≥–æ, —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html)

## link\_map

–Ø–∫ –ø–æ—è—Å–Ω–µ–Ω–æ [**—É —Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure), —è–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `return` –∞–±–æ `exit()`, –≤–æ–Ω–∞ –≤–∏–∫–æ–Ω–∞—î `__run_exit_handlers()`, —è–∫–∞ –≤–∏–∫–ª–∏—á–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏.

{% hint style="danger" %}
–Ø–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—é **`_exit()`**, –≤–æ–Ω–∞ –≤–∏–∫–ª–∏—á–µ **—Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫ `exit`** —ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –≤–∏—Ö–æ–¥—É –Ω–µ –±—É–¥—É—Ç—å –≤–∏–∫–æ–Ω–∞–Ω—ñ. –¢–æ–º—É, —â–æ–± –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è `__run_exit_handlers()`, –≤–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ç–æ—á–∫—É –∑—É–ø–∏–Ω–∫–∏ –Ω–∞ —Ü—ñ–π —Ñ—É–Ω–∫—Ü—ñ—ó.
{% endhint %}

–í–∞–∂–ª–∏–≤–∏–π –∫–æ–¥ ([–¥–∂–µ—Ä–µ–ª–æ](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ `map -> l_addr + fini_array -> d_un.d_ptr` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è **–æ–±—á–∏—Å–ª–µ–Ω–Ω—è** –ø–æ–∑–∏—Ü—ñ—ó **–º–∞—Å–∏–≤—É —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è –≤–∏–∫–ª–∏–∫—É**.

–Ñ **–∫—ñ–ª—å–∫–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤**:

* –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è `map->l_addr`, —â–æ–± –≤–æ–Ω–æ –≤–∫–∞–∑—É–≤–∞–ª–æ –Ω–∞ **—Ñ–∞–ª—å—à–∏–≤–∏–π `fini_array`** –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É
* –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–∞–ø–∏—Å–∏ `l_info[DT_FINI_ARRAY]` —Ç–∞ `l_info[DT_FINI_ARRAYSZ]` (—è–∫—ñ –ø—Ä–∏–±–ª–∏–∑–Ω–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ —É –ø–∞–º'—è—Ç—ñ), —â–æ–± –≤–æ–Ω–∏ –≤–∫–∞–∑—É–≤–∞–ª–∏ –Ω–∞ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É `Elf64_Dyn`, —è–∫–∞ –∑–Ω–æ–≤—É –∑—Ä–æ–±–∏—Ç—å **`array` –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º –Ω–∞ –ø–∞–º'—è—Ç—å**, —è–∫—É –∫–æ–Ω—Ç—Ä–æ–ª—é—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫.&#x20;
* [**–¶–µ–π –æ–ø–∏—Å**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î `l_info[DT_FINI_ARRAY]` –∞–¥—Ä–µ—Å–æ—é –∫–µ—Ä–æ–≤–∞–Ω–æ—ó –ø–∞–º'—è—Ç—ñ –≤ `.bss`, —â–æ –º—ñ—Å—Ç–∏—Ç—å —Ñ–∞–ª—å—à–∏–≤–∏–π `fini_array`. –¶–µ–π —Ñ–∞–ª—å—à–∏–≤–∏–π –º–∞—Å–∏–≤ –º—ñ—Å—Ç–∏—Ç—å **—Å–ø–æ—á–∞—Ç–∫—É** [**–∞–¥—Ä–µ—Å—É –æ–¥–Ω–æ–≥–æ –≥–∞–¥–∂–µ—Ç–∞**](../rop-return-oriented-programing/ret2lib/one-gadget.md), —è–∫–∞ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–∞, –∞ –ø–æ—Ç—ñ–º **—Ä—ñ–∑–Ω–∏—Ü—é** –º—ñ–∂ –∞–¥—Ä–µ—Å–æ—é —Ü—å–æ–≥–æ **—Ñ–∞–ª—å—à–∏–≤–æ–≥–æ –º–∞—Å–∏–≤—É** —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º `map->l_addr`, —â–æ–± `*array` –≤–∫–∞–∑—É–≤–∞–≤ –Ω–∞ —Ñ–∞–ª—å—à–∏–≤–∏–π –º–∞—Å–∏–≤.
* –ó–≥—ñ–¥–Ω–æ –∑ –æ—Å–Ω–æ–≤–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ —Ç–∞ [**—Ü–∏–º –æ–ø–∏—Å–æ–º**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) ld.so –∑–∞–ª–∏—à–∞—î –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ —Å—Ç–µ–∫—É, —è–∫–∏–π –≤–∫–∞–∑—É—î –Ω–∞ –±—ñ–Ω–∞—Ä–Ω–∏–π `link_map` –≤ ld.so. –ó –¥–æ–ø–æ–º–æ–≥–æ—é –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –π–æ–≥–æ —ñ –∑—Ä–æ–±–∏—Ç–∏ –π–æ–≥–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º –Ω–∞ —Ñ–∞–ª—å—à–∏–≤–∏–π `fini_array`, –∫–µ—Ä–æ–≤–∞–Ω–∏–π –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º, –∑ –∞–¥—Ä–µ—Å–æ—é [**–æ–¥–Ω–æ–≥–æ –≥–∞–¥–∂–µ—Ç–∞**](../rop-return-oriented-programing/ret2lib/one-gadget.md), –Ω–∞–ø—Ä–∏–∫–ª–∞–¥.

–ü—ñ—Å–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫–æ–¥—É –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —â–µ –æ–¥–∏–Ω —Ü—ñ–∫–∞–≤–∏–π —Ä–æ–∑–¥—ñ–ª –∑ –∫–æ–¥–æ–º:
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
–£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è `map->l_info[DT_FINI]`, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ —Å—Ñ–∞–ª—å—Å–∏—Ñ—ñ–∫–æ–≤–∞–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É `ElfW(Dyn)`. –ó–Ω–∞–π–¥—ñ—Ç—å [**–±—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç—É—Ç**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure).

## –ü–µ—Ä–µ–∑–∞–ø–∏—Å dtor\_list TLS-—Å—Ö–æ–≤–∏—â–∞ –≤ **`__run_exit_handlers`**

–Ø–∫ [**–ø–æ—è—Å–Ω–µ–Ω–æ —Ç—É—Ç**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), —è–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `return` –∞–±–æ `exit()`, –≤–æ–Ω–∞ –≤–∏–∫–æ–Ω–∞—î **`__run_exit_handlers()`**, —è–∫–∞ –≤–∏–∫–ª–∏—á–µ –±—É–¥—å-—è–∫—ñ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä—ñ–≤.

–ö–æ–¥ –∑ `_run_exit_handlers()`:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
–ö–æ–¥ –∑ **`__call_tls_dtors()`**:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
–î–ª—è –∫–æ–∂–Ω–æ—ó –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –≤ **`tls_dtor_list`**, –≤—ñ–Ω —Ä–æ–∑—à–∏—Ñ—Ä—É—î –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –∑ **`cur->func`** —Ç–∞ –≤–∏–∫–ª–∏—á–µ –π–æ–≥–æ –∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º **`cur->obj`**.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ—é **`tls`** –∑ —Ü—å–æ–≥–æ [**—Ñ–æ—Ä–∫—É GEF**](https://github.com/bata24/gef), –º–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ **`dtor_list`** –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –¥—É–∂–µ **–±–ª–∏–∑—å–∫–æ** –¥–æ **—Å—Ç–µ–∫–æ–≤–æ–≥–æ –∫–∞–Ω–∞—Ä–µ–π–∫–∏** —Ç–∞ **PTR\_MANGLE –∫—É–∫—ñ**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∑ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è–º —Ü—å–æ–≥–æ –±—É–¥–µ –º–æ–∂–ª–∏–≤–æ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏** –∫—É–∫—É —Ç–∞ —Å—Ç–µ–∫–æ–≤—É –∫–∞–Ω–∞—Ä–µ–π–∫—É.\
–ü–µ—Ä–µ–∑–∞–ø–∏—Å—É—é—á–∏ PTR\_MANGLE –∫—É–∫—É, –±—É–¥–µ –º–æ–∂–ª–∏–≤–æ **–æ–±—ñ–π—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é `PTR_DEMANLE`**, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ —ó—ó –Ω–∞ 0x00, —â–æ –æ–∑–Ω–∞—á–∞—Ç–∏–º–µ, —â–æ **`xor`**, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∞–ª—å–Ω–æ—ó –∞–¥—Ä–µ—Å–∏, –±—É–¥–µ –ª–∏—à–µ –∞–¥—Ä–µ—Å–æ—é, —è–∫–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞. –ü–æ—Ç—ñ–º, –∑–∞–ø–∏—Å—É—é—á–∏ –≤ **`dtor_list`**, –º–æ–∂–ª–∏–≤–æ **–ª–∞–Ω—Ü—é–∂–∏—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ñ—É–Ω–∫—Ü—ñ–π** –∑ –∞–¥—Ä–µ—Å–æ—é —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ —ó—ó **–∞—Ä–≥—É–º–µ–Ω—Ç–æ–º.**

–ó–∞—É–≤–∞–∂—Ç–µ, —â–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–µ –ª–∏—à–µ –±—É–¥–µ **xor** –∑ –∫—É–∫–æ—é, –∞–ª–µ —Ç–∞–∫–æ–∂ –±—É–¥–µ –æ–±–µ—Ä—Ç–∞—Ç–∏—Å—è –Ω–∞ 17 –±—ñ—Ç:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
–û—Ç–∂–µ, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ü–µ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º –Ω–æ–≤–æ—ó –∞–¥—Ä–µ—Å–∏.

–ó–Ω–∞–π–¥—ñ—Ç—å –ø—Ä–∏–∫–ª–∞–¥ —É [**–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É –ø–æ—Å—Ç—ñ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite).

## –Ü–Ω—à—ñ –∑–º—ñ–Ω–µ–Ω—ñ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ –≤ **`__run_exit_handlers`**

–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è [**—Ç—É—Ç**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) —ñ –∑–Ω–æ–≤—É –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø—Ä–æ–≥—Ä–∞–º–∏ **–≤–∏—Ö–æ–¥—É, —è–∫–∞ –≤–∏–∫–ª–∏–∫–∞—î `return` –∞–±–æ `exit()`**, —Ç–æ–¥—ñ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è **`__run_exit_handlers()`**.

–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –±—ñ–ª—å—à–µ –∫–æ–¥—É —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ—ó:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
–ó–º—ñ–Ω–Ω–∞ `f` –≤–∫–∞–∑—É—î –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É **`initial`**, —ñ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∑–Ω–∞—á–µ–Ω–Ω—è `f->flavor` –±—É–¥—É—Ç—å –≤–∏–∫–ª–∏–∫–∞–Ω—ñ —Ä—ñ–∑–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó.\
–ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∑–Ω–∞—á–µ–Ω–Ω—è, –∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤–∏–∫–ª–∏–∫—É –±—É–¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏—Å—è –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö, –∞–ª–µ –∑–∞–≤–∂–¥–∏ –±—É–¥–µ **—Ä–æ–∑–∫–æ–¥–æ–≤–∞–Ω–∞**.

–ö—Ä—ñ–º —Ç–æ–≥–æ, —É –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö **`ef_on`** —Ç–∞ **`ef_cxa`** —Ç–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ **–∞—Ä–≥—É–º–µ–Ω—Ç**.

–ú–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É **`initial`** –ø—ñ–¥ —á–∞—Å —Å–µ–∞–Ω—Å—É –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –∑ GEF, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ **`gef> p initial`**.

–î–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ü–∏–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–±–æ **–≤–∏—Ç—ñ–∫–∞—Ç–∏ –∞–±–æ —Å—Ç–µ—Ä—Ç–∏ –∫—É–∫—É `PTR_MANGLE`** —ñ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–∞–ø–∏—Å `cxa` –≤ initial –Ω–∞ `system('/bin/sh')`.\
–ü—Ä–∏–∫–ª–∞–¥ —Ü—å–æ–≥–æ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ [**–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É –¥–æ–ø–∏—Å—ñ –≤ –±–ª–æ–∑—ñ –ø—Ä–æ —Ç–µ—Ö–Ω—ñ–∫—É**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure).
