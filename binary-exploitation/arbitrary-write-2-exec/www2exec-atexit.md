# WWW2Exec - atexit(), TLS Storage & Other mangled Pointers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **\_\_atexit Structures**

{% hint style="danger" %}
Î£Î®Î¼ÎµÏÎ± ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï **Ï€ÎµÏÎ¯ÎµÏÎ³Î¿ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï‚ Î±Ï…Ï„ÏŒ!**
{% endhint %}

**`atexit()`** ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÏƒÏ„Î·Î½ Î¿Ï€Î¿Î¯Î± **Î¬Î»Î»ÎµÏ‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Ï€ÎµÏÎ½Î¹Î¿ÏÎ½Ï„Î±Î¹ Ï‰Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹.** Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ **ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚** Î¸Î± **ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹** ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· ÎµÎ½ÏŒÏ‚ **`exit()`** Î® Ï„Î·Ï‚ **ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚** Ï„Î·Ï‚ **ÎºÏÏÎ¹Î±Ï‚**.\
Î‘Î½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± **Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚** Ï„Î· **Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·** Î¿Ï€Î¿Î¹Î±ÏƒÎ´Î®Ï€Î¿Ï„Îµ Î±Ï€ÏŒ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ **ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚** ÏÏƒÏ„Îµ Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î­Î½Î± shellcode Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Î¸Î± **ÎºÎµÏÎ´Î¯ÏƒÎµÎ¹Ï‚ Î­Î»ÎµÎ³Ï‡Î¿** Ï„Î·Ï‚ **Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚**, Î±Î»Î»Î¬ Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Ï€Î¹Î¿ Ï€ÎµÏÎ¯Ï€Î»Î¿ÎºÎ¿.\
Î‘Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Î¿Î¹ **Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¹Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚** Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎµÎ¯Î½Î±Î¹ **ÎºÏÏ…Î¼Î¼Î­Î½ÎµÏ‚** Ï€Î¯ÏƒÏ‰ Î±Ï€ÏŒ Ï€Î¿Î»Î»Î­Ï‚ Î´Î¿Î¼Î­Ï‚ ÎºÎ±Î¹ Ï„ÎµÎ»Î¹ÎºÎ¬ Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î·Î½ Î¿Ï€Î¿Î¯Î± Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î¿Î¹ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚ Ï„Ï‰Î½ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÏ‰Î½, Î±Î»Î»Î¬ ÎµÎ¯Î½Î±Î¹ **ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î·Î¼Î­Î½ÎµÏ‚ Î¼Îµ XOR** ÎºÎ±Î¹ Î¼ÎµÏ„Î±Ï„Î¿Ï€Î¯ÏƒÎµÎ¹Ï‚ Î¼Îµ Î¼Î¹Î± **Ï„Ï…Ï‡Î±Î¯Î± ÎºÎ»ÎµÎ¹Î´Î¯**. ÎˆÏ„ÏƒÎ¹, Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î® Î±Ï…Ï„ÏŒÏ‚ Î¿ ÎµÏ€Î¹Î¸ÎµÏ„Î¹ÎºÏŒÏ‚ Ï€Î±ÏÎ¬Î³Î¿Î½Ï„Î±Ï‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ **Ï€Î¿Î»Ï Ï‡ÏÎ®ÏƒÎ¹Î¼Î¿Ï‚ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ ÏƒÎµ x86** ÎºÎ±Î¹ **x64\_86**.\
Î— **ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·Ï‚** ÎµÎ¯Î½Î±Î¹ **`PTR_MANGLE`**. **Î†Î»Î»ÎµÏ‚ Î±ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ­Ï‚** ÏŒÏ€Ï‰Ï‚ m68k, mips32, mips64, aarch64, arm, hppa... **Î´ÎµÎ½ Ï…Î»Î¿Ï€Î¿Î¹Î¿ÏÎ½ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ¬Ï†Î·ÏƒÎ·Ï‚** Î³Î¹Î±Ï„Î¯ **ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î¿ Î¯Î´Î¹Î¿** Î¼Îµ Î±Ï…Ï„ÏŒ Ï€Î¿Ï… Î­Î»Î±Î²Îµ Ï‰Ï‚ ÎµÎ¯ÏƒÎ¿Î´Î¿. ÎˆÏ„ÏƒÎ¹, Î±Ï…Ï„Î­Ï‚ Î¿Î¹ Î±ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ­Ï‚ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î½ Î½Î± ÎµÏ€Î¹Ï„ÎµÎ¸Î¿ÏÎ½ Î¼Î­ÏƒÏ‰ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚.

ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î²ÏÎµÎ¹Ï‚ Î¼Î¹Î± ÏƒÎµ Î²Î¬Î¸Î¿Ï‚ ÎµÎ¾Î®Î³Î·ÏƒÎ· Î³Î¹Î± Ï„Î¿ Ï€ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î±Ï…Ï„ÏŒ ÏƒÏ„Î¿ [https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html)

## link\_map

ÎŒÏ€Ï‰Ï‚ ÎµÎ¾Î·Î³Î®Î¸Î·ÎºÎµ [**ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î¬ÏÏ„Î·ÏƒÎ·**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure), Î±Î½ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÎµÎ¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ `return` Î® `exit()` Î¸Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ `__run_exit_handlers()` Ï€Î¿Ï… Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½ÎµÏ‚ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î­Ï‚.

{% hint style="danger" %}
Î‘Î½ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÎµÎ¹ Î¼Î­ÏƒÏ‰ Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ **`_exit()`**, Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Ï„Î·Î½ **`exit` syscall** ÎºÎ±Î¹ Î¿Î¹ Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î­Ï‚ ÎµÎ¾ÏŒÎ´Î¿Ï… Î´ÎµÎ½ Î¸Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹. ÎˆÏ„ÏƒÎ¹, Î³Î¹Î± Î½Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÎµÎ¹Ï‚ ÏŒÏ„Î¹ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ `__run_exit_handlers()`, Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î¿ÏÎ¯ÏƒÎµÎ¹Ï‚ Î­Î½Î± breakpoint ÏƒÎµ Î±Ï…Ï„ÏŒ.
{% endhint %}

ÎŸ ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒÏ‚ ÎºÏÎ´Î¹ÎºÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ ([source](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ Ï€ÏÏ‚ Ï„Î¿ `map -> l_addr + fini_array -> d_un.d_ptr` Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Î½Î± **Ï…Ï€Î¿Î»Î¿Î³Î¯ÏƒÎµÎ¹** Ï„Î· Î¸Î­ÏƒÎ· Ï„Î¿Ï… **Ï€Î¯Î½Î±ÎºÎ± ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÏ‰Î½ Ï€Î¿Ï… Î¸Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î¼Îµ**.

Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ **Î¼ÎµÏÎ¹ÎºÎ­Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚**:

* Î•Ï€Î±Î½Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® Ï„Î¿Ï… `map->l_addr` Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î­Î½Î± **ÏˆÎµÏÏ„Î¹ÎºÎ¿ `fini_array`** Î¼Îµ Î¿Î´Î·Î³Î¯ÎµÏ‚ Î³Î¹Î± Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ±
* Î•Ï€Î±Î½Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ `l_info[DT_FINI_ARRAY]` ÎºÎ±Î¹ `l_info[DT_FINI_ARRAYSZ]` (Î¿Î¹ Î¿Ï€Î¿Î¯ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿ Î® Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿ Î´Î¹Î±Î´Î¿Ï‡Î¹ÎºÎ­Ï‚ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·), Î³Î¹Î± Î½Î± Ï„Î¹Ï‚ ÎºÎ¬Î½ÎµÏ„Îµ **Î½Î± Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î½ ÏƒÎµ Î¼Î¹Î± Ï€Î»Î±ÏƒÏ„Î® `Elf64_Dyn`** Î´Î¿Î¼Î® Ï€Î¿Ï… Î¸Î± ÎºÎ¬Î½ÎµÎ¹ Î¾Î±Î½Î¬ **Î¿ `array` Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î¼Î¹Î± Î¼Î½Î®Î¼Î·** Î¶ÏÎ½Î· Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿.&#x20;
* [**Î‘Ï…Ï„Î® Î· Î±Î½Î±Ï†Î¿ÏÎ¬**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) ÎµÏ€Î±Î½Î±Î³ÏÎ¬Ï†ÎµÎ¹ Ï„Î¿ `l_info[DT_FINI_ARRAY]` Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¼Î¹Î±Ï‚ ÎµÎ»ÎµÎ³Ï‡ÏŒÎ¼ÎµÎ½Î·Ï‚ Î¼Î½Î®Î¼Î·Ï‚ ÏƒÏ„Î¿ `.bss` Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î­Î½Î± ÏˆÎµÏÏ„Î¹ÎºÎ¿ `fini_array`. Î‘Ï…Ï„ÏŒÏ‚ Î¿ ÏˆÎµÏÏ„Î¹ÎºÎ¿Ï‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ **Ï€ÏÏÏ„Î± Î¼Î¹Î±** [**Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Ï„Î·** **Î´Î¹Î±Ï†Î¿ÏÎ¬** Î¼ÎµÏ„Î±Î¾Ï Ï„Î·Ï‚ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… **ÏˆÎµÏÏ„Î¹ÎºÎ¿Ï… Ï€Î¯Î½Î±ÎºÎ±** ÎºÎ±Î¹ Ï„Î·Ï‚ **Ï„Î¹Î¼Î®Ï‚ Ï„Î¿Ï… `map->l_addr`** Î­Ï„ÏƒÎ¹ ÏÏƒÏ„Îµ Ï„Î¿ `*array` Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ ÏˆÎµÏÏ„Î¹ÎºÎ¿ Ï€Î¯Î½Î±ÎºÎ±.
* Î£ÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î·Î½ ÎºÏÏÎ¹Î± Î±Î½Î¬ÏÏ„Î·ÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ®Ï‚ ÎºÎ±Î¹ [**Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î±Ï†Î¿ÏÎ¬**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet) Ï„Î¿ ld.so Î±Ï†Î®Î½ÎµÎ¹ Î­Î½Î±Î½ Î´ÎµÎ¯ÎºÏ„Î· ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î± Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ Î´Ï…Î±Î´Î¹ÎºÏŒ `link_map` ÏƒÏ„Î¿ ld.so. ÎœÎµ Î¼Î¹Î± Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î· ÎµÎ³Î³ÏÎ±Ï†Î® ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï„Î¿ ÎµÏ€Î±Î½Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ ÎºÎ±Î¹ Î½Î± Ï„Î¿ ÎºÎ¬Î½ÎµÏ„Îµ Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î­Î½Î± ÏˆÎµÏÏ„Î¹ÎºÎ¿ `fini_array` Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÎµ Î­Î½Î± [**one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.

Î‘ÎºÎ¿Î»Î¿Ï…Î¸ÏÎ½Ï„Î±Ï‚ Ï„Î¿Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ ÎºÏÎ´Î¹ÎºÎ± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î¼Î¹Î± Î¬Î»Î»Î· ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎ± ÎµÎ½ÏŒÏ„Î·Ï„Î± Î¼Îµ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±:
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
Î£Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·, Î¸Î± Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î±Î¸ÎµÎ¯ Î· Ï„Î¹Î¼Î® Ï„Î¿Ï… `map->l_info[DT_FINI]` Ï€Î¿Ï… Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÎµ Î¼Î¹Î± Ï€Î»Î±ÏƒÏ„Î® Î´Î¿Î¼Î® `ElfW(Dyn)`. Î’ÏÎµÎ¯Ï„Îµ [**Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÎµÎ´Ï**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure).

## TLS-Storage dtor\_list Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÏƒÏ„Î·Î½ **`__run_exit_handlers`**

ÎŒÏ€Ï‰Ï‚ [**ÎµÎ¾Î·Î³ÎµÎ¯Ï„Î±Î¹ ÎµÎ´Ï**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite), Î±Î½ Î­Î½Î± Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Ï„ÎµÏÎ¼Î±Ï„Î¯ÏƒÎµÎ¹ Î¼Î­ÏƒÏ‰ `return` Î® `exit()`, Î¸Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ **`__run_exit_handlers()`** Ï€Î¿Ï… Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î­Î± Î­Ï‡ÎµÎ¹ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯.

ÎšÏÎ´Î¹ÎºÎ±Ï‚ Î±Ï€ÏŒ `_run_exit_handlers()`:
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
ÎšÏÎ´Î¹ÎºÎ±Ï‚ Î±Ï€ÏŒ **`__call_tls_dtors()`**:
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
Î“Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÏƒÏ„Î· **`tls_dtor_list`**, Î¸Î± Î±Ï€Î¿ÏƒÏ…Î¼Ï€Î¹Î­ÏƒÎµÎ¹ Ï„Î¿Î½ Î´ÎµÎ¯ÎºÏ„Î· Î±Ï€ÏŒ Ï„Î· **`cur->func`** ÎºÎ±Î¹ Î¸Î± Ï„Î·Î½ ÎºÎ±Î»Î­ÏƒÎµÎ¹ Î¼Îµ Ï„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± **`cur->obj`**.

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· **`tls`** Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ Ï„Î¿ [**fork Ï„Î¿Ï… GEF**](https://github.com/bata24/gef), ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î´Î¿ÏÎ¼Îµ ÏŒÏ„Î¹ ÏƒÏ„Î·Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î± Î· **`dtor_list`** ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï **ÎºÎ¿Î½Ï„Î¬** ÏƒÏ„Î¿ **stack canary** ÎºÎ±Î¹ Ï„Î¿ **PTR_MANGLE cookie**. ÎˆÏ„ÏƒÎ¹, Î¼Îµ Î¼Î¹Î± Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ· ÏƒÎµ Î±Ï…Ï„ÏŒ, Î¸Î± Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **ÎµÏ€Î¹ÎºÎ±Î»Ï…Ï†Î¸ÎµÎ¯** Ï„Î¿ **cookie** ÎºÎ±Î¹ Ï„Î¿ **stack canary**.\
Î•Ï€Î¹ÎºÎ±Î»ÏÏ€Ï„Î¿Î½Ï„Î±Ï‚ Ï„Î¿ PTR_MANGLE cookie, Î¸Î± Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **Ï€Î±ÏÎ±ÎºÎ±Î¼Ï†Î¸ÎµÎ¯ Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· `PTR_DEMANLE`** ÏÏ…Î¸Î¼Î¯Î¶Î¿Î½Ï„Î¬Ï‚ Ï„Î·Î½ ÏƒÎµ 0x00, Ï€Î¿Ï… ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Ï„Î¿ **`xor`** Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï„Î· Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ® Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î±Ï€Î»ÏÏ‚ Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÏÏ…Î¸Î¼Î¹ÏƒÏ„ÎµÎ¯. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î³ÏÎ¬Ï†Î¿Î½Ï„Î±Ï‚ ÏƒÏ„Î· **`dtor_list`** ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **Î±Î»Ï…ÏƒÎ¹Î´Ï‰Î¸Î¿ÏÎ½ Ï€Î¿Î»Î»Î­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚** Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ Ï„Î¿ **ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î¬** Ï„Î·Ï‚.

Î¤Î­Î»Î¿Ï‚, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Î´ÎµÎ½ Î¸Î± xored Î¼ÏŒÎ½Î¿ Î¼Îµ Ï„Î¿ cookie Î±Î»Î»Î¬ ÎºÎ±Î¹ Î¸Î± Ï€ÎµÏÎ¹ÏƒÏ„ÏÎ±Ï†ÎµÎ¯ 17 bits:
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î»Î¬Î²ÎµÏ„Îµ Ï…Ï€ÏŒÏˆÎ· Î±Ï…Ï„ÏŒ Ï€ÏÎ¹Î½ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Î¼Î¹Î± Î½Î­Î± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·.

Î’ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÏƒÏ„Î·Î½ [**Î±ÏÏ‡Î¹ÎºÎ® Î±Î½Î¬ÏÏ„Î·ÏƒÎ·**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite).

## Î†Î»Î»Î¿Î¹ Ï€Î±ÏÎ±Î¼Î¿ÏÏ†Ï‰Î¼Î­Î½Î¿Î¹ Î´ÎµÎ¯ÎºÏ„ÎµÏ‚ ÏƒÏ„Î¿ **`__run_exit_handlers`**

Î‘Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® ÎµÎ¯Î½Î±Î¹ [**ÎµÎ¾Î·Î³Î·Î¼Î­Î½Î· ÎµÎ´Ï**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite) ÎºÎ±Î¹ ÎµÎ¾Î±ÏÏ„Î¬Ï„Î±Î¹ Î¾Î±Î½Î¬ Î±Ï€ÏŒ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± **Î½Î± Ï„ÎµÏÎ¼Î±Ï„Î¯Î¶ÎµÎ¹ ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ `return` Î® `exit()`** ÏÏƒÏ„Îµ Î½Î± ÎºÎ»Î·Î¸ÎµÎ¯ **`__run_exit_handlers()`**.

Î‘Ï‚ ÎµÎ»Î­Î³Î¾Î¿Ï…Î¼Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± ÎºÏÎ´Î¹ÎºÎ± Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚:
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
Î— Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® `f` Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î· **`initial`** Î´Î¿Î¼Î® ÎºÎ±Î¹ Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® Ï„Î¿Ï… `f->flavor` Î¸Î± ÎºÎ»Î·Î¸Î¿ÏÎ½ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ­Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚.\
Î‘Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î·Î½ Ï„Î¹Î¼Î®, Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ Ï€Î¿Ï… Î¸Î± ÎºÎ»Î·Î¸ÎµÎ¯ Î¸Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ® Î¸Î­ÏƒÎ·, Î±Î»Î»Î¬ Î¸Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¬Î½Ï„Î± **demangled**.

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, ÏƒÏ„Î¹Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ **`ef_on`** ÎºÎ±Î¹ **`ef_cxa`** ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒÏ‚ Î¿ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÎµÎ½ÏŒÏ‚ **Î¿ÏÎ¯ÏƒÎ¼Î±Ï„Î¿Ï‚**.

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î· **`initial` Î´Î¿Î¼Î®** ÏƒÎµ Î¼Î¹Î± ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿ GEF Î½Î± Ï„ÏÎ­Ï‡ÎµÎ¹ **`gef> p initial`**.

Î“Î¹Î± Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Î±Ï…Ï„ÏŒ, Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ ÎµÎ¯Ï„Îµ Î½Î± **leak Î® Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ `PTR_MANGLE` cookie** ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÏ„Îµ Î¼Î¹Î± ÎµÎ¯ÏƒÎ¿Î´Î¿ `cxa` ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¼Îµ `system('/bin/sh')`.\
ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î¿Ï ÏƒÏ„Î¿ [**Î±ÏÏ‡Î¹ÎºÏŒ blog post ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î·Î½ Ï„ÎµÏ‡Î½Î¹ÎºÎ®**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure).

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
