# WWW2Exec - atexit(), TLSå­˜å‚¨å’Œå…¶ä»–æ··æ·†æŒ‡é’ˆ

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶(ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶(GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**Telegramç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **\_\_atexitç»“æ„**

{% hint style="danger" %}
ç°åœ¨åˆ©ç”¨è¿™ä¸ªæ˜¯éå¸¸**å¥‡æ€ªçš„ï¼**
{% endhint %}

**`atexit()`**æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ**å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚**è¿™äº›**å‡½æ•°**å°†åœ¨æ‰§è¡Œ**`exit()`**æˆ–**main**çš„**è¿”å›**æ—¶è¢«**æ‰§è¡Œ**ã€‚\
å¦‚æœä½ èƒ½**ä¿®æ”¹**è¿™äº›**å‡½æ•°**çš„**åœ°å€**ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ªshellcodeï¼Œä¾‹å¦‚ï¼Œä½ å°†**è·å¾—å¯¹**è¯¥**è¿›ç¨‹çš„æ§åˆ¶æƒ**ï¼Œä½†è¿™ç›®å‰æ›´å¤æ‚ã€‚\
ç›®å‰è¦æ‰§è¡Œçš„**å‡½æ•°çš„åœ°å€**è¢«**éšè—**åœ¨å‡ ä¸ªç»“æ„åï¼Œæœ€ç»ˆæŒ‡å‘çš„åœ°å€ä¸æ˜¯å‡½æ•°çš„åœ°å€ï¼Œè€Œæ˜¯**ç”¨XORåŠ å¯†**å’Œç”¨**éšæœºå¯†é’¥**è¿›è¡Œä½ç§»ã€‚å› æ­¤ï¼Œç›®å‰è¿™ä¸ªæ”»å‡»å‘é‡åœ¨x86å’Œx64\_86ä¸Š**ä¸æ˜¯å¾ˆæœ‰ç”¨**ã€‚\
**åŠ å¯†å‡½æ•°**æ˜¯**`PTR_MANGLE`**ã€‚**å…¶ä»–æ¶æ„**å¦‚m68kã€mips32ã€mips64ã€aarch64ã€armã€hppa...**ä¸å®ç°åŠ å¯†**å‡½æ•°ï¼Œå› ä¸ºå®ƒ**è¿”å›ä¸è¾“å…¥ç›¸åŒ**çš„å†…å®¹ã€‚å› æ­¤ï¼Œè¿™äº›æ¶æ„å¯ä»¥é€šè¿‡è¿™ä¸ªå‘é‡è¿›è¡Œæ”»å‡»ã€‚

ä½ å¯ä»¥åœ¨[https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html](https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html)æ‰¾åˆ°å…³äºè¿™ä¸ªå¦‚ä½•å·¥ä½œçš„æ·±å…¥è§£é‡Šã€‚

## link\_map

å¦‚[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure)æ‰€è¿°ï¼Œå¦‚æœç¨‹åºé€šè¿‡`return`æˆ–`exit()`é€€å‡ºï¼Œå®ƒå°†è¿è¡Œ`__run_exit_handlers()`ï¼Œè¿™å°†è°ƒç”¨æ³¨å†Œçš„ææ„å‡½æ•°ã€‚

{% hint style="danger" %}
å¦‚æœç¨‹åºé€šè¿‡**`_exit()`**å‡½æ•°é€€å‡ºï¼Œå®ƒå°†è°ƒç”¨**`exit`ç³»ç»Ÿè°ƒç”¨**ï¼Œè€Œé€€å‡ºå¤„ç†ç¨‹åºå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œä¸ºäº†ç¡®è®¤`__run_exit_handlers()`è¢«æ‰§è¡Œï¼Œä½ å¯ä»¥åœ¨å®ƒä¸Šé¢è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ã€‚
{% endhint %}

é‡è¦ä»£ç æ˜¯([source](https://elixir.bootlin.com/glibc/glibc-2.32/source/elf/dl-fini.c#L131)):
```c
ElfW(Dyn) *fini_array = map->l_info[DT_FINI_ARRAY];
if (fini_array != NULL)
{
ElfW(Addr) *array = (ElfW(Addr) *) (map->l_addr + fini_array->d_un.d_ptr);
size_t sz = (map->l_info[DT_FINI_ARRAYSZ]->d_un.d_val / sizeof (ElfW(Addr)));

while (sz-- > 0)
((fini_t) array[sz]) ();
}
[...]




// This is the d_un structure
ptype l->l_info[DT_FINI_ARRAY]->d_un
type = union {
Elf64_Xword d_val;	// address of function that will be called, we put our onegadget here
Elf64_Addr d_ptr;	// offset from l->l_addr of our structure
}
```
æ³¨æ„å¦‚ä½• `map -> l_addr + fini_array -> d_un.d_ptr` è¢«ç”¨æ¥**è®¡ç®—**è¦è°ƒç”¨çš„**å‡½æ•°æ•°ç»„**çš„ä½ç½®ã€‚

æœ‰**å‡ ç§é€‰æ‹©**ï¼š

* è¦†ç›– `map->l_addr` çš„å€¼ï¼Œä½¿å…¶æŒ‡å‘ä¸€ä¸ª**å‡çš„ `fini_array`**ï¼Œå…¶ä¸­åŒ…å«æ‰§è¡Œä»»æ„ä»£ç çš„æŒ‡ä»¤
* è¦†ç›– `l_info[DT_FINI_ARRAY]` å’Œ `l_info[DT_FINI_ARRAYSZ]` æ¡ç›®ï¼ˆåœ¨å†…å­˜ä¸­å¤§è‡´æ˜¯è¿ç»­çš„ï¼‰ï¼Œä½¿å®ƒä»¬**æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„ `Elf64_Dyn`** ç»“æ„ï¼Œè¿™å°†ä½¿**`array`å†æ¬¡æŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„å†…å­˜**åŒºåŸŸã€‚&#x20;
* [**è¿™ä¸ªå†™ä½œ**](https://github.com/nobodyisnobody/write-ups/tree/main/DanteCTF.2023/pwn/Sentence.To.Hell) ç”¨ä¸€ä¸ªå—æ§å†…å­˜ä¸­çš„åœ°å€è¦†ç›– `l_info[DT_FINI_ARRAY]`ï¼Œè¯¥å†…å­˜ä½äº `.bss` ä¸­ï¼ŒåŒ…å«ä¸€ä¸ªå‡çš„ `fini_array`ã€‚è¿™ä¸ªå‡æ•°ç»„**é¦–å…ˆåŒ…å«ä¸€ä¸ª** [**one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) **åœ°å€**ï¼Œå°†è¢«æ‰§è¡Œï¼Œç„¶åæ˜¯è¿™ä¸ª**å‡æ•°ç»„**çš„åœ°å€ä¸**`map->l_addr`**çš„**å·®å€¼**ï¼Œä½¿å¾— `*array` æŒ‡å‘å‡æ•°ç»„ã€‚
* æ ¹æ®è¯¥æŠ€æœ¯çš„ä¸»è¦å¸–å­å’Œ[**è¿™ä¸ªå†™ä½œ**](https://activities.tjhsst.edu/csc/writeups/angstromctf-2021-wallstreet)ï¼Œld.so åœ¨æ ˆä¸Šç•™ä¸‹ä¸€ä¸ªæŒ‡å‘ ld.so ä¸­äºŒè¿›åˆ¶ `link_map` çš„æŒ‡é’ˆã€‚é€šè¿‡ä»»æ„å†™å…¥ï¼Œå¯ä»¥è¦†ç›–å®ƒå¹¶ä½¿å…¶æŒ‡å‘ä¸€ä¸ªç”±æ”»å‡»è€…æ§åˆ¶çš„å‡ `fini_array`ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª [**one gadget**](../rop-return-oriented-programing/ret2lib/one-gadget.md) çš„åœ°å€ï¼Œä¾‹å¦‚ã€‚

åœ¨å‰é¢çš„ä»£ç ä¹‹åï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å¦ä¸€ä¸ªæœ‰è¶£çš„ä»£ç éƒ¨åˆ†ï¼š
```c
/* Next try the old-style destructor.  */
ElfW(Dyn) *fini = map->l_info[DT_FINI];
if (fini != NULL)
DL_CALL_DT_FINI (map, ((void *) map->l_addr + fini->d_un.d_ptr));
}
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è¦†ç›–æŒ‡å‘ä¼ªé€ çš„ `ElfW(Dyn)` ç»“æ„çš„ `map->l_info[DT_FINI]` çš„å€¼ã€‚æŸ¥æ‰¾ [**æ›´å¤šä¿¡æ¯è¿™é‡Œ**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#2---targetting-ldso-link\_map-structure)ã€‚

## TLS-Storage dtor\_list åœ¨ **`__run_exit_handlers`** ä¸­çš„è¦†ç›–

æ­£å¦‚ [**è¿™é‡Œè§£é‡Šçš„**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ï¼Œå¦‚æœç¨‹åºé€šè¿‡ `return` æˆ– `exit()` é€€å‡ºï¼Œå®ƒå°†æ‰§è¡Œ **`__run_exit_handlers()`**ï¼Œè¯¥å‡½æ•°å°†è°ƒç”¨ä»»ä½•æ³¨å†Œçš„ææ„å‡½æ•°ã€‚

æ¥è‡ª `_run_exit_handlers()` çš„ä»£ç ï¼š
```c
/* Call all functions registered with `atexit' and `on_exit',
in the reverse of the order in which they were registered
perform stdio cleanup, and terminate program execution with STATUS.  */
void
attribute_hidden
__run_exit_handlers (int status, struct exit_function_list **listp,
bool run_list_atexit, bool run_dtors)
{
/* First, call the TLS destructors.  */
#ifndef SHARED
if (&__call_tls_dtors != NULL)
#endif
if (run_dtors)
__call_tls_dtors ();
```
**`__call_tls_dtors()`** çš„ä»£ç ï¼š
```c
typedef void (*dtor_func) (void *);
struct dtor_list //struct added
{
dtor_func func;
void *obj;
struct link_map *map;
struct dtor_list *next;
};

[...]
/* Call the destructors.  This is called either when a thread returns from the
initial function or when the process exits via the exit function.  */
void
__call_tls_dtors (void)
{
while (tls_dtor_list)		// parse the dtor_list chained structures
{
struct dtor_list *cur = tls_dtor_list;		// cur point to tls-storage dtor_list
dtor_func func = cur->func;
PTR_DEMANGLE (func);						// demangle the function ptr

tls_dtor_list = tls_dtor_list->next;		// next dtor_list structure
func (cur->obj);
[...]
}
}
```
å¯¹äº**`tls_dtor_list`**ä¸­æ¯ä¸ªæ³¨å†Œçš„å‡½æ•°ï¼Œå®ƒå°†ä»**`cur->func`**ä¸­è§£ç æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨å‚æ•°**`cur->obj`**è°ƒç”¨å®ƒã€‚

ä½¿ç”¨è¿™ä¸ª[**GEFçš„åˆ†æ”¯**](https://github.com/bata24/gef)ä¸­çš„**`tls`**å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Š**`dtor_list`**éå¸¸**æ¥è¿‘**äº**stack canary**å’Œ**PTR_MANGLE cookie**ã€‚å› æ­¤ï¼Œé€šè¿‡å¯¹å…¶è¿›è¡Œæº¢å‡ºï¼Œå°†æœ‰å¯èƒ½**è¦†ç›–**è¯¥**cookie**å’Œ**stack canary**ã€‚\
è¦†ç›–PTR_MANGLE cookieåï¼Œé€šè¿‡å°†å…¶è®¾ç½®ä¸º0x00ï¼Œå¯ä»¥**ç»•è¿‡`PTR_DEMANLE`å‡½æ•°**ï¼Œè¿™æ„å‘³ç€ç”¨äºè·å–çœŸå®åœ°å€çš„**`xor`**åªæ˜¯é…ç½®çš„åœ°å€ã€‚ç„¶åï¼Œé€šè¿‡å†™å…¥**`dtor_list`**ï¼Œå¯ä»¥**é“¾æ¥å¤šä¸ªå‡½æ•°**åŠå…¶**åœ°å€**å’Œ**å‚æ•°**ã€‚

æœ€åè¯·æ³¨æ„ï¼Œå­˜å‚¨çš„æŒ‡é’ˆä¸ä»…ä¼šä¸cookieè¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œè¿˜ä¼šæ—‹è½¬17ä½ï¼š
```armasm
0x00007fc390444dd4 <+36>:	mov    rax,QWORD PTR [rbx]      --> mangled ptr
0x00007fc390444dd7 <+39>:	ror    rax,0x11		        --> rotate of 17 bits
0x00007fc390444ddb <+43>:	xor    rax,QWORD PTR fs:0x30	--> xor with PTR_MANGLE
```
æ‰€ä»¥åœ¨æ·»åŠ æ–°åœ°å€ä¹‹å‰ï¼Œä½ éœ€è¦è€ƒè™‘è¿™ä¸€ç‚¹ã€‚

åœ¨[**åŸå§‹å¸–å­**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ä¸­æ‰¾åˆ°ä¸€ä¸ªä¾‹å­ã€‚

## **`__run_exit_handlers`**ä¸­çš„å…¶ä»–æŸåæŒ‡é’ˆ

è¿™ä¸ªæŠ€æœ¯åœ¨[**è¿™é‡Œè§£é‡Š**](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#5---code-execution-via-tls-storage-dtor\_list-overwrite)ï¼Œå¹¶ä¸”å†æ¬¡ä¾èµ–äºç¨‹åº**é€šè¿‡è°ƒç”¨`return`æˆ–`exit()`é€€å‡º**ï¼Œå› æ­¤è°ƒç”¨äº†**`__run_exit_handlers()`**ã€‚

è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ›´å¤šä»£ç ï¼š
```c
while (true)
{
struct exit_function_list *cur;

restart:
cur = *listp;

if (cur == NULL)
{
/* Exit processing complete.  We will not allow any more
atexit/on_exit registrations.  */
__exit_funcs_done = true;
break;
}

while (cur->idx > 0)
{
struct exit_function *const f = &cur->fns[--cur->idx];
const uint64_t new_exitfn_called = __new_exitfn_called;

switch (f->flavor)
{
void (*atfct) (void);
void (*onfct) (int status, void *arg);
void (*cxafct) (void *arg, int status);
void *arg;

case ef_free:
case ef_us:
break;
case ef_on:
onfct = f->func.on.fn;
arg = f->func.on.arg;
PTR_DEMANGLE (onfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
onfct (status, arg);
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_at:
atfct = f->func.at;
PTR_DEMANGLE (atfct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
atfct ();
__libc_lock_lock (__exit_funcs_lock);
break;
case ef_cxa:
/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),
we must mark this function as ef_free.  */
f->flavor = ef_free;
cxafct = f->func.cxa.fn;
arg = f->func.cxa.arg;
PTR_DEMANGLE (cxafct);

/* Unlock the list while we call a foreign function.  */
__libc_lock_unlock (__exit_funcs_lock);
cxafct (arg, status);
__libc_lock_lock (__exit_funcs_lock);
break;
}

if (__glibc_unlikely (new_exitfn_called != __new_exitfn_called))
/* The last exit function, or another thread, has registered
more exit functions.  Start the loop over.  */
goto restart;
}

*listp = cur->next;
if (*listp != NULL)
/* Don't free the last element in the chain, this is the statically
allocate element.  */
free (cur);
}

__libc_lock_unlock (__exit_funcs_lock);
```
å˜é‡ `f` æŒ‡å‘ **`initial`** ç»“æ„ï¼Œå…·ä½“è°ƒç”¨å“ªä¸ªå‡½æ•°å–å†³äº `f->flavor` çš„å€¼ã€‚\
æ ¹æ®è¯¥å€¼ï¼Œè°ƒç”¨çš„å‡½æ•°åœ°å€ä¼šåœ¨ä¸åŒçš„ä½ç½®ï¼Œä½†å®ƒå§‹ç»ˆæ˜¯ **demangled** çš„ã€‚

æ­¤å¤–ï¼Œåœ¨é€‰é¡¹ **`ef_on`** å’Œ **`ef_cxa`** ä¸­ï¼Œä¹Ÿå¯ä»¥æ§åˆ¶ä¸€ä¸ª **argument**ã€‚

å¯ä»¥åœ¨è°ƒè¯•ä¼šè¯ä¸­ä½¿ç”¨ GEF æ£€æŸ¥ **`initial` ç»“æ„**ï¼Œå‘½ä»¤ä¸º **`gef> p initial`**ã€‚

è¦åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦ **leak æˆ–è€…æ“¦é™¤ `PTR_MANGLE`cookie**ï¼Œç„¶åç”¨ `system('/bin/sh')` è¦†ç›– `initial` ä¸­çš„ `cxa` æ¡ç›®ã€‚\
ä½ å¯ä»¥åœ¨ [**å…³äºè¯¥æŠ€æœ¯çš„åŸå§‹åšå®¢æ–‡ç« **](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md#6---code-execution-via-other-mangled-pointers-in-initial-structure) ä¸­æ‰¾åˆ°è¿™ä¸ªä¾‹å­ã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
