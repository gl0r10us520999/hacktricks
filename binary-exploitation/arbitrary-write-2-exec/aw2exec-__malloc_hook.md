# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Malloc Hook**

–Ø–∫ –≤–∏ –º–æ–∂–µ—Ç–µ [–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π —Å–∞–π—Ç GNU](https://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html), –∑–º—ñ–Ω–Ω–∞ **`__malloc_hook`** —î –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ **–∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫–∞ –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–∞** —â–æ—Ä–∞–∑—É, –∫–æ–ª–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `malloc()`, **–∑–±–µ—Ä–µ–∂–µ–Ω—É –≤ —Å–µ–∫—Ü—ñ—ó –¥–∞–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc**. –¢–æ–º—É, —è–∫—â–æ —Ü—è –∞–¥—Ä–µ—Å–∞ –±—É–¥–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **One Gadget**, —ñ –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–æ `malloc`, **–±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–æ One Gadget**.

–©–æ–± –≤–∏–∫–ª–∏–∫–∞—Ç–∏ malloc, –º–æ–∂–Ω–∞ –¥–æ—á–µ–∫–∞—Ç–∏—Å—è, –ø–æ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –≤–∏–∫–ª–∏—á–µ –π–æ–≥–æ, –∞–±–æ **–≤–∏–∫–ª–∏–∫–∞–≤—à–∏ `printf("%10000$c")**, —â–æ –≤–∏–¥—ñ–ª—è—î –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ –±–∞–π—Ç—ñ–≤, –∑–º—É—à—É—é—á–∏ `libc` –≤–∏–∫–ª–∏–∫–∞—Ç–∏ malloc –¥–ª—è —ó—Ö –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –≤ –∫—É–ø—ñ.

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ One Gadget –≤:

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —Ö—É–∫–∏ **–≤–∏–º–∫–Ω–µ–Ω—ñ –¥–ª—è GLIBC >= 2.34**. –Ñ —ñ–Ω—à—ñ —Ç–µ—Ö–Ω—ñ–∫–∏, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤ —Å—É—á–∞—Å–Ω–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö GLIBC. –î–∏–≤—ñ—Ç—å—Å—è: [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).
{% endhint %}

## Free Hook

–¶–µ –±—É–ª–æ –∑–ª–æ–≤–∂–∏—Ç–æ –≤ –æ–¥–Ω–æ–º—É –∑ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ –∞—Ç–∞–∫–æ—é —à–≤–∏–¥–∫–æ–≥–æ –±—ñ–Ω—É –ø—ñ—Å–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –∞—Ç–∞–∫–æ—é –Ω–µ–∑–∞—Å–æ—Ä—Ç–æ–≤–∞–Ω–æ–≥–æ –±—ñ–Ω—É:

{% content-ref url="../libc-heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../libc-heap/unsorted-bin-attack.md)
{% endcontent-ref %}

–ú–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å—É `__free_hook`, —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –º–∞—î —Å–∏–º–≤–æ–ª–∏, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏:
```bash
gef‚û§  p &__free_hook
```
[–£ –ø–æ—Å—Ç—ñ](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html) –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ –ø–æ–∫—Ä–æ–∫–æ–≤—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –ø—Ä–æ —Ç–µ, —è–∫ –∑–Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å—É free hook –±–µ–∑ —Å–∏–º–≤–æ–ª—ñ–≤. –£ –ø—ñ–¥—Å—É–º–∫—É, —É —Ñ—É–Ω–∫—Ü—ñ—ó free:

<pre class="language-armasm"><code class="lang-armasm">gef‚û§  x/20i free
0xf75dedc0 &#x3C;free>: push   ebx
0xf75dedc1 &#x3C;free+1>: call   0xf768f625
0xf75dedc6 &#x3C;free+6>: add    ebx,0x14323a
0xf75dedcc &#x3C;free+12>:  sub    esp,0x8
0xf75dedcf &#x3C;free+15>:  mov    eax,DWORD PTR [ebx-0x98]
0xf75dedd5 &#x3C;free+21>:  mov    ecx,DWORD PTR [esp+0x10]
<strong>0xf75dedd9 &#x3C;free+25>:  mov    eax,DWORD PTR [eax]--- BREAK HERE
</strong>0xf75deddb &#x3C;free+27>:  test   eax,eax ;&#x3C;
0xf75deddd &#x3C;free+29>:  jne    0xf75dee50 &#x3C;free+144>
</code></pre>

–£ –≤–∫–∞–∑–∞–Ω—ñ–π —Ç–æ—á—Ü—ñ –∑—É–ø–∏–Ω–∫–∏ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫–æ–¥—ñ –≤ `$eax` –±—É–¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏—Å—è –∞–¥—Ä–µ—Å–∞ free hook.

–¢–µ–ø–µ—Ä –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–∞—Ç–∞–∫–∞ –Ω–∞ —à–≤–∏–¥–∫—ñ –±—ñ–Ω–∞—Ä–∏**:

* –ü–æ-–ø–µ—Ä—à–µ, –≤–∏—è–≤–ª–µ–Ω–æ, —â–æ –º–æ–∂–ª–∏–≤–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ —à–≤–∏–¥–∫–∏–º–∏ **—á–∞—Å—Ç–∏–Ω–∞–º–∏ —Ä–æ–∑–º—ñ—Ä—É 200** –≤ –º—ñ—Å—Ü—ñ **`__free_hook`**:
* <pre class="language-c"><code class="lang-c">gef‚û§  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gef‚û§  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* –Ø–∫—â–æ –Ω–∞–º –≤–¥–∞—Å—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —à–≤–∏–¥–∫—É —á–∞—Å—Ç–∏–Ω—É —Ä–æ–∑–º—ñ—Ä—É 0x200 —É —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ, –±—É–¥–µ –º–æ–∂–ª–∏–≤–∏–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫–∞ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–∞
* –î–ª—è —Ü—å–æ–≥–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –Ω–æ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É `0xfc` —ñ –æ–±'—î–¥–Ω–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ —Ü–∏–º –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º –¥–≤—ñ—á—ñ, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω—É —á–∞—Å—Ç–∏–Ω—É —Ä–æ–∑–º—ñ—Ä—É `0xfc*2 = 0x1f8` —É —à–≤–∏–¥–∫–æ–º—É –±—ñ–Ω–∞—Ä—ñ.
* –ü–æ—Ç—ñ–º –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤ —Ü—ñ–π —á–∞—Å—Ç–∏–Ω—ñ, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –∞–¥—Ä–µ—Å—É **`fd`** —Ü—å–æ–≥–æ —à–≤–∏–¥–∫–æ–≥–æ –±—ñ–Ω–∞—Ä—É, —â–æ–± –≤–∫–∞–∑–∞—Ç–∏ –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—é —Ñ—É–Ω–∫—Ü—ñ—é **`__free_hook`**.
* –ü–æ—Ç—ñ–º —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —á–∞—Å—Ç–∏–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É `0x1f8`, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ —à–≤–∏–¥–∫–æ–≥–æ –±—ñ–Ω–∞—Ä—É –ø–æ–ø–µ—Ä–µ–¥–Ω—é –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω—É —á–∞—Å—Ç–∏–Ω—É, —Ç–æ–º—É —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —â–µ –æ–¥–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É `0x1f8`, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —à–≤–∏–¥–∫—É —á–∞—Å—Ç–∏–Ω—É –≤ **`__free_hook`**, —è–∫–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –∞–¥—Ä–µ—Å–æ—é —Ñ—É–Ω–∫—Ü—ñ—ó **`system`**.
* –Ü –Ω–∞—Ä–µ—à—Ç—ñ, —á–∞—Å—Ç–∏–Ω–∞, —â–æ –º—ñ—Å—Ç–∏—Ç—å —Ä—è–¥–æ–∫ `/bin/sh\x00`, –∑–≤—ñ–ª—å–Ω—è—î—Ç—å—Å—è, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–Ω—è, —â–æ –≤–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é **`__free_hook`**, —è–∫–∞ –≤–∫–∞–∑—É—î –Ω–∞ system –∑ `/bin/sh\x00` —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º.

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –Ω–∞–º–∏ –≤** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
{% endhint %}
