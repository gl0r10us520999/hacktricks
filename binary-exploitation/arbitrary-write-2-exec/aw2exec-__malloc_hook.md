# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Malloc Hook**

ê³µì‹ GNU ì‚¬ì´íŠ¸ì— ë”°ë¥´ë©´, ë³€ìˆ˜ **`__malloc_hook`**ëŠ” `malloc()`ì´ í˜¸ì¶œë  ë•Œë§ˆë‹¤ í˜¸ì¶œë  í•¨ìˆ˜ì˜ **ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°**ë¡œ, **libc ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë°ì´í„° ì„¹ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ ì£¼ì†Œê°€ ì˜ˆë¥¼ ë“¤ì–´ **One Gadget**ìœ¼ë¡œ ë®ì–´ì“°ì—¬ì§€ë©´ `malloc`ì´ í˜¸ì¶œë  ë•Œ **One Gadgetì´ í˜¸ì¶œë©ë‹ˆë‹¤**.

`malloc`ì„ í˜¸ì¶œí•˜ê¸° ìœ„í•´ í”„ë¡œê·¸ë¨ì´ í˜¸ì¶œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê±°ë‚˜ **`printf("%10000$c")`**ë¥¼ í˜¸ì¶œí•˜ì—¬ `libc`ê°€ í™ì— í• ë‹¹í•˜ë„ë¡ `malloc`ì„ í˜¸ì¶œí•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

One Gadgetì— ëŒ€í•œ ë” ë§ì€ ì •ë³´ëŠ” ë‹¤ìŒì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
GLIBC >= 2.34ì—ì„œëŠ” í›…ì´ **ë¹„í™œì„±í™”**ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìµœì‹  GLIBC ë²„ì „ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ê¸°ìˆ ì´ ìˆìŠµë‹ˆë‹¤. ì°¸ì¡°: [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).
{% endhint %}

## Free Hook

ì´ëŠ” ì •ë ¬ë˜ì§€ ì•Šì€ ë¹ˆ ê³µê²©ì„ ë‚¨ìš©í•œ í›„ ë¹ ë¥¸ ë¹ˆ ê³µê²©ì„ ë‚¨ìš©í•œ ì˜ˆì œ ì¤‘ í•˜ë‚˜ì—ì„œ ì•…ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:

{% content-ref url="../libc-heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../libc-heap/unsorted-bin-attack.md)
{% endcontent-ref %}

ì´ì§„ íŒŒì¼ì— ê¸°í˜¸ê°€ ìˆëŠ” ê²½ìš° `__free_hook`ì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
```bash
gefâ¤  p &__free_hook
```
[ì´ í¬ìŠ¤íŠ¸](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)ì—ì„œëŠ” ê¸°í˜¸ ì—†ì´ free hookì˜ ì£¼ì†Œë¥¼ ì°¾ëŠ” ë°©ë²•ì— ëŒ€í•œ ë‹¨ê³„ë³„ ê°€ì´ë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš”ì•½í•˜ìë©´, free í•¨ìˆ˜ì—ì„œ:

<pre class="language-armasm"><code class="lang-armasm">gefâ¤  x/20i free
0xf75dedc0 &#x3C;free>: push   ebx
0xf75dedc1 &#x3C;free+1>: call   0xf768f625
0xf75dedc6 &#x3C;free+6>: add    ebx,0x14323a
0xf75dedcc &#x3C;free+12>:  sub    esp,0x8
0xf75dedcf &#x3C;free+15>:  mov    eax,DWORD PTR [ebx-0x98]
0xf75dedd5 &#x3C;free+21>:  mov    ecx,DWORD PTR [esp+0x10]
<strong>0xf75dedd9 &#x3C;free+25>:  mov    eax,DWORD PTR [eax]--- ì—¬ê¸°ì„œ ì¤‘ë‹¨
</strong>0xf75deddb &#x3C;free+27>:  test   eax,eax ;&#x3C;
0xf75deddd &#x3C;free+29>:  jne    0xf75dee50 &#x3C;free+144>
</code></pre>

ì•ì„œ ì–¸ê¸‰í•œ ì½”ë“œì˜ ì¤‘ë‹¨ì ì—ì„œ `$eax`ì—ëŠ” free hookì˜ ì£¼ì†Œê°€ ìœ„ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤.

ì´ì œ **fast bin attack**ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤:

* ìš°ì„ , **`__free_hook`** ìœ„ì¹˜ì—ì„œ **í¬ê¸° 200**ì˜ ë¹ ë¥¸ **ì²­í¬**ë¡œ ì‘ì—…í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* ì´ ìœ„ì¹˜ì—ì„œ í¬ê¸° 0x200ì˜ ë¹ ë¥¸ ì²­í¬ë¥¼ ì–»ìœ¼ë©´ ì‹¤í–‰ë  í•¨ìˆ˜ í¬ì¸í„°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì´ë¥¼ ìœ„í•´ í¬ê¸° `0xfc`ì˜ ìƒˆë¡œìš´ ì²­í¬ë¥¼ ìƒì„±í•˜ê³ , ê·¸ í¬ì¸í„°ë¡œ ë³‘í•©ëœ í•¨ìˆ˜ë¥¼ ë‘ ë²ˆ í˜¸ì¶œí•˜ì—¬ í¬ê¸° `0xfc*2 = 0x1f8`ì˜ í•´ì œëœ ì²­í¬ì— ëŒ€í•œ í¬ì¸í„°ë¥¼ ì–»ìŠµë‹ˆë‹¤.
* ê·¸ëŸ° ë‹¤ìŒ, ì´ ì²­í¬ì—ì„œ **`fd`** ì£¼ì†Œë¥¼ ì´ì „ **`__free_hook`** í•¨ìˆ˜ë¡œ ê°€ë¦¬í‚¤ë„ë¡ ìˆ˜ì •í•˜ëŠ” í¸ì§‘ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
* ì´í›„, í¬ê¸° `0x1f8`ì˜ ì²­í¬ë¥¼ ìƒì„±í•˜ì—¬ ë¹ ë¥¸ ë¹ˆì—ì„œ ì´ì „ì˜ ì“¸ëª¨ì—†ëŠ” ì²­í¬ë¥¼ ê°€ì ¸ì˜¤ê³ , ë˜ ë‹¤ë¥¸ í¬ê¸° `0x1f8`ì˜ ì²­í¬ë¥¼ ìƒì„±í•˜ì—¬ **`__free_hook`**ì—ì„œ ë¹ ë¥¸ ë¹ˆ ì²­í¬ë¥¼ ê°€ì ¸ì˜¤ê³ , ì´ë¥¼ **`system`** í•¨ìˆ˜ì˜ ì£¼ì†Œë¡œ ë®ì–´ì”ë‹ˆë‹¤.
* ë§ˆì§€ë§‰ìœ¼ë¡œ, ë¬¸ìì—´ `/bin/sh\x00`ë¥¼ í¬í•¨í•˜ëŠ” ì²­í¬ë¥¼ ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œë¡œ í•´ì œí•˜ì—¬ **`__free_hook`** í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•˜ê³ , ì´ í•¨ìˆ˜ëŠ” `/bin/sh\x00`ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ í•˜ì—¬ systemì„ ê°€ë¦¬í‚µë‹ˆë‹¤.

## References

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
