# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **Malloc Hook**

æ­£å¦‚ä½ å¯ä»¥åœ¨ [å®˜æ–¹ GNU ç½‘ç«™](https://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html) ä¸Šçœ‹åˆ°çš„ï¼Œå˜é‡ **`__malloc_hook`** æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ **æ¯å½“è°ƒç”¨ `malloc()` æ—¶å°†è¢«è°ƒç”¨çš„å‡½æ•°çš„åœ°å€**ï¼Œè¯¥åœ°å€ **å­˜å‚¨åœ¨ libc åº“çš„æ•°æ®æ®µä¸­**ã€‚å› æ­¤ï¼Œå¦‚æœè¿™ä¸ªåœ°å€è¢«è¦†ç›–ä¸ºä¸€ä¸ª **One Gadget**ï¼Œä¾‹å¦‚ï¼Œå½“è°ƒç”¨ `malloc` æ—¶ï¼Œ**One Gadget å°†è¢«è°ƒç”¨**ã€‚

è¦è°ƒç”¨ mallocï¼Œå¯ä»¥ç­‰å¾…ç¨‹åºè°ƒç”¨å®ƒï¼Œæˆ–è€…é€šè¿‡ **è°ƒç”¨ `printf("%10000$c")`**ï¼Œè¿™ä¼šåˆ†é…è¿‡å¤šçš„å­—èŠ‚ï¼Œä½¿å¾— `libc` è°ƒç”¨ malloc åœ¨å †ä¸­åˆ†é…å®ƒä»¬ã€‚

æœ‰å…³ One Gadget çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œ**GLIBC >= 2.34 çš„é’©å­å·²è¢«ç¦ç”¨**ã€‚åœ¨ç°ä»£ GLIBC ç‰ˆæœ¬ä¸­å¯ä»¥ä½¿ç”¨å…¶ä»–æŠ€æœ¯ã€‚è¯·å‚è§ï¼š[https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md)ã€‚
{% endhint %}

## Free Hook

è¿™åœ¨é¡µé¢ä¸­çš„ä¸€ä¸ªç¤ºä¾‹ä¸­è¢«æ»¥ç”¨ï¼Œæ»¥ç”¨äº†ä¸€æ¬¡å¿«é€Ÿ bin æ”»å‡»ï¼Œä¹‹ååˆæ»¥ç”¨äº†ä¸€æ¬¡æœªæ’åº bin æ”»å‡»ï¼š

{% content-ref url="../libc-heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../libc-heap/unsorted-bin-attack.md)
{% endcontent-ref %}

å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰ç¬¦å·ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰¾åˆ° `__free_hook` çš„åœ°å€ï¼š
```bash
gefâ¤  p &__free_hook
```
[åœ¨è¿™ç¯‡æ–‡ç« ä¸­](https://guyinatuxedo.github.io/41-house\_of\_force/bkp16\_cookbook/index.html)ï¼Œä½ å¯ä»¥æ‰¾åˆ°å¦‚ä½•åœ¨æ²¡æœ‰ç¬¦å·çš„æƒ…å†µä¸‹å®šä½ free hook åœ°å€çš„é€æ­¥æŒ‡å—ã€‚æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨ free å‡½æ•°ä¸­ï¼š

<pre class="language-armasm"><code class="lang-armasm">gefâ¤  x/20i free
0xf75dedc0 &#x3C;free>: push   ebx
0xf75dedc1 &#x3C;free+1>: call   0xf768f625
0xf75dedc6 &#x3C;free+6>: add    ebx,0x14323a
0xf75dedcc &#x3C;free+12>:  sub    esp,0x8
0xf75dedcf &#x3C;free+15>:  mov    eax,DWORD PTR [ebx-0x98]
0xf75dedd5 &#x3C;free+21>:  mov    ecx,DWORD PTR [esp+0x10]
<strong>0xf75dedd9 &#x3C;free+25>:  mov    eax,DWORD PTR [eax]--- åœ¨è¿™é‡Œä¸­æ–­
</strong>0xf75deddb &#x3C;free+27>:  test   eax,eax ;&#x3C;
0xf75deddd &#x3C;free+29>:  jne    0xf75dee50 &#x3C;free+144>
</code></pre>

åœ¨å‰é¢ä»£ç ä¸­æåˆ°çš„ä¸­æ–­ä½ç½®ï¼Œ`$eax` ä¸­å°†ä¼šå­˜æ”¾ free hook çš„åœ°å€ã€‚

ç°åœ¨è¿›è¡Œä¸€ä¸ª **fast bin attack**ï¼š

* é¦–å…ˆå‘ç°å¯ä»¥åœ¨ **`__free_hook`** ä½ç½®å¤„ç† **å¤§å°ä¸º 200 çš„å¿«é€Ÿå—**ï¼š
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿™ä¸ªä½ç½®è·å–ä¸€ä¸ªå¤§å°ä¸º 0x200 çš„å¿«é€Ÿå—ï¼Œå°±å¯ä»¥è¦†ç›–ä¸€ä¸ªå°†è¢«æ‰§è¡Œçš„å‡½æ•°æŒ‡é’ˆã€‚
* ä¸ºæ­¤ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `0xfc` çš„æ–°å—ï¼Œå¹¶ç”¨è¯¥æŒ‡é’ˆè°ƒç”¨åˆå¹¶å‡½æ•°ä¸¤æ¬¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨å¿«é€Ÿå—ä¸­è·å¾—ä¸€ä¸ªæŒ‡å‘å¤§å°ä¸º `0xfc*2 = 0x1f8` çš„å·²é‡Šæ”¾å—çš„æŒ‡é’ˆã€‚
* ç„¶åï¼Œåœ¨è¿™ä¸ªå—ä¸­è°ƒç”¨ç¼–è¾‘å‡½æ•°ï¼Œå°†è¿™ä¸ªå¿«é€Ÿå—çš„ **`fd`** åœ°å€ä¿®æ”¹ä¸ºæŒ‡å‘ä¹‹å‰çš„ **`__free_hook`** å‡½æ•°ã€‚
* æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `0x1f8` çš„å—ï¼Œä»å¿«é€Ÿå—ä¸­æ£€ç´¢ä¹‹å‰æ— ç”¨çš„å—ï¼Œå› æ­¤å†åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `0x1f8` çš„å—ï¼Œä»¥åœ¨ **`__free_hook`** ä¸­è·å–ä¸€ä¸ªå¿«é€Ÿå—ï¼Œå¹¶ç”¨ **`system`** å‡½æ•°çš„åœ°å€è¦†ç›–å®ƒã€‚
* æœ€åï¼Œé‡Šæ”¾ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸² `/bin/sh\x00` çš„å—ï¼Œè°ƒç”¨åˆ é™¤å‡½æ•°ï¼Œè§¦å‘ **`__free_hook`** å‡½æ•°ï¼Œè¯¥å‡½æ•°å°† `/bin/sh\x00` ä½œä¸ºå‚æ•°æŒ‡å‘ systemã€‚

## å‚è€ƒæ–‡çŒ®

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hackingï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hackingï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
