# Podstawowa Metodologia Eksploatacji Binarnych

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

## Podstawowe Informacje o ELF

Zanim zaczniesz eksploatowaÄ‡ cokolwiek, warto zrozumieÄ‡ czÄ™Å›Ä‡ struktury **pliku binarnego ELF**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## NarzÄ™dzia Eksploatacji

{% content-ref url="tools/" %}
[narzÄ™dzia](tools/)
{% endcontent-ref %}

## Metodologia PrzepeÅ‚nienia Stosu

Przy tak wielu technikach dobrze jest mieÄ‡ schemat, kiedy kaÅ¼da technika bÄ™dzie przydatna. ZauwaÅ¼, Å¼e te same zabezpieczenia bÄ™dÄ… wpÅ‚ywaÄ‡ na rÃ³Å¼ne techniki. MoÅ¼esz znaleÅºÄ‡ sposoby na obejÅ›cie zabezpieczeÅ„ w kaÅ¼dej sekcji zabezpieczeÅ„, ale nie w tej metodologii.

## Kontrolowanie PrzepÅ‚ywu

IstniejÄ… rÃ³Å¼ne sposoby, w jakie moÅ¼esz kontrolowaÄ‡ przepÅ‚yw programu:

* [**PrzepeÅ‚nienia Stosu**](../stack-overflow/) nadpisujÄ…c wskaÅºnik powrotu ze stosu lub EBP -> ESP -> EIP.
* MoÅ¼e byÄ‡ konieczne naduÅ¼ycie [**PrzepeÅ‚nieÅ„ Liczbowych**](../integer-overflow.md), aby spowodowaÄ‡ przepeÅ‚nienie.
* Lub poprzez **Arbitralne Zapisanie + Write What Where to Execution**.
* [**Formaty ciÄ…gÃ³w**](../format-strings/)**:** NaduÅ¼yj `printf`, aby zapisaÄ‡ arbitralnÄ… zawartoÅ›Ä‡ w arbitralnych adresach.
* [**Indeksowanie Tablic**](../array-indexing.md): NaduÅ¼yj Åºle zaprojektowanego indeksowania, aby mÃ³c kontrolowaÄ‡ niektÃ³re tablice i uzyskaÄ‡ arbitralne zapisanie.
* MoÅ¼e byÄ‡ konieczne naduÅ¼ycie [**PrzepeÅ‚nieÅ„ Liczbowych**](../integer-overflow.md), aby spowodowaÄ‡ przepeÅ‚nienie.
* **bof do WWW poprzez ROP**: NaduÅ¼yj przepeÅ‚nienia bufora, aby skonstruowaÄ‡ ROP i mÃ³c uzyskaÄ‡ WWW.

MoÅ¼esz znaleÅºÄ‡ techniki **Write What Where to Execution** w:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Wieczne PÄ™tle

CoÅ›, co naleÅ¼y wziÄ…Ä‡ pod uwagÄ™, to Å¼e zazwyczaj **jedna eksploatacja luki moÅ¼e nie byÄ‡ wystarczajÄ…ca**, aby przeprowadziÄ‡ udanÄ… eksploatacjÄ™, szczegÃ³lnie niektÃ³re zabezpieczenia muszÄ… byÄ‡ obejÅ›cie. Dlatego warto omÃ³wiÄ‡ kilka opcji, aby **uczyniÄ‡ jednÄ… lukÄ™ eksploatowalnÄ… wiele razy** w tej samej egzekucji binarnej:

* Zapisz w Å‚aÅ„cuchu **ROP** adres funkcji **`main`** lub adres, w ktÃ³rym wystÄ™puje **luka**.
* KontrolujÄ…c odpowiedni Å‚aÅ„cuch ROP, moÅ¼esz wykonaÄ‡ wszystkie akcje w tym Å‚aÅ„cuchu.
* Zapisz w **adresie `exit` w GOT** (lub jakiejkolwiek innej funkcji uÅ¼ywanej przez binarny przed zakoÅ„czeniem) adres, aby wrÃ³ciÄ‡ **do luki**.
* Jak wyjaÅ›niono w [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** przechowuj tutaj 2 funkcje, jednÄ… do ponownego wywoÅ‚ania luki i drugÄ… do wywoÅ‚ania **`__libc_csu_fini`**, ktÃ³ra ponownie wywoÅ‚a funkcjÄ™ z `.fini_array`.

## Cele Eksploatacji

### Cel: WywoÅ‚anie IstniejÄ…cej Funkcji

* [**ret2win**](./#ret2win): Istnieje funkcja w kodzie, ktÃ³rÄ… musisz wywoÅ‚aÄ‡ (moÅ¼e z pewnymi specyficznymi parametrami), aby uzyskaÄ‡ flagÄ™.
* W **zwykÅ‚ym bof bez** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/) wystarczy zapisaÄ‡ adres w adresie powrotu przechowywanym na stosie.
* W bof z [**PIE**](../common-binary-protections-and-bypasses/pie/), bÄ™dziesz musiaÅ‚ to obejÅ›Ä‡.
* W bof z [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), bÄ™dziesz musiaÅ‚ to obejÅ›Ä‡.
* JeÅ›li musisz ustawiÄ‡ kilka parametrÃ³w, aby poprawnie wywoÅ‚aÄ‡ funkcjÄ™ **ret2win**, moÅ¼esz uÅ¼yÄ‡:
* ÅaÅ„cucha [**ROP**](./#rop-and-ret2...-techniques) **jeÅ›li jest wystarczajÄ…co duÅ¼o gadÅ¼etÃ³w**, aby przygotowaÄ‡ wszystkie parametry.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (w przypadku, gdy moÅ¼esz wywoÅ‚aÄ‡ ten syscall) do kontrolowania wielu rejestrÃ³w.
* GadÅ¼etÃ³w z [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) do kontrolowania kilku rejestrÃ³w.
* Poprzez [**Write What Where**](../arbitrary-write-2-exec/) moÅ¼esz naduÅ¼yÄ‡ innych luk (nie bof), aby wywoÅ‚aÄ‡ funkcjÄ™ **`win`**.
* [**Przekierowywanie WskaÅºnikÃ³w**](../stack-overflow/pointer-redirecting.md): W przypadku, gdy stos zawiera wskaÅºniki do funkcji, ktÃ³ra ma byÄ‡ wywoÅ‚ana lub do ciÄ…gu, ktÃ³ry ma byÄ‡ uÅ¼yty przez interesujÄ…cÄ… funkcjÄ™ (system lub printf), moÅ¼liwe jest nadpisanie tego adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/) mogÄ… wpÅ‚ywaÄ‡ na adresy.
* [**Niezainicjowane zmienne**](../stack-overflow/uninitialized-variables.md): Nigdy nie wiesz.

### Cel: RCE

#### Poprzez shellcode, jeÅ›li nx wyÅ‚Ä…czone lub mieszajÄ…c shellcode z ROP:

* [**(Stos) Shellcode**](./#stack-shellcode): To jest przydatne do przechowywania shellcode na stosie przed lub po nadpisaniu wskaÅºnika powrotu, a nastÄ™pnie **skoczyÄ‡ do niego**, aby go wykonaÄ‡:
* **W kaÅ¼dym przypadku, jeÅ›li istnieje** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** w zwykÅ‚ym bof bÄ™dziesz musiaÅ‚ to obejÅ›Ä‡ (leak).
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) moÅ¼liwe jest skoczenie do adresu stosu, poniewaÅ¼ nigdy siÄ™ nie zmieni.
* **Z** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) bÄ™dziesz potrzebowaÄ‡ technik takich jak [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md), aby do niego skoczyÄ‡.
* **Z** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), bÄ™dziesz musiaÅ‚ uÅ¼yÄ‡ [**ROP**](../rop-return-oriented-programing/), **aby wywoÅ‚aÄ‡ `memprotect`** i ustawiÄ‡ stronÄ™ `rwx`, aby nastÄ™pnie **przechowaÄ‡ shellcode tam** (wywoÅ‚ujÄ…c read na przykÅ‚ad) i nastÄ™pnie skoczyÄ‡ tam.
* To poÅ‚Ä…czy shellcode z Å‚aÅ„cuchem ROP.

#### Poprzez syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): Przydatne do wywoÅ‚ania `execve`, aby uruchomiÄ‡ arbitralne polecenia. Musisz byÄ‡ w stanie znaleÅºÄ‡ **gadÅ¼ety do wywoÅ‚ania konkretnego syscall z parametrami**.
* JeÅ›li [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/) sÄ… wÅ‚Ä…czone, bÄ™dziesz musiaÅ‚ je pokonaÄ‡ **w celu uÅ¼ycia gadÅ¼etÃ³w ROP** z binarnego lub bibliotek.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) moÅ¼e byÄ‡ przydatne do przygotowania **ret2execve**.
* GadÅ¼ety z [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) do kontrolowania kilku rejestrÃ³w.

#### Poprzez libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): Przydatne do wywoÅ‚ania funkcji z biblioteki (zwykle z **`libc`**) jak **`system`** z pewnymi przygotowanymi argumentami (np. `'/bin/sh'`). Musisz, aby binarny **zaÅ‚adowaÅ‚ bibliotekÄ™** z funkcjÄ…, ktÃ³rÄ… chciaÅ‚byÅ› wywoÅ‚aÄ‡ (zwykle libc).
* JeÅ›li **skompilowane statycznie i bez** [**PIE**](../common-binary-protections-and-bypasses/pie/), **adres** `system` i `/bin/sh` nie bÄ™dÄ… siÄ™ zmieniaÄ‡, wiÄ™c moÅ¼liwe jest ich uÅ¼ycie statycznie.
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i znajÄ…c wersjÄ™ libc** zaÅ‚adowanÄ…, **adres** `system` i `/bin/sh` nie bÄ™dÄ… siÄ™ zmieniaÄ‡, wiÄ™c moÅ¼liwe jest ich uÅ¼ycie statycznie.
* Z [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **ale bez** [**PIE**](../common-binary-protections-and-bypasses/pie/)**, znajÄ…c libc i z binarnym uÅ¼ywajÄ…cym funkcji `system`**, moÅ¼liwe jest **`ret` do adresu system w GOT** z adresem `'/bin/sh'` w parametrze (musisz to ustaliÄ‡).
* Z [ASLR](../common-binary-protections-and-bypasses/aslr/) ale bez [PIE](../common-binary-protections-and-bypasses/pie/), znajÄ…c libc i **bez binarnego uÅ¼ywajÄ…cego `system`**:
* UÅ¼yj [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md), aby rozwiÄ…zaÄ‡ adres `system` i go wywoÅ‚aÄ‡.
* **ObejdÅº** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) i oblicz adres `system` i `'/bin/sh'` w pamiÄ™ci.
* **Z** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i nie znajÄ…c libc**: Musisz:
* ObejÅ›Ä‡ [**PIE**](../common-binary-protections-and-bypasses/pie/).
* ZnaleÅºÄ‡ **wersjÄ™ `libc`** uÅ¼ywanÄ… (leak kilka adresÃ³w funkcji).
* SprawdziÄ‡ **poprzednie scenariusze z ASLR**, aby kontynuowaÄ‡.

#### Poprzez EBP/RBP

* [**Pivotowanie Stosu / EBP2Ret / ÅaÅ„cuchowanie EBP**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Kontroluj ESP, aby kontrolowaÄ‡ RET poprzez przechowywane EBP na stosie.
* Przydatne dla **przepeÅ‚nieÅ„ stosu off-by-one**.
* Przydatne jako alternatywny sposÃ³b na kontrolowanie EIP, naduÅ¼ywajÄ…c EIP do skonstruowania Å‚adunku w pamiÄ™ci, a nastÄ™pnie skaczÄ…c do niego poprzez EBP.

#### RÃ³Å¼ne

* [**Przekierowywanie WskaÅºnikÃ³w**](../stack-overflow/pointer-redirecting.md): W przypadku, gdy stos zawiera wskaÅºniki do funkcji, ktÃ³ra ma byÄ‡ wywoÅ‚ana lub do ciÄ…gu, ktÃ³ry ma byÄ‡ uÅ¼yty przez interesujÄ…cÄ… funkcjÄ™ (system lub printf), moÅ¼liwe jest nadpisanie tego adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) lub [**PIE**](../common-binary-protections-and-bypasses/pie/) mogÄ… wpÅ‚ywaÄ‡ na adresy.
* [**Niezainicjowane zmienne**](../stack-overflow/uninitialized-variables.md): Nigdy nie wiesz.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}
