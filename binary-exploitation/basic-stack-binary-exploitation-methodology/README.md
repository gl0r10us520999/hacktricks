# 基本的なバイナリエクスプロイト手法

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}

## ELF基本情報

何かをエクスプロイトする前に、**ELFバイナリ**の構造の一部を理解することが興味深いです：

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## エクスプロイトツール

{% content-ref url="tools/" %}
[tools](tools/)
{% endcontent-ref %}

## スタックオーバーフロー手法

多くの技術があるため、各技術がどのように役立つかのスキームを持つことが良いです。同じ保護が異なる技術に影響を与えることに注意してください。各保護セクションで保護を回避する方法を見つけることができますが、この手法ではありません。

## フローの制御

プログラムのフローを制御する方法はいくつかあります：

* [**スタックオーバーフロー**](../stack-overflow/)によってスタックからのリターンポインタまたはEBP -> ESP -> EIPを上書きする。
* オーバーフローを引き起こすために[**整数オーバーフロー**](../integer-overflow.md)を悪用する必要があるかもしれません。
* または**任意の書き込み + 実行への書き込み**。
* [**フォーマット文字列**](../format-strings/)**:** `printf`を悪用して任意の内容を任意のアドレスに書き込む。
* [**配列インデックス**](../array-indexing.md)：不適切に設計されたインデックスを悪用して、いくつかの配列を制御し、任意の書き込みを取得する。
* オーバーフローを引き起こすために[**整数オーバーフロー**](../integer-overflow.md)を悪用する必要があるかもしれません。
* **bofからWWWへのROP**：バッファオーバーフローを悪用してROPを構築し、WWWを取得できるようにします。

**実行への書き込み**技術は以下で見つけることができます：

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## 永続ループ

考慮すべきことは、通常**脆弱性の1回のエクスプロイトだけでは**成功したエクスプロイトを実行するには不十分であることです。特にいくつかの保護を回避する必要があります。したがって、**単一の脆弱性を同じバイナリの実行中に複数回エクスプロイト可能にする**いくつかのオプションを議論することが興味深いです：

* **`main`関数**のアドレスまたは**脆弱性**が発生しているアドレスをROPチェーンに書き込む。
* 適切なROPチェーンを制御することで、そのチェーン内のすべてのアクションを実行できるかもしれません。
* **`exit`のGOT内のアドレス**（またはバイナリが終了する前に使用する他の関数）に**脆弱性に戻る**アドレスを書き込む。
* [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**で説明されているように、ここに2つの関数を格納し、1つは再度脆弱性を呼び出し、もう1つは**`__libc_csu_fini`**を呼び出して再度`.fini_array`の関数を呼び出します。

## エクスプロイトの目標

### 目標：既存の関数を呼び出す

* [**ret2win**](./#ret2win)：フラグを取得するために呼び出す必要があるコード内の関数（特定のパラメータで呼び出す必要があるかもしれません）。
* **PIE**がない通常のbofでは、スタックに保存されたリターンアドレスにアドレスを書き込むだけで済みます。
* [**PIE**](../common-binary-protections-and-bypasses/pie/)があるbofでは、それを回避する必要があります。
* [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)があるbofでは、それを回避する必要があります。
* **ret2win**関数を正しく呼び出すために複数のパラメータを設定する必要がある場合は、次のようにできます：
* すべてのパラメータを準備するのに十分なガジェットがある場合は、[**ROP**](./#rop-and-ret2...-techniques)チェーンを使用します。
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/)（このシステムコールを呼び出せる場合）を使用して多くのレジスタを制御します。
* [**ret2csu**](../rop-return-oriented-programing/ret2csu.md)および[**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md)のガジェットを使用して複数のレジスタを制御します。
* [**Write What Where**](../arbitrary-write-2-exec/)を介して、他の脆弱性（bofではない）を悪用して**`win`**関数を呼び出すことができます。
* [**ポインタのリダイレクト**](../stack-overflow/pointer-redirecting.md)：スタックに呼び出される関数へのポインタや、興味のある関数（systemまたはprintf）で使用される文字列へのポインタが含まれている場合、そのアドレスを上書きすることが可能です。
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)または[**PIE**](../common-binary-protections-and-bypasses/pie/)がアドレスに影響を与える可能性があります。
* [**未初期化変数**](../stack-overflow/uninitialized-variables.md)：あなたは決してわかりません。

### 目標：RCE

#### シェルコード経由、nxが無効な場合またはシェルコードとROPを混合する場合：

* [**(スタック)シェルコード**](./#stack-shellcode)：これは、リターンポインタを上書きする前または後にスタックにシェルコードを格納し、次に**それにジャンプして**実行するのに役立ちます：
* **いかなる場合でも、** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**がある場合、通常のbofではそれを回避する必要があります（漏洩）**
* **ASLR**がない場合、**nx**がない場合、スタックのアドレスにジャンプすることが可能です。なぜなら、それは決して変わらないからです。
* **ASLR**がある場合、[**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md)のような技術を使用してそこにジャンプする必要があります。
* **nx**がある場合、いくつかの[**ROP**](../rop-return-oriented-programing/)を使用して`memprotect`を呼び出し、ページを`rwx`にする必要があります。その後、シェルコードをそこに格納し（例えばreadを呼び出す）、そこにジャンプします。
* これはシェルコードとROPチェーンを混合します。

#### システムコール経由

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): 任意のコマンドを実行するために`execve`を呼び出すのに役立ちます。**特定のシステムコールをパラメータで呼び出すためのガジェットを見つける必要があります**。
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)または[**PIE**](../common-binary-protections-and-bypasses/pie/)が有効な場合、バイナリまたはライブラリからROPガジェットを使用するためにそれらを打破する必要があります。
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/)は**ret2execve**を準備するのに役立ちます。
* [**ret2csu**](../rop-return-oriented-programing/ret2csu.md)および[**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md)のガジェットを使用して複数のレジスタを制御します。

#### libc経由

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): **`libc`**からの関数（通常は**`system`**）を呼び出すのに役立ちます。準備された引数（例：`'/bin/sh'`）を使用します。呼び出したい関数を持つライブラリを**バイナリがロードする必要があります**（通常はlibc）。
* **静的にコンパイルされていて、** [**PIE**](../common-binary-protections-and-bypasses/pie/)がない場合、`system`と`/bin/sh`の**アドレス**は変わらないため、静的に使用することが可能です。
* **ASLR**がない場合、**libcのバージョン**を知っている場合、`system`と`/bin/sh`の**アドレス**は変わらないため、静的に使用することが可能です。
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)があるが[**PIE**](../common-binary-protections-and-bypasses/pie/)がない場合、libcを知っていて、バイナリが`system`**関数を使用している場合、**GOT内のsystemのアドレスに`ret`し、`'/bin/sh'`のアドレスをパラメータにすることが可能です（これを解決する必要があります）。
* [ASLR](../common-binary-protections-and-bypasses/aslr/)があり[PIE](../common-binary-protections-and-bypasses/pie/)がないが、libcを知っていて**バイナリが`system`を使用していない場合**：
* [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md)を使用して`system`のアドレスを解決し、呼び出します。
* **ASLR**を回避し、メモリ内の`system`と`'/bin/sh'`のアドレスを計算します。
* **ASLR**と[**PIE**](../common-binary-protections-and-bypasses/pie/)があり、libcを知らない場合：次のことを行う必要があります：
* [**PIE**](../common-binary-protections-and-bypasses/pie/)を回避します。
* 使用されている**`libc`バージョン**を見つけます（いくつかの関数アドレスを漏洩させます）。
* 続行するために**ASLR**を使用した前のシナリオを確認します。

#### EBP/RBP経由

* [**スタックピボット/EBP2Ret/EBPチェイニング**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md)：スタック内の保存されたEBPを通じてRETを制御するためにESPを制御します。
* **オフバイワン**スタックオーバーフローに役立ちます。
* EIPを制御しながら、メモリ内にペイロードを構築し、次にEBPを介してそれにジャンプするための代替手段として役立ちます。

#### その他

* [**ポインタのリダイレクト**](../stack-overflow/pointer-redirecting.md)：スタックに呼び出される関数へのポインタや、興味のある関数（systemまたはprintf）で使用される文字列へのポインタが含まれている場合、そのアドレスを上書きすることが可能です。
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)または[**PIE**](../common-binary-protections-and-bypasses/pie/)がアドレスに影響を与える可能性があります。
* [**未初期化変数**](../stack-overflow/uninitialized-variables.md)：あなたは決してわかりません。

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してハッキングトリックを共有してください。**

</details>
{% endhint %}
