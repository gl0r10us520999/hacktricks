# Metodolog铆a B谩sica de Explotaci贸n Binaria

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Informaci贸n B谩sica de ELF

Antes de comenzar a explotar cualquier cosa, es interesante entender parte de la estructura de un **binario ELF**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Herramientas de Explotaci贸n

{% content-ref url="tools/" %}
[tools](tools/)
{% endcontent-ref %}

## Metodolog铆a de Desbordamiento de Pila

Con tantas t茅cnicas, es bueno tener un esquema de cu谩ndo cada t茅cnica ser谩 煤til. Ten en cuenta que las mismas protecciones afectar谩n diferentes t茅cnicas. Puedes encontrar formas de eludir las protecciones en cada secci贸n de protecci贸n, pero no en esta metodolog铆a.

## Controlando el Flujo

Hay diferentes formas en las que podr铆as terminar controlando el flujo de un programa:

* [**Desbordamientos de Pila**](../stack-overflow/) sobrescribiendo el puntero de retorno desde la pila o el EBP -> ESP -> EIP.
* Podr铆a ser necesario abusar de un [**Desbordamiento de Entero**](../integer-overflow.md) para causar el desbordamiento.
* O a trav茅s de **Escrituras Arbitrarias + Escribir Qu茅 D贸nde para Ejecuci贸n**.
* [**Cadenas de Formato**](../format-strings/)**:** Abusar de `printf` para escribir contenido arbitrario en direcciones arbitrarias.
* [**Indexaci贸n de Arreglos**](../array-indexing.md): Abusar de una indexaci贸n mal dise帽ada para poder controlar algunos arreglos y obtener una escritura arbitraria.
* Podr铆a ser necesario abusar de un [**Desbordamiento de Entero**](../integer-overflow.md) para causar el desbordamiento.
* **bof a WWW a trav茅s de ROP**: Abusar de un desbordamiento de b煤fer para construir un ROP y poder obtener un WWW.

Puedes encontrar las t茅cnicas de **Escribir Qu茅 D贸nde para Ejecuci贸n** en:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Bucles Eternos

Algo a tener en cuenta es que generalmente **solo una explotaci贸n de una vulnerabilidad puede no ser suficiente** para ejecutar un exploit exitoso, especialmente algunas protecciones necesitan ser eludidas. Por lo tanto, es interesante discutir algunas opciones para **hacer que una sola vulnerabilidad sea explotable varias veces** en la misma ejecuci贸n del binario:

* Escribir en una **cadena ROP** la direcci贸n de la **funci贸n `main`** o la direcci贸n donde est谩 ocurriendo la **vulnerabilidad**.
* Controlando una cadena ROP adecuada, podr铆as ser capaz de realizar todas las acciones en esa cadena.
* Escribir en la **direcci贸n `exit` en GOT** (o cualquier otra funci贸n utilizada por el binario antes de finalizar) la direcci贸n para **volver a la vulnerabilidad**.
* Como se explic贸 en [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** almacenar 2 funciones aqu铆, una para llamar a la vulnerabilidad nuevamente y otra para llamar a **`__libc_csu_fini`** que volver谩 a llamar a la funci贸n de `.fini_array`.

## Objetivos de Explotaci贸n

### Objetivo: Llamar a una Funci贸n Existente

* [**ret2win**](./#ret2win): Hay una funci贸n en el c贸digo que necesitas llamar (quiz谩s con algunos par谩metros espec铆ficos) para obtener la bandera.
* En un **bof regular sin** [**PIE**](../common-binary-protections-and-bypasses/pie/) **y** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/) solo necesitas escribir la direcci贸n en la direcci贸n de retorno almacenada en la pila.
* En un bof con [**PIE**](../common-binary-protections-and-bypasses/pie/), necesitar谩s eludirlo.
* En un bof con [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), necesitar谩s eludirlo.
* Si necesitas establecer varios par谩metros para llamar correctamente a la funci贸n **ret2win**, puedes usar:
* Una cadena [**ROP**](./#rop-and-ret2...-techniques) **si hay suficientes gadgets** para preparar todos los par谩metros.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (en caso de que puedas llamar a esta syscall) para controlar muchos registros.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) y [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar varios registros.
* A trav茅s de un [**Escribir Qu茅 D贸nde**](../arbitrary-write-2-exec/) podr铆as abusar de otras vulnerabilidades (no bof) para llamar a la funci贸n **`win`**.
* [**Redireccionamiento de Punteros**](../stack-overflow/pointer-redirecting.md): En caso de que la pila contenga punteros a una funci贸n que se va a llamar o a una cadena que se va a usar por una funci贸n interesante (system o printf), es posible sobrescribir esa direcci贸n.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/) pueden afectar las direcciones.
* [**Variables No Inicializadas**](../stack-overflow/uninitialized-variables.md): Nunca se sabe.

### Objetivo: RCE

#### A trav茅s de shellcode, si nx est谩 deshabilitado o mezclando shellcode con ROP:

* [**(Stack) Shellcode**](./#stack-shellcode): Esto es 煤til para almacenar un shellcode en la pila antes o despu茅s de sobrescribir el puntero de retorno y luego **saltar a 茅l** para ejecutarlo:
* **En cualquier caso, si hay un** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** en un bof regular necesitar谩s eludirlo (leak).
* **Sin** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) es posible saltar a la direcci贸n de la pila ya que nunca cambiar谩.
* **Con** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) necesitar谩s t茅cnicas como [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) para saltar a ella.
* **Con** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), necesitar谩s usar alg煤n [**ROP**](../rop-return-oriented-programing/) **para llamar a `memprotect`** y hacer que alguna p谩gina sea `rwx`, para luego **almacenar el shellcode all铆** (llamando a read por ejemplo) y luego saltar all铆.
* Esto mezclar谩 shellcode con una cadena ROP.

#### A trav茅s de syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): til para llamar a `execve` para ejecutar comandos arbitrarios. Necesitas ser capaz de encontrar los **gadgets para llamar a la syscall espec铆fica con los par谩metros**.
* Si [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/) est谩n habilitados, necesitar谩s derrotarlos **para usar gadgets ROP** del binario o bibliotecas.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) puede ser 煤til para preparar el **ret2execve**.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) y [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar varios registros.

#### A trav茅s de libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): til para llamar a una funci贸n de una biblioteca (generalmente de **`libc`**) como **`system`** con algunos argumentos preparados (por ejemplo, `'/bin/sh'`). Necesitas que el binario **cargue la biblioteca** con la funci贸n que te gustar铆a llamar (libc generalmente).
* Si **compilado est谩ticamente y sin** [**PIE**](../common-binary-protections-and-bypasses/pie/), la **direcci贸n** de `system` y `/bin/sh` no van a cambiar, por lo que es posible usarlas est谩ticamente.
* **Sin** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y conociendo la versi贸n de libc** cargada, la **direcci贸n** de `system` y `/bin/sh` no van a cambiar, por lo que es posible usarlas est谩ticamente.
* Con [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **pero sin** [**PIE**](../common-binary-protections-and-bypasses/pie/)**, conociendo la libc y con el binario usando la funci贸n `system`** es posible **`ret` a la direcci贸n de system en el GOT** con la direcci贸n de `'/bin/sh'` en el par谩metro (necesitar谩s averiguarlo).
* Con [ASLR](../common-binary-protections-and-bypasses/aslr/) pero sin [PIE](../common-binary-protections-and-bypasses/pie/), conociendo la libc y **sin que el binario use la `system`**:
* Usa [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) para resolver la direcci贸n de `system` y llamarla.
* **Eludir** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) y calcular la direcci贸n de `system` y `'/bin/sh'` en memoria.
* **Con** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y** [**PIE**](../common-binary-protections-and-bypasses/pie/) **y sin conocer la libc**: Necesitas:
* Eludir [**PIE**](../common-binary-protections-and-bypasses/pie/).
* Encontrar la **versi贸n de `libc`** utilizada (filtrar un par de direcciones de funciones).
* Revisar los **escenarios anteriores con ASLR** para continuar.

#### A trav茅s de EBP/RBP

* [**Pivotar la Pila / EBP2Ret / Encadenamiento de EBP**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Controlar el ESP para controlar RET a trav茅s del EBP almacenado en la pila.
* til para **desbordamientos de pila off-by-one**.
* til como una forma alternativa de terminar controlando EIP mientras se abusa de EIP para construir la carga 煤til en memoria y luego saltar a ella a trav茅s de EBP.

#### Varios

* [**Redireccionamiento de Punteros**](../stack-overflow/pointer-redirecting.md): En caso de que la pila contenga punteros a una funci贸n que se va a llamar o a una cadena que se va a usar por una funci贸n interesante (system o printf), es posible sobrescribir esa direcci贸n.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/) pueden afectar las direcciones.
* [**Variables No Inicializadas**](../stack-overflow/uninitialized-variables.md): Nunca se sabe.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
