# M√©thodologie de Base pour l'Exploitation Binaire

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supportez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Informations de Base sur ELF

Avant de commencer √† exploiter quoi que ce soit, il est int√©ressant de comprendre une partie de la structure d'un **binaire ELF** :

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Outils d'Exploitation

{% content-ref url="tools/" %}
[tools](tools/)
{% endcontent-ref %}

## M√©thodologie de D√©bordement de Pile

Avec tant de techniques, il est bon d'avoir un sch√©ma pour savoir quand chaque technique sera utile. Notez que les m√™mes protections affecteront diff√©rentes techniques. Vous pouvez trouver des moyens de contourner les protections dans chaque section de protection, mais pas dans cette m√©thodologie.

## Contr√¥le du Flux

Il existe diff√©rentes mani√®res de contr√¥ler le flux d'un programme :

* [**D√©bordements de Pile**](../stack-overflow/) en √©crasant le pointeur de retour de la pile ou le EBP -> ESP -> EIP.
* Peut n√©cessiter d'abuser d'un [**D√©bordement d'Entier**](../integer-overflow.md) pour provoquer le d√©bordement.
* Ou via **√âcritures Arbitraires + √âcrire Quoi O√π pour l'Ex√©cution**.
* [**Cha√Ænes de Format**](../format-strings/)**:** Abuser de `printf` pour √©crire du contenu arbitraire √† des adresses arbitraires.
* [**Indexation de Tableaux**](../array-indexing.md) : Abuser d'une indexation mal con√ßue pour pouvoir contr√¥ler certains tableaux et obtenir une √©criture arbitraire.
* Peut n√©cessiter d'abuser d'un [**D√©bordement d'Entier**](../integer-overflow.md) pour provoquer le d√©bordement.
* **bof √† WWW via ROP** : Abuser d'un d√©bordement de tampon pour construire un ROP et pouvoir obtenir un WWW.

Vous pouvez trouver les techniques **√âcrire Quoi O√π pour l'Ex√©cution** dans :

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Boucles √âternelles

Un point √† prendre en compte est que g√©n√©ralement **une seule exploitation d'une vuln√©rabilit√© peut ne pas suffire** √† ex√©cuter un exploit r√©ussi, surtout certaines protections doivent √™tre contourn√©es. Par cons√©quent, il est int√©ressant de discuter de certaines options pour **rendre une seule vuln√©rabilit√© exploitable plusieurs fois** dans la m√™me ex√©cution du binaire :

* √âcrire dans une cha√Æne **ROP** l'adresse de la **fonction `main`** ou l'adresse o√π la **vuln√©rabilit√©** se produit.
* En contr√¥lant une cha√Æne ROP appropri√©e, vous pourriez √™tre en mesure d'effectuer toutes les actions dans cette cha√Æne.
* √âcrire √† l'adresse **`exit` dans GOT** (ou toute autre fonction utilis√©e par le binaire avant de se terminer) l'adresse pour **revenir √† la vuln√©rabilit√©**.
* Comme expliqu√© dans [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini_array.md#eternal-loop)**,** stocker 2 fonctions ici, une pour rappeler la vuln√©rabilit√© et une autre pour appeler **`__libc_csu_fini`** qui rappellera √† nouveau la fonction de `.fini_array`.

## Objectifs d'Exploitation

### Objectif : Appeler une Fonction Existante

* [**ret2win**](./#ret2win) : Il y a une fonction dans le code que vous devez appeler (peut-√™tre avec des param√®tres sp√©cifiques) afin d'obtenir le drapeau.
* Dans un **bof r√©gulier sans** [**PIE**](../common-binary-protections-and-bypasses/pie/) **et** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), vous devez simplement √©crire l'adresse dans l'adresse de retour stock√©e dans la pile.
* Dans un bof avec [**PIE**](../common-binary-protections-and-bypasses/pie/), vous devrez le contourner.
* Dans un bof avec [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), vous devrez le contourner.
* Si vous devez d√©finir plusieurs param√®tres pour appeler correctement la fonction **ret2win**, vous pouvez utiliser :
* Une cha√Æne [**ROP**](./#rop-and-ret2...-techniques) **s'il y a suffisamment de gadgets** pour pr√©parer tous les param√®tres.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (au cas o√π vous pourriez appeler cet appel syst√®me) pour contr√¥ler beaucoup de registres.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) et [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) pour contr√¥ler plusieurs registres.
* Via un [**√âcrire Quoi O√π**](../arbitrary-write-2-exec/), vous pourriez abuser d'autres vuln√©rabilit√©s (pas bof) pour appeler la fonction **`win`**.
* [**Redirection de Pointeurs**](../stack-overflow/pointer-redirecting.md) : Dans le cas o√π la pile contient des pointeurs vers une fonction qui va √™tre appel√©e ou vers une cha√Æne qui va √™tre utilis√©e par une fonction int√©ressante (syst√®me ou printf), il est possible d'√©craser cette adresse.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) peuvent affecter les adresses.
* [**Variables Non Initialis√©es**](../stack-overflow/uninitialized-variables.md) : On ne sait jamais.

### Objectif : RCE

#### Via shellcode, si nx d√©sactiv√© ou m√©langeant shellcode avec ROP :

* [**(Stack) Shellcode**](./#stack-shellcode) : Cela est utile pour stocker un shellcode dans la pile avant ou apr√®s avoir √©cras√© le pointeur de retour et ensuite **sauter vers lui** pour l'ex√©cuter :
* **Dans tous les cas, s'il y a un** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** dans un bof r√©gulier, vous devrez le contourner (leak).
* **Sans** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), il est possible de sauter √† l'adresse de la pile car elle ne changera jamais.
* **Avec** [**ASLR**](../common-binary-protections-and-bypasses/aslr/), vous aurez besoin de techniques telles que [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) pour y sauter.
* **Avec** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), vous devrez utiliser certains [**ROP**](../rop-return-oriented-programing/) **pour appeler `memprotect`** et rendre une page `rwx`, afin de pouvoir ensuite **stocker le shellcode l√†-dedans** (en appelant read par exemple) et ensuite sauter l√†-bas.
* Cela m√©langera le shellcode avec une cha√Æne ROP.

#### Via des appels syst√®me

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/) : Utile pour appeler `execve` pour ex√©cuter des commandes arbitraires. Vous devez √™tre capable de trouver les **gadgets pour appeler l'appel syst√®me sp√©cifique avec les param√®tres**.
* Si [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) sont activ√©s, vous devrez les contourner **afin d'utiliser les gadgets ROP** du binaire ou des biblioth√®ques.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) peut √™tre utile pour pr√©parer le **ret2execve**.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) et [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) pour contr√¥ler plusieurs registres.

#### Via libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/) : Utile pour appeler une fonction d'une biblioth√®que (g√©n√©ralement de **`libc`**) comme **`system`** avec des arguments pr√©par√©s (par exemple, `'/bin/sh'`). Vous avez besoin que le binaire **charge la biblioth√®que** avec la fonction que vous souhaitez appeler (libc g√©n√©ralement).
* Si **compil√© statiquement et sans** [**PIE**](../common-binary-protections-and-bypasses/pie/), l'**adresse** de `system` et `/bin/sh` ne changera pas, donc il est possible de les utiliser statiquement.
* **Sans** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et en connaissant la version de libc** charg√©e, l'**adresse** de `system` et `/bin/sh` ne changera pas, donc il est possible de les utiliser statiquement.
* Avec [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **mais sans** [**PIE**](../common-binary-protections-and-bypasses/pie/)**, en connaissant la libc et avec le binaire utilisant la fonction `system`**, il est possible de **`ret` √† l'adresse de system dans le GOT** avec l'adresse de `'/bin/sh'` dans le param√®tre (vous devrez le d√©couvrir).
* Avec [ASLR](../common-binary-protections-and-bypasses/aslr/) mais sans [PIE](../common-binary-protections-and-bypasses/pie/), en connaissant la libc et **sans que le binaire utilise la `system`** :
* Utilisez [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) pour r√©soudre l'adresse de `system` et l'appeler.
* **Contourner** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) et calculer l'adresse de `system` et `'/bin/sh'` en m√©moire.
* **Avec** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **et** [**PIE**](../common-binary-protections-and-bypasses/pie/) **et sans conna√Ætre la libc** : Vous devez :
* Contourner [**PIE**](../common-binary-protections-and-bypasses/pie/).
* Trouver la **version de `libc`** utilis√©e (leak quelques adresses de fonction).
* V√©rifier les **sc√©narios pr√©c√©dents avec ASLR** pour continuer.

#### Via EBP/RBP

* [**Pivotement de Pile / EBP2Ret / Cha√Ænage EBP**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md) : Contr√¥ler l'ESP pour contr√¥ler RET via le EBP stock√© dans la pile.
* Utile pour les **d√©bordements de pile off-by-one**.
* Utile comme une alternative pour finir par contr√¥ler EIP tout en abusant d'EIP pour construire la charge utile en m√©moire et ensuite sauter vers elle via EBP.

#### Divers

* [**Redirection de Pointeurs**](../stack-overflow/pointer-redirecting.md) : Dans le cas o√π la pile contient des pointeurs vers une fonction qui va √™tre appel√©e ou vers une cha√Æne qui va √™tre utilis√©e par une fonction int√©ressante (syst√®me ou printf), il est possible d'√©craser cette adresse.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ou [**PIE**](../common-binary-protections-and-bypasses/pie/) peuvent affecter les adresses.
* [**Variables Non Initialis√©es**](../stack-overflow/uninitialized-variables.md) : On ne sait jamais.

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supportez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
