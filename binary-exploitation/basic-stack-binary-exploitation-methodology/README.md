# Osnovna metodologija binarnog eksploatisanja

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

## Osnovne informacije o ELF-u

Pre nego 코to po캜nete da eksploati코ete bilo 코ta, zanimljivo je razumeti deo strukture **ELF binarnog** fajla:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Alati za eksploatisanje

{% content-ref url="tools/" %}
[tools](tools/)
{% endcontent-ref %}

## Metodologija prelivanja steka

Sa toliko tehnika, dobro je imati shemu kada 캖e svaka tehnika biti korisna. Imajte na umu da 캖e iste za코tite uticati na razli캜ite tehnike. Mo쬰te prona캖i na캜ine da zaobi캠ete za코tite u svakoj sekciji za코tite, ali ne u ovoj metodologiji.

## Kontrola toka

Postoje razli캜iti na캜ini na koje mo쬰te kontrolisati tok programa:

* [**Stack Overflows**](../stack-overflow/) prepisivanjem povratne adrese iz steka ili EBP -> ESP -> EIP.
* Mo쬯a 캖e biti potrebno da zloupotrebite [**Integer Overflows**](../integer-overflow.md) da izazovete prelivanje.
* Ili putem **Arbitrary Writes + Write What Where to Execution**.
* [**Format strings**](../format-strings/)**:** Zloupotreba `printf` za pisanje proizvoljnog sadr쬬ja na proizvoljne adrese.
* [**Array Indexing**](../array-indexing.md): Zloupotreba lo코e dizajniranog indeksiranja kako biste mogli da kontroli코ete neke nizove i dobijete proizvoljno pisanje.
* Mo쬯a 캖e biti potrebno da zloupotrebite [**Integer Overflows**](../integer-overflow.md) da izazovete prelivanje.
* **bof to WWW putem ROP-a**: Zloupotreba prelivanja bafera za konstrukciju ROP-a i mogu캖nost dobijanja WWW.

Mo쬰te prona캖i tehnike **Write What Where to Execution** u:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Ve캜ne petlje

Ne코to 코to treba uzeti u obzir je da obi캜no **samo jedna eksploatacija ranjivosti mo쬯a ne캖e biti dovoljna** da se izvr코i uspe코na eksploatacija, posebno neke za코tite treba zaobi캖i. Stoga, zanimljivo je raspraviti o nekim opcijama za **u캜initi jednu ranjivost eksploatabilnom vi코e puta** u istoj izvr코noj binarnoj datoteci:

* Pisanje u **ROP** lancu adrese **`main` funkcije** ili na adresu gde se **ranjivost** de코ava.
* Kontrolisanjem odgovaraju캖eg ROP lanca mo쬯a 캖ete mo캖i da izvr코ite sve akcije u tom lancu.
* Pisanje u **`exit` adresu u GOT** (ili bilo kojoj drugoj funkciji koju koristi binarna datoteka pre zavr코etka) adrese za **povratak na ranjivost**.
* Kao 코to je obja코njeno u [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** ovde 캜uvajte 2 funkcije, jednu za ponovno pozivanje ranjivosti i drugu za pozivanje **`__libc_csu_fini`** koja 캖e ponovo pozvati funkciju iz `.fini_array`.

## Ciljevi eksploatisanja

### Cilj: Pozvati postoje캖u funkciju

* [**ret2win**](./#ret2win): Postoji funkcija u kodu koju treba pozvati (mo쬯a sa nekim specifi캜nim parametrima) kako biste dobili zastavicu.
* U **obi캜nom bof-u bez** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/) samo treba da upi코ete adresu u povratnu adresu koja je sa캜uvana u steku.
* U bof-u sa [**PIE**](../common-binary-protections-and-bypasses/pie/), mora캖ete da je zaobi캠ete.
* U bof-u sa [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), mora캖ete da je zaobi캠ete.
* Ako treba da postavite nekoliko parametara da biste ispravno pozvali funkciju **ret2win**, mo쬰te koristiti:
* [**ROP**](./#rop-and-ret2...-techniques) **lanac ako ima dovoljno gadgeta** da pripremite sve parametre.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (u slu캜aju da mo쬰te pozvati ovaj syscall) da kontroli코ete mnogo registara.
* Gadgeti iz [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) za kontrolu vi코e registara.
* Putem [**Write What Where**](../arbitrary-write-2-exec/) mogli biste zloupotrebiti druge ranjivosti (ne bof) da pozovete funkciju **`win`**.
* [**Pointers Redirecting**](../stack-overflow/pointer-redirecting.md): U slu캜aju da stek sadr쬴 pokaziva캜e na funkciju koja 캖e biti pozvana ili na string koji 캖e koristiti zanimljiva funkcija (system ili printf), mogu캖e je prepisati tu adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) mogu uticati na adrese.
* [**Neinicijalizovane promenljive**](../stack-overflow/uninitialized-variables.md): Nikad ne znate.

### Cilj: RCE

#### Putem shellcode-a, ako je nx onemogu캖en ili me코anjem shellcode-a sa ROP-om:

* [**(Stack) Shellcode**](./#stack-shellcode): Ovo je korisno za skladi코tenje shellcode-a u steku pre ili posle prepisivanja povratne adrese i zatim **skakanje na njega** da ga izvr코ite:
* **U svakom slu캜aju, ako postoji** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** u obi캜nom bof-u mora캖ete da je zaobi캠ete (leak).
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) mogu캖e je sko캜iti na adresu steka jer se nikada ne캖e promeniti.
* **Sa** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) mora캖ete koristiti tehnike kao 코to su [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) da biste sko캜ili na njega.
* **Sa** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), mora캖ete da koristite neki [**ROP**](../rop-return-oriented-programing/) **da pozovete `memprotect`** i u캜inite neku stranicu `rwx`, kako biste zatim **sa캜uvali shellcode tamo** (pozivaju캖i read na primer) i zatim sko캜ili tamo.
* Ovo 캖e pome코ati shellcode sa ROP lancem.

#### Putem syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): Korisno za pozivanje `execve` da izvr코i proizvoljne komande. Morate biti u mogu캖nosti da prona캠ete **gadgete za pozivanje specifi캜nog syscall-a sa parametrima**.
* Ako su [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) omogu캖eni, mora캖ete da ih savladate **da biste koristili ROP gadgete** iz binarne datoteke ili biblioteka.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) mo쬰 biti koristan za pripremu **ret2execve**.
* Gadgeti iz [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) i [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) za kontrolu vi코e registara.

#### Putem libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): Korisno za pozivanje funkcije iz biblioteke (obi캜no iz **`libc`**) kao 코to je **`system`** sa nekim pripremljenim argumentima (npr. `'/bin/sh'`). Potrebno je da binarna datoteka **u캜ita biblioteku** sa funkcijom koju 쬰lite da pozovete (libc obi캜no).
* Ako je **staticki kompajlirana i bez** [**PIE**](../common-binary-protections-and-bypasses/pie/), **adresa** `system` i `/bin/sh` se ne캖e menjati, tako da ih je mogu캖e koristiti stati캜ki.
* **Bez** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i znaju캖i verziju libc** koja je u캜itana, **adresa** `system` i `/bin/sh` se ne캖e menjati, tako da ih je mogu캖e koristiti stati캜ki.
* Sa [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **ali bez** [**PIE**](../common-binary-protections-and-bypasses/pie/)**, znaju캖i libc i sa binarnom datotekom koja koristi funkciju `system`** mogu캖e je **`ret` na adresu system u GOT** sa adresom `'/bin/sh'` u parametru (to 캖ete morati da otkrijete).
* Sa [ASLR](../common-binary-protections-and-bypasses/aslr/) ali bez [PIE](../common-binary-protections-and-bypasses/pie/), znaju캖i libc i **bez binarne datoteke koja koristi `system`**:
* Koristite [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) da biste re코ili adresu `system` i pozvali je.
* **Zaobi캠ite** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) i izra캜unajte adresu `system` i `'/bin/sh'` u memoriji.
* **Sa** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **i** [**PIE**](../common-binary-protections-and-bypasses/pie/) **i ne znaju캖i libc**: Morate:
* Zaobi캖i [**PIE**](../common-binary-protections-and-bypasses/pie/).
* Prona캖i **`libc` verziju** koja se koristi (leak nekoliko adresa funkcija).
* Proveriti **prethodne scenarije sa ASLR** da nastavite.

#### Putem EBP/RBP

* [**Stack Pivoting / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Kontrola ESP-a da kontroli코ete RET putem sa캜uvanog EBP-a u steku.
* Korisno za **off-by-one** prelivanja steka.
* Korisno kao alternativni na캜in da se zavr코i kontrola EIP-a dok se zloupotrebljava EIP za konstrukciju payload-a u memoriji i zatim skakanje na njega putem EBP-a.

#### Razno

* [**Pointers Redirecting**](../stack-overflow/pointer-redirecting.md): U slu캜aju da stek sadr쬴 pokaziva캜e na funkciju koja 캖e biti pozvana ili na string koji 캖e koristiti zanimljiva funkcija (system ili printf), mogu캖e je prepisati tu adresu.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ili [**PIE**](../common-binary-protections-and-bypasses/pie/) mogu uticati na adrese.
* [**Neinicijalizovane promenljive**](../stack-overflow/uninitialized-variables.md): Nikad ne znate.

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
