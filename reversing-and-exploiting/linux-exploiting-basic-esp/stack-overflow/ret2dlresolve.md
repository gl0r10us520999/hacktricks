# Ret2dlresolve

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

рдЬреИрд╕рд╛ рдХрд┐ [**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md) рдФрд░ [**Relro**](../common-binary-protections-and-bypasses/relro.md) рдХреЗ рдкреГрд╖реНрда рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдмрд┐рдирд╛ рдлреБрд▓ рд░рд┐рд▓рд░реЛ рдХреЗ рдмрд╛рдЗрдирд░реА рдкрд╣рд▓реА рдмрд╛рд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рдкрд░ рдкреНрд░рддреАрдХреЛрдВ (рдЬреИрд╕реЗ рдмрд╛рд╣рд░реА рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкрддреЗ) рдХреЛ рд╣рд▓ рдХрд░реЗрдВрдЧреАред рдпрд╣ рд╕рдорд╛рдзрд╛рди **`_dl_runtime_resolve`** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рд╣реЛрддрд╛ рд╣реИред

**`_dl_runtime_resolve`** рдлрд╝рдВрдХреНрд╢рди рд╕реНрдЯреИрдХ рд╕реЗ рдХреБрдЫ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рд╕рдВрджрд░реНрдн рд▓реЗрддрд╛ рд╣реИ рдЬрд┐рдирдХреА рдЙрд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреНрд░рддреАрдХ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдЗрд╕рд▓рд┐рдП, рд╕рднреА рдЗрди рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ **рдлреЗрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ** рддрд╛рдХрд┐ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХ рдХрд┐рдП рдЧрдП рдкреНрд░рддреАрдХ рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ (рдЬреИрд╕реЗ **`system`** рдлрд╝рдВрдХреНрд╢рди) рдФрд░ рдЗрд╕реЗ рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ (рдЬреИрд╕реЗ **`system('/bin/sh')`**).

рдЖрдорддреМрд░ рдкрд░, рд╕рднреА рдЗрди рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдПрдХ **рдкреНрд░рд╛рд░рдВрднрд┐рдХ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рдХрд░ рдлреЗрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ `read` рдХреЛ рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдореЗрдореЛрд░реА рдкрд░ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ **рд╕рдВрд░рдЪрдирд╛рдПрдБ** рдФрд░ рд╕реНрдЯреНрд░рд┐рдВрдЧ **`'/bin/sh'`** рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡реЗ рдПрдХ рдЬреНрдЮрд╛рдд рд╕реНрдерд╛рди рдкрд░ рдкрдврд╝реЗ рдЬрд╛рдПрдВ, рдФрд░ рдлрд┐рд░ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ **`_dl_runtime_resolve`** рдХреЛ `$'/bin/sh'` рдХреЗ рдкрддреЗ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░рдХреЗ рдЬрд╛рд░реА рд░рд╣рддреА рд╣реИред

{% hint style="success" %}
рдпрд╣ рддрдХрдиреАрдХ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧреА рд╣реИ рдпрджрд┐ syscall рдЧреИрдЬреЗрдЯреНрд╕ рдирд╣реАрдВ рд╣реИрдВ (рдЬреИрд╕реЗ [**ret2syscall**](rop-syscall-execv.md) рдпрд╛ [SROP](srop-sigreturn-oriented-programming.md) рдЬреИрд╕реА рддрдХрдиреАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП) рдФрд░ libc рдкрддреЗ рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдирд╣реАрдВ рд╣реИрдВред
{% endhint %}

рдЖрдк рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреЗрд╣рддрд░ рд╡реНрдпрд╛рдЦреНрдпрд╛ рджреВрд╕рд░реЗ рднрд╛рдЧ рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Structures

3 рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдлреЗрдХ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ: **`JMPREL`**, **`STRTAB`** рдФрд░ **`SYMTAB`**ред рдЖрдк [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures) рдореЗрдВ рдЗрдирдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреЗрд╣рддрд░ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## Attack Summary

1. рдХреБрдЫ рд╕реНрдерд╛рди рдкрд░ рдлреЗрдХ рд╕рдВрд░рдЪрдирд╛рдПрдБ рд▓рд┐рдЦреЗрдВ
2. рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдВ (`$rdi = &'/bin/sh'`)
3. **`_dl_runtime_resolve`** рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдкрд░ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЗ рдкрддреЗ рд╕реЗрдЯ рдХрд░реЗрдВ
4. **рдХреЙрд▓ рдХрд░реЗрдВ** `_dl_runtime_resolve`
5. **`system`** рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ `'/bin/sh'` рдХреЛ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛

## Example

рдЖрдк [**рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдБ**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **рдкреИрд╕рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЕрдВрддрд┐рдо ROP рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреА рдмрд╣реБрдд рдЕрдЪреНрдЫреА рд╡реНрдпрд╛рдЦреНрдпрд╛ рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдБ рдЕрдВрддрд┐рдо рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
## рд╕рдВрджрд░реНрдн

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
