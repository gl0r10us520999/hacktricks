# Ret2esp / Ret2reg

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ret2esp**

**рдХреНрдпреЛрдВрдХрд┐ ESP (рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░) рд╣рдореЗрд╢рд╛ рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ**, рдпрд╣ рддрдХрдиреАрдХ EIP (рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рдкреЙрдЗрдВрдЯрд░) рдХреЛ **`jmp esp`** рдпрд╛ **`call esp`** рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рдХреЗ рдкрддреЗ рд╕реЗ рдмрджрд▓рдиреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИред рдРрд╕рд╛ рдХрд░рдиреЗ рд╕реЗ, рд╢реЗрд▓рдХреЛрдб рдареАрдХ рдЙрд╕ рд╕реНрдерд╛рди рдкрд░ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдБ EIP рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЬрдм `ret` рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ ESP рдЕрдЧрд▓реЗ рдкрддреЗ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдареАрдХ рдЙрд╕реА рд╕реНрдерд╛рди рдкрд░ рд╣реИ рдЬрд╣рд╛рдБ рд╢реЗрд▓рдХреЛрдб рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред

рдпрджрд┐ **рдПрдбреНрд░реЗрд╕ рд╕реНрдкреЗрд╕ рд▓реЗрдЖрдЙрдЯ рд░реИрдВрдбрдорд╛рдЗрдЬреЗрд╢рди (ASLR)** рд╡рд┐рдВрдбреЛрдЬрд╝ рдпрд╛ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдкрд╛рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ `jmp esp` рдпрд╛ `call esp` рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, [**ASLR**](../common-binary-protections-and-bypasses/aslr/) рд╕рдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░, рдХрд┐рд╕реА рдХреЛ рдЗрди рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдХрдордЬреЛрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рднреАрддрд░ рджреЗрдЦрдирд╛ рдкрдбрд╝ рд╕рдХрддрд╛ рд╣реИ (рдФрд░ рдЖрдкрдХреЛ [**PIE**](../common-binary-protections-and-bypasses/pie/) рдХреЛ рд╣рд░рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ)ред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, EIP рднреНрд░рд╖реНрдЯрд╛рдЪрд╛рд░ рдХреЗ **рдмрд╛рдж рд╢реЗрд▓рдХреЛрдб рдХреЛ рд░рдЦрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛**, рд╕реНрдЯреИрдХ рдХреЗ рдордзреНрдп рдореЗрдВ рд░рдЦрдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рджреМрд░рд╛рди рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рд╕реА рднреА `push` рдпрд╛ `pop` рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рдиреЛрдВ рдХрд╛ рд╢реЗрд▓рдХреЛрдб рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрдХреНрд╖реЗрдк рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рд╣рд╕реНрддрдХреНрд╖реЗрдк рддрдм рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рд╢реЗрд▓рдХреЛрдб рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕реНрдЯреИрдХ рдХреЗ рдордзреНрдп рдореЗрдВ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реЛред

### рд╕реНрдерд╛рди рдХреА рдХрдореА

рдпрджрд┐ RIP рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕реНрдерд╛рди рдХреА рдХрдореА рд╣реИ (рд╢рд╛рдпрдж рдХреЗрд╡рд▓ рдХреБрдЫ рдмрд╛рдЗрдЯреНрд╕), рддреЛ рдПрдХ рдкреНрд░рд╛рд░рдВрднрд┐рдХ `jmp` рд╢реЗрд▓рдХреЛрдб рд▓рд┐рдЦреЗрдВ рдЬреИрд╕реЗ:
```armasm
sub rsp, 0x30
jmp rsp
```
рдФрд░ рд╕реНрдЯреИрдХ рдореЗрдВ рдЬрд▓реНрджреА рд╢реЗрд▓рдХреЛрдб рд▓рд┐рдЦреЗрдВред

### рдЙрджрд╛рд╣рд░рдг

рдЖрдк рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) рдкрд░ рдЕрдВрддрд┐рдо рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЗ рд╕рд╛рде рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

рдЗрд╕реА рддрд░рд╣, рдпрджрд┐ рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдЙрд╕ рдкрддреЗ рдХреЛ рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рд╢реЗрд▓рдХреЛрдб рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рддреЛ рд╣рдо **`call eax`** рдпрд╛ **`jmp eax`** рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЬрд┐рд╕реЗ **ret2eax** рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ), рдЬреЛ рд╣рдорд╛рд░реЗ рд╢реЗрд▓рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред eax рдХреА рддрд░рд╣, **рдХреЛрдИ рдЕрдиреНрдп рд░рдЬрд┐рд╕реНрдЯрд░** рдЬрд┐рд╕рдореЗрдВ рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рдкрддрд╛ рд╣реЛ, рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (**ret2reg**).

### Example

You can find an example here: [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## Protections

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): рдпрджрд┐ рд╕реНрдЯреИрдХ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдирд╣реАрдВ рд╣реИ рддреЛ рдпрд╣ рдорджрдж рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рд╣рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдХреЛ рд╕реНрдЯреИрдХ рдореЗрдВ рд░рдЦрдирд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреВрджрдирд╛ рд╣реИред
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): рдпреЗ esp рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд░рдЬрд┐рд╕реНрдЯрд░ рдкрд░ рдХреВрджрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рд░реНрджреЗрд╢ рдЦреЛрдЬрдиреЗ рдХреЛ рдХрдард┐рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред

## References

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
