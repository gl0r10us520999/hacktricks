# EBP2Ret - EBP 체이닝

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로**부터 **히어로**로 **AWS 해킹**을 배우세요!</summary>

다른 방법으로 **HackTricks**를 지원하는 방법:

* **회사가 HackTricks에 광고**되길 원하거나 **PDF로 HackTricks 다운로드**하고 싶다면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

이 기술은 **베이스 포인터 (EBP)**를 조작하여 **EBP 레지스터**와 `leave; ret` 명령어 시퀀스를 조심스럽게 사용하여 여러 함수의 실행을 연결하는 능력을 악용합니다.

**`leave`**는 기본적으로 다음을 의미합니다:
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

이 기술은 **EBP 레지스터를 변경할 수 있지만 EIP 레지스터를 직접적으로 변경할 방법이 없을 때 특히 유용**합니다. 함수가 실행을 마치면서 발생하는 동작을 활용합니다.

`fvuln`의 실행 중에 스택에 **가짜 EBP**를 주입하여 해당 위치가 셸코드 주소가 있는 메모리 영역을 가리키도록 관리한다면 (pop 작업을 고려하여 4바이트를 더한), 간접적으로 EIP를 제어할 수 있습니다. `fvuln`이 반환될 때 ESP는 이 조작된 위치로 설정되며, 이후의 `pop` 작업은 ESP를 4만큼 감소시켜 실제로는 셸코드를 가리키도록 만듭니다. `ret` 명령이 실행되면 제어가 셸코드로 전달됩니다.

#### Exploit 구성

먼저 실행 가능한 메모리의 어딘가에 **셸코드를 주입**하고 **주소를 가져오거나** 유효한 [**ONE\_GADGET**](https://github.com/david942j/one\_gadget)의 주소를 가져오거나 **`system()`의 주소 뒤에 4바이트의 쓰레기 바이트와 `"/bin/sh"`의 주소가 있는 위치를 ESP가 가리키도록**해야 합니다.

그런 다음, 패딩을 생성하고 `셸코드/one_gadget 주소 - 4`로 EBP를 **손상**시켜야 합니다. `pop` 때문에 `-4`여야 합니다. 그럼 ESP는 우리가 원하는 주소를 가리키게 되고 `ret`가 실행됩니다.

#### Off-By-One Exploit

이 기술의 특정 변형인 "Off-By-One Exploit"이 있습니다. 이는 **EBP의 가장 낮은 유효 바이트만 수정할 수 있는 경우** 사용됩니다. 이 경우 셸코드 주소를 저장하는 메모리 위치는 EBP와 처음 세 바이트를 공유해야 하므로 더 제약 조건이 있는 유사한 조작이 가능합니다.

### **EBP Chaining**

따라서 스택의 `EBP` 항목에 제어 가능한 주소를 넣고 `EIP`에 `leave; ret`의 주소를 넣으면 **`ESP`를 스택에서 제어 가능한 `EBP` 주소로 이동**할 수 있습니다.

이제 **`ESP`**가 원하는 주소를 가리키도록 제어되고 실행할 다음 명령은 `RET`입니다. 이를 악용하기 위해 제어된 ESP 위치에 다음을 배치할 수 있습니다:

- **`&(다음 가짜 EBP)`** -> `leave` 명령의 `pop ebp`로 새로운 EBP를 로드합니다.
- **`system()`** -> `ret`에 의해 호출됩니다.
- **`&(leave;ret)`** -> 시스템이 종료된 후 호출되며, ESP를 가짜 EBP로 이동시키고 다시 시작합니다.
- **`&("/bin/sh")`** -> `system`의 매개변수

이 방법을 사용하면 프로그램의 흐름을 제어하기 위해 여러 가짜 EBP를 연결할 수 있습니다.
