# EBP2Ret - EBP chaining

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する。
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出**してください。

</details>

## 基本情報

このテクニックは、**ベースポインタ（EBP）**を操作して、EBPレジスタと`leave; ret`命令シーケンスを注意深く使用して複数の関数の実行を連鎖させる能力を悪用します。

再確認ですが、**`leave`**は基本的に次の意味です：
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

このテクニックは、**EBPレジスタを変更する方法がないが、EIPレジスタを直接変更する方法がない**場合に特に有用です。関数が実行を終了する際の振る舞いを活用します。

`fvuln`の実行中に、スタックに**偽のEBP**を挿入し、そのEBPがメモリ内のシェルコードのアドレスを指すようにすることに成功すれば（`pop`操作を考慮して4バイトを追加）、間接的にEIPを制御できます。 `fvuln`がリターンすると、ESPはこの作成された場所に設定され、その後の`pop`操作によりESPが4減少し、効果的にシェルコードを指すようになります。 `ret`命令が実行されると、制御がシェルコードに移ります。

#### 攻撃構築

まず、実行可能なメモリ内のどこかに**シェルコードを挿入**し、**そのアドレスを取得**するか、有効な[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)のアドレスを取得するか、またはESPを`system()`のアドレスが続く**4つのダミーバイト**と`"/bin/sh"`のアドレスがある場所を指すようにする必要があります。

次に、パディングを作成し、EBPを`シェルコード/one_gadgetのアドレス - 4`で妥協します。これは`pop`のために`-4`である必要があります。その後、`ESP`は望ましいアドレスを指すようになり、`ret`が実行されます。

#### Off-By-One Exploit

このテクニックの特定のバリアントを「Off-By-One Exploit」と呼びます。これは、**EBPの最も重要なバイトのみを変更できる場合**に使用されます。その場合、シェルコードのアドレスを格納するメモリ位置は、最初の3バイトをEBPと共有する必要があり、より制約のある条件で同様の操作が可能になります。

### **EBP Chaining**

したがって、スタックの`EBP`エントリに制御可能なアドレスを配置し、`EIP`に`leave; ret`のアドレスを配置することで、**`ESP`をスタックから制御された`EBP`アドレスに移動**することができます。

今、**`ESP`**は望ましいアドレスを指すように制御され、次に実行される命令は`RET`です。これを悪用するために、制御されたESPの場所に次のものを配置できます：

- **`&(次の偽のEBP)`** -> `leave`命令からの`pop ebp`により新しいEBPをロード
- **`system()`** -> `ret`によって呼び出される
- **`&(leave;ret)`** -> systemが終了した後に呼び出され、ESPを偽のEBPに移動させて再開
- **`&("/bin/sh")`** -> `system`のパラメータ

基本的に、この方法でプログラムのフローを制御するために複数の偽のEBPを連鎖させることができます。

正直言って、これは[ret2lib](ret2lib/)のようなものですが、より複雑で明確な利点はないものの、いくつかのエッジケースでは興味深いかもしれません。
