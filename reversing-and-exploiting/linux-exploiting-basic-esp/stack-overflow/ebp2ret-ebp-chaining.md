# EBP2Ret - Encadenamiento de EBP

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

Esta técnica explota la capacidad de manipular el **Puntero Base (EBP)** para encadenar la ejecución de múltiples funciones mediante el uso cuidadoso del registro EBP y la secuencia de instrucciones `leave; ret`.

Como recordatorio, **`leave`** básicamente significa:
```
movl               %ebp, %esp
popl               %ebp
ret
```
Y como el **EBP está en la pila** antes del EIP, es posible controlarlo controlando la pila.

### EBP2Ret

Esta técnica es particularmente útil cuando puedes **alterar el registro EBP pero no tienes una forma directa de cambiar el registro EIP**. Aprovecha el comportamiento de las funciones cuando terminan de ejecutarse.

Si, durante la ejecución de `fvuln`, logras inyectar un **EBP falso** en la pila que apunta a un área en la memoria donde se encuentra la dirección de tu shellcode (más 4 bytes para tener en cuenta la operación `pop`), puedes controlar indirectamente el EIP. Cuando `fvuln` retorna, el ESP se establece en esta ubicación manipulada, y la operación `pop` subsiguiente disminuye el ESP en 4, haciendo que apunte efectivamente a tu shellcode. Cuando se ejecuta la instrucción `ret`, el control se transfiere a tu shellcode.

#### Construcción del Exploit

Primero necesitas **inyectar tu shellcode** en algún lugar de la memoria ejecutable y **obtener la dirección**, o obtener la dirección de un [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) válido, o hacer que el ESP apunte a un lugar con la dirección de **`system()`** seguido de **4 bytes basura** y la dirección de `"/bin/sh"`.

Luego, crea un relleno y **compromete el EBP** con la `dirección del shellcode/one_gadget - 4`. Debe ser `-4` debido al `pop`. Entonces, el `ESP` apuntará a nuestra dirección deseada y se ejecutará el `ret`.

#### Exploit de Desbordamiento por Uno

Existe una variante específica de esta técnica conocida como un "Exploit de Desbordamiento por Uno". Se utiliza cuando solo puedes **modificar el byte menos significativo del EBP**. En ese caso, la ubicación de memoria que almacena la dirección del shellcode debe compartir los tres primeros bytes con el EBP, lo que permite una manipulación similar con condiciones más restringidas.

### **Cadenas de EBP**

Por lo tanto, al colocar una dirección controlada en la entrada de `EBP` de la pila y una dirección a `leave; ret` en `EIP`, es posible **mover el `ESP` a la dirección controlada de `EBP` desde la pila**.

Ahora, el **`ESP`** está controlado apuntando a una dirección deseada y la siguiente instrucción a ejecutar es un `RET`. Para abusar de esto, es posible colocar en el lugar controlado del ESP esto:

* **`&(próximo EBP falso)`** -> Carga el nuevo EBP debido a `pop ebp` de la instrucción `leave`
* **`system()`** -> Llamado por `ret`
* **`&(leave;ret)`** -> Llamado después de que system termine, moverá ESP al EBP falso y comenzará de nuevo
* **`&("/bin/sh")`**-> Parámetro para `system`

Básicamente de esta manera es posible encadenar varios EBPs falsos para controlar el flujo del programa.

Para ser honesto, esto es como un [ret2lib](ret2lib/), pero más complejo sin un beneficio aparente, aunque podría ser interesante en algunos casos excepcionales.
