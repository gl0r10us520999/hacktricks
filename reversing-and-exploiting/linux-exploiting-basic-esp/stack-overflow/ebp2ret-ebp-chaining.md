# EBP2Ret - Ufuatiliaji wa EBP

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Mbinu hii inatumia uwezo wa kudhibiti **Msajili wa Msingi (EBP)** ili kuunganisha utekelezaji wa kazi nyingi kupitia matumizi makini ya msajili wa EBP na mfuatiliaji wa maagizo ya `leave; ret`.

Kama kumbukumbu, **`leave`** kimsingi inamaanisha:
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

Mbinu hii ni muhimu hasa unapoweza **kubadilisha kisajili cha EBP lakini huna njia moja kwa moja ya kubadilisha kisajili cha EIP**. Inatumia tabia ya kazi wakati zinaisha kutekelezwa.

Ikiwa, wakati wa utekelezaji wa `fvuln`, unaweza kuingiza **EBP bandia** kwenye stack inayoashiria eneo kwenye kumbukumbu ambapo anwani ya shellcode yako inapatikana (pamoja na byte 4 kuhesabu operesheni ya `pop`), unaweza kudhibiti EIP kwa njia isiyo ya moja kwa moja. Wakati `fvuln` inarudi, ESP inawekwa kwenye eneo lililoundwa hili, na operesheni inayofuata ya `pop` inapunguza ESP kwa 4, ikifanya iweze kuashiria shellcode yako. Wakati maagizo ya `ret` yanatekelezwa, udhibiti unahamishiwa kwa shellcode yako.

#### Ujenzi wa Shambulizi

Kwanza unahitaji **kuingiza shellcode yako** mahali popote kwenye kumbukumbu inayoweza kutekelezwa na **pata anwani**, au pata anwani ya [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) halali, au fanya ESP iashirie mahali na anwani ya **`system()`** ikifuatiwa na **byte 4 za taka** na anwani ya `"/bin/sh"`.

Kisha, tengeneza padding na **dhoofisha EBP** na `anwani ya shellcode/one_gadget - 4`. Lazima iwe `-4` kwa sababu ya `pop`. Kisha, ESP itakuwa ikiashiria anwani tunayotaka na `ret` itatekelezwa.

#### Shambulizi la Off-By-One

Kuna toleo maalum la mbinu hii inayojulikana kama "Shambulizi la Off-By-One". Inatumika unapoweza **kubadilisha byte ya kima cha chini kabisa cha EBP**. Katika kesi kama hiyo, eneo la kumbukumbu linalohifadhi anwani ya shellcode lazima iwe na byte tatu za kwanza na EBP, kuruhusu udanganyifu sawa na hali zilizozuiwa zaidi.

### **EBP Chaining**

Hivyo, kwa kuweka anwani inayodhibitiwa kwenye kuingia ya `EBP` ya stack na anwani ya `leave; ret` katika `EIP`, inawezekana **kuhamisha `ESP` kwenye anwani iliyodhibitiwa ya `EBP` kutoka kwenye stack**.

Sasa, **`ESP`** inadhibitiwa ikiashiria anwani inayotakiwa na maagizo inayofuata ya kutekelezwa ni `RET`. Ili kutumia hili, inawezekana kuweka mahali pa ESP iliyodhibitiwa hii:

* **`&(EBP bandia inayofuata)`** -> Pakia EBP mpya kwa sababu ya `pop ebp` kutoka kwa maagizo ya `leave`
* **`system()`** -> Kuitwa na `ret`
* **`&(leave;ret)`** -> Kuitwa baada ya mfumo kumaliza, itahamisha ESP kwa EBP bandia na kuanza tena
* **`&("/bin/sh")`**-> Param kwa `system`

Kimsingi njia hii inawezesha kuunganisha EBPs bandia kadhaa kudhibiti mtiririko wa programu.

Kwa kweli, hii ni kama [ret2lib](ret2lib/), lakini ni ngumu zaidi bila faida inayoonekana lakini inaweza kuwa ya kuvutia katika hali za kipekee.
