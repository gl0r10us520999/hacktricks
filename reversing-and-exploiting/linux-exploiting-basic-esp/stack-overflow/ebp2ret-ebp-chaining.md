# EBP2Ret - EBP zincirleme

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na(https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking hilelerinizi paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

Bu teknik, **Base Pointer'ı (EBP)** manipüle etme yeteneğini kullanarak EBP kaydının dikkatli bir şekilde kullanımı ve `leave; ret` komut dizisi ile birden fazla işlevin yürütülmesini zincirleme şeklinde sömürür.

Hatırlatma olarak, **`leave`** temelde şunu ifade eder:
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

Bu teknik, **EBP kaydedicisini değiştirebilecek ancak EIP kaydedicisini doğrudan değiştiremeyecek** durumlarda özellikle kullanışlıdır. Fonksiyonların çalışmasını tamamladıklarında davranışlarını kaldırmaktadır.

`fvuln`'nin yürütülmesi sırasında, stack'e **sahte bir EBP** enjekte etmeyi başarırsanız ve bu sahte EBP, shellcode'unuzun adresinin bulunduğu bellek alanına işaret eder (pop işlemi için 4 bayt eklemek için), EIP'yi dolaylı olarak kontrol edebilirsiniz. `fvuln` geri döndüğünde, ESP bu hazırlanmış konuma ayarlanır ve ardışık `pop` işlemi ESP'yi 4 azaltarak etkili bir şekilde shellcode'unuza işaret eder. `ret` talimatı yürütüldüğünde, kontrol shellcode'unuza aktarılır.

#### Saldırı Oluşturma

İlk olarak, shellcode'unuzu yürütülebilir bir bellek alanına **enjekte etmeniz ve adresini almanız**, veya geçerli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresini almanız veya ESP'yi `system()` adresinin bulunduğu bir yere ve ardından **4 gereksiz bayt** ve `"/bin/sh"` adresi ile işaret etmesini sağlamanız gerekir.

Ardından, bir dolgu oluşturun ve EBP'yi `shellcode/one_gadget adresi - 4` ile **tehlikeye atın**. Bu `-4` olmalı çünkü `pop` işlemi nedeniyle. Sonra, ESP istediğimiz adrese işaret eder hale gelecek ve `ret` yürütülecektir.

#### Bir Fazla Bir Saldırısı

Bu tekniğin belirli bir varyantı olan "Bir Fazla Bir Saldırısı" vardır. Bu, **EBP'nin en az anlamlı baytını yalnızca değiştirebildiğinizde kullanılır**. Bu durumda, shellcode'un adresini depolayan bellek konumu, EBP ile ilk üç baytı paylaşmalıdır, daha kısıtlayıcı koşullarla benzer bir manipülasyon için izin verir.

### **EBP Zincirleme**

Bu nedenle, stack'teki `EBP` girişine kontrol edilen bir adres ve `EIP`'de `leave; ret` adresi yerleştirerek, `ESP`'yi stack'teki kontrol edilen `EBP` adresine **taşımak mümkündür**.

Şimdi, **`ESP`** istenilen bir adrese işaret eder hale gelir ve yürütülecek sonraki talimat bir `RET` olur. Bunu kötüye kullanmak için, kontrol edilen ESP yerine şunu yerleştirmek mümkündür:

* **`&(sonraki sahte EBP)`** -> `leave` talimatından `pop ebp` nedeniyle yeni EBP'yi yükleyin
* **`system()`** -> `ret` tarafından çağrılır
* **`&(leave;ret)`** -> sistem bittiğinde çağrılır, ESP'yi sahte EBP'ye taşıyacak ve yeniden başlayacak
* **`&("/bin/sh")`**-> `system` için parametre

Temelde bu şekilde programın akışını kontrol etmek için birkaç sahte EBP zincirlenmesi mümkündür.

Aslında, bu bir [ret2lib](ret2lib/) gibi, ancak açık bir fayda olmaksızın daha karmaşık olabilir ve bazı sınırlı durumlarda ilginç olabilir.
