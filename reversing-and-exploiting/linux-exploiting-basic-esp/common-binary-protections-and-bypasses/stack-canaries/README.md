# Stack Canaries

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## **StackGuard und StackShield**

**StackGuard** f√ºgt einen speziellen Wert, bekannt als **canary**, vor dem **EIP (Extended Instruction Pointer)** ein, speziell `0x000aff0d` (repr√§sentiert null, Zeilenumbruch, EOF, Wagenr√ºcklauf), um gegen Buffer√ºberl√§ufe zu sch√ºtzen. Funktionen wie `recv()`, `memcpy()`, `read()` und `bcopy()` bleiben jedoch anf√§llig, und es sch√ºtzt nicht den **EBP (Base Pointer)**.

**StackShield** verfolgt einen ausgefeilteren Ansatz als StackGuard, indem es einen **Global Return Stack** beibeh√§lt, der alle R√ºckgabewerte (**EIPs**) speichert. Diese Einrichtung stellt sicher, dass ein √úberlauf keinen Schaden anrichtet, da sie einen Vergleich zwischen gespeicherten und tats√§chlichen R√ºckgabewerten erm√∂glicht, um √úberlaufereignisse zu erkennen. Dar√ºber hinaus kann StackShield die R√ºckgabewerte mit einem Grenzwert vergleichen, um zu erkennen, ob der **EIP** au√üerhalb des erwarteten Datenraums zeigt. Diese Schutzma√ünahme kann jedoch durch Techniken wie Return-to-libc, ROP (Return-Oriented Programming) oder ret2ret umgangen werden, was darauf hinweist, dass StackShield auch keine lokalen Variablen sch√ºtzt.

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

Dieser Mechanismus platziert einen **canary** vor dem **EBP** und reorganisiert lokale Variablen, um Puffer an h√∂heren Speicheradressen zu positionieren, wodurch verhindert wird, dass sie andere Variablen √ºberschreiben. Er kopiert auch sicher die Argumente, die auf dem Stack √ºber lokalen Variablen √ºbergeben werden, und verwendet diese Kopien als Argumente. Es sch√ºtzt jedoch keine Arrays mit weniger als 8 Elementen oder Puffer innerhalb einer Benutzerstruktur.

Der **canary** ist eine Zufallszahl, die aus `/dev/urandom` oder einem Standardwert von `0xff0a0000` abgeleitet wird. Er wird in **TLS (Thread Local Storage)** gespeichert, sodass gemeinsame Speicherbereiche √ºber Threads hinweg thread-spezifische globale oder statische Variablen haben k√∂nnen. Diese Variablen werden zun√§chst vom √ºbergeordneten Prozess kopiert, und untergeordnete Prozesse k√∂nnen ihre Daten √§ndern, ohne den √ºbergeordneten oder Geschwisterprozesse zu beeinflussen. Wenn jedoch ein **`fork()` ohne Erstellen eines neuen canary verwendet wird, teilen sich alle Prozesse (Eltern und Kinder) denselben canary**, was ihn anf√§llig macht. In der **i386**-Architektur wird der canary bei `gs:0x14` gespeichert, und in **x86\_64** bei `fs:0x28`.

Dieser lokale Schutz identifiziert Funktionen mit Puffern, die anf√§llig f√ºr Angriffe sind, und injiziert Code am Anfang dieser Funktionen, um den canary zu platzieren, und am Ende, um seine Integrit√§t zu √ºberpr√ºfen.

Wenn ein Webserver `fork()` verwendet, erm√∂glicht dies einen Brute-Force-Angriff, um das canary Byte f√ºr Byte zu erraten. Die Verwendung von `execve()` nach `fork()` √ºberschreibt jedoch den Speicherbereich und negiert den Angriff. `vfork()` erm√∂glicht es dem untergeordneten Prozess, ohne Duplikation auszuf√ºhren, bis er versucht zu schreiben, wobei zu diesem Zeitpunkt ein Duplikat erstellt wird, was einen anderen Ansatz zur Prozessgenerierung und Speicherverwaltung bietet.

### L√§ngen

In `x64`-Binaries ist das canary-Cookie ein **`0x8`** Byte qword. Die **ersten sieben Bytes sind zuf√§llig** und das letzte Byte ist ein **null Byte.**

In `x86`-Binaries ist das canary-Cookie ein **`0x4`** Byte dword. Die **ersten drei Bytes sind zuf√§llig** und das letzte Byte ist ein **null Byte.**

{% hint style="danger" %}
Das am wenigsten signifikante Byte beider canaries ist ein null Byte, da es das erste im Stack ist, das von niedrigeren Adressen kommt, und daher **werden Funktionen, die Strings lesen, stoppen, bevor sie es lesen**.
{% endhint %}

## Umgehungen

**Den canary auslesen** und dann mit seinem eigenen Wert √ºberschreiben (z. B. Buffer√ºberlauf).

* Wenn der **canary in untergeordneten Prozessen geforkt wird**, k√∂nnte es m√∂glich sein, ihn **byteweise zu brute-forcen**:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Wenn es eine interessante **Leck- oder willk√ºrliche Leseanf√§lligkeit** im Binary gibt, k√∂nnte es m√∂glich sein, ihn auszulesen:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **√úberschreiben von im Stack gespeicherten Zeigern**

Der Stack, der anf√§llig f√ºr einen Stack√ºberlauf ist, k√∂nnte **Adressen zu Strings oder Funktionen enthalten, die √ºberschrieben werden k√∂nnen**, um die Anf√§lligkeit auszunutzen, ohne den Stack canary erreichen zu m√ºssen. √úberpr√ºfen Sie:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **√Ñndern sowohl des Master- als auch des Thread-canary**

Ein Buffer√ºberlauf in einer gesch√ºtzten Funktion mit canary kann verwendet werden, um den Master-canary des Threads zu √§ndern. Infolgedessen ist die Minderung nutzlos, da die √úberpr√ºfung mit zwei canaries verwendet wird, die gleich sind (obwohl modifiziert).

* **√Ñndern des GOT-Eintrags von `__stack_chk_fail`**

Wenn das Binary Partial RELRO hat, k√∂nnen Sie einen willk√ºrlichen Schreibvorgang verwenden, um den GOT-Eintrag von `__stack_chk_fail` in eine Dummy-Funktion zu √§ndern, die das Programm nicht blockiert, wenn der canary ge√§ndert wird.

## Referenzen

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64 Bit, kein PIE, nx, Master- und Thread-canary √§ndern.
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
* 64 Bit, kein PIE, nx, write-what-where-Primitiv. √Ñndern Sie den GOT-Eintrag von `__stack_chk_fail`.

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
