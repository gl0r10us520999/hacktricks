# Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **StackGuard and StackShield**

**StackGuard**は、**EIP (Extended Instruction Pointer)**の前に特別な値である**canary**を挿入します。具体的には`0x000aff0d`（ヌル、改行、EOF、キャリッジリターンを表す）で、バッファオーバーフローから保護します。しかし、`recv()`、`memcpy()`、`read()`、および`bcopy()`のような関数は依然として脆弱であり、**EBP (Base Pointer)**を保護しません。

**StackShield**は、**Global Return Stack**を維持することでStackGuardよりも洗練されたアプローチを取ります。これにより、すべての戻りアドレス（**EIPs**）が保存され、オーバーフローが発生しても害を及ぼさないようにします。保存された戻りアドレスと実際の戻りアドレスを比較することで、オーバーフローの発生を検出できます。さらに、StackShieldは戻りアドレスを境界値と照合して、**EIP**が期待されるデータ空間の外を指しているかどうかを検出できます。しかし、この保護はReturn-to-libc、ROP (Return-Oriented Programming)、またはret2retのような技術によって回避可能であり、StackShieldもローカル変数を保護しないことを示しています。

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

このメカニズムは、**EBP**の前に**canary**を配置し、ローカル変数を再配置してバッファをより高いメモリアドレスに配置し、他の変数を上書きしないようにします。また、ローカル変数の上にスタックで渡された引数を安全にコピーし、これらのコピーを引数として使用します。しかし、8要素未満の配列やユーザーの構造内のバッファは保護されません。

**canary**は、`/dev/urandom`から派生したランダムな数またはデフォルト値`0xff0a0000`です。これは**TLS (Thread Local Storage)**に保存され、スレッド間で共有メモリ空間がスレッド固有のグローバルまたは静的変数を持つことを可能にします。これらの変数は最初に親プロセスからコピーされ、子プロセスは親や兄弟に影響を与えずにデータを変更できます。しかし、**`fork()`を使用して新しいcanaryを作成しない場合、すべてのプロセス（親と子）は同じcanaryを共有するため、脆弱になります**。**i386**アーキテクチャでは、canaryは`gs:0x14`に保存され、**x86\_64**では`fs:0x28`に保存されます。

このローカル保護は、攻撃に脆弱なバッファを持つ関数を特定し、これらの関数の開始時にcanaryを配置するためにコードを注入し、終了時にその整合性を確認します。

ウェブサーバーが`fork()`を使用すると、canaryバイトを1バイトずつ推測するためのブルートフォース攻撃が可能になります。しかし、`fork()`の後に`execve()`を使用すると、メモリ空間が上書きされ、攻撃が無効になります。`vfork()`は、子プロセスが書き込みを試みるまで複製なしで実行できるため、プロセス作成とメモリ処理に異なるアプローチを提供します。

### Lengths

`x64`バイナリでは、canaryクッキーは**`0x8`**バイトのqwordです。**最初の7バイトはランダム**で、最後のバイトは**ヌルバイト**です。

`x86`バイナリでは、canaryクッキーは**`0x4`**バイトのdwordです。**最初の3バイトはランダム**で、最後のバイトは**ヌルバイト**です。

{% hint style="danger" %}
両方のcanaryの最下位バイトはヌルバイトです。なぜなら、それはスタックの最初に来るため、**文字列を読み取る関数はそれを読み取る前に停止します**。
{% endhint %}

## Bypasses

**canaryを漏洩させ**、その後自分の値で上書きします（例：バッファオーバーフロー）。

* **canaryが子プロセスでフォークされる場合**、1バイトずつ**ブルートフォース**することが可能かもしれません：

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* バイナリに興味深い**漏洩または任意の読み取り脆弱性**がある場合、それを漏洩させることができるかもしれません：

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **スタックに保存されたポインタを上書きする**

スタックはスタックオーバーフローに脆弱であり、**上書き可能な文字列や関数のアドレスを含む可能性があります**。これにより、canaryに到達することなく脆弱性を悪用できます。確認してください：

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **マスターcanaryとスレッドcanaryの両方を変更する**

canaryで保護されたスレッド関数のバッファオーバーフローを使用して、スレッドのマスターcanaryを変更できます。その結果、チェックは同じ（ただし変更された）2つのcanaryを使用するため、緩和策は無効になります。

* **`__stack_chk_fail`のGOTエントリを変更する**

バイナリがPartial RELROを持っている場合、任意の書き込みを使用して`__stack_chk_fail`のGOTエントリをダミー関数に変更し、canaryが変更されてもプログラムがブロックされないようにできます。

## References

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64ビット、PIEなし、nx、スレッドとマスターcanaryを変更。
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
* 64ビット、PIEなし、nx、write-what-whereプリミティブ。`__stack_chk_fail`のGOTエントリを変更。 

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
