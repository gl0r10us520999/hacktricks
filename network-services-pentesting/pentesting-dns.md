# 53 - Pentesting DNS

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre r√©seau et le cloud**

**Trouvez et signalez des vuln√©rabilit√©s critiques et exploitables ayant un impact commercial r√©el.** Utilisez nos 20+ outils personnalis√©s pour cartographier la surface d'attaque, trouver des probl√®mes de s√©curit√© qui vous permettent d'escalader les privil√®ges, et utilisez des exploits automatis√©s pour collecter des preuves essentielles, transformant votre travail acharn√© en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## **Informations de base**

Le **syst√®me de noms de domaine (DNS)** sert de r√©pertoire d'internet, permettant aux utilisateurs d'acc√©der √† des sites web via des **noms de domaine faciles √† retenir** comme google.com ou facebook.com, au lieu des adresses num√©riques de protocole Internet (IP). En traduisant les noms de domaine en adresses IP, le DNS garantit que les navigateurs web peuvent rapidement charger les ressources internet, simplifiant ainsi notre navigation dans le monde en ligne.

**Port par d√©faut :** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Diff√©rents serveurs DNS

* **Serveurs racines DNS** : Ceux-ci se trouvent au sommet de la hi√©rarchie DNS, g√©rant les domaines de premier niveau et intervenant uniquement si les serveurs de niveau inf√©rieur ne r√©pondent pas. La Corporation Internet pour les Noms et Num√©ros Assign√©s (**ICANN**) supervise leur fonctionnement, avec un nombre global de 13.
* **Serveurs de noms autoritaires** : Ces serveurs ont le dernier mot pour les requ√™tes dans leurs zones d√©sign√©es, offrant des r√©ponses d√©finitives. S'ils ne peuvent pas fournir de r√©ponse, la requ√™te est escalad√©e vers les serveurs racines.
* **Serveurs de noms non autoritaires** : Ne poss√©dant pas de zones DNS, ces serveurs rassemblent des informations sur les domaines par le biais de requ√™tes √† d'autres serveurs.
* **Serveur DNS de mise en cache** : Ce type de serveur m√©morise les r√©ponses aux requ√™tes pr√©c√©dentes pendant un certain temps pour acc√©l√©rer les temps de r√©ponse pour les demandes futures, la dur√©e du cache √©tant dict√©e par le serveur autoritaire.
* **Serveur de transfert** : Jouant un r√¥le simple, les serveurs de transfert relaient simplement les requ√™tes √† un autre serveur.
* **R√©solveur** : Int√©gr√© dans les ordinateurs ou les routeurs, les r√©solveurs ex√©cutent la r√©solution de noms localement et ne sont pas consid√©r√©s comme autoritaires.

## √ânum√©ration

### **R√©cup√©ration de banni√®re**

Il n'y a pas de banni√®res dans DNS mais vous pouvez r√©cup√©rer la requ√™te magique pour `version.bind. CHAOS TXT` qui fonctionnera sur la plupart des serveurs de noms BIND.\
Vous pouvez effectuer cette requ√™te en utilisant `dig` :
```bash
dig version.bind CHAOS TXT @DNS
```
De plus, l'outil [`fpdns`](https://github.com/kirei/fpdns) peut √©galement identifier le serveur.

Il est √©galement possible de r√©cup√©rer la banni√®re avec un script **nmap** :
```
--script dns-nsid
```
### **Any record**

L'enregistrement **ANY** demandera au serveur DNS de **retourner** toutes les **entr√©es** disponibles qu'**il est pr√™t √† divulguer**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transfert de Zone**

Cette proc√©dure est abr√©g√©e `Asynchronous Full Transfer Zone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### Plus d'infos
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Automatisation
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Utilisation de nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Modules Metasploit Utiles
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts nmap utiles
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Si vous parvenez √† trouver des sous-domaines r√©solvant des adresses IP internes, vous devriez essayer d'effectuer un BF DNS inverse vers les NS du domaine demandant cette plage d'IP.
{% endhint %}

Un autre outil pour cela : [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Vous pouvez interroger des plages IP inverses √† [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#_dns) (cet outil est √©galement utile avec BGP).

### DNS - Sous-domaines BF
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Serveurs Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Force brute en utilisant des requ√™tes "AAAA" pour rassembler l'IPv6 des sous-domaines.
```bash
dnsdict6 -s -t <domain>
```
Bruteforce reverse DNS en utilisant des adresses IPv6
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Si **la r√©cursion DNS est activ√©e**, un attaquant pourrait **usurper** l'**origine** dans le paquet UDP afin de faire en sorte que le **DNS envoie la r√©ponse au serveur victime**. Un attaquant pourrait abuser des types d'enregistrements **ANY** ou **DNSSEC** car ils ont tendance √† avoir des r√©ponses plus volumineuses.\
La fa√ßon de **v√©rifier** si un DNS prend en charge la **r√©cursion** est de interroger un nom de domaine et de **v√©rifier** si le **drapeau "ra"** (_r√©cursion disponible_) est dans la r√©ponse :
```bash
dig google.com A @<IP>
```
**Non disponible**:

![](<../.gitbook/assets/image (123).png>)

**Disponible**:

![](<../.gitbook/assets/image (146).png>)

<figure><img src="../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre r√©seau et votre cloud**

**Trouvez et signalez des vuln√©rabilit√©s critiques et exploitables ayant un impact commercial r√©el.** Utilisez nos 20+ outils personnalis√©s pour cartographier la surface d'attaque, trouver des probl√®mes de s√©curit√© qui vous permettent d'escalader les privil√®ges, et utilisez des exploits automatis√©s pour collecter des preuves essentielles, transformant votre travail acharn√© en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

### Mail √† un compte inexistant

**Envoyer un email √† une adresse inexistante** en utilisant le domaine de la victime pourrait d√©clencher l'envoi d'une notification de non-livraison (NDN) dont les **en-t√™tes** pourraient contenir des informations int√©ressantes telles que le **nom des serveurs internes et les adresses IP**.

## Post-Exploitation

* Lors de la v√©rification de la configuration d'un serveur Bind, v√©rifiez la configuration du param√®tre **`allow-transfer`** car il indique qui peut effectuer des transferts de zone et **`allow-recursion`** et **`allow-query`** car ils indiquent qui peut envoyer des requ√™tes r√©cursives et des requ√™tes vers celui-ci.
* Les noms des fichiers li√©s au DNS qui pourraient √™tre int√©ressants √† rechercher sur les machines sont :
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
## R√©f√©rences

* [https://www.myrasecurity.com/en/knowledge-hub/dns/](https://www.myrasecurity.com/en/knowledge-hub/dns/)
* Livre : **√âvaluation de la s√©curit√© r√©seau 3√®me √©dition**

## Commandes automatiques HackTricks
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
<figure><img src="../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre r√©seau et le cloud**

**Trouvez et signalez des vuln√©rabilit√©s critiques et exploitables ayant un impact commercial r√©el.** Utilisez nos 20+ outils personnalis√©s pour cartographier la surface d'attaque, trouver des probl√®mes de s√©curit√© qui vous permettent d'escalader les privil√®ges, et utilisez des exploits automatis√©s pour collecter des preuves essentielles, transformant votre travail acharn√© en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
