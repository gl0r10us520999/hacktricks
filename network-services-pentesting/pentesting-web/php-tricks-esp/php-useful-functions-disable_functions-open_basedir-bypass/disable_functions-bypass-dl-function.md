{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

**Wichtiger Hinweis:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** ist eine PHP-Funktion, die verwendet werden kann, um PHP-Erweiterungen zu laden. Wenn die Funktion nicht deaktiviert ist, k√∂nnte sie missbraucht werden, um **`disable_functions` zu umgehen und beliebige Befehle auszuf√ºhren**.\
Es gibt jedoch einige strenge Einschr√§nkungen:

* Die `dl`-Funktion muss **vorhanden** und **nicht deaktiviert** sein.
* Die PHP-Erweiterung **muss mit der gleichen Hauptversion** (PHP-API-Version) kompiliert sein, die der Server verwendet (diese Informationen k√∂nnen Sie in der Ausgabe von phpinfo sehen).
* Die PHP-Erweiterung muss sich im **Verzeichnis** befinden, das durch die **`extension_dir`**-Direktive **definiert** ist (Sie k√∂nnen es in der Ausgabe von phpinfo sehen). Es ist sehr unwahrscheinlich, dass ein Angreifer, der versucht, den Server auszunutzen, Schreibzugriff auf dieses Verzeichnis hat, sodass diese Anforderung wahrscheinlich verhindern wird, dass Sie diese Technik ausnutzen.

**Wenn Sie diese Anforderungen erf√ºllen, lesen Sie den Beitrag** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **weiter, um zu erfahren, wie Sie disable\_functions umgehen k√∂nnen**. Hier ist eine Zusammenfassung:

Die [dl-Funktion](http://www.php.net/manual/en/function.dl.php) wird verwendet, um PHP-Erweiterungen dynamisch w√§hrend der Skriptausf√ºhrung zu laden. PHP-Erweiterungen, die typischerweise in C/C++ geschrieben sind, erweitern die Funktionalit√§t von PHP. Der Angreifer, der bemerkt, dass die `dl`-Funktion nicht deaktiviert ist, beschlie√üt, eine benutzerdefinierte PHP-Erweiterung zu erstellen, um Systembefehle auszuf√ºhren.

### Schritte des Angreifers:

1. **Identifizierung der PHP-Version:**
- Der Angreifer bestimmt die PHP-Version mit einem Skript (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Erwerb des PHP-Quellcodes:**
- L√§dt den PHP-Quellcode von der offiziellen [PHP-Website](http://www.php.net/downloads.php) oder dem [Archiv](http://museum.php.net), wenn die Version √§lter ist.

3. **Lokale PHP-Installation:**
- Entpackt und installiert die spezifische PHP-Version auf seinem System.

4. **Erstellung der Erweiterung:**
- Studiert [die Erstellung von PHP-Erweiterungen](http://www.php.net/manual/en/zend.creating.php) und untersucht den PHP-Quellcode.
- Konzentriert sich darauf, die Funktionalit√§t der [exec-Funktion](http://www.php.net/manual/en/function.exec.php) zu duplizieren, die sich in `ext/standard/exec.c` befindet.

### Hinweise zum Kompilieren der benutzerdefinierten Erweiterung:

1. **ZEND_MODULE_API_NO:**
- Die `ZEND_MODULE_API_NO` in `bypass.c` muss mit dem aktuellen Zend Extension Build √ºbereinstimmen, abrufbar mit:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **√Ñnderung von PHP_FUNCTION:**
- F√ºr neuere PHP-Versionen (5, 7, 8) muss `PHP_FUNCTION(bypass_exec)` m√∂glicherweise angepasst werden. Der bereitgestellte Codeausschnitt beschreibt diese √Ñnderung.

### Dateien der benutzerdefinierten Erweiterung:

- **bypass.c**:
- Implementiert die Kernfunktionalit√§t der benutzerdefinierten Erweiterung.
- **php_bypass.h**:
- Header-Datei, die die Eigenschaften der Erweiterung definiert.
- **config.m4**:
- Wird von `phpize` verwendet, um die Build-Umgebung f√ºr die benutzerdefinierte Erweiterung zu konfigurieren.

### Kompilierung der Erweiterung:

1. **Kompilierungsbefehle:**
- Verwendet `phpize`, `./configure` und `make`, um die Erweiterung zu kompilieren.
- Das resultierende `bypass.so` befindet sich dann im Unterverzeichnis der Module.

2. **Bereinigung:**
- F√ºhrt nach der Kompilierung `make clean` und `phpize --clean` aus.

### Hochladen und Ausf√ºhren auf dem Zielhost:

1. **Versionskompatibilit√§t:**
- Stellt sicher, dass die PHP-API-Versionen zwischen dem System des Angreifers und dem des Opfers √ºbereinstimmen.

2. **Laden der Erweiterung:**
- Nutzt die `dl`-Funktion, um Einschr√§nkungen zu umgehen, indem relative Pfade oder ein Skript verwendet werden, um den Prozess zu automatisieren.

3. **Skriptausf√ºhrung:**
- Der Angreifer l√§dt `bypass.so` und ein PHP-Skript auf den Server des Opfers hoch.
- Das Skript verwendet die `dl_local`-Funktion, um `bypass.so` dynamisch zu laden und ruft dann `bypass_exec` mit einem √ºber den Parameter `cmd` √ºbergebenen Befehl auf.

### Befehlsausf√ºhrung:

- Der Angreifer kann jetzt Befehle ausf√ºhren, indem er auf zugreift: `http://www.example.com/script.php?cmd=<command>`

Diese detaillierte Anleitung beschreibt den Prozess der Erstellung und Bereitstellung einer PHP-Erweiterung zur Ausf√ºhrung von Systembefehlen, indem die `dl`-Funktion ausgenutzt wird, die idealerweise deaktiviert sein sollte, um solche Sicherheitsverletzungen zu verhindern.


{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
