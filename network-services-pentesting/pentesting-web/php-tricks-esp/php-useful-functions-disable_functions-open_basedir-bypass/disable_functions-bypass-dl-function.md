{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Önemli not:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** PHP uzantılarını yüklemek için kullanılabilen bir PHP fonksiyonudur. Eğer bu fonksiyon devre dışı bırakılmamışsa, **`disable_functions` bypass etmek ve keyfi komutlar çalıştırmak için kötüye kullanılabilir**.\
Ancak, bazı katı sınırlamaları vardır:

* `dl` fonksiyonu **mevcut** olmalı ve **devre dışı bırakılmamalıdır**
* PHP uzantısı, sunucunun kullandığı **aynı ana sürümle** (PHP API sürümü) derlenmiş olmalıdır (bu bilgiyi phpinfo çıktısında görebilirsiniz)
* PHP uzantısı, **`extension_dir`** direktifi ile **tanımlanan** dizinde **bulunmalıdır** (bunu phpinfo çıktısında görebilirsiniz). Bir saldırganın bu dizinde yazma erişimine sahip olması çok olası değildir, bu nedenle bu gereklilik muhtemelen bu tekniği kötüye kullanmanızı engelleyecektir.

**Bu gereklilikleri karşılıyorsanız, `disable_functions` bypass etmeyi öğrenmek için yazıyı okumaya devam edin** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/). İşte bir özet:

[dl fonksiyonu](http://www.php.net/manual/en/function.dl.php), script çalıştırma sırasında PHP uzantılarını dinamik olarak yüklemek için kullanılır. Genellikle C/C++ ile yazılan PHP uzantıları, PHP'nin işlevselliğini artırır. Saldırgan, `dl` fonksiyonunun devre dışı bırakılmadığını fark ettiğinde, sistem komutlarını çalıştırmak için özel bir PHP uzantısı oluşturmayı karar verir.

### Saldırganın Aldığı Adımlar:

1. **PHP Sürüm Belirleme:**
- Saldırgan, bir script kullanarak PHP sürümünü belirler (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **PHP Kaynağını Temin Etme:**
- Resmi [PHP web sitesinden](http://www.php.net/downloads.php) veya sürüm eskiyse [arşivden](http://museum.php.net) PHP kaynağını indirir.

3. **Yerel PHP Kurulumu:**
- Belirli PHP sürümünü sistemine çıkarır ve kurar.

4. **Uzantı Oluşturma:**
- [PHP uzantıları oluşturmayı](http://www.php.net/manual/en/zend.creating.php) inceler ve PHP kaynak kodunu gözden geçirir.
- `ext/standard/exec.c` dosyasındaki [exec fonksiyonunun](http://www.php.net/manual/en/function.exec.php) işlevselliğini çoğaltmaya odaklanır.

### Özel Uzantıyı Derleme Notları:

1. **ZEND_MODULE_API_NO:**
- `bypass.c` içindeki `ZEND_MODULE_API_NO`, mevcut Zend Extension Build ile eşleşmelidir, bu bilgi şu komutla alınabilir:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **PHP_FUNCTION Değişikliği:**
- Son PHP sürümleri (5, 7, 8) için `PHP_FUNCTION(bypass_exec)` ayarlanması gerekebilir. Sağlanan kod parçası bu değişikliği detaylandırır.

### Özel Uzantı Dosyaları:

- **bypass.c**:
- Özel uzantının temel işlevselliğini uygular.
- **php_bypass.h**:
- Uzantı özelliklerini tanımlayan başlık dosyası.
- **config.m4**:
- Özel uzantının derleme ortamını yapılandırmak için `phpize` tarafından kullanılır.

### Uzantıyı Derleme:

1. **Derleme Komutları:**
- Uzantıyı derlemek için `phpize`, `./configure` ve `make` kullanır.
- Ortaya çıkan `bypass.so`, modüller alt dizininde bulunur.

2. **Temizlik:**
- Derlemeden sonra `make clean` ve `phpize --clean` komutlarını çalıştırır.

### Kurban Sunucusuna Yükleme ve Çalıştırma:

1. **Sürüm Uyumluluğu:**
- Saldırganın ve kurbanın sistemleri arasında PHP API sürümlerinin eşleştiğinden emin olur.

2. **Uzantı Yükleme:**
- `dl` fonksiyonunu kullanarak, kısıtlamaları aşmak için göreceli yollar veya süreci otomatikleştiren bir script kullanır.

3. **Script Çalıştırma:**
- Saldırgan, `bypass.so` ve bir PHP scriptini kurbanın sunucusuna yükler.
- Script, `bypass.so`'yu dinamik olarak yüklemek için `dl_local` fonksiyonunu kullanır ve ardından `cmd` sorgu parametresi aracılığıyla geçirilen bir komut ile `bypass_exec` çağrısında bulunur.

### Komut Çalıştırma:

- Saldırgan artık komutları şu şekilde çalıştırabilir: `http://www.example.com/script.php?cmd=<command>`


Bu ayrıntılı inceleme, sistem komutlarını çalıştırmak için bir PHP uzantısı oluşturma ve dağıtma sürecini, `dl` fonksiyonunu kötüye kullanarak açıklamaktadır; bu, bu tür güvenlik ihlallerini önlemek için ideal olarak devre dışı bırakılmalıdır.


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
