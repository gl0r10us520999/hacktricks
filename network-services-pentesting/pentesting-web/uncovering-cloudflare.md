# Uncovering CloudFlare

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Common Techniques to Uncover Cloudflare

* Puedes usar alg칰n servicio que te d칠 los **registros DNS hist칩ricos** del dominio. Tal vez la p치gina web est칠 funcionando en una direcci칩n IP utilizada anteriormente.
* Lo mismo podr칤a lograrse **verificando certificados SSL hist칩ricos** que podr칤an estar apuntando a la direcci칩n IP de origen.
* Verifica tambi칠n **registros DNS de otros subdominios que apunten directamente a IPs**, ya que es posible que otros subdominios est칠n apuntando al mismo servidor (quiz치s para ofrecer FTP, correo u otro servicio).
* Si encuentras un **SSRF dentro de la aplicaci칩n web** puedes abusar de ello para obtener la direcci칩n IP del servidor.
* Busca una cadena 칰nica de la p치gina web en navegadores como shodan (y tal vez google y similares?). Quiz치s puedas encontrar una direcci칩n IP con ese contenido.
* De manera similar, en lugar de buscar una cadena 칰nica, podr칤as buscar el icono favicon con la herramienta: [https://github.com/karma9874/CloudFlare-IP](https://github.com/karma9874/CloudFlare-IP) o con [https://github.com/pielco11/fav-up](https://github.com/pielco11/fav-up)
* Esto no funcionar치 muy frecuentemente porque el servidor debe enviar la misma respuesta cuando se accede por la direcci칩n IP, pero nunca se sabe.

## Tools to uncover Cloudflare

* Busca el dominio dentro de [http://www.crimeflare.org:82/cfs.html](http://www.crimeflare.org:82/cfs.html) o [https://crimeflare.herokuapp.com](https://crimeflare.herokuapp.com). O usa la herramienta [CloudPeler](https://github.com/zidansec/CloudPeler) (que utiliza esa API)
* Busca el dominio en [https://leaked.site/index.php?resolver/cloudflare.0/](https://leaked.site/index.php?resolver/cloudflare.0/)
* [**CloudFlair**](https://github.com/christophetd/CloudFlair) es una herramienta que buscar치 utilizando certificados de Censys que contengan el nombre de dominio, luego buscar치 IPv4s dentro de esos certificados y finalmente intentar치 acceder a la p치gina web en esas IPs.
* [**CloakQuest3r**](https://github.com/spyboy-productions/CloakQuest3r): CloakQuest3r es una poderosa herramienta de Python meticulosamente dise침ada para descubrir la verdadera direcci칩n IP de sitios web protegidos por Cloudflare y otras alternativas, un servicio de seguridad web y mejora del rendimiento ampliamente adoptado. Su misi칩n principal es discernir con precisi칩n la direcci칩n IP real de los servidores web que est치n ocultos detr치s del escudo protector de Cloudflare.
* [Censys](https://search.censys.io/)
* [Shodan](https://shodan.io/)
* [Bypass-firewalls-by-DNS-history](https://github.com/vincentcox/bypass-firewalls-by-DNS-history)
* Si tienes un conjunto de IPs potenciales donde se encuentra la p치gina web, podr칤as usar [https://github.com/hakluke/hakoriginfinder](https://github.com/hakluke/hakoriginfinder)
```bash
# You can check if the tool is working with
prips 1.0.0.0/30 | hakoriginfinder -h one.one.one.one

# If you know the company is using AWS you could use the previous tool to search the
## web page inside the EC2 IPs
DOMAIN=something.com
WIDE_REGION=us
for ir in `curl https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | select(.region|test("^us")) | .ip_prefix'`; do
echo "Checking $ir"
prips $ir | hakoriginfinder -h "$DOMAIN"
done
```
## Uncovering Cloudflare from Cloud infrastructure

Tenga en cuenta que, aunque esto se hizo para m치quinas de AWS, podr칤a hacerse para cualquier otro proveedor de nube.

Para una mejor descripci칩n de este proceso, consulte:

{% embed url="https://trickest.com/blog/cloudflare-bypass-discover-ip-addresses-aws/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
```bash
# Find open ports
sudo masscan --max-rate 10000 -p80,443 $(curl -s https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | .ip_prefix' | tr '\n' ' ') | grep "open"  > all_open.txt
# Format results
cat all_open.txt | sed 's,.*port \(.*\)/tcp on \(.*\),\2:\1,' | tr -d " " > all_open_formated.txt
# Search actual web pages
httpx -silent -threads 200 -l all_open_formated.txt -random-agent -follow-redirects -json -no-color -o webs.json
# Format web results and remove eternal redirects
cat webs.json | jq -r "select((.failed==false) and (.chain_status_codes | length) < 9) | .url" | sort -u > aws_webs.json

# Search via Host header
httpx -json -no-color -list aws_webs.json -header Host: cloudflare.malwareworld.com -threads 250 -random-agent -follow-redirects -o web_checks.json
```
## Bypass de Cloudflare a trav칠s de Cloudflare

### Extracciones de Origen Autenticadas

Este mecanismo se basa en **certificados SSL** [**del cliente**](https://socradar.io/how-to-monitor-your-ssl-certificates-expiration-easily-and-why/) **para autenticar conexiones** entre los servidores de **proxy inverso de Cloudflare** y el servidor **de origen**, lo que se llama **mTLS**.

En lugar de configurar su propio certificado, los clientes pueden simplemente usar el certificado de Cloudflare para permitir cualquier conexi칩n desde Cloudflare, **independientemente del inquilino**.

{% hint style="danger" %}
Por lo tanto, un atacante podr칤a simplemente establecer un **dominio en Cloudflare usando el certificado de Cloudflare y apuntarlo** a la direcci칩n **IP** del **v칤ctima**. De esta manera, al configurar su dominio completamente desprotegido, Cloudflare no proteger치 las solicitudes enviadas.
{% endhint %}

M치s informaci칩n [**aqu칤**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

### Direcciones IP de Cloudflare en la Lista Permitida

Esto **rechazar치 conexiones que no se originen en las** direcciones IP de Cloudflare. Esto tambi칠n es vulnerable a la configuraci칩n anterior donde un atacante simplemente **apunta su propio dominio en Cloudflare** a la direcci칩n **IP** de las **v칤ctimas**.

M치s informaci칩n [**aqu칤**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

## Bypass de Cloudflare para scraping

### Cach칠

A veces solo quieres eludir Cloudflare para raspar la p치gina web. Hay algunas opciones para esto:

* Usar la cach칠 de Google: `https://webcache.googleusercontent.com/search?q=cache:https://www.petsathome.com/shop/en/pets/dog`
* Usar otros servicios de cach칠 como [https://archive.org/web/](https://archive.org/web/)

### Herramientas

Algunas herramientas como las siguientes pueden eludir (o pudieron eludir) la protecci칩n de Cloudflare contra el scraping:

* [https://github.com/sarperavci/CloudflareBypassForScraping](https://github.com/sarperavci/CloudflareBypassForScraping)

### Solucionadores de Cloudflare

Se han desarrollado varios solucionadores de Cloudflare:

* [FlareSolverr](https://github.com/FlareSolverr/FlareSolverr)
* [cloudscraper](https://github.com/VeNoMouS/cloudscraper) [Gu칤a aqu칤](https://scrapeops.io/python-web-scraping-playbook/python-cloudscraper/)
* [cloudflare-scrape](https://github.com/Anorov/cloudflare-scrape)
* [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)
* [Cloudflare-IUAM-Solver](https://github.com/ninja-beans/cloudflare-iuam-solver)
* [cloudflare-bypass](https://github.com/devgianlu/cloudflare-bypass) \[Archivado]
* [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)

### Navegadores Sin Cabeza Fortalecidos <a href="#option-4-scrape-with-fortified-headless-browsers" id="option-4-scrape-with-fortified-headless-browsers"></a>

Usa un navegador sin cabeza que no sea detectado como un navegador automatizado (puedes necesitar personalizarlo para eso). Algunas opciones son:

* **Puppeteer:** El [plugin de sigilo](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth) para [puppeteer](https://github.com/puppeteer/puppeteer).
* **Playwright:** El [plugin de sigilo](https://www.npmjs.com/package/playwright-stealth) llegar치 a Playwright pronto. Sigue los desarrollos [aqu칤](https://github.com/berstend/puppeteer-extra/issues/454) y [aqu칤](https://github.com/berstend/puppeteer-extra/tree/master/packages/playwright-extra).
* **Selenium:** El [undetected-chromedriver](https://github.com/ultrafunkamsterdam/undetected-chromedriver) es un parche optimizado para Selenium Chromedriver.

### Proxy Inteligente Con Bypass Integrado de Cloudflare <a href="#option-5-smart-proxy-with-cloudflare-built-in-bypass" id="option-5-smart-proxy-with-cloudflare-built-in-bypass"></a>

Los **proxies inteligentes** son actualizados continuamente por empresas especializadas, con el objetivo de eludir las medidas de seguridad de Cloudflare (ya que ese es su negocio).

Algunos de ellos son:

* [ScraperAPI](https://www.scraperapi.com/?fp\_ref=scrapeops)
* [Scrapingbee](https://www.scrapingbee.com/?fpr=scrapeops)
* [Oxylabs](https://oxylabs.go2cloud.org/aff\_c?offer\_id=7\&aff\_id=379\&url\_id=32)
* [Smartproxy](https://prf.hn/click/camref:1100loxdG/\[p\_id:1100l442001]/destination:https%3A%2F%2Fsmartproxy.com%2Fscraping%2Fweb) son conocidos por sus mecanismos de bypass de Cloudflare patentados.

Para aquellos que buscan una soluci칩n optimizada, el [Agregador de Proxies de ScrapeOps](https://scrapeops.io/proxy-aggregator/) se destaca. Este servicio integra m치s de 20 proveedores de proxies en una sola API, seleccionando autom치ticamente el proxy m치s adecuado y rentable para tus dominios objetivo, ofreciendo as칤 una opci칩n superior para navegar por las defensas de Cloudflare.

### Ingenier칤a Inversa de la Protecci칩n Anti-Bot de Cloudflare <a href="#option-6-reverse-engineer-cloudflare-anti-bot-protection" id="option-6-reverse-engineer-cloudflare-anti-bot-protection"></a>

La ingenier칤a inversa de las medidas anti-bot de Cloudflare es una t치ctica utilizada por proveedores de proxies inteligentes, adecuada para un scraping web extenso sin el alto costo de ejecutar muchos navegadores sin cabeza.

**Ventajas:** Este m칠todo permite la creaci칩n de un bypass extremadamente eficiente que apunta espec칤ficamente a las verificaciones de Cloudflare, ideal para operaciones a gran escala.

**Desventajas:** La desventaja es la complejidad involucrada en entender y enga침ar al sistema anti-bot deliberadamente oscuro de Cloudflare, lo que requiere un esfuerzo continuo para probar diferentes estrategias y actualizar el bypass a medida que Cloudflare mejora sus protecciones.

Encuentra m치s informaci칩n sobre c칩mo hacer esto en el [art칤culo original](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/).

## Referencias

* [https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
