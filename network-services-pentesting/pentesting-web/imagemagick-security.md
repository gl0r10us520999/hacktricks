# ImageMagick Security

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

Check further details in [**https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html**](https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html)

ImageMagick, uma biblioteca vers√°til de processamento de imagens, apresenta um desafio na configura√ß√£o de sua pol√≠tica de seguran√ßa devido √†s suas extensas op√ß√µes e √† falta de documenta√ß√£o detalhada online. Os usu√°rios frequentemente criam pol√≠ticas com base em fontes fragmentadas da internet, levando a poss√≠veis configura√ß√µes incorretas. A biblioteca suporta uma vasta gama de mais de 100 formatos de imagem, cada um contribuindo para sua complexidade e perfil de vulnerabilidade, como demonstrado por incidentes de seguran√ßa hist√≥ricos.

## Towards Safer Policies
Para abordar esses desafios, uma [ferramenta foi desenvolvida](https://imagemagick-secevaluator.doyensec.com/) para ajudar no design e auditoria das pol√≠ticas de seguran√ßa do ImageMagick. Esta ferramenta √© baseada em extensa pesquisa e visa garantir que as pol√≠ticas n√£o sejam apenas robustas, mas tamb√©m livres de brechas que possam ser exploradas.

## Allowlist vs Denylist Approach
Historicamente, as pol√≠ticas do ImageMagick dependiam de uma abordagem de denylist, onde codificadores espec√≠ficos eram negados acesso. No entanto, mudan√ßas no ImageMagick 6.9.7-7 mudaram esse paradigma, permitindo uma abordagem de allowlist. Essa abordagem primeiro nega acesso a todos os codificadores e, em seguida, concede acesso seletivamente aos confi√°veis, melhorando a postura de seguran√ßa.
```xml
...
<policy domain="coder" rights="none" pattern="*" />
<policy domain="coder" rights="read | write" pattern="{GIF,JPEG,PNG,WEBP}" />
...
```
## Sensibilidade a Mai√∫sculas em Pol√≠ticas
√â crucial notar que os padr√µes de pol√≠tica no ImageMagick s√£o sens√≠veis a mai√∫sculas. Assim, garantir que os codificadores e m√≥dulos estejam corretamente em mai√∫sculas nas pol√≠ticas √© vital para evitar permiss√µes indesejadas.

## Limites de Recursos
O ImageMagick √© suscet√≠vel a ataques de nega√ß√£o de servi√ßo se n√£o estiver configurado corretamente. Definir limites de recursos expl√≠citos na pol√≠tica √© essencial para prevenir tais vulnerabilidades.

## Fragmenta√ß√£o de Pol√≠ticas
As pol√≠ticas podem estar fragmentadas em diferentes instala√ß√µes do ImageMagick, levando a potenciais conflitos ou substitui√ß√µes. √â recomend√°vel localizar e verificar os arquivos de pol√≠tica ativos usando comandos como:
```shell
$ find / -iname policy.xml
```
## Uma Pol√≠tica Restritiva para Iniciantes
Um modelo de pol√≠tica restritiva foi proposto, focando em limita√ß√µes rigorosas de recursos e controles de acesso. Este modelo serve como uma base para desenvolver pol√≠ticas personalizadas que se alinhem com os requisitos espec√≠ficos da aplica√ß√£o.

A efic√°cia de uma pol√≠tica de seguran√ßa pode ser confirmada usando o comando `identify -list policy` no ImageMagick. Al√©m disso, a [ferramenta avaliadora](https://imagemagick-secevaluator.doyensec.com/) mencionada anteriormente pode ser usada para refinar a pol√≠tica com base nas necessidades individuais.

## Refer√™ncias
* [https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html**](https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html)



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
