# NextJS

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripciÃ³n**](https://github.com/sponsors/carlospolop)!
* **Ãšnete al** ğŸ’¬ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­guenos** en **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Arquitectura General de una AplicaciÃ³n Next.js

### Estructura de Archivos TÃ­pica

Un proyecto estÃ¡ndar de Next.js sigue una estructura especÃ­fica de archivos y directorios que facilita sus caracterÃ­sticas como enrutamiento, puntos finales de API y gestiÃ³n de activos estÃ¡ticos. AquÃ­ hay un diseÃ±o tÃ­pico:
```lua
my-nextjs-app/
â”œâ”€â”€ node_modules/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ logo.png
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ hello/
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â””â”€â”€ Footer.tsx
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â””â”€â”€ Home.module.css
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ .env.local
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ yarn.lock / package-lock.json

```
### Directorios y Archivos Principales

* **public/:** Aloja activos estÃ¡ticos como imÃ¡genes, fuentes y otros archivos. Los archivos aquÃ­ son accesibles en la ruta raÃ­z (`/`).
* **app/:** Directorio central para las pÃ¡ginas, diseÃ±os, componentes y rutas API de tu aplicaciÃ³n. Abraza el paradigma del **App Router**, permitiendo caracterÃ­sticas avanzadas de enrutamiento y segregaciÃ³n de componentes del servidor y del cliente.
* **app/layout.tsx:** Define el diseÃ±o raÃ­z para tu aplicaciÃ³n, envolviendo todas las pÃ¡ginas y proporcionando elementos de UI consistentes como encabezados, pies de pÃ¡gina y barras de navegaciÃ³n.
* **app/page.tsx:** Sirve como el punto de entrada para la ruta raÃ­z `/`, renderizando la pÃ¡gina de inicio.
* **app/\[route]/page.tsx:** Maneja rutas estÃ¡ticas y dinÃ¡micas. Cada carpeta dentro de `app/` representa un segmento de ruta, y `page.tsx` dentro de esas carpetas corresponde al componente de la ruta.
* **app/api/:** Contiene rutas API, permitiÃ©ndote crear funciones sin servidor que manejan solicitudes HTTP. Estas rutas reemplazan el directorio tradicional `pages/api`.
* **app/components/:** Alberga componentes reutilizables de React que pueden ser utilizados en diferentes pÃ¡ginas y diseÃ±os.
* **app/styles/:** Contiene archivos CSS globales y MÃ³dulos CSS para estilos especÃ­ficos de componentes.
* **app/utils/:** Incluye funciones utilitarias, mÃ³dulos de ayuda y otra lÃ³gica no relacionada con la UI que puede ser compartida a travÃ©s de la aplicaciÃ³n.
* **.env.local:** Almacena variables de entorno especÃ­ficas para el entorno de desarrollo local. Estas variables **no** se comprometen al control de versiones.
* **next.config.js:** Personaliza el comportamiento de Next.js, incluyendo configuraciones de webpack, variables de entorno y configuraciones de seguridad.
* **tsconfig.json:** Configura los ajustes de TypeScript para el proyecto, habilitando la verificaciÃ³n de tipos y otras caracterÃ­sticas de TypeScript.
* **package.json:** Gestiona las dependencias del proyecto, scripts y metadatos.
* **README.md:** Proporciona documentaciÃ³n e informaciÃ³n sobre el proyecto, incluyendo instrucciones de configuraciÃ³n, pautas de uso y otros detalles relevantes.
* **yarn.lock / package-lock.json:** Bloquea las dependencias del proyecto a versiones especÃ­ficas, asegurando instalaciones consistentes en diferentes entornos.

## Lado del Cliente en Next.js

### Enrutamiento Basado en Archivos en el Directorio `app`

El directorio `app` es la piedra angular del enrutamiento en las Ãºltimas versiones de Next.js. Aprovecha el sistema de archivos para definir rutas, haciendo que la gestiÃ³n de rutas sea intuitiva y escalable.

<details>

<summary>Manejo de la Ruta RaÃ­z /</summary>

**Estructura de Archivos:**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Archivos Clave:**

* **`app/page.tsx`**: Maneja las solicitudes a la ruta raÃ­z `/`.
* **`app/layout.tsx`**: Define el diseÃ±o para la aplicaciÃ³n, envolviendo todas las pÃ¡ginas.

**ImplementaciÃ³n:**
```tsx
tsxCopy code// app/page.tsx

export default function HomePage() {
return (
<div>
<h1>Welcome to the Home Page!</h1>
<p>This is the root route.</p>
</div>
);
}
```
**ExplicaciÃ³n:**

* **DefiniciÃ³n de Ruta:** El archivo `page.tsx` directamente bajo el directorio `app` corresponde a la ruta `/`.
* **Renderizado:** Este componente renderiza el contenido para la pÃ¡gina de inicio.
* **IntegraciÃ³n de DiseÃ±o:** El componente `HomePage` estÃ¡ envuelto por el `layout.tsx`, que puede incluir encabezados, pies de pÃ¡gina y otros elementos comunes.

</details>

<details>

<summary>Manejo de Otras Rutas EstÃ¡ticas</summary>



**Ejemplo: Ruta `/about`**

**Estructura de Archivos:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```tsx
// app/about/page.tsx

export default function AboutPage() {
return (
<div>
<h1>About Us</h1>
<p>Learn more about our mission and values.</p>
</div>
);
}
```
**ExplicaciÃ³n:**

* **DefiniciÃ³n de Ruta:** El archivo `page.tsx` dentro de la carpeta `about` corresponde a la ruta `/about`.
* **Renderizado:** Este componente renderiza el contenido para la pÃ¡gina de acerca de.

</details>

<details>

<summary>Rutas DinÃ¡micas</summary>



Las rutas dinÃ¡micas permiten manejar rutas con segmentos variables, lo que permite a las aplicaciones mostrar contenido basado en parÃ¡metros como IDs, slugs, etc.

**Ejemplo: Ruta `/posts/[id]`**

**Estructura de Archivos:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ posts/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```tsx
tsxCopy code// app/posts/[id]/page.tsx

import { useRouter } from 'next/navigation';

interface PostProps {
params: { id: string };
}

export default function PostPage({ params }: PostProps) {
const { id } = params;
// Fetch post data based on 'id'

return (
<div>
<h1>Post #{id}</h1>
<p>This is the content of post {id}.</p>
</div>
);
}
```
**ExplicaciÃ³n:**

* **Segmento DinÃ¡mico:** `[id]` denota un segmento dinÃ¡mico en la ruta, capturando el parÃ¡metro `id` de la URL.
* **Accediendo a ParÃ¡metros:** El objeto `params` contiene los parÃ¡metros dinÃ¡micos, accesibles dentro del componente.
* **Coincidencia de Rutas:** Cualquier ruta que coincida con `/posts/*`, como `/posts/1`, `/posts/abc`, etc., serÃ¡ manejada por este componente.

</details>

<details>

<summary>Rutas Anidadas</summary>



Next.js soporta el enrutamiento anidado, permitiendo estructuras de rutas jerÃ¡rquicas que reflejan la disposiciÃ³n del directorio.

**Ejemplo: Ruta `/dashboard/settings/profile`**

**Estructura de Archivos:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ profile/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```tsx
tsxCopy code// app/dashboard/settings/profile/page.tsx

export default function ProfileSettingsPage() {
return (
<div>
<h1>Profile Settings</h1>
<p>Manage your profile information here.</p>
</div>
);
}
```
**ExplicaciÃ³n:**

* **Anidamiento Profundo:** El archivo `page.tsx` dentro de `dashboard/settings/profile/` corresponde a la ruta `/dashboard/settings/profile`.
* **Reflejo de JerarquÃ­a:** La estructura del directorio refleja la ruta URL, mejorando la mantenibilidad y claridad.

</details>

<details>

<summary>Rutas Catch-All</summary>

Las rutas catch-all manejan mÃºltiples segmentos anidados o rutas desconocidas, proporcionando flexibilidad en el manejo de rutas.

**Ejemplo: Ruta `/*`**

**Estructura de Archivos:**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [..slug]/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```tsx
// app/[...slug]/page.tsx

interface CatchAllProps {
params: { slug: string[] };
}

export default function CatchAllPage({ params }: CatchAllProps) {
const { slug } = params;
const fullPath = `/${slug.join('/')}`;

return (
<div>
<h1>Catch-All Route</h1>
<p>You have navigated to: {fullPath}</p>
</div>
);
}
```
**ExplicaciÃ³n:**

* **Segmento Catch-All:** `[...slug]` captura todos los segmentos de ruta restantes como un array.
* **Uso:** Ãštil para manejar escenarios de enrutamiento dinÃ¡mico como rutas generadas por el usuario, categorÃ­as anidadas, etc.
* **Coincidencia de Rutas:** Rutas como `/anything/here`, `/foo/bar/baz`, etc., son manejadas por este componente.

</details>

### Vulnerabilidades Potenciales del Lado del Cliente

Mientras que Next.js proporciona una base segura, las prÃ¡cticas de codificaciÃ³n inadecuadas pueden introducir vulnerabilidades. Las principales vulnerabilidades del lado del cliente incluyen:

<details>

<summary>Cross-Site Scripting (XSS)</summary>

Los ataques XSS ocurren cuando scripts maliciosos son inyectados en sitios web de confianza. Los atacantes pueden ejecutar scripts en los navegadores de los usuarios, robando datos o realizando acciones en nombre del usuario.

**Ejemplo de CÃ³digo Vulnerable:**
```jsx
// Dangerous: Injecting user input directly into HTML
function Comment({ userInput }) {
return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
}
```
**Por quÃ© es vulnerable:** Usar `dangerouslySetInnerHTML` con entradas no confiables permite a los atacantes inyectar scripts maliciosos.

</details>

<details>

<summary>InyecciÃ³n de Plantillas del Lado del Cliente</summary>

Ocurre cuando las entradas del usuario no se manejan adecuadamente en las plantillas, lo que permite a los atacantes inyectar y ejecutar plantillas o expresiones.

**Ejemplo de CÃ³digo Vulnerable:**
```jsx
import React from 'react';
import ejs from 'ejs';

function RenderTemplate({ template, data }) {
const html = ejs.render(template, data);
return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```
**Por quÃ© es vulnerable:** Si `template` o `data` incluyen contenido malicioso, puede llevar a la ejecuciÃ³n de cÃ³digo no intencionado.

</details>

<details>

<summary>Recorrido de Ruta del Cliente</summary>

Es una vulnerabilidad que permite a los atacantes manipular rutas del lado del cliente para realizar acciones no intencionadas, como el Cross-Site Request Forgery (CSRF). A diferencia del recorrido de ruta del lado del servidor, que apunta al sistema de archivos del servidor, CSPT se centra en explotar mecanismos del lado del cliente para redirigir solicitudes API legÃ­timas a puntos finales maliciosos.

**Ejemplo de CÃ³digo Vulnerable:**

Una aplicaciÃ³n Next.js permite a los usuarios subir y descargar archivos. La funciÃ³n de descarga se implementa del lado del cliente, donde los usuarios pueden especificar la ruta del archivo a descargar.
```jsx
// pages/download.js
import { useState } from 'react';

export default function DownloadPage() {
const [filePath, setFilePath] = useState('');

const handleDownload = () => {
fetch(`/api/files/${filePath}`)
.then(response => response.blob())
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filePath;
a.click();
});
};

return (
<div>
<h1>Download File</h1>
<input
type="text"
value={filePath}
onChange={(e) => setFilePath(e.target.value)}
placeholder="Enter file path"
/>
<button onClick={handleDownload}>Download</button>
</div>
);
}
```
#### Escenario de Ataque

1. **Objetivo del Atacante**: Realizar un ataque CSRF para eliminar un archivo crÃ­tico (por ejemplo, `admin/config.json`) manipulando el `filePath`.
2. **Explotando CSPT**:
* **Entrada Maliciosa**: El atacante crea una URL con un `filePath` manipulado como `../deleteFile/config.json`.
* **Llamada API Resultante**: El cÃ³digo del lado del cliente realiza una solicitud a `/api/files/../deleteFile/config.json`.
* **Manejo del Servidor**: Si el servidor no valida el `filePath`, procesa la solicitud, potencialmente eliminando o exponiendo archivos sensibles.
3. **Ejecutando CSRF**:
* **Enlace Elaborado**: El atacante envÃ­a a la vÃ­ctima un enlace o incrusta un script malicioso que activa la solicitud de descarga con el `filePath` manipulado.
* **Resultado**: La vÃ­ctima ejecuta sin saber la acciÃ³n, lo que lleva a un acceso no autorizado a archivos o a su eliminaciÃ³n.

#### Por QuÃ© Es Vulnerable

* **Falta de ValidaciÃ³n de Entrada**: El lado del cliente permite entradas arbitrarias de `filePath`, habilitando la traversÃ­a de rutas.
* **Confianza en las Entradas del Cliente**: La API del lado del servidor confÃ­a y procesa el `filePath` sin sanitizaciÃ³n.
* **Acciones Potenciales de la API**: Si el endpoint de la API realiza acciones que cambian el estado (por ejemplo, eliminar, modificar archivos), puede ser explotado a travÃ©s de CSPT.

</details>

## Lado del Servidor en Next.js

### Renderizado del Lado del Servidor (SSR)

Las pÃ¡ginas se renderizan en el servidor en cada solicitud, asegurando que el usuario reciba HTML completamente renderizado. En este caso, deberÃ­as crear tu propio servidor personalizado para procesar las solicitudes.

**Casos de Uso:**

* Contenido dinÃ¡mico que cambia con frecuencia.
* OptimizaciÃ³n SEO, ya que los motores de bÃºsqueda pueden rastrear la pÃ¡gina completamente renderizada.

**ImplementaciÃ³n:**
```jsx
// pages/index.js
export async function getServerSideProps(context) {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data } };
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### GeneraciÃ³n de Sitios EstÃ¡ticos (SSG)

Las pÃ¡ginas se pre-renderizan en el momento de la construcciÃ³n, lo que resulta en tiempos de carga mÃ¡s rÃ¡pidos y una carga reducida en el servidor.

**Casos de Uso:**

* Contenido que no cambia con frecuencia.
* Blogs, documentaciÃ³n, pÃ¡ginas de marketing.

**ImplementaciÃ³n:**
```jsx
// pages/index.js
export async function getStaticProps() {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data }, revalidate: 60 }; // Revalidate every 60 seconds
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Serverless Functions (API Routes)

Next.js permite la creaciÃ³n de puntos finales de API como funciones sin servidor. Estas funciones se ejecutan bajo demanda sin necesidad de un servidor dedicado.

**Casos de Uso:**

* Manejo de envÃ­os de formularios.
* InteracciÃ³n con bases de datos.
* Procesamiento de datos o integraciÃ³n con APIs de terceros.

**ImplementaciÃ³n:**

Con la introducciÃ³n del directorio `app` en Next.js 13, el enrutamiento y el manejo de API se han vuelto mÃ¡s flexibles y potentes. Este enfoque moderno se alinea estrechamente con el sistema de enrutamiento basado en archivos, pero introduce capacidades mejoradas, incluyendo soporte para componentes de servidor y cliente.

#### Basic Route Handler

**Estructura de Archivos:**
```go
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello/
â”‚           â””â”€â”€ route.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```javascript
// app/api/hello/route.js

export async function POST(request) {
return new Response(JSON.stringify({ message: 'Hello from App Router!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

// Client-side fetch to access the API endpoint
fetch('/api/submit', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'John Doe' }),
})
.then((res) => res.json())
.then((data) => console.log(data));
```
**ExplicaciÃ³n:**

* **UbicaciÃ³n:** Las rutas de la API se colocan en el directorio `app/api/`.
* **Nomenclatura de Archivos:** Cada punto final de la API reside en su propia carpeta que contiene un archivo `route.js` o `route.ts`.
* **Funciones Exportadas:** En lugar de una Ãºnica exportaciÃ³n predeterminada, se exportan funciones especÃ­ficas de mÃ©todos HTTP (por ejemplo, `GET`, `POST`).
* **Manejo de Respuestas:** Utiliza el constructor `Response` para devolver respuestas, lo que permite un mayor control sobre los encabezados y cÃ³digos de estado.

#### CÃ³mo manejar otros caminos y mÃ©todos:

<details>

<summary>Manejo de MÃ©todos HTTP EspecÃ­ficos</summary>

Next.js 13+ te permite definir controladores para mÃ©todos HTTP especÃ­ficos dentro del mismo archivo `route.js` o `route.ts`, promoviendo un cÃ³digo mÃ¡s claro y organizado.

**Ejemplo:**
```javascript
// app/api/users/[id]/route.js

export async function GET(request, { params }) {
const { id } = params;
// Fetch user data based on 'id'
return new Response(JSON.stringify({ userId: id, name: 'Jane Doe' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function PUT(request, { params }) {
const { id } = params;
// Update user data based on 'id'
return new Response(JSON.stringify({ message: `User ${id} updated.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function DELETE(request, { params }) {
const { id } = params;
// Delete user based on 'id'
return new Response(JSON.stringify({ message: `User ${id} deleted.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**ExplicaciÃ³n:**

* **MÃºltiples Exportaciones:** Cada mÃ©todo HTTP (`GET`, `PUT`, `DELETE`) tiene su propia funciÃ³n exportada.
* **ParÃ¡metros:** El segundo argumento proporciona acceso a los parÃ¡metros de ruta a travÃ©s de `params`.
* **Respuestas Mejoradas:** Mayor control sobre los objetos de respuesta, lo que permite una gestiÃ³n precisa de encabezados y cÃ³digos de estado.

</details>

<details>

<summary>Rutas Catch-All y Anidadas</summary>



Next.js 13+ admite caracterÃ­sticas avanzadas de enrutamiento como rutas catch-all y rutas API anidadas, lo que permite estructuras de API mÃ¡s dinÃ¡micas y escalables.

**Ejemplo de Ruta Catch-All:**
```javascript
// app/api/[...slug]/route.js

export async function GET(request, { params }) {
const { slug } = params;
// Handle dynamic nested routes
return new Response(JSON.stringify({ slug }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**ExplicaciÃ³n:**

* **Sintaxis:** `[...]` denota un segmento que captura todo, capturando todos los caminos anidados.
* **Uso:** Ãštil para APIs que necesitan manejar diferentes profundidades de ruta o segmentos dinÃ¡micos.

**Ejemplo de Rutas Anidadas:**
```javascript
// app/api/posts/[postId]/comments/[commentId]/route.js

export async function GET(request, { params }) {
const { postId, commentId } = params;
// Fetch specific comment for a post
return new Response(JSON.stringify({ postId, commentId, comment: 'Great post!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**ExplicaciÃ³n:**

* **Anidamiento Profundo:** Permite estructuras de API jerÃ¡rquicas, reflejando relaciones de recursos.
* **Acceso a ParÃ¡metros:** Accede fÃ¡cilmente a mÃºltiples parÃ¡metros de ruta a travÃ©s del objeto `params`.

</details>

<details>

<summary>Manejo de rutas API en Next.js 12 y versiones anteriores</summary>

## Rutas API en el Directorio `pages` (Next.js 12 y versiones anteriores)

Antes de que Next.js 13 introdujera el directorio `app` y mejorara las capacidades de enrutamiento, las rutas API se definÃ­an principalmente dentro del directorio `pages`. Este enfoque todavÃ­a se utiliza y es compatible en Next.js 12 y versiones anteriores.

#### Ruta API BÃ¡sica

**Estructura de Archivos:**
```go
goCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```javascript
javascriptCopy code// pages/api/hello.js

export default function handler(req, res) {
res.status(200).json({ message: 'Hello, World!' });
}
```
**ExplicaciÃ³n:**

* **UbicaciÃ³n:** Las rutas de la API residen en el directorio `pages/api/`.
* **Exportar:** Usa `export default` para definir la funciÃ³n manejadora.
* **Firma de la FunciÃ³n:** El manejador recibe los objetos `req` (solicitud HTTP) y `res` (respuesta HTTP).
* **Enrutamiento:** El nombre del archivo (`hello.js`) se mapea al endpoint `/api/hello`.

#### Rutas de API DinÃ¡micas

**Estructura de Archivos:**
```bash
bashCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ users/
â”‚           â””â”€â”€ [id].js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**ImplementaciÃ³n:**
```javascript
javascriptCopy code// pages/api/users/[id].js

export default function handler(req, res) {
const {
query: { id },
method,
} = req;

switch (method) {
case 'GET':
// Fetch user data based on 'id'
res.status(200).json({ userId: id, name: 'John Doe' });
break;
case 'PUT':
// Update user data based on 'id'
res.status(200).json({ message: `User ${id} updated.` });
break;
case 'DELETE':
// Delete user based on 'id'
res.status(200).json({ message: `User ${id} deleted.` });
break;
default:
res.setHeader('Allow', ['GET', 'PUT', 'DELETE']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**ExplicaciÃ³n:**

* **Segmentos DinÃ¡micos:** Los corchetes (`[id].js`) denotan segmentos de ruta dinÃ¡mica.
* **Accediendo a ParÃ¡metros:** Usa `req.query.id` para acceder al parÃ¡metro dinÃ¡mico.
* **Manejo de MÃ©todos:** Utiliza lÃ³gica condicional para manejar diferentes mÃ©todos HTTP (`GET`, `PUT`, `DELETE`, etc.).

#### Manejo de Diferentes MÃ©todos HTTP

Mientras que el ejemplo bÃ¡sico de ruta API maneja todos los mÃ©todos HTTP dentro de una sola funciÃ³n, puedes estructurar tu cÃ³digo para manejar cada mÃ©todo explÃ­citamente para una mejor claridad y mantenibilidad.

**Ejemplo:**
```javascript
javascriptCopy code// pages/api/posts.js

export default async function handler(req, res) {
const { method } = req;

switch (method) {
case 'GET':
// Handle GET request
res.status(200).json({ message: 'Fetching posts.' });
break;
case 'POST':
// Handle POST request
res.status(201).json({ message: 'Post created.' });
break;
default:
res.setHeader('Allow', ['GET', 'POST']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Mejores PrÃ¡cticas:**

* **SeparaciÃ³n de Preocupaciones:** Separa claramente la lÃ³gica para diferentes mÃ©todos HTTP.
* **Consistencia en las Respuestas:** Asegura estructuras de respuesta consistentes para facilitar el manejo del lado del cliente.
* **Manejo de Errores:** Maneja de manera elegante los mÃ©todos no soportados y los errores inesperados.

</details>

### ConfiguraciÃ³n de CORS

Controla quÃ© orÃ­genes pueden acceder a tus rutas de API, mitigando las vulnerabilidades de Cross-Origin Resource Sharing (CORS).

**Ejemplo de Mala ConfiguraciÃ³n:**
```javascript
// app/api/data/route.js

export async function GET(request) {
return new Response(JSON.stringify({ data: 'Public Data' }), {
status: 200,
headers: {
'Access-Control-Allow-Origin': '*', // Allows any origin
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
},
});
}
```
Nota que **CORS tambiÃ©n se puede configurar en todas las rutas de la API** dentro del **`middleware.ts`** archivo:
```javascript
// app/middleware.ts

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
const allowedOrigins = ['https://yourdomain.com', 'https://sub.yourdomain.com'];
const origin = request.headers.get('Origin');

const response = NextResponse.next();

if (allowedOrigins.includes(origin || '')) {
response.headers.set('Access-Control-Allow-Origin', origin || '');
response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
// If credentials are needed:
// response.headers.set('Access-Control-Allow-Credentials', 'true');
}

// Handle preflight requests
if (request.method === 'OPTIONS') {
return new Response(null, {
status: 204,
headers: response.headers,
});
}

return response;
}

export const config = {
matcher: '/api/:path*', // Apply to all API routes
};

```
**Problema:**

* **`Access-Control-Allow-Origin: '*'`:** Permite que cualquier sitio web acceda a la API, lo que potencialmente permite que sitios maliciosos interactÃºen con tu API sin restricciones.
* **Amplia PermisiÃ³n de MÃ©todos:** Permitir todos los mÃ©todos puede habilitar a los atacantes para realizar acciones no deseadas.

**CÃ³mo los atacantes lo explotan:**

Los atacantes pueden crear sitios web maliciosos que hagan solicitudes a tu API, potencialmente abusando de funcionalidades como la recuperaciÃ³n de datos, la manipulaciÃ³n de datos o la activaciÃ³n de acciones no deseadas en nombre de usuarios autenticados.

{% content-ref url="../../pentesting-web/cors-bypass.md" %}
[cors-bypass.md](../../pentesting-web/cors-bypass.md)
{% endcontent-ref %}

## ExposiciÃ³n del cÃ³digo del servidor en el lado del cliente

Es fÃ¡cil **usar el cÃ³digo utilizado por el servidor tambiÃ©n en el cÃ³digo expuesto y utilizado por el lado del cliente**, la mejor manera de asegurar que un archivo de cÃ³digo nunca se exponga en el lado del cliente es utilizando esta importaciÃ³n al principio del archivo:
```js
import "server-only";
```
## Archivos Clave y Sus Roles

### `middleware.ts` / `middleware.js`

**UbicaciÃ³n:** RaÃ­z del proyecto o dentro de `src/`.

**PropÃ³sito:** Ejecuta cÃ³digo en la funciÃ³n sin servidor del lado del servidor antes de que se procese una solicitud, permitiendo tareas como autenticaciÃ³n, redirecciones o modificaciÃ³n de respuestas.

**Flujo de EjecuciÃ³n:**

1. **Solicitud Entrante:** El middleware intercepta la solicitud.
2. **Procesamiento:** Realiza operaciones basadas en la solicitud (por ejemplo, verificar autenticaciÃ³n).
3. **ModificaciÃ³n de Respuesta:** Puede alterar la respuesta o pasar el control al siguiente manejador.

**Casos de Uso de Ejemplo:**

* Redirigir a usuarios no autenticados.
* Agregar encabezados personalizados.
* Registrar solicitudes.

**ConfiguraciÃ³n de Ejemplo:**
```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
const url = req.nextUrl.clone();
if (!req.cookies.has('token')) {
url.pathname = '/login';
return NextResponse.redirect(url);
}
return NextResponse.next();
}

export const config = {
matcher: ['/protected/:path*'],
};
```
### `next.config.js`

**UbicaciÃ³n:** RaÃ­z del proyecto.

**PropÃ³sito:** Configura el comportamiento de Next.js, habilitando o deshabilitando caracterÃ­sticas, personalizando configuraciones de webpack, estableciendo variables de entorno y configurando varias caracterÃ­sticas de seguridad.

**Configuraciones de Seguridad Clave:**

<details>

<summary>Encabezados de Seguridad</summary>

Los encabezados de seguridad mejoran la seguridad de tu aplicaciÃ³n al instruir a los navegadores sobre cÃ³mo manejar el contenido. Ayudan a mitigar varios ataques como Cross-Site Scripting (XSS), Clickjacking y la detecciÃ³n de tipos MIME:

* PolÃ­tica de Seguridad de Contenido (CSP)
* X-Frame-Options
* X-Content-Type-Options
* Strict-Transport-Security (HSTS)
* PolÃ­tica de Referencia

**Ejemplos:**
```javascript
// next.config.js

module.exports = {
async headers() {
return [
{
source: '/(.*)', // Apply to all routes
headers: [
{
key: 'X-Frame-Options',
value: 'DENY',
},
{
key: 'Content-Security-Policy',
value: "default-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval';",
},
{
key: 'X-Content-Type-Options',
value: 'nosniff',
},
{
key: 'Strict-Transport-Security',
value: 'max-age=63072000; includeSubDomains; preload', // Enforces HTTPS
},
{
key: 'Referrer-Policy',
value: 'no-referrer', // Completely hides referrer
},
// Additional headers...
],
},
];
},
};
```
</details>

<details>

<summary>Configuraciones de OptimizaciÃ³n de ImÃ¡genes</summary>

Next.js optimiza las imÃ¡genes para el rendimiento, pero las configuraciones incorrectas pueden llevar a vulnerabilidades de seguridad, como permitir que fuentes no confiables inyecten contenido malicioso.

**Ejemplo de Mala ConfiguraciÃ³n:**
```javascript
// next.config.js

module.exports = {
images: {
domains: ['*'], // Allows images from any domain
},
};
```
**Problema:**

* **`'*'`:** Permite que las imÃ¡genes se carguen desde cualquier fuente externa, incluidos dominios no confiables o maliciosos. Los atacantes pueden alojar imÃ¡genes que contengan cargas Ãºtiles maliciosas o contenido que engaÃ±e a los usuarios.
* Otro problema podrÃ­a ser permitir un dominio **donde cualquiera puede subir una imagen** (como `raw.githubusercontent.com`)

**CÃ³mo los atacantes lo abusan:**

Al inyectar imÃ¡genes de fuentes maliciosas, los atacantes pueden realizar ataques de phishing, mostrar informaciÃ³n engaÃ±osa o explotar vulnerabilidades en bibliotecas de renderizado de imÃ¡genes.

</details>

<details>

<summary>ExposiciÃ³n de Variables de Entorno</summary>

Gestiona informaciÃ³n sensible como claves API y credenciales de base de datos de manera segura sin exponerlas al cliente.

#### a. Exponiendo Variables Sensibles

**Ejemplo de Mala ConfiguraciÃ³n:**
```javascript
// next.config.js

module.exports = {
env: {
SECRET_API_KEY: process.env.SECRET_API_KEY, // Exposed to the client
NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL, // Correctly prefixed for client
},
};
```
**Problema:**

* **`SECRET_API_KEY`:** Sin el prefijo `NEXT_PUBLIC_`, Next.js no expone variables al cliente. Sin embargo, si se antepone errÃ³neamente (por ejemplo, `NEXT_PUBLIC_SECRET_API_KEY`), se vuelve accesible en el lado del cliente.

**CÃ³mo los atacantes lo abusan:**

Si las variables sensibles se exponen al cliente, los atacantes pueden recuperarlas inspeccionando el cÃ³digo del lado del cliente o las solicitudes de red, obteniendo acceso no autorizado a APIs, bases de datos u otros servicios.

</details>

<details>

<summary>Redirecciones</summary>

Administra las redirecciones y reescrituras de URL dentro de tu aplicaciÃ³n, asegurando que los usuarios sean dirigidos apropiadamente sin introducir vulnerabilidades de redirecciÃ³n abierta.

#### a. Vulnerabilidad de RedirecciÃ³n Abierta

**Ejemplo de Mala ConfiguraciÃ³n:**
```javascript
// next.config.js

module.exports = {
async redirects() {
return [
{
source: '/redirect',
destination: (req) => req.query.url, // Dynamically redirects based on query parameter
permanent: false,
},
];
},
};
```
**Problema:**

* **Destino DinÃ¡mico:** Permite a los usuarios especificar cualquier URL, lo que habilita ataques de redirecciÃ³n abierta.
* **Confiar en la Entrada del Usuario:** Redirigir a URLs proporcionadas por los usuarios sin validaciÃ³n puede llevar a phishing, distribuciÃ³n de malware o robo de credenciales.

**CÃ³mo los atacantes lo abusan:**

Los atacantes pueden crear URLs que parecen originarse de su dominio pero redirigen a los usuarios a sitios maliciosos. Por ejemplo:
```bash
https://yourdomain.com/redirect?url=https://malicious-site.com
```
Los usuarios que confÃ­an en el dominio original pueden navegar sin saberlo a sitios web daÃ±inos.

</details>

<details>

<summary>ConfiguraciÃ³n de Webpack</summary>

Personaliza las configuraciones de Webpack para tu aplicaciÃ³n Next.js, que pueden introducir inadvertidamente vulnerabilidades de seguridad si no se manejan con precauciÃ³n.

#### a. Exponiendo MÃ³dulos Sensibles

**Ejemplo de ConfiguraciÃ³n Incorrecta:**
```javascript
// next.config.js

module.exports = {
webpack: (config, { isServer }) => {
if (!isServer) {
config.resolve.alias['@sensitive'] = path.join(__dirname, 'secret-folder');
}
return config;
},
};
```
**Problema:**

* **ExposiciÃ³n de Rutas Sensibles:** Alias de directorios sensibles y permitir el acceso del lado del cliente puede filtrar informaciÃ³n confidencial.
* **AgrupaciÃ³n de Secretos:** Si se agrupan archivos sensibles para el cliente, su contenido se vuelve accesible a travÃ©s de mapas de origen o inspeccionando el cÃ³digo del lado del cliente.

**CÃ³mo los atacantes lo abusan:**

Los atacantes pueden acceder o reconstruir la estructura de directorios de la aplicaciÃ³n, encontrando y explotando potencialmente archivos o datos sensibles.

</details>

### `pages/_app.js` y `pages/_document.js`

#### **`pages/_app.js`**

**PropÃ³sito:** Sobrescribe el componente App predeterminado, permitiendo estado global, estilos y componentes de diseÃ±o.

**Casos de Uso:**

* Inyectar CSS global.
* Agregar envolturas de diseÃ±o.
* Integrar bibliotecas de gestiÃ³n de estado.

**Ejemplo:**
```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
return <Component {...pageProps} />;
}

export default MyApp;
```
#### **`pages/_document.js`**

**PropÃ³sito:** Sobrescribe el Documento predeterminado, permitiendo la personalizaciÃ³n de las etiquetas HTML y Body.

**Casos de Uso:**

* Modificar las etiquetas `<html>` o `<body>`.
* Agregar etiquetas meta o scripts personalizados.
* Integrar fuentes de terceros.

**Ejemplo:**
```jsx
// pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
render() {
return (
<Html lang="en">
<Head>
{/* Custom fonts or meta tags */}
</Head>
<body>
<Main />
<NextScript />
</body>
</Html>
);
}
}

export default MyDocument;
```
### Servidor Personalizado (Opcional)

**PropÃ³sito:** Aunque Next.js viene con un servidor integrado, puedes crear un servidor personalizado para casos de uso avanzados como enrutamiento personalizado o integraciÃ³n con servicios backend existentes.

**Nota:** Usar un servidor personalizado puede limitar las opciones de implementaciÃ³n, especialmente en plataformas como Vercel que optimizan para el servidor integrado de Next.js.

**Ejemplo:**
```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
const server = express();

// Custom route
server.get('/a', (req, res) => {
return app.render(req, res, '/a');
});

// Default handler
server.all('*', (req, res) => {
return handle(req, res);
});

server.listen(3000, (err) => {
if (err) throw err;
console.log('> Ready on http://localhost:3000');
});
});
```
***

## Consideraciones Adicionales de Arquitectura y Seguridad

### Variables de Entorno y ConfiguraciÃ³n

**PropÃ³sito:** Gestionar informaciÃ³n sensible y configuraciones fuera de la base de cÃ³digo.

**Mejores PrÃ¡cticas:**

* **Usar Archivos `.env`:** Almacenar variables como claves API en `.env.local` (excluido del control de versiones).
* **Acceder a Variables de Forma Segura:** Usar `process.env.VARIABLE_NAME` para acceder a variables de entorno.
* **Nunca Exponer Secretos en el Cliente:** Asegurarse de que las variables sensibles solo se utilicen del lado del servidor.

**Ejemplo:**
```javascript
// next.config.js
module.exports = {
env: {
API_KEY: process.env.API_KEY, // Accessible on both client and server
SECRET_KEY: process.env.SECRET_KEY, // Be cautious if accessible on the client
},
};
```
**Nota:** Para restringir las variables solo al lado del servidor, omÃ­talas del objeto `env` o prefÃ­jalas con `NEXT_PUBLIC_` para la exposiciÃ³n del cliente.

### AutenticaciÃ³n y AutorizaciÃ³n

**Enfoque:**

* **AutenticaciÃ³n Basada en Sesiones:** Utiliza cookies para gestionar las sesiones de usuario.
* **AutenticaciÃ³n Basada en Tokens:** Implementa JWTs para autenticaciÃ³n sin estado.
* **Proveedores de Terceros:** Integra con proveedores de OAuth (por ejemplo, Google, GitHub) utilizando bibliotecas como `next-auth`.

**PrÃ¡cticas de Seguridad:**

* **Cookies Seguras:** Establece los atributos `HttpOnly`, `Secure` y `SameSite`.
* **Hashing de ContraseÃ±as:** Siempre hashea las contraseÃ±as antes de almacenarlas.
* **ValidaciÃ³n de Entradas:** Previene ataques de inyecciÃ³n validando y sanitizando las entradas.

**Ejemplo:**
```javascript
// pages/api/login.js
import { sign } from 'jsonwebtoken';
import { serialize } from 'cookie';

export default async function handler(req, res) {
const { username, password } = req.body;

// Validate user credentials
if (username === 'admin' && password === 'password') {
const token = sign({ username }, process.env.JWT_SECRET, { expiresIn: '1h' });
res.setHeader('Set-Cookie', serialize('auth', token, { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }));
res.status(200).json({ message: 'Logged in' });
} else {
res.status(401).json({ error: 'Invalid credentials' });
}
}
```
### OptimizaciÃ³n del Rendimiento

**Estrategias:**

* **OptimizaciÃ³n de ImÃ¡genes:** Usa el componente `next/image` de Next.js para la optimizaciÃ³n automÃ¡tica de imÃ¡genes.
* **DivisiÃ³n de CÃ³digo:** Aprovecha las importaciones dinÃ¡micas para dividir el cÃ³digo y reducir los tiempos de carga iniciales.
* **CachÃ©:** Implementa estrategias de cachÃ© para las respuestas de API y activos estÃ¡ticos.
* **Carga Perezosa:** Carga componentes o activos solo cuando sean necesarios.

**Ejemplo:**
```jsx
// Dynamic Import with Code Splitting
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('../components/HeavyComponent'), {
loading: () => <p>Loading...</p>,
});
```
{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripciÃ³n**](https://github.com/sponsors/carlospolop)!
* **Ãšnete al** ğŸ’¬ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­guenos** en **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
