# NextJS

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}

## OgÃ³lna architektura aplikacji Next.js

### Typowa struktura plikÃ³w

Standardowy projekt Next.js przestrzega okreÅ›lonej struktury plikÃ³w i katalogÃ³w, ktÃ³ra uÅ‚atwia jego funkcje, takie jak routowanie, punkty koÅ„cowe API i zarzÄ…dzanie zasobami statycznymi. Oto typowy ukÅ‚ad:
```lua
my-nextjs-app/
â”œâ”€â”€ node_modules/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ logo.png
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ hello/
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â””â”€â”€ Footer.tsx
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â””â”€â”€ Home.module.css
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ .env.local
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ yarn.lock / package-lock.json

```
### Core Directories and Files

* **public/:** Hostuje statyczne zasoby, takie jak obrazy, czcionki i inne pliki. Pliki tutaj sÄ… dostÄ™pne pod Å›cieÅ¼kÄ… gÅ‚Ã³wnÄ… (`/`).
* **app/:** Centralny katalog dla stron, ukÅ‚adÃ³w, komponentÃ³w i tras API Twojej aplikacji. Wprowadza paradygmat **App Router**, umoÅ¼liwiajÄ…c zaawansowane funkcje routingu i segregacjÄ™ komponentÃ³w serwera i klienta.
* **app/layout.tsx:** Definiuje gÅ‚Ã³wny ukÅ‚ad dla Twojej aplikacji, otaczajÄ…c wszystkie strony i zapewniajÄ…c spÃ³jne elementy UI, takie jak nagÅ‚Ã³wki, stopki i paski nawigacyjne.
* **app/page.tsx:** SÅ‚uÅ¼y jako punkt wejÅ›cia dla gÅ‚Ã³wnej trasy `/`, renderujÄ…c stronÄ™ gÅ‚Ã³wnÄ….
* **app/\[route]/page.tsx:** ObsÅ‚uguje trasy statyczne i dynamiczne. KaÅ¼dy folder w `app/` reprezentuje segment trasy, a `page.tsx` w tych folderach odpowiada komponentowi trasy.
* **app/api/:** Zawiera trasy API, umoÅ¼liwiajÄ…c tworzenie funkcji bezserwerowych, ktÃ³re obsÅ‚ugujÄ… Å¼Ä…dania HTTP. Te trasy zastÄ™pujÄ… tradycyjny katalog `pages/api`.
* **app/components/:** Zawiera wielokrotnego uÅ¼ytku komponenty React, ktÃ³re mogÄ… byÄ‡ wykorzystywane w rÃ³Å¼nych stronach i ukÅ‚adach.
* **app/styles/:** Zawiera globalne pliki CSS i moduÅ‚y CSS do stylizacji ograniczonej do komponentÃ³w.
* **app/utils/:** Zawiera funkcje pomocnicze, moduÅ‚y pomocnicze i innÄ… logikÄ™ niezwiÄ…zanÄ… z UI, ktÃ³ra moÅ¼e byÄ‡ wspÃ³Å‚dzielona w caÅ‚ej aplikacji.
* **.env.local:** Przechowuje zmienne Å›rodowiskowe specyficzne dla lokalnego Å›rodowiska deweloperskiego. Te zmienne **nie** sÄ… dodawane do kontroli wersji.
* **next.config.js:** Dostosowuje zachowanie Next.js, w tym konfiguracje webpack, zmienne Å›rodowiskowe i ustawienia bezpieczeÅ„stwa.
* **tsconfig.json:** Konfiguruje ustawienia TypeScript dla projektu, umoÅ¼liwiajÄ…c sprawdzanie typÃ³w i inne funkcje TypeScript.
* **package.json:** ZarzÄ…dza zaleÅ¼noÅ›ciami projektu, skryptami i metadanymi.
* **README.md:** Dostarcza dokumentacjÄ™ i informacje o projekcie, w tym instrukcje dotyczÄ…ce konfiguracji, wytyczne dotyczÄ…ce uÅ¼ytkowania i inne istotne szczegÃ³Å‚y.
* **yarn.lock / package-lock.json:** Zamyka zaleÅ¼noÅ›ci projektu do konkretnych wersji, zapewniajÄ…c spÃ³jne instalacje w rÃ³Å¼nych Å›rodowiskach.

## Client-Side in Next.js

### File-Based Routing in the `app` Directory

Katalog `app` jest fundamentem routingu w najnowszych wersjach Next.js. Wykorzystuje system plikÃ³w do definiowania tras, co sprawia, Å¼e zarzÄ…dzanie trasami jest intuicyjne i skalowalne.

<details>

<summary>Handling the Root Path /</summary>

**File Structure:**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Kluczowe pliki:**

* **`app/page.tsx`**: ObsÅ‚uguje Å¼Ä…dania do Å›cieÅ¼ki gÅ‚Ã³wnej `/`.
* **`app/layout.tsx`**: Definiuje ukÅ‚ad aplikacji, otaczajÄ…c wszystkie strony.

**Implementacja:**
```tsx
tsxCopy code// app/page.tsx

export default function HomePage() {
return (
<div>
<h1>Welcome to the Home Page!</h1>
<p>This is the root route.</p>
</div>
);
}
```
**WyjaÅ›nienie:**

* **Definicja trasy:** Plik `page.tsx` bezpoÅ›rednio pod katalogiem `app` odpowiada trasie `/`.
* **Renderowanie:** Ten komponent renderuje zawartoÅ›Ä‡ strony gÅ‚Ã³wnej.
* **Integracja ukÅ‚adu:** Komponent `HomePage` jest otoczony przez `layout.tsx`, ktÃ³ry moÅ¼e zawieraÄ‡ nagÅ‚Ã³wki, stopki i inne wspÃ³lne elementy.

</details>

<details>

<summary>ObsÅ‚uga innych statycznych Å›cieÅ¼ek</summary>



**PrzykÅ‚ad: Trasa `/about`**

**Struktura plikÃ³w:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```tsx
// app/about/page.tsx

export default function AboutPage() {
return (
<div>
<h1>About Us</h1>
<p>Learn more about our mission and values.</p>
</div>
);
}
```
**WyjaÅ›nienie:**

* **Definicja trasy:** Plik `page.tsx` wewnÄ…trz folderu `about` odpowiada trasie `/about`.
* **Renderowanie:** Ten komponent renderuje zawartoÅ›Ä‡ strony o nas.

</details>

<details>

<summary>Dynamiczne trasy</summary>

Dynamiczne trasy umoÅ¼liwiajÄ… obsÅ‚ugÄ™ Å›cieÅ¼ek z zmiennymi segmentami, co pozwala aplikacjom na wyÅ›wietlanie zawartoÅ›ci na podstawie parametrÃ³w, takich jak identyfikatory, slugi itp.

**PrzykÅ‚ad: Trasa `/posts/[id]`**

**Struktura plikÃ³w:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ posts/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```tsx
tsxCopy code// app/posts/[id]/page.tsx

import { useRouter } from 'next/navigation';

interface PostProps {
params: { id: string };
}

export default function PostPage({ params }: PostProps) {
const { id } = params;
// Fetch post data based on 'id'

return (
<div>
<h1>Post #{id}</h1>
<p>This is the content of post {id}.</p>
</div>
);
}
```
**WyjaÅ›nienie:**

* **Dynamiczny segment:** `[id]` oznacza dynamiczny segment w trasie, przechwytujÄ…c parametr `id` z URL.
* **DostÄ™p do parametrÃ³w:** Obiekt `params` zawiera dynamiczne parametry, dostÄ™pne w komponencie.
* **Dopasowywanie tras:** KaÅ¼da Å›cieÅ¼ka pasujÄ…ca do `/posts/*`, taka jak `/posts/1`, `/posts/abc`, itp., bÄ™dzie obsÅ‚ugiwana przez ten komponent.

</details>

<details>

<summary>ZagnieÅ¼dÅ¼one trasy</summary>



Next.js obsÅ‚uguje zagnieÅ¼dÅ¼one trasowanie, umoÅ¼liwiajÄ…c hierarchiczne struktury tras, ktÃ³re odzwierciedlajÄ… ukÅ‚ad katalogÃ³w.

**PrzykÅ‚ad: `/dashboard/settings/profile` Trasa**

**Struktura plikÃ³w:**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ profile/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```tsx
tsxCopy code// app/dashboard/settings/profile/page.tsx

export default function ProfileSettingsPage() {
return (
<div>
<h1>Profile Settings</h1>
<p>Manage your profile information here.</p>
</div>
);
}
```
**WyjaÅ›nienie:**

* **GÅ‚Ä™bokie ZagnieÅ¼dÅ¼enie:** Plik `page.tsx` w `dashboard/settings/profile/` odpowiada trasie `/dashboard/settings/profile`.
* **Odbicie Hierarchii:** Struktura katalogÃ³w odzwierciedla Å›cieÅ¼kÄ™ URL, co zwiÄ™ksza Å‚atwoÅ›Ä‡ utrzymania i przejrzystoÅ›Ä‡.

</details>

<details>

<summary>Trasy Catch-All</summary>

Trasy catch-all obsÅ‚ugujÄ… wiele zagnieÅ¼dÅ¼onych segmentÃ³w lub nieznane Å›cieÅ¼ki, zapewniajÄ…c elastycznoÅ›Ä‡ w obsÅ‚udze tras.

**PrzykÅ‚ad: Trasa `/*`**

**Struktura PlikÃ³w:**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [..slug]/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```tsx
// app/[...slug]/page.tsx

interface CatchAllProps {
params: { slug: string[] };
}

export default function CatchAllPage({ params }: CatchAllProps) {
const { slug } = params;
const fullPath = `/${slug.join('/')}`;

return (
<div>
<h1>Catch-All Route</h1>
<p>You have navigated to: {fullPath}</p>
</div>
);
}
```
**WyjaÅ›nienie:**

* **Catch-All Segment:** `[...slug]` przechwytuje wszystkie pozostaÅ‚e segmenty Å›cieÅ¼ki jako tablicÄ™.
* **Zastosowanie:** Przydatne do obsÅ‚ugi dynamicznych scenariuszy routingu, takich jak Å›cieÅ¼ki generowane przez uÅ¼ytkownikÃ³w, zagnieÅ¼dÅ¼one kategorie itp.
* **Dopasowywanie tras:** ÅšcieÅ¼ki takie jak `/anything/here`, `/foo/bar/baz` itp. sÄ… obsÅ‚ugiwane przez ten komponent.

</details>

### Potencjalne luki w zabezpieczeniach po stronie klienta

ChociaÅ¼ Next.js zapewnia bezpiecznÄ… podstawÄ™, niewÅ‚aÅ›ciwe praktyki kodowania mogÄ… wprowadzaÄ‡ luki. Kluczowe luki po stronie klienta obejmujÄ…:

<details>

<summary>Cross-Site Scripting (XSS)</summary>

Ataki XSS wystÄ™pujÄ…, gdy zÅ‚oÅ›liwe skrypty sÄ… wstrzykiwane do zaufanych stron internetowych. Napastnicy mogÄ… wykonywaÄ‡ skrypty w przeglÄ…darkach uÅ¼ytkownikÃ³w, kradnÄ…c dane lub wykonujÄ…c dziaÅ‚ania w imieniu uÅ¼ytkownika.

**PrzykÅ‚ad podatnego kodu:**
```jsx
// Dangerous: Injecting user input directly into HTML
function Comment({ userInput }) {
return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
}
```
**Dlaczego jest podatne:** UÅ¼ycie `dangerouslySetInnerHTML` z nieufnym wejÅ›ciem pozwala atakujÄ…cym na wstrzykiwanie zÅ‚oÅ›liwych skryptÃ³w.

</details>

<details>

<summary>Wstrzykiwanie szablonÃ³w po stronie klienta</summary>

WystÄ™puje, gdy dane wejÅ›ciowe uÅ¼ytkownika sÄ… niewÅ‚aÅ›ciwie obsÅ‚ugiwane w szablonach, co pozwala atakujÄ…cym na wstrzykiwanie i wykonywanie szablonÃ³w lub wyraÅ¼eÅ„.

**PrzykÅ‚ad podatnego kodu:**
```jsx
import React from 'react';
import ejs from 'ejs';

function RenderTemplate({ template, data }) {
const html = ejs.render(template, data);
return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```
**Dlaczego jest podatne:** JeÅ›li `template` lub `data` zawiera zÅ‚oÅ›liwÄ… treÅ›Ä‡, moÅ¼e to prowadziÄ‡ do wykonania niezamierzonego kodu.

</details>

<details>

<summary>Przechodzenie po Å›cieÅ¼kach po stronie klienta</summary>

To podatnoÅ›Ä‡, ktÃ³ra pozwala atakujÄ…cym manipulowaÄ‡ Å›cieÅ¼kami po stronie klienta, aby wykonaÄ‡ niezamierzone dziaÅ‚ania, takie jak Cross-Site Request Forgery (CSRF). W przeciwieÅ„stwie do przechodzenia po Å›cieÅ¼kach po stronie serwera, ktÃ³re celuje w system plikÃ³w serwera, CSPT koncentruje siÄ™ na wykorzystywaniu mechanizmÃ³w po stronie klienta do przekierowywania legalnych Å¼Ä…daÅ„ API do zÅ‚oÅ›liwych punktÃ³w koÅ„cowych.

**PrzykÅ‚ad podatnego kodu:**

Aplikacja Next.js pozwala uÅ¼ytkownikom na przesyÅ‚anie i pobieranie plikÃ³w. Funkcja pobierania jest zaimplementowana po stronie klienta, gdzie uÅ¼ytkownicy mogÄ… okreÅ›liÄ‡ Å›cieÅ¼kÄ™ pliku do pobrania.
```jsx
// pages/download.js
import { useState } from 'react';

export default function DownloadPage() {
const [filePath, setFilePath] = useState('');

const handleDownload = () => {
fetch(`/api/files/${filePath}`)
.then(response => response.blob())
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filePath;
a.click();
});
};

return (
<div>
<h1>Download File</h1>
<input
type="text"
value={filePath}
onChange={(e) => setFilePath(e.target.value)}
placeholder="Enter file path"
/>
<button onClick={handleDownload}>Download</button>
</div>
);
}
```
#### Scenariusz Ataku

1. **Cel AtakujÄ…cego**: Wykonanie ataku CSRF w celu usuniÄ™cia krytycznego pliku (np. `admin/config.json`) poprzez manipulacjÄ™ `filePath`.
2. **Wykorzystanie CSPT**:
* **ZÅ‚oÅ›liwy Input**: AtakujÄ…cy tworzy URL z manipulowanym `filePath`, takim jak `../deleteFile/config.json`.
* **Wynikowe WywoÅ‚anie API**: Kod po stronie klienta wysyÅ‚a Å¼Ä…danie do `/api/files/../deleteFile/config.json`.
* **ObsÅ‚uga przez Serwer**: JeÅ›li serwer nie waliduje `filePath`, przetwarza Å¼Ä…danie, potencjalnie usuwajÄ…c lub ujawniajÄ…c wraÅ¼liwe pliki.
3. **Wykonanie CSRF**:
* **Stworzony Link**: AtakujÄ…cy wysyÅ‚a ofierze link lub osadza zÅ‚oÅ›liwy skrypt, ktÃ³ry wywoÅ‚uje Å¼Ä…danie pobrania z manipulowanym `filePath`.
* **Wynik**: Ofiara nieÅ›wiadomie wykonuje akcjÄ™, co prowadzi do nieautoryzowanego dostÄ™pu do plikÃ³w lub ich usuniÄ™cia.

#### Dlaczego Jest To WraÅ¼liwe

* **Brak Walidacji Inputu**: Po stronie klienta dozwolone sÄ… dowolne inputy `filePath`, co umoÅ¼liwia traversowanie Å›cieÅ¼ek.
* **Zaufanie do InputÃ³w Klienta**: API po stronie serwera ufa i przetwarza `filePath` bez sanitizacji.
* **Potencjalne Akcje API**: JeÅ›li punkt koÅ„cowy API wykonuje akcje zmieniajÄ…ce stan (np. usuwanie, modyfikowanie plikÃ³w), moÅ¼e byÄ‡ wykorzystywany za pomocÄ… CSPT.

</details>

## Po Stronie Serwera w Next.js

### Renderowanie Po Stronie Serwera (SSR)

Strony sÄ… renderowane na serwerze przy kaÅ¼dym Å¼Ä…daniu, zapewniajÄ…c, Å¼e uÅ¼ytkownik otrzymuje w peÅ‚ni renderowany HTML. W tym przypadku powinieneÅ› stworzyÄ‡ wÅ‚asny niestandardowy serwer do przetwarzania Å¼Ä…daÅ„.

**PrzykÅ‚ady Zastosowania:**

* Dynamiczna treÅ›Ä‡, ktÃ³ra czÄ™sto siÄ™ zmienia.
* Optymalizacja SEO, poniewaÅ¼ wyszukiwarki mogÄ… indeksowaÄ‡ w peÅ‚ni renderowanÄ… stronÄ™.

**Implementacja:**
```jsx
// pages/index.js
export async function getServerSideProps(context) {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data } };
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Static Site Generation (SSG)

Strony sÄ… wstÄ™pnie renderowane w czasie budowy, co skutkuje szybszym czasem Å‚adowania i zmniejszonym obciÄ…Å¼eniem serwera.

**Use Cases:**

* TreÅ›ci, ktÃ³re nie zmieniajÄ… siÄ™ czÄ™sto.
* Blogi, dokumentacja, strony marketingowe.

**Implementation:**
```jsx
// pages/index.js
export async function getStaticProps() {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data }, revalidate: 60 }; // Revalidate every 60 seconds
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Serverless Functions (API Routes)

Next.js umoÅ¼liwia tworzenie punktÃ³w koÅ„cowych API jako funkcji bezserwerowych. Te funkcje dziaÅ‚ajÄ… na Å¼Ä…danie bez potrzeby posiadania dedykowanego serwera.

**Use Cases:**

* ObsÅ‚uga przesyÅ‚ania formularzy.
* Interakcja z bazami danych.
* Przetwarzanie danych lub integracja z zewnÄ™trznymi API.

**Implementation:**

Wraz z wprowadzeniem katalogu `app` w Next.js 13, routowanie i obsÅ‚uga API staÅ‚y siÄ™ bardziej elastyczne i potÄ™Å¼ne. To nowoczesne podejÅ›cie Å›ciÅ›le wspÃ³Å‚pracuje z systemem routingu opartym na plikach, ale wprowadza ulepszone moÅ¼liwoÅ›ci, w tym wsparcie dla komponentÃ³w serwerowych i klienckich.

#### Basic Route Handler

**File Structure:**
```go
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello/
â”‚           â””â”€â”€ route.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```javascript
// app/api/hello/route.js

export async function POST(request) {
return new Response(JSON.stringify({ message: 'Hello from App Router!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

// Client-side fetch to access the API endpoint
fetch('/api/submit', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'John Doe' }),
})
.then((res) => res.json())
.then((data) => console.log(data));
```
**WyjaÅ›nienie:**

* **Lokalizacja:** Trasy API znajdujÄ… siÄ™ w katalogu `app/api/`.
* **Nazewnictwo plikÃ³w:** KaÅ¼dy punkt koÅ„cowy API znajduje siÄ™ w swoim wÅ‚asnym folderze zawierajÄ…cym plik `route.js` lub `route.ts`.
* **Eksportowane funkcje:** Zamiast pojedynczego domyÅ›lnego eksportu, eksportowane sÄ… specyficzne funkcje metod HTTP (np. `GET`, `POST`).
* **ObsÅ‚uga odpowiedzi:** UÅ¼yj konstruktora `Response`, aby zwracaÄ‡ odpowiedzi, co pozwala na wiÄ™kszÄ… kontrolÄ™ nad nagÅ‚Ã³wkami i kodami statusu.

#### Jak obsÅ‚ugiwaÄ‡ inne Å›cieÅ¼ki i metody:

<details>

<summary>ObsÅ‚uga specyficznych metod HTTP</summary>



Next.js 13+ pozwala na definiowanie handlerÃ³w dla specyficznych metod HTTP w tym samym pliku `route.js` lub `route.ts`, co promuje jaÅ›niejszy i bardziej zorganizowany kod.

**PrzykÅ‚ad:**
```javascript
// app/api/users/[id]/route.js

export async function GET(request, { params }) {
const { id } = params;
// Fetch user data based on 'id'
return new Response(JSON.stringify({ userId: id, name: 'Jane Doe' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function PUT(request, { params }) {
const { id } = params;
// Update user data based on 'id'
return new Response(JSON.stringify({ message: `User ${id} updated.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function DELETE(request, { params }) {
const { id } = params;
// Delete user based on 'id'
return new Response(JSON.stringify({ message: `User ${id} deleted.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**WyjaÅ›nienie:**

* **Wielokrotne Eksporty:** KaÅ¼da metoda HTTP (`GET`, `PUT`, `DELETE`) ma swojÄ… wÅ‚asnÄ… funkcjÄ™ eksportowanÄ….
* **Parametry:** Drugi argument zapewnia dostÄ™p do parametrÃ³w trasy za pomocÄ… `params`.
* **Ulepszone Odpowiedzi:** WiÄ™ksza kontrola nad obiektami odpowiedzi, umoÅ¼liwiajÄ…ca precyzyjne zarzÄ…dzanie nagÅ‚Ã³wkami i kodami statusu.

</details>

<details>

<summary>Trasy Catch-All i ZagnieÅ¼dÅ¼one</summary>



Next.js 13+ obsÅ‚uguje zaawansowane funkcje routingu, takie jak trasy catch-all i zagnieÅ¼dÅ¼one trasy API, co pozwala na bardziej dynamiczne i skalowalne struktury API.

**PrzykÅ‚ad Trasy Catch-All:**
```javascript
// app/api/[...slug]/route.js

export async function GET(request, { params }) {
const { slug } = params;
// Handle dynamic nested routes
return new Response(JSON.stringify({ slug }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**WyjaÅ›nienie:**

* **SkÅ‚adnia:** `[...]` oznacza segment przechwytujÄ…cy, ktÃ³ry uchwyca wszystkie zagnieÅ¼dÅ¼one Å›cieÅ¼ki.
* **Zastosowanie:** Przydatne dla API, ktÃ³re muszÄ… obsÅ‚ugiwaÄ‡ rÃ³Å¼ne gÅ‚Ä™bokoÅ›ci tras lub dynamiczne segmenty.

**PrzykÅ‚ad zagnieÅ¼dÅ¼onych tras:**
```javascript
// app/api/posts/[postId]/comments/[commentId]/route.js

export async function GET(request, { params }) {
const { postId, commentId } = params;
// Fetch specific comment for a post
return new Response(JSON.stringify({ postId, commentId, comment: 'Great post!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**WyjaÅ›nienie:**

* **GÅ‚Ä™bokie zagnieÅ¼dÅ¼enie:** UmoÅ¼liwia hierarchiczne struktury API, odzwierciedlajÄ…ce relacje zasobÃ³w.
* **DostÄ™p do parametrÃ³w:** Åatwy dostÄ™p do wielu parametrÃ³w trasy za pomocÄ… obiektu `params`.

</details>

<details>

<summary>ObsÅ‚uga tras API w Next.js 12 i wczeÅ›niejszych wersjach</summary>

## Trasy API w katalogu `pages` (Next.js 12 i wczeÅ›niejsze)

Zanim Next.js 13 wprowadziÅ‚ katalog `app` i ulepszone moÅ¼liwoÅ›ci routingu, trasy API byÅ‚y gÅ‚Ã³wnie definiowane w katalogu `pages`. To podejÅ›cie jest nadal szeroko stosowane i wspierane w Next.js 12 i wczeÅ›niejszych wersjach.

#### Podstawowa trasa API

**Struktura plikÃ³w:**
```go
goCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```javascript
javascriptCopy code// pages/api/hello.js

export default function handler(req, res) {
res.status(200).json({ message: 'Hello, World!' });
}
```
**WyjaÅ›nienie:**

* **Lokalizacja:** Trasy API znajdujÄ… siÄ™ w katalogu `pages/api/`.
* **Eksport:** UÅ¼yj `export default`, aby zdefiniowaÄ‡ funkcjÄ™ obsÅ‚ugi.
* **Podpis funkcji:** Funkcja obsÅ‚ugi otrzymuje obiekty `req` (Å¼Ä…danie HTTP) i `res` (odpowiedÅº HTTP).
* **Routing:** Nazwa pliku (`hello.js`) odpowiada punktowi koÅ„cowemu `/api/hello`.

#### Dynamiczne trasy API

**Struktura plikÃ³w:**
```bash
bashCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ users/
â”‚           â””â”€â”€ [id].js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**WdroÅ¼enie:**
```javascript
javascriptCopy code// pages/api/users/[id].js

export default function handler(req, res) {
const {
query: { id },
method,
} = req;

switch (method) {
case 'GET':
// Fetch user data based on 'id'
res.status(200).json({ userId: id, name: 'John Doe' });
break;
case 'PUT':
// Update user data based on 'id'
res.status(200).json({ message: `User ${id} updated.` });
break;
case 'DELETE':
// Delete user based on 'id'
res.status(200).json({ message: `User ${id} deleted.` });
break;
default:
res.setHeader('Allow', ['GET', 'PUT', 'DELETE']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**WyjaÅ›nienie:**

* **Dynamiczne segmenty:** Kwadratowe nawiasy (`[id].js`) oznaczajÄ… dynamiczne segmenty tras.
* **DostÄ™p do parametrÃ³w:** UÅ¼yj `req.query.id`, aby uzyskaÄ‡ dostÄ™p do dynamicznego parametru.
* **ObsÅ‚uga metod:** Wykorzystaj logikÄ™ warunkowÄ… do obsÅ‚ugi rÃ³Å¼nych metod HTTP (`GET`, `PUT`, `DELETE` itp.).

#### ObsÅ‚uga rÃ³Å¼nych metod HTTP

Podczas gdy podstawowy przykÅ‚ad trasy API obsÅ‚uguje wszystkie metody HTTP w jednej funkcji, moÅ¼esz zorganizowaÄ‡ swÃ³j kod, aby obsÅ‚ugiwaÅ‚ kaÅ¼dÄ… metodÄ™ wyraÅºnie dla lepszej przejrzystoÅ›ci i Å‚atwoÅ›ci utrzymania.

**PrzykÅ‚ad:**
```javascript
javascriptCopy code// pages/api/posts.js

export default async function handler(req, res) {
const { method } = req;

switch (method) {
case 'GET':
// Handle GET request
res.status(200).json({ message: 'Fetching posts.' });
break;
case 'POST':
// Handle POST request
res.status(201).json({ message: 'Post created.' });
break;
default:
res.setHeader('Allow', ['GET', 'POST']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Najlepsze Praktyki:**

* **Separation of Concerns:** WyraÅºnie oddziel logikÄ™ dla rÃ³Å¼nych metod HTTP.
* **Response Consistency:** Zapewnij spÃ³jne struktury odpowiedzi dla Å‚atwiejszego obsÅ‚ugiwania po stronie klienta.
* **Error Handling:** Elegancko obsÅ‚uguj nieobsÅ‚ugiwane metody i nieoczekiwane bÅ‚Ä™dy.

</details>

### Konfiguracja CORS

Kontroluj, ktÃ³re ÅºrÃ³dÅ‚a mogÄ… uzyskiwaÄ‡ dostÄ™p do twoich tras API, Å‚agodzÄ…c luki w Cross-Origin Resource Sharing (CORS).

**ZÅ‚y PrzykÅ‚ad Konfiguracji:**
```javascript
// app/api/data/route.js

export async function GET(request) {
return new Response(JSON.stringify({ data: 'Public Data' }), {
status: 200,
headers: {
'Access-Control-Allow-Origin': '*', // Allows any origin
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
},
});
}
```
ZauwaÅ¼, Å¼e **CORS moÅ¼na rÃ³wnieÅ¼ skonfigurowaÄ‡ we wszystkich trasach API** w pliku **`middleware.ts`**:
```javascript
// app/middleware.ts

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
const allowedOrigins = ['https://yourdomain.com', 'https://sub.yourdomain.com'];
const origin = request.headers.get('Origin');

const response = NextResponse.next();

if (allowedOrigins.includes(origin || '')) {
response.headers.set('Access-Control-Allow-Origin', origin || '');
response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
// If credentials are needed:
// response.headers.set('Access-Control-Allow-Credentials', 'true');
}

// Handle preflight requests
if (request.method === 'OPTIONS') {
return new Response(null, {
status: 204,
headers: response.headers,
});
}

return response;
}

export const config = {
matcher: '/api/:path*', // Apply to all API routes
};

```
**Problem:**

* **`Access-Control-Allow-Origin: '*'`:** Zezwala kaÅ¼dej stronie na dostÄ™p do API, co potencjalnie umoÅ¼liwia zÅ‚oÅ›liwym stronom interakcjÄ™ z Twoim API bez ograniczeÅ„.
* **Szerokie zezwolenie na metody:** Zezwolenie na wszystkie metody moÅ¼e umoÅ¼liwiÄ‡ atakujÄ…cym wykonywanie niepoÅ¼Ä…danych dziaÅ‚aÅ„.

**Jak atakujÄ…cy to wykorzystujÄ…:**

AtakujÄ…cy mogÄ… tworzyÄ‡ zÅ‚oÅ›liwe strony, ktÃ³re wysyÅ‚ajÄ… Å¼Ä…dania do Twojego API, potencjalnie naduÅ¼ywajÄ…c funkcji takich jak pobieranie danych, manipulacja danymi lub wywoÅ‚ywanie niepoÅ¼Ä…danych dziaÅ‚aÅ„ w imieniu uwierzytelnionych uÅ¼ytkownikÃ³w.

{% content-ref url="../../pentesting-web/cors-bypass.md" %}
[cors-bypass.md](../../pentesting-web/cors-bypass.md)
{% endcontent-ref %}

## Ekspozycja kodu serwera po stronie klienta

Åatwo jest **uÅ¼yÄ‡ kodu uÅ¼ywanego przez serwer rÃ³wnieÅ¼ w kodzie eksponowanym i uÅ¼ywanym przez stronÄ™ klienta**, najlepszym sposobem na zapewnienie, Å¼e plik kodu nigdy nie jest eksponowany po stronie klienta, jest uÅ¼ycie tego importu na poczÄ…tku pliku:
```js
import "server-only";
```
## Kluczowe pliki i ich rola

### `middleware.ts` / `middleware.js`

**Lokalizacja:** KorzeÅ„ projektu lub w `src/`.

**Cel:** Wykonuje kod w funkcji serverless po stronie serwera przed przetworzeniem Å¼Ä…dania, umoÅ¼liwiajÄ…c takie zadania jak uwierzytelnianie, przekierowania lub modyfikowanie odpowiedzi.

**PrzepÅ‚yw wykonania:**

1. **PrzychodzÄ…ce Å¼Ä…danie:** Middleware przechwytuje Å¼Ä…danie.
2. **Przetwarzanie:** Wykonuje operacje na podstawie Å¼Ä…dania (np. sprawdzenie uwierzytelnienia).
3. **Modyfikacja odpowiedzi:** MoÅ¼e zmieniaÄ‡ odpowiedÅº lub przekazaÄ‡ kontrolÄ™ do nastÄ™pnego handlera.

**PrzykÅ‚ady zastosowaÅ„:**

* Przekierowywanie nieautoryzowanych uÅ¼ytkownikÃ³w.
* Dodawanie niestandardowych nagÅ‚Ã³wkÃ³w.
* Rejestrowanie Å¼Ä…daÅ„.

**PrzykÅ‚adowa konfiguracja:**
```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
const url = req.nextUrl.clone();
if (!req.cookies.has('token')) {
url.pathname = '/login';
return NextResponse.redirect(url);
}
return NextResponse.next();
}

export const config = {
matcher: ['/protected/:path*'],
};
```
### `next.config.js`

**Lokalizacja:** Root projektu.

**Cel:** Konfiguruje zachowanie Next.js, wÅ‚Ä…czajÄ…c lub wyÅ‚Ä…czajÄ…c funkcje, dostosowujÄ…c konfiguracje webpack, ustawiajÄ…c zmienne Å›rodowiskowe i konfigurowanie rÃ³Å¼nych funkcji zabezpieczeÅ„.

**Kluczowe konfiguracje zabezpieczeÅ„:**

<details>

<summary>NagÅ‚Ã³wki zabezpieczeÅ„</summary>

NagÅ‚Ã³wki zabezpieczeÅ„ zwiÄ™kszajÄ… bezpieczeÅ„stwo Twojej aplikacji, instruujÄ…c przeglÄ…darki, jak obsÅ‚ugiwaÄ‡ treÅ›ci. PomagajÄ… w Å‚agodzeniu rÃ³Å¼nych atakÃ³w, takich jak Cross-Site Scripting (XSS), Clickjacking i sniffing typu MIME:

* Content Security Policy (CSP)
* X-Frame-Options
* X-Content-Type-Options
* Strict-Transport-Security (HSTS)
* Referrer Policy

**PrzykÅ‚ady:**
```javascript
// next.config.js

module.exports = {
async headers() {
return [
{
source: '/(.*)', // Apply to all routes
headers: [
{
key: 'X-Frame-Options',
value: 'DENY',
},
{
key: 'Content-Security-Policy',
value: "default-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval';",
},
{
key: 'X-Content-Type-Options',
value: 'nosniff',
},
{
key: 'Strict-Transport-Security',
value: 'max-age=63072000; includeSubDomains; preload', // Enforces HTTPS
},
{
key: 'Referrer-Policy',
value: 'no-referrer', // Completely hides referrer
},
// Additional headers...
],
},
];
},
};
```
</details>

<details>

<summary>Ustawienia optymalizacji obrazÃ³w</summary>

Next.js optymalizuje obrazy pod kÄ…tem wydajnoÅ›ci, ale bÅ‚Ä™dne konfiguracje mogÄ… prowadziÄ‡ do luk w zabezpieczeniach, takich jak umoÅ¼liwienie nieufnym ÅºrÃ³dÅ‚om wstrzykiwania zÅ‚oÅ›liwej treÅ›ci.

**PrzykÅ‚ad zÅ‚ej konfiguracji:**
```javascript
// next.config.js

module.exports = {
images: {
domains: ['*'], // Allows images from any domain
},
};
```
**Problem:**

* **`'*'`:** Zezwala na Å‚adowanie obrazÃ³w z dowolnego zewnÄ™trznego ÅºrÃ³dÅ‚a, w tym z nieufnych lub zÅ‚oÅ›liwych domen. AtakujÄ…cy mogÄ… hostowaÄ‡ obrazy zawierajÄ…ce zÅ‚oÅ›liwe Å‚adunki lub treÅ›ci, ktÃ³re wprowadzajÄ… uÅ¼ytkownikÃ³w w bÅ‚Ä…d.
* Innym problemem moÅ¼e byÄ‡ zezwolenie na domenÄ™ **gdzie ktokolwiek moÅ¼e przesÅ‚aÄ‡ obraz** (jak `raw.githubusercontent.com`)

**How attackers abuse it:**

Poprzez wstrzykiwanie obrazÃ³w z zÅ‚oÅ›liwych ÅºrÃ³deÅ‚, atakujÄ…cy mogÄ… przeprowadzaÄ‡ ataki phishingowe, wyÅ›wietlaÄ‡ wprowadzajÄ…ce w bÅ‚Ä…d informacje lub wykorzystywaÄ‡ luki w bibliotekach renderujÄ…cych obrazy.

</details>

<details>

<summary>Exposure of Environment Variables</summary>

ZarzÄ…dzaj wraÅ¼liwymi informacjami, takimi jak klucze API i dane uwierzytelniajÄ…ce do bazy danych, w sposÃ³b bezpieczny, nie ujawniajÄ…c ich klientowi.

#### a. Ujawnianie WraÅ¼liwych Zmiennych

**ZÅ‚y PrzykÅ‚ad Konfiguracji:**
```javascript
// next.config.js

module.exports = {
env: {
SECRET_API_KEY: process.env.SECRET_API_KEY, // Exposed to the client
NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL, // Correctly prefixed for client
},
};
```
**Problem:**

* **`SECRET_API_KEY`:** Bez prefiksu `NEXT_PUBLIC_`, Next.js nie udostÄ™pnia zmiennych klientowi. Jednak, jeÅ›li przez pomyÅ‚kÄ™ zostanie dodany prefiks (np. `NEXT_PUBLIC_SECRET_API_KEY`), staje siÄ™ dostÄ™pny po stronie klienta.

**How attackers abuse it:**

JeÅ›li wraÅ¼liwe zmienne sÄ… udostÄ™pnione klientowi, atakujÄ…cy mogÄ… je odzyskaÄ‡, przeglÄ…dajÄ…c kod po stronie klienta lub Å¼Ä…dania sieciowe, uzyskujÄ…c nieautoryzowany dostÄ™p do API, baz danych lub innych usÅ‚ug.

</details>

<details>

<summary>Redirects</summary>

ZarzÄ…dzaj przekierowaniami URL i przepisywaniem w swojej aplikacji, zapewniajÄ…c, Å¼e uÅ¼ytkownicy sÄ… odpowiednio kierowani, nie wprowadzajÄ…c podatnoÅ›ci na otwarte przekierowania.

#### a. Open Redirect Vulnerability

**Bad Configuration Example:**
```javascript
// next.config.js

module.exports = {
async redirects() {
return [
{
source: '/redirect',
destination: (req) => req.query.url, // Dynamically redirects based on query parameter
permanent: false,
},
];
},
};
```
**Problem:**

* **Dynamic Destination:** UmoÅ¼liwia uÅ¼ytkownikom okreÅ›lenie dowolnego URL, co pozwala na ataki typu open redirect.
* **Zaufanie do danych wejÅ›ciowych uÅ¼ytkownika:** Przekierowania do URL podanych przez uÅ¼ytkownikÃ³w bez walidacji mogÄ… prowadziÄ‡ do phishingu, dystrybucji zÅ‚oÅ›liwego oprogramowania lub kradzieÅ¼y danych uwierzytelniajÄ…cych.

**Jak atakujÄ…cy to wykorzystujÄ…:**

AtakujÄ…cy mogÄ… tworzyÄ‡ URL, ktÃ³re wydajÄ… siÄ™ pochodziÄ‡ z twojej domeny, ale przekierowujÄ… uÅ¼ytkownikÃ³w na zÅ‚oÅ›liwe strony. Na przykÅ‚ad:
```bash
https://yourdomain.com/redirect?url=https://malicious-site.com
```
UÅ¼ytkownicy ufajÄ…cy oryginalnej domenie mogÄ… nieÅ›wiadomie przechodziÄ‡ do szkodliwych stron internetowych.

</details>

<details>

<summary>Konfiguracja Webpack</summary>

Dostosuj konfiguracje Webpack dla swojej aplikacji Next.js, ktÃ³re mogÄ… nieumyÅ›lnie wprowadzaÄ‡ luki w zabezpieczeniach, jeÅ›li nie sÄ… ostroÅ¼nie obsÅ‚ugiwane.

#### a. Ujawnianie wraÅ¼liwych moduÅ‚Ã³w

**ZÅ‚y przykÅ‚ad konfiguracji:**
```javascript
// next.config.js

module.exports = {
webpack: (config, { isServer }) => {
if (!isServer) {
config.resolve.alias['@sensitive'] = path.join(__dirname, 'secret-folder');
}
return config;
},
};
```
**Problem:**

* **Eksponowanie wraÅ¼liwych Å›cieÅ¼ek:** Aliasowanie wraÅ¼liwych katalogÃ³w i umoÅ¼liwienie dostÄ™pu po stronie klienta moÅ¼e prowadziÄ‡ do wycieku poufnych informacji.
* **Pakowanie sekretÃ³w:** JeÅ›li wraÅ¼liwe pliki sÄ… pakowane dla klienta, ich zawartoÅ›Ä‡ staje siÄ™ dostÄ™pna poprzez mapy ÅºrÃ³dÅ‚owe lub inspekcjÄ™ kodu po stronie klienta.

**How attackers abuse it:**

AtakujÄ…cy mogÄ… uzyskaÄ‡ dostÄ™p do struktury katalogÃ³w aplikacji lub jÄ… odtworzyÄ‡, potencjalnie znajdujÄ…c i wykorzystujÄ…c wraÅ¼liwe pliki lub dane.

</details>

### `pages/_app.js` i `pages/_document.js`

#### **`pages/_app.js`**

**Cel:** Nadpisuje domyÅ›lny komponent App, umoÅ¼liwiajÄ…c globalny stan, style i komponenty ukÅ‚adu.

**PrzykÅ‚ady uÅ¼ycia:**

* Wstrzykiwanie globalnego CSS.
* Dodawanie opakowaÅ„ ukÅ‚adu.
* Integracja bibliotek zarzÄ…dzania stanem.

**PrzykÅ‚ad:**
```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
return <Component {...pageProps} />;
}

export default MyApp;
```
#### **`pages/_document.js`**

**Cel:** Nadpisuje domyÅ›lny dokument, umoÅ¼liwiajÄ…c dostosowanie tagÃ³w HTML i Body.

**PrzykÅ‚ady uÅ¼ycia:**

* Modyfikacja tagÃ³w `<html>` lub `<body>`.
* Dodawanie tagÃ³w meta lub niestandardowych skryptÃ³w.
* Integracja czcionek zewnÄ™trznych.

**PrzykÅ‚ad:**
```jsx
// pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
render() {
return (
<Html lang="en">
<Head>
{/* Custom fonts or meta tags */}
</Head>
<body>
<Main />
<NextScript />
</body>
</Html>
);
}
}

export default MyDocument;
```
### Custom Server (Optional)

**Cel:** ChociaÅ¼ Next.js ma wbudowany serwer, moÅ¼esz stworzyÄ‡ wÅ‚asny serwer do zaawansowanych przypadkÃ³w uÅ¼ycia, takich jak niestandardowe routowanie lub integracja z istniejÄ…cymi usÅ‚ugami backendowymi.

**Uwaga:** UÅ¼ycie niestandardowego serwera moÅ¼e ograniczyÄ‡ opcje wdroÅ¼enia, szczegÃ³lnie na platformach takich jak Vercel, ktÃ³re optymalizujÄ… dla wbudowanego serwera Next.js.

**PrzykÅ‚ad:**
```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
const server = express();

// Custom route
server.get('/a', (req, res) => {
return app.render(req, res, '/a');
});

// Default handler
server.all('*', (req, res) => {
return handle(req, res);
});

server.listen(3000, (err) => {
if (err) throw err;
console.log('> Ready on http://localhost:3000');
});
});
```
***

## Dodatkowe rozwaÅ¼ania architektoniczne i bezpieczeÅ„stwa

### Zmienne Åšrodowiskowe i Konfiguracja

**Cel:** ZarzÄ…dzanie wraÅ¼liwymi informacjami i ustawieniami konfiguracyjnymi poza kodem.

**Najlepsze Praktyki:**

* **UÅ¼ywaj plikÃ³w `.env`:** Przechowuj zmienne, takie jak klucze API, w `.env.local` (wyÅ‚Ä…czone z kontroli wersji).
* **Bezpieczny dostÄ™p do zmiennych:** UÅ¼ywaj `process.env.VARIABLE_NAME`, aby uzyskaÄ‡ dostÄ™p do zmiennych Å›rodowiskowych.
* **Nigdy nie ujawniaj sekretÃ³w po stronie klienta:** Upewnij siÄ™, Å¼e wraÅ¼liwe zmienne sÄ… uÅ¼ywane tylko po stronie serwera.

**PrzykÅ‚ad:**
```javascript
// next.config.js
module.exports = {
env: {
API_KEY: process.env.API_KEY, // Accessible on both client and server
SECRET_KEY: process.env.SECRET_KEY, // Be cautious if accessible on the client
},
};
```
**Uwaga:** Aby ograniczyÄ‡ zmienne tylko do serwera, pomiÅ„ je z obiektu `env` lub poprzedÅº je prefiksem `NEXT_PUBLIC_` dla ekspozycji po stronie klienta.

### Uwierzytelnianie i autoryzacja

**PodejÅ›cie:**

* **Uwierzytelnianie oparte na sesji:** UÅ¼yj ciasteczek do zarzÄ…dzania sesjami uÅ¼ytkownikÃ³w.
* **Uwierzytelnianie oparte na tokenach:** WdraÅ¼aj JWT do stateless authentication.
* **Dostawcy zewnÄ™trzni:** Integruj siÄ™ z dostawcami OAuth (np. Google, GitHub) za pomocÄ… bibliotek takich jak `next-auth`.

**Praktyki bezpieczeÅ„stwa:**

* **Bezpieczne ciasteczka:** Ustaw atrybuty `HttpOnly`, `Secure` i `SameSite`.
* **Hashowanie haseÅ‚:** Zawsze haszuj hasÅ‚a przed ich przechowywaniem.
* **Walidacja danych wejÅ›ciowych:** Zapobiegaj atakom typu injection poprzez walidacjÄ™ i sanitizacjÄ™ danych wejÅ›ciowych.

**PrzykÅ‚ad:**
```javascript
// pages/api/login.js
import { sign } from 'jsonwebtoken';
import { serialize } from 'cookie';

export default async function handler(req, res) {
const { username, password } = req.body;

// Validate user credentials
if (username === 'admin' && password === 'password') {
const token = sign({ username }, process.env.JWT_SECRET, { expiresIn: '1h' });
res.setHeader('Set-Cookie', serialize('auth', token, { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }));
res.status(200).json({ message: 'Logged in' });
} else {
res.status(401).json({ error: 'Invalid credentials' });
}
}
```
### Optymalizacja WydajnoÅ›ci

**Strategie:**

* **Optymalizacja ObrazÃ³w:** UÅ¼yj komponentu `next/image` w Next.js do automatycznej optymalizacji obrazÃ³w.
* **PodziaÅ‚ Kodu:** Wykorzystaj dynamiczne importy do podziaÅ‚u kodu i zmniejszenia czasÃ³w Å‚adowania poczÄ…tkowego.
* **Cache:** WdroÅ¼ strategie cache dla odpowiedzi API i statycznych zasobÃ³w.
* **Åadowanie na Å»Ä…danie:** Åaduj komponenty lub zasoby tylko wtedy, gdy sÄ… potrzebne.

**PrzykÅ‚ad:**
```jsx
// Dynamic Import with Code Splitting
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('../components/HeavyComponent'), {
loading: () => <p>Loading...</p>,
});
```
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
