# NextJS

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Next.js åº”ç”¨ç¨‹åºçš„ä¸€èˆ¬æ¶æ„

### å…¸å‹æ–‡ä»¶ç»“æ„

ä¸€ä¸ªæ ‡å‡†çš„ Next.js é¡¹ç›®éµå¾ªç‰¹å®šçš„æ–‡ä»¶å’Œç›®å½•ç»“æ„ï¼Œä»¥ä¾¿äºå…¶è·¯ç”±ã€API ç«¯ç‚¹å’Œé™æ€èµ„äº§ç®¡ç†ç­‰åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„å¸ƒå±€ï¼š
```lua
my-nextjs-app/
â”œâ”€â”€ node_modules/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ logo.png
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ hello/
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â””â”€â”€ Footer.tsx
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â””â”€â”€ Home.module.css
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ .env.local
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ yarn.lock / package-lock.json

```
### æ ¸å¿ƒç›®å½•å’Œæ–‡ä»¶

* **public/:** æ‰˜ç®¡é™æ€èµ„äº§ï¼Œå¦‚å›¾åƒã€å­—ä½“å’Œå…¶ä»–æ–‡ä»¶ã€‚è¿™é‡Œçš„æ–‡ä»¶å¯ä»¥åœ¨æ ¹è·¯å¾„ (`/`) è®¿é—®ã€‚
* **app/:** åº”ç”¨ç¨‹åºé¡µé¢ã€å¸ƒå±€ã€ç»„ä»¶å’Œ API è·¯ç”±çš„ä¸­å¤®ç›®å½•ã€‚é‡‡ç”¨ **App Router** èŒƒå¼ï¼Œæ”¯æŒé«˜çº§è·¯ç”±åŠŸèƒ½å’ŒæœåŠ¡å™¨-å®¢æˆ·ç«¯ç»„ä»¶åˆ†ç¦»ã€‚
* **app/layout.tsx:** å®šä¹‰åº”ç”¨ç¨‹åºçš„æ ¹å¸ƒå±€ï¼ŒåŒ…è£¹æ‰€æœ‰é¡µé¢å¹¶æä¾›ä¸€è‡´çš„ UI å…ƒç´ ï¼Œå¦‚é¡µçœ‰ã€é¡µè„šå’Œå¯¼èˆªæ ã€‚
* **app/page.tsx:** ä½œä¸ºæ ¹è·¯ç”± `/` çš„å…¥å£ç‚¹ï¼Œæ¸²æŸ“ä¸»é¡µã€‚
* **app/\[route]/page.tsx:** å¤„ç†é™æ€å’ŒåŠ¨æ€è·¯ç”±ã€‚`app/` ä¸­çš„æ¯ä¸ªæ–‡ä»¶å¤¹ä»£è¡¨ä¸€ä¸ªè·¯ç”±æ®µï¼Œè€Œè¿™äº›æ–‡ä»¶å¤¹ä¸­çš„ `page.tsx` å¯¹åº”äºè¯¥è·¯ç”±çš„ç»„ä»¶ã€‚
* **app/api/:** åŒ…å« API è·¯ç”±ï¼Œå…è®¸æ‚¨åˆ›å»ºå¤„ç† HTTP è¯·æ±‚çš„æ— æœåŠ¡å™¨å‡½æ•°ã€‚è¿™äº›è·¯ç”±æ›¿ä»£äº†ä¼ ç»Ÿçš„ `pages/api` ç›®å½•ã€‚
* **app/components/:** å­˜æ”¾å¯é‡ç”¨çš„ React ç»„ä»¶ï¼Œå¯ä»¥åœ¨ä¸åŒé¡µé¢å’Œå¸ƒå±€ä¸­ä½¿ç”¨ã€‚
* **app/styles/:** åŒ…å«å…¨å±€ CSS æ–‡ä»¶å’Œç”¨äºç»„ä»¶èŒƒå›´æ ·å¼çš„ CSS æ¨¡å—ã€‚
* **app/utils/:** åŒ…å«å®ç”¨å‡½æ•°ã€è¾…åŠ©æ¨¡å—å’Œå…¶ä»–å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å…±äº«çš„é UI é€»è¾‘ã€‚
* **.env.local:** å­˜å‚¨ç‰¹å®šäºæœ¬åœ°å¼€å‘ç¯å¢ƒçš„ç¯å¢ƒå˜é‡ã€‚è¿™äº›å˜é‡ **ä¸** ä¼šæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚
* **next.config.js:** è‡ªå®šä¹‰ Next.js è¡Œä¸ºï¼ŒåŒ…æ‹¬ webpack é…ç½®ã€ç¯å¢ƒå˜é‡å’Œå®‰å…¨è®¾ç½®ã€‚
* **tsconfig.json:** é…ç½®é¡¹ç›®çš„ TypeScript è®¾ç½®ï¼Œå¯ç”¨ç±»å‹æ£€æŸ¥å’Œå…¶ä»– TypeScript åŠŸèƒ½ã€‚
* **package.json:** ç®¡ç†é¡¹ç›®ä¾èµ–ã€è„šæœ¬å’Œå…ƒæ•°æ®ã€‚
* **README.md:** æä¾›æœ‰å…³é¡¹ç›®çš„æ–‡æ¡£å’Œä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¾ç½®è¯´æ˜ã€ä½¿ç”¨æŒ‡å—å’Œå…¶ä»–ç›¸å…³ç»†èŠ‚ã€‚
* **yarn.lock / package-lock.json:** å°†é¡¹ç›®çš„ä¾èµ–é”å®šåˆ°ç‰¹å®šç‰ˆæœ¬ï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸­çš„ä¸€è‡´å®‰è£…ã€‚

## Next.js ä¸­çš„å®¢æˆ·ç«¯

### `app` ç›®å½•ä¸­çš„åŸºäºæ–‡ä»¶çš„è·¯ç”±

`app` ç›®å½•æ˜¯æœ€æ–° Next.js ç‰ˆæœ¬ä¸­è·¯ç”±çš„åŸºçŸ³ã€‚å®ƒåˆ©ç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å®šä¹‰è·¯ç”±ï¼Œä½¿è·¯ç”±ç®¡ç†ç›´è§‚ä¸”å¯æ‰©å±•ã€‚

<details>

<summary>å¤„ç†æ ¹è·¯å¾„ /</summary>

**æ–‡ä»¶ç»“æ„ï¼š**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**å…³é”®æ–‡ä»¶ï¼š**

* **`app/page.tsx`**ï¼šå¤„ç†å¯¹æ ¹è·¯å¾„ `/` çš„è¯·æ±‚ã€‚
* **`app/layout.tsx`**ï¼šå®šä¹‰åº”ç”¨ç¨‹åºçš„å¸ƒå±€ï¼ŒåŒ…è£¹æ‰€æœ‰é¡µé¢ã€‚

**å®ç°ï¼š**
```tsx
tsxCopy code// app/page.tsx

export default function HomePage() {
return (
<div>
<h1>Welcome to the Home Page!</h1>
<p>This is the root route.</p>
</div>
);
}
```
**è§£é‡Šï¼š**

* **è·¯ç”±å®šä¹‰ï¼š** `app` ç›®å½•ä¸‹çš„ `page.tsx` æ–‡ä»¶å¯¹åº”äº `/` è·¯ç”±ã€‚
* **æ¸²æŸ“ï¼š** è¯¥ç»„ä»¶æ¸²æŸ“ä¸»é¡µçš„å†…å®¹ã€‚
* **å¸ƒå±€é›†æˆï¼š** `HomePage` ç»„ä»¶è¢« `layout.tsx` åŒ…è£¹ï¼Œå¯ä»¥åŒ…å«å¤´éƒ¨ã€åº•éƒ¨å’Œå…¶ä»–å…¬å…±å…ƒç´ ã€‚

</details>

<details>

<summary>å¤„ç†å…¶ä»–é™æ€è·¯å¾„</summary>



**ç¤ºä¾‹ï¼š`/about` è·¯ç”±**

**æ–‡ä»¶ç»“æ„ï¼š**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**å®ç°ï¼š**
```tsx
// app/about/page.tsx

export default function AboutPage() {
return (
<div>
<h1>About Us</h1>
<p>Learn more about our mission and values.</p>
</div>
);
}
```
**è§£é‡Šï¼š**

* **è·¯ç”±å®šä¹‰ï¼š** `about` æ–‡ä»¶å¤¹ä¸­çš„ `page.tsx` æ–‡ä»¶å¯¹åº”äº `/about` è·¯ç”±ã€‚
* **æ¸²æŸ“ï¼š** è¯¥ç»„ä»¶æ¸²æŸ“å…³äºé¡µé¢çš„å†…å®¹ã€‚

</details>

<details>

<summary>åŠ¨æ€è·¯ç”±</summary>

åŠ¨æ€è·¯ç”±å…è®¸å¤„ç†å…·æœ‰å¯å˜æ®µçš„è·¯å¾„ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ ¹æ®å‚æ•°ï¼ˆå¦‚ IDã€slug ç­‰ï¼‰æ˜¾ç¤ºå†…å®¹ã€‚

**ç¤ºä¾‹ï¼š`/posts/[id]` è·¯ç”±**

**æ–‡ä»¶ç»“æ„ï¼š**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ posts/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**å®ç°ï¼š**
```tsx
tsxCopy code// app/posts/[id]/page.tsx

import { useRouter } from 'next/navigation';

interface PostProps {
params: { id: string };
}

export default function PostPage({ params }: PostProps) {
const { id } = params;
// Fetch post data based on 'id'

return (
<div>
<h1>Post #{id}</h1>
<p>This is the content of post {id}.</p>
</div>
);
}
```
**è§£é‡Šï¼š**

* **åŠ¨æ€æ®µï¼š** `[id]` è¡¨ç¤ºè·¯ç”±ä¸­çš„åŠ¨æ€æ®µï¼Œä» URL ä¸­æ•è· `id` å‚æ•°ã€‚
* **è®¿é—®å‚æ•°ï¼š** `params` å¯¹è±¡åŒ…å«åŠ¨æ€å‚æ•°ï¼Œå¯ä»¥åœ¨ç»„ä»¶å†…è®¿é—®ã€‚
* **è·¯ç”±åŒ¹é…ï¼š** ä»»ä½•åŒ¹é… `/posts/*` çš„è·¯å¾„ï¼Œä¾‹å¦‚ `/posts/1`ã€`/posts/abc` ç­‰ï¼Œå°†ç”±æ­¤ç»„ä»¶å¤„ç†ã€‚

</details>

<details>

<summary>åµŒå¥—è·¯ç”±</summary>



Next.js æ”¯æŒåµŒå¥—è·¯ç”±ï¼Œå…è®¸åˆ›å»ºä¸ç›®å½•ç»“æ„ç›¸å¯¹åº”çš„å±‚æ¬¡åŒ–è·¯ç”±ç»“æ„ã€‚

**ç¤ºä¾‹ï¼š`/dashboard/settings/profile` è·¯ç”±**

**æ–‡ä»¶ç»“æ„ï¼š**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ profile/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**å®ç°ï¼š**
```tsx
tsxCopy code// app/dashboard/settings/profile/page.tsx

export default function ProfileSettingsPage() {
return (
<div>
<h1>Profile Settings</h1>
<p>Manage your profile information here.</p>
</div>
);
}
```
**è§£é‡Šï¼š**

* **æ·±å±‚åµŒå¥—ï¼š** `dashboard/settings/profile/` ç›®å½•ä¸‹çš„ `page.tsx` æ–‡ä»¶å¯¹åº”äº `/dashboard/settings/profile` è·¯ç”±ã€‚
* **å±‚æ¬¡åæ˜ ï¼š** ç›®å½•ç»“æ„åæ˜ äº† URL è·¯å¾„ï¼Œå¢å¼ºäº†å¯ç»´æŠ¤æ€§å’Œæ¸…æ™°åº¦ã€‚

</details>

<details>

<summary>æ•è·æ‰€æœ‰è·¯ç”±</summary>

æ•è·æ‰€æœ‰è·¯ç”±å¤„ç†å¤šä¸ªåµŒå¥—æ®µæˆ–æœªçŸ¥è·¯å¾„ï¼Œæä¾›è·¯ç”±å¤„ç†çš„çµæ´»æ€§ã€‚

**ç¤ºä¾‹ï¼š`/*` è·¯ç”±**

**æ–‡ä»¶ç»“æ„ï¼š**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [..slug]/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**å®æ–½ï¼š**
```tsx
// app/[...slug]/page.tsx

interface CatchAllProps {
params: { slug: string[] };
}

export default function CatchAllPage({ params }: CatchAllProps) {
const { slug } = params;
const fullPath = `/${slug.join('/')}`;

return (
<div>
<h1>Catch-All Route</h1>
<p>You have navigated to: {fullPath}</p>
</div>
);
}
```
**è§£é‡Šï¼š**

* **Catch-All æ®µï¼š** `[...slug]` æ•è·æ‰€æœ‰å‰©ä½™çš„è·¯å¾„æ®µä½œä¸ºæ•°ç»„ã€‚
* **ç”¨æ³•ï¼š** é€‚ç”¨äºå¤„ç†åŠ¨æ€è·¯ç”±åœºæ™¯ï¼Œå¦‚ç”¨æˆ·ç”Ÿæˆçš„è·¯å¾„ã€åµŒå¥—ç±»åˆ«ç­‰ã€‚
* **è·¯ç”±åŒ¹é…ï¼š** åƒ `/anything/here`ã€`/foo/bar/baz` ç­‰è·¯å¾„ç”±æ­¤ç»„ä»¶å¤„ç†ã€‚

</details>

### æ½œåœ¨çš„å®¢æˆ·ç«¯æ¼æ´

è™½ç„¶ Next.js æä¾›äº†å®‰å…¨çš„åŸºç¡€ï¼Œä½†ä¸å½“çš„ç¼–ç å®è·µå¯èƒ½ä¼šå¼•å…¥æ¼æ´ã€‚å…³é”®çš„å®¢æˆ·ç«¯æ¼æ´åŒ…æ‹¬ï¼š

<details>

<summary>è·¨ç«™è„šæœ¬æ”»å‡» (XSS)</summary>

XSS æ”»å‡»å‘ç”Ÿåœ¨æ¶æ„è„šæœ¬è¢«æ³¨å…¥åˆ°å—ä¿¡ä»»çš„ç½‘ç«™æ—¶ã€‚æ”»å‡»è€…å¯ä»¥åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­æ‰§è¡Œè„šæœ¬ï¼Œçªƒå–æ•°æ®æˆ–ä»£è¡¨ç”¨æˆ·æ‰§è¡Œæ“ä½œã€‚

**æ˜“å—æ”»å‡»ä»£ç ç¤ºä¾‹ï¼š**
```jsx
// Dangerous: Injecting user input directly into HTML
function Comment({ userInput }) {
return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
}
```
**ä¸ºä»€ä¹ˆå®ƒå®¹æ˜“å—åˆ°æ”»å‡»ï¼š** ä½¿ç”¨ `dangerouslySetInnerHTML` å¤„ç†ä¸å—ä¿¡ä»»çš„è¾“å…¥å…è®¸æ”»å‡»è€…æ³¨å…¥æ¶æ„è„šæœ¬ã€‚

</details>

<details>

<summary>å®¢æˆ·ç«¯æ¨¡æ¿æ³¨å…¥</summary>

å½“ç”¨æˆ·è¾“å…¥åœ¨æ¨¡æ¿ä¸­å¤„ç†ä¸å½“æ—¶å‘ç”Ÿï¼Œå…è®¸æ”»å‡»è€…æ³¨å…¥å’Œæ‰§è¡Œæ¨¡æ¿æˆ–è¡¨è¾¾å¼ã€‚

**æ˜“å—æ”»å‡»ä»£ç ç¤ºä¾‹ï¼š**
```jsx
import React from 'react';
import ejs from 'ejs';

function RenderTemplate({ template, data }) {
const html = ejs.render(template, data);
return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```
**ä¸ºä»€ä¹ˆå®ƒå®¹æ˜“å—åˆ°æ”»å‡»ï¼š** å¦‚æœ `template` æˆ– `data` åŒ…å«æ¶æ„å†…å®¹ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–ä»£ç çš„æ‰§è¡Œã€‚

</details>

<details>

<summary>å®¢æˆ·ç«¯è·¯å¾„éå†</summary>

è¿™æ˜¯ä¸€ç§æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…æ“çºµå®¢æˆ·ç«¯è·¯å¾„ä»¥æ‰§è¡Œæ„å¤–æ“ä½œï¼Œä¾‹å¦‚è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰ã€‚ä¸é’ˆå¯¹æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿçš„æœåŠ¡å™¨ç«¯è·¯å¾„éå†ä¸åŒï¼ŒCSPT ä¾§é‡äºåˆ©ç”¨å®¢æˆ·ç«¯æœºåˆ¶å°†åˆæ³•çš„ API è¯·æ±‚é‡å®šå‘åˆ°æ¶æ„ç«¯ç‚¹ã€‚

**æ˜“å—æ”»å‡»ä»£ç ç¤ºä¾‹ï¼š**

ä¸€ä¸ª Next.js åº”ç”¨ç¨‹åºå…è®¸ç”¨æˆ·ä¸Šä¼ å’Œä¸‹è½½æ–‡ä»¶ã€‚ä¸‹è½½åŠŸèƒ½åœ¨å®¢æˆ·ç«¯å®ç°ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šè¦ä¸‹è½½çš„æ–‡ä»¶è·¯å¾„ã€‚
```jsx
// pages/download.js
import { useState } from 'react';

export default function DownloadPage() {
const [filePath, setFilePath] = useState('');

const handleDownload = () => {
fetch(`/api/files/${filePath}`)
.then(response => response.blob())
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filePath;
a.click();
});
};

return (
<div>
<h1>Download File</h1>
<input
type="text"
value={filePath}
onChange={(e) => setFilePath(e.target.value)}
placeholder="Enter file path"
/>
<button onClick={handleDownload}>Download</button>
</div>
);
}
```
#### æ”»å‡»åœºæ™¯

1. **æ”»å‡»è€…çš„ç›®æ ‡**ï¼šé€šè¿‡æ“çºµ `filePath` æ‰§è¡Œ CSRF æ”»å‡»ä»¥åˆ é™¤å…³é”®æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ`admin/config.json`ï¼‰ã€‚
2. **åˆ©ç”¨ CSPT**ï¼š
* **æ¶æ„è¾“å…¥**ï¼šæ”»å‡»è€…æ„é€ ä¸€ä¸ªå¸¦æœ‰æ“çºµçš„ `filePath` çš„ URLï¼Œä¾‹å¦‚ `../deleteFile/config.json`ã€‚
* **ç»“æœ API è°ƒç”¨**ï¼šå®¢æˆ·ç«¯ä»£ç å‘ `/api/files/../deleteFile/config.json` å‘å‡ºè¯·æ±‚ã€‚
* **æœåŠ¡å™¨çš„å¤„ç†**ï¼šå¦‚æœæœåŠ¡å™¨ä¸éªŒè¯ `filePath`ï¼Œåˆ™ä¼šå¤„ç†è¯¥è¯·æ±‚ï¼Œå¯èƒ½ä¼šåˆ é™¤æˆ–æš´éœ²æ•æ„Ÿæ–‡ä»¶ã€‚
3. **æ‰§è¡Œ CSRF**ï¼š
* **æ„é€ çš„é“¾æ¥**ï¼šæ”»å‡»è€…å‘å—å®³è€…å‘é€ä¸€ä¸ªé“¾æ¥æˆ–åµŒå…¥ä¸€ä¸ªæ¶æ„è„šæœ¬ï¼Œè§¦å‘å¸¦æœ‰æ“çºµçš„ `filePath` çš„ä¸‹è½½è¯·æ±‚ã€‚
* **ç»“æœ**ï¼šå—å®³è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œè¯¥æ“ä½œï¼Œå¯¼è‡´æœªç»æˆæƒçš„æ–‡ä»¶è®¿é—®æˆ–åˆ é™¤ã€‚

#### ä¸ºä»€ä¹ˆå®ƒæ˜¯è„†å¼±çš„

* **ç¼ºä¹è¾“å…¥éªŒè¯**ï¼šå®¢æˆ·ç«¯å…è®¸ä»»æ„çš„ `filePath` è¾“å…¥ï¼Œä»è€Œå¯ç”¨è·¯å¾„éå†ã€‚
* **ä¿¡ä»»å®¢æˆ·ç«¯è¾“å…¥**ï¼šæœåŠ¡å™¨ç«¯ API ä¿¡ä»»å¹¶å¤„ç†æœªç»è¿‡æ¸…ç†çš„ `filePath`ã€‚
* **æ½œåœ¨çš„ API æ“ä½œ**ï¼šå¦‚æœ API ç«¯ç‚¹æ‰§è¡ŒçŠ¶æ€æ›´æ”¹æ“ä½œï¼ˆä¾‹å¦‚ï¼Œåˆ é™¤ã€ä¿®æ”¹æ–‡ä»¶ï¼‰ï¼Œåˆ™å¯èƒ½é€šè¿‡ CSPT è¢«åˆ©ç”¨ã€‚

</details>

## Next.js ä¸­çš„æœåŠ¡å™¨ç«¯

### æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)

é¡µé¢åœ¨æ¯ä¸ªè¯·æ±‚æ—¶åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ï¼Œç¡®ä¿ç”¨æˆ·æ¥æ”¶åˆ°å®Œå…¨æ¸²æŸ“çš„ HTMLã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥åˆ›å»ºè‡ªå·±çš„è‡ªå®šä¹‰æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚

**ç”¨ä¾‹ï¼š**

* ç»å¸¸å˜åŒ–çš„åŠ¨æ€å†…å®¹ã€‚
* SEO ä¼˜åŒ–ï¼Œå› ä¸ºæœç´¢å¼•æ“å¯ä»¥æŠ“å–å®Œå…¨æ¸²æŸ“çš„é¡µé¢ã€‚

**å®ç°ï¼š**
```jsx
// pages/index.js
export async function getServerSideProps(context) {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data } };
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### é™æ€ç½‘ç«™ç”Ÿæˆ (SSG)

é¡µé¢åœ¨æ„å»ºæ—¶é¢„æ¸²æŸ“ï¼Œä»è€Œå®ç°æ›´å¿«çš„åŠ è½½æ—¶é—´å’Œå‡å°‘æœåŠ¡å™¨è´Ÿè½½ã€‚

**ç”¨ä¾‹ï¼š**

* ä¸ç»å¸¸æ›´æ”¹çš„å†…å®¹ã€‚
* åšå®¢ã€æ–‡æ¡£ã€è¥é”€é¡µé¢ã€‚

**å®ç°ï¼š**
```jsx
// pages/index.js
export async function getStaticProps() {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data }, revalidate: 60 }; // Revalidate every 60 seconds
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Serverless Functions (API Routes)

Next.js å…è®¸åˆ›å»ºä½œä¸ºæ— æœåŠ¡å™¨å‡½æ•°çš„ API ç«¯ç‚¹ã€‚è¿™äº›å‡½æ•°æŒ‰éœ€è¿è¡Œï¼Œæ— éœ€ä¸“ç”¨æœåŠ¡å™¨ã€‚

**ç”¨ä¾‹ï¼š**

* å¤„ç†è¡¨å•æäº¤ã€‚
* ä¸æ•°æ®åº“äº¤äº’ã€‚
* å¤„ç†æ•°æ®æˆ–ä¸ç¬¬ä¸‰æ–¹ API é›†æˆã€‚

**å®ç°ï¼š**

éšç€ Next.js 13 ä¸­ `app` ç›®å½•çš„å¼•å…¥ï¼Œè·¯ç”±å’Œ API å¤„ç†å˜å¾—æ›´åŠ çµæ´»å’Œå¼ºå¤§ã€‚è¿™ç§ç°ä»£æ–¹æ³•ä¸åŸºäºæ–‡ä»¶çš„è·¯ç”±ç³»ç»Ÿç´§å¯†å¯¹é½ï¼Œä½†å¼•å…¥äº†å¢å¼ºçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯¹æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç»„ä»¶çš„æ”¯æŒã€‚

#### åŸºæœ¬è·¯ç”±å¤„ç†ç¨‹åº

**æ–‡ä»¶ç»“æ„ï¼š**
```go
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello/
â”‚           â””â”€â”€ route.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**å®ç°ï¼š**
```javascript
// app/api/hello/route.js

export async function POST(request) {
return new Response(JSON.stringify({ message: 'Hello from App Router!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

// Client-side fetch to access the API endpoint
fetch('/api/submit', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'John Doe' }),
})
.then((res) => res.json())
.then((data) => console.log(data));
```
**è§£é‡Šï¼š**

* **ä½ç½®ï¼š** API è·¯ç”±ä½äº `app/api/` ç›®å½•ä¸‹ã€‚
* **æ–‡ä»¶å‘½åï¼š** æ¯ä¸ª API ç«¯ç‚¹éƒ½æœ‰è‡ªå·±çš„æ–‡ä»¶å¤¹ï¼ŒåŒ…å«ä¸€ä¸ª `route.js` æˆ– `route.ts` æ–‡ä»¶ã€‚
* **å¯¼å‡ºå‡½æ•°ï¼š** ä¸å†æ˜¯å•ä¸€çš„é»˜è®¤å¯¼å‡ºï¼Œè€Œæ˜¯å¯¼å‡ºç‰¹å®šçš„ HTTP æ–¹æ³•å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œ`GET`ã€`POST`ï¼‰ã€‚
* **å“åº”å¤„ç†ï¼š** ä½¿ç”¨ `Response` æ„é€ å‡½æ•°è¿”å›å“åº”ï¼Œä»è€Œæ›´å¥½åœ°æ§åˆ¶å¤´éƒ¨å’ŒçŠ¶æ€ç ã€‚

#### å¦‚ä½•å¤„ç†å…¶ä»–è·¯å¾„å’Œæ–¹æ³•ï¼š

<details>

<summary>å¤„ç†ç‰¹å®šçš„ HTTP æ–¹æ³•</summary>



Next.js 13+ å…è®¸æ‚¨åœ¨åŒä¸€ä¸ª `route.js` æˆ– `route.ts` æ–‡ä»¶ä¸­å®šä¹‰ç‰¹å®š HTTP æ–¹æ³•çš„å¤„ç†ç¨‹åºï¼Œä»è€Œä¿ƒè¿›æ›´æ¸…æ™°å’Œæ›´æœ‰ç»„ç»‡çš„ä»£ç ã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// app/api/users/[id]/route.js

export async function GET(request, { params }) {
const { id } = params;
// Fetch user data based on 'id'
return new Response(JSON.stringify({ userId: id, name: 'Jane Doe' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function PUT(request, { params }) {
const { id } = params;
// Update user data based on 'id'
return new Response(JSON.stringify({ message: `User ${id} updated.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function DELETE(request, { params }) {
const { id } = params;
// Delete user based on 'id'
return new Response(JSON.stringify({ message: `User ${id} deleted.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**è§£é‡Šï¼š**

* **å¤šä¸ªå¯¼å‡ºï¼š** æ¯ä¸ª HTTP æ–¹æ³•ï¼ˆ`GET`ï¼Œ`PUT`ï¼Œ`DELETE`ï¼‰éƒ½æœ‰å…¶è‡ªå·±çš„å¯¼å‡ºå‡½æ•°ã€‚
* **å‚æ•°ï¼š** ç¬¬äºŒä¸ªå‚æ•°é€šè¿‡ `params` æä¾›å¯¹è·¯ç”±å‚æ•°çš„è®¿é—®ã€‚
* **å¢å¼ºå“åº”ï¼š** æ›´å¥½åœ°æ§åˆ¶å“åº”å¯¹è±¡ï¼Œå®ç°ç²¾ç¡®çš„å¤´éƒ¨å’ŒçŠ¶æ€ç ç®¡ç†ã€‚

</details>

<details>

<summary>æ•è·æ‰€æœ‰å’ŒåµŒå¥—è·¯ç”±</summary>



Next.js 13+ æ”¯æŒé«˜çº§è·¯ç”±åŠŸèƒ½ï¼Œå¦‚æ•è·æ‰€æœ‰è·¯ç”±å’ŒåµŒå¥— API è·¯ç”±ï¼Œå…è®¸æ›´åŠ¨æ€å’Œå¯æ‰©å±•çš„ API ç»“æ„ã€‚

**æ•è·æ‰€æœ‰è·¯ç”±ç¤ºä¾‹ï¼š**
```javascript
// app/api/[...slug]/route.js

export async function GET(request, { params }) {
const { slug } = params;
// Handle dynamic nested routes
return new Response(JSON.stringify({ slug }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**è§£é‡Šï¼š**

* **è¯­æ³•ï¼š** `[...]` è¡¨ç¤ºä¸€ä¸ªæ•è·æ‰€æœ‰æ®µçš„é€šç”¨éƒ¨åˆ†ï¼Œæ•è·æ‰€æœ‰åµŒå¥—è·¯å¾„ã€‚
* **ç”¨æ³•ï¼š** å¯¹äºéœ€è¦å¤„ç†ä¸åŒè·¯ç”±æ·±åº¦æˆ–åŠ¨æ€æ®µçš„ API å¾ˆæœ‰ç”¨ã€‚

**åµŒå¥—è·¯ç”±ç¤ºä¾‹ï¼š**
```javascript
// app/api/posts/[postId]/comments/[commentId]/route.js

export async function GET(request, { params }) {
const { postId, commentId } = params;
// Fetch specific comment for a post
return new Response(JSON.stringify({ postId, commentId, comment: 'Great post!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**è§£é‡Šï¼š**

* **æ·±å±‚åµŒå¥—ï¼š** å…è®¸å±‚æ¬¡åŒ–çš„APIç»“æ„ï¼Œåæ˜ èµ„æºå…³ç³»ã€‚
* **å‚æ•°è®¿é—®ï¼š** é€šè¿‡`params`å¯¹è±¡è½»æ¾è®¿é—®å¤šä¸ªè·¯ç”±å‚æ•°ã€‚

</details>

<details>

<summary>åœ¨Next.js 12åŠæ›´æ—©ç‰ˆæœ¬ä¸­å¤„ç†APIè·¯ç”±</summary>

## `pages`ç›®å½•ä¸­çš„APIè·¯ç”±ï¼ˆNext.js 12åŠæ›´æ—©ç‰ˆæœ¬ï¼‰

åœ¨Next.js 13å¼•å…¥`app`ç›®å½•å¹¶å¢å¼ºè·¯ç”±åŠŸèƒ½ä¹‹å‰ï¼ŒAPIè·¯ç”±ä¸»è¦å®šä¹‰åœ¨`pages`ç›®å½•ä¸­ã€‚è¿™ç§æ–¹æ³•åœ¨Next.js 12åŠæ›´æ—©ç‰ˆæœ¬ä¸­ä»ç„¶å¹¿æ³›ä½¿ç”¨å’Œæ”¯æŒã€‚

#### åŸºæœ¬APIè·¯ç”±

**æ–‡ä»¶ç»“æ„ï¼š**
```go
goCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**å®æ–½ï¼š**
```javascript
javascriptCopy code// pages/api/hello.js

export default function handler(req, res) {
res.status(200).json({ message: 'Hello, World!' });
}
```
**è§£é‡Šï¼š**

* **ä½ç½®ï¼š** API è·¯ç”±ä½äº `pages/api/` ç›®å½•ä¸‹ã€‚
* **å¯¼å‡ºï¼š** ä½¿ç”¨ `export default` æ¥å®šä¹‰å¤„ç†å‡½æ•°ã€‚
* **å‡½æ•°ç­¾åï¼š** å¤„ç†å‡½æ•°æ¥æ”¶ `req`ï¼ˆHTTP è¯·æ±‚ï¼‰å’Œ `res`ï¼ˆHTTP å“åº”ï¼‰å¯¹è±¡ã€‚
* **è·¯ç”±ï¼š** æ–‡ä»¶åï¼ˆ`hello.js`ï¼‰æ˜ å°„åˆ°ç«¯ç‚¹ `/api/hello`ã€‚

#### åŠ¨æ€ API è·¯ç”±

**æ–‡ä»¶ç»“æ„ï¼š**
```bash
bashCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ users/
â”‚           â””â”€â”€ [id].js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**å®ç°ï¼š**
```javascript
javascriptCopy code// pages/api/users/[id].js

export default function handler(req, res) {
const {
query: { id },
method,
} = req;

switch (method) {
case 'GET':
// Fetch user data based on 'id'
res.status(200).json({ userId: id, name: 'John Doe' });
break;
case 'PUT':
// Update user data based on 'id'
res.status(200).json({ message: `User ${id} updated.` });
break;
case 'DELETE':
// Delete user based on 'id'
res.status(200).json({ message: `User ${id} deleted.` });
break;
default:
res.setHeader('Allow', ['GET', 'PUT', 'DELETE']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**è§£é‡Šï¼š**

* **åŠ¨æ€æ®µï¼š** æ–¹æ‹¬å·ï¼ˆ`[id].js`ï¼‰è¡¨ç¤ºåŠ¨æ€è·¯ç”±æ®µã€‚
* **è®¿é—®å‚æ•°ï¼š** ä½¿ç”¨ `req.query.id` è®¿é—®åŠ¨æ€å‚æ•°ã€‚
* **å¤„ç†æ–¹æ³•ï¼š** åˆ©ç”¨æ¡ä»¶é€»è¾‘å¤„ç†ä¸åŒçš„ HTTP æ–¹æ³•ï¼ˆ`GET`ã€`PUT`ã€`DELETE` ç­‰ï¼‰ã€‚

#### å¤„ç†ä¸åŒçš„ HTTP æ–¹æ³•

è™½ç„¶åŸºæœ¬çš„ API è·¯ç”±ç¤ºä¾‹åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¤„ç†æ‰€æœ‰ HTTP æ–¹æ³•ï¼Œä½†æ‚¨å¯ä»¥å°†ä»£ç ç»“æ„åŒ–ä¸ºæ˜ç¡®å¤„ç†æ¯ç§æ–¹æ³•ï¼Œä»¥æé«˜æ¸…æ™°åº¦å’Œå¯ç»´æŠ¤æ€§ã€‚

**ç¤ºä¾‹ï¼š**
```javascript
javascriptCopy code// pages/api/posts.js

export default async function handler(req, res) {
const { method } = req;

switch (method) {
case 'GET':
// Handle GET request
res.status(200).json({ message: 'Fetching posts.' });
break;
case 'POST':
// Handle POST request
res.status(201).json({ message: 'Post created.' });
break;
default:
res.setHeader('Allow', ['GET', 'POST']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**æœ€ä½³å®è·µï¼š**

* **å…³æ³¨ç‚¹åˆ†ç¦»ï¼š** æ¸…æ™°åœ°åˆ†ç¦»ä¸åŒHTTPæ–¹æ³•çš„é€»è¾‘ã€‚
* **å“åº”ä¸€è‡´æ€§ï¼š** ç¡®ä¿ä¸€è‡´çš„å“åº”ç»“æ„ï¼Œä»¥ä¾¿äºå®¢æˆ·ç«¯å¤„ç†ã€‚
* **é”™è¯¯å¤„ç†ï¼š** ä¼˜é›…åœ°å¤„ç†ä¸æ”¯æŒçš„æ–¹æ³•å’Œæ„å¤–é”™è¯¯ã€‚

</details>

### CORSé…ç½®

æ§åˆ¶å“ªäº›æ¥æºå¯ä»¥è®¿é—®æ‚¨çš„APIè·¯ç”±ï¼Œä»¥å‡è½»è·¨æºèµ„æºå…±äº«ï¼ˆCORSï¼‰æ¼æ´ã€‚

**é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**
```javascript
// app/api/data/route.js

export async function GET(request) {
return new Response(JSON.stringify({ data: 'Public Data' }), {
status: 200,
headers: {
'Access-Control-Allow-Origin': '*', // Allows any origin
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
},
});
}
```
æ³¨æ„ï¼Œ**CORS ä¹Ÿå¯ä»¥åœ¨æ‰€æœ‰ API è·¯ç”±ä¸­é…ç½®**ï¼Œä½äº **`middleware.ts`** æ–‡ä»¶å†…ï¼š
```javascript
// app/middleware.ts

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
const allowedOrigins = ['https://yourdomain.com', 'https://sub.yourdomain.com'];
const origin = request.headers.get('Origin');

const response = NextResponse.next();

if (allowedOrigins.includes(origin || '')) {
response.headers.set('Access-Control-Allow-Origin', origin || '');
response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
// If credentials are needed:
// response.headers.set('Access-Control-Allow-Credentials', 'true');
}

// Handle preflight requests
if (request.method === 'OPTIONS') {
return new Response(null, {
status: 204,
headers: response.headers,
});
}

return response;
}

export const config = {
matcher: '/api/:path*', // Apply to all API routes
};

```
**é—®é¢˜ï¼š**

* **`Access-Control-Allow-Origin: '*'`ï¼š** å…è®¸ä»»ä½•ç½‘ç«™è®¿é—®APIï¼Œå¯èƒ½å¯¼è‡´æ¶æ„ç½‘ç«™åœ¨æ²¡æœ‰é™åˆ¶çš„æƒ…å†µä¸‹ä¸æ‚¨çš„APIäº¤äº’ã€‚
* **å¹¿æ³›çš„æ–¹æ³•å…è®¸ï¼š** å…è®¸æ‰€æœ‰æ–¹æ³•å¯èƒ½ä½¿æ”»å‡»è€…æ‰§è¡Œä¸å¿…è¦çš„æ“ä½œã€‚

**æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

æ”»å‡»è€…å¯ä»¥æ„å»ºæ¶æ„ç½‘ç«™ï¼Œå‘æ‚¨çš„APIå‘é€è¯·æ±‚ï¼Œå¯èƒ½æ»¥ç”¨è¯¸å¦‚æ•°æ®æ£€ç´¢ã€æ•°æ®æ“ä½œæˆ–ä»£è¡¨ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·è§¦å‘ä¸å¿…è¦çš„æ“ä½œç­‰åŠŸèƒ½ã€‚

{% content-ref url="../../pentesting-web/cors-bypass.md" %}
[cors-bypass.md](../../pentesting-web/cors-bypass.md)
{% endcontent-ref %}

### å®¢æˆ·ç«¯çš„æœåŠ¡å™¨ä»£ç æš´éœ²

**åœ¨å®¢æˆ·ç«¯æš´éœ²å’Œä½¿ç”¨çš„ä»£ç ä¸­ä½¿ç”¨æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ˜¯å¾ˆå®¹æ˜“çš„**ï¼Œç¡®ä¿ä»£ç æ–‡ä»¶åœ¨å®¢æˆ·ç«¯ä»æœªæš´éœ²çš„æœ€ä½³æ–¹æ³•æ˜¯åœ¨æ–‡ä»¶å¼€å¤´ä½¿ç”¨æ­¤å¯¼å…¥ï¼š
```js
import "server-only";
```
## å…³é”®æ–‡ä»¶åŠå…¶è§’è‰²

### `middleware.ts` / `middleware.js`

**ä½ç½®ï¼š** é¡¹ç›®çš„æ ¹ç›®å½•æˆ– `src/` ä¸­ã€‚

**ç›®çš„ï¼š** åœ¨è¯·æ±‚å¤„ç†ä¹‹å‰ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ— æœåŠ¡å™¨å‡½æ•°ä¸­æ‰§è¡Œä»£ç ï¼Œå…è®¸è¿›è¡Œèº«ä»½éªŒè¯ã€é‡å®šå‘æˆ–ä¿®æ”¹å“åº”ç­‰ä»»åŠ¡ã€‚

**æ‰§è¡Œæµç¨‹ï¼š**

1. **ä¼ å…¥è¯·æ±‚ï¼š** ä¸­é—´ä»¶æ‹¦æˆªè¯·æ±‚ã€‚
2. **å¤„ç†ï¼š** æ ¹æ®è¯·æ±‚æ‰§è¡Œæ“ä½œï¼ˆä¾‹å¦‚ï¼Œæ£€æŸ¥èº«ä»½éªŒè¯ï¼‰ã€‚
3. **å“åº”ä¿®æ”¹ï¼š** å¯ä»¥æ›´æ”¹å“åº”æˆ–å°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚

**ç¤ºä¾‹ç”¨ä¾‹ï¼š**

* é‡å®šå‘æœªè®¤è¯ç”¨æˆ·ã€‚
* æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨ã€‚
* è®°å½•è¯·æ±‚ã€‚

**ç¤ºä¾‹é…ç½®ï¼š**
```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
const url = req.nextUrl.clone();
if (!req.cookies.has('token')) {
url.pathname = '/login';
return NextResponse.redirect(url);
}
return NextResponse.next();
}

export const config = {
matcher: ['/protected/:path*'],
};
```
### `next.config.js`

**ä½ç½®ï¼š** é¡¹ç›®çš„æ ¹ç›®å½•ã€‚

**ç›®çš„ï¼š** é…ç½® Next.js çš„è¡Œä¸ºï¼Œå¯ç”¨æˆ–ç¦ç”¨åŠŸèƒ½ï¼Œè‡ªå®šä¹‰ webpack é…ç½®ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¹¶é…ç½®å¤šä¸ªå®‰å…¨åŠŸèƒ½ã€‚

**å…³é”®å®‰å…¨é…ç½®ï¼š**

<details>

<summary>å®‰å…¨å¤´éƒ¨</summary>

å®‰å…¨å¤´éƒ¨é€šè¿‡æŒ‡ç¤ºæµè§ˆå™¨å¦‚ä½•å¤„ç†å†…å®¹æ¥å¢å¼ºåº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚å®ƒä»¬æœ‰åŠ©äºå‡è½»å„ç§æ”»å‡»ï¼Œå¦‚è·¨ç«™è„šæœ¬ (XSS)ã€ç‚¹å‡»åŠ«æŒå’Œ MIME ç±»å‹å—…æ¢ï¼š

* å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
* X-Frame-Options
* X-Content-Type-Options
* ä¸¥æ ¼ä¼ è¾“å®‰å…¨ (HSTS)
* å¼•ç”¨æ”¿ç­–

**ç¤ºä¾‹ï¼š**
```javascript
// next.config.js

module.exports = {
async headers() {
return [
{
source: '/(.*)', // Apply to all routes
headers: [
{
key: 'X-Frame-Options',
value: 'DENY',
},
{
key: 'Content-Security-Policy',
value: "default-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval';",
},
{
key: 'X-Content-Type-Options',
value: 'nosniff',
},
{
key: 'Strict-Transport-Security',
value: 'max-age=63072000; includeSubDomains; preload', // Enforces HTTPS
},
{
key: 'Referrer-Policy',
value: 'no-referrer', // Completely hides referrer
},
// Additional headers...
],
},
];
},
};
```
</details>

<details>

<summary>å›¾åƒä¼˜åŒ–è®¾ç½®</summary>

Next.js ä¸ºæ€§èƒ½ä¼˜åŒ–å›¾åƒï¼Œä½†é”™è¯¯é…ç½®å¯èƒ½å¯¼è‡´å®‰å…¨æ¼æ´ï¼Œä¾‹å¦‚å…è®¸ä¸å—ä¿¡ä»»çš„æ¥æºæ³¨å…¥æ¶æ„å†…å®¹ã€‚

**é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**
```javascript
// next.config.js

module.exports = {
images: {
domains: ['*'], // Allows images from any domain
},
};
```
**é—®é¢˜ï¼š**

* **`'*'`ï¼š** å…è®¸ä»ä»»ä½•å¤–éƒ¨æ¥æºåŠ è½½å›¾åƒï¼ŒåŒ…æ‹¬ä¸å—ä¿¡ä»»æˆ–æ¶æ„çš„åŸŸã€‚æ”»å‡»è€…å¯ä»¥æ‰˜ç®¡åŒ…å«æ¶æ„è´Ÿè½½æˆ–è¯¯å¯¼ç”¨æˆ·å†…å®¹çš„å›¾åƒã€‚
* å¦ä¸€ä¸ªé—®é¢˜å¯èƒ½æ˜¯å…è®¸ä¸€ä¸ª**ä»»ä½•äººéƒ½å¯ä»¥ä¸Šä¼ å›¾åƒçš„åŸŸ**ï¼ˆå¦‚ `raw.githubusercontent.com`ï¼‰

**æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

é€šè¿‡ä»æ¶æ„æ¥æºæ³¨å…¥å›¾åƒï¼Œæ”»å‡»è€…å¯ä»¥æ‰§è¡Œç½‘ç»œé’“é±¼æ”»å‡»ï¼Œæ˜¾ç¤ºè¯¯å¯¼æ€§ä¿¡æ¯ï¼Œæˆ–åˆ©ç”¨å›¾åƒæ¸²æŸ“åº“ä¸­çš„æ¼æ´ã€‚

</details>

<details>

<summary>ç¯å¢ƒå˜é‡æ³„éœ²</summary>

å®‰å…¨åœ°ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ API å¯†é’¥å’Œæ•°æ®åº“å‡­æ®ï¼Œè€Œä¸å°†å…¶æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

#### a. æ³„éœ²æ•æ„Ÿå˜é‡

**é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**
```javascript
// next.config.js

module.exports = {
env: {
SECRET_API_KEY: process.env.SECRET_API_KEY, // Exposed to the client
NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL, // Correctly prefixed for client
},
};
```
**é—®é¢˜ï¼š**

* **`SECRET_API_KEY`ï¼š** å¦‚æœæ²¡æœ‰ `NEXT_PUBLIC_` å‰ç¼€ï¼ŒNext.js ä¸ä¼šå°†å˜é‡æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚ç„¶è€Œï¼Œå¦‚æœé”™è¯¯åœ°æ·»åŠ äº†å‰ç¼€ï¼ˆä¾‹å¦‚ï¼Œ`NEXT_PUBLIC_SECRET_API_KEY`ï¼‰ï¼Œå®ƒå°†åœ¨å®¢æˆ·ç«¯å¯è®¿é—®ã€‚

**æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

å¦‚æœæ•æ„Ÿå˜é‡æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ£€æŸ¥å®¢æˆ·ç«¯ä»£ç æˆ–ç½‘ç»œè¯·æ±‚æ¥æ£€ç´¢å®ƒä»¬ï¼Œä»è€Œè·å¾—å¯¹ APIã€æ•°æ®åº“æˆ–å…¶ä»–æœåŠ¡çš„æœªæˆæƒè®¿é—®ã€‚

</details>

<details>

<summary>é‡å®šå‘</summary>

ç®¡ç†åº”ç”¨ç¨‹åºå†…çš„ URL é‡å®šå‘å’Œé‡å†™ï¼Œç¡®ä¿ç”¨æˆ·è¢«é€‚å½“åœ°å¼•å¯¼ï¼Œè€Œä¸ä¼šå¼•å…¥å¼€æ”¾é‡å®šå‘æ¼æ´ã€‚

#### a. å¼€æ”¾é‡å®šå‘æ¼æ´

**é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**
```javascript
// next.config.js

module.exports = {
async redirects() {
return [
{
source: '/redirect',
destination: (req) => req.query.url, // Dynamically redirects based on query parameter
permanent: false,
},
];
},
};
```
**é—®é¢˜ï¼š**

* **åŠ¨æ€ç›®æ ‡ï¼š** å…è®¸ç”¨æˆ·æŒ‡å®šä»»ä½• URLï¼Œä»è€Œå¯ç”¨å¼€æ”¾é‡å®šå‘æ”»å‡»ã€‚
* **ä¿¡ä»»ç”¨æˆ·è¾“å…¥ï¼š** åœ¨æ²¡æœ‰éªŒè¯çš„æƒ…å†µä¸‹é‡å®šå‘åˆ°ç”¨æˆ·æä¾›çš„ URL å¯èƒ½å¯¼è‡´ç½‘ç»œé’“é±¼ã€æ¶æ„è½¯ä»¶ä¼ æ’­æˆ–å‡­è¯ç›—çªƒã€‚

**æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

æ”»å‡»è€…å¯ä»¥æ„é€ çœ‹ä¼¼æ¥è‡ªæ‚¨åŸŸçš„ URLï¼Œä½†å°†ç”¨æˆ·é‡å®šå‘åˆ°æ¶æ„ç½‘ç«™ã€‚ä¾‹å¦‚ï¼š
```bash
https://yourdomain.com/redirect?url=https://malicious-site.com
```
ç”¨æˆ·ä¿¡ä»»åŸå§‹åŸŸåå¯èƒ½ä¼šä¸çŸ¥æƒ…åœ°è®¿é—®æœ‰å®³ç½‘ç«™ã€‚

</details>

<details>

<summary>Webpack é…ç½®</summary>

è‡ªå®šä¹‰ Next.js åº”ç”¨ç¨‹åºçš„ Webpack é…ç½®ï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šæ— æ„ä¸­å¼•å…¥å®‰å…¨æ¼æ´ã€‚

#### a. æš´éœ²æ•æ„Ÿæ¨¡å—

**é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**
```javascript
// next.config.js

module.exports = {
webpack: (config, { isServer }) => {
if (!isServer) {
config.resolve.alias['@sensitive'] = path.join(__dirname, 'secret-folder');
}
return config;
},
};
```
**é—®é¢˜ï¼š**

* **æš´éœ²æ•æ„Ÿè·¯å¾„ï¼š** åˆ«åæ•æ„Ÿç›®å½•å¹¶å…è®¸å®¢æˆ·ç«¯è®¿é—®å¯èƒ½ä¼šæ³„éœ²æœºå¯†ä¿¡æ¯ã€‚
* **æ†ç»‘ç§˜å¯†ï¼š** å¦‚æœæ•æ„Ÿæ–‡ä»¶è¢«æ†ç»‘ç»™å®¢æˆ·ç«¯ï¼Œå…¶å†…å®¹å¯ä»¥é€šè¿‡æºæ˜ å°„æˆ–æ£€æŸ¥å®¢æˆ·ç«¯ä»£ç è®¿é—®ã€‚

**æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨å®ƒï¼š**

æ”»å‡»è€…å¯ä»¥è®¿é—®æˆ–é‡å»ºåº”ç”¨ç¨‹åºçš„ç›®å½•ç»“æ„ï¼Œå¯èƒ½æ‰¾åˆ°å¹¶åˆ©ç”¨æ•æ„Ÿæ–‡ä»¶æˆ–æ•°æ®ã€‚

</details>

### `pages/_app.js` å’Œ `pages/_document.js`

#### **`pages/_app.js`**

**ç›®çš„ï¼š** é‡å†™é»˜è®¤çš„ App ç»„ä»¶ï¼Œå…è®¸å…¨å±€çŠ¶æ€ã€æ ·å¼å’Œå¸ƒå±€ç»„ä»¶ã€‚

**ç”¨ä¾‹ï¼š**

* æ³¨å…¥å…¨å±€ CSSã€‚
* æ·»åŠ å¸ƒå±€åŒ…è£…å™¨ã€‚
* é›†æˆçŠ¶æ€ç®¡ç†åº“ã€‚

**ç¤ºä¾‹ï¼š**
```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
return <Component {...pageProps} />;
}

export default MyApp;
```
#### **`pages/_document.js`**

**ç›®çš„ï¼š** é‡å†™é»˜è®¤æ–‡æ¡£ï¼Œå…è®¸è‡ªå®šä¹‰ HTML å’Œ Body æ ‡ç­¾ã€‚

**ä½¿ç”¨æ¡ˆä¾‹ï¼š**

* ä¿®æ”¹ `<html>` æˆ– `<body>` æ ‡ç­¾ã€‚
* æ·»åŠ å…ƒæ ‡ç­¾æˆ–è‡ªå®šä¹‰è„šæœ¬ã€‚
* é›†æˆç¬¬ä¸‰æ–¹å­—ä½“ã€‚

**ç¤ºä¾‹ï¼š**
```jsx
// pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
render() {
return (
<Html lang="en">
<Head>
{/* Custom fonts or meta tags */}
</Head>
<body>
<Main />
<NextScript />
</body>
</Html>
);
}
}

export default MyDocument;
```
### è‡ªå®šä¹‰æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰

**ç›®çš„ï¼š** è™½ç„¶ Next.js è‡ªå¸¦ä¸€ä¸ªå†…ç½®æœåŠ¡å™¨ï¼Œä½†æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æœåŠ¡å™¨ä»¥æ»¡è¶³é«˜çº§ç”¨ä¾‹ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è·¯ç”±æˆ–ä¸ç°æœ‰åç«¯æœåŠ¡é›†æˆã€‚

**æ³¨æ„ï¼š** ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡å™¨å¯èƒ½ä¼šé™åˆ¶éƒ¨ç½²é€‰é¡¹ï¼Œç‰¹åˆ«æ˜¯åœ¨åƒ Vercel è¿™æ ·ä¼˜åŒ– Next.js å†…ç½®æœåŠ¡å™¨çš„å¹³å°ä¸Šã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
const server = express();

// Custom route
server.get('/a', (req, res) => {
return app.render(req, res, '/a');
});

// Default handler
server.all('*', (req, res) => {
return handle(req, res);
});

server.listen(3000, (err) => {
if (err) throw err;
console.log('> Ready on http://localhost:3000');
});
});
```
***

## é¢å¤–çš„æ¶æ„å’Œå®‰å…¨è€ƒè™‘

### ç¯å¢ƒå˜é‡å’Œé…ç½®

**ç›®çš„ï¼š** åœ¨ä»£ç åº“ä¹‹å¤–ç®¡ç†æ•æ„Ÿä¿¡æ¯å’Œé…ç½®è®¾ç½®ã€‚

**æœ€ä½³å®è·µï¼š**

* **ä½¿ç”¨ `.env` æ–‡ä»¶ï¼š** å°† API å¯†é’¥ç­‰å˜é‡å­˜å‚¨åœ¨ `.env.local` ä¸­ï¼ˆä¸çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰ã€‚
* **å®‰å…¨è®¿é—®å˜é‡ï¼š** ä½¿ç”¨ `process.env.VARIABLE_NAME` è®¿é—®ç¯å¢ƒå˜é‡ã€‚
* **ç»ä¸è¦åœ¨å®¢æˆ·ç«¯æš´éœ²ç§˜å¯†ï¼š** ç¡®ä¿æ•æ„Ÿå˜é‡ä»…åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// next.config.js
module.exports = {
env: {
API_KEY: process.env.API_KEY, // Accessible on both client and server
SECRET_KEY: process.env.SECRET_KEY, // Be cautious if accessible on the client
},
};
```
**æ³¨æ„ï¼š** è¦å°†å˜é‡é™åˆ¶ä¸ºä»…æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼Œè¯·å°†å®ƒä»¬ä» `env` å¯¹è±¡ä¸­çœç•¥æˆ–ä½¿ç”¨ `NEXT_PUBLIC_` å‰ç¼€ä»¥ä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚

### è®¤è¯å’Œæˆæƒ

**æ–¹æ³•ï¼š**

* **åŸºäºä¼šè¯çš„è®¤è¯ï¼š** ä½¿ç”¨ cookies ç®¡ç†ç”¨æˆ·ä¼šè¯ã€‚
* **åŸºäºä»¤ç‰Œçš„è®¤è¯ï¼š** å®ç° JWT è¿›è¡Œæ— çŠ¶æ€è®¤è¯ã€‚
* **ç¬¬ä¸‰æ–¹æä¾›è€…ï¼š** ä½¿ç”¨ `next-auth` ç­‰åº“ä¸ OAuth æä¾›è€…ï¼ˆä¾‹å¦‚ï¼ŒGoogleã€GitHubï¼‰é›†æˆã€‚

**å®‰å…¨å®è·µï¼š**

* **å®‰å…¨ Cookiesï¼š** è®¾ç½® `HttpOnly`ã€`Secure` å’Œ `SameSite` å±æ€§ã€‚
* **å¯†ç å“ˆå¸Œï¼š** åœ¨å­˜å‚¨å¯†ç ä¹‹å‰å§‹ç»ˆè¿›è¡Œå“ˆå¸Œå¤„ç†ã€‚
* **è¾“å…¥éªŒè¯ï¼š** é€šè¿‡éªŒè¯å’Œæ¸…ç†è¾“å…¥æ¥é˜²æ­¢æ³¨å…¥æ”»å‡»ã€‚

**ç¤ºä¾‹ï¼š**
```javascript
// pages/api/login.js
import { sign } from 'jsonwebtoken';
import { serialize } from 'cookie';

export default async function handler(req, res) {
const { username, password } = req.body;

// Validate user credentials
if (username === 'admin' && password === 'password') {
const token = sign({ username }, process.env.JWT_SECRET, { expiresIn: '1h' });
res.setHeader('Set-Cookie', serialize('auth', token, { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }));
res.status(200).json({ message: 'Logged in' });
} else {
res.status(401).json({ error: 'Invalid credentials' });
}
}
```
### æ€§èƒ½ä¼˜åŒ–

**ç­–ç•¥ï¼š**

* **å›¾åƒä¼˜åŒ–ï¼š** ä½¿ç”¨ Next.js çš„ `next/image` ç»„ä»¶è¿›è¡Œè‡ªåŠ¨å›¾åƒä¼˜åŒ–ã€‚
* **ä»£ç åˆ†å‰²ï¼š** åˆ©ç”¨åŠ¨æ€å¯¼å…¥æ¥åˆ†å‰²ä»£ç å¹¶å‡å°‘åˆå§‹åŠ è½½æ—¶é—´ã€‚
* **ç¼“å­˜ï¼š** å®æ–½ API å“åº”å’Œé™æ€èµ„äº§çš„ç¼“å­˜ç­–ç•¥ã€‚
* **æ‡’åŠ è½½ï¼š** ä»…åœ¨éœ€è¦æ—¶åŠ è½½ç»„ä»¶æˆ–èµ„äº§ã€‚

**ç¤ºä¾‹ï¼š**
```jsx
// Dynamic Import with Code Splitting
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('../components/HeavyComponent'), {
loading: () => <p>Loading...</p>,
});
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
