# NextJS

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Arquitetura Geral de uma Aplica√ß√£o Next.js

### Estrutura de Arquivos T√≠pica

Um projeto padr√£o Next.js segue uma estrutura espec√≠fica de arquivos e diret√≥rios que facilita seus recursos, como roteamento, endpoints de API e gerenciamento de ativos est√°ticos. Aqui est√° um layout t√≠pico:
```lua
my-nextjs-app/
‚îú‚îÄ‚îÄ node_modules/
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo.png
‚îÇ   ‚îî‚îÄ‚îÄ favicon.ico
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hello/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ about/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Footer.tsx
‚îÇ   ‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Home.module.css
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ api.ts
‚îú‚îÄ‚îÄ .env.local
‚îú‚îÄ‚îÄ next.config.js
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ yarn.lock / package-lock.json

```
### Diret√≥rios e Arquivos Principais

* **public/:** Hospeda ativos est√°ticos, como imagens, fontes e outros arquivos. Os arquivos aqui s√£o acess√≠veis na raiz (`/`).
* **app/:** Diret√≥rio central para as p√°ginas, layouts, componentes e rotas da API da sua aplica√ß√£o. Abrange o paradigma **App Router**, permitindo recursos avan√ßados de roteamento e segrega√ß√£o de componentes servidor-cliente.
* **app/layout.tsx:** Define o layout raiz da sua aplica√ß√£o, envolvendo todas as p√°ginas e fornecendo elementos de UI consistentes, como cabe√ßalhos, rodap√©s e barras de navega√ß√£o.
* **app/page.tsx:** Serve como o ponto de entrada para a rota raiz `/`, renderizando a p√°gina inicial.
* **app/\[route]/page.tsx:** Lida com rotas est√°ticas e din√¢micas. Cada pasta dentro de `app/` representa um segmento de rota, e `page.tsx` dentro dessas pastas corresponde ao componente da rota.
* **app/api/:** Cont√©m rotas da API, permitindo que voc√™ crie fun√ß√µes serverless que lidam com requisi√ß√µes HTTP. Essas rotas substituem o diret√≥rio tradicional `pages/api`.
* **app/components/:** Abriga componentes React reutiliz√°veis que podem ser utilizados em diferentes p√°ginas e layouts.
* **app/styles/:** Cont√©m arquivos CSS globais e CSS Modules para estiliza√ß√£o com escopo de componente.
* **app/utils/:** Inclui fun√ß√µes utilit√°rias, m√≥dulos auxiliares e outras l√≥gicas n√£o relacionadas √† UI que podem ser compartilhadas pela aplica√ß√£o.
* **.env.local:** Armazena vari√°veis de ambiente espec√≠ficas para o ambiente de desenvolvimento local. Essas vari√°veis **n√£o** s√£o comprometidas no controle de vers√£o.
* **next.config.js:** Personaliza o comportamento do Next.js, incluindo configura√ß√µes do webpack, vari√°veis de ambiente e configura√ß√µes de seguran√ßa.
* **tsconfig.json:** Configura as defini√ß√µes do TypeScript para o projeto, habilitando verifica√ß√£o de tipos e outros recursos do TypeScript.
* **package.json:** Gerencia depend√™ncias do projeto, scripts e metadados.
* **README.md:** Fornece documenta√ß√£o e informa√ß√µes sobre o projeto, incluindo instru√ß√µes de configura√ß√£o, diretrizes de uso e outros detalhes relevantes.
* **yarn.lock / package-lock.json:** Bloqueia as depend√™ncias do projeto em vers√µes espec√≠ficas, garantindo instala√ß√µes consistentes em diferentes ambientes.

## Lado do Cliente no Next.js

### Roteamento Baseado em Arquivos no Diret√≥rio `app`

O diret√≥rio `app` √© a pedra angular do roteamento nas vers√µes mais recentes do Next.js. Ele aproveita o sistema de arquivos para definir rotas, tornando o gerenciamento de rotas intuitivo e escal√°vel.

<details>

<summary>Tratando o Caminho Raiz /</summary>

**Estrutura de Arquivos:**
```arduino
my-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ ...
```
**Arquivos Chave:**

* **`app/page.tsx`**: Manipula solicita√ß√µes para o caminho raiz `/`.
* **`app/layout.tsx`**: Define o layout para a aplica√ß√£o, envolvendo todas as p√°ginas.

**Implementa√ß√£o:**
```tsx
tsxCopy code// app/page.tsx

export default function HomePage() {
return (
<div>
<h1>Welcome to the Home Page!</h1>
<p>This is the root route.</p>
</div>
);
}
```
**Explica√ß√£o:**

* **Defini√ß√£o de Rota:** O arquivo `page.tsx` diretamente sob o diret√≥rio `app` corresponde √† rota `/`.
* **Renderiza√ß√£o:** Este componente renderiza o conte√∫do da p√°gina inicial.
* **Integra√ß√£o de Layout:** O componente `HomePage` √© envolto pelo `layout.tsx`, que pode incluir cabe√ßalhos, rodap√©s e outros elementos comuns.

</details>

<details>

<summary>Tratando Outros Caminhos Est√°ticos</summary>



**Exemplo: Rota `/about`**

**Estrutura de Arquivos:**
```arduino
arduinoCopy codemy-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ about/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```tsx
// app/about/page.tsx

export default function AboutPage() {
return (
<div>
<h1>About Us</h1>
<p>Learn more about our mission and values.</p>
</div>
);
}
```
**Explica√ß√£o:**

* **Defini√ß√£o de Rota:** O arquivo `page.tsx` dentro da pasta `about` corresponde √† rota `/about`.
* **Renderiza√ß√£o:** Este componente renderiza o conte√∫do da p√°gina sobre.

</details>

<details>

<summary>Rotas Din√¢micas</summary>

Rotas din√¢micas permitem o manuseio de caminhos com segmentos vari√°veis, permitindo que aplica√ß√µes exibam conte√∫do com base em par√¢metros como IDs, slugs, etc.

**Exemplo: Rota `/posts/[id]`**

**Estrutura de Arquivos:**
```arduino
arduinoCopy codemy-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ posts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```tsx
tsxCopy code// app/posts/[id]/page.tsx

import { useRouter } from 'next/navigation';

interface PostProps {
params: { id: string };
}

export default function PostPage({ params }: PostProps) {
const { id } = params;
// Fetch post data based on 'id'

return (
<div>
<h1>Post #{id}</h1>
<p>This is the content of post {id}.</p>
</div>
);
}
```
**Explica√ß√£o:**

* **Segmento Din√¢mico:** `[id]` denota um segmento din√¢mico na rota, capturando o par√¢metro `id` da URL.
* **Acessando Par√¢metros:** O objeto `params` cont√©m os par√¢metros din√¢micos, acess√≠veis dentro do componente.
* **Correspond√™ncia de Rota:** Qualquer caminho que corresponda a `/posts/*`, como `/posts/1`, `/posts/abc`, etc., ser√° tratado por este componente.

</details>

<details>

<summary>Rotas Aninhadas</summary>



Next.js suporta roteamento aninhado, permitindo estruturas de rotas hier√°rquicas que refletem o layout do diret√≥rio.

**Exemplo: Rota `/dashboard/settings/profile`**

**Estrutura de Arquivos:**
```arduino
arduinoCopy codemy-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```tsx
tsxCopy code// app/dashboard/settings/profile/page.tsx

export default function ProfileSettingsPage() {
return (
<div>
<h1>Profile Settings</h1>
<p>Manage your profile information here.</p>
</div>
);
}
```
**Explica√ß√£o:**

* **Aninhamento Profundo:** O arquivo `page.tsx` dentro de `dashboard/settings/profile/` corresponde √† rota `/dashboard/settings/profile`.
* **Reflex√£o de Hierarquia:** A estrutura de diret√≥rios reflete o caminho da URL, melhorando a manutenibilidade e clareza.

</details>

<details>

<summary>Rotas Catch-All</summary>

Rotas catch-all lidam com m√∫ltiplos segmentos aninhados ou caminhos desconhecidos, proporcionando flexibilidade no manuseio de rotas.

**Exemplo: Rota `/*`**

**Estrutura de Arquivos:**
```arduino
my-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ [..slug]/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```tsx
// app/[...slug]/page.tsx

interface CatchAllProps {
params: { slug: string[] };
}

export default function CatchAllPage({ params }: CatchAllProps) {
const { slug } = params;
const fullPath = `/${slug.join('/')}`;

return (
<div>
<h1>Catch-All Route</h1>
<p>You have navigated to: {fullPath}</p>
</div>
);
}
```
**Explica√ß√£o:**

* **Segmento Catch-All:** `[...slug]` captura todos os segmentos de caminho restantes como um array.
* **Uso:** √ötil para lidar com cen√°rios de roteamento din√¢mico, como caminhos gerados por usu√°rios, categorias aninhadas, etc.
* **Correspond√™ncia de Rota:** Caminhos como `/anything/here`, `/foo/bar/baz`, etc., s√£o tratados por este componente.

</details>

### Potenciais Vulnerabilidades do Lado do Cliente

Embora o Next.js forne√ßa uma base segura, pr√°ticas de codifica√ß√£o inadequadas podem introduzir vulnerabilidades. As principais vulnerabilidades do lado do cliente incluem:

<details>

<summary>Cross-Site Scripting (XSS)</summary>

Os ataques XSS ocorrem quando scripts maliciosos s√£o injetados em sites confi√°veis. Os atacantes podem executar scripts nos navegadores dos usu√°rios, roubando dados ou realizando a√ß√µes em nome do usu√°rio.

**Exemplo de C√≥digo Vulner√°vel:**
```jsx
// Dangerous: Injecting user input directly into HTML
function Comment({ userInput }) {
return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
}
```
**Por que √© vulner√°vel:** Usar `dangerouslySetInnerHTML` com entradas n√£o confi√°veis permite que atacantes injetem scripts maliciosos.

</details>

<details>

<summary>Inje√ß√£o de Template do Lado do Cliente</summary>

Ocorre quando as entradas do usu√°rio s√£o manipuladas de forma inadequada em templates, permitindo que atacantes injetem e executem templates ou express√µes.

**Exemplo de C√≥digo Vulner√°vel:**
```jsx
import React from 'react';
import ejs from 'ejs';

function RenderTemplate({ template, data }) {
const html = ejs.render(template, data);
return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```
**Por Que √â Vulner√°vel:** Se `template` ou `data` incluir conte√∫do malicioso, isso pode levar √† execu√ß√£o de c√≥digo n√£o intencionado.

</details>

<details>

<summary>Traversal de Caminho do Cliente</summary>

√â uma vulnerabilidade que permite que atacantes manipulem caminhos do lado do cliente para realizar a√ß√µes n√£o intencionais, como Cross-Site Request Forgery (CSRF). Ao contr√°rio do traversal de caminho do lado do servidor, que visa o sistema de arquivos do servidor, o CSPT foca em explorar mecanismos do lado do cliente para redirecionar solicita√ß√µes de API leg√≠timas para endpoints maliciosos.

**Exemplo de C√≥digo Vulner√°vel:**

Uma aplica√ß√£o Next.js permite que os usu√°rios fa√ßam upload e download de arquivos. O recurso de download √© implementado no lado do cliente, onde os usu√°rios podem especificar o caminho do arquivo a ser baixado.
```jsx
// pages/download.js
import { useState } from 'react';

export default function DownloadPage() {
const [filePath, setFilePath] = useState('');

const handleDownload = () => {
fetch(`/api/files/${filePath}`)
.then(response => response.blob())
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filePath;
a.click();
});
};

return (
<div>
<h1>Download File</h1>
<input
type="text"
value={filePath}
onChange={(e) => setFilePath(e.target.value)}
placeholder="Enter file path"
/>
<button onClick={handleDownload}>Download</button>
</div>
);
}
```
#### Cen√°rio de Ataque

1. **Objetivo do Atacante**: Realizar um ataque CSRF para deletar um arquivo cr√≠tico (por exemplo, `admin/config.json`) manipulando o `filePath`.
2. **Explorando CSPT**:
* **Entrada Maliciosa**: O atacante cria uma URL com um `filePath` manipulado, como `../deleteFile/config.json`.
* **Chamada de API Resultante**: O c√≥digo do lado do cliente faz uma solicita√ß√£o para `/api/files/../deleteFile/config.json`.
* **Tratamento do Servidor**: Se o servidor n√£o validar o `filePath`, ele processa a solicita√ß√£o, potencialmente deletando ou expondo arquivos sens√≠veis.
3. **Executando CSRF**:
* **Link Criado**: O atacante envia √† v√≠tima um link ou incorpora um script malicioso que aciona a solicita√ß√£o de download com o `filePath` manipulado.
* **Resultado**: A v√≠tima executa a a√ß√£o sem saber, levando ao acesso n√£o autorizado ou dele√ß√£o de arquivos.

#### Por Que √â Vulner√°vel

* **Falta de Valida√ß√£o de Entrada**: O lado do cliente permite entradas arbitr√°rias de `filePath`, possibilitando a travessia de caminho.
* **Confiando nas Entradas do Cliente**: A API do lado do servidor confia e processa o `filePath` sem sanitiza√ß√£o.
* **A√ß√µes Potenciais da API**: Se o endpoint da API realiza a√ß√µes que alteram o estado (por exemplo, deletar, modificar arquivos), pode ser explorado via CSPT.

</details>

## Lado do Servidor em Next.js

### Renderiza√ß√£o do Lado do Servidor (SSR)

As p√°ginas s√£o renderizadas no servidor a cada solicita√ß√£o, garantindo que o usu√°rio receba HTML totalmente renderizado. Neste caso, voc√™ deve criar seu pr√≥prio servidor personalizado para processar as solicita√ß√µes.

**Casos de Uso:**

* Conte√∫do din√¢mico que muda com frequ√™ncia.
* Otimiza√ß√£o de SEO, pois os motores de busca podem rastrear a p√°gina totalmente renderizada.

**Implementa√ß√£o:**
```jsx
// pages/index.js
export async function getServerSideProps(context) {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data } };
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Gera√ß√£o de Site Est√°tico (SSG)

As p√°ginas s√£o pr√©-renderizadas no momento da constru√ß√£o, resultando em tempos de carregamento mais r√°pidos e redu√ß√£o da carga no servidor.

**Casos de Uso:**

* Conte√∫do que n√£o muda com frequ√™ncia.
* Blogs, documenta√ß√£o, p√°ginas de marketing.

**Implementa√ß√£o:**
```jsx
// pages/index.js
export async function getStaticProps() {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data }, revalidate: 60 }; // Revalidate every 60 seconds
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Fun√ß√µes Serverless (Rotas de API)

Next.js permite a cria√ß√£o de endpoints de API como fun√ß√µes serverless. Essas fun√ß√µes s√£o executadas sob demanda, sem a necessidade de um servidor dedicado.

**Casos de Uso:**

* Manipula√ß√£o de envios de formul√°rios.
* Intera√ß√£o com bancos de dados.
* Processamento de dados ou integra√ß√£o com APIs de terceiros.

**Implementa√ß√£o:**

Com a introdu√ß√£o do diret√≥rio `app` no Next.js 13, o roteamento e o manuseio de API se tornaram mais flex√≠veis e poderosos. Essa abordagem moderna se alinha de perto com o sistema de roteamento baseado em arquivos, mas introduz capacidades aprimoradas, incluindo suporte para componentes de servidor e cliente.

#### Manipulador de Rota B√°sico

**Estrutura de Arquivos:**
```go
my-nextjs-app/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ hello/
‚îÇ           ‚îî‚îÄ‚îÄ route.js
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```javascript
// app/api/hello/route.js

export async function POST(request) {
return new Response(JSON.stringify({ message: 'Hello from App Router!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

// Client-side fetch to access the API endpoint
fetch('/api/submit', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'John Doe' }),
})
.then((res) => res.json())
.then((data) => console.log(data));
```
**Explica√ß√£o:**

* **Localiza√ß√£o:** As rotas da API est√£o localizadas no diret√≥rio `app/api/`.
* **Nomea√ß√£o de Arquivos:** Cada endpoint da API reside em sua pr√≥pria pasta contendo um arquivo `route.js` ou `route.ts`.
* **Fun√ß√µes Exportadas:** Em vez de uma √∫nica exporta√ß√£o padr√£o, fun√ß√µes espec√≠ficas de m√©todos HTTP (por exemplo, `GET`, `POST`) s√£o exportadas.
* **Manipula√ß√£o de Respostas:** Use o construtor `Response` para retornar respostas, permitindo mais controle sobre cabe√ßalhos e c√≥digos de status.

#### Como lidar com outros caminhos e m√©todos:

<details>

<summary>Manipulando M√©todos HTTP Espec√≠ficos</summary>



Next.js 13+ permite que voc√™ defina manipuladores para m√©todos HTTP espec√≠ficos dentro do mesmo arquivo `route.js` ou `route.ts`, promovendo um c√≥digo mais claro e organizado.

**Exemplo:**
```javascript
// app/api/users/[id]/route.js

export async function GET(request, { params }) {
const { id } = params;
// Fetch user data based on 'id'
return new Response(JSON.stringify({ userId: id, name: 'Jane Doe' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function PUT(request, { params }) {
const { id } = params;
// Update user data based on 'id'
return new Response(JSON.stringify({ message: `User ${id} updated.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function DELETE(request, { params }) {
const { id } = params;
// Delete user based on 'id'
return new Response(JSON.stringify({ message: `User ${id} deleted.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explica√ß√£o:**

* **M√∫ltiplas Exporta√ß√µes:** Cada m√©todo HTTP (`GET`, `PUT`, `DELETE`) tem sua pr√≥pria fun√ß√£o exportada.
* **Par√¢metros:** O segundo argumento fornece acesso aos par√¢metros de rota via `params`.
* **Respostas Aprimoradas:** Maior controle sobre objetos de resposta, permitindo gerenciamento preciso de cabe√ßalhos e c√≥digos de status.

</details>

<details>

<summary>Rotas Catch-All e Aninhadas</summary>



Next.js 13+ suporta recursos avan√ßados de roteamento, como rotas catch-all e rotas de API aninhadas, permitindo estruturas de API mais din√¢micas e escal√°veis.

**Exemplo de Rota Catch-All:**
```javascript
// app/api/[...slug]/route.js

export async function GET(request, { params }) {
const { slug } = params;
// Handle dynamic nested routes
return new Response(JSON.stringify({ slug }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explica√ß√£o:**

* **Sintaxe:** `[...]` denota um segmento que captura todos os caminhos aninhados.
* **Uso:** √ötil para APIs que precisam lidar com profundidades de rota variadas ou segmentos din√¢micos.

**Exemplo de Rotas Aninhadas:**
```javascript
// app/api/posts/[postId]/comments/[commentId]/route.js

export async function GET(request, { params }) {
const { postId, commentId } = params;
// Fetch specific comment for a post
return new Response(JSON.stringify({ postId, commentId, comment: 'Great post!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explica√ß√£o:**

* **Aninhamento Profundo:** Permite estruturas de API hier√°rquicas, refletindo relacionamentos de recursos.
* **Acesso a Par√¢metros:** Acesse facilmente m√∫ltiplos par√¢metros de rota via o objeto `params`.

</details>

<details>

<summary>Manipulando rotas de API no Next.js 12 e vers√µes anteriores</summary>

## Rotas de API no Diret√≥rio `pages` (Next.js 12 e vers√µes anteriores)

Antes que o Next.js 13 introduzisse o diret√≥rio `app` e melhorasse as capacidades de roteamento, as rotas de API eram definidas principalmente dentro do diret√≥rio `pages`. Essa abordagem ainda √© amplamente utilizada e suportada no Next.js 12 e vers√µes anteriores.

#### Rota de API B√°sica

**Estrutura de Arquivo:**
```go
goCopy codemy-nextjs-app/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ hello.js
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```javascript
javascriptCopy code// pages/api/hello.js

export default function handler(req, res) {
res.status(200).json({ message: 'Hello, World!' });
}
```
**Explica√ß√£o:**

* **Localiza√ß√£o:** As rotas da API residem no diret√≥rio `pages/api/`.
* **Exporta√ß√£o:** Use `export default` para definir a fun√ß√£o manipuladora.
* **Assinatura da Fun√ß√£o:** O manipulador recebe os objetos `req` (requisi√ß√£o HTTP) e `res` (resposta HTTP).
* **Roteamento:** O nome do arquivo (`hello.js`) mapeia para o endpoint `/api/hello`.

#### Rotas de API Din√¢micas

**Estrutura de Arquivo:**
```bash
bashCopy codemy-nextjs-app/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ users/
‚îÇ           ‚îî‚îÄ‚îÄ [id].js
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ...
```
**Implementa√ß√£o:**
```javascript
javascriptCopy code// pages/api/users/[id].js

export default function handler(req, res) {
const {
query: { id },
method,
} = req;

switch (method) {
case 'GET':
// Fetch user data based on 'id'
res.status(200).json({ userId: id, name: 'John Doe' });
break;
case 'PUT':
// Update user data based on 'id'
res.status(200).json({ message: `User ${id} updated.` });
break;
case 'DELETE':
// Delete user based on 'id'
res.status(200).json({ message: `User ${id} deleted.` });
break;
default:
res.setHeader('Allow', ['GET', 'PUT', 'DELETE']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Explica√ß√£o:**

* **Segmentos Din√¢micos:** Colchetes (`[id].js`) denotam segmentos de rota din√¢micos.
* **Acessando Par√¢metros:** Use `req.query.id` para acessar o par√¢metro din√¢mico.
* **Tratando M√©todos:** Utilize l√≥gica condicional para tratar diferentes m√©todos HTTP (`GET`, `PUT`, `DELETE`, etc.).

#### Tratando Diferentes M√©todos HTTP

Enquanto o exemplo b√°sico de rota de API trata todos os m√©todos HTTP dentro de uma √∫nica fun√ß√£o, voc√™ pode estruturar seu c√≥digo para tratar cada m√©todo explicitamente para melhor clareza e manutenibilidade.

**Exemplo:**
```javascript
javascriptCopy code// pages/api/posts.js

export default async function handler(req, res) {
const { method } = req;

switch (method) {
case 'GET':
// Handle GET request
res.status(200).json({ message: 'Fetching posts.' });
break;
case 'POST':
// Handle POST request
res.status(201).json({ message: 'Post created.' });
break;
default:
res.setHeader('Allow', ['GET', 'POST']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Melhores Pr√°ticas:**

* **Separa√ß√£o de Preocupa√ß√µes:** Separe claramente a l√≥gica para diferentes m√©todos HTTP.
* **Consist√™ncia de Resposta:** Garanta estruturas de resposta consistentes para facilitar o manuseio do lado do cliente.
* **Tratamento de Erros:** Lide graciosamente com m√©todos n√£o suportados e erros inesperados.

</details>

### Configura√ß√£o de CORS

Controle quais origens podem acessar suas rotas de API, mitigando vulnerabilidades de Cross-Origin Resource Sharing (CORS).

**Exemplo de Configura√ß√£o Ruim:**
```javascript
// app/api/data/route.js

export async function GET(request) {
return new Response(JSON.stringify({ data: 'Public Data' }), {
status: 200,
headers: {
'Access-Control-Allow-Origin': '*', // Allows any origin
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
},
});
}
```
Observe que **CORS tamb√©m pode ser configurado em todas as rotas da API** dentro do arquivo **`middleware.ts`**:
```javascript
// app/middleware.ts

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
const allowedOrigins = ['https://yourdomain.com', 'https://sub.yourdomain.com'];
const origin = request.headers.get('Origin');

const response = NextResponse.next();

if (allowedOrigins.includes(origin || '')) {
response.headers.set('Access-Control-Allow-Origin', origin || '');
response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
// If credentials are needed:
// response.headers.set('Access-Control-Allow-Credentials', 'true');
}

// Handle preflight requests
if (request.method === 'OPTIONS') {
return new Response(null, {
status: 204,
headers: response.headers,
});
}

return response;
}

export const config = {
matcher: '/api/:path*', // Apply to all API routes
};

```
**Problema:**

* **`Access-Control-Allow-Origin: '*'`:** Permite que qualquer site acesse a API, potencialmente permitindo que sites maliciosos interajam com sua API sem restri√ß√µes.
* **Ampla Permiss√£o de M√©todos:** Permitir todos os m√©todos pode permitir que atacantes realizem a√ß√µes indesejadas.

**Como os atacantes exploram isso:**

Os atacantes podem criar sites maliciosos que fazem solicita√ß√µes √† sua API, potencialmente abusando de funcionalidades como recupera√ß√£o de dados, manipula√ß√£o de dados ou acionamento de a√ß√µes indesejadas em nome de usu√°rios autenticados.

{% content-ref url="../../pentesting-web/cors-bypass.md" %}
[cors-bypass.md](../../pentesting-web/cors-bypass.md)
{% endcontent-ref %}

### Exposi√ß√£o de c√≥digo do servidor no lado do cliente

√â f√°cil **usar c√≥digo usado pelo servidor tamb√©m no c√≥digo exposto e usado pelo lado do cliente**, a melhor maneira de garantir que um arquivo de c√≥digo nunca seja exposto no lado do cliente √© usando esta importa√ß√£o no in√≠cio do arquivo:
```js
import "server-only";
```
## Arquivos Chave e Seus Pap√©is

### `middleware.ts` / `middleware.js`

**Localiza√ß√£o:** Raiz do projeto ou dentro de `src/`.

**Prop√≥sito:** Executa c√≥digo na fun√ß√£o serverless do lado do servidor antes que uma solicita√ß√£o seja processada, permitindo tarefas como autentica√ß√£o, redirecionamentos ou modifica√ß√£o de respostas.

**Fluxo de Execu√ß√£o:**

1. **Solicita√ß√£o de Entrada:** O middleware intercepta a solicita√ß√£o.
2. **Processamento:** Realiza opera√ß√µes com base na solicita√ß√£o (por exemplo, verificar autentica√ß√£o).
3. **Modifica√ß√£o da Resposta:** Pode alterar a resposta ou passar o controle para o pr√≥ximo manipulador.

**Casos de Uso Exemplares:**

* Redirecionando usu√°rios n√£o autenticados.
* Adicionando cabe√ßalhos personalizados.
* Registrando solicita√ß√µes.

**Configura√ß√£o de Exemplo:**
```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
const url = req.nextUrl.clone();
if (!req.cookies.has('token')) {
url.pathname = '/login';
return NextResponse.redirect(url);
}
return NextResponse.next();
}

export const config = {
matcher: ['/protected/:path*'],
};
```
### `next.config.js`

**Localiza√ß√£o:** Raiz do projeto.

**Prop√≥sito:** Configura o comportamento do Next.js, habilitando ou desabilitando recursos, personalizando configura√ß√µes do webpack, definindo vari√°veis de ambiente e configurando v√°rios recursos de seguran√ßa.

**Principais Configura√ß√µes de Seguran√ßa:**

<details>

<summary>Headers de Seguran√ßa</summary>

Headers de seguran√ßa aumentam a seguran√ßa da sua aplica√ß√£o, instruindo os navegadores sobre como lidar com o conte√∫do. Eles ajudam a mitigar v√°rios ataques, como Cross-Site Scripting (XSS), Clickjacking e detec√ß√£o de tipo MIME:

* Content Security Policy (CSP)
* X-Frame-Options
* X-Content-Type-Options
* Strict-Transport-Security (HSTS)
* Referrer Policy

**Exemplos:**
```javascript
// next.config.js

module.exports = {
async headers() {
return [
{
source: '/(.*)', // Apply to all routes
headers: [
{
key: 'X-Frame-Options',
value: 'DENY',
},
{
key: 'Content-Security-Policy',
value: "default-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval';",
},
{
key: 'X-Content-Type-Options',
value: 'nosniff',
},
{
key: 'Strict-Transport-Security',
value: 'max-age=63072000; includeSubDomains; preload', // Enforces HTTPS
},
{
key: 'Referrer-Policy',
value: 'no-referrer', // Completely hides referrer
},
// Additional headers...
],
},
];
},
};
```
</details>

<details>

<summary>Configura√ß√µes de Otimiza√ß√£o de Imagem</summary>

Next.js otimiza imagens para desempenho, mas configura√ß√µes incorretas podem levar a vulnerabilidades de seguran√ßa, como permitir que fontes n√£o confi√°veis injetem conte√∫do malicioso.

**Exemplo de Configura√ß√£o Ruim:**
```javascript
// next.config.js

module.exports = {
images: {
domains: ['*'], // Allows images from any domain
},
};
```
**Problema:**

* **`'*'`:** Permite que imagens sejam carregadas de qualquer fonte externa, incluindo dom√≠nios n√£o confi√°veis ou maliciosos. Ataques podem hospedar imagens contendo cargas √∫teis maliciosas ou conte√∫do que engana os usu√°rios.
* Outro problema pode ser permitir um dom√≠nio **onde qualquer um pode fazer upload de uma imagem** (como `raw.githubusercontent.com`)

**Como os atacantes abusam disso:**

Ao injetar imagens de fontes maliciosas, os atacantes podem realizar ataques de phishing, exibir informa√ß√µes enganosas ou explorar vulnerabilidades em bibliotecas de renderiza√ß√£o de imagens.

</details>

<details>

<summary>Exposi√ß√£o de Vari√°veis de Ambiente</summary>

Gerencie informa√ß√µes sens√≠veis como chaves de API e credenciais de banco de dados de forma segura, sem exp√¥-las ao cliente.

#### a. Expondo Vari√°veis Sens√≠veis

**Exemplo de Configura√ß√£o Ruim:**
```javascript
// next.config.js

module.exports = {
env: {
SECRET_API_KEY: process.env.SECRET_API_KEY, // Exposed to the client
NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL, // Correctly prefixed for client
},
};
```
**Problema:**

* **`SECRET_API_KEY`:** Sem o prefixo `NEXT_PUBLIC_`, o Next.js n√£o exp√µe vari√°veis para o cliente. No entanto, se prefixado por engano (por exemplo, `NEXT_PUBLIC_SECRET_API_KEY`), torna-se acess√≠vel no lado do cliente.

**Como os atacantes abusam disso:**

Se vari√°veis sens√≠veis forem expostas ao cliente, os atacantes podem recuper√°-las inspecionando o c√≥digo do lado do cliente ou as requisi√ß√µes de rede, obtendo acesso n√£o autorizado a APIs, bancos de dados ou outros servi√ßos.

</details>

<details>

<summary>Redirecionamentos</summary>

Gerencie redirecionamentos e reescritas de URL dentro de sua aplica√ß√£o, garantindo que os usu√°rios sejam direcionados adequadamente sem introduzir vulnerabilidades de redirecionamento aberto.

#### a. Vulnerabilidade de Redirecionamento Aberto

**Exemplo de Configura√ß√£o Ruim:**
```javascript
// next.config.js

module.exports = {
async redirects() {
return [
{
source: '/redirect',
destination: (req) => req.query.url, // Dynamically redirects based on query parameter
permanent: false,
},
];
},
};
```
**Problema:**

* **Destino Din√¢mico:** Permite que os usu√°rios especifiquem qualquer URL, possibilitando ataques de redirecionamento aberto.
* **Confiando na Entrada do Usu√°rio:** Redirecionar para URLs fornecidas pelos usu√°rios sem valida√ß√£o pode levar a phishing, distribui√ß√£o de malware ou roubo de credenciais.

**Como os atacantes abusam disso:**

Os atacantes podem criar URLs que parecem originar do seu dom√≠nio, mas redirecionam os usu√°rios para sites maliciosos. Por exemplo:
```bash
https://yourdomain.com/redirect?url=https://malicious-site.com
```
Usu√°rios que confiam no dom√≠nio original podem, sem saber, navegar para sites prejudiciais.

</details>

<details>

<summary>Configura√ß√£o do Webpack</summary>

Personalize as configura√ß√µes do Webpack para sua aplica√ß√£o Next.js, que podem inadvertidamente introduzir vulnerabilidades de seguran√ßa se n√£o forem tratadas com cautela.

#### a. Expondo M√≥dulos Sens√≠veis

**Exemplo de Configura√ß√£o Ruim:**
```javascript
// next.config.js

module.exports = {
webpack: (config, { isServer }) => {
if (!isServer) {
config.resolve.alias['@sensitive'] = path.join(__dirname, 'secret-folder');
}
return config;
},
};
```
**Problema:**

* **Expondo Caminhos Sens√≠veis:** Alias de diret√≥rios sens√≠veis e permitindo acesso do lado do cliente pode vazar informa√ß√µes confidenciais.
* **Agrupando Segredos:** Se arquivos sens√≠veis forem agrupados para o cliente, seu conte√∫do se torna acess√≠vel atrav√©s de mapas de origem ou inspecionando o c√≥digo do lado do cliente.

**Como os atacantes abusam disso:**

Os atacantes podem acessar ou reconstruir a estrutura de diret√≥rios da aplica√ß√£o, potencialmente encontrando e explorando arquivos ou dados sens√≠veis.

</details>

### `pages/_app.js` e `pages/_document.js`

#### **`pages/_app.js`**

**Prop√≥sito:** Substitui o componente App padr√£o, permitindo estado global, estilos e componentes de layout.

**Casos de Uso:**

* Injetando CSS global.
* Adicionando wrappers de layout.
* Integrando bibliotecas de gerenciamento de estado.

**Exemplo:**
```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
return <Component {...pageProps} />;
}

export default MyApp;
```
#### **`pages/_document.js`**

**Prop√≥sito:** Substitui o Documento padr√£o, permitindo a personaliza√ß√£o das tags HTML e Body.

**Casos de Uso:**

* Modificando as tags `<html>` ou `<body>`.
* Adicionando meta tags ou scripts personalizados.
* Integrando fontes de terceiros.

**Exemplo:**
```jsx
// pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
render() {
return (
<Html lang="en">
<Head>
{/* Custom fonts or meta tags */}
</Head>
<body>
<Main />
<NextScript />
</body>
</Html>
);
}
}

export default MyDocument;
```
### Servidor Personalizado (Opcional)

**Prop√≥sito:** Embora o Next.js venha com um servidor embutido, voc√™ pode criar um servidor personalizado para casos de uso avan√ßados, como roteamento personalizado ou integra√ß√£o com servi√ßos de backend existentes.

**Nota:** Usar um servidor personalizado pode limitar as op√ß√µes de implanta√ß√£o, especialmente em plataformas como Vercel que otimizam para o servidor embutido do Next.js.

**Exemplo:**
```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
const server = express();

// Custom route
server.get('/a', (req, res) => {
return app.render(req, res, '/a');
});

// Default handler
server.all('*', (req, res) => {
return handle(req, res);
});

server.listen(3000, (err) => {
if (err) throw err;
console.log('> Ready on http://localhost:3000');
});
});
```
***

## Considera√ß√µes Adicionais de Arquitetura e Seguran√ßa

### Vari√°veis de Ambiente e Configura√ß√£o

**Prop√≥sito:** Gerenciar informa√ß√µes sens√≠veis e configura√ß√µes fora da base de c√≥digo.

**Melhores Pr√°ticas:**

* **Use Arquivos `.env`:** Armazene vari√°veis como chaves de API em `.env.local` (exclu√≠do do controle de vers√£o).
* **Acesse Vari√°veis de Forma Segura:** Use `process.env.VARIABLE_NAME` para acessar vari√°veis de ambiente.
* **Nunca Exponha Segredos no Cliente:** Garanta que vari√°veis sens√≠veis sejam usadas apenas no lado do servidor.

**Exemplo:**
```javascript
// next.config.js
module.exports = {
env: {
API_KEY: process.env.API_KEY, // Accessible on both client and server
SECRET_KEY: process.env.SECRET_KEY, // Be cautious if accessible on the client
},
};
```
**Nota:** Para restringir vari√°veis apenas ao lado do servidor, omita-as do objeto `env` ou prefixe-as com `NEXT_PUBLIC_` para exposi√ß√£o no cliente.

### Autentica√ß√£o e Autoriza√ß√£o

**Abordagem:**

* **Autentica√ß√£o Baseada em Sess√£o:** Use cookies para gerenciar sess√µes de usu√°rios.
* **Autentica√ß√£o Baseada em Token:** Implemente JWTs para autentica√ß√£o sem estado.
* **Provedores de Terceiros:** Integre-se com provedores OAuth (por exemplo, Google, GitHub) usando bibliotecas como `next-auth`.

**Pr√°ticas de Seguran√ßa:**

* **Cookies Seguros:** Defina os atributos `HttpOnly`, `Secure` e `SameSite`.
* **Hashing de Senhas:** Sempre fa√ßa hash das senhas antes de armazen√°-las.
* **Valida√ß√£o de Entrada:** Previna ataques de inje√ß√£o validando e sanitizando entradas.

**Exemplo:**
```javascript
// pages/api/login.js
import { sign } from 'jsonwebtoken';
import { serialize } from 'cookie';

export default async function handler(req, res) {
const { username, password } = req.body;

// Validate user credentials
if (username === 'admin' && password === 'password') {
const token = sign({ username }, process.env.JWT_SECRET, { expiresIn: '1h' });
res.setHeader('Set-Cookie', serialize('auth', token, { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }));
res.status(200).json({ message: 'Logged in' });
} else {
res.status(401).json({ error: 'Invalid credentials' });
}
}
```
### Otimiza√ß√£o de Desempenho

**Estrat√©gias:**

* **Otimiza√ß√£o de Imagem:** Use o componente `next/image` do Next.js para otimiza√ß√£o autom√°tica de imagens.
* **Divis√£o de C√≥digo:** Aproveite as importa√ß√µes din√¢micas para dividir o c√≥digo e reduzir os tempos de carregamento iniciais.
* **Cache:** Implemente estrat√©gias de cache para respostas de API e ativos est√°ticos.
* **Carregamento Sob Demanda:** Carregue componentes ou ativos apenas quando forem necess√°rios.

**Exemplo:**
```jsx
// Dynamic Import with Code Splitting
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('../components/HeavyComponent'), {
loading: () => <p>Loading...</p>,
});
```
{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
