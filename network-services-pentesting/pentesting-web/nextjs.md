# NextJS

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** ğŸ’¬ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) dÃ©pÃ´ts github.

</details>
{% endhint %}

## Architecture gÃ©nÃ©rale d'une application Next.js

### Structure de fichiers typique

Un projet Next.js standard suit une structure de fichiers et de rÃ©pertoires spÃ©cifique qui facilite ses fonctionnalitÃ©s telles que le routage, les points de terminaison API et la gestion des actifs statiques. Voici une disposition typique :
```lua
my-nextjs-app/
â”œâ”€â”€ node_modules/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ logo.png
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ hello/
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â””â”€â”€ Footer.tsx
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â””â”€â”€ Home.module.css
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ api.ts
â”œâ”€â”€ .env.local
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ yarn.lock / package-lock.json

```
### RÃ©pertoires et Fichiers Principaux

* **public/:** HÃ©berge des ressources statiques telles que des images, des polices et d'autres fichiers. Les fichiers ici sont accessibles Ã  la racine (`/`).
* **app/:** RÃ©pertoire central pour les pages, mises en page, composants et routes API de votre application. Adopte le paradigme **App Router**, permettant des fonctionnalitÃ©s de routage avancÃ©es et une sÃ©paration des composants serveur-client.
* **app/layout.tsx:** DÃ©finit la mise en page racine de votre application, englobant toutes les pages et fournissant des Ã©lÃ©ments d'interface utilisateur cohÃ©rents comme des en-tÃªtes, des pieds de page et des barres de navigation.
* **app/page.tsx:** Sert de point d'entrÃ©e pour la route racine `/`, rendant la page d'accueil.
* **app/\[route]/page.tsx:** GÃ¨re les routes statiques et dynamiques. Chaque dossier dans `app/` reprÃ©sente un segment de route, et `page.tsx` dans ces dossiers correspond au composant de la route.
* **app/api/:** Contient des routes API, vous permettant de crÃ©er des fonctions sans serveur qui gÃ¨rent les requÃªtes HTTP. Ces routes remplacent le rÃ©pertoire traditionnel `pages/api`.
* **app/components/:** Contient des composants React rÃ©utilisables qui peuvent Ãªtre utilisÃ©s sur diffÃ©rentes pages et mises en page.
* **app/styles/:** Contient des fichiers CSS globaux et des modules CSS pour le style spÃ©cifique aux composants.
* **app/utils/:** Inclut des fonctions utilitaires, des modules d'aide et d'autres logiques non-UI qui peuvent Ãªtre partagÃ©es Ã  travers l'application.
* **.env.local:** Stocke des variables d'environnement spÃ©cifiques Ã  l'environnement de dÃ©veloppement local. Ces variables **ne sont pas** engagÃ©es dans le contrÃ´le de version.
* **next.config.js:** Personnalise le comportement de Next.js, y compris les configurations webpack, les variables d'environnement et les paramÃ¨tres de sÃ©curitÃ©.
* **tsconfig.json:** Configure les paramÃ¨tres TypeScript pour le projet, permettant la vÃ©rification de type et d'autres fonctionnalitÃ©s TypeScript.
* **package.json:** GÃ¨re les dÃ©pendances du projet, les scripts et les mÃ©tadonnÃ©es.
* **README.md:** Fournit de la documentation et des informations sur le projet, y compris des instructions de configuration, des directives d'utilisation et d'autres dÃ©tails pertinents.
* **yarn.lock / package-lock.json:** Verrouille les dÃ©pendances du projet Ã  des versions spÃ©cifiques, garantissant des installations cohÃ©rentes Ã  travers diffÃ©rents environnements.

## CÃ´tÃ© Client dans Next.js

### Routage BasÃ© sur les Fichiers dans le RÃ©pertoire `app`

Le rÃ©pertoire `app` est la pierre angulaire du routage dans les derniÃ¨res versions de Next.js. Il exploite le systÃ¨me de fichiers pour dÃ©finir des routes, rendant la gestion des routes intuitive et Ã©volutive.

<details>

<summary>Gestion du Chemin Racine /</summary>

**Structure de Fichiers :**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Fichiers ClÃ©s :**

* **`app/page.tsx`** : GÃ¨re les requÃªtes vers le chemin racine `/`.
* **`app/layout.tsx`** : DÃ©finit la mise en page de l'application, englobant toutes les pages.

**Mise en Å“uvre :**
```tsx
tsxCopy code// app/page.tsx

export default function HomePage() {
return (
<div>
<h1>Welcome to the Home Page!</h1>
<p>This is the root route.</p>
</div>
);
}
```
**Explication :**

* **DÃ©finition de la Route :** Le fichier `page.tsx` directement sous le rÃ©pertoire `app` correspond Ã  la route `/`.
* **Rendu :** Ce composant rend le contenu de la page d'accueil.
* **IntÃ©gration de la Mise en Page :** Le composant `HomePage` est enveloppÃ© par le `layout.tsx`, qui peut inclure des en-tÃªtes, des pieds de page et d'autres Ã©lÃ©ments communs.

</details>

<details>

<summary>Gestion d'Autres Chemins Statique</summary>



**Exemple : Route `/about`**

**Structure de Fichier :**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```tsx
// app/about/page.tsx

export default function AboutPage() {
return (
<div>
<h1>About Us</h1>
<p>Learn more about our mission and values.</p>
</div>
);
}
```
**Explication :**

* **DÃ©finition de la Route :** Le fichier `page.tsx` Ã  l'intÃ©rieur du dossier `about` correspond Ã  la route `/about`.
* **Rendu :** Ce composant rend le contenu de la page Ã  propos.

</details>

<details>

<summary>Routes Dynamiques</summary>

Les routes dynamiques permettent de gÃ©rer des chemins avec des segments variables, permettant aux applications d'afficher du contenu en fonction de paramÃ¨tres tels que des IDs, des slugs, etc.

**Exemple : Route `/posts/[id]`**

**Structure de Fichier :**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ posts/
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```tsx
tsxCopy code// app/posts/[id]/page.tsx

import { useRouter } from 'next/navigation';

interface PostProps {
params: { id: string };
}

export default function PostPage({ params }: PostProps) {
const { id } = params;
// Fetch post data based on 'id'

return (
<div>
<h1>Post #{id}</h1>
<p>This is the content of post {id}.</p>
</div>
);
}
```
**Explication :**

* **Segment Dynamique :** `[id]` dÃ©signe un segment dynamique dans la route, capturant le paramÃ¨tre `id` de l'URL.
* **AccÃ¨s aux ParamÃ¨tres :** L'objet `params` contient les paramÃ¨tres dynamiques, accessibles au sein du composant.
* **Correspondance de Route :** Tout chemin correspondant Ã  `/posts/*`, tel que `/posts/1`, `/posts/abc`, etc., sera gÃ©rÃ© par ce composant.

</details>

<details>

<summary>Routes ImbriquÃ©es</summary>



Next.js prend en charge le routage imbriquÃ©, permettant des structures de routes hiÃ©rarchiques qui reflÃ¨tent la disposition du rÃ©pertoire.

**Exemple : Route `/dashboard/settings/profile`**

**Structure de Fichiers :**
```arduino
arduinoCopy codemy-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ profile/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```tsx
tsxCopy code// app/dashboard/settings/profile/page.tsx

export default function ProfileSettingsPage() {
return (
<div>
<h1>Profile Settings</h1>
<p>Manage your profile information here.</p>
</div>
);
}
```
**Explication :**

* **Imbrication Profonde :** Le fichier `page.tsx` Ã  l'intÃ©rieur de `dashboard/settings/profile/` correspond Ã  la route `/dashboard/settings/profile`.
* **RÃ©flexion de la HiÃ©rarchie :** La structure du rÃ©pertoire reflÃ¨te le chemin URL, amÃ©liorant la maintenabilitÃ© et la clartÃ©.

</details>

<details>

<summary>Routes Catch-All</summary>



Les routes catch-all gÃ¨rent plusieurs segments imbriquÃ©s ou des chemins inconnus, offrant une flexibilitÃ© dans la gestion des routes.

**Exemple : Route `/*`**

**Structure de Fichier :**
```arduino
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ [..slug]/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ public/
â”œâ”€â”€ next.config.js
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```tsx
// app/[...slug]/page.tsx

interface CatchAllProps {
params: { slug: string[] };
}

export default function CatchAllPage({ params }: CatchAllProps) {
const { slug } = params;
const fullPath = `/${slug.join('/')}`;

return (
<div>
<h1>Catch-All Route</h1>
<p>You have navigated to: {fullPath}</p>
</div>
);
}
```
**Explication :**

* **Segment Catch-All :** `[...slug]` capture tous les segments de chemin restants sous forme de tableau.
* **Utilisation :** Utile pour gÃ©rer des scÃ©narios de routage dynamique comme des chemins gÃ©nÃ©rÃ©s par les utilisateurs, des catÃ©gories imbriquÃ©es, etc.
* **Correspondance de Route :** Des chemins comme `/anything/here`, `/foo/bar/baz`, etc., sont gÃ©rÃ©s par ce composant.

</details>

### VulnÃ©rabilitÃ©s Potentielles CÃ´tÃ© Client

Bien que Next.js fournisse une base sÃ©curisÃ©e, des pratiques de codage inappropriÃ©es peuvent introduire des vulnÃ©rabilitÃ©s. Les principales vulnÃ©rabilitÃ©s cÃ´tÃ© client incluent :

<details>

<summary>Cross-Site Scripting (XSS)</summary>

Les attaques XSS se produisent lorsque des scripts malveillants sont injectÃ©s dans des sites Web de confiance. Les attaquants peuvent exÃ©cuter des scripts dans les navigateurs des utilisateurs, volant des donnÃ©es ou effectuant des actions au nom de l'utilisateur.

**Exemple de Code VulnÃ©rable :**
```jsx
// Dangerous: Injecting user input directly into HTML
function Comment({ userInput }) {
return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
}
```
**Pourquoi c'est vulnÃ©rable :** L'utilisation de `dangerouslySetInnerHTML` avec des entrÃ©es non fiables permet aux attaquants d'injecter des scripts malveillants.

</details>

<details>

<summary>Injection de Template CÃ´tÃ© Client</summary>

Se produit lorsque les entrÃ©es utilisateur sont mal gÃ©rÃ©es dans les templates, permettant aux attaquants d'injecter et d'exÃ©cuter des templates ou des expressions.

**Exemple de Code VulnÃ©rable :**
```jsx
import React from 'react';
import ejs from 'ejs';

function RenderTemplate({ template, data }) {
const html = ejs.render(template, data);
return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```
**Pourquoi c'est vulnÃ©rable :** Si `template` ou `data` inclut du contenu malveillant, cela peut conduire Ã  l'exÃ©cution de code non intentionnel.

</details>

<details>

<summary>TraversÃ©e de chemin client</summary>

C'est une vulnÃ©rabilitÃ© qui permet aux attaquants de manipuler les chemins cÃ´tÃ© client pour effectuer des actions non intentionnelles, telles que le Cross-Site Request Forgery (CSRF). Contrairement Ã  la traversÃ©e de chemin cÃ´tÃ© serveur, qui cible le systÃ¨me de fichiers du serveur, la CSPT se concentre sur l'exploitation des mÃ©canismes cÃ´tÃ© client pour rediriger les requÃªtes API lÃ©gitimes vers des points de terminaison malveillants.

**Exemple de code vulnÃ©rable :**

Une application Next.js permet aux utilisateurs de tÃ©lÃ©charger et d'uploader des fichiers. La fonctionnalitÃ© de tÃ©lÃ©chargement est implÃ©mentÃ©e cÃ´tÃ© client, oÃ¹ les utilisateurs peuvent spÃ©cifier le chemin du fichier Ã  tÃ©lÃ©charger.
```jsx
// pages/download.js
import { useState } from 'react';

export default function DownloadPage() {
const [filePath, setFilePath] = useState('');

const handleDownload = () => {
fetch(`/api/files/${filePath}`)
.then(response => response.blob())
.then(blob => {
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filePath;
a.click();
});
};

return (
<div>
<h1>Download File</h1>
<input
type="text"
value={filePath}
onChange={(e) => setFilePath(e.target.value)}
placeholder="Enter file path"
/>
<button onClick={handleDownload}>Download</button>
</div>
);
}
```
#### ScÃ©nario d'Attaque

1. **Objectif de l'Attaquant** : Effectuer une attaque CSRF pour supprimer un fichier critique (par exemple, `admin/config.json`) en manipulant le `filePath`.
2. **Exploitation de CSPT** :
* **EntrÃ©e Malveillante** : L'attaquant crÃ©e une URL avec un `filePath` manipulÃ© tel que `../deleteFile/config.json`.
* **Appel API RÃ©sultant** : Le code cÃ´tÃ© client effectue une requÃªte Ã  `/api/files/../deleteFile/config.json`.
* **Gestion par le Serveur** : Si le serveur ne valide pas le `filePath`, il traite la requÃªte, supprimant ou exposant potentiellement des fichiers sensibles.
3. **ExÃ©cution de CSRF** :
* **Lien ConÃ§u** : L'attaquant envoie Ã  la victime un lien ou intÃ¨gre un script malveillant qui dÃ©clenche la requÃªte de tÃ©lÃ©chargement avec le `filePath` manipulÃ©.
* **RÃ©sultat** : La victime exÃ©cute sans le savoir l'action, entraÃ®nant un accÃ¨s ou une suppression non autorisÃ©e de fichiers.

#### Pourquoi c'est VulnÃ©rable

* **Absence de Validation des EntrÃ©es** : Le cÃ´tÃ© client permet des entrÃ©es `filePath` arbitraires, permettant le parcours de chemin.
* **Confiance dans les EntrÃ©es du Client** : L'API cÃ´tÃ© serveur fait confiance et traite le `filePath` sans assainissement.
* **Actions Potentielles de l'API** : Si le point de terminaison de l'API effectue des actions modifiant l'Ã©tat (par exemple, supprimer, modifier des fichiers), il peut Ãªtre exploitÃ© via CSPT.

</details>

## CÃ´tÃ© Serveur dans Next.js

### Rendu CÃ´tÃ© Serveur (SSR)

Les pages sont rendues sur le serveur Ã  chaque requÃªte, garantissant que l'utilisateur reÃ§oit du HTML entiÃ¨rement rendu. Dans ce cas, vous devez crÃ©er votre propre serveur personnalisÃ© pour traiter les requÃªtes.

**Cas d'Utilisation :**

* Contenu dynamique qui change frÃ©quemment.
* Optimisation SEO, car les moteurs de recherche peuvent explorer la page entiÃ¨rement rendue.

**Mise en Å’uvre :**
```jsx
// pages/index.js
export async function getServerSideProps(context) {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data } };
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### GÃ©nÃ©ration de Sites Statique (SSG)

Les pages sont prÃ©-rendues au moment de la construction, ce qui entraÃ®ne des temps de chargement plus rapides et une charge serveur rÃ©duite.

**Cas d'utilisation :**

* Contenu qui ne change pas frÃ©quemment.
* Blogs, documentation, pages marketing.

**Mise en Å“uvre :**
```jsx
// pages/index.js
export async function getStaticProps() {
const res = await fetch('https://api.example.com/data');
const data = await res.json();
return { props: { data }, revalidate: 60 }; // Revalidate every 60 seconds
}

function HomePage({ data }) {
return <div>{data.title}</div>;
}

export default HomePage;
```
### Fonctions sans serveur (Routes API)

Next.js permet la crÃ©ation de points de terminaison API en tant que fonctions sans serveur. Ces fonctions s'exÃ©cutent Ã  la demande sans avoir besoin d'un serveur dÃ©diÃ©.

**Cas d'utilisation :**

* Gestion des soumissions de formulaires.
* Interaction avec des bases de donnÃ©es.
* Traitement des donnÃ©es ou intÃ©gration avec des API tierces.

**Mise en Å“uvre :**

Avec l'introduction du rÃ©pertoire `app` dans Next.js 13, le routage et la gestion des API sont devenus plus flexibles et puissants. Cette approche moderne s'aligne Ã©troitement avec le systÃ¨me de routage basÃ© sur les fichiers mais introduit des capacitÃ©s amÃ©liorÃ©es, y compris le support pour les composants serveur et client.

#### Gestionnaire de route de base

**Structure de fichiers :**
```go
my-nextjs-app/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello/
â”‚           â””â”€â”€ route.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```javascript
// app/api/hello/route.js

export async function POST(request) {
return new Response(JSON.stringify({ message: 'Hello from App Router!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

// Client-side fetch to access the API endpoint
fetch('/api/submit', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ name: 'John Doe' }),
})
.then((res) => res.json())
.then((data) => console.log(data));
```
**Explication :**

* **Emplacement :** Les routes API sont placÃ©es sous le rÃ©pertoire `app/api/`.
* **Nom des fichiers :** Chaque point de terminaison API rÃ©side dans son propre dossier contenant un fichier `route.js` ou `route.ts`.
* **Fonctions exportÃ©es :** Au lieu d'un seul export par dÃ©faut, des fonctions spÃ©cifiques aux mÃ©thodes HTTP (par exemple, `GET`, `POST`) sont exportÃ©es.
* **Gestion des rÃ©ponses :** Utilisez le constructeur `Response` pour renvoyer des rÃ©ponses, permettant un meilleur contrÃ´le sur les en-tÃªtes et les codes d'Ã©tat.

#### Comment gÃ©rer d'autres chemins et mÃ©thodes :

<details>

<summary>Gestion des mÃ©thodes HTTP spÃ©cifiques</summary>

Next.js 13+ vous permet de dÃ©finir des gestionnaires pour des mÃ©thodes HTTP spÃ©cifiques dans le mÃªme fichier `route.js` ou `route.ts`, favorisant un code plus clair et mieux organisÃ©.

**Exemple :**
```javascript
// app/api/users/[id]/route.js

export async function GET(request, { params }) {
const { id } = params;
// Fetch user data based on 'id'
return new Response(JSON.stringify({ userId: id, name: 'Jane Doe' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function PUT(request, { params }) {
const { id } = params;
// Update user data based on 'id'
return new Response(JSON.stringify({ message: `User ${id} updated.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}

export async function DELETE(request, { params }) {
const { id } = params;
// Delete user based on 'id'
return new Response(JSON.stringify({ message: `User ${id} deleted.` }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explication :**

* **Exports Multiples :** Chaque mÃ©thode HTTP (`GET`, `PUT`, `DELETE`) a sa propre fonction exportÃ©e.
* **ParamÃ¨tres :** Le deuxiÃ¨me argument donne accÃ¨s aux paramÃ¨tres de route via `params`.
* **RÃ©ponses AmÃ©liorÃ©es :** Un meilleur contrÃ´le sur les objets de rÃ©ponse, permettant une gestion prÃ©cise des en-tÃªtes et des codes d'Ã©tat.

</details>

<details>

<summary>Routes Catch-All et ImbriquÃ©es</summary>



Next.js 13+ prend en charge des fonctionnalitÃ©s de routage avancÃ©es telles que les routes catch-all et les routes API imbriquÃ©es, permettant des structures API plus dynamiques et Ã©volutives.

**Exemple de Route Catch-All :**
```javascript
// app/api/[...slug]/route.js

export async function GET(request, { params }) {
const { slug } = params;
// Handle dynamic nested routes
return new Response(JSON.stringify({ slug }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explication :**

* **Syntaxe :** `[...]` dÃ©signe un segment attrape-tout, capturant tous les chemins imbriquÃ©s.
* **Utilisation :** Utile pour les API qui doivent gÃ©rer des profondeurs de route variÃ©es ou des segments dynamiques.

**Exemple de Routes ImbriquÃ©es :**
```javascript
// app/api/posts/[postId]/comments/[commentId]/route.js

export async function GET(request, { params }) {
const { postId, commentId } = params;
// Fetch specific comment for a post
return new Response(JSON.stringify({ postId, commentId, comment: 'Great post!' }), {
status: 200,
headers: { 'Content-Type': 'application/json' },
});
}
```
**Explication :**

* **Nesting Profond :** Permet des structures d'API hiÃ©rarchiques, reflÃ©tant les relations entre les ressources.
* **AccÃ¨s aux ParamÃ¨tres :** AccÃ©dez facilement Ã  plusieurs paramÃ¨tres de route via l'objet `params`.

</details>

<details>

<summary>Gestion des routes API dans Next.js 12 et versions antÃ©rieures</summary>

## Routes API dans le RÃ©pertoire `pages` (Next.js 12 et versions antÃ©rieures)

Avant que Next.js 13 n'introduise le rÃ©pertoire `app` et n'amÃ©liore les capacitÃ©s de routage, les routes API Ã©taient principalement dÃ©finies dans le rÃ©pertoire `pages`. Cette approche est toujours largement utilisÃ©e et supportÃ©e dans Next.js 12 et les versions antÃ©rieures.

#### Route API de Base

**Structure de Fichier :**
```go
goCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ hello.js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```javascript
javascriptCopy code// pages/api/hello.js

export default function handler(req, res) {
res.status(200).json({ message: 'Hello, World!' });
}
```
**Explication :**

* **Emplacement :** Les routes API se trouvent sous le rÃ©pertoire `pages/api/`.
* **Exportation :** Utilisez `export default` pour dÃ©finir la fonction de gestion.
* **Signature de la fonction :** Le gestionnaire reÃ§oit les objets `req` (requÃªte HTTP) et `res` (rÃ©ponse HTTP).
* **Routage :** Le nom du fichier (`hello.js`) correspond Ã  l'endpoint `/api/hello`.

#### Routes API Dynamiques

**Structure de fichier :**
```bash
bashCopy codemy-nextjs-app/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ users/
â”‚           â””â”€â”€ [id].js
â”œâ”€â”€ package.json
â””â”€â”€ ...
```
**Mise en Å“uvre :**
```javascript
javascriptCopy code// pages/api/users/[id].js

export default function handler(req, res) {
const {
query: { id },
method,
} = req;

switch (method) {
case 'GET':
// Fetch user data based on 'id'
res.status(200).json({ userId: id, name: 'John Doe' });
break;
case 'PUT':
// Update user data based on 'id'
res.status(200).json({ message: `User ${id} updated.` });
break;
case 'DELETE':
// Delete user based on 'id'
res.status(200).json({ message: `User ${id} deleted.` });
break;
default:
res.setHeader('Allow', ['GET', 'PUT', 'DELETE']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Explication :**

* **Segments Dynamiques :** Les crochets (`[id].js`) dÃ©signent des segments de route dynamiques.
* **AccÃ©der aux ParamÃ¨tres :** Utilisez `req.query.id` pour accÃ©der au paramÃ¨tre dynamique.
* **Gestion des MÃ©thodes :** Utilisez une logique conditionnelle pour gÃ©rer diffÃ©rentes mÃ©thodes HTTP (`GET`, `PUT`, `DELETE`, etc.).

#### Gestion des DiffÃ©rentes MÃ©thodes HTTP

Bien que l'exemple de route API de base gÃ¨re toutes les mÃ©thodes HTTP dans une seule fonction, vous pouvez structurer votre code pour gÃ©rer chaque mÃ©thode explicitement pour une meilleure clartÃ© et maintenabilitÃ©.

**Exemple :**
```javascript
javascriptCopy code// pages/api/posts.js

export default async function handler(req, res) {
const { method } = req;

switch (method) {
case 'GET':
// Handle GET request
res.status(200).json({ message: 'Fetching posts.' });
break;
case 'POST':
// Handle POST request
res.status(201).json({ message: 'Post created.' });
break;
default:
res.setHeader('Allow', ['GET', 'POST']);
res.status(405).end(`Method ${method} Not Allowed`);
}
}
```
**Meilleures Pratiques :**

* **SÃ©paration des PrÃ©occupations :** SÃ©parer clairement la logique pour diffÃ©rentes mÃ©thodes HTTP.
* **Consistance des RÃ©ponses :** Assurer des structures de rÃ©ponse cohÃ©rentes pour faciliter la gestion cÃ´tÃ© client.
* **Gestion des Erreurs :** GÃ©rer avec Ã©lÃ©gance les mÃ©thodes non prises en charge et les erreurs inattendues.

</details>

### Configuration CORS

ContrÃ´lez quels origines peuvent accÃ©der Ã  vos routes API, attÃ©nuant les vulnÃ©rabilitÃ©s de partage de ressources entre origines (CORS).

**Mauvais Exemple de Configuration :**
```javascript
// app/api/data/route.js

export async function GET(request) {
return new Response(JSON.stringify({ data: 'Public Data' }), {
status: 200,
headers: {
'Access-Control-Allow-Origin': '*', // Allows any origin
'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
},
});
}
```
Notez que **CORS peut Ã©galement Ãªtre configurÃ© dans toutes les routes API** Ã  l'intÃ©rieur du **`middleware.ts`** fichier :
```javascript
// app/middleware.ts

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
const allowedOrigins = ['https://yourdomain.com', 'https://sub.yourdomain.com'];
const origin = request.headers.get('Origin');

const response = NextResponse.next();

if (allowedOrigins.includes(origin || '')) {
response.headers.set('Access-Control-Allow-Origin', origin || '');
response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');
// If credentials are needed:
// response.headers.set('Access-Control-Allow-Credentials', 'true');
}

// Handle preflight requests
if (request.method === 'OPTIONS') {
return new Response(null, {
status: 204,
headers: response.headers,
});
}

return response;
}

export const config = {
matcher: '/api/:path*', // Apply to all API routes
};

```
**ProblÃ¨me :**

* **`Access-Control-Allow-Origin: '*'` :** Permet Ã  n'importe quel site web d'accÃ©der Ã  l'API, permettant potentiellement Ã  des sites malveillants d'interagir avec votre API sans restrictions.
* **Large autorisation de mÃ©thode :** Autoriser toutes les mÃ©thodes peut permettre aux attaquants d'effectuer des actions indÃ©sirables.

**Comment les attaquants en profitent :**

Les attaquants peuvent crÃ©er des sites web malveillants qui effectuent des requÃªtes Ã  votre API, abusant potentiellement de fonctionnalitÃ©s telles que la rÃ©cupÃ©ration de donnÃ©es, la manipulation de donnÃ©es ou le dÃ©clenchement d'actions indÃ©sirables au nom d'utilisateurs authentifiÃ©s.

{% content-ref url="../../pentesting-web/cors-bypass.md" %}
[cors-bypass.md](../../pentesting-web/cors-bypass.md)
{% endcontent-ref %}

## Exposition du code serveur cÃ´tÃ© client

Il est facile de **utiliser le code utilisÃ© par le serveur Ã©galement dans le code exposÃ© et utilisÃ© par le cÃ´tÃ© client**, la meilleure faÃ§on de s'assurer qu'un fichier de code n'est jamais exposÃ© du cÃ´tÃ© client est d'utiliser cet import au dÃ©but du fichier :
```js
import "server-only";
```
## Fichiers ClÃ©s et Leurs RÃ´les

### `middleware.ts` / `middleware.js`

**Emplacement :** Racine du projet ou dans `src/`.

**But :** ExÃ©cute du code dans la fonction sans serveur cÃ´tÃ© serveur avant qu'une requÃªte ne soit traitÃ©e, permettant des tÃ¢ches comme l'authentification, les redirections ou la modification des rÃ©ponses.

**Flux d'ExÃ©cution :**

1. **RequÃªte Entrante :** Le middleware intercepte la requÃªte.
2. **Traitement :** Effectue des opÃ©rations basÃ©es sur la requÃªte (par exemple, vÃ©rification de l'authentification).
3. **Modification de la RÃ©ponse :** Peut altÃ©rer la rÃ©ponse ou passer le contrÃ´le au prochain gestionnaire.

**Exemples de Cas d'Utilisation :**

* Rediriger les utilisateurs non authentifiÃ©s.
* Ajouter des en-tÃªtes personnalisÃ©s.
* Journaliser les requÃªtes.

**Configuration Exemple :**
```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
const url = req.nextUrl.clone();
if (!req.cookies.has('token')) {
url.pathname = '/login';
return NextResponse.redirect(url);
}
return NextResponse.next();
}

export const config = {
matcher: ['/protected/:path*'],
};
```
### `next.config.js`

**Emplacement :** Racine du projet.

**But :** Configure le comportement de Next.js, active ou dÃ©sactive des fonctionnalitÃ©s, personnalise les configurations webpack, dÃ©finit des variables d'environnement et configure plusieurs fonctionnalitÃ©s de sÃ©curitÃ©.

**Configurations de sÃ©curitÃ© clÃ©s :**

<details>

<summary>En-tÃªtes de sÃ©curitÃ©</summary>

Les en-tÃªtes de sÃ©curitÃ© amÃ©liorent la sÃ©curitÃ© de votre application en instruisant les navigateurs sur la maniÃ¨re de gÃ©rer le contenu. Ils aident Ã  attÃ©nuer diverses attaques telles que le Cross-Site Scripting (XSS), le Clickjacking et le sniffing de type MIME :

* Politique de sÃ©curitÃ© du contenu (CSP)
* X-Frame-Options
* X-Content-Type-Options
* Strict-Transport-Security (HSTS)
* Politique de rÃ©fÃ©rent

**Exemples :**
```javascript
// next.config.js

module.exports = {
async headers() {
return [
{
source: '/(.*)', // Apply to all routes
headers: [
{
key: 'X-Frame-Options',
value: 'DENY',
},
{
key: 'Content-Security-Policy',
value: "default-src *; script-src 'self' 'unsafe-inline' 'unsafe-eval';",
},
{
key: 'X-Content-Type-Options',
value: 'nosniff',
},
{
key: 'Strict-Transport-Security',
value: 'max-age=63072000; includeSubDomains; preload', // Enforces HTTPS
},
{
key: 'Referrer-Policy',
value: 'no-referrer', // Completely hides referrer
},
// Additional headers...
],
},
];
},
};
```
</details>

<details>

<summary>ParamÃ¨tres d'optimisation des images</summary>

Next.js optimise les images pour la performance, mais des erreurs de configuration peuvent entraÃ®ner des vulnÃ©rabilitÃ©s de sÃ©curitÃ©, comme permettre Ã  des sources non fiables d'injecter du contenu malveillant.

**Exemple de mauvaise configuration :**
```javascript
// next.config.js

module.exports = {
images: {
domains: ['*'], // Allows images from any domain
},
};
```
**ProblÃ¨me :**

* **`'*'` :** Permet le chargement d'images depuis n'importe quelle source externe, y compris des domaines non fiables ou malveillants. Les attaquants peuvent hÃ©berger des images contenant des charges utiles malveillantes ou du contenu qui induit les utilisateurs en erreur.
* Un autre problÃ¨me pourrait Ãªtre de permettre un domaine **oÃ¹ tout le monde peut tÃ©lÃ©charger une image** (comme `raw.githubusercontent.com`)

**Comment les attaquants en abusent :**

En injectant des images provenant de sources malveillantes, les attaquants peuvent effectuer des attaques de phishing, afficher des informations trompeuses ou exploiter des vulnÃ©rabilitÃ©s dans les bibliothÃ¨ques de rendu d'images.

</details>

<details>

<summary>Exposition des Variables d'Environnement</summary>

GÃ©rez les informations sensibles comme les clÃ©s API et les identifiants de base de donnÃ©es de maniÃ¨re sÃ©curisÃ©e sans les exposer au client.

#### a. Exposition des Variables Sensibles

**Mauvais Exemple de Configuration :**
```javascript
// next.config.js

module.exports = {
env: {
SECRET_API_KEY: process.env.SECRET_API_KEY, // Exposed to the client
NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL, // Correctly prefixed for client
},
};
```
**ProblÃ¨me :**

* **`SECRET_API_KEY` :** Sans le prÃ©fixe `NEXT_PUBLIC_`, Next.js n'expose pas les variables au client. Cependant, si par erreur il est prÃ©fixÃ© (par exemple, `NEXT_PUBLIC_SECRET_API_KEY`), il devient accessible cÃ´tÃ© client.

**Comment les attaquants en abusent :**

Si des variables sensibles sont exposÃ©es au client, les attaquants peuvent les rÃ©cupÃ©rer en inspectant le code cÃ´tÃ© client ou les requÃªtes rÃ©seau, obtenant un accÃ¨s non autorisÃ© aux API, bases de donnÃ©es ou autres services.

</details>

<details>

<summary>Redirections</summary>

GÃ©rez les redirections et rÃ©Ã©critures d'URL au sein de votre application, en veillant Ã  ce que les utilisateurs soient dirigÃ©s de maniÃ¨re appropriÃ©e sans introduire de vulnÃ©rabilitÃ©s de redirection ouverte.

#### a. VulnÃ©rabilitÃ© de Redirection Ouverte

**Mauvais Exemple de Configuration :**
```javascript
// next.config.js

module.exports = {
async redirects() {
return [
{
source: '/redirect',
destination: (req) => req.query.url, // Dynamically redirects based on query parameter
permanent: false,
},
];
},
};
```
**ProblÃ¨me :**

* **Destination Dynamique :** Permet aux utilisateurs de spÃ©cifier n'importe quelle URL, ce qui permet des attaques de redirection ouverte.
* **Confiance dans l'EntrÃ©e de l'Utilisateur :** Les redirections vers des URL fournies par les utilisateurs sans validation peuvent conduire Ã  du phishing, Ã  la distribution de logiciels malveillants ou au vol d'identifiants.

**Comment les attaquants en abusent :**

Les attaquants peuvent crÃ©er des URL qui semblent provenir de votre domaine mais redirigent les utilisateurs vers des sites malveillants. Par exemple :
```bash
https://yourdomain.com/redirect?url=https://malicious-site.com
```
Les utilisateurs faisant confiance au domaine d'origine pourraient naviguer sans le savoir vers des sites Web nuisibles.

</details>

<details>

<summary>Configuration Webpack</summary>

Personnalisez les configurations Webpack pour votre application Next.js, ce qui peut involontairement introduire des vulnÃ©rabilitÃ©s de sÃ©curitÃ© si cela n'est pas gÃ©rÃ© avec prudence.

#### a. Exposition de modules sensibles

**Mauvais exemple de configuration :**
```javascript
// next.config.js

module.exports = {
webpack: (config, { isServer }) => {
if (!isServer) {
config.resolve.alias['@sensitive'] = path.join(__dirname, 'secret-folder');
}
return config;
},
};
```
**ProblÃ¨me :**

* **Exposition de chemins sensibles :** L'aliasing de rÃ©pertoires sensibles et l'autorisation d'accÃ¨s cÃ´tÃ© client peuvent leak des informations confidentielles.
* **Regroupement de secrets :** Si des fichiers sensibles sont regroupÃ©s pour le client, leur contenu devient accessible via des cartes sources ou en inspectant le code cÃ´tÃ© client.

**Comment les attaquants en abusent :**

Les attaquants peuvent accÃ©der ou reconstruire la structure de rÃ©pertoires de l'application, trouvant potentiellement et exploitant des fichiers ou des donnÃ©es sensibles.

</details>

### `pages/_app.js` et `pages/_document.js`

#### **`pages/_app.js`**

**But :** Remplace le composant App par dÃ©faut, permettant un Ã©tat global, des styles et des composants de mise en page.

**Cas d'utilisation :**

* Injection de CSS global.
* Ajout d'enveloppes de mise en page.
* IntÃ©gration de bibliothÃ¨ques de gestion d'Ã©tat.

**Exemple :**
```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
return <Component {...pageProps} />;
}

export default MyApp;
```
#### **`pages/_document.js`**

**But:** Remplace le Document par dÃ©faut, permettant la personnalisation des balises HTML et Body.

**Cas d'utilisation :**

* Modification des balises `<html>` ou `<body>`.
* Ajout de balises meta ou de scripts personnalisÃ©s.
* IntÃ©gration de polices tierces.

**Exemple :**
```jsx
// pages/_document.js
import Document, { Html, Head, Main, NextScript } from 'next/document';

class MyDocument extends Document {
render() {
return (
<Html lang="en">
<Head>
{/* Custom fonts or meta tags */}
</Head>
<body>
<Main />
<NextScript />
</body>
</Html>
);
}
}

export default MyDocument;
```
### Serveur PersonnalisÃ© (Optionnel)

**But :** Bien que Next.js soit livrÃ© avec un serveur intÃ©grÃ©, vous pouvez crÃ©er un serveur personnalisÃ© pour des cas d'utilisation avancÃ©s comme le routage personnalisÃ© ou l'intÃ©gration avec des services backend existants.

**Remarque :** L'utilisation d'un serveur personnalisÃ© peut limiter les options de dÃ©ploiement, en particulier sur des plateformes comme Vercel qui optimisent pour le serveur intÃ©grÃ© de Next.js.

**Exemple :**
```javascript
// server.js
const express = require('express');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
const server = express();

// Custom route
server.get('/a', (req, res) => {
return app.render(req, res, '/a');
});

// Default handler
server.all('*', (req, res) => {
return handle(req, res);
});

server.listen(3000, (err) => {
if (err) throw err;
console.log('> Ready on http://localhost:3000');
});
});
```
***

## ConsidÃ©rations Architecturales et de SÃ©curitÃ© SupplÃ©mentaires

### Variables d'Environnement et Configuration

**Objectif :** GÃ©rer les informations sensibles et les paramÃ¨tres de configuration en dehors de la base de code.

**Meilleures Pratiques :**

* **Utiliser des Fichiers `.env` :** Stocker des variables comme les clÃ©s API dans `.env.local` (exclu du contrÃ´le de version).
* **AccÃ©der aux Variables de ManiÃ¨re SÃ©curisÃ©e :** Utiliser `process.env.VARIABLE_NAME` pour accÃ©der aux variables d'environnement.
* **Ne Jamais Exposer de Secrets sur le Client :** S'assurer que les variables sensibles ne sont utilisÃ©es que cÃ´tÃ© serveur.

**Exemple :**
```javascript
// next.config.js
module.exports = {
env: {
API_KEY: process.env.API_KEY, // Accessible on both client and server
SECRET_KEY: process.env.SECRET_KEY, // Be cautious if accessible on the client
},
};
```
**Note :** Pour restreindre les variables uniquement cÃ´tÃ© serveur, omettez-les de l'objet `env` ou prÃ©fixez-les avec `NEXT_PUBLIC_` pour une exposition cÃ´tÃ© client.

### Authentification et Autorisation

**Approche :**

* **Authentification BasÃ©e sur les Sessions :** Utilisez des cookies pour gÃ©rer les sessions utilisateur.
* **Authentification BasÃ©e sur les Jetons :** ImplÃ©mentez des JWT pour une authentification sans Ã©tat.
* **Fournisseurs Tiers :** IntÃ©grez-vous avec des fournisseurs OAuth (par exemple, Google, GitHub) en utilisant des bibliothÃ¨ques comme `next-auth`.

**Pratiques de SÃ©curitÃ© :**

* **Cookies SÃ©curisÃ©s :** DÃ©finissez les attributs `HttpOnly`, `Secure` et `SameSite`.
* **Hachage des Mots de Passe :** Hachez toujours les mots de passe avant de les stocker.
* **Validation des EntrÃ©es :** PrÃ©venez les attaques par injection en validant et en nettoyant les entrÃ©es.

**Exemple :**
```javascript
// pages/api/login.js
import { sign } from 'jsonwebtoken';
import { serialize } from 'cookie';

export default async function handler(req, res) {
const { username, password } = req.body;

// Validate user credentials
if (username === 'admin' && password === 'password') {
const token = sign({ username }, process.env.JWT_SECRET, { expiresIn: '1h' });
res.setHeader('Set-Cookie', serialize('auth', token, { path: '/', httpOnly: true, secure: true, sameSite: 'strict' }));
res.status(200).json({ message: 'Logged in' });
} else {
res.status(401).json({ error: 'Invalid credentials' });
}
}
```
### Optimisation des performances

**StratÃ©gies :**

* **Optimisation des images :** Utilisez le composant `next/image` de Next.js pour une optimisation automatique des images.
* **Fractionnement du code :** Profitez des imports dynamiques pour diviser le code et rÃ©duire les temps de chargement initiaux.
* **Mise en cache :** Mettez en Å“uvre des stratÃ©gies de mise en cache pour les rÃ©ponses API et les actifs statiques.
* **Chargement paresseux :** Chargez les composants ou les actifs uniquement lorsqu'ils sont nÃ©cessaires.

**Exemple :**
```jsx
// Dynamic Import with Code Splitting
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('../components/HeavyComponent'), {
loading: () => <p>Loading...</p>,
});
```
{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** ğŸ’¬ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) dÃ©pÃ´ts github.

</details>
{% endhint %}
