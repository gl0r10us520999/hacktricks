<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# **Introduction**

**Imprimer sans autorisation** peut en soi constituer un risque de s√©curit√© ou une violation de la politique de l'entreprise. Dans les environnements o√π les travaux d'impression sont factur√©s, un attaquant interne a une motivation pour contourner le syst√®me de comptabilit√©. De plus, √™tre capable d'‚Äòimprimer‚Äô est une condition pr√©alable pour la plupart des attaques contre les imprimantes r√©seau.

Il existe deux approches principales en mati√®re de comptabilit√© des travaux d'impression : soit **laisser l'imprimante g√©rer directement, soit utiliser un serveur d'impression interm√©diaire**. La premi√®re approche est sp√©cifique au fournisseur, implique g√©n√©ralement une sorte de ‚Äòpilote d'imprimante‚Äô sp√©cial et n'est pas discut√©e ici. L'autre approche implique un serveur d'impression s√©par√© ‚Äì g√©n√©ralement une impl√©mentation logicielle comme [CUPS](https://en.wikipedia.org/wiki/CUPS) ou [LPRng](https://en.wikipedia.org/wiki/LPRng) ‚Äì pour g√©rer la comptabilit√© et est assez courante dans les entreprises et les institutions. Le serveur d'impression peut utiliser LPD, IPP ou d'autres protocoles d'impression et transf√®re les travaux vers l'imprimante r√©elle. **Il est important de noter que l'acc√®s direct au r√©seau de l'imprimante doit √™tre restreint**, sinon un attaquant peut **facilement contourner le serveur d'impression** et ses m√©canismes de comptabilit√©. Cela signifie filtrer l'acc√®s aux ports typiques et atypiques (LPD, IPP, brut, HTTP, SMB, FTP, SNMP).

Il existe essentiellement deux approches pour contourner les syst√®mes de comptabilit√© des travaux d'impression : soit **usurper l'identit√© d'un autre utilisateur, soit manipuler le compteur** de pages imprim√©es. Dans la suite, les deux options sont discut√©es pour les installations LPRng (v3.8.B) et CUPS (v2.1.4) qui sont des syst√®mes d'impression open-source populaires utilis√©s dans les environnements acad√©miques et d'entreprise. Une comparaison des fonctionnalit√©s de s√©curit√© des deux syst√®mes est donn√©e ci-dessous.

| Syst√®me d'impression | Protocole | Chiffrement | Authentification | Compteur de pages |
| -------------------- | --------- | ----------- | ---------------- | ----------------- |
| **LPRng**            | LPD       | SSL/TLS     | Kerberos, PGP    | mat√©riel          |
| **CUPS**             | IPP       | SSL/TLS     | Kerberos, HTTP   | logiciel          |

# Contournements d'authentification

LPRng et CUPS offrent tous deux un chiffrement de canal bas√© sur SSL et des sch√©mas d'authentification s√©curis√©s tels que [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), [PGP](https://en.wikipedia.org/wiki/Pretty\_Good\_Privacy) signant des travaux d'impression ou une authentification HTTP [basic](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Si **configur√© correctement** et dans le cas o√π l'attaquant ne peut pas acc√©der directement √† l'imprimante, il ne sera **pas capable d'usurper l'identit√© d'autres utilisateurs**. Cependant, ces fonctionnalit√©s de s√©curit√© sont **optionnelles et rarement appliqu√©es** dans les serveurs d'impression r√©els. Au lieu de cela, les **noms d'utilisateur donn√©s en tant que param√®tres LPD (LPRng) ou IPP (CUPS) sont enregistr√©s et comptabilis√©s** ‚Äì qui peuvent √™tre d√©finis √† des valeurs arbitraires par le c√¥t√© client. La raison en est une simple consid√©ration co√ªt-b√©n√©fice dans la plupart des institutions : **Kerberos n√©cessite une configuration sp√©ciale** sur chaque client et l'authentification **HTTP** **exige** des utilisateurs d'entrer un **mot de passe** chaque fois qu'ils veulent imprimer quelque chose alors que le co√ªt de quelques impressions non comptabilis√©es est supportable.

Vous pouvez **v√©rifier une authentification appropri√©e** en essayant d'imprimer avec un **nom d'utilisateur personnalis√©** comme ceci :
```
lp -U nobody test.ps
```
# Manipulation du compteur de pages

## Compteurs de pages mat√©riels

Pour une comptabilit√© correcte, **le nombre de pages imprim√©es doit √™tre d√©termin√©** par le syst√®me d'impression, ce qui n'est pas une t√¢che triviale. Les auteurs de **LPRng** _partent du principe que l'imprimante dispose d'une sorte de m√©canisme de compteur de pages non-volatile fiable et insensible aux cycles de mise sous/hors tension_. De tels **compteurs de pages mat√©riels** sont pris en charge par la plupart des imprimantes et **lus** par LPRng **√† l'aide de PJL apr√®s** chaque **travail d'impression**. **HP** a m√™me document√© une fonctionnalit√© pour **√©crire** sur la variable du **compteur de pages** en mettant l'imprimante en mode service. De cette fa√ßon, le **compteur de pages** des _HP LaserJet 1200, HP LaserJet 4200N_ et _HP LaserJet 4250N_ **peut √™tre manipul√©** au sein d'un travail d'impression. √Ä la fin du document √† imprimer et s√©par√© par le [UEL](./#uel), le compteur doit simplement √™tre r√©initialis√© √† sa valeur d'origine (par exemple, `2342`) :
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Un attaquant pourrait d√©finir un nombre n√©gatif de pages imprim√©es. Notez que la r√©initialisation de l'appareil aux [param√®tres d'usine](factory-defaults.md) **r√©initialise √©galement le compteur de pages √† z√©ro sur certains** des appareils test√©s.\
R√©duire le compteur de pages peut √©galement √™tre utilis√© pour **vendre une imprimante au-dessus de son prix** car cela peut √™tre compar√© √† l'odom√®tre lors de l'achat d'une voiture d'occasion. Il convient cependant de souligner que **la r√©initialisation du compteur de pages n'est pas n√©cessairement √† des fins malveillantes** : Il s'agit d'un mod√®le commercial bien connu de vendre de l'encre sur√©valu√©e pour des appareils √† jet d'encre √† faible co√ªt et de bloquer les kits de recharge de tiers en refusant d'imprimer apr√®s un certain nombre de pages ‚Äì pour g√©rer de telles pratiques non √©thiques, il est absolument l√©gitime de r√©initialiser le compteur de pages.

Sur les anciens laserjets HP, la commande `pagecount` de [PRET](https://github.com/RUB-NDS/PRET) peut √™tre utilis√©e pour facilement d√©finir les compteurs de pages mat√©riels :
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Compteurs de pages logiciels

**CUPS** utilise des **compteurs de pages logiciels** qui ont √©t√© impl√©ment√©s pour tous les principaux langages de description de page. Pour PostScript, une mani√®re simple de contourner la comptabilit√© est de v√©rifier si le param√®tre syst√®me PageCount existe ‚Äì ce qui retournera faux lorsqu'interpr√©t√© dans CUPS/Ghostscript ‚Äì avant d'imprimer r√©ellement le document comme montr√© ci-dessous.
```
currentsystemparams (PageCount) known {
<@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
Ainsi, le logiciel de comptabilit√© utilis√© par CUPS rend un document diff√©rent de celui de l'imprimante. **CUPS ne compte qu'une seule page** ‚Äì ce qui semble √™tre un **minimum cod√© en dur** ‚Äì tandis que le **vrai** travail d'impression peut contenir **des centaines** **de pages**. Notez que l'utilisation de la file d'attente/option 'raw' IPP est obligatoire, sinon CUPS analyse le code avec un filtre PostScript vers PostScript (ps2write de Ghostscript) avant qu'il n'atteigne le compteur de pages.

**Comment tester cette attaque ?**

**Encapsulez** un **document PostScript de plusieurs pages** arbitraire dans le **code ci-dessus** et imprimez. Ensuite, allez sur [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which\_jobs=all) et v√©rifiez le compteur de pages de CUPS pour ce travail d'impression. Notez que vous devez √©tablir une file d'attente raw. C'est-√†-dire, une file d'attente o√π le syst√®me de filtrage n'est pas impliqu√© et le travail d'impression va directement √† une imprimante. Pour CUPS, cela se fait en d√©finissant le type de contenu sur `application/vnd.cups-raw`. Si votre syst√®me est d√©j√† configur√© pour utiliser le serveur d'impression √† tester, utilisez simplement :
```
lp -o raw test.ps
```
<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
