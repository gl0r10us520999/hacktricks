<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# **Introdu√ß√£o**

**Imprimir sem permiss√£o** pode ser um risco de seguran√ßa ou viola√ß√£o da pol√≠tica da empresa. Em ambientes onde os trabalhos de impress√£o s√£o cobrados, um atacante interno tem motiva√ß√£o para burlar o sistema de contabilidade. Al√©m disso, ser capaz de 'imprimir' √© uma pr√©-condi√ß√£o para a maioria dos ataques contra impressoras de rede.

Existem duas abordagens principais quando se trata de contabilidade de trabalhos de impress√£o: **deixar a impressora lidar com isso diretamente ou usar um servidor de impress√£o intermedi√°rio**. A primeira abordagem √© espec√≠fica do fornecedor, geralmente envolve algum tipo de 'driver de impressora' especial e n√£o √© discutida aqui. A outra abordagem envolve um servidor de impress√£o separado ‚Äì geralmente uma implementa√ß√£o de software como [CUPS](https://en.wikipedia.org/wiki/CUPS) ou [LPRng](https://en.wikipedia.org/wiki/LPRng) ‚Äì para lidar com a contabilidade e √© bastante comum em empresas e institui√ß√µes. O servidor de impress√£o pode usar LPD, IPP ou outros protocolos de impress√£o e encaminha os trabalhos para a impressora real. **√â importante notar que o acesso direto √† rede da impressora deve ser restrito**, caso contr√°rio, um atacante pode **burlar facilmente o servidor de impress√£o** e seus mecanismos de contabilidade. Isso significa filtrar o acesso a portas t√≠picas e at√≠picas (LPD, IPP, raw, HTTP, SMB, FTP, SNMP).

Basicamente, existem duas abordagens para contornar os sistemas de contabilidade de trabalhos de impress√£o: **personificar outro usu√°rio ou manipular o contador** de p√°ginas impressas. A seguir, ambas as op√ß√µes s√£o discutidas para instala√ß√µes de LPRng (v3.8.B) e CUPS (v2.1.4), que s√£o sistemas de impress√£o de c√≥digo aberto populares usados em ambientes acad√™micos e corporativos. Abaixo √© apresentada uma compara√ß√£o das caracter√≠sticas de seguran√ßa de ambos os sistemas.

| Sistema de impress√£o | Protocolo | Criptografia | Autentica√ß√£o | Contador de p√°ginas |
| -------------------- | --------- | ------------ | ------------ | ------------------- |
| **LPRng**            | LPD       | SSL/TLS      | Kerberos, PGP| hardware            |
| **CUPS**             | IPP       | SSL/TLS      | Kerberos, HTTP| software           |

# Bypass de autentica√ß√£o

LPRng e CUPS oferecem criptografia de canal baseada em SSL e esquemas de autentica√ß√£o seguros como [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), [PGP](https://en.wikipedia.org/wiki/Pretty\_Good\_Privacy) para trabalhos de impress√£o assinados ou autentica√ß√£o HTTP [b√°sica](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Se **configurados corretamente** e caso o atacante n√£o possa acessar a impressora diretamente, ele **n√£o ser√° capaz de personificar outros usu√°rios**. No entanto, esses recursos de seguran√ßa s√£o **opcionais e raramente aplicados** nos servidores de impress√£o do mundo real. Em vez disso, os **nomes de usu√°rio fornecidos como par√¢metros LPD (LPRng) ou IPP (CUPS) s√£o registrados e contabilizados** ‚Äì que podem ser definidos para valores arbitr√°rios pelo lado do cliente. A raz√£o para isso √© uma simples considera√ß√£o de custo-benef√≠cio na maioria das institui√ß√µes**: Kerberos requer uma configura√ß√£o especial** em cada cliente e a autentica√ß√£o **HTTP** **exige** que os usu√°rios digitem uma **senha** sempre que quiserem imprimir algo, enquanto os custos de algumas impress√µes n√£o contabilizadas s√£o suport√°veis.

Voc√™ pode **verificar a autentica√ß√£o adequada** tentando imprimir com um **nome de usu√°rio personalizado** assim:
```
lp -U nobody test.ps
```
# Manipula√ß√£o do contador de p√°ginas

## Contadores de p√°ginas de hardware

Para uma contabilidade correta, **o n√∫mero de p√°ginas impressas deve ser determinado** pelo sistema de impress√£o, o que n√£o √© uma tarefa trivial. Os autores do **LPRng** _assumem que a impressora possui algum tipo de mecanismo de contador de p√°ginas n√£o vol√°til que √© confi√°vel e imune a ciclos de ligar/desligar_. Tais **contadores de p√°ginas de hardware** s√£o suportados pela maioria das impressoras e **lidos** pelo LPRng **usando PJL ap√≥s** cada **trabalho de impress√£o**. A **HP** at√© documentou um recurso para **escrever** no **contador de p√°ginas** vari√°vel, colocando a impressora em modo de servi√ßo. Dessa forma, o **contador de p√°ginas** da _HP LaserJet 1200, HP LaserJet 4200N_ e _HP LaserJet 4250N_ **pode ser manipulado** dentro de um trabalho de impress√£o. No final do documento a ser impresso e separado pelo [UEL](./#uel), o contador simplesmente tem que ser redefinido para o seu valor original (por exemplo, `2342`):
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Um atacante pode definir um n√∫mero negativo de p√°ginas impressas. Observe que redefinir o dispositivo para [Configura√ß√µes de f√°brica](factory-defaults.md) tamb√©m **redefine o contador de p√°ginas para zero em alguns** dos dispositivos testados.\
Diminuir o contador de p√°ginas tamb√©m pode ser usado para **vender uma impressora acima do seu pre√ßo**, pois pode ser comparado ao od√¥metro ao comprar um carro usado. No entanto, vale ressaltar que **redefinir o contador de p√°ginas n√£o √© necessariamente para fins maliciosos**: √â um modelo de neg√≥cios bem conhecido vender tinta cara para dispositivos jato de tinta de baixo custo e bloquear kits de recarga de terceiros, recusando-se a imprimir ap√≥s um determinado n√∫mero de p√°ginas ‚Äì para lidar com tais pr√°ticas anti√©ticas, √© absolutamente leg√≠timo redefinir o contador de p√°ginas.

Em modelos antigos de HP LaserJets, o comando `pagecount` do [PRET](https://github.com/RUB-NDS/PRET) pode ser usado para definir facilmente contadores de p√°ginas de hardware:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Contadores de p√°ginas de software

**CUPS** utiliza **contadores de p√°ginas de software** que foram implementados para todas as principais linguagens de descri√ß√£o de p√°ginas. Para PostScript, uma maneira f√°cil de contornar a contabilidade √© verificar se o par√¢metro do sistema PageCount existe ‚Äì o que retornar√° falso quando interpretado em CUPS/Ghostscript ‚Äì antes de realmente imprimir o documento, conforme mostrado abaixo.
```
currentsystemparams (PageCount) known {
<@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
```markdown
Dessa forma, o software de contabilidade usado pelo CUPS renderiza um documento diferente do que a impressora. **O CUPS s√≥ contabiliza uma p√°gina** ‚Äì o que parece ser um **m√≠nimo codificado** ‚Äì enquanto o trabalho de impress√£o **real** pode conter **centenas** **de p√°ginas**. Observe que o uso da fila/op√ß√£o 'raw' do IPP √© obrigat√≥rio, caso contr√°rio, o CUPS analisa o c√≥digo com um filtro de PostScript para PostScript (ps2write do Ghostscript) antes de chegar ao contador de p√°ginas.

**Como testar esse ataque?**

**Embrulhe** um **documento PostScript de v√°rias p√°ginas** arbitr√°rio no **c√≥digo acima** e imprima. Em seguida, acesse [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which_jobs=all) e verifique o contador de p√°ginas do CUPS para este trabalho de impress√£o. Observe que voc√™ deve estabelecer uma fila raw. Isto √©, uma fila onde o sistema de filtragem n√£o est√° envolvido e o trabalho de impress√£o vai diretamente para uma impressora. Para o CUPS, isso √© feito definindo o tipo de conte√∫do para `application/vnd.cups-raw`. Se o seu sistema j√° estiver configurado para usar o servidor de impress√£o a ser testado, simplesmente use:
```
```
lp -o raw test.ps
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
