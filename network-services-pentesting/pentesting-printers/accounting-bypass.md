<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# **Introducci√≥n**

**Imprimir sin permiso** puede ser un riesgo de seguridad o una violaci√≥n de la pol√≠tica de la empresa. En entornos donde se cobra por los trabajos de impresi√≥n, un atacante interno tiene motivaci√≥n para eludir el sistema de contabilidad. Adem√°s, poder 'imprimir' es una condici√≥n previa para la mayor√≠a de los ataques contra impresoras de red.

Hay dos enfoques principales cuando se trata de la contabilidad de trabajos de impresi√≥n: **dejar que la impresora lo maneje directamente o usar un servidor de impresi√≥n intermedio**. El primer enfoque es espec√≠fico del proveedor, generalmente implica alg√∫n tipo de 'controlador de impresora' especial y no se discute m√°s aqu√≠. El otro enfoque implica un servidor de impresi√≥n separado, generalmente una implementaci√≥n de software como [CUPS](https://en.wikipedia.org/wiki/CUPS) o [LPRng](https://en.wikipedia.org/wiki/LPRng), para manejar la contabilidad y es bastante com√∫n en empresas e instituciones. El servidor de impresi√≥n puede utilizar LPD, IPP u otros protocolos de impresi√≥n y reenv√≠a los trabajos a la impresora real. **Es importante notar que el acceso directo a la red de la impresora debe estar restringido**, de lo contrario, un atacante puede **eludir f√°cilmente el servidor de impresi√≥n** y sus mecanismos de contabilidad. Esto significa filtrar el acceso a puertos t√≠picos y at√≠picos (LPD, IPP, raw, HTTP, SMB, FTP, SNMP).

Hay b√°sicamente dos enfoques para eludir los sistemas de contabilidad de trabajos de impresi√≥n: **suplantar a otro usuario o manipular el contador** de p√°ginas impresas. A continuaci√≥n, se discuten ambas opciones para instalaciones de LPRng (v3.8.B) y CUPS (v2.1.4), que son sistemas de impresi√≥n de c√≥digo abierto populares utilizados en entornos acad√©micos y corporativos. A continuaci√≥n, se presenta una comparaci√≥n de las caracter√≠sticas de seguridad de ambos sistemas.

| Sistema de impresi√≥n | Protocolo | Encriptaci√≥n | Autenticaci√≥n | Contador de p√°ginas |
| -------------------- | --------- | ------------ | ------------- | ------------------- |
| **LPRng**            | LPD       | SSL/TLS      | Kerberos, PGP | hardware            |
| **CUPS**             | IPP       | SSL/TLS      | Kerberos, HTTP | software           |

# Elusiones de autenticaci√≥n

LPRng y CUPS ofrecen encriptaci√≥n de canal basada en SSL y esquemas de autenticaci√≥n seguros como [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), trabajos de impresi√≥n firmados con [PGP](https://en.wikipedia.org/wiki/Pretty\_Good\_Privacy) o autenticaci√≥n HTTP [b√°sica](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Si se **configuran correctamente** y en caso de que el atacante no pueda acceder directamente a la impresora, **no podr√° suplantar a otros usuarios**. Sin embargo, estas caracter√≠sticas de seguridad son **opcionales y raramente se aplican** en los servidores de impresi√≥n reales. En cambio, los **nombres de usuario dados como par√°metros LPD (LPRng) o IPP (CUPS) se registran y se contabilizan** ‚Äì los cuales pueden ser establecidos con valores arbitrarios por el lado del cliente. La raz√≥n de esto es una simple consideraci√≥n de costo-beneficio en la mayor√≠a de las instituciones**: Kerberos necesita una configuraci√≥n especial** en cada cliente y la autenticaci√≥n **HTTP** **requiere** que los usuarios ingresen una **contrase√±a** cada vez que quieren imprimir algo, mientras que el costo de algunas impresiones no contabilizadas es soportable.

Puedes **verificar la autenticaci√≥n adecuada** intentando imprimir con un **nombre de usuario personalizado** de la siguiente manera:
```
lp -U nobody test.ps
```
# Manipulaci√≥n del contador de p√°ginas

## Contadores de p√°ginas de hardware

Para una contabilidad correcta, **se debe determinar el n√∫mero de p√°ginas impresas** por el sistema de impresi√≥n, lo cual no es una tarea trivial. Los autores de **LPRng** _hacen la suposici√≥n de que la impresora tiene alg√∫n tipo de mecanismo de contador de p√°ginas no vol√°til que es confiable e inmune a ciclos de encendido/apagado_. Tales **contadores de p√°ginas de hardware** son soportados por la mayor√≠a de las impresoras y **le√≠dos** por LPRng **usando PJL despu√©s** de cada trabajo de **impresi√≥n**. **HP** incluso ha documentado una caracter√≠stica para **escribir** en la variable del **contador de p√°ginas** al poner la impresora en modo de servicio. De esta manera, el **contador de p√°ginas** de la _HP LaserJet 1200, HP LaserJet 4200N_ y _HP LaserJet 4250N_ **puede ser manipulado** dentro de un trabajo de impresi√≥n. Al final del documento a imprimir y separado por el [UEL](./#uel), el contador simplemente tiene que ser restablecido a su valor original (por ejemplo, `2342`):
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Un atacante podr√≠a establecer un n√∫mero negativo de p√°ginas impresas. Tenga en cuenta que restablecer el dispositivo a los [valores de f√°brica](factory-defaults.md) tambi√©n **restablece el contador de p√°ginas a cero en algunos** de los dispositivos probados.\
Reducir el contador de p√°ginas tambi√©n puede usarse para **vender una impresora por encima de su precio**, ya que se puede comparar con el od√≥metro al comprar un coche de segunda mano. Sin embargo, es importante enfatizar que **restablecer el contador de p√°ginas no es necesariamente con fines maliciosos**: Es un modelo de negocio bien conocido vender tinta sobrevalorada para dispositivos de inyecci√≥n de tinta de bajo costo y bloquear kits de recarga de terceros al negarse a imprimir despu√©s de un cierto n√∫mero de p√°ginas ‚Äì para manejar tales pr√°cticas poco √©ticas es absolutamente leg√≠timo restablecer el contador de p√°ginas.

En impresoras l√°ser HP antiguas, el comando `pagecount` de [PRET](https://github.com/RUB-NDS/PRET) puede usarse para establecer f√°cilmente contadores de p√°ginas de hardware:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Contadores de p√°ginas de software

**CUPS** utiliza **contadores de p√°ginas de software** que han sido implementados para todos los principales lenguajes de descripci√≥n de p√°ginas. Para PostScript, una forma f√°cil de evadir la contabilidad es verificar si el par√°metro del sistema PageCount existe ‚Äì lo cual retornar√° falso cuando se interprete en CUPS/Ghostscript ‚Äì antes de imprimir realmente el documento como se muestra a continuaci√≥n.
```
currentsystemparams (PageCount) known {
<@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
De esta manera, el software de contabilidad utilizado por CUPS genera un documento diferente al de la impresora. **CUPS solo contabiliza una p√°gina** ‚Äì que parece ser un **m√≠nimo codificado** ‚Äì mientras que el trabajo de impresi√≥n **real** puede contener **cientos** **de p√°ginas**. Tenga en cuenta que es obligatorio utilizar la cola/opci√≥n 'raw' de IPP, de lo contrario, CUPS analiza el c√≥digo con un filtro de PostScript a PostScript (ps2write de Ghostscript) antes de que alcance el contador de p√°ginas.

**¬øC√≥mo probar este ataque?**

**Envuelva** un **documento PostScript de varias p√°ginas** arbitrario en el **c√≥digo anterior** e imprima. Luego vaya a [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which\_jobs=all) y verifique el contador de p√°ginas de CUPS para este trabajo de impresi√≥n. Tenga en cuenta que tiene que establecer una cola raw. Es decir, una cola donde el sistema de filtrado no interviene y el trabajo de impresi√≥n va directamente a una impresora. Para CUPS, esto se hace configurando el tipo de contenido a `application/vnd.cups-raw`. Si su sistema ya est√° configurado para usar el servidor de impresi√≥n a ser probado, simplemente use:
```
lp -o raw test.ps
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
