<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>


ユーザーにHTTP POSTリクエストを複数のIPのポート9100に送信させ、オープンなrawプリントポートを探します。見つかった場合、**HTTPヘッダーはプリンターの設定に基づいてプレーンテキストとして印刷されるか、破棄されます**。しかし、**POSTデータ**には、解釈される**PostScript**や**PJL**コマンドなどの任意のプリントジョブを**含む**ことができます。

### 強化されたクロスサイトプリンティング

内部プリンターにHTTP POSTリクエストを実行するために、XMLHttpRequest (XHR) JavaScriptオブジェクトを使用できます。これまでに議論されたクロスサイトプリンティングのアプローチの制限は、同一生成元ポリシーのために**デバイスにデータを送信することはできますが、受信することはできません**。同一生成元ポリシーの**制限を曲げる**ために、CORSリクエストを許可する偽のがら**有効なHTTPレスポンス**（`Access-Control-Allow-Origin=*`を含む）で**サーバー**が応答するように**作る**ことができます。攻撃の概要図は以下の通りです：

![CORSスプーフィングを伴う高度なクロスサイトプリンティング](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

CORSスプーフィングと組み合わせたこのような強化されたXSPのバリアントでは、ウェブ攻撃者はHTTPレスポンスに完全にアクセスでき、プリンターデバイスからキャプチャされたプリントジョブなどの任意の情報を抽出することができます。以下に、概念実証のJavaScriptスニペットを示します：
```javascript
job = "\x1B%-12345X\r\n"
+ "%!\r\n"
+ "(HTTP/1.0 200 OK\\n) print\r\n"
+ "(Server: PostScript HTTPD\\n) print\r\n"
+ "(Access-Control-Allow-Origin: *\\n) print\r\n"
+ "(Connection: close\\n) print\r\n"
+ "(Content-Length: ) print\r\n"
+ "product dup length dup string cvs print\r\n"
+ "(\\n\\n) print\r\n"
+ "print\r\n"
+ "(\\n) print flush\r\n"
+ "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
if (x.readyState == 4)
alert(x.responseText);
};
```
### クロスサイト印刷の制限

**PCL**はページ記述言語として**CORSスプーフィングには適用できない**ことに注意してください。なぜなら、**単一の数字**のみを**エコー**することができるからです。**PJLも同様に使用できません**。残念ながら、すべてのエコーされた文字列の前に`@PJL ECHO`が追加されるため、有効なHTTPヘッダーをシミュレートすることが不可能です。しかし、これは**強化されたXSP攻撃**が**PostScript**ジョブに**限定される**という意味では**ありません**：PostScriptは偽装されたHTTPヘッダーで応答するために使用でき、[**UEL**](./#uel)はプリンター言語を切り替えるためにさらに呼び出すことができます。この方法で、ウェブ攻撃者はPJLコマンドの結果も取得することができます。実装上の2つの落とし穴が存在し、言及する価値があります：まず、PostScriptで応答するデータの正しい`Content-Length`を決定する必要があります。攻撃者が応答の全体的なサイズを予測できない場合、またはチャンクエンコーディングもオプションではない場合、非常に高い値を設定し、パディングを使用する必要があります。次に、`Connection: close`ヘッダーフィールドを追加することが重要です。そうでなければ、HTTP/1.1接続はウェブクライアントまたはプリンターデバイスがタイムアウトを引き起こすまで維持され、これはプリンターがしばらくの間アクセスできなくなることを意味します。

**もし**プリンターデバイスが**プレーンテキスト印刷**をサポートしている場合、XHRの**HTTPリクエスト**ヘッダーが紙のコピーとして出力されます。これには、悪意のあるJavaScriptを呼び出したURLを含む`Origin`ヘッダーフィールドが含まれており、攻撃者が**静かに留まる**ことを**困難**にします。これは避けられません。なぜなら、HTTPボディが処理されるまで、そしてHTTPヘッダーがプリンターデバイスによってプレーンテキストとして解釈されてしまった後でないと、プリンターの制御を得ることができないからです。そして、印刷機能を無効にすることができるかもしれません。もしノイズを減らすことが優先事項であれば、攻撃者はIPP、LPD、FTP、またはプリンターの組み込みウェブサーバーなど、他の潜在的なXSPチャネルを使用して、[PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document\_processing#PJL\_jobmedia)で提案されている独自のPJLコマンドで印刷機能を最初に無効にすることを**試みる**ことができます。クロスプロトコルスクリプティングのバリアントを使用して印刷ジョブをデプロイするすべてのプロトコルは成功裏にテストされましたが、偽装されたCORSヘッダーを使用してフィードバックを提供しないことを超えていくつかの欠点があります：

* クロスプロトコルアクセスは、さまざまなウェブブラウザによってLPDおよびFTPポートがブロックされています
* 組み込みウェブサーバーを介した直接印刷のパラメーターはモデル固有です
* IPP標準では、HTTP POSTリクエストの`Content-type`が`application/ipp`に設定されることが求められますが、XHRオブジェクトではこれを行うことはできません。しかし、実装によっては、不正なタイプに実際に気を配るかどうかは異なります

以下にクロスサイト印刷チャネルの比較を示します：

| チャネル | ポート | フィードバックなし | 予期せぬ印刷物 | 標準化 | ブロックされている |
| ------- | ---- | ---------------- | ------------- | ------ | ---------------- |
| Raw     | 9100 | -                | ✔             | ✔      | -                |
| Web     | 80   | ✔                | -             | -      | -                |
| IPP     | 631  | ✔                | -             | ✔      | -                |
| LPD     | 515  | ✔                | -             | ✔      | FF, Ch, Op       |
| FTP     | 21   | ✔                | -             | ✔      | FF, Ch, Op, IE   |

XSPの主な問題の一つは、**プリンター**の**正しいアドレス**またはホスト名を**見つける**ことです。私たちのアプローチは、最新のブラウザに実装されている**WebRTCを悪用する**ことです。これには、ローカルネットワークインターフェースのIPアドレスを列挙する機能があります。ローカルIPアドレスが与えられたら、XHRオブジェクトはさらに、残りの253のアドレスすべてに対して**9100/tcp**ポートへの接続を開き、PostScriptとCORSスプーフィングを使用してプリンター製品名を取得します。これは私たちのテストでは数秒で完了します。もしプリンターが被害者のホストと同じサブネット上にある場合、そのアドレスはJavaScriptのみを使用して検出することができます。WebRTCはSafariの開発中であり、Firefox、Chrome、Microsoft Edgeの現行バージョンによってサポートされています。Internet ExplorerにはWebRTCのサポートがありませんが、VBScriptやJavaも同様にローカルIPアドレスをリークするために使用することができます。もしローカルインターフェースのアドレスが取得できない場合、私たちはインテリジェントなブルートフォースアプローチを適用します：XHRオブジェクトを使用して、被害者のルーターのポート80に接続を試みます。これには、さまざまなインターネットアクセス可能なリソースからコンパイルされた115のデフォルトルーターアドレスのリストが使用されます。もしルーターにアクセスできる場合、前述のようにサブネット内のプリンターをスキャンします。

## 実証実験

高度なクロスサイト印刷攻撃が実用的であり、企業や機関にとって実際の脅威であることを示す実証実験の実装は、[hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)で利用可能です


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
