<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


Vous pouvez faire en sorte qu'un utilisateur envoie une requ√™te HTTP POST au port 9100 de plusieurs IP essayant d'atteindre un port d'impression raw ouvert. Si trouv√©, **l'en-t√™te HTTP est soit imprim√© en texte clair soit ignor√©** selon les param√®tres de l'imprimante. Les **donn√©es POST** cependant peuvent **contenir** des travaux d'impression arbitraires comme des commandes **PostScript** ou **PJL** √† √™tre **interpr√©t√©es**.

### Impression cross-site am√©lior√©e

Vous pouvez utiliser des objets JavaScript XMLHttpRequest (XHR) comme d√©fini pour effectuer des requ√™tes HTTP POST vers des imprimantes internes. Une limitation de l'approche d'impression cross-site discut√©e jusqu'√† pr√©sent est que **les donn√©es ne peuvent √™tre envoy√©es qu'√† l'appareil**, **non re√ßues** √† cause de la politique de m√™me origine. Pour **contourner** les **restrictions** de la politique de m√™me origine, vous pouvez **faire** en sorte que **le serveur** r√©ponde avec une fausse mais **valide r√©ponse HTTP** autorisant les requ√™tes CORS (y compris `Access-Control-Allow-Origin=*`). Un aper√ßu sch√©matique de l'attaque est donn√© ci-dessous :

![Impression cross-site avanc√©e avec usurpation CORS](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

Dans une telle variante am√©lior√©e de XSP ‚Äì combin√©e avec l'usurpation CORS ‚Äì un attaquant web a un acc√®s complet √† la r√©ponse HTTP ce qui lui permet d'extraire des informations arbitraires comme des travaux d'impression captur√©s de l'appareil d'impression. Un extrait de code JavaScript de preuve de concept est montr√© ci-dessous :
```javascript
job = "\x1B%-12345X\r\n"
+ "%!\r\n"
+ "(HTTP/1.0 200 OK\\n) print\r\n"
+ "(Server: PostScript HTTPD\\n) print\r\n"
+ "(Access-Control-Allow-Origin: *\\n) print\r\n"
+ "(Connection: close\\n) print\r\n"
+ "(Content-Length: ) print\r\n"
+ "product dup length dup string cvs print\r\n"
+ "(\\n\\n) print\r\n"
+ "print\r\n"
+ "(\\n) print flush\r\n"
+ "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
if (x.readyState == 4)
alert(x.responseText);
};
```
### Limitations de l'impression cross-site

Notez que **PCL** en tant que langage de description de page n'est **pas applicable pour le spoofing CORS** car il ne permet que l'√©cho d'un **seul nombre**. **PJL ne peut √©galement pas** √™tre utilis√© car malheureusement il ajoute `@PJL ECHO` √† toutes les cha√Ænes √©cho, ce qui rend impossible de simuler un en-t√™te HTTP valide. Cependant, cela ne signifie **pas** que les attaques **XSP am√©lior√©es** sont **limit√©es** √† **PostScript** : PostScript peut √™tre utilis√© pour r√©pondre avec un en-t√™te HTTP usurp√© et **le** [**UEL**](./#uel) **peut ensuite √™tre invoqu√© pour changer le langage de l'imprimante**. De cette mani√®re, un attaquant web peut √©galement obtenir les r√©sultats des commandes PJL. Deux pi√®ges de mise en ≈ìuvre existent qui m√©ritent d'√™tre mentionn√©s : Premi√®rement, une `Content-Length` correcte pour les donn√©es √† r√©pondre doit √™tre d√©termin√©e avec PostScript. Si l'attaquant ne peut pas pr√©dire la taille globale de la r√©ponse et que l'encodage en morceaux n'est pas une option non plus, elle doit d√©finir une valeur tr√®s √©lev√©e et utiliser du remplissage. Deuxi√®mement, ajouter le champ d'en-t√™te `Connection: close` est important, sinon les connexions HTTP/1.1 sont maintenues actives jusqu'√† ce que le client web ou l'appareil d'impression d√©clenche un d√©lai d'attente, ce qui signifie que l'imprimante ne sera pas accessible pendant un certain temps.

**Si** l'appareil d'impression prend en charge **l'impression de texte brut**, l'en-t√™te de **la requ√™te HTTP** du XHR est imprim√© sous forme de copie papier ‚Äì y compris le champ d'en-t√™te `Origin` contenant l'URL qui a invoqu√© le JavaScript malveillant, rendant ainsi **difficile** pour un attaquant de **rester silencieux**. Cela est in√©vitable, car nous ne prenons pas le contr√¥le de l'imprimante ‚Äì et sous certaines circonstances pouvons d√©sactiver la fonctionnalit√© d'impression ‚Äì jusqu'√† ce que le corps HTTP soit trait√© et que l'en-t√™te HTTP ait d√©j√† √©t√© interpr√©t√© comme du texte brut par l'appareil d'impression. Si r√©duire le bruit est une priorit√©, l'attaquant peut cependant **essayer de d√©sactiver d'abord la fonctionnalit√© d'impression** avec des commandes PJL propri√©taires comme propos√© dans [PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document_processing#PJL_jobmedia) en utilisant d'autres canaux XSP potentiels comme IPP, LPD, FTP ou le serveur web embarqu√© de l'imprimante. Bien que tous les protocoles aient pu √™tre test√©s avec succ√®s pour d√©ployer des travaux d'impression en utilisant des variantes de scripting cross-protocole, ils pr√©sentent certains inconv√©nients au-del√† de ne pas fournir de retour d'information en utilisant des en-t√™tes CORS usurp√©s :

* L'acc√®s cross-protocole aux ports LPD et FTP est bloqu√© par divers navigateurs web
* Les param√®tres pour l'impression directe via le serveur web embarqu√© sont sp√©cifiques au mod√®le
* La norme IPP exige que le `Content-type` pour les requ√™tes HTTP POST soit d√©fini sur `application/ipp`, ce qui ne peut pas √™tre fait avec des objets XHR ‚Äì cependant, il appartient √† l'impl√©mentation de se soucier r√©ellement des types incorrects

Une comparaison des canaux d'impression cross-site est donn√©e ci-dessous :

| Canal  | Port | Pas de retour | Impressions non sollicit√©es | Standardis√© | Bloqu√© par     |
| ------ | ---- | ------------- | --------------------------- | ----------- | -------------- |
| Raw    | 9100 | -             | ‚úî                           | ‚úî           | -              |
| Web    | 80   | ‚úî             | -                           | -           | -              |
| IPP    | 631  | ‚úî             | -                           | ‚úî           | -              |
| LPD    | 515  | ‚úî             | -                           | ‚úî           | FF, Ch, Op     |
| FTP    | 21   | ‚úî             | -                           | ‚úî           | FF, Ch, Op, IE |

Un probl√®me majeur du XSP est de **trouver** l'**adresse correcte** ou le nom d'h√¥te de l'**imprimante**. Notre approche consiste √† **abuser de WebRTC** qui est impl√©ment√© dans la plupart des navigateurs modernes et a la fonctionnalit√© d'√©num√©rer les adresses IP pour les interfaces r√©seau locales. √âtant donn√© l'adresse IP locale, des objets XHR sont en outre utilis√©s pour ouvrir des connexions au port **9100/tcp** pour les 253 adresses restantes afin de r√©cup√©rer le nom du produit de l'imprimante en utilisant PostScript et le spoofing CORS, ce qui ne prend que quelques secondes dans nos tests. Si l'imprimante est sur le m√™me sous-r√©seau que l'h√¥te de la victime, son adresse peut √™tre d√©tect√©e uniquement √† l'aide de JavaScript. WebRTC est en d√©veloppement pour Safari et pris en charge par les versions actuelles de Firefox, Chrome et Microsoft Edge. Internet Explorer n'a pas de support WebRTC, mais VBScript et Java peuvent √©galement √™tre utilis√©s pour divulguer l'adresse IP locale. Si l'adresse de l'interface locale ne peut pas √™tre r√©cup√©r√©e, nous appliquons une approche de force brute intelligente : Nous essayons de nous connecter au port 80 du routeur de la victime √† l'aide d'objets XHR. Pour cela, une liste de 115 adresses de routeur par d√©faut provenant de diverses ressources accessibles sur Internet a √©t√© compil√©e. Si un routeur est accessible, nous scannons le sous-r√©seau pour les imprimantes comme d√©crit pr√©c√©demment.

## Preuve de concept

Une impl√©mentation de preuve de concept d√©montrant que les attaques d'impression cross-site avanc√©es sont pratiques et une menace r√©elle pour les entreprises et les institutions est disponible sur [hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
