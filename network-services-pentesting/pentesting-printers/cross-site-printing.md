<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


Puedes hacer que un usuario env√≠e una solicitud HTTP POST al puerto 9100 de varias IPs intentando alcanzar un puerto de impresi√≥n raw abierto. Si se encuentra, el **encabezado HTTP se imprime como texto plano o se descarta** seg√∫n la configuraci√≥n de la impresora. Sin embargo, los **datos POST** pueden **contener** trabajos de impresi√≥n arbitrarios como comandos **PostScript** o **PJL** para ser **interpretados**.

### Impresi√≥n cross-site mejorada

Puedes usar objetos JavaScript XMLHttpRequest (XHR) como se define para realizar solicitudes HTTP POST a impresoras internas. Una limitaci√≥n del enfoque de impresi√≥n cross-site discutido hasta ahora es que **solo se pueden enviar datos al dispositivo**, **no recibirlos** debido a la pol√≠tica de mismo origen. Para **doblar** las **restricciones** de la pol√≠tica de mismo origen, puedes **hacer** que el **servidor** responda con una respuesta HTTP falsa pero **v√°lida** que permita solicitudes CORS (incluyendo `Access-Control-Allow-Origin=*`). A continuaci√≥n se muestra una visi√≥n esquem√°tica del ataque:

![Impresi√≥n cross-site avanzada con suplantaci√≥n de CORS](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

En tal variante mejorada de XSP ‚Äì combinada con suplantaci√≥n de CORS ‚Äì un atacante web tiene acceso completo a la respuesta HTTP, lo que le permite extraer informaci√≥n arbitraria como trabajos de impresi√≥n capturados del dispositivo de impresi√≥n. A continuaci√≥n se muestra un fragmento de c√≥digo JavaScript de prueba de concepto:
```javascript
job = "\x1B%-12345X\r\n"
+ "%!\r\n"
+ "(HTTP/1.0 200 OK\\n) print\r\n"
+ "(Server: PostScript HTTPD\\n) print\r\n"
+ "(Access-Control-Allow-Origin: *\\n) print\r\n"
+ "(Connection: close\\n) print\r\n"
+ "(Content-Length: ) print\r\n"
+ "product dup length dup string cvs print\r\n"
+ "(\\n\\n) print\r\n"
+ "print\r\n"
+ "(\\n) print flush\r\n"
+ "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
if (x.readyState == 4)
alert(x.responseText);
};
```
### Limitaciones de la impresi√≥n cruzada

Tenga en cuenta que **PCL** como lenguaje de descripci√≥n de p√°gina **no es aplicable para el spoofing de CORS** porque solo permite que se **eco** un **√∫nico n√∫mero**. **PJL tampoco puede** usarse porque desafortunadamente antepone `@PJL ECHO` a todas las cadenas eco, lo que hace imposible simular un encabezado HTTP v√°lido. Sin embargo, esto **no** significa que los ataques **XSP mejorados** est√©n **limitados** a trabajos **PostScript**: PostScript se puede usar para responder con un encabezado HTTP falsificado y **el** [**UEL**](./#uel) **puede invocarse adicionalmente para cambiar el lenguaje de la impresora**. De esta manera, un atacante web tambi√©n puede obtener los resultados de los comandos PJL. Existen dos trampas de implementaci√≥n que merecen ser mencionadas: Primero, se necesita determinar un `Content-Length` correcto para los datos a responder con PostScript. Si el atacante no puede predecir el tama√±o total de la respuesta y la codificaci√≥n fragmentada tampoco es una opci√≥n, necesita establecer un valor muy alto y usar relleno. Segundo, es importante agregar el campo de encabezado `Connection: close`, de lo contrario, las conexiones HTTP/1.1 se mantienen activas hasta que el cliente web o el dispositivo de la impresora activan un tiempo de espera, lo que significa que la impresora no ser√° accesible durante alg√∫n tiempo.

**Si** el dispositivo de la impresora admite la **impresi√≥n de texto plano**, el encabezado de la **solicitud HTTP** del XHR se imprime como copia en papel, incluido el campo de encabezado `Origin` que contiene la URL que invoc√≥ el JavaScript malicioso, lo que hace **dif√≠cil** para un atacante **permanecer en silencio**. Esto es inevitable, ya que no obtenemos control sobre la impresora ‚Äì y bajo algunas circunstancias podemos deshabilitar la funcionalidad de impresi√≥n ‚Äì hasta que se procese el cuerpo HTTP y el encabezado HTTP ya haya sido interpretado como texto plano por el dispositivo de la impresora. Si reducir el ruido es una prioridad, el atacante puede **intentar primero deshabilitar la funcionalidad de impresi√≥n** con comandos PJL propietarios como se propone en [PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document\_processing#PJL\_jobmedia) utilizando otros canales XSP potenciales como IPP, LPD, FTP o el servidor web integrado de la impresora. Aunque todos los protocolos podr√≠an probarse con √©xito para implementar trabajos de impresi√≥n utilizando variantes de scripting entre protocolos, tienen algunas desventajas m√°s all√° de no proporcionar retroalimentaci√≥n utilizando encabezados CORS falsificados:

* El acceso entre protocolos a los puertos LPD y FTP est√° bloqueado por varios navegadores web
* Los par√°metros para la impresi√≥n directa a trav√©s del servidor web integrado son espec√≠ficos del modelo
* El est√°ndar IPP requiere que el `Content-type` para las solicitudes HTTP POST se establezca en `application/ipp`, lo cual no se puede hacer con objetos XHR ‚Äì sin embargo, depende de la implementaci√≥n preocuparse realmente por los tipos incorrectos

A continuaci√≥n se presenta una comparaci√≥n de los canales de impresi√≥n cruzada:

| Canal  | Puerto | Sin Retroalimentaci√≥n | Impresiones no solicitadas | Estandarizado | Bloqueado por |
| ------ | ------ | --------------------- | -------------------------- | ------------- | ------------- |
| Raw    | 9100   | -                     | ‚úî                          | ‚úî             | -             |
| Web    | 80     | ‚úî                     | -                          | -             | -             |
| IPP    | 631    | ‚úî                     | -                          | ‚úî             | -             |
| LPD    | 515    | ‚úî                     | -                          | ‚úî             | FF, Ch, Op    |
| FTP    | 21     | ‚úî                     | -                          | ‚úî             | FF, Ch, Op, IE|

Un problema importante de XSP es **encontrar** la **direcci√≥n correcta** o el nombre de host de la **impresora**. Nuestro enfoque es **abusar de WebRTC** que est√° implementado en la mayor√≠a de los navegadores modernos y tiene la caracter√≠stica de enumerar direcciones IP para interfaces de red locales. Dada la direcci√≥n IP local, se utilizan adem√°s objetos XHR para abrir conexiones al puerto **9100/tcp** para todas las 253 direcciones restantes para recuperar el nombre del producto de la impresora usando PostScript y spoofing de CORS, lo que solo toma segundos en nuestras pruebas. Si la impresora est√° en la misma subred que el host de la v√≠ctima, su direcci√≥n se puede detectar √∫nicamente usando JavaScript. WebRTC est√° en desarrollo para Safari y es compatible con las versiones actuales de Firefox, Chrome y Microsoft Edge. Internet Explorer no tiene soporte para WebRTC, pero VBScript y Java tambi√©n se pueden usar para filtrar la direcci√≥n IP local. Si no se puede recuperar la direcci√≥n de la interfaz local, aplicamos un enfoque de fuerza bruta inteligente: intentamos conectarnos al puerto 80 del enrutador de la v√≠ctima usando objetos XHR. Para ello, se compil√≥ una lista de 115 direcciones de enrutadores predeterminadas de varios recursos accesibles por Internet. Si se puede acceder a un enrutador, escaneamos la subred en busca de impresoras como se describi√≥ anteriormente.

## Prueba de concepto

Una implementaci√≥n de prueba de concepto que demuestra que los ataques avanzados de impresi√≥n cruzada son pr√°cticos y una amenaza real para empresas e instituciones est√° disponible en [hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)


<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
