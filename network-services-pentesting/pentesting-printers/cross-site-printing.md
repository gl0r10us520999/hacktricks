<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


Voc√™ pode fazer um usu√°rio enviar uma requisi√ß√£o HTTP POST para a porta 9100 de v√°rios IPs tentando alcan√ßar uma porta de impress√£o raw aberta. Se encontrada, o **cabe√ßalho HTTP √© impresso como texto simples ou descartado** dependendo das configura√ß√µes da impressora. Os **dados POST**, no entanto, podem **conter** trabalhos de impress√£o arbitr√°rios como comandos **PostScript** ou **PJL** para serem **interpretados**.

### Impress√£o cross-site aprimorada

Voc√™ pode usar objetos JavaScript XMLHttpRequest (XHR) conforme definido para realizar requisi√ß√µes HTTP POST para impressoras internas. Uma limita√ß√£o da abordagem de impress√£o cross-site discutida at√© agora √© que **dados s√≥ podem ser enviados ao dispositivo**, **n√£o recebidos** devido √† pol√≠tica de mesma origem. Para **contornar** as **restri√ß√µes** da pol√≠tica de mesma origem, voc√™ pode **fazer** com que o **servidor** responda com uma resposta HTTP falsa, mas **v√°lida**, permitindo solicita√ß√µes CORS (incluindo `Access-Control-Allow-Origin=*`). Uma vis√£o esquem√°tica do ataque √© fornecida abaixo:

![Impress√£o cross-site avan√ßada com spoofing de CORS](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

Nessa variante aprimorada de XSP ‚Äì combinada com spoofing de CORS ‚Äì um atacante web tem acesso total √† resposta HTTP, o que lhe permite extrair informa√ß√µes arbitr√°rias como trabalhos de impress√£o capturados do dispositivo de impress√£o. Um exemplo de c√≥digo JavaScript de prova de conceito √© mostrado abaixo:
```javascript
job = "\x1B%-12345X\r\n"
+ "%!\r\n"
+ "(HTTP/1.0 200 OK\\n) print\r\n"
+ "(Server: PostScript HTTPD\\n) print\r\n"
+ "(Access-Control-Allow-Origin: *\\n) print\r\n"
+ "(Connection: close\\n) print\r\n"
+ "(Content-Length: ) print\r\n"
+ "product dup length dup string cvs print\r\n"
+ "(\\n\\n) print\r\n"
+ "print\r\n"
+ "(\\n) print flush\r\n"
+ "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
if (x.readyState == 4)
alert(x.responseText);
};
```
### Limita√ß√µes da impress√£o cross-site

Note que **PCL** como linguagem de descri√ß√£o de p√°gina **n√£o √© aplic√°vel para spoofing de CORS** porque s√≥ permite que um **√∫nico n√∫mero** seja **ecoado**. **PJL tamb√©m n√£o pode** ser usado porque, infelizmente, ele antep√µe `@PJL ECHO` a todas as strings ecoadas, o que torna imposs√≠vel simular um cabe√ßalho HTTP v√°lido. No entanto, isso **n√£o** significa que ataques XSP **aprimorados** est√£o **limitados** a trabalhos **PostScript**: PostScript pode ser usado para responder com um cabe√ßalho HTTP falsificado e **o** [**UEL**](./#uel) **pode ser invocado para mudar a linguagem da impressora**. Desta forma, um atacante web tamb√©m pode obter os resultados para comandos PJL. Existem duas armadilhas de implementa√ß√£o que merecem ser mencionadas: Primeiro, um `Content-Length` correto para os dados a serem respondidos precisa ser determinado com PostScript. Se o atacante n√£o pode prever o tamanho total da resposta e a codifica√ß√£o em partes tamb√©m n√£o √© uma op√ß√£o, ele precisa definir um valor muito alto e usar preenchimento. Segundo, adicionar o campo de cabe√ßalho `Connection: close` √© importante, caso contr√°rio, conex√µes HTTP/1.1 s√£o mantidas ativas at√© que o cliente web ou o dispositivo da impressora acione um tempo limite, o que significa que a impressora n√£o estar√° acess√≠vel por algum tempo.

**Se** o dispositivo da impressora suporta **impress√£o de texto simples**, o cabe√ßalho da **solicita√ß√£o HTTP** do XHR √© impresso como c√≥pia f√≠sica ‚Äì incluindo o campo de cabe√ßalho `Origin` contendo a URL que invocou o JavaScript malicioso, tornando **dif√≠cil** para um atacante **permanecer silencioso**. Isso √© inevit√°vel, pois n√£o ganhamos controle sobre a impressora ‚Äì e sob algumas circunst√¢ncias podemos desativar a funcionalidade de impress√£o ‚Äì at√© que o corpo HTTP seja processado e o cabe√ßalho HTTP j√° tenha sido interpretado como texto simples pelo dispositivo da impressora. Se reduzir o ru√≠do √© uma prioridade, o atacante pode, no entanto, **tentar desativar primeiro a funcionalidade de impress√£o** com comandos PJL propriet√°rios conforme proposto em [PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document_processing#PJL_jobmedia) usando outros canais XSP potenciais como IPP, LPD, FTP ou o servidor web embutido da impressora. Embora todos os protocolos pudessem ser testados com sucesso para implantar trabalhos de impress√£o usando variantes de scripting entre protocolos, eles t√™m algumas desvantagens al√©m de n√£o fornecer feedback usando cabe√ßalhos CORS falsificados:

* O acesso cross-protocol a portas LPD e FTP √© bloqueado por v√°rios navegadores web
* Par√¢metros para impress√£o direta pelo servidor web embutido s√£o espec√≠ficos do modelo
* O padr√£o IPP exige que o `Content-type` para solicita√ß√µes HTTP POST seja definido como `application/ipp`, o que n√£o pode ser feito com objetos XHR ‚Äì no entanto, cabe √† implementa√ß√£o realmente se preocupar com tipos incorretos

Uma compara√ß√£o dos canais de impress√£o cross-site √© dada abaixo:

| Canal  | Porta | Sem Feedback | Impress√µes n√£o solicitadas | Padronizado | Bloqueado por |
| ------ | ----- | ------------ | -------------------------- | ----------- | ------------- |
| Raw    | 9100  | -            | ‚úî                          | ‚úî           | -             |
| Web    | 80    | ‚úî            | -                          | -           | -             |
| IPP    | 631   | ‚úî            | -                          | ‚úî           | -             |
| LPD    | 515   | ‚úî            | -                          | ‚úî           | FF, Ch, Op    |
| FTP    | 21    | ‚úî            | -                          | ‚úî           | FF, Ch, Op, IE|

Um grande problema do XSP √© **encontrar** o **endere√ßo correto** ou nome do host da **impressora**. Nossa abordagem √© **abusar do WebRTC** que √© implementado na maioria dos navegadores modernos e tem o recurso de enumerar endere√ßos IP para interfaces de rede locais. Dado o endere√ßo IP local, objetos XHR s√£o usados para abrir conex√µes com a porta **9100/tcp** para todos os 253 endere√ßos restantes para recuperar o nome do produto da impressora usando PostScript e spoofing de CORS, o que leva apenas segundos em nossos testes. Se a impressora estiver na mesma sub-rede que o host da v√≠tima, seu endere√ßo pode ser detectado usando apenas JavaScript. O WebRTC est√° em desenvolvimento para o Safari e √© suportado pelas vers√µes atuais do Firefox, Chrome e Microsoft Edge. O Internet Explorer n√£o tem suporte para WebRTC, mas VBScript e Java tamb√©m podem ser usados para vazar o endere√ßo IP local. Se o endere√ßo da interface local n√£o puder ser recuperado, aplicamos uma abordagem de for√ßa bruta inteligente: Tentamos nos conectar √† porta 80 do roteador da v√≠tima usando objetos XHR. Para isso, uma lista de 115 endere√ßos padr√£o de roteadores de v√°rios recursos acess√≠veis pela Internet foi compilada. Se um roteador for acess√≠vel, escaneamos a sub-rede em busca de impressoras como descrito anteriormente.

## Prova de conceito

Uma implementa√ß√£o de prova de conceito demonstrando que ataques avan√ßados de impress√£o cross-site s√£o pr√°ticos e uma amea√ßa real para empresas e institui√ß√µes est√° dispon√≠vel em [hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)


<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
