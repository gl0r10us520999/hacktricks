# 9200 - Pentesting Elasticsearch

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Get a hacker's perspective on your web apps, network, and cloud**

**Find and report critical, exploitable vulnerabilities with real business impact.** Use our 20+ custom tools to map the attack surface, find security issues that let you escalate privileges, and use automated exploits to collect essential evidence, turning your hard work into persuasive reports.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Podstawowe informacje

Elasticsearch to **rozproszony**, **otwarty** silnik wyszukiwania i analizy dla **wszystkich typ√≥w danych**. Znany jest z **szybko≈õci**, **skalowalno≈õci** i **prosty REST API**. Zbudowany na Apache Lucene, zosta≈Ç po raz pierwszy wydany w 2010 roku przez Elasticsearch N.V. (obecnie znany jako Elastic). Elasticsearch jest podstawowym komponentem Elastic Stack, zbioru narzƒôdzi open source do pobierania, wzbogacania, przechowywania, analizy i wizualizacji danych. Ten stos, powszechnie nazywany ELK Stack, obejmuje r√≥wnie≈º Logstash i Kibana, a teraz ma lekkie agenty do przesy≈Çania danych zwane Beats.

### Czym jest indeks Elasticsearch?

Indeks Elasticsearch to **zbi√≥r** **powiƒÖzanych dokument√≥w** przechowywanych jako **JSON**. Ka≈ºdy dokument sk≈Çada siƒô z **kluczy** i odpowiadajƒÖcych im **warto≈õci** (ciƒÖgi, liczby, warto≈õci logiczne, daty, tablice, lokalizacje geograficzne itp.).

Elasticsearch u≈ºywa efektywnej struktury danych zwanej **indeksem odwr√≥conym**, aby u≈Çatwiƒá szybkie wyszukiwanie pe≈Çnotekstowe. Ten indeks wymienia ka≈ºde unikalne s≈Çowo w dokumentach i identyfikuje dokumenty, w kt√≥rych ka≈ºde s≈Çowo siƒô pojawia.

Podczas procesu indeksowania Elasticsearch przechowuje dokumenty i konstruuje indeks odwr√≥cony, co pozwala na wyszukiwanie w niemal rzeczywistym czasie. **API indeksu** jest u≈ºywane do dodawania lub aktualizowania dokument√≥w JSON w okre≈õlonym indeksie.

**Domy≈õlny port**: 9200/tcp

## Rƒôczna enumeracja

### Baner

Protok√≥≈Ç u≈ºywany do uzyskania dostƒôpu do Elasticsearch to **HTTP**. Gdy uzyskasz do niego dostƒôp przez HTTP, znajdziesz interesujƒÖce informacje: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (294).png>)

Je≈õli nie widzisz tej odpowiedzi, uzyskujƒÖc dostƒôp do `/`, zobacz nastƒôpnƒÖ sekcjƒô.

### Uwierzytelnianie

**Domy≈õlnie Elasticsearch nie ma w≈ÇƒÖczonego uwierzytelniania**, wiƒôc domy≈õlnie mo≈ºesz uzyskaƒá dostƒôp do wszystkiego w bazie danych bez u≈ºycia jakichkolwiek po≈õwiadcze≈Ñ.

Mo≈ºesz zweryfikowaƒá, ≈ºe uwierzytelnianie jest wy≈ÇƒÖczone, wysy≈ÇajƒÖc ≈ºƒÖdanie do:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Jednak≈ºe**, je≈õli wy≈õlesz ≈ºƒÖdanie do `/` i otrzymasz odpowied≈∫ podobnƒÖ do poni≈ºszej:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
To oznacza, ≈ºe uwierzytelnianie jest skonfigurowane i **potrzebujesz wa≈ºnych po≈õwiadcze≈Ñ**, aby uzyskaƒá jakiekolwiek informacje z elasticserach. Nastƒôpnie mo≈ºesz [**spr√≥bowaƒá przeprowadziƒá atak brute force**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (u≈ºywa HTTP basic auth, wiƒôc wszystko, co mo≈ºe przeprowadziƒá BF HTTP basic auth, mo≈ºe byƒá u≈ºyte).\
Oto **lista domy≈õlnych nazw u≈ºytkownik√≥w**: _**elastic** (superu≈ºytkownik), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_._ Starsze wersje Elasticsearch majƒÖ domy≈õlne has≈Ço **changeme** dla tego u≈ºytkownika.
```
curl -X GET http://user:password@IP:9200/
```
### Podstawowa enumeracja u≈ºytkownik√≥w
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Elastic Info

Oto kilka punkt√≥w ko≈Ñcowych, kt√≥re mo≈ºesz **uzyskaƒá za pomocƒÖ GET**, aby **uzyskaƒá** pewne **informacje** o elasticsearch:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Te punkty ko≈Ñcowe zosta≈Çy [**wziƒôte z dokumentacji**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html), gdzie mo≈ºesz **znale≈∫ƒá wiƒôcej**.\
Ponadto, je≈õli uzyskasz dostƒôp do `/_cat`, odpowied≈∫ bƒôdzie zawieraƒá punkty ko≈Ñcowe `/_cat/*` obs≈Çugiwane przez instancjƒô.

W `/_security/user` (je≈õli uwierzytelnianie jest w≈ÇƒÖczone) mo≈ºesz zobaczyƒá, kt√≥ry u≈ºytkownik ma rolƒô `superuser`.

### Indices

Mo≈ºesz **zgromadziƒá wszystkie indeksy**, uzyskujƒÖc dostƒôp do `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Aby uzyskaƒá **informacje o tym, jakie dane sƒÖ zapisane w indeksie**, mo≈ºesz uzyskaƒá dostƒôp do: `http://host:9200/<index>` w tym przypadku `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (342).png>)

### Zrzut indeksu

Je≈õli chcesz **zrzuciƒá wszystkie zawarto≈õci** indeksu, mo≈ºesz uzyskaƒá dostƒôp do: `http://host:9200/<index>/_search?pretty=true` jak `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (914).png>)

_Po≈õwiƒôƒá chwilƒô, aby por√≥wnaƒá zawarto≈õƒá ka≈ºdego dokumentu (wpisu) w indeksie bankowym oraz pola tego indeksu, kt√≥re widzieli≈õmy w poprzedniej sekcji._

Na tym etapie mo≈ºesz zauwa≈ºyƒá, ≈ºe **istnieje pole o nazwie "total" wewnƒÖtrz "hits"**, kt√≥re wskazuje, ≈ºe **znaleziono 1000 dokument√≥w** w tym indeksie, ale tylko 10 zosta≈Ço zwr√≥conych. Dzieje siƒô tak, poniewa≈º **domy≈õlnie istnieje limit 10 dokument√≥w**.\
Jednak teraz, gdy wiesz, ≈ºe **ten indeks zawiera 1000 dokument√≥w**, mo≈ºesz **zrzuciƒá wszystkie z nich**, wskazujƒÖc liczbƒô wpis√≥w, kt√≥re chcesz zrzuciƒá w parametrze **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
&#xNAN;_&#x4E;ote: Je≈õli wska≈ºesz wiƒôkszƒÖ liczbƒô, wszystkie wpisy i tak zostanƒÖ zrzucane, na przyk≈Çad mo≈ºesz wskazaƒá `size=9999`, a bƒôdzie to dziwne, je≈õli by≈Çoby wiƒôcej wpis√≥w (ale powiniene≈õ to sprawdziƒá)._

### Zrzut wszystkich

Aby zrzuciƒá wszystko, mo≈ºesz po prostu przej≈õƒá do **tej samej ≈õcie≈ºki co wcze≈õniej, ale bez wskazywania jakiego≈õ indeksu** `http://host:9200/_search?pretty=true` jak `http://10.10.10.115:9200/_search?pretty=true`\
Pamiƒôtaj, ≈ºe w tym przypadku zostanie zastosowany **domy≈õlny limit 10** wynik√≥w. Mo≈ºesz u≈ºyƒá parametru `size`, aby zrzuciƒá **wiƒôkszƒÖ ilo≈õƒá wynik√≥w**. Przeczytaj poprzedniƒÖ sekcjƒô, aby uzyskaƒá wiƒôcej informacji.

### Wyszukiwanie

Je≈õli szukasz jakich≈õ informacji, mo≈ºesz wykonaƒá **surowe wyszukiwanie we wszystkich indeksach**, przechodzƒÖc do `http://host:9200/_search?pretty=true&q=<search_term>` jak w `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (335).png>)

Je≈õli chcesz tylko **wyszukiwaƒá w indeksie**, mo≈ºesz po prostu **okre≈õliƒá** go w **≈õcie≈ºce**: `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Zauwa≈º, ≈ºe parametr q u≈ºywany do wyszukiwania tre≈õci **obs≈Çuguje wyra≈ºenia regularne**_

Mo≈ºesz r√≥wnie≈º u≈ºyƒá czego≈õ takiego jak [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz), aby fuzzowaƒá us≈Çugƒô elasticsearch.

### Uprawnienia do zapisu

Mo≈ºesz sprawdziƒá swoje uprawnienia do zapisu, pr√≥bujƒÖc utworzyƒá nowy dokument w nowym indeksie, uruchamiajƒÖc co≈õ takiego jak poni≈ºej:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Ten cmd utworzy **nowy indeks** o nazwie `bookindex` z dokumentem typu `books`, kt√≥ry ma atrybuty "_bookId_", "_author_", "_publisher_" i "_name_".

Zauwa≈º, jak **nowy indeks pojawia siƒô teraz na li≈õcie**:

![](<../.gitbook/assets/image (130).png>)

I zwr√≥ƒá uwagƒô na **automatycznie utworzone w≈Ça≈õciwo≈õci**:

![](<../.gitbook/assets/image (434).png>)

## Automatyczna enumeracja

Niekt√≥re narzƒôdzia uzyskajƒÖ czƒô≈õƒá danych przedstawionych wcze≈õniej:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

<figure><img src="../.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Uzyskaj perspektywƒô hakera na swoje aplikacje internetowe, sieƒá i chmurƒô**

**Znajd≈∫ i zg≈Ço≈õ krytyczne, wykorzystywalne luki w zabezpieczeniach, kt√≥re majƒÖ rzeczywisty wp≈Çyw na biznes.** U≈ºyj naszych 20+ niestandardowych narzƒôdzi do mapowania powierzchni ataku, znajdowania problem√≥w z bezpiecze≈Ñstwem, kt√≥re pozwalajƒÖ na eskalacjƒô uprawnie≈Ñ, oraz u≈ºyj zautomatyzowanych exploit√≥w do zbierania niezbƒôdnych dowod√≥w, przekszta≈ÇcajƒÖc swojƒÖ ciƒô≈ºkƒÖ pracƒô w przekonujƒÖce raporty.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{% hint style="success" %}
Ucz siƒô i ƒáwicz Hacking AWS:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siƒô i ƒáwicz Hacking GCP: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd≈∫ [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siƒô trikami hakerskimi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori√≥w na GitHubie.

</details>
{% endhint %}
