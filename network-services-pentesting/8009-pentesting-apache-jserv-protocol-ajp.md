# 8009 - Pentesting Apache JServ Protocol (AJP)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**é»‘å®¢è§è§£**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**å®æ—¶é»‘å®¢æ–°é—»**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**æœ€æ–°å…¬å‘Š**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘è®¡åˆ’å’Œé‡è¦å¹³å°æ›´æ–°

**ä»Šå¤©å°±åŠ å…¥æˆ‘ä»¬çš„** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ï¼Œä¸é¡¶å°–é»‘å®¢å¼€å§‹åˆä½œå§ï¼

## åŸºæœ¬ä¿¡æ¯

æ¥è‡ª [https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP æ˜¯ä¸€ç§çº¿åè®®ã€‚å®ƒæ˜¯ HTTP åè®®çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå…è®¸ç‹¬ç«‹çš„ web æœåŠ¡å™¨å¦‚ [Apache](http://httpd.apache.org/) ä¸ Tomcat é€šä¿¡ã€‚ä»å†å²ä¸Šçœ‹ï¼ŒApache åœ¨æä¾›é™æ€å†…å®¹æ–¹é¢æ¯” Tomcat å¿«å¾—å¤šã€‚å…¶æƒ³æ³•æ˜¯è®© Apache åœ¨å¯èƒ½çš„æƒ…å†µä¸‹æä¾›é™æ€å†…å®¹ï¼Œä½†å°†è¯·æ±‚ä»£ç†åˆ° Tomcat ä»¥è·å–ä¸ Tomcat ç›¸å…³çš„å†…å®¹ã€‚

ä¹Ÿå¾ˆæœ‰è¶£ï¼š

> ajp13 åè®®æ˜¯é¢å‘æ•°æ®åŒ…çš„ã€‚å‡ºäºæ€§èƒ½åŸå› ï¼Œæ˜¾ç„¶é€‰æ‹©äº†äºŒè¿›åˆ¶æ ¼å¼è€Œä¸æ˜¯æ›´æ˜“è¯»çš„çº¯æ–‡æœ¬ã€‚web æœåŠ¡å™¨é€šè¿‡ TCP è¿æ¥ä¸ servlet å®¹å™¨é€šä¿¡ã€‚ä¸ºäº†å‡å°‘åˆ›å»ºå¥—æ¥å­—çš„æ˜‚è´µè¿‡ç¨‹ï¼Œweb æœåŠ¡å™¨å°†å°è¯•ä¿æŒä¸ servlet å®¹å™¨çš„æŒä¹… TCP è¿æ¥ï¼Œå¹¶é‡ç”¨ä¸€ä¸ªè¿æ¥è¿›è¡Œå¤šä¸ªè¯·æ±‚/å“åº”å‘¨æœŸã€‚

**é»˜è®¤ç«¯å£ï¼š** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

è¿™æ˜¯ä¸€ä¸ªLFIæ¼æ´ï¼Œå…è®¸è·å–ä¸€äº›æ–‡ä»¶ï¼Œå¦‚`WEB-INF/web.xml`ï¼Œå…¶ä¸­åŒ…å«å‡­æ®ã€‚è¿™æ˜¯ä¸€ä¸ª[åˆ©ç”¨](https://www.exploit-db.com/exploits/48143)è¯¥æ¼æ´çš„æ”»å‡»ï¼ŒAJPæš´éœ²çš„ç«¯å£å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚

ä¿®è¡¥ç‰ˆæœ¬ä¸º9.0.31åŠä»¥ä¸Šã€8.5.51åŠä»¥ä¸Šå’Œ7.0.100åŠä»¥ä¸Šã€‚

## Enumeration

### Automatic
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**æš´åŠ›ç ´è§£**](../generic-hacking/brute-force.md#ajp)

## AJP ä»£ç†

### Nginx åå‘ä»£ç† + AJP

([æŸ¥çœ‹ Docker åŒ–ç‰ˆæœ¬](8009-pentesting-apache-jserv-protocol-ajp.md#Dockerized-version))

å¯ä»¥é€šè¿‡ä½¿ç”¨ Nginx `ajp_module` apache æ¨¡å—ä¸å¼€æ”¾çš„ AJP ä»£ç†ç«¯å£ (8009 TCP) è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä»è¯¥ç«¯å£è®¿é—® Tomcat ç®¡ç†å™¨ï¼Œè¿™å¯èƒ½æœ€ç»ˆå¯¼è‡´åœ¨æ˜“å—æ”»å‡»çš„æœåŠ¡å™¨ä¸Šå®ç° RCEã€‚

* ä» [https://nginx.org/en/download.html](https://nginx.org/en/download.html) å¼€å§‹ä¸‹è½½ Nginxï¼Œç„¶åä½¿ç”¨ ajp æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼š
```bash
# Compile Nginx with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-version
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
* ç„¶åï¼Œæ³¨é‡Šæ‰ `server` å—ï¼Œå¹¶åœ¨ `/etc/nginx/conf/nginx.conf` çš„ `http` å—ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ã€‚
```json
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
* æœ€åï¼Œå¯åŠ¨ nginx (`sudo nginx`)ï¼Œå¹¶é€šè¿‡è®¿é—® `http://127.0.0.1` æ£€æŸ¥å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

### Nginx DockeråŒ–ç‰ˆæœ¬
```bash
git clone https://github.com/ScribblerCoder/nginx-ajp-docker
cd nginx-ajp-docker
```
å°† `nginx.conf` ä¸­çš„ `TARGET-IP` æ›¿æ¢ä¸º AJP IPï¼Œç„¶åæ„å»ºå¹¶è¿è¡Œã€‚
```bash
docker build . -t nginx-ajp-proxy
docker run -it --rm -p 80:80 nginx-ajp-proxy
```
### Apache AJP Proxy

ä¹Ÿå¯ä»¥ä½¿ç”¨ **Apache AJP proxy** æ¥è®¿é—®è¯¥ç«¯å£ï¼Œè€Œä¸æ˜¯ **Nginx**ã€‚

## References

* [https://github.com/yaoweibin/nginx\_ajp\_module](https://github.com/yaoweibin/nginx_ajp_module)

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

åŠ å…¥ [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) æœåŠ¡å™¨ï¼Œä¸ç»éªŒä¸°å¯Œçš„é»‘å®¢å’Œæ¼æ´èµé‡‘çŒäººäº¤æµï¼

**Hacking Insights**\
å‚ä¸æ·±å…¥æ¢è®¨é»‘å®¢çš„åˆºæ¿€ä¸æŒ‘æˆ˜çš„å†…å®¹

**Real-Time Hack News**\
é€šè¿‡å®æ—¶æ–°é—»å’Œè§è§£ï¼Œè·Ÿä¸Šå¿«é€Ÿå˜åŒ–çš„é»‘å®¢ä¸–ç•Œ

**Latest Announcements**\
äº†è§£æœ€æ–°çš„æ¼æ´èµé‡‘å‘å¸ƒå’Œé‡è¦å¹³å°æ›´æ–°

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) å¹¶ç«‹å³ä¸é¡¶çº§é»‘å®¢åˆä½œï¼

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
