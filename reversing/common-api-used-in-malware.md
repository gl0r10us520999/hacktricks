# Common API used in Malware

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Gen√©rico

### Rede

| Sockets Brutos   | Sockets WinAPI |
| ------------- | -------------- |
| socket()      | WSAStratup()   |
| bind()        | bind()         |
| listen()      | listen()       |
| accept()      | accept()       |
| connect()     | connect()      |
| read()/recv() | recv()         |
| write()       | send()         |
| shutdown()    | WSACleanup()   |

### Persist√™ncia

| Registro         | Arquivo          | Servi√ßo                      |
| ---------------- | ------------- | ---------------------------- |
| RegCreateKeyEx() | GetTempPath() | OpenSCManager                |
| RegOpenKeyEx()   | CopyFile()    | CreateService()              |
| RegSetValueEx()  | CreateFile()  | StartServiceCtrlDispatcher() |
| RegDeleteKeyEx() | WriteFile()   |                              |
| RegGetValue()    | ReadFile()    |                              |

### Criptografia

| Nome                  |
| --------------------- |
| WinCrypt              |
| CryptAcquireContext() |
| CryptGenKey()         |
| CryptDeriveKey()      |
| CryptDecrypt()        |
| CryptReleaseContext() |

### Anti-An√°lise/VM

| Nome da Fun√ß√£o                                             | Instru√ß√µes de Assembly |
| --------------------------------------------------------- | --------------------- |
| IsDebuggerPresent()                                       | CPUID()               |
| GetSystemInfo()                                           | IN()                  |
| GlobalMemoryStatusEx()                                    |                       |
| GetVersion()                                              |                       |
| CreateToolhelp32Snapshot \[Verificar se um processo est√° em execu√ß√£o] |                       |
| CreateFileW/A \[Verificar se um arquivo existe]                    |                       |

### Stealth

| Nome                     |                                                                            |
| ------------------------ | -------------------------------------------------------------------------- |
| VirtualAlloc             | Alocar mem√≥ria (packers)                                                  |
| VirtualProtect           | Alterar permiss√£o de mem√≥ria (packer dando permiss√£o de execu√ß√£o a uma se√ß√£o) |
| ReadProcessMemory        | Inje√ß√£o em processos externos                                             |
| WriteProcessMemoryA/W    | Inje√ß√£o em processos externos                                             |
| NtWriteVirtualMemory     |                                                                            |
| CreateRemoteThread       | Inje√ß√£o de DLL/Processo...                                               |
| NtUnmapViewOfSection     |                                                                            |
| QueueUserAPC             |                                                                            |
| CreateProcessInternalA/W |                                                                            |

### Execu√ß√£o

| Nome da Fun√ß√£o    |
| ---------------- |
| CreateProcessA/W |
| ShellExecute     |
| WinExec          |
| ResumeThread     |
| NtResumeThread   |

### Diversos

* GetAsyncKeyState() -- Registro de teclas
* SetWindowsHookEx -- Registro de teclas
* GetForeGroundWindow -- Obter nome da janela em execu√ß√£o (ou o site de um navegador)
* LoadLibrary() -- Importar biblioteca
* GetProcAddress() -- Importar biblioteca
* CreateToolhelp32Snapshot() -- Listar processos em execu√ß√£o
* GetDC() -- Captura de tela
* BitBlt() -- Captura de tela
* InternetOpen(), InternetOpenUrl(), InternetReadFile(), InternetWriteFile() -- Acessar a Internet
* FindResource(), LoadResource(), LockResource() -- Acessar recursos do execut√°vel

## T√©cnicas de Malware

### Inje√ß√£o de DLL

Executar uma DLL arbitr√°ria dentro de outro processo

1. Localizar o processo para injetar a DLL maliciosa: CreateToolhelp32Snapshot, Process32First, Process32Next
2. Abrir o processo: GetModuleHandle, GetProcAddress, OpenProcess
3. Escrever o caminho para a DLL dentro do processo: VirtualAllocEx, WriteProcessMemory
4. Criar uma thread no processo que carregar√° a DLL maliciosa: CreateRemoteThread, LoadLibrary

Outras fun√ß√µes a serem usadas: NTCreateThreadEx, RtlCreateUserThread

### Inje√ß√£o de DLL Reflexiva

Carregar uma DLL maliciosa sem chamar as chamadas normais da API do Windows.\
A DLL √© mapeada dentro de um processo, resolver√° os endere√ßos de importa√ß√£o, corrigir√° as realoca√ß√µes e chamar√° a fun√ß√£o DllMain.

### Sequestro de Thread

Encontrar uma thread de um processo e fazer com que ela carregue uma DLL maliciosa

1. Encontrar uma thread alvo: CreateToolhelp32Snapshot, Thread32First, Thread32Next
2. Abrir a thread: OpenThread
3. Suspender a thread: SuspendThread
4. Escrever o caminho para a DLL maliciosa dentro do processo da v√≠tima: VirtualAllocEx, WriteProcessMemory
5. Retomar a thread carregando a biblioteca: ResumeThread

### Inje√ß√£o PE

Inje√ß√£o de Execu√ß√£o Port√°til: O execut√°vel ser√° escrito na mem√≥ria do processo da v√≠tima e ser√° executado a partir da√≠.

### Hollowing de Processo

O malware ir√° desmapear o c√≥digo leg√≠timo da mem√≥ria do processo e carregar um bin√°rio malicioso

1. Criar um novo processo: CreateProcess
2. Desmapear a mem√≥ria: ZwUnmapViewOfSection, NtUnmapViewOfSection
3. Escrever o bin√°rio malicioso na mem√≥ria do processo: VirtualAllocEc, WriteProcessMemory
4. Definir o ponto de entrada e executar: SetThreadContext, ResumeThread

## Hooking

* A **SSDT** (**Tabela de Descritores de Servi√ßo do Sistema**) aponta para fun√ß√µes do kernel (ntoskrnl.exe) ou driver GUI (win32k.sys) para que processos de usu√°rio possam chamar essas fun√ß√µes.
* Um rootkit pode modificar esses ponteiros para endere√ßos que ele controla
* **IRP** (**Pacotes de Solicita√ß√£o de I/O**) transmitem peda√ßos de dados de um componente para outro. Quase tudo no kernel usa IRPs e cada objeto de dispositivo tem sua pr√≥pria tabela de fun√ß√µes que pode ser hookada: DKOM (Manipula√ß√£o Direta de Objetos do Kernel)
* A **IAT** (**Tabela de Endere√ßos de Importa√ß√£o**) √© √∫til para resolver depend√™ncias. √â poss√≠vel hookar esta tabela para sequestrar o c√≥digo que ser√° chamado.
* **EAT** (**Tabela de Endere√ßos de Exporta√ß√£o**) Hooks. Esses hooks podem ser feitos a partir do **userland**. O objetivo √© hookar fun√ß√µes exportadas por DLLs.
* **Inline Hooks**: Este tipo √© dif√≠cil de alcan√ßar. Isso envolve modificar o c√≥digo das pr√≥prias fun√ß√µes. Talvez colocando um salto no in√≠cio delas.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
