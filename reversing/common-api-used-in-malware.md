# API couramment utilis√©e dans les logiciels malveillants

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## G√©n√©rique

### R√©seautage

| Sockets bruts   | Sockets WinAPI |
| --------------- | -------------- |
| socket()        | WSAStratup()   |
| bind()          | bind()         |
| listen()        | listen()       |
| accept()        | accept()       |
| connect()       | connect()      |
| read()/recv()   | recv()         |
| write()         | send()         |
| shutdown()      | WSACleanup()   |

### Persistance

| Registre         | Fichier       | Service                      |
| ---------------- | ------------- | ---------------------------- |
| RegCreateKeyEx() | GetTempPath() | OpenSCManager                |
| RegOpenKeyEx()   | CopyFile()    | CreateService()              |
| RegSetValueEx()  | CreateFile()  | StartServiceCtrlDispatcher() |
| RegDeleteKeyEx() | WriteFile()   |                              |
| RegGetValue()    | ReadFile()    |                              |

### Chiffrement

| Nom                  |
| --------------------- |
| WinCrypt              |
| CryptAcquireContext() |
| CryptGenKey()         |
| CryptDeriveKey()      |
| CryptDecrypt()        |
| CryptReleaseContext() |

### Anti-analyse/VM

| Nom de la fonction                                         | Instructions d'assemblage |
| --------------------------------------------------------- | -------------------------- |
| IsDebuggerPresent()                                       | CPUID()                   |
| GetSystemInfo()                                          | IN()                      |
| GlobalMemoryStatusEx()                                    |                            |
| GetVersion()                                             |                            |
| CreateToolhelp32Snapshot \[V√©rifiez si un processus est en cours d'ex√©cution] |                            |
| CreateFileW/A \[V√©rifiez si un fichier existe]           |                            |

### Discr√©tion

| Nom                     |                                                                            |
| ------------------------ | -------------------------------------------------------------------------- |
| VirtualAlloc             | Allouer de la m√©moire (packers)                                          |
| VirtualProtect           | Changer les permissions de m√©moire (packer donnant la permission d'ex√©cution √† une section) |
| ReadProcessMemory        | Injection dans des processus externes                                      |
| WriteProcessMemoryA/W    | Injection dans des processus externes                                      |
| NtWriteVirtualMemory     |                                                                            |
| CreateRemoteThread       | Injection de DLL/processus...                                             |
| NtUnmapViewOfSection     |                                                                            |
| QueueUserAPC             |                                                                            |
| CreateProcessInternalA/W |                                                                            |

### Ex√©cution

| Nom de la fonction    |
| ---------------------- |
| CreateProcessA/W      |
| ShellExecute           |
| WinExec                |
| ResumeThread           |
| NtResumeThread         |

### Divers

* GetAsyncKeyState() -- Enregistrement des touches
* SetWindowsHookEx -- Enregistrement des touches
* GetForeGroundWindow -- Obtenir le nom de la fen√™tre en cours d'ex√©cution (ou le site Web d'un navigateur)
* LoadLibrary() -- Importer une biblioth√®que
* GetProcAddress() -- Importer une biblioth√®que
* CreateToolhelp32Snapshot() -- Lister les processus en cours d'ex√©cution
* GetDC() -- Capture d'√©cran
* BitBlt() -- Capture d'√©cran
* InternetOpen(), InternetOpenUrl(), InternetReadFile(), InternetWriteFile() -- Acc√©der √† Internet
* FindResource(), LoadResource(), LockResource() -- Acc√©der aux ressources de l'ex√©cutable

## Techniques de logiciels malveillants

### Injection de DLL

Ex√©cuter une DLL arbitraire √† l'int√©rieur d'un autre processus

1. Localiser le processus pour injecter la DLL malveillante : CreateToolhelp32Snapshot, Process32First, Process32Next
2. Ouvrir le processus : GetModuleHandle, GetProcAddress, OpenProcess
3. √âcrire le chemin vers la DLL √† l'int√©rieur du processus : VirtualAllocEx, WriteProcessMemory
4. Cr√©er un thread dans le processus qui chargera la DLL malveillante : CreateRemoteThread, LoadLibrary

Autres fonctions √† utiliser : NTCreateThreadEx, RtlCreateUserThread

### Injection de DLL r√©fl√©chissante

Charger une DLL malveillante sans appeler les appels API Windows normaux.\
La DLL est mapp√©e √† l'int√©rieur d'un processus, elle r√©soudra les adresses d'importation, corrigera les relocations et appellera la fonction DllMain.

### D√©tournement de thread

Trouver un thread d'un processus et le faire charger une DLL malveillante

1. Trouver un thread cible : CreateToolhelp32Snapshot, Thread32First, Thread32Next
2. Ouvrir le thread : OpenThread
3. Suspendre le thread : SuspendThread
4. √âcrire le chemin vers la DLL malveillante √† l'int√©rieur du processus de la victime : VirtualAllocEx, WriteProcessMemory
5. Reprendre le thread chargeant la biblioth√®que : ResumeThread

### Injection PE

Injection d'ex√©cution portable : L'ex√©cutable sera √©crit dans la m√©moire du processus de la victime et sera ex√©cut√© √† partir de l√†.

### Hollowing de processus

Le logiciel malveillant d√©sallouera le code l√©gitime de la m√©moire du processus et chargera un binaire malveillant

1. Cr√©er un nouveau processus : CreateProcess
2. D√©sallouer la m√©moire : ZwUnmapViewOfSection, NtUnmapViewOfSection
3. √âcrire le binaire malveillant dans la m√©moire du processus : VirtualAllocEc, WriteProcessMemory
4. D√©finir le point d'entr√©e et ex√©cuter : SetThreadContext, ResumeThread

## Hooking

* Le **SSDT** (**Table des descripteurs de services syst√®me**) pointe vers des fonctions du noyau (ntoskrnl.exe) ou du pilote GUI (win32k.sys) afin que les processus utilisateur puissent appeler ces fonctions.
* Un rootkit peut modifier ces pointeurs vers des adresses qu'il contr√¥le.
* **IRP** (**Paquets de demande d'E/S**) transmettent des morceaux de donn√©es d'un composant √† un autre. Presque tout dans le noyau utilise des IRP et chaque objet de p√©riph√©rique a sa propre table de fonctions qui peut √™tre hook√©e : DKOM (Manipulation directe d'objet noyau).
* La **IAT** (**Table des adresses d'importation**) est utile pour r√©soudre les d√©pendances. Il est possible de hooker cette table afin de d√©tourner le code qui sera appel√©.
* **EAT** (**Table des adresses d'exportation**) Hooks. Ces hooks peuvent √™tre r√©alis√©s depuis **userland**. L'objectif est de hooker les fonctions export√©es par les DLL.
* **Hooks en ligne** : Ce type est difficile √† r√©aliser. Cela implique de modifier le code des fonctions elles-m√™mes. Peut-√™tre en mettant un saut au d√©but de celles-ci.

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
