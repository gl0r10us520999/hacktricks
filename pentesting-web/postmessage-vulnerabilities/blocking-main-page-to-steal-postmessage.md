# Bloquer la page principale pour voler le postmessage

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Gagner des RCs avec des Iframes

Selon ce [**writeup de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), les blobs cr√©√©s √† partir d'origines nulles sont isol√©s pour des raisons de s√©curit√©, ce qui signifie que si vous maintenez la page principale occup√©e, la page iframe va √™tre ex√©cut√©e.

Fondamentalement, dans ce d√©fi, un **iframe isol√© est ex√©cut√©** et juste **apr√®s** qu'il soit **charg√©**, la **page parent** va **envoyer un post** message avec le **flag**.\
Cependant, cette communication postmessage est **vuln√©rable √† XSS** (l'**iframe** peut ex√©cuter du code JS).

Par cons√©quent, l'objectif de l'attaquant est de **laisser le parent cr√©er l'iframe**, mais **avant** de laisser la **page parent** **envoyer** les donn√©es sensibles (**flag**) **la garder occup√©e** et envoyer le **payload √† l'iframe**. Pendant que le **parent est occup√©**, l'**iframe ex√©cute le payload** qui sera un JS qui √©coutera le **message postmessage du parent et volera le flag**.\
Enfin, l'iframe a ex√©cut√© le payload et la page parent cesse d'√™tre occup√©e, donc elle envoie le flag et le payload le vole.

Mais comment pourriez-vous faire en sorte que le parent soit **occup√© juste apr√®s avoir g√©n√©r√© l'iframe et juste pendant qu'il attend que l'iframe soit pr√™te √† envoyer les donn√©es sensibles ?** Fondamentalement, vous devez trouver une **action asynchrone** que vous pourriez faire ex√©cuter au parent. Par exemple, dans ce d√©fi, le parent √©tait **√† l'√©coute** des **postmessages** comme ceci :
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
il √©tait donc possible d'envoyer un **grand entier dans un postmessage** qui sera **converti en cha√Æne** dans cette comparaison, ce qui prendra un certain temps :
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Et pour √™tre pr√©cis et **envoyer** ce **postmessage** juste **apr√®s** la cr√©ation de l'**iframe** mais **avant** qu'il soit **pr√™t** √† recevoir les donn√©es du parent, vous devrez **jouer avec les millisecondes d'un `setTimeout`**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
