# Bloqueando a p√°gina principal para roubar postmessage

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Ganhando RCs com Iframes

De acordo com este [**escrito de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), blobs de documentos criados a partir de origens nulas s√£o isolados por benef√≠cios de seguran√ßa, o que significa que se voc√™ mantiver a p√°gina principal ocupada, a p√°gina do iframe ser√° executada.

Basicamente, nesse desafio um **iframe isolado √© executado** e logo **ap√≥s** ser **carregado**, a **p√°gina pai** vai **enviar uma mensagem post** com a **flag**.\
No entanto, essa comunica√ß√£o postmessage √© **vulner√°vel a XSS** (o **iframe** pode executar c√≥digo JS).

Portanto, o objetivo do atacante √© **deixar a p√°gina pai criar o iframe**, mas **antes** de deixar a **p√°gina pai** **enviar** os dados sens√≠veis (**flag**) **mant√™-la ocupada** e enviar o **payload para o iframe**. Enquanto a **p√°gina pai est√° ocupada**, o **iframe executa o payload**, que ser√° algum JS que ir√° escutar a **mensagem postmessage da p√°gina pai e vazar a flag**.\
Finalmente, o iframe executou o payload e a p√°gina pai para de estar ocupada, ent√£o ela envia a flag e o payload a vaza.

Mas como voc√™ poderia fazer a p√°gina pai ficar **ocupada logo ap√≥s gerar o iframe e apenas enquanto espera que o iframe esteja pronto para enviar os dados sens√≠veis?** Basicamente, voc√™ precisa encontrar uma **a√ß√£o** **ass√≠ncrona** que voc√™ poderia fazer a p√°gina pai **executar**. Por exemplo, nesse desafio a p√°gina pai estava **ouvindo** **postmessages** assim:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
ent√£o era poss√≠vel enviar um **big integer em um postmessage** que ser√° **convertido para string** nessa compara√ß√£o, o que levar√° algum tempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
E, para ser preciso e **enviar** esse **postmessage** logo **ap√≥s** o **iframe** ser criado, mas **antes** de estar **pronto** para receber os dados do pai, voc√™ precisar√° **brincar com os milissegundos de um `setTimeout`**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
