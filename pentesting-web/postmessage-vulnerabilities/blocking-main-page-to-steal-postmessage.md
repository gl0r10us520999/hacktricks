# Bloccare la pagina principale per rubare postmessage

{% hint style="success" %}
Impara e pratica AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Impara e pratica GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}

## Vincere RC con Iframes

Secondo questo [**writeup di Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), i blob documenti creati da origini nulle sono isolati per motivi di sicurezza, il che significa che se mantieni occupata la pagina principale, la pagina dell'iframe verr√† eseguita.

Fondamentalmente, in quella sfida un **iframe isolato viene eseguito** e subito **dopo** che √® **caricato**, la **pagina genitore** invier√† un **messaggio post** con il **flag**.\
Tuttavia, quella comunicazione postmessage √® **vulnerabile a XSS** (l'**iframe** pu√≤ eseguire codice JS).

Pertanto, l'obiettivo dell'attaccante √® **far s√¨ che la pagina genitore crei l'iframe**, ma **prima** di far s√¨ che la **pagina genitore** **invi** i dati sensibili (**flag**) **mantienila occupata** e invia il **payload all'iframe**. Mentre la **pagina genitore √® occupata**, l'**iframe esegue il payload**, che sar√† un po' di JS che ascolter√† il **messaggio postmessage della pagina genitore e ruber√† il flag**.\
Infine, l'iframe ha eseguito il payload e la pagina genitore smette di essere occupata, quindi invia il flag e il payload lo ruba.

Ma come potresti far s√¨ che la pagina genitore sia **occupata subito dopo aver generato l'iframe e solo mentre aspetta che l'iframe sia pronto per inviare i dati sensibili?** Fondamentalmente, devi trovare un'**azione** **async** che potresti far **eseguire** alla pagina genitore. Ad esempio, in quella sfida la pagina genitore stava **ascoltando** i **postmessages** in questo modo:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
quindi era possibile inviare un **big integer in un postmessage** che sar√† **convertito in stringa** in quella comparazione, il che richieder√† del tempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
E per essere precisi e **inviare** quel **postmessage** proprio **dopo** che l'**iframe** √® stato creato ma **prima** che sia **pronto** a ricevere i dati dal genitore, dovrai **giocare con i millisecondi di un `setTimeout`**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
