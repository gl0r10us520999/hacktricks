# Ana sayfayı engelleyerek postmessage çalmak

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Eğitim AWS Kırmızı Takım Uzmanı (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Eğitim GCP Kırmızı Takım Uzmanı (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

## Iframe'lerle RC'leri Kazanmak

Bu [**Terjanq yazısı**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710)'na göre, null kökenlerden oluşturulan blob belgeleri güvenlik faydaları için izole edilmiştir, bu da demektir ki, ana sayfayı meşgul tutarsanız, iframe sayfası çalıştırılacaktır.

Temelde bu zorlukta bir **izole iframe çalıştırılmaktadır** ve hemen **yüklenmesinden sonra** **ebeveyn** sayfa **bir post** mesajı **gönderecektir**.\
Ancak, bu postmessage iletişimi **XSS'e karşı savunmasızdır** (iframe JS kodu çalıştırabilir).

Bu nedenle, saldırganın amacı **ebeveynin iframe oluşturmasına izin vermek**, ancak **önce** **ebeveyn** sayfanın **hassas verileri** (**flag**) **göndermesini engelleyip** **meşgul tutmak** ve **payload'ı iframe'e göndermektir**. **Ebeveyn meşgulken**, **iframe payload'ı çalıştırır**; bu, **ebeveyn postmessage mesajını dinleyecek ve flag'i sızdıracak** bir JS olacaktır.\
Sonunda, iframe payload'ı çalıştırır ve ebeveyn sayfa meşgul olmayı bırakır, böylece flag'i gönderir ve payload onu sızdırır.

Ama ebeveyni **iframe'i oluşturduktan hemen sonra ve sadece iframe'in hassas verileri göndermeye hazır olmasını beklerken meşgul hale nasıl getirebilirsiniz?** Temelde, ebeveynin **çalıştırabileceği** bir **async** **hareket** bulmanız gerekiyor. Örneğin, bu zorlukta ebeveyn **postmessages** dinliyordu:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
bu nedenle, o karşılaştırmada **string'e dönüştürülecek bir postmessage'da büyük bir tam sayı göndermek** mümkün oldu, bu da biraz zaman alacaktır:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Ve tam olarak doğru olmak için, o **postmessage**'i **iframe** oluşturulduktan hemen sonra ama ana sayfadan veri almaya hazır olmadan **göndermeniz** gerekecek, bu yüzden bir `setTimeout`'ın milisaniyeleriyle **oynamanız** gerekecek.
