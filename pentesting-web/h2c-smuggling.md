# Upgrade Header Smuggling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 Over Cleartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, –∞–±–æ **http2 —á–µ—Ä–µ–∑ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —Ç–µ–∫—Å—Ç**, –≤—ñ–¥—Ö–∏–ª—è—î—Ç—å—Å—è –≤—ñ–¥ –Ω–æ—Ä–º–∏ —Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∏—Ö HTTP –∑'—î–¥–Ω–∞–Ω—å, –æ–Ω–æ–≤–ª—é—é—á–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ HTTP **–∑'—î–¥–Ω–∞–Ω–Ω—è –¥–æ –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ**. –¶–µ –æ–Ω–æ–≤–ª–µ–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±—ñ–Ω–∞—Ä–Ω–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª http2 –¥–ª—è –ø–æ—Å—Ç—ñ–π–Ω–æ—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó, –Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç—É HTTP.

–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º–∏ –∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∏ –≤–∏–Ω–∏–∫–∞—î –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º **–∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ**. –ó–∞–∑–≤–∏—á–∞–π –∑–≤–æ—Ä–æ—Ç–Ω–∏–π –ø—Ä–æ–∫—Å—ñ –æ–±—Ä–æ–±–ª—è—î —Ç–∞ –ø–µ—Ä–µ—Å–∏–ª–∞—î HTTP –∑–∞–ø–∏—Ç–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥, –ø–æ–≤–µ—Ä—Ç–∞—é—á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∫–µ–Ω–¥—É –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ. –û–¥–Ω–∞–∫, –∫–æ–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Connection: Upgrade` –ø—Ä–∏—Å—É—Ç–Ω—ñ–π —É HTTP –∑–∞–ø–∏—Ç—ñ (–∑–∞–∑–≤–∏—á–∞–π —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑ –≤–µ–±—Å–æ–∫–µ—Ç–Ω–∏–º–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è–º–∏), –∑–≤–æ—Ä–æ—Ç–Ω–∏–π **–ø—Ä–æ–∫—Å—ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î –ø–æ—Å—Ç—ñ–π–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è** –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —ñ —Å–µ—Ä–≤–µ—Ä–æ–º, –ø–æ–ª–µ–≥—à—É—é—á–∏ –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω–∏–π –æ–±–º—ñ–Ω, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–ª—è –ø–µ–≤–Ω–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤. –î–ª—è H2C –∑'—î–¥–Ω–∞–Ω—å –¥–æ—Ç—Ä–∏–º–∞–Ω–Ω—è RFC –≤–∏–º–∞–≥–∞—î –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç—Ä—å–æ—Ö —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
–í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –≤–∏–Ω–∏–∫–∞—î, –∫–æ–ª–∏ –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è —Ä–µ–≤–µ—Ä—Å–Ω–∏–π –ø—Ä–æ–∫—Å—ñ –ø–µ—Ä–µ—Å—Ç–∞—î –æ–±—Ä–æ–±–ª—è—Ç–∏ –æ–∫—Ä–µ–º—ñ –∑–∞–ø–∏—Ç–∏, –≤–≤–∞–∂–∞—é—á–∏, —â–æ –π–æ–≥–æ —Ä–æ–±–æ—Ç–∞ –∑ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—ó –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è H2C Smuggling –¥–æ–∑–≤–æ–ª—è—î –æ–±—ñ–π—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–≤–µ—Ä—Å–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ, —è–∫—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤, —Ç–∞–∫—ñ —è–∫ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–ª—è—Ö—É, –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –æ–±—Ä–æ–±–∫–∞ WAF, –∑–∞ —É–º–æ–≤–∏, —â–æ –∑'—î–¥–Ω–∞–Ω–Ω—è H2C —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–µ.

#### –í—Ä–∞–∑–ª–∏–≤—ñ –ø—Ä–æ–∫—Å—ñ <a href="#exploitation" id="exploitation"></a>

–í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –æ–±—Ä–æ–±–∫–∏ —Ä–µ–≤–µ—Ä—Å–Ω–∏–º –ø—Ä–æ–∫—Å—ñ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ `Upgrade` —ñ —ñ–Ω–æ–¥—ñ `Connection`. –ù–∞—Å—Ç—É–ø–Ω—ñ –ø—Ä–æ–∫—Å—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–µ—Ä–µ—Å–∏–ª–∞—é—Ç—å —Ü—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ–∫—Å—ñ-–ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è, —Ç–∏–º —Å–∞–º–∏–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–æ–∑–≤–æ–ª—è—é—á–∏ H2C smuggling:

* HAProxy
* Traefik
* Nuster

–ù–∞–≤–ø–∞–∫–∏, —Ü—ñ —Å–µ—Ä–≤—ñ—Å–∏ –Ω–µ –ø–µ—Ä–µ—Å–∏–ª–∞—é—Ç—å –æ–±–∏–¥–≤–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ–∫—Å—ñ-–ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º. –û–¥–Ω–∞–∫ —ó—Ö –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –Ω–µ–Ω–∞–¥—ñ–π–Ω–æ, —â–æ –¥–æ–∑–≤–æ–ª—è—î –Ω–µ–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–µ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ `Upgrade` —ñ `Connection`:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è <a href="#exploitation" id="exploitation"></a>

–í–∞–∂–ª–∏–≤–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ –Ω–µ –≤—Å—ñ —Å–µ—Ä–≤–µ—Ä–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–µ—Ä–µ—Å–∏–ª–∞—é—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏, –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è H2C. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, —Ç–∞–∫—ñ —Å–µ—Ä–≤–µ—Ä–∏, —è–∫ AWS ALB/CLB, NGINX —ñ Apache Traffic Server, —Å–µ—Ä–µ–¥ —ñ–Ω—à–∏—Ö, –ø—Ä–∏—Ä–æ–¥–Ω–æ –±–ª–æ–∫—É—é—Ç—å –∑'—î–¥–Ω–∞–Ω–Ω—è H2C. –ü—Ä–æ—Ç–µ –≤–∞—Ä—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç, —â–æ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º, `Connection: Upgrade`, —è–∫–∏–π –≤–∏–∫–ª—é—á–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è `HTTP2-Settings` –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Connection`, –æ—Å–∫—ñ–ª—å–∫–∏ –¥–µ—è–∫—ñ –±–µ–∫–µ–Ω–¥–∏ –º–æ–∂—É—Ç—å –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.

{% hint style="danger" %}
–ù–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ **—à–ª—è—Ö—É**, –≤–∫–∞–∑–∞–Ω–æ–≥–æ –≤ URL `proxy_pass` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `http://backend:9999/socket.io`), –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —î `http://backend:9999`. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º —à–ª—è—Ö–æ–º —É —Ü—å–æ–º—É –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–º—É –∫—ñ–Ω—Ü–µ–≤–æ–º—É –ø—É–Ω–∫—Ç—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É. –û—Ç–∂–µ, –≤–∫–∞–∑—ñ–≤–∫–∞ —à–ª—è—Ö—É –≤ URL `proxy_pass` –Ω–µ –æ–±–º–µ–∂—É—î –¥–æ—Å—Ç—É–ø.
{% endhint %}

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ [**h2csmuggler –≤—ñ–¥ BishopFox**](https://github.com/BishopFox/h2csmuggler) —Ç–∞ [**h2csmuggler –≤—ñ–¥ assetnote**](https://github.com/assetnote/h2csmuggler) –ø–æ–ª–µ–≥—à—É—é—Ç—å —Å–ø—Ä–æ–±–∏ **–æ–±—ñ–π—Ç–∏ –∑–∞—Ö–∏—Å—Ç, –Ω–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø—Ä–æ–∫—Å—ñ**, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—á–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è H2C, —â–æ –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤, –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –ø—Ä–æ–∫—Å—ñ.

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ü—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, –æ—Å–æ–±–ª–∏–≤–æ —â–æ–¥–æ NGINX, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ [**—Ü—å–æ–≥–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Websocket smuggling, –Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è HTTP2 —Ç—É–Ω–µ–ª—é –¥–æ –∫—ñ–Ω—Ü–µ–≤–æ–≥–æ –ø—É–Ω–∫—Ç—É, –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î Websocket —Ç—É–Ω–µ–ª—å –¥–ª—è –æ–±—Ö–æ–¥—É –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –æ–±–º–µ–∂–µ–Ω—å –ø—Ä–æ–∫—Å—ñ —Ç–∞ —Å–ø—Ä–∏—è–Ω–Ω—è –ø—Ä—è–º—ñ–π –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –∑ –∫—ñ–Ω—Ü–µ–≤–∏–º –ø—É–Ω–∫—Ç–æ–º.

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1

–£ —Ü—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ REST API –∑–ª–æ–≤–º–∏—Å–Ω–∏–π –∫–ª—ñ—î–Ω—Ç, —è–∫–∏–π –Ω–∞—Ü—ñ–ª–µ–Ω–∏–π –Ω–∞ –±–µ–∫–µ–Ω–¥, —â–æ –ø—Ä–æ–ø–æ–Ω—É—î –ø—É–±–ª—ñ—á–Ω–∏–π WebSocket API –ø–æ—Ä—è–¥ –∑ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–º REST API. –ê—Ç–∞–∫–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –∫—ñ–ª—å–∫–∞ –µ—Ç–∞–ø—ñ–≤:

1. –ö–ª—ñ—î–Ω—Ç —ñ–Ω—ñ—Ü—ñ—é—î, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ –∑–∞–ø–∏—Ç Upgrade –¥–æ —Ä–µ–≤–µ—Ä—Å–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º –ø—Ä–æ—Ç–æ–∫–æ–ª—É `Sec-WebSocket-Version` —É –∑–∞–≥–æ–ª–æ–≤–∫—É. –ü—Ä–æ–∫—Å—ñ, –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Sec-WebSocket-Version`, –≤–≤–∞–∂–∞—î –∑–∞–ø–∏—Ç Upgrade –¥—ñ–π—Å–Ω–∏–º —ñ –ø–µ—Ä–µ—Å–∏–ª–∞—î –π–æ–≥–æ –¥–æ –±–µ–∫–µ–Ω–¥—É.
2. –ë–µ–∫–µ–Ω–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∫–æ–¥–æ–º —Å—Ç–∞—Ç—É—Å—É `426`, –≤–∫–∞–∑—É—é—á–∏ –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é –ø—Ä–æ—Ç–æ–∫–æ–ª—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É `Sec-WebSocket-Version`. –†–µ–≤–µ—Ä—Å–Ω–∏–π –ø—Ä–æ–∫—Å—ñ, —ñ–≥–Ω–æ—Ä—É—é—á–∏ —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–µ–∫–µ–Ω–¥—É, –≤–≤–∞–∂–∞—î, —â–æ –≥–æ—Ç–æ–≤–∏–π –¥–æ WebSocket –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó, —ñ –ø–µ—Ä–µ–¥–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–ª—ñ—î–Ω—Ç—É.
3. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ —Ä–µ–≤–µ—Ä—Å–Ω–∏–π –ø—Ä–æ–∫—Å—ñ –≤–≤–æ–¥–∏—Ç—å—Å—è –≤ –æ–º–∞–Ω—É, –≤–≤–∞–∂–∞—é—á–∏, —â–æ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –±—É–ª–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —ñ –±–µ–∫–µ–Ω–¥–æ–º, —Ç–æ–¥—ñ —è–∫ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –±–µ–∫–µ–Ω–¥ –≤—ñ–¥—Ö–∏–ª–∏–≤ –∑–∞–ø–∏—Ç Upgrade. –ù–µ–∑–≤–∞–∂–∞—é—á–∏ –Ω–∞ —Ü–µ, –ø—Ä–æ–∫—Å—ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤—ñ–¥–∫—Ä–∏—Ç–∏–º TCP –∞–±–æ TLS –∑'—î–¥–Ω–∞–Ω–Ω—è –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —ñ –±–µ–∫–µ–Ω–¥–æ–º, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–ª—ñ—î–Ω—Ç—É –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ REST API —á–µ—Ä–µ–∑ —Ü–µ –∑'—î–¥–Ω–∞–Ω–Ω—è.

–ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª—ñ —Ä–µ–≤–µ—Ä—Å–Ω—ñ –ø—Ä–æ–∫—Å—ñ –≤–∫–ª—é—á–∞—é—Ç—å Varnish, —è–∫–∏–π –≤—ñ–¥–º–æ–≤–∏–≤—Å—è –≤–∏—Ä—ñ—à–∏—Ç–∏ —Ü—é –ø—Ä–æ–±–ª–µ–º—É, —Ç–∞ –≤–µ—Ä—Å—ñ—é –ø—Ä–æ–∫—Å—ñ Envoy 1.8.0 –∞–±–æ —Å—Ç–∞—Ä—ñ—à—É, —É –Ω–æ–≤—ñ—à–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö –º–µ—Ö–∞–Ω—ñ–∑–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±—É–≤ –∑–º—ñ–Ω–µ–Ω–∏–π. –Ü–Ω—à—ñ –ø—Ä–æ–∫—Å—ñ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤–∏–º–∏.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2

–¶–µ–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –ø–µ—Ä–µ–¥–±–∞—á–∞—î –±–µ–∫–µ–Ω–¥ –∑ –ø—É–±–ª—ñ—á–Ω–∏–º WebSocket API —Ç–∞ –ø—É–±–ª—ñ—á–Ω–∏–º REST API –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É, –∞ —Ç–∞–∫–æ–∂ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–º REST API. –ê—Ç–∞–∫–∞, –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω–∞, –≤–∫–ª—é—á–∞—î –Ω–∞—Å—Ç—É–ø–Ω—ñ –µ—Ç–∞–ø–∏:

1. –ö–ª—ñ—î–Ω—Ç –Ω–∞–¥—Å–∏–ª–∞—î POST –∑–∞–ø–∏—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó API –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É, –≤–∫–ª—é—á–∞—é—á–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π HTTP –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Upgrade: websocket`. NGINX, —â–æ –≤–∏–∫–æ–Ω—É—î —Ä–æ–ª—å —Ä–µ–≤–µ—Ä—Å–Ω–æ–≥–æ –ø—Ä–æ–∫—Å—ñ, —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç—É—î —Ü–µ —è–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∑–∞–ø–∏—Ç Upgrade, —Å–ø–∏—Ä–∞—é—á–∏—Å—å –ª–∏—à–µ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Upgrade`, —ñ–≥–Ω–æ—Ä—É—é—á–∏ —ñ–Ω—à—ñ –∞—Å–ø–µ–∫—Ç–∏ –∑–∞–ø–∏—Ç—É, —ñ –ø–µ—Ä–µ—Å–∏–ª–∞—î –π–æ–≥–æ –¥–æ –±–µ–∫–µ–Ω–¥—É.
2. –ë–µ–∫–µ–Ω–¥ –≤–∏–∫–æ–Ω—É—î API –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É, –∑–≤–µ—Ä—Ç–∞—é—á–∏—Å—å –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Ä–µ—Å—É—Ä—Å—É, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î HTTP –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –∫–æ–¥–æ–º —Å—Ç–∞—Ç—É—Å—É `101`. –¶—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –æ—Ç—Ä–∏–º–∞–Ω–∞ –±–µ–∫–µ–Ω–¥–æ–º —ñ –ø–µ—Ä–µ—Å–ª–∞–Ω–∞ –¥–æ NGINX, –≤–≤–æ–¥–∏—Ç—å –ø—Ä–æ–∫—Å—ñ –≤ –æ–º–∞–Ω—É, –∑–º—É—à—É—é—á–∏ –π–æ–≥–æ –¥—É–º–∞—Ç–∏, —â–æ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è –±—É–ª–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –π–æ–≥–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ª–∏—à–µ –∫–æ–¥—É —Å—Ç–∞—Ç—É—Å—É.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **–£–≤–∞–≥–∞:** –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏ –∑—Ä–æ—Å—Ç–∞—î, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –≤–∏–º–∞–≥–∞—î –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –∫—ñ–Ω—Ü–µ–≤–∏–º –ø—É–Ω–∫—Ç–æ–º, –∑–¥–∞—Ç–Ω–∏–º –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫–æ–¥ —Å—Ç–∞—Ç—É—Å—É 101.

–í—Ä–µ—à—Ç—ñ-—Ä–µ—à—Ç, NGINX –≤–≤–æ–¥–∏—Ç—å—Å—è –≤ –æ–º–∞–Ω—É, –≤–≤–∞–∂–∞—é—á–∏, —â–æ WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è —ñ—Å–Ω—É—î –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —ñ –±–µ–∫–µ–Ω–¥–æ–º. –ù–∞—Å–ø—Ä–∞–≤–¥—ñ —Ç–∞–∫–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ —ñ—Å–Ω—É—î; —Ü—ñ–ª—å–æ–≤–∏–º –±—É–≤ API –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É REST. –ü—Ä–æ—Ç–µ —Ä–µ–≤–µ—Ä—Å–Ω–∏–π –ø—Ä–æ–∫—Å—ñ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑'—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–∏–º, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–ª—ñ—î–Ω—Ç—É –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ REST API —á–µ—Ä–µ–∑ –Ω—å–æ–≥–æ.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

–ë—ñ–ª—å—à—ñ—Å—Ç—å —Ä–µ–≤–µ—Ä—Å–Ω–∏—Ö –ø—Ä–æ–∫—Å—ñ –≤—Ä–∞–∑–ª–∏–≤—ñ –¥–æ —Ü—å–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é, –∞–ª–µ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ SSRF, —è–∫–∞ –∑–∞–∑–≤–∏—á–∞–π –≤–≤–∞–∂–∞—î—Ç—å—Å—è –ø—Ä–æ–±–ª–µ–º–æ—é –Ω–∏–∑—å–∫–æ—ó —Å–µ—Ä–π–æ–∑–Ω–æ—Å—Ç—ñ.

#### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó, —â–æ–± –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –æ–±–∏–¥–≤–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –≤ [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>
{% endhint %}
