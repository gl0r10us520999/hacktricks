# BrowExt - permissions & host\_permissions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

### **`permissions`**

Uprawnienia sÄ… definiowane w pliku **`manifest.json`** rozszerzenia za pomocÄ… wÅ‚aÅ›ciwoÅ›ci **`permissions`** i pozwalajÄ… na dostÄ™p do prawie wszystkiego, do czego moÅ¼e uzyskaÄ‡ dostÄ™p przeglÄ…darka (ciasteczka lub fizyczne przechowywanie):

Poprzedni manifest deklaruje, Å¼e rozszerzenie wymaga uprawnienia `storage`. Oznacza to, Å¼e moÅ¼e uÅ¼ywaÄ‡ [API storage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) do trwaÅ‚ego przechowywania swoich danych. W przeciwieÅ„stwie do ciasteczek lub API `localStorage`, ktÃ³re dajÄ… uÅ¼ytkownikom pewien poziom kontroli, **przechowywanie w rozszerzeniu moÅ¼na zazwyczaj wyczyÅ›ciÄ‡ tylko przez odinstalowanie rozszerzenia**.

Rozszerzenie poprosi o uprawnienia wskazane w jego pliku **`manifest.json`** i po zainstalowaniu rozszerzenia, moÅ¼esz **zawsze sprawdziÄ‡ jego uprawnienia w swojej przeglÄ…darce**, jak pokazano na tym obrazie:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

MoÅ¼esz znaleÅºÄ‡ [**peÅ‚nÄ… listÄ™ uprawnieÅ„, o ktÃ³re moÅ¼e prosiÄ‡ rozszerzenie przeglÄ…darki Chromium tutaj**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) oraz [**peÅ‚nÄ… listÄ™ dla rozszerzeÅ„ Firefox tutaj**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Opcjonalne, ale potÄ™Å¼ne ustawienie **`host_permissions`** wskazuje, z ktÃ³rymi hostami rozszerzenie bÄ™dzie mogÅ‚o wchodziÄ‡ w interakcje za pomocÄ… API, takich jak [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) i [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

NastÄ™pujÄ…ce `host_permissions` zasadniczo pozwalajÄ… na dostÄ™p do kaÅ¼dej strony internetowej:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Te hosty, do ktÃ³rych rozszerzenie przeglÄ…darki ma swobodny dostÄ™p. Dzieje siÄ™ tak, poniewaÅ¼ gdy rozszerzenie przeglÄ…darki wywoÅ‚uje **`fetch("https://gmail.com/")`**, nie jest ograniczone przez CORS.

## Wykorzystywanie `permissions` i `host_permissions`

### Karty

Ponadto **`host_permissions`** odblokowuje rÃ³wnieÅ¼ â€zaawansowanÄ…â€ funkcjonalnoÅ›Ä‡ [**API kart**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). UmoÅ¼liwiajÄ… one rozszerzeniu wywoÅ‚anie [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) i nie tylko uzyskanie **listy kart przeglÄ…darki uÅ¼ytkownika**, ale takÅ¼e dowiedzenie siÄ™, ktÃ³ra **strona internetowa (czyli adres i tytuÅ‚) jest zaÅ‚adowana**.

{% hint style="danger" %}
Nie tylko to, ale rÃ³wnieÅ¼ nasÅ‚uchiwacze, tacy jak [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated), **stajÄ… siÄ™ znacznie bardziej uÅ¼yteczni**. BÄ™dÄ… powiadamiani za kaÅ¼dym razem, gdy nowa strona Å‚adowana jest do karty.
{% endhint %}

### Uruchamianie skryptÃ³w treÅ›ci <a href="#running-content-scripts" id="running-content-scripts"></a>

Skrypty treÅ›ci nie muszÄ… byÄ‡ koniecznie statycznie zapisane w manifeÅ›cie rozszerzenia. Przy wystarczajÄ…cych **`host_permissions`**, **rozszerzenia mogÄ… rÃ³wnieÅ¼ Å‚adowaÄ‡ je dynamicznie, wywoÅ‚ujÄ…c** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **lub** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Oba API pozwalajÄ… na wykonywanie nie tylko plikÃ³w zawartych w rozszerzeniach jako skryptÃ³w treÅ›ci, ale takÅ¼e **dowolnego kodu**. Pierwsze pozwala na przekazywanie kodu JavaScript jako ciÄ…gu, podczas gdy drugie oczekuje funkcji JavaScript, ktÃ³ra jest mniej podatna na luki w zabezpieczeniach zwiÄ…zane z wstrzykiwaniem. Mimo to, oba API mogÄ… wyrzÄ…dziÄ‡ powaÅ¼ne szkody, jeÅ›li sÄ… niewÅ‚aÅ›ciwie uÅ¼ywane.

{% hint style="danger" %}
OprÃ³cz powyÅ¼szych moÅ¼liwoÅ›ci, skrypty treÅ›ci mogÄ… na przykÅ‚ad **przechwytywaÄ‡ dane uwierzytelniajÄ…ce**, gdy sÄ… one wprowadzane na stronach internetowych. Innym klasycznym sposobem ich naduÅ¼ycia jest **wstrzykiwanie reklam** na kaÅ¼dej stronie internetowej. MoÅ¼liwe jest rÃ³wnieÅ¼ dodawanie **wiadomoÅ›ci oszukaÅ„czych**, aby naduÅ¼yÄ‡ wiarygodnoÅ›ci stron informacyjnych. Wreszcie, mogÄ… **manipulowaÄ‡ stronami bankowymi**, aby przekierowywaÄ‡ przelewy.
{% endhint %}

### Uprawnienia implicitne <a href="#implicit-privileges" id="implicit-privileges"></a>

NiektÃ³re uprawnienia rozszerzenia **nie muszÄ… byÄ‡ wyraÅºnie zadeklarowane**. PrzykÅ‚adem jest [API kart](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): jego podstawowa funkcjonalnoÅ›Ä‡ jest dostÄ™pna bez jakichkolwiek uprawnieÅ„. KaÅ¼de rozszerzenie moÅ¼e byÄ‡ powiadamiane, gdy otwierasz i zamykasz karty, po prostu nie bÄ™dzie wiedziaÅ‚o, z jakÄ… stronÄ… internetowÄ… te karty sÄ… zwiÄ…zane.

Brzmi zbyt nieszkodliwie? API [tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) jest nieco mniej takie. MoÅ¼e byÄ‡ uÅ¼ywane do **tworzenia nowej karty**, zasadniczo tak samo jak [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), ktÃ³re moÅ¼e byÄ‡ wywoÅ‚ywane przez kaÅ¼dÄ… stronÄ™ internetowÄ…. Jednak podczas gdy `window.open()` podlega **blokadzie wyskakujÄ…cych okienek, `tabs.create()` nie podlega**.

{% hint style="danger" %}
Rozszerzenie moÅ¼e tworzyÄ‡ dowolnÄ… liczbÄ™ kart, kiedy tylko chce.
{% endhint %}

JeÅ›li przejrzysz moÅ¼liwe parametry `tabs.create()`, zauwaÅ¼ysz rÃ³wnieÅ¼, Å¼e jego moÅ¼liwoÅ›ci wykraczajÄ… daleko poza to, co `window.open()` moÅ¼e kontrolowaÄ‡. I podczas gdy Firefox nie pozwala na uÅ¼ywanie URI `data:` z tym API, Chrome nie ma takiej ochrony. **UÅ¼ycie takich URI na najwyÅ¼szym poziomie zostaÅ‚o** [**zakazane z powodu naduÅ¼yÄ‡ zwiÄ…zanych z phishingiem**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) jest bardzo podobne do `tabs.create()`, ale **modyfikuje istniejÄ…cÄ… kartÄ™**. Tak wiÄ™c zÅ‚oÅ›liwe rozszerzenie moÅ¼e na przykÅ‚ad dowolnie zaÅ‚adowaÄ‡ stronÄ™ reklamowÄ… do jednej z twoich kart i moÅ¼e rÃ³wnieÅ¼ aktywowaÄ‡ odpowiadajÄ…cÄ… jej kartÄ™.

### Kamera internetowa, geolokalizacja i inne <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Prawdopodobnie wiesz, Å¼e strony internetowe mogÄ… Å¼Ä…daÄ‡ specjalnych uprawnieÅ„, np. w celu uzyskania dostÄ™pu do twojej kamery internetowej (narzÄ™dzia do wideokonferencji) lub lokalizacji geograficznej (mapy). To funkcje z duÅ¼ym potencjaÅ‚em naduÅ¼yÄ‡, wiÄ™c uÅ¼ytkownicy muszÄ… za kaÅ¼dym razem potwierdzaÄ‡, Å¼e nadal chcÄ… tego.

{% hint style="danger" %}
Nie w przypadku rozszerzeÅ„ przeglÄ…darki. **JeÅ›li rozszerzenie przeglÄ…darki** [**chce uzyskaÄ‡ dostÄ™p do twojej kamery internetowej lub mikrofonu**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, musi tylko raz poprosiÄ‡ o pozwolenie**
{% endhint %}

Zazwyczaj rozszerzenie robi to natychmiast po zainstalowaniu. Gdy to powiadomienie zostanie zaakceptowane, **dostÄ™p do kamery internetowej jest moÅ¼liwy w dowolnym momencie**, nawet jeÅ›li uÅ¼ytkownik w tym momencie nie wchodzi w interakcjÄ™ z rozszerzeniem. Tak, uÅ¼ytkownik zaakceptuje to powiadomienie tylko wtedy, gdy rozszerzenie naprawdÄ™ potrzebuje dostÄ™pu do kamery internetowej. Ale po tym muszÄ… zaufaÄ‡ rozszerzeniu, Å¼e nie nagra nic w tajemnicy.

DziÄ™ki dostÄ™powi do [twojej dokÅ‚adnej lokalizacji geograficznej](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) lub [zawartoÅ›ci twojego schowka](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), wyraÅºne udzielenie pozwolenia jest caÅ‚kowicie niepotrzebne. **Rozszerzenie po prostu dodaje `geolocation` lub `clipboard` do** [**wpisu uprawnieÅ„**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **swojego manifestu**. Te uprawnienia dostÄ™pu sÄ… nastÄ™pnie przyznawane implicitnie, gdy rozszerzenie jest instalowane. Tak wiÄ™c zÅ‚oÅ›liwe lub skompromitowane rozszerzenie z tymi uprawnieniami moÅ¼e stworzyÄ‡ twÃ³j profil ruchu lub monitorowaÄ‡ twÃ³j schowek w poszukiwaniu skopiowanych haseÅ‚, nie zauwaÅ¼ajÄ…c niczego.

Dodanie sÅ‚owa kluczowego **`history`** do [wpisu uprawnieÅ„](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) manifestu rozszerzenia przyznaje **dostÄ™p do** [**API historii**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). UmoÅ¼liwia to pobranie caÅ‚ej historii przeglÄ…dania uÅ¼ytkownika za jednym razem, bez czekania, aÅ¼ uÅ¼ytkownik ponownie odwiedzi te strony internetowe.

Uprawnienie **`bookmarks`** ma podobny potencjaÅ‚ naduÅ¼yÄ‡, pozwala na **odczytanie wszystkich zakÅ‚adek za pomocÄ…** [**API zakÅ‚adek**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Uprawnienie do przechowywania <a href="#the-storage-permission" id="the-storage-permission"></a>

Przechowywanie rozszerzenia to jedynie kolekcja klucz-wartoÅ›Ä‡, bardzo podobna do [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage), ktÃ³rej mogÅ‚aby uÅ¼ywaÄ‡ kaÅ¼da strona internetowa. Dlatego nie powinno siÄ™ tutaj przechowywaÄ‡ Å¼adnych wraÅ¼liwych informacji.

Jednak firmy reklamowe mogÄ… rÃ³wnieÅ¼ naduÅ¼ywaÄ‡ tego przechowywania.

### WiÄ™cej uprawnieÅ„

MoÅ¼esz znaleÅºÄ‡ [**peÅ‚nÄ… listÄ™ uprawnieÅ„, ktÃ³re moÅ¼e Å¼Ä…daÄ‡ rozszerzenie przeglÄ…darki Chromium tutaj**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) oraz [**peÅ‚nÄ… listÄ™ dla rozszerzeÅ„ Firefox tutaj**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Zapobieganie <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Polityka dewelopera Google wyraÅºnie zabrania rozszerzeniom Å¼Ä…dania wiÄ™kszych uprawnieÅ„ niÅ¼ to konieczne do ich funkcjonalnoÅ›ci, skutecznie Å‚agodzÄ…c nadmierne Å¼Ä…dania uprawnieÅ„. PrzykÅ‚adem, w ktÃ³rym rozszerzenie przeglÄ…darki przekroczyÅ‚o tÄ™ granicÄ™, byÅ‚o jego dystrybucja z samÄ… przeglÄ…darkÄ…, a nie przez sklep z dodatkami.

PrzeglÄ…darki mogÅ‚yby dodatkowo ograniczyÄ‡ naduÅ¼ycia uprawnieÅ„ rozszerzeÅ„. Na przykÅ‚ad API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) i [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) Chrome, uÅ¼ywane do nagrywania ekranu, sÄ… zaprojektowane w celu minimalizacji naduÅ¼yÄ‡. API tabCapture moÅ¼e byÄ‡ aktywowane tylko poprzez bezpoÅ›redniÄ… interakcjÄ™ uÅ¼ytkownika, takÄ… jak klikniÄ™cie na ikonÄ™ rozszerzenia, podczas gdy desktopCapture wymaga potwierdzenia uÅ¼ytkownika, aby okno mogÅ‚o byÄ‡ nagrywane, zapobiegajÄ…c potajemnym dziaÅ‚aniom nagrywajÄ…cym.

Jednak zaostrzenie Å›rodkÃ³w bezpieczeÅ„stwa czÄ™sto prowadzi do zmniejszenia elastycznoÅ›ci i przyjaznoÅ›ci dla uÅ¼ytkownika rozszerzeÅ„. Uprawnienie [activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustruje ten kompromis. ZostaÅ‚o wprowadzone, aby wyeliminowaÄ‡ potrzebÄ™, aby rozszerzenia Å¼Ä…daÅ‚y uprawnieÅ„ hosta w caÅ‚ym internecie, pozwalajÄ…c rozszerzeniom na dostÄ™p tylko do bieÅ¼Ä…cej karty po wyraÅºnej aktywacji przez uÅ¼ytkownika. Ten model jest skuteczny dla rozszerzeÅ„ wymagajÄ…cych dziaÅ‚aÅ„ inicjowanych przez uÅ¼ytkownika, ale nie sprawdza siÄ™ w przypadku tych, ktÃ³re wymagajÄ… automatycznych lub prewencyjnych dziaÅ‚aÅ„, co kompromituje wygodÄ™ i natychmiastowÄ… reakcjÄ™.

## **Referencje**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
