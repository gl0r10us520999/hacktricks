# BrowExt - permisos & host\_permissions

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci칩n B치sica

### **`permissions`**

Los permisos se definen en el archivo **`manifest.json`** de la extensi칩n utilizando la propiedad **`permissions`** y permiten el acceso a casi cualquier cosa a la que un navegador puede acceder (Cookies o Almacenamiento F칤sico):

El manifiesto anterior declara que la extensi칩n requiere el permiso `storage`. Esto significa que puede usar [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para almacenar sus datos de manera persistente. A diferencia de las cookies o las APIs de `localStorage` que dan a los usuarios cierto nivel de control, **el almacenamiento de la extensi칩n normalmente solo puede ser borrado desinstalando la extensi칩n**.

Una extensi칩n solicitar치 los permisos indicados en su archivo **`manifest.json`** y despu칠s de instalar la extensi칩n, siempre puedes **verificar sus permisos en tu navegador**, como se muestra en esta imagen:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Puedes encontrar la [**lista completa de permisos que una extensi칩n de navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

La configuraci칩n opcional pero poderosa **`host_permissions`** indica con qu칠 hosts la extensi칩n podr치 interactuar a trav칠s de APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), y [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Los siguientes `host_permissions` permiten b치sicamente cada web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estos son los hosts a los que la extensi칩n del navegador puede acceder libremente. Esto se debe a que cuando una extensi칩n del navegador llama a **`fetch("https://gmail.com/")`**, no est치 restringida por CORS.

## Abusando de `permissions` y `host_permissions`

### Tabs

Adem치s, **`host_permissions`** tambi칠n desbloquea la funcionalidad "avanzada" de la [**API de tabs**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Permiten que la extensi칩n llame a [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) y no solo obtenga una **lista de las pesta침as del navegador del usuario**, sino que tambi칠n aprenda qu칠 **p치gina web (es decir, direcci칩n y t칤tulo) est치 cargada**.

{% hint style="danger" %}
No solo eso, los oyentes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **se vuelven mucho m치s 칰tiles tambi칠n**. Estos ser치n notificados cada vez que se cargue una nueva p치gina en una pesta침a.
{% endhint %}

### Ejecutando scripts de contenido <a href="#running-content-scripts" id="running-content-scripts"></a>

Los scripts de contenido no necesariamente est치n escritos de forma est치tica en el manifiesto de la extensi칩n. Dadas suficientes **`host_permissions`**, **las extensiones tambi칠n pueden cargarlos din치micamente llamando a** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas API permiten ejecutar no solo archivos contenidos en las extensiones como scripts de contenido, sino tambi칠n **c칩digo arbitrario**. La primera permite pasar c칩digo JavaScript como una cadena, mientras que la segunda espera una funci칩n de JavaScript que es menos propensa a vulnerabilidades de inyecci칩n. A칰n as칤, ambas API causar치n estragos si se usan incorrectamente.

{% hint style="danger" %}
Adem치s de las capacidades anteriores, los scripts de contenido podr칤an, por ejemplo, **interceptar credenciales** a medida que se ingresan en las p치ginas web. Otra forma cl치sica de abusar de ellos es **inyectar publicidad** en cada sitio web. Agregar **mensajes de estafa** para abusar de la credibilidad de los sitios de noticias tambi칠n es posible. Finalmente, podr칤an **manipular sitios web bancarios** para redirigir transferencias de dinero.
{% endhint %}

### Privilegios impl칤citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Algunos privilegios de la extensi칩n **no tienen que ser declarados expl칤citamente**. Un ejemplo es la [API de tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): su funcionalidad b치sica es accesible sin ning칰n privilegio. Cualquier extensi칩n puede ser notificada cuando abres y cierras pesta침as, simplemente no sabr치 a qu칠 sitio web corresponden estas pesta침as.

쯉uena demasiado inofensivo? La [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) es algo menos inofensiva. Puede ser utilizada para **crear una nueva pesta침a**, esencialmente lo mismo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) que puede ser llamado por cualquier sitio web. Sin embargo, mientras `window.open()` est치 sujeto al **bloqueador de ventanas emergentes, `tabs.create()` no lo est치**.

{% hint style="danger" %}
Una extensi칩n puede crear cualquier n칰mero de pesta침as cuando quiera.
{% endhint %}

Si revisas los posibles par치metros de `tabs.create()`, tambi칠n notar치s que sus capacidades van mucho m치s all치 de lo que `window.open()` puede controlar. Y aunque Firefox no permite el uso de URIs `data:` con esta API, Chrome no tiene tal protecci칩n. **El uso de tales URIs en el nivel superior ha sido** [**prohibido debido a su abuso para phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) es muy similar a `tabs.create()`, pero **modificar치 una pesta침a existente**. As칤 que una extensi칩n maliciosa puede, por ejemplo, cargar arbitrariamente una p치gina de publicidad en una de tus pesta침as, y tambi칠n puede activar la pesta침a correspondiente.

### Webcam, geolocalizaci칩n y amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probablemente sepas que los sitios web pueden solicitar permisos especiales, por ejemplo, para acceder a tu c치mara web (herramientas de videoconferencia) o ubicaci칩n geogr치fica (mapas). Son caracter칤sticas con un considerable potencial de abuso, por lo que los usuarios deben confirmar cada vez que a칰n desean esto.

{% hint style="danger" %}
No es as칤 con las extensiones del navegador. **Si una extensi칩n del navegador** [**quiere acceso a tu c치mara web o micr칩fono**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, solo necesita pedir permiso una vez**
{% endhint %}

T칤picamente, una extensi칩n lo har치 inmediatamente despu칠s de ser instalada. Una vez que se acepta este aviso, **el acceso a la c치mara web es posible en cualquier momento**, incluso si el usuario no est치 interactuando con la extensi칩n en ese momento. S칤, un usuario solo aceptar치 este aviso si la extensi칩n realmente necesita acceso a la c치mara web. Pero despu칠s de eso, deben confiar en que la extensi칩n no grabar치 nada en secreto.

Con acceso a [tu ubicaci칩n geogr치fica exacta](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) o [el contenido de tu portapapeles](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), otorgar permiso expl칤citamente es innecesario por completo. **Una extensi칩n simplemente agrega `geolocation` o `clipboard` a la** [**entrada de permisos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de su manifiesto**. Estos privilegios de acceso se otorgan impl칤citamente cuando se instala la extensi칩n. As칤 que una extensi칩n maliciosa o comprometida con estos privilegios puede crear tu perfil de movimiento o monitorear tu portapapeles en busca de contrase침as copiadas sin que te des cuenta.

Agregar la palabra clave **`history`** a la [entrada de permisos](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifiesto de la extensi칩n otorga **acceso a la** [**API de history**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Permite recuperar todo el historial de navegaci칩n del usuario de una vez, sin esperar a que el usuario visite estos sitios web nuevamente.

El **permiso `bookmarks`** tiene un potencial de abuso similar, este permite **leer todos los marcadores a trav칠s de la** [**API de bookmarks**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiso de almacenamiento <a href="#the-storage-permission" id="the-storage-permission"></a>

El almacenamiento de la extensi칩n es simplemente una colecci칩n de clave-valor, muy similar a [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que cualquier sitio web podr칤a usar. Por lo tanto, no se debe almacenar informaci칩n sensible aqu칤.

Sin embargo, las empresas de publicidad tambi칠n podr칤an abusar de este almacenamiento.

### M치s permisos

Puedes encontrar la [**lista completa de permisos que una extensi칩n de navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Prevenci칩n <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La pol칤tica de los desarrolladores de Google proh칤be expl칤citamente a las extensiones solicitar m치s privilegios de los necesarios para su funcionalidad, mitigando efectivamente las solicitudes excesivas de permisos. Un caso en el que una extensi칩n del navegador sobrepas칩 este l칤mite involucr칩 su distribuci칩n con el propio navegador en lugar de a trav칠s de una tienda de complementos.

Los navegadores podr칤an limitar a칰n m치s el abuso de los privilegios de las extensiones. Por ejemplo, las API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) y [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) de Chrome, utilizadas para la grabaci칩n de pantalla, est치n dise침adas para minimizar el abuso. La API tabCapture solo puede ser activada a trav칠s de la interacci칩n directa del usuario, como hacer clic en el 칤cono de la extensi칩n, mientras que desktopCapture requiere confirmaci칩n del usuario para que la ventana sea grabada, previniendo actividades de grabaci칩n clandestinas.

Sin embargo, endurecer las medidas de seguridad a menudo resulta en una disminuci칩n de la flexibilidad y la facilidad de uso de las extensiones. El permiso [activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustra este compromiso. Se introdujo para eliminar la necesidad de que las extensiones solicitaran privilegios de host en toda la internet, permitiendo que las extensiones accedan solo a la pesta침a actual tras la activaci칩n expl칤cita por parte del usuario. Este modelo es efectivo para extensiones que requieren acciones iniciadas por el usuario, pero no es suficiente para aquellas que requieren acciones autom치ticas o preventivas, comprometiendo as칤 la conveniencia y la capacidad de respuesta inmediata.

## **Referencias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
