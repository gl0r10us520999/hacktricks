# Toma de Control de Cuenta

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## **Problema de Autorizaci칩n**

Se debe intentar cambiar el correo de una cuenta, y el proceso de confirmaci칩n **debe ser examinado**. Si se encuentra **d칠bil**, el correo debe ser cambiado al del objetivo y luego confirmado.

## **Problema de Normalizaci칩n de Unicode**

1. La cuenta del objetivo `victim@gmail.com`
2. Se debe crear una cuenta usando Unicode\
por ejemplo: `vi캖tim@gmail.com`

Como se explic칩 en [**esta charla**](https://www.youtube.com/watch?v=CiIyaZ3x49c), el ataque anterior tambi칠n podr칤a realizarse abusando de proveedores de identidad de terceros:

* Crear una cuenta en el proveedor de identidad de terceros con un correo similar al de la v칤ctima usando alg칰n car치cter unicode (`vi캖tim@company.com`).
* El proveedor de terceros no deber칤a verificar el correo.
* Si el proveedor de identidad verifica el correo, tal vez puedas atacar la parte del dominio como: `victim@캖ompany.com` y registrar ese dominio y esperar que el proveedor de identidad genere la versi칩n ascii del dominio mientras la plataforma de la v칤ctima normaliza el nombre de dominio.
* Iniciar sesi칩n a trav칠s de este proveedor de identidad en la plataforma de la v칤ctima que deber칤a normalizar el car치cter unicode y permitirte acceder a la cuenta de la v칤ctima.

Para m치s detalles, consulta el documento sobre Normalizaci칩n de Unicode:

{% content-ref url="unicode-injection/unicode-normalization.md" %}
[unicode-normalization.md](unicode-injection/unicode-normalization.md)
{% endcontent-ref %}

## **Reutilizaci칩n de Token de Restablecimiento**

Si el sistema objetivo permite que el **enlace de restablecimiento sea reutilizado**, se deben hacer esfuerzos para **encontrar m치s enlaces de restablecimiento** utilizando herramientas como `gau`, `wayback` o `scan.io`.

## **Pre Toma de Control de Cuenta**

1. El correo de la v칤ctima debe ser utilizado para registrarse en la plataforma, y se debe establecer una contrase침a (se debe intentar confirmarla, aunque carecer de acceso a los correos de la v칤ctima podr칤a hacer esto imposible).
2. Se debe esperar hasta que la v칤ctima se registre usando OAuth y confirme la cuenta.
3. Se espera que el registro regular sea confirmado, permitiendo el acceso a la cuenta de la v칤ctima.

## **Configuraci칩n Incorrecta de CORS para Toma de Control de Cuenta**

Si la p치gina contiene **configuraciones incorrectas de CORS**, podr칤as ser capaz de **robar informaci칩n sensible** del usuario para **tomar el control de su cuenta** o hacer que cambie la informaci칩n de autenticaci칩n con el mismo prop칩sito:

{% content-ref url="cors-bypass.md" %}
[cors-bypass.md](cors-bypass.md)
{% endcontent-ref %}

## **CSRF para Toma de Control de Cuenta**

Si la p치gina es vulnerable a CSRF, podr칤as ser capaz de hacer que el **usuario modifique su contrase침a**, correo o autenticaci칩n para que luego puedas acceder a ello:

{% content-ref url="csrf-cross-site-request-forgery.md" %}
[csrf-cross-site-request-forgery.md](csrf-cross-site-request-forgery.md)
{% endcontent-ref %}

## **XSS para Toma de Control de Cuenta**

Si encuentras un XSS en la aplicaci칩n, podr칤as ser capaz de robar cookies, almacenamiento local o informaci칩n de la p치gina web que podr칤a permitirte tomar el control de la cuenta:

{% content-ref url="xss-cross-site-scripting/" %}
[xss-cross-site-scripting](xss-cross-site-scripting/)
{% endcontent-ref %}

## **Misma Origen + Cookies**

Si encuentras un XSS limitado o una toma de control de subdominio, podr칤as jugar con las cookies (fij치ndolas, por ejemplo) para intentar comprometer la cuenta de la v칤ctima:

{% content-ref url="hacking-with-cookies/" %}
[hacking-with-cookies](hacking-with-cookies/)
{% endcontent-ref %}

## **Atacando el Mecanismo de Restablecimiento de Contrase침a**

{% content-ref url="reset-password.md" %}
[reset-password.md](reset-password.md)
{% endcontent-ref %}

## **Manipulaci칩n de Respuesta**

Si la respuesta de autenticaci칩n podr칤a ser **reducida a un simple booleano, solo intenta cambiar falso a verdadero** y ver si obtienes acceso.

## OAuth para Toma de Control de Cuenta

{% content-ref url="oauth-to-account-takeover.md" %}
[oauth-to-account-takeover.md](oauth-to-account-takeover.md)
{% endcontent-ref %}

## Inyecci칩n de Encabezado Host

1. El encabezado Host se modifica tras la iniciaci칩n de una solicitud de restablecimiento de contrase침a.
2. El encabezado proxy `X-Forwarded-For` se altera a `attacker.com`.
3. Los encabezados Host, Referer y Origin se cambian simult치neamente a `attacker.com`.
4. Despu칠s de iniciar un restablecimiento de contrase침a y optar por reenviar el correo, se emplean los tres m칠todos mencionados anteriormente.

## Manipulaci칩n de Respuesta

1. **Manipulaci칩n de C칩digo**: El c칩digo de estado se altera a `200 OK`.
2. **Manipulaci칩n de C칩digo y Cuerpo**:
* El c칩digo de estado se cambia a `200 OK`.
* El cuerpo de la respuesta se modifica a `{"success":true}` o un objeto vac칤o `{}`.

Estas t칠cnicas de manipulaci칩n son efectivas en escenarios donde se utiliza JSON para la transmisi칩n y recepci칩n de datos.

## Cambiar correo de la sesi칩n actual

De [este informe](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea):

* El atacante solicita cambiar su correo por uno nuevo.
* El atacante recibe un enlace para confirmar el cambio del correo.
* El atacante env칤a el enlace a la v칤ctima para que lo haga clic.
* El correo de la v칤ctima se cambia al indicado por el atacante.
* El atacante puede recuperar la contrase침a y tomar el control de la cuenta.

Esto tambi칠n ocurri칩 en [**este informe**](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea).

### Cookies Antiguas

Como se explic칩 [**en esta publicaci칩n**](https://medium.com/@niraj1mahajan/uncovering-the-hidden-vulnerability-how-i-found-an-authentication-bypass-on-shopifys-exchange-cc2729ea31a9), fue posible iniciar sesi칩n en una cuenta, guardar las cookies como un usuario autenticado, cerrar sesi칩n y luego iniciar sesi칩n nuevamente.\
Con el nuevo inicio de sesi칩n, aunque se podr칤an generar cookies diferentes, las antiguas comenzaron a funcionar nuevamente.

## Referencias

* [https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050](https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050)
* [https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
