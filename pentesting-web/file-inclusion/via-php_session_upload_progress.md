# LFI2RCE via PHP\_SESSION\_UPLOAD\_PROGRESS

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚

Î‘Î½ Î²ÏÎµÎ¯Ï„Îµ Î¼Î¹Î± **Î¤Î¿Ï€Î¹ÎºÎ® Î£Ï…Î¼Ï€ÎµÏÎ¯Î»Î·ÏˆÎ· Î‘ÏÏ‡ÎµÎ¯Î¿Ï…** Î±ÎºÏŒÎ¼Î± ÎºÎ±Î¹ Î±Î½ **Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±** ÎºÎ±Î¹ `session.auto_start` ÎµÎ¯Î½Î±Î¹ `Off`. Î‘Î½ **`session.upload_progress.enabled`** ÎµÎ¯Î½Î±Î¹ **`On`** ÎºÎ±Î¹ Ï€Î±ÏÎ­Ï‡ÎµÏ„Îµ Ï„Î¿ **`PHP_SESSION_UPLOAD_PROGRESS`** ÏƒÏ„Î± **multipart POST** Î´ÎµÎ´Î¿Î¼Î­Î½Î±, Ï„Î¿ PHP Î¸Î± **ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Î³Î¹Î± ÎµÏƒÎ¬Ï‚**.
```bash
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -d 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -F 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'  -F 'file=@/etc/passwd'
$ ls -a /var/lib/php/sessions/
. .. sess_iamorange

In the last example the session will contain the string blahblahblah
```
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¼Îµ Ï„Î¿ **`PHP_SESSION_UPLOAD_PROGRESS`** Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î­ÏƒÎ± ÏƒÏ„Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±**, Î¿Ï€ÏŒÏ„Îµ Î±Î½ ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î¬Î²ÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±Ï‚ ÏƒÎ±Ï‚, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î¬Î²ÎµÏ„Îµ Î­Î½Î± Î¼Î­ÏÎ¿Ï‚ Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Îµ (Î­Î½Î± php shellcode Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±).

{% hint style="info" %}
Î‘Î½ ÎºÎ±Î¹ Î¿Î¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î¿Î´Î·Î³Î¯ÎµÏ‚ ÏƒÏ„Î¿ Î”Î¹Î±Î´Î¯ÎºÏ„Ï…Î¿ ÏƒÎ±Ï‚ Ï€ÏÎ¿Ï„ÎµÎ¯Î½Î¿Ï…Î½ Î½Î± Î¿ÏÎ¯ÏƒÎµÏ„Îµ Ï„Î¿ `session.upload_progress.cleanup` ÏƒÎµ `Off` Î³Î¹Î± ÏƒÎºÎ¿Ï€Î¿ÏÏ‚ Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ·Ï‚. Î— Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· `session.upload_progress.cleanup` ÏƒÏ„Î¿ PHP ÎµÎ¯Î½Î±Î¹ Î±ÎºÏŒÎ¼Î± `On`. Î‘Ï…Ï„ÏŒ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Î· Ï€ÏÏŒÎ¿Î´Î¿Ï‚ Ï„Î·Ï‚ Î¼ÎµÏ„Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏƒÎ±Ï‚ ÏƒÏ„Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î± Î¸Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ ÏƒÏ…Î½Ï„Î¿Î¼ÏŒÏ„ÎµÏÎ¿ Î´Ï…Î½Î±Ï„ÏŒ. ÎˆÏ„ÏƒÎ¹, Î±Ï…Ï„ÏŒ Î¸Î± ÎµÎ¯Î½Î±Î¹ **Race Condition**.
{% endhint %}

### Î¤Î¿ CTF

Î£Ï„Î¿ [**Î±ÏÏ‡Î¹ÎºÏŒ CTF**](https://blog.orange.tw/2018/10/) ÏŒÏ€Î¿Ï… ÏƒÏ‡Î¿Î»Î¹Î¬Î¶ÎµÏ„Î±Î¹ Î±Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ®, Î´ÎµÎ½ Î®Ï„Î±Î½ Î±ÏÎºÎµÏ„ÏŒ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Ï„Î¿ Race Condition, Î±Î»Î»Î¬ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï€Î¿Ï… Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Î­Ï€ÏÎµÏ€Îµ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Î¾ÎµÎºÎ¹Î½Î¬ Î¼Îµ Ï„Î· ÏƒÏ…Î¼Î²Î¿Î»Î¿ÏƒÎµÎ¹ÏÎ¬ `@<?php`.

Î›ÏŒÎ³Ï‰ Ï„Î·Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ ÏÏÎ¸Î¼Î¹ÏƒÎ·Ï‚ Ï„Î¿Ï… `session.upload_progress.prefix`, Ï„Î¿ **Î±ÏÏ‡ÎµÎ¯Î¿ Î£Î¥ÎÎ•Î”Î¡Î™Î‘Î£ Î¼Î±Ï‚ Î¸Î± Î¾ÎµÎºÎ¹Î½Î¬ Î¼Îµ Î­Î½Î± ÎµÎ½Î¿Ï‡Î»Î·Ï„Î¹ÎºÏŒ Ï€ÏÏŒÎ¸ÎµÎ¼Î±** `upload_progress_` ÎŒÏ€Ï‰Ï‚: `upload_progress_controlledcontentbyattacker`

Î¤Î¿ ÎºÏŒÎ»Ï€Î¿ Î³Î¹Î± **Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ Ï€ÏÏŒÎ¸ÎµÎ¼Î±** Î®Ï„Î±Î½ Î½Î± **base64encode Ï„Î¿ payload 3 Ï†Î¿ÏÎ­Ï‚** ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Ï„Î¿ Î±Ï€Î¿ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î¼Î­ÏƒÏ‰ Ï†Î¯Î»Ï„ÏÏ‰Î½ `convert.base64-decode`, Î±Ï…Ï„ÏŒ ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ ÎµÏ€ÎµÎ¹Î´Î® ÏŒÏ„Î±Î½ **Î±Ï€Î¿ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹ÎµÎ¯Ï„Îµ Ï„Î¿ base64, Ï„Î¿ PHP Î¸Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ Ï€ÎµÏÎ¯ÎµÏÎ³Î¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚**, Î¿Ï€ÏŒÏ„Îµ Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 3 Ï†Î¿ÏÎ­Ï‚ **Î¼ÏŒÎ½Î¿** Ï„Î¿ **payload** **Ï€Î¿Ï… ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ** Î±Ï€ÏŒ Ï„Î¿Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿ Î¸Î± **Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹** (ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¿ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ Î¼Î­ÏÎ¿Ï‚).

Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î±Î½Î¬ÏÏ„Î·ÏƒÎ· [https://blog.orange.tw/2018/10/](https://blog.orange.tw/2018/10/) ÎºÎ±Î¹ Ï„ÎµÎ»Î¹ÎºÎ® ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ· [https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py](https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py)\
ÎœÎ¹Î± Î¬Î»Î»Î· Î±Î½Î¬ÏÏ„Î·ÏƒÎ· ÏƒÏ„Î¿ [https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/](https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/)

{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
