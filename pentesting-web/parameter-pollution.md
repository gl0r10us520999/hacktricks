# Parameter Pollution | JSON Injection

## Parameter Pollution

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## HTTP Parameter Pollution (HPP) √úbersicht

HTTP Parameter Pollution (HPP) ist eine Technik, bei der Angreifer HTTP-Parameter manipulieren, um das Verhalten einer Webanwendung auf unbeabsichtigte Weise zu √§ndern. Diese Manipulation erfolgt durch Hinzuf√ºgen, √Ñndern oder Duplizieren von HTTP-Parametern. Die Auswirkungen dieser Manipulationen sind f√ºr den Benutzer nicht direkt sichtbar, k√∂nnen jedoch die Funktionalit√§t der Anwendung auf der Serverseite erheblich ver√§ndern, mit beobachtbaren Auswirkungen auf der Clientseite.

### Beispiel f√ºr HTTP Parameter Pollution (HPP)

Eine Transaktions-URL einer Bankanwendung:

* **Urspr√ºngliche URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000`

Durch das Einf√ºgen eines zus√§tzlichen `from`-Parameters:

* **Manipulierte URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000&from=accountC`

Die Transaktion k√∂nnte f√§lschlicherweise `accountC` anstelle von `accountA` belastet werden, was das Potenzial von HPP zur Manipulation von Transaktionen oder anderen Funktionen wie Passwortzur√ºcksetzungen, 2FA-Einstellungen oder API-Schl√ºsselanforderungen zeigt.

#### **Technologiespezifische Parameterverarbeitung**

* Die Art und Weise, wie Parameter verarbeitet und priorisiert werden, h√§ngt von der zugrunde liegenden Webtechnologie ab, was die Ausnutzbarkeit von HPP beeinflusst.
* Tools wie [Wappalyzer](https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/) helfen dabei, diese Technologien und deren Verhaltensweisen bei der Verarbeitung zu identifizieren.

### PHP und HPP-Ausnutzung

**OTP-Manipulationsfall:**

* **Kontext:** Ein Anmeldeverfahren, das ein Einmalpasswort (OTP) erfordert, wurde ausgenutzt.
* **Methode:** Durch das Abfangen der OTP-Anforderung mit Tools wie Burp Suite duplizierten Angreifer den `email`-Parameter in der HTTP-Anforderung.
* **Ergebnis:** Das OTP, das f√ºr die urspr√ºngliche E-Mail bestimmt war, wurde stattdessen an die zweite in der manipulierten Anfrage angegebene E-Mail-Adresse gesendet. Dieser Fehler erm√∂glichte unbefugten Zugriff, indem die beabsichtigte Sicherheitsma√ünahme umgangen wurde.

Dieses Szenario hebt einen kritischen Fehler im Backend der Anwendung hervor, das den ersten `email`-Parameter zur OTP-Generierung verarbeitete, aber den letzten f√ºr die Zustellung verwendete.

**API-Schl√ºssel-Manipulationsfall:**

* **Szenario:** Eine Anwendung erm√∂glicht es Benutzern, ihren API-Schl√ºssel √ºber eine Profilseite zu aktualisieren.
* **Angriffsvektor:** Ein Angreifer entdeckt, dass er durch das Anh√§ngen eines zus√§tzlichen `api_key`-Parameters an die POST-Anforderung das Ergebnis der API-Schl√ºsselaktualisierungsfunktion manipulieren kann.
* **Technik:** Mit einem Tool wie Burp Suite erstellt der Angreifer eine Anfrage, die zwei `api_key`-Parameter enth√§lt: einen legitimen und einen b√∂sartigen. Der Server, der nur die letzte Instanz verarbeitet, aktualisiert den API-Schl√ºssel auf den vom Angreifer bereitgestellten Wert.
* **Ergebnis:** Der Angreifer erh√§lt die Kontrolle √ºber die API-Funktionalit√§t des Opfers und kann m√∂glicherweise unbefugt auf private Daten zugreifen oder diese √§ndern.

Dieses Beispiel unterstreicht weiter die Notwendigkeit einer sicheren Parameterverarbeitung, insbesondere bei so kritischen Funktionen wie der Verwaltung von API-Schl√ºsseln.

### Parameterverarbeitung: Flask vs. PHP

Die Art und Weise, wie Webtechnologien doppelte HTTP-Parameter behandeln, variiert und beeinflusst ihre Anf√§lligkeit f√ºr HPP-Angriffe:

* **Flask:** Nimmt den ersten gefundenen Parameterwert an, wie `a=1` in einer Abfragezeichenfolge `a=1&a=2`, und priorisiert die erste Instanz gegen√ºber nachfolgenden Duplikaten.
* **PHP (auf Apache HTTP Server):** Priorisiert hingegen den letzten Parameterwert und w√§hlt `a=2` im gegebenen Beispiel. Dieses Verhalten kann unbeabsichtigt HPP-Angriffe erleichtern, indem es den manipulierten Parameter des Angreifers √ºber den urspr√ºnglichen respektiert.

## Parameterverunreinigung nach Technologie

Die Ergebnisse stammen von [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)

### PHP 8.3.11 UND Apache 2.4.62 <a href="#id-9523" id="id-9523"></a>

<figure><img src="../.gitbook/assets/image (1255).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg</a></p></figcaption></figure>

1. Ignorieren Sie alles nach %00 im Parameternamen.
2. Behandeln Sie name\[] als Array.
3. \_GET bedeutet nicht GET-Methode.
4. Bevorzugen Sie den letzten Parameter.

### Ruby 3.3.5 und WEBrick 1.8.2

<figure><img src="../.gitbook/assets/image (1257).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg</a></p></figcaption></figure>

1. Verwendet die & und ; Trennzeichen, um Parameter zu trennen.
2. name\[] wird nicht erkannt.
3. Bevorzugen Sie den ersten Parameter.

### Spring MVC 6.0.23 UND Apache Tomcat 10.1.30 <a href="#dd68" id="dd68"></a>

<figure><img src="../.gitbook/assets/image (1258).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg</a></p></figcaption></figure>

1. POST RequestMapping == PostMapping & GET RequestMapping == GetMapping.
2. POST RequestMapping & PostMapping erkennen name\[].
3. Bevorzugen Sie name, wenn name UND name\[] vorhanden sind.
4. Verkettung von Parametern z.B. first,last.
5. POST RequestMapping & PostMapping erkennen Abfrageparameter mit Content-Type.

### **NodeJS** 20.17.0 **UND** Express 4.21.0 <a href="#id-6d72" id="id-6d72"></a>

<figure><img src="../.gitbook/assets/image (1259).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg</a></p></figcaption></figure>

1. Erkennt name\[].
2. Verkettung von Parametern z.B. first,last.

### GO 1.22.7 <a href="#id-63dc" id="id-63dc"></a>

<figure><img src="../.gitbook/assets/image (1260).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg</a></p></figcaption></figure>

1. name\[] wird NICHT erkannt.
2. Bevorzugen Sie den ersten Parameter.

### Python 3.12.6 UND Werkzeug 3.0.4 UND Flask 3.0.3 <a href="#b853" id="b853"></a>

<figure><img src="../.gitbook/assets/image (1261).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg</a></p></figcaption></figure>

1. name\[] wird NICHT erkannt.
2. Bevorzugen Sie den ersten Parameter.

### Python 3.12.6 UND Django 4.2.15 <a href="#id-8079" id="id-8079"></a>

<figure><img src="../.gitbook/assets/image (1262).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg</a></p></figcaption></figure>

1. name\[] wird NICHT erkannt.
2. Bevorzugen Sie den letzten Parameter.

### Python 3.12.6 UND Tornado 6.4.1 <a href="#id-2ad8" id="id-2ad8"></a>

<figure><img src="../.gitbook/assets/image (1263).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg</a></p></figcaption></figure>

1. name\[] wird NICHT erkannt.
2. Bevorzugen Sie den letzten Parameter.

## JSON Injection

### Doppelte Schl√ºssel
```ini
obj = {"test": "user", "test": "admin"}
```
Der Frontend k√∂nnte die erste Vorkommen glauben, w√§hrend das Backend die zweite Vorkommen des Schl√ºssels verwendet.

### Schl√ºssel-Kollision: Zeichenk√ºrzung und Kommentare

Bestimmte Zeichen werden vom Frontend m√∂glicherweise nicht korrekt interpretiert, aber das Backend wird sie interpretieren und diese Schl√ºssel verwenden. Dies k√∂nnte n√ºtzlich sein, um **bestimmte Einschr√§nkungen zu umgehen**:
```json
{"test": 1, "test\[raw \x0d byte]": 2}
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```
Beachten Sie, dass in diesen F√§llen das Frontend denken k√∂nnte, dass `test == 1` und das Backend denken k√∂nnte, dass `test == 2`.

Dies kann auch verwendet werden, um Wertbeschr√§nkungen zu umgehen wie:
```json
{"role": "administrator\[raw \x0d byte]"}
{"role":"administrator\ud800"}
{"role": "administrator""}
{"role": "admini\strator"}
```
### **Verwendung von Kommentartrunkierung**

{% code overflow="wrap" %}
```ini
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```
{% endcode %}

Hier verwenden wir den Serializer von jedem Parser, um dessen jeweilige Ausgabe zu sehen.

Serializer 1 (z. B. GoLangs GoJay-Bibliothek) produziert:

* `description = "Duplicate with comments"`
* `test = 2`
* `extra = ""`

Serializer 2 (z. B. Javas JSON-iterator-Bibliothek) produziert:

* `description = "Duplicate with comments"`
* `extra = "/*"`
* `extra2 = "*/"`
* `test = 1`

Alternativ kann die einfache Verwendung von Kommentaren ebenfalls effektiv sein:
```ini
obj = {"description": "Comment support", "test": 1, "extra": "a"/*, "test": 2, "extra2": "b"*/}
```
Die GSON-Bibliothek von Java:
```json
{"description":"Comment support","test":1,"extra":"a"}
```
Ruby‚Äôs simdjson-Bibliothek:
```json
{"description":"Comment support","test":2,"extra":"a","extra2":"b"}
```
### **Inkonsistente Priorit√§t: Deserialisierung vs. Serialisierung**
```ini
obj = {"test": 1, "test": 2}

obj["test"] // 1
obj.toString() // {"test": 2}
```
### Float und Integer

Die Zahl
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```
kann in mehrere Darstellungen decodiert werden, einschlie√ülich:
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9.999999999999999e95
1E+96
0
9223372036854775807
```
Welche Inkonsistenzen erzeugen k√∂nnte

## Referenzen

* [https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654](https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654)
* [https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution](https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution)
* [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)
* [https://bishopfox.com/blog/json-interoperability-vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
