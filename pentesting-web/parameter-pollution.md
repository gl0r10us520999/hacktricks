# Parameter Pollution | JSON Injection

## Parameter Pollution

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** 汳ｬ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** 汾ｦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositﾃｳrios do github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Visﾃ｣o Geral da Poluiﾃｧﾃ｣o de Parﾃ｢metros HTTP (HPP)

A Poluiﾃｧﾃ｣o de Parﾃ｢metros HTTP (HPP) ﾃｩ uma tﾃｩcnica onde atacantes manipulam parﾃ｢metros HTTP para alterar o comportamento de uma aplicaﾃｧﾃ｣o web de maneiras nﾃ｣o intencionais. Essa manipulaﾃｧﾃ｣o ﾃｩ feita adicionando, modificando ou duplicando parﾃ｢metros HTTP. O efeito dessas manipulaﾃｧﾃｵes nﾃ｣o ﾃｩ diretamente visﾃｭvel para o usuﾃ｡rio, mas pode alterar significativamente a funcionalidade da aplicaﾃｧﾃ｣o no lado do servidor, com impactos observﾃ｡veis no lado do cliente.

### Exemplo de Poluiﾃｧﾃ｣o de Parﾃ｢metros HTTP (HPP)

Uma URL de transaﾃｧﾃ｣o de um aplicativo bancﾃ｡rio:

* **URL Original:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000`

Ao inserir um parﾃ｢metro `from` adicional:

* **URL Manipulada:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000&from=accountC`

A transaﾃｧﾃ｣o pode ser incorretamente cobrada para `accountC` em vez de `accountA`, demonstrando o potencial da HPP para manipular transaﾃｧﾃｵes ou outras funcionalidades, como redefiniﾃｧﾃｵes de senha, configuraﾃｧﾃｵes de 2FA ou solicitaﾃｧﾃｵes de chave de API.

#### **Anﾃ｡lise de Parﾃ｢metros Especﾃｭfica da Tecnologia**

* A forma como os parﾃ｢metros sﾃ｣o analisados e priorizados depende da tecnologia web subjacente, afetando como a HPP pode ser explorada.
* Ferramentas como [Wappalyzer](https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/) ajudam a identificar essas tecnologias e seus comportamentos de anﾃ｡lise.

### Exploraﾃｧﾃ｣o de HPP em PHP

**Caso de Manipulaﾃｧﾃ｣o de OTP:**

* **Contexto:** Um mecanismo de login que requer uma Senha de Uso ﾃ嗜ico (OTP) foi explorado.
* **Mﾃｩtodo:** Ao interceptar a solicitaﾃｧﾃ｣o de OTP usando ferramentas como Burp Suite, os atacantes duplicaram o parﾃ｢metro `email` na solicitaﾃｧﾃ｣o HTTP.
* **Resultado:** O OTP, destinado ao email inicial, foi enviado para o segundo endereﾃｧo de email especificado na solicitaﾃｧﾃ｣o manipulada. Essa falha permitiu acesso nﾃ｣o autorizado ao contornar a medida de seguranﾃｧa pretendida.

Esse cenﾃ｡rio destaca uma falha crﾃｭtica no backend da aplicaﾃｧﾃ｣o, que processou o primeiro parﾃ｢metro `email` para a geraﾃｧﾃ｣o de OTP, mas usou o ﾃｺltimo para entrega.

**Caso de Manipulaﾃｧﾃ｣o de Chave de API:**

* **Cenﾃ｡rio:** Um aplicativo permite que os usuﾃ｡rios atualizem sua chave de API atravﾃｩs de uma pﾃ｡gina de configuraﾃｧﾃｵes de perfil.
* **Vetor de Ataque:** Um atacante descobre que, ao anexar um parﾃ｢metro `api_key` adicional ﾃ solicitaﾃｧﾃ｣o POST, pode manipular o resultado da funﾃｧﾃ｣o de atualizaﾃｧﾃ｣o da chave de API.
* **Tﾃｩcnica:** Utilizando uma ferramenta como Burp Suite, o atacante cria uma solicitaﾃｧﾃ｣o que inclui dois parﾃ｢metros `api_key`: um legﾃｭtimo e um malicioso. O servidor, processando apenas a ﾃｺltima ocorrﾃｪncia, atualiza a chave de API para o valor fornecido pelo atacante.
* **Resultado:** O atacante ganha controle sobre a funcionalidade da API da vﾃｭtima, potencialmente acessando ou modificando dados privados de forma nﾃ｣o autorizada.

Esse exemplo reforﾃｧa ainda mais a necessidade de um manuseio seguro de parﾃ｢metros, especialmente em recursos tﾃ｣o crﾃｭticos quanto a gestﾃ｣o de chaves de API.

### Anﾃ｡lise de Parﾃ｢metros: Flask vs. PHP

A forma como as tecnologias web lidam com parﾃ｢metros HTTP duplicados varia, afetando sua suscetibilidade a ataques HPP:

* **Flask:** Adota o primeiro valor de parﾃ｢metro encontrado, como `a=1` em uma string de consulta `a=1&a=2`, priorizando a instﾃ｢ncia inicial em relaﾃｧﾃ｣o a duplicatas subsequentes.
* **PHP (no Apache HTTP Server):** Por outro lado, prioriza o ﾃｺltimo valor de parﾃ｢metro, optando por `a=2` no exemplo dado. Esse comportamento pode inadvertidamente facilitar exploraﾃｧﾃｵes de HPP ao honrar o parﾃ｢metro manipulado do atacante em vez do original.

## Poluiﾃｧﾃ｣o de parﾃ｢metros por tecnologia

Os resultados foram retirados de [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)

### PHP 8.3.11 E Apache 2.4.62 <a href="#id-9523" id="id-9523"></a>

<figure><img src="../.gitbook/assets/image (1255).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg</a></p></figcaption></figure>

1. Ignorar qualquer coisa apﾃｳs %00 no nome do parﾃ｢metro.
2. Tratar name\[] como array.
3. \_GET nﾃ｣o significa Mﾃｩtodo GET.
4. Preferir o ﾃｺltimo parﾃ｢metro.

### Ruby 3.3.5 e WEBrick 1.8.2

<figure><img src="../.gitbook/assets/image (1257).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg</a></p></figcaption></figure>

1. Usa os delimitadores & e ; para dividir parﾃ｢metros.
2. Nﾃ｣o reconhece name\[].
3. Preferir o primeiro parﾃ｢metro.

### Spring MVC 6.0.23 E Apache Tomcat 10.1.30 <a href="#dd68" id="dd68"></a>

<figure><img src="../.gitbook/assets/image (1258).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg</a></p></figcaption></figure>

1. POST RequestMapping == PostMapping & GET RequestMapping == GetMapping.
2. POST RequestMapping & PostMapping reconhecem name[].
3. Preferir name se name E name[] existirem.
4. Concatenar parﾃ｢metros, por exemplo, first,last.
5. POST RequestMapping & PostMapping reconhecem parﾃ｢metros de consulta com Content-Type.

### **NodeJS** 20.17.0 **E** Express 4.21.0 <a href="#id-6d72" id="id-6d72"></a>

<figure><img src="../.gitbook/assets/image (1259).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg</a></p></figcaption></figure>

1. Reconhece name[].
2. Concatenar parﾃ｢metros, por exemplo, first,last.

### GO 1.22.7 <a href="#id-63dc" id="id-63dc"></a>

<figure><img src="../.gitbook/assets/image (1260).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg</a></p></figcaption></figure>

1. Nﾃグ reconhece name[].
2. Preferir o primeiro parﾃ｢metro.

### Python 3.12.6 E Werkzeug 3.0.4 E Flask 3.0.3 <a href="#b853" id="b853"></a>

<figure><img src="../.gitbook/assets/image (1261).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg</a></p></figcaption></figure>

1. Nﾃグ reconhece name[].
2. Preferir o primeiro parﾃ｢metro.

### Python 3.12.6 E Django 4.2.15 <a href="#id-8079" id="id-8079"></a>

<figure><img src="../.gitbook/assets/image (1262).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg</a></p></figcaption></figure>

1. Nﾃグ reconhece name[].
2. Preferir o ﾃｺltimo parﾃ｢metro.

### Python 3.12.6 E Tornado 6.4.1 <a href="#id-2ad8" id="id-2ad8"></a>

<figure><img src="../.gitbook/assets/image (1263).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg</a></p></figcaption></figure>

1. Nﾃグ reconhece name[].
2. Preferir o ﾃｺltimo parﾃ｢metro.

## Injeﾃｧﾃ｣o JSON

### Chaves duplicadas
```ini
obj = {"test": "user", "test": "admin"}
```
A interface pode acreditar na primeira ocorrﾃｪncia enquanto o backend usa a segunda ocorrﾃｪncia da chave.

### Colisﾃ｣o de Chaves: Truncamento de Caracteres e Comentﾃ｡rios

Certos caracteres nﾃ｣o serﾃ｣o interpretados corretamente pela interface, mas o backend os interpretarﾃ｡ e usarﾃ｡ essas chaves, isso pode ser ﾃｺtil para **contornar certas restriﾃｧﾃｵes**:
```json
{"test": 1, "test\[raw \x0d byte]": 2}
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```
Note como nesses casos o front end pode pensar que `test == 1` e o backend pensarﾃ｡ que `test == 2`.

Isso tambﾃｩm pode ser usado para contornar restriﾃｧﾃｵes de valor como:
```json
{"role": "administrator\[raw \x0d byte]"}
{"role":"administrator\ud800"}
{"role": "administrator""}
{"role": "admini\strator"}
```
### **Usando Truncamento de Comentﾃ｡rios**

{% code overflow="wrap" %}
```ini
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```
{% endcode %}

Aqui usaremos o serializador de cada parser para visualizar sua respectiva saﾃｭda.

Serializador 1 (por exemplo, a biblioteca GoJay do GoLang) produzirﾃ｡:

* `description = "Duplicado com comentﾃ｡rios"`
* `test = 2`
* `extra = ""`

Serializador 2 (por exemplo, a biblioteca JSON-iterator do Java) produzirﾃ｡:

* `description = "Duplicado com comentﾃ｡rios"`
* `extra = "/*"`
* `extra2 = "*/"`
* `test = 1`

Alternativamente, o uso direto de comentﾃ｡rios tambﾃｩm pode ser eficaz:
```ini
obj = {"description": "Comment support", "test": 1, "extra": "a"/*, "test": 2, "extra2": "b"*/}
```
A biblioteca GSON do Java:
```json
{"description":"Comment support","test":1,"extra":"a"}
```
A biblioteca simdjson do Ruby:
```json
{"description":"Comment support","test":2,"extra":"a","extra2":"b"}
```
### **Precedﾃｪncia Inconsistente: Desserializaﾃｧﾃ｣o vs. Serializaﾃｧﾃ｣o**
```ini
obj = {"test": 1, "test": 2}

obj["test"] // 1
obj.toString() // {"test": 2}
```
### Float e Inteiro

O nﾃｺmero
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```
pode ser decodificado em mﾃｺltiplas representaﾃｧﾃｵes, incluindo:
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9.999999999999999e95
1E+96
0
9223372036854775807
```
Which might create inconsistﾃｪncias

## Referﾃｪncias

* [https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654](https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654)
* [https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution](https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution)
* [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)
* [https://bishopfox.com/blog/json-interoperability-vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 汳ｬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 汾ｦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
