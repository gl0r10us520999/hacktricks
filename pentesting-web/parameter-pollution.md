# Zanieczyszczenie parametr贸w | Wstrzykiwanie JSON

## Zanieczyszczenie parametr贸w

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Przegld HTTP Parameter Pollution (HPP)

HTTP Parameter Pollution (HPP) to technika, w kt贸rej atakujcy manipuluj parametrami HTTP, aby zmieni zachowanie aplikacji webowej w niezamierzony spos贸b. Manipulacja ta polega na dodawaniu, modyfikowaniu lub duplikowaniu parametr贸w HTTP. Efekt tych manipulacji nie jest bezporednio widoczny dla u偶ytkownika, ale mo偶e znaczco zmieni funkcjonalno aplikacji po stronie serwera, z zauwa偶alnymi skutkami po stronie klienta.

### Przykad HTTP Parameter Pollution (HPP)

URL transakcji aplikacji bankowej:

* **Oryginalny URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000`

Wstawiajc dodatkowy parametr `from`:

* **Manipulowany URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000&from=accountC`

Transakcja mo偶e by bdnie obci偶ona na `accountC` zamiast `accountA`, co pokazuje potencja HPP do manipulacji transakcjami lub innymi funkcjonalnociami, takimi jak resetowanie hase, ustawienia 2FA czy 偶dania kluczy API.

#### **Analiza parametr贸w specyficznych dla technologii**

* Spos贸b, w jaki parametry s analizowane i priorytetowane, zale偶y od u偶ywanej technologii webowej, co wpywa na to, jak HPP mo偶e by wykorzystywane.
* Narzdzia takie jak [Wappalyzer](https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/) pomagaj zidentyfikowa te technologie i ich zachowania analityczne.

### Wykorzystanie HPP w PHP

**Przypadek manipulacji OTP:**

* **Kontekst:** Mechanizm logowania wymagajcy jednorazowego hasa (OTP) zosta wykorzystany.
* **Metoda:** Poprzez przechwycenie 偶dania OTP za pomoc narzdzi takich jak Burp Suite, atakujcy zduplikowa parametr `email` w 偶daniu HTTP.
* **Wynik:** OTP, przeznaczone dla pocztkowego adresu e-mail, zostao wysane na drugi adres e-mail podany w manipulowanym 偶daniu. Ta luka umo偶liwia nieautoryzowany dostp, omijajc zamierzony rodek bezpieczestwa.

Ten scenariusz podkrela krytyczny bd w backendzie aplikacji, kt贸ry przetwarza pierwszy parametr `email` do generacji OTP, ale u偶ywa ostatniego do dostarczenia.

**Przypadek manipulacji kluczem API:**

* **Scenariusz:** Aplikacja pozwala u偶ytkownikom na aktualizacj swojego klucza API przez stron ustawie profilu.
* **Wektor ataku:** Atakujcy odkrywa, 偶e dodajc dodatkowy parametr `api_key` do 偶dania POST, mo偶e manipulowa wynikiem funkcji aktualizacji klucza API.
* **Technika:** Wykorzystujc narzdzie takie jak Burp Suite, atakujcy tworzy 偶danie, kt贸re zawiera dwa parametry `api_key`: jeden prawidowy i jeden zoliwy. Serwer, przetwarzajc tylko ostatnie wystpienie, aktualizuje klucz API na warto podan przez atakujcego.
* **Wynik:** Atakujcy zyskuje kontrol nad funkcjonalnoci API ofiary, potencjalnie uzyskujc dostp do prywatnych danych w spos贸b nieautoryzowany.

Ten przykad dodatkowo podkrela konieczno bezpiecznego zarzdzania parametrami, szczeg贸lnie w funkcjach tak krytycznych jak zarzdzanie kluczem API.

### Analiza parametr贸w: Flask vs. PHP

Spos贸b, w jaki technologie webowe obsuguj duplikaty parametr贸w HTTP, r贸偶ni si, co wpywa na ich podatno na ataki HPP:

* **Flask:** Przyjmuje pierwsz warto parametru, np. `a=1` w cigu zapytania `a=1&a=2`, priorytetujc pocztkow instancj nad kolejnymi duplikatami.
* **PHP (na serwerze Apache HTTP):** Przeciwnie, priorytetuje ostatni warto parametru, wybierajc `a=2` w podanym przykadzie. To zachowanie mo偶e niezamierzenie uatwi wykorzystanie HPP, honorujc zoliwy parametr atakujcego nad oryginalnym.

## Zanieczyszczenie parametr贸w wedug technologii

Wyniki zostay zaczerpnite z [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)

### PHP 8.3.11 I Apache 2.4.62 <a href="#id-9523" id="id-9523"></a>

<figure><img src="../.gitbook/assets/image (1255).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg</a></p></figcaption></figure>

1. Ignoruj wszystko po %00 w nazwie parametru.
2. Obsuguj name\[] jako tablic.
3. \_GET nie oznacza metody GET.
4. Preferuj ostatni parametr.

### Ruby 3.3.5 i WEBrick 1.8.2

<figure><img src="../.gitbook/assets/image (1257).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg</a></p></figcaption></figure>

1. U偶ywa & i ; jako separator贸w do dzielenia parametr贸w.
2. Nie rozpoznaje name[].
3. Preferuje pierwszy parametr.

### Spring MVC 6.0.23 I Apache Tomcat 10.1.30 <a href="#dd68" id="dd68"></a>

<figure><img src="../.gitbook/assets/image (1258).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg</a></p></figcaption></figure>

1. POST RequestMapping == PostMapping & GET RequestMapping == GetMapping.
2. POST RequestMapping & PostMapping rozpoznaje name[].
3. Preferuj name, jeli name i name[] istniej.
4. cz parametry, np. first,last.
5. POST RequestMapping & PostMapping rozpoznaje parametry zapytania z Content-Type.

### **NodeJS** 20.17.0 **I** Express 4.21.0 <a href="#id-6d72" id="id-6d72"></a>

<figure><img src="../.gitbook/assets/image (1259).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg</a></p></figcaption></figure>

1. Rozpoznaje name[].
2. cz parametry, np. first,last.

### GO 1.22.7 <a href="#id-63dc" id="id-63dc"></a>

<figure><img src="../.gitbook/assets/image (1260).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg</a></p></figcaption></figure>

1. NIE rozpoznaje name[].
2. Preferuj pierwszy parametr.

### Python 3.12.6 I Werkzeug 3.0.4 I Flask 3.0.3 <a href="#b853" id="b853"></a>

<figure><img src="../.gitbook/assets/image (1261).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg</a></p></figcaption></figure>

1. NIE rozpoznaje name[].
2. Preferuj pierwszy parametr.

### Python 3.12.6 I Django 4.2.15 <a href="#id-8079" id="id-8079"></a>

<figure><img src="../.gitbook/assets/image (1262).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg</a></p></figcaption></figure>

1. NIE rozpoznaje name[].
2. Preferuj ostatni parametr.

### Python 3.12.6 I Tornado 6.4.1 <a href="#id-2ad8" id="id-2ad8"></a>

<figure><img src="../.gitbook/assets/image (1263).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg</a></p></figcaption></figure>

1. NIE rozpoznaje name[].
2. Preferuj ostatni parametr.

## Wstrzykiwanie JSON

### Duplikaty kluczy
```ini
obj = {"test": "user", "test": "admin"}
```
Front-end mo偶e uwierzy w pierwsze wystpienie, podczas gdy backend u偶ywa drugiego wystpienia klucza.

### Kolizja kluczy: Skracanie znak贸w i komentarze

Niekt贸re znaki nie bd poprawnie interpretowane przez frontend, ale backend je zinterpretuje i u偶yje tych kluczy, co mo偶e by przydatne do **obejcia pewnych ogranicze**:
```json
{"test": 1, "test\[raw \x0d byte]": 2}
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```
Zauwa偶, jak w tych przypadkach front end mo偶e myle, 偶e `test == 1`, a backend bdzie myla, 偶e `test == 2`.

Mo偶e to by r贸wnie偶 u偶yte do obejcia ogranicze wartoci, takich jak:
```json
{"role": "administrator\[raw \x0d byte]"}
{"role":"administrator\ud800"}
{"role": "administrator""}
{"role": "admini\strator"}
```
### **U偶ywanie skracania komentarzy**

{% code overflow="wrap" %}
```ini
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```
{% endcode %}

Tutaj u偶yjemy serializatora z ka偶dego parsera, aby zobaczy jego odpowiedni wynik.

Serializer 1 (np. biblioteka GoJay w GoLang) wygeneruje:

* `description = "Duplikat z komentarzami"`
* `test = 2`
* `extra = ""`

Serializer 2 (np. biblioteka JSON-iterator w Javie) wygeneruje:

* `description = "Duplikat z komentarzami"`
* `extra = "/*"`
* `extra2 = "*/"`
* `test = 1`

Alternatywnie, proste u偶ycie komentarzy mo偶e by r贸wnie偶 skuteczne:
```ini
obj = {"description": "Comment support", "test": 1, "extra": "a"/*, "test": 2, "extra2": "b"*/}
```
Biblioteka GSON w Javie:
```json
{"description":"Comment support","test":1,"extra":"a"}
```
Biblioteka simdjson w Ruby:
```json
{"description":"Comment support","test":2,"extra":"a","extra2":"b"}
```
### **Niesp贸jna Precedencja: Deserializacja vs. Serializacja**
```ini
obj = {"test": 1, "test": 2}

obj["test"] // 1
obj.toString() // {"test": 2}
```
### Float i Integer

Liczba
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```
mo偶e by dekodowane do wielu reprezentacji, w tym:
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9.999999999999999e95
1E+96
0
9223372036854775807
```
Kt贸re mog tworzy niesp贸jnoci

## Odniesienia

* [https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654](https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654)
* [https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution](https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution)
* [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)
* [https://bishopfox.com/blog/json-interoperability-vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
