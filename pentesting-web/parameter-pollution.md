# Parameter Pollution | JSON Injection

## Parameter Pollution

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## HTTP Parameter Pollution (HPP) Overview

HTTP Parameter Pollution (HPP) je tehnika gde napadaÄi manipuliÅ¡u HTTP parametrima kako bi promenili ponaÅ¡anje web aplikacije na nepredviÄ‘ene naÄine. Ova manipulacija se vrÅ¡i dodavanjem, modifikovanjem ili dupliciranjem HTTP parametara. Efekat ovih manipulacija nije direktno vidljiv korisniku, ali moÅ¾e znaÄajno promeniti funkcionalnost aplikacije na serverskoj strani, sa uoÄljivim uticajima na klijentskoj strani.

### Example of HTTP Parameter Pollution (HPP)

URL transakcije bankarske aplikacije:

* **Original URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000`

Umetanjem dodatnog `from` parametra:

* **Manipulated URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000&from=accountC`

Transakcija moÅ¾e biti pogreÅ¡no naplaÄ‡ena na `accountC` umesto na `accountA`, pokazujuÄ‡i potencijal HPP-a da manipuliÅ¡e transakcijama ili drugim funkcionalnostima kao Å¡to su resetovanje lozinke, podeÅ¡avanja 2FA ili zahtevi za API kljuÄem.

#### **Technology-Specific Parameter Parsing**

* NaÄin na koji se parametri analiziraju i prioritetizuju zavisi od osnovne web tehnologije, Å¡to utiÄe na to kako se HPP moÅ¾e iskoristiti.
* Alati poput [Wappalyzer](https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/) pomaÅ¾u u identifikaciji ovih tehnologija i njihovih ponaÅ¡anja prilikom analize.

### PHP and HPP Exploitation

**OTP Manipulation Case:**

* **Context:** Mehanizam prijavljivanja koji zahteva jednokratnu lozinku (OTP) je iskoriÅ¡Ä‡en.
* **Method:** Presretanjem zahteva za OTP koristeÄ‡i alate poput Burp Suite, napadaÄi su duplicirali `email` parametar u HTTP zahtevu.
* **Outcome:** OTP, namenjen za inicijalnu email adresu, umesto toga je poslat na drugu email adresu navedenu u manipulisanom zahtevu. Ova greÅ¡ka je omoguÄ‡ila neovlaÅ¡Ä‡en pristup zaobilaÅ¾enjem predviÄ‘ene sigurnosne mere.

Ovaj scenario istiÄe kritiÄan propust u backend-u aplikacije, koji je obradio prvi `email` parametar za generisanje OTP-a, ali je koristio poslednji za isporuku.

**API Key Manipulation Case:**

* **Scenario:** Aplikacija omoguÄ‡ava korisnicima da aÅ¾uriraju svoj API kljuÄ putem stranice za podeÅ¡avanje profila.
* **Attack Vector:** NapadaÄ otkriva da dodavanjem dodatnog `api_key` parametra u POST zahtev moÅ¾e manipulisati ishodom funkcije aÅ¾uriranja API kljuÄa.
* **Technique:** KoristeÄ‡i alat poput Burp Suite, napadaÄ kreira zahtev koji ukljuÄuje dva `api_key` parametra: jedan legitimni i jedan maliciozni. Server, obraÄ‘ujuÄ‡i samo poslednju pojavu, aÅ¾urira API kljuÄ na vrednost koju je naveo napadaÄ.
* **Result:** NapadaÄ dobija kontrolu nad funkcionalnoÅ¡Ä‡u API-ja Å¾rtve, potencijalno pristupajuÄ‡i ili modifikujuÄ‡i privatne podatke neovlaÅ¡Ä‡eno.

Ovaj primer dodatno naglaÅ¡ava potrebu za sigurnim rukovanjem parametrima, posebno u funkcijama koje su kritiÄne kao Å¡to je upravljanje API kljuÄem.

### Parameter Parsing: Flask vs. PHP

NaÄin na koji web tehnologije obraÄ‘uju duple HTTP parametre varira, utiÄuÄ‡i na njihovu podloÅ¾nost HPP napadima:

* **Flask:** Usvaja prvu vrednost parametra koja se susreÄ‡e, kao Å¡to je `a=1` u upitu `a=1&a=2`, prioritetizujuÄ‡i inicijalnu instancu nad kasnijim duplikatima.
* **PHP (na Apache HTTP Server-u):** Nasuprot tome, prioritetizuje poslednju vrednost parametra, birajuÄ‡i `a=2` u datom primeru. Ovo ponaÅ¡anje moÅ¾e nenamerno olakÅ¡ati HPP eksploate tako Å¡to poÅ¡tuje manipulisan parametar napadaÄa umesto originalnog.

## Parameter pollution by technology

There results were taken from [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)

### PHP 8.3.11 AND Apache 2.4.62 <a href="#id-9523" id="id-9523"></a>

<figure><img src="../.gitbook/assets/image (1255).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg</a></p></figcaption></figure>

1. IgnoriÅ¡i sve nakon %00 u imenu parametra.
2. Rukuj sa name\[] kao nizom.
3. \_GET ne znaÄi GET metodu.
4. Preferiraj poslednji parametar.

### Ruby 3.3.5 and WEBrick 1.8.2

<figure><img src="../.gitbook/assets/image (1257).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg</a></p></figcaption></figure>

1. Koristi & i ; delimitere za razdvajanje parametara.
2. Ne prepoznaje name\[].
3. Preferiraj prvi parametar.

### Spring MVC 6.0.23 AND Apache Tomcat 10.1.30 <a href="#dd68" id="dd68"></a>

<figure><img src="../.gitbook/assets/image (1258).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg</a></p></figcaption></figure>

1. POST RequestMapping == PostMapping & GET RequestMapping == GetMapping.
2. POST RequestMapping & PostMapping prepoznaju name[].
3. Preferiraj name ako name i name[] postoje.
4. Konkateniraj parametre npr. first,last.
5. POST RequestMapping & PostMapping prepoznaju upitni parametar sa Content-Type.

### **NodeJS** 20.17.0 **AND** Express 4.21.0 <a href="#id-6d72" id="id-6d72"></a>

<figure><img src="../.gitbook/assets/image (1259).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg</a></p></figcaption></figure>

1. Prepoznaje name[].
2. Konkateniraj parametre npr. first,last.

### GO 1.22.7 <a href="#id-63dc" id="id-63dc"></a>

<figure><img src="../.gitbook/assets/image (1260).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg</a></p></figcaption></figure>

1. NE prepoznaje name[].
2. Preferiraj prvi parametar.

### Python 3.12.6 AND Werkzeug 3.0.4 AND Flask 3.0.3 <a href="#b853" id="b853"></a>

<figure><img src="../.gitbook/assets/image (1261).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg</a></p></figcaption></figure>

1. NE prepoznaje name[].
2. Preferiraj prvi parametar.

### Python 3.12.6 AND Django 4.2.15 <a href="#id-8079" id="id-8079"></a>

<figure><img src="../.gitbook/assets/image (1262).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg</a></p></figcaption></figure>

1. NE prepoznaje name[].
2. Preferiraj poslednji parametar.

### Python 3.12.6 AND Tornado 6.4.1 <a href="#id-2ad8" id="id-2ad8"></a>

<figure><img src="../.gitbook/assets/image (1263).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg</a></p></figcaption></figure>

1. NE prepoznaje name[].
2. Preferiraj poslednji parametar.

## JSON Injection

### Duplicate keys
```ini
obj = {"test": "user", "test": "admin"}
```
Frontend moÅ¾e verovati prvoj pojavi, dok backend koristi drugu pojavu kljuÄa.

### Sudar kljuÄeva: SkraÄ‡ivanje karaktera i komentari

OdreÄ‘eni karakteri neÄ‡e biti ispravno interpretirani od strane frontenda, ali backend Ä‡e ih interpretirati i koristiti te kljuÄeve, Å¡to moÅ¾e biti korisno za **obiÄ‡i odreÄ‘ena ograniÄenja**:
```json
{"test": 1, "test\[raw \x0d byte]": 2}
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```
Napomena kako u ovim sluÄajevima frontend moÅ¾e misliti da je `test == 1`, dok backend moÅ¾e misliti da je `test == 2`.

Ovo se takoÄ‘e moÅ¾e koristiti za zaobilaÅ¾enje ograniÄenja vrednosti kao Å¡to su:
```json
{"role": "administrator\[raw \x0d byte]"}
{"role":"administrator\ud800"}
{"role": "administrator""}
{"role": "admini\strator"}
```
### **KoriÅ¡Ä‡enje skraÄ‡ivanja komentara**

{% code overflow="wrap" %}
```ini
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```
{% endcode %}

Ovde Ä‡emo koristiti serializer iz svakog parsera da bismo videli njegov odgovarajuÄ‡i izlaz.

Serializer 1 (npr., GoLangova GoJay biblioteka) Ä‡e proizvesti:

* `description = "Duplikat sa komentarima"`
* `test = 2`
* `extra = ""`

Serializer 2 (npr., Java-ova JSON-iterator biblioteka) Ä‡e proizvesti:

* `description = "Duplikat sa komentarima"`
* `extra = "/*"`
* `extra2 = "*/"`
* `test = 1`

Alternativno, jednostavna upotreba komentara moÅ¾e takoÄ‘e biti efikasna:
```ini
obj = {"description": "Comment support", "test": 1, "extra": "a"/*, "test": 2, "extra2": "b"*/}
```
Java-ova GSON biblioteka:
```json
{"description":"Comment support","test":1,"extra":"a"}
```
Rubyjeva simdjson biblioteka:
```json
{"description":"Comment support","test":2,"extra":"a","extra2":"b"}
```
### **Nepodudarnost Prioriteta: Deserijalizacija naspram Serijalizacije**
```ini
obj = {"test": 1, "test": 2}

obj["test"] // 1
obj.toString() // {"test": 2}
```
### Float and Integer

Broj
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```
moÅ¾e se dekodirati u viÅ¡e reprezentacija, ukljuÄujuÄ‡i:
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9.999999999999999e95
1E+96
0
9223372036854775807
```
Koje bi mogle stvoriti nesuglasice

## Reference

* [https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654](https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654)
* [https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution](https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution)
* [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)
* [https://bishopfox.com/blog/json-interoperability-vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
