# Parameter Pollution | JSON Injection

## Parameter Pollution

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## HTTP Parameter Pollution (HPP) Overview

HTTP Parameter Pollution (HPP) es una t칠cnica donde los atacantes manipulan par치metros HTTP para cambiar el comportamiento de una aplicaci칩n web de maneras no intencionadas. Esta manipulaci칩n se realiza a침adiendo, modificando o duplicando par치metros HTTP. El efecto de estas manipulaciones no es directamente visible para el usuario, pero puede alterar significativamente la funcionalidad de la aplicaci칩n en el lado del servidor, con impactos observables en el lado del cliente.

### Example of HTTP Parameter Pollution (HPP)

Una URL de transacci칩n de una aplicaci칩n bancaria:

* **Original URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000`

Al insertar un par치metro `from` adicional:

* **Manipulated URL:** `https://www.victim.com/send/?from=accountA&to=accountB&amount=10000&from=accountC`

La transacci칩n puede ser incorrectamente cargada a `accountC` en lugar de `accountA`, mostrando el potencial de HPP para manipular transacciones u otras funcionalidades como restablecimientos de contrase침a, configuraciones de 2FA o solicitudes de claves API.

#### **Technology-Specific Parameter Parsing**

* La forma en que se analizan y priorizan los par치metros depende de la tecnolog칤a web subyacente, afectando c칩mo se puede explotar HPP.
* Herramientas como [Wappalyzer](https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/) ayudan a identificar estas tecnolog칤as y sus comportamientos de an치lisis.

### PHP and HPP Exploitation

**OTP Manipulation Case:**

* **Context:** Se explot칩 un mecanismo de inicio de sesi칩n que requer칤a una Contrase침a de Un Solo Uso (OTP).
* **Method:** Al interceptar la solicitud de OTP utilizando herramientas como Burp Suite, los atacantes duplicaron el par치metro `email` en la solicitud HTTP.
* **Outcome:** El OTP, destinado al correo electr칩nico inicial, fue enviado en su lugar a la segunda direcci칩n de correo electr칩nico especificada en la solicitud manipulada. Este defecto permiti칩 el acceso no autorizado al eludir la medida de seguridad prevista.

Este escenario destaca una falla cr칤tica en el backend de la aplicaci칩n, que proces칩 el primer par치metro `email` para la generaci칩n de OTP, pero utiliz칩 el 칰ltimo para la entrega.

**API Key Manipulation Case:**

* **Scenario:** Una aplicaci칩n permite a los usuarios actualizar su clave API a trav칠s de una p치gina de configuraci칩n de perfil.
* **Attack Vector:** Un atacante descubre que al a침adir un par치metro `api_key` adicional a la solicitud POST, puede manipular el resultado de la funci칩n de actualizaci칩n de la clave API.
* **Technique:** Utilizando una herramienta como Burp Suite, el atacante elabora una solicitud que incluye dos par치metros `api_key`: uno leg칤timo y uno malicioso. El servidor, procesando solo la 칰ltima ocurrencia, actualiza la clave API al valor proporcionado por el atacante.
* **Result:** El atacante obtiene control sobre la funcionalidad API de la v칤ctima, potencialmente accediendo o modificando datos privados sin autorizaci칩n.

Este ejemplo subraya a칰n m치s la necesidad de un manejo seguro de par치metros, especialmente en caracter칤sticas tan cr칤ticas como la gesti칩n de claves API.

### Parameter Parsing: Flask vs. PHP

La forma en que las tecnolog칤as web manejan par치metros HTTP duplicados var칤a, afectando su susceptibilidad a ataques HPP:

* **Flask:** Adopta el primer valor de par치metro encontrado, como `a=1` en una cadena de consulta `a=1&a=2`, priorizando la instancia inicial sobre los duplicados posteriores.
* **PHP (en Apache HTTP Server):** Por el contrario, prioriza el 칰ltimo valor de par치metro, optando por `a=2` en el ejemplo dado. Este comportamiento puede facilitar inadvertidamente los exploits HPP al honrar el par치metro manipulado del atacante sobre el original.

## Parameter pollution by technology

There results were taken from [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)

### PHP 8.3.11 AND Apache 2.4.62 <a href="#id-9523" id="id-9523"></a>

<figure><img src="../.gitbook/assets/image (1255).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*l_Pf2JNCYhmfAvfk7UTEbQ.jpeg</a></p></figcaption></figure>

1. Ignorar cualquier cosa despu칠s de %00 en el nombre del par치metro.
2. Manejar name\[] como array.
3. \_GET no significa m칠todo GET.
4. Preferir el 칰ltimo par치metro.

### Ruby 3.3.5 and WEBrick 1.8.2

<figure><img src="../.gitbook/assets/image (1257).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*kKxtZ8qEmgTIMS81py5hhg.jpeg</a></p></figcaption></figure>

1. Utiliza los delimitadores & y ; para dividir par치metros.
2. No reconoce name[].
3. Preferir el primer par치metro.

### Spring MVC 6.0.23 AND Apache Tomcat 10.1.30 <a href="#dd68" id="dd68"></a>

<figure><img src="../.gitbook/assets/image (1258).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*llG22MF1gPTYZYFVCmCiVw.jpeg</a></p></figcaption></figure>

1. POST RequestMapping == PostMapping & GET RequestMapping == GetMapping.
2. POST RequestMapping & PostMapping reconocen name[].
3. Preferir name si name Y name[] existen.
4. Concatenar par치metros e.g. first,last.
5. POST RequestMapping & PostMapping reconocen par치metros de consulta con Content-Type.

### **NodeJS** 20.17.0 **AND** Express 4.21.0 <a href="#id-6d72" id="id-6d72"></a>

<figure><img src="../.gitbook/assets/image (1259).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JzNkLOSW7orcHXswtMHGMA.jpeg</a></p></figcaption></figure>

1. Reconoce name[].
2. Concatenar par치metros e.g. first,last.

### GO 1.22.7 <a href="#id-63dc" id="id-63dc"></a>

<figure><img src="../.gitbook/assets/image (1260).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*NVvN1N8sL4g_Gi796FzlZA.jpeg</a></p></figcaption></figure>

1. NO reconoce name[].
2. Preferir el primer par치metro.

### Python 3.12.6 AND Werkzeug 3.0.4 AND Flask 3.0.3 <a href="#b853" id="b853"></a>

<figure><img src="../.gitbook/assets/image (1261).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*Se5467PFFjIlmT3O7KNlWQ.jpeg</a></p></figcaption></figure>

1. NO reconoce name[].
2. Preferir el primer par치metro.

### Python 3.12.6 AND Django 4.2.15 <a href="#id-8079" id="id-8079"></a>

<figure><img src="../.gitbook/assets/image (1262).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*rf38VXut5YhAx0ZhUzgT8Q.jpeg</a></p></figcaption></figure>

1. NO reconoce name[].
2. Preferir el 칰ltimo par치metro.

### Python 3.12.6 AND Tornado 6.4.1 <a href="#id-2ad8" id="id-2ad8"></a>

<figure><img src="../.gitbook/assets/image (1263).png" alt=""><figcaption><p><a href="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg">https://miro.medium.com/v2/resize:fit:1100/format:webp/1*obCn7xahDc296JZccXM2qQ.jpeg</a></p></figcaption></figure>

1. NO reconoce name[].
2. Preferir el 칰ltimo par치metro.

## JSON Injection

### Duplicate keys
```ini
obj = {"test": "user", "test": "admin"}
```
El front-end podr칤a creer la primera ocurrencia mientras que el backend utiliza la segunda ocurrencia de la clave.

### Colisi칩n de Claves: Truncamiento de Caracteres y Comentarios

Ciertos caracteres no ser치n interpretados correctamente por el front-end, pero el backend los interpretar치 y utilizar치 esas claves, esto podr칤a ser 칰til para **eludir ciertas restricciones**:
```json
{"test": 1, "test\[raw \x0d byte]": 2}
{"test": 1, "test\ud800": 2}
{"test": 1, "test"": 2}
{"test": 1, "te\st": 2}
```
Nota c칩mo en estos casos el front end podr칤a pensar que `test == 1` y el backend pensar치 que `test == 2`.

Esto tambi칠n se puede usar para eludir restricciones de valor como:
```json
{"role": "administrator\[raw \x0d byte]"}
{"role":"administrator\ud800"}
{"role": "administrator""}
{"role": "admini\strator"}
```
### **Uso de la Truncaci칩n de Comentarios**

{% code overflow="wrap" %}
```ini
obj = {"description": "Duplicate with comments", "test": 2, "extra": /*, "test": 1, "extra2": */}
```
{% endcode %}

Aqu칤 utilizaremos el serializador de cada analizador para ver su respectiva salida.

Serializer 1 (por ejemplo, la biblioteca GoJay de GoLang) producir치:

* `description = "Duplicado con comentarios"`
* `test = 2`
* `extra = ""`

Serializer 2 (por ejemplo, la biblioteca JSON-iterator de Java) producir치:

* `description = "Duplicado con comentarios"`
* `extra = "/*"`
* `extra2 = "*/"`
* `test = 1`

Alternativamente, el uso directo de comentarios tambi칠n puede ser efectivo:
```ini
obj = {"description": "Comment support", "test": 1, "extra": "a"/*, "test": 2, "extra2": "b"*/}
```
La biblioteca GSON de Java:
```json
{"description":"Comment support","test":1,"extra":"a"}
```
La biblioteca simdjson de Ruby:
```json
{"description":"Comment support","test":2,"extra":"a","extra2":"b"}
```
### **Precedencia Inconsistente: Deserializaci칩n vs. Serializaci칩n**
```ini
obj = {"test": 1, "test": 2}

obj["test"] // 1
obj.toString() // {"test": 2}
```
### Float and Integer

El n칰mero
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
```
puede ser decodificado a m칰ltiples representaciones, incluyendo:
```undefined
999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999
9.999999999999999e95
1E+96
0
9223372036854775807
```
Which might create inconsistencias

## References

* [https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654](https://medium.com/@shahjerry33/http-parameter-pollution-its-contaminated-85edc0805654)
* [https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution](https://github.com/google/google-ctf/tree/master/2023/web-under-construction/solution)
* [https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89](https://medium.com/@0xAwali/http-parameter-pollution-in-2024-32ec1b810f89)
* [https://bishopfox.com/blog/json-interoperability-vulnerabilities](https://bishopfox.com/blog/json-interoperability-vulnerabilities)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
