{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Overview

**Security Assertion Markup Language (SAML)** permite que los proveedores de identidad (IdP) se utilicen para enviar credenciales de autorizaci贸n a los proveedores de servicios (SP), facilitando el inicio de sesi贸n 煤nico (SSO). Este enfoque simplifica la gesti贸n de m煤ltiples inicios de sesi贸n al permitir que un solo conjunto de credenciales se utilice en m煤ltiples sitios web. Utiliza XML para la comunicaci贸n estandarizada entre IdPs y SPs, vinculando la autenticaci贸n de la identidad del usuario con la autorizaci贸n del servicio.

## Comparison between SAML and OAuth

- **SAML** est谩 dise帽ado para proporcionar a las empresas un mayor control sobre la seguridad del inicio de sesi贸n SSO.
- **OAuth** est谩 dise帽ado para ser m谩s amigable con dispositivos m贸viles, utiliza JSON y es un esfuerzo colaborativo de empresas como Google y Twitter.

# SAML Authentication Flow

**For further details check the full post from [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. This is a summary:

El proceso de autenticaci贸n SAML implica varios pasos, como se ilustra en el esquema:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Intento de Acceso a Recurso**: El usuario intenta acceder a un recurso protegido.
2. **Generaci贸n de Solicitud SAML**: El SP no reconoce al usuario y genera una Solicitud SAML.
3. **Redirecci贸n a IdP**: El usuario es redirigido al IdP, con la Solicitud SAML pasando a trav茅s del navegador del usuario.
4. **IdP Recibe la Solicitud**: El IdP recibe la Solicitud SAML.
5. **Autenticaci贸n en IdP**: El IdP autentica al usuario.
6. **Validaci贸n del Usuario**: El IdP valida la legitimidad del usuario para acceder al recurso solicitado.
7. **Creaci贸n de Respuesta SAML**: El IdP genera una Respuesta SAML que contiene las afirmaciones necesarias.
8. **Redirecci贸n a la URL ACS del SP**: El usuario es redirigido a la URL del Servicio Consumidor de Afirmaciones (ACS) del SP.
9. **Validaci贸n de la Respuesta SAML**: El ACS valida la Respuesta SAML.
10. **Acceso al Recurso Concedido**: Se concede acceso al recurso inicialmente solicitado.

# SAML Request Example

Considere el escenario en el que un usuario solicita acceso a un recurso seguro en [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). El SP identifica la falta de autenticaci贸n y genera una Solicitud SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
La solicitud SAML en bruto se ve as铆:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Elementos clave de esta solicitud incluyen:
- **AssertionConsumerServiceURL**: Especifica d贸nde el IdP debe enviar la SAML Response despu茅s de la autenticaci贸n.
- **Destination**: La direcci贸n del IdP a la que se env铆a la solicitud.
- **ProtocolBinding**: Define el m茅todo de transmisi贸n de los mensajes del protocolo SAML.
- **saml:Issuer**: Identifica la entidad que inici贸 la solicitud.

Despu茅s de la generaci贸n de la SAML Request, el SP responde con un **302 redirect**, dirigiendo el navegador al IdP con la SAML Request codificada en el encabezado **Location** de la respuesta HTTP. El par谩metro **RelayState** mantiene la informaci贸n de estado a lo largo de la transacci贸n, asegurando que el SP reconozca la solicitud de recurso inicial al recibir la SAML Response. El par谩metro **SAMLRequest** es una versi贸n comprimida y codificada del fragmento XML en bruto, utilizando compresi贸n Deflate y codificaci贸n base64.


# Ejemplo de SAML Response

Puedes encontrar una [respuesta SAML completa aqu铆](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Los componentes clave de la respuesta incluyen:

- **ds:Signature**: Esta secci贸n, una firma XML, asegura la integridad y autenticidad del emisor de la afirmaci贸n. La SAML response en el ejemplo contiene dos elementos `ds:Signature`, uno para el mensaje y el otro para la afirmaci贸n.
- **saml:Assertion**: Esta parte contiene informaci贸n sobre la identidad del usuario y posiblemente otros atributos.
- **saml:Subject**: Especifica el sujeto principal de todas las declaraciones en la afirmaci贸n.
- **saml:StatusCode**: Representa el estado de la operaci贸n en respuesta a la solicitud correspondiente.
- **saml:Conditions**: Detalla condiciones como el tiempo de validez de la Assertion y el Service Provider especificado.
- **saml:AuthnStatement**: Confirma que el IdP autentic贸 al sujeto de la Assertion.
- **saml:AttributeStatement**: Contiene atributos que describen al sujeto de la Assertion.

Despu茅s de la SAML Response, el proceso incluye un 302 redirect desde el IdP. Esto lleva a una solicitud POST a la URL del Assertion Consumer Service (ACS) del Service Provider. La solicitud POST incluye los par谩metros `RelayState` y `SAMLResponse`. El ACS es responsable de procesar y validar la SAML Response.

Despu茅s de que se recibe la solicitud POST y se valida la SAML Response, se concede acceso al recurso protegido solicitado inicialmente por el usuario. Esto se ilustra con una solicitud `GET` al endpoint `/secure/` y una respuesta `200 OK`, indicando acceso exitoso al recurso.


# Firmas XML

Las firmas XML son vers谩tiles, capaces de firmar un 谩rbol XML completo o elementos espec铆ficos dentro de 茅l. Pueden aplicarse a cualquier objeto XML, no solo a elementos de respuesta. A continuaci贸n se presentan los tipos clave de firmas XML:

### Estructura b谩sica de la firma XML
Una firma XML consiste en elementos esenciales como se muestra:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Cada `Reference` elemento significa un recurso espec铆fico que est谩 siendo firmado, identificable por el atributo URI.

### Tipos de Firmas XML

1. **Firma Envolvente**: Este tipo de firma es un descendiente del recurso que firma, lo que significa que la firma est谩 contenida dentro de la misma estructura XML que el contenido firmado.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

En una firma envolvente, el elemento `ds:Transform` especifica que est谩 envuelta a trav茅s del algoritmo `enveloped-signature`.

2. **Firma Envolvente**: A diferencia de las firmas envolventes, las firmas envolventes envuelven el recurso que se est谩 firmando.

Ejemplo:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Firma Desprendida**: Este tipo es independiente del contenido que firma. La firma y el contenido existen de manera independiente, pero se mantiene un enlace entre ambos.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

En conclusi贸n, las Firmas XML proporcionan formas flexibles de asegurar documentos XML, con cada tipo sirviendo a diferentes necesidades estructurales y de seguridad.


## Referencias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
