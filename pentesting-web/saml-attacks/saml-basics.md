{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Pregled

**Security Assertion Markup Language (SAML)** omoguƒáava kori≈°ƒáenje provajdera identiteta (IdP) za slanje autorizacionih kredencijala provajderima usluga (SP), olak≈°avajuƒái jedinstveno prijavljivanje (SSO). Ovaj pristup pojednostavljuje upravljanje vi≈°estrukim prijavama omoguƒáavajuƒái kori≈°ƒáenje jednog skupa kredencijala na vi≈°e veb sajtova. Koristi XML za standardizovanu komunikaciju izmeƒëu IdP-a i SP-a, povezujuƒái autentifikaciju identiteta korisnika sa autorizacijom usluga.

## Uporedba izmeƒëu SAML i OAuth

- **SAML** je prilagoƒëen za pru≈æanje preduzeƒáima veƒáe kontrole nad bezbedno≈°ƒáu SSO prijavljivanja.
- **OAuth** je dizajniran da bude vi≈°e prilagoƒëen mobilnim ureƒëajima, koristi JSON i rezultat je saradnje kompanija kao ≈°to su Google i Twitter.

# SAML Tok Autentifikacije

**Za vi≈°e detalja pogledajte ceo post sa [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Ovo je sa≈æetak:

Proces SAML autentifikacije ukljuƒçuje nekoliko koraka, kako je prikazano u ≈°emi:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Poku≈°aj pristupa resursu**: Korisnik poku≈°ava da pristupi za≈°tiƒáenom resursu.
2. **Generisanje SAML Zahteva**: SP ne prepoznaje korisnika i generi≈°e SAML Zahtev.
3. **Preusmeravanje na IdP**: Korisnik se preusmerava na IdP, pri ƒçemu SAML Zahtev prolazi kroz korisnikov pretra≈æivaƒç.
4. **IdP prima zahtev**: IdP prima SAML Zahtev.
5. **Autentifikacija na IdP**: IdP autentifikuje korisnika.
6. **Validacija korisnika**: IdP validira legitimnost korisnika za pristup tra≈æenom resursu.
7. **Kreiranje SAML Odgovora**: IdP generi≈°e SAML Odgovor koji sadr≈æi potrebne tvrdnje.
8. **Preusmeravanje na SP-ovu ACS URL**: Korisnik se preusmerava na SP-ovu URL adresu za uslugu potro≈°nje tvrdnji (ACS).
9. **Validacija SAML Odgovora**: ACS validira SAML Odgovor.
10. **Odobren pristup resursu**: Pristup inicijalno tra≈æenom resursu je odobren.

# SAML Primer Zahteva

Razmotrite scenario u kojem korisnik tra≈æi pristup sigurnom resursu na [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). SP identifikuje nedostatak autentifikacije i generi≈°e SAML Zahtev:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Raw SAML zahtev izgleda ovako:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: Odreƒëuje gde IdP treba da po≈°alje SAML odgovor nakon autentifikacije.
- **Destination**: Adresa IdP-a na koju se zahtev ≈°alje.
- **ProtocolBinding**: Defini≈°e metodu prenosa SAML protokol poruka.
- **saml:Issuer**: Identifikuje entitet koji je inicirao zahtev.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Ovaj deo, XML potpis, osigurava integritet i autentiƒçnost izdavaoca asertije. SAML odgovor u primeru sadr≈æi dva `ds:Signature` elementa, jedan za poruku i drugi za asertiju.
- **saml:Assertion**: Ovaj deo sadr≈æi informacije o identitetu korisnika i moguƒáe druge atribute.
- **saml:Subject**: Odreƒëuje glavnog subjekta svih izjava u asertiji.
- **saml:StatusCode**: Predstavlja status operacije kao odgovor na odgovarajuƒái zahtev.
- **saml:Conditions**: Detalji o uslovima kao ≈°to su vremenski okvir va≈æenja asertije i odreƒëeni provajder usluga.
- **saml:AuthnStatement**: Potvrƒëuje da je IdP autentifikovao subjekat asertije.
- **saml:AttributeStatement**: Sadr≈æi atribute koji opisuju subjekat asertije.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Signatures are versatile, capable of signing an entire XML tree or specific elements within it. They can be applied to any XML Object, not just Response elements. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Each `Reference` element signifies a specific resource being signed, identifiable by the URI attribute.

### Types of XML Signatures

1. **Enveloped Signature**: Ova vrsta potpisa je potomak resursa koji potpisuje, ≈°to znaƒçi da je potpis sadr≈æan unutar iste XML strukture kao i potpisani sadr≈æaj.

Example:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

In an enveloped signature, the `ds:Transform` element specifies that it's enveloped through the `enveloped-signature` algorithm.

2. **Enveloping Signature**: U poreƒëenju sa potpisima unutar, potpisivanje resursa obavija resurs koji se potpisuje.

Example:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Detached Signature**: Ova vrsta je odvojena od sadr≈æaja koji potpisuje. Potpis i sadr≈æaj postoje nezavisno, ali se odr≈æava veza izmeƒëu njih.

Example:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

In conclusion, XML Signatures provide flexible ways to secure XML documents, with each type serving different structural and security needs.

## References
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
