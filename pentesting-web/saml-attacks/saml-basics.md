{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Overview

**Security Assertion Markup Language (SAML)** permet aux fournisseurs d'identit√© (IdP) d'√™tre utilis√©s pour envoyer des informations d'autorisation aux fournisseurs de services (SP), facilitant ainsi l'authentification unique (SSO). Cette approche simplifie la gestion de plusieurs connexions en permettant d'utiliser un seul ensemble d'identifiants sur plusieurs sites web. Elle utilise XML pour une communication standardis√©e entre les IdP et les SP, liant l'authentification de l'identit√© de l'utilisateur √† l'autorisation de service.

## Comparison between SAML and OAuth

- **SAML** est con√ßu pour offrir aux entreprises un meilleur contr√¥le sur la s√©curit√© des connexions SSO.
- **OAuth** est con√ßu pour √™tre plus adapt√© aux mobiles, utilise JSON et est un effort collaboratif d'entreprises comme Google et Twitter.

# SAML Authentication Flow

**Pour plus de d√©tails, consultez le post complet de [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Voici un r√©sum√© :

Le processus d'authentification SAML implique plusieurs √©tapes, comme illustr√© dans le sch√©ma :

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Tentative d'acc√®s √† la ressource** : L'utilisateur essaie d'acc√©der √† une ressource prot√©g√©e.
2. **G√©n√©ration de la demande SAML** : Le SP ne reconna√Æt pas l'utilisateur et g√©n√®re une demande SAML.
3. **Redirection vers l'IdP** : L'utilisateur est redirig√© vers l'IdP, la demande SAML passant par le navigateur de l'utilisateur.
4. **L'IdP re√ßoit la demande** : L'IdP re√ßoit la demande SAML.
5. **Authentification √† l'IdP** : L'IdP authentifie l'utilisateur.
6. **Validation de l'utilisateur** : L'IdP valide la l√©gitimit√© de l'utilisateur √† acc√©der √† la ressource demand√©e.
7. **Cr√©ation de la r√©ponse SAML** : L'IdP g√©n√®re une r√©ponse SAML contenant les assertions n√©cessaires.
8. **Redirection vers l'URL ACS du SP** : L'utilisateur est redirig√© vers l'URL du Service Consommateur d'Assertions (ACS) du SP.
9. **Validation de la r√©ponse SAML** : L'ACS valide la r√©ponse SAML.
10. **Acc√®s √† la ressource accord√©** : L'acc√®s √† la ressource initialement demand√©e est accord√©.

# SAML Request Example

Consid√©rons le sc√©nario o√π un utilisateur demande l'acc√®s √† une ressource s√©curis√©e √† [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). Le SP identifie l'absence d'authentification et g√©n√®re une demande SAML :
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
La requ√™te SAML brute ressemble √† ceci :
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: Sp√©cifie o√π l'IdP doit envoyer la r√©ponse SAML apr√®s l'authentification.
- **Destination**: L'adresse de l'IdP √† laquelle la demande est envoy√©e.
- **ProtocolBinding**: D√©finit la m√©thode de transmission des messages du protocole SAML.
- **saml:Issuer**: Identifie l'entit√© qui a initi√© la demande.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Cette section, une signature XML, garantit l'int√©grit√© et l'authenticit√© de l'√©metteur de l'assertion. La r√©ponse SAML dans l'exemple contient deux √©l√©ments `ds:Signature`, un pour le message et l'autre pour l'assertion.
- **saml:Assertion**: Cette partie contient des informations sur l'identit√© de l'utilisateur et √©ventuellement d'autres attributs.
- **saml:Subject**: Elle sp√©cifie le sujet principal de toutes les d√©clarations dans l'assertion.
- **saml:StatusCode**: Repr√©sente le statut de l'op√©ration en r√©ponse √† la demande correspondante.
- **saml:Conditions**: D√©tails des conditions comme la dur√©e de validit√© de l'assertion et le fournisseur de services sp√©cifi√©.
- **saml:AuthnStatement**: Confirme que l'IdP a authentifi√© le sujet de l'assertion.
- **saml:AttributeStatement**: Contient des attributs d√©crivant le sujet de l'assertion.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Signatures are versatile, capable of signing an entire XML tree or specific elements within it. They can be applied to any XML Object, not just Response elements. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Chaque √©l√©ment `Reference` signifie une ressource sp√©cifique sign√©e, identifiable par l'attribut URI.

### Types de signatures XML

1. **Signature envelopp√©e** : Ce type de signature est un descendant de la ressource qu'il signe, ce qui signifie que la signature est contenue dans la m√™me structure XML que le contenu sign√©.

Exemple :
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

Dans une signature envelopp√©e, l'√©l√©ment `ds:Transform` sp√©cifie qu'il est envelopp√© par l'algorithme `enveloped-signature`.

2. **Signature enveloppante** : Contrairement aux signatures envelopp√©es, les signatures enveloppantes enveloppent la ressource √† signer.

Exemple :
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Signature d√©tach√©e** : Ce type est s√©par√© du contenu qu'il signe. La signature et le contenu existent ind√©pendamment, mais un lien entre les deux est maintenu.

Exemple :
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

En conclusion, les signatures XML offrent des moyens flexibles de s√©curiser les documents XML, chaque type r√©pondant √† diff√©rents besoins structurels et de s√©curit√©.


## R√©f√©rences
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
