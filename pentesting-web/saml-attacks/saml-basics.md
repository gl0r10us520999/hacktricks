{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# Vis√£o Geral do SAML

**Security Assertion Markup Language (SAML)** permite que provedores de identidade (IdP) sejam utilizados para enviar credenciais de autoriza√ß√£o para provedores de servi√ßo (SP), facilitando o single sign-on (SSO). Essa abordagem simplifica a gest√£o de m√∫ltiplos logins ao permitir que um √∫nico conjunto de credenciais seja usado em v√°rios sites. Ela utiliza XML para comunica√ß√£o padronizada entre IdPs e SPs, vinculando a autentica√ß√£o da identidade do usu√°rio com a autoriza√ß√£o do servi√ßo.

## Compara√ß√£o entre SAML e OAuth

- **SAML** √© voltado para fornecer √†s empresas maior controle sobre a seguran√ßa do login SSO.
- **OAuth** √© projetado para ser mais amig√°vel para dispositivos m√≥veis, usa JSON e √© um esfor√ßo colaborativo de empresas como Google e Twitter.

# Fluxo de Autentica√ß√£o SAML

**Para mais detalhes, consulte o post completo em [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Este √© um resumo:

O processo de autentica√ß√£o SAML envolve v√°rias etapas, conforme ilustrado no esquema:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Tentativa de Acesso ao Recurso**: O usu√°rio tenta acessar um recurso protegido.
2. **Gera√ß√£o da Solicita√ß√£o SAML**: O SP n√£o reconhece o usu√°rio e gera uma Solicita√ß√£o SAML.
3. **Redirecionamento para o IdP**: O usu√°rio √© redirecionado para o IdP, com a Solicita√ß√£o SAML passando pelo navegador do usu√°rio.
4. **IdP Recebe a Solicita√ß√£o**: O IdP recebe a Solicita√ß√£o SAML.
5. **Autentica√ß√£o no IdP**: O IdP autentica o usu√°rio.
6. **Valida√ß√£o do Usu√°rio**: O IdP valida a legitimidade do usu√°rio para acessar o recurso solicitado.
7. **Cria√ß√£o da Resposta SAML**: O IdP gera uma Resposta SAML contendo as afirma√ß√µes necess√°rias.
8. **Redirecionamento para a URL ACS do SP**: O usu√°rio √© redirecionado para a URL do Servi√ßo Consumidor de Afirma√ß√µes (ACS) do SP.
9. **Valida√ß√£o da Resposta SAML**: O ACS valida a Resposta SAML.
10. **Acesso ao Recurso Concedido**: O acesso ao recurso inicialmente solicitado √© concedido.

# Exemplo de Solicita√ß√£o SAML

Considere o cen√°rio em que um usu√°rio solicita acesso a um recurso seguro em [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). O SP identifica a falta de autentica√ß√£o e gera uma Solicita√ß√£o SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
A solicita√ß√£o SAML bruta se parece com isto:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: Especifica onde o IdP deve enviar a SAML Response ap√≥s a autentica√ß√£o.
- **Destination**: O endere√ßo do IdP para o qual a solicita√ß√£o √© enviada.
- **ProtocolBinding**: Define o m√©todo de transmiss√£o das mensagens do protocolo SAML.
- **saml:Issuer**: Identifica a entidade que iniciou a solicita√ß√£o.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Esta se√ß√£o, uma Assinatura XML, garante a integridade e autenticidade do emissor da asser√ß√£o. A SAML response no exemplo cont√©m dois elementos `ds:Signature`, um para a mensagem e o outro para a asser√ß√£o.
- **saml:Assertion**: Esta parte cont√©m informa√ß√µes sobre a identidade do usu√°rio e possivelmente outros atributos.
- **saml:Subject**: Especifica o sujeito principal de todas as declara√ß√µes na asser√ß√£o.
- **saml:StatusCode**: Representa o status da opera√ß√£o em resposta √† solicita√ß√£o correspondente.
- **saml:Conditions**: Detalha condi√ß√µes como o tempo de validade da Asser√ß√£o e o Provedor de Servi√ßo especificado.
- **saml:AuthnStatement**: Confirma que o IdP autenticou o sujeito da Asser√ß√£o.
- **saml:AttributeStatement**: Cont√©m atributos que descrevem o sujeito da Asser√ß√£o.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Signatures are versatile, capable of signing an entire XML tree or specific elements within it. They can be applied to any XML Object, not just Response elements. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Cada elemento `Reference` significa um recurso espec√≠fico sendo assinado, identific√°vel pelo atributo URI.

### Tipos de Assinaturas XML

1. **Assinatura Envelopada**: Este tipo de assinatura √© um descendente do recurso que assina, significando que a assinatura est√° contida na mesma estrutura XML que o conte√∫do assinado.

Exemplo:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

Em uma assinatura envelopada, o elemento `ds:Transform` especifica que est√° envelopada atrav√©s do algoritmo `enveloped-signature`.

2. **Assinatura Envelopante**: Contrastando com assinaturas envelopadas, assinaturas envelopantes envolvem o recurso sendo assinado.

Exemplo:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Assinatura Destacada**: Este tipo √© separado do conte√∫do que assina. A assinatura e o conte√∫do existem de forma independente, mas uma liga√ß√£o entre os dois √© mantida.

Exemplo:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

Em conclus√£o, Assinaturas XML fornecem maneiras flex√≠veis de proteger documentos XML, com cada tipo atendendo a diferentes necessidades estruturais e de seguran√ßa.

## Refer√™ncias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
