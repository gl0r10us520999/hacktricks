{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Pregled

**Security Assertion Markup Language (SAML)** omoguÄ‡ava koriÅ¡Ä‡enje provajdera identiteta (IdP) za slanje autorizacionih kredencijala provajderima usluga (SP), olakÅ¡avajuÄ‡i jedinstveno prijavljivanje (SSO). Ovaj pristup pojednostavljuje upravljanje viÅ¡estrukim prijavama omoguÄ‡avajuÄ‡i koriÅ¡Ä‡enje jednog skupa kredencijala na viÅ¡e veb sajtova. Koristi XML za standardizovanu komunikaciju izmeÄ‘u IdP-a i SP-a, povezujuÄ‡i autentifikaciju identiteta korisnika sa autorizacijom usluga.

## Uporedba izmeÄ‘u SAML i OAuth

- **SAML** je prilagoÄ‘en za pruÅ¾anje preduzeÄ‡ima veÄ‡e kontrole nad bezbednoÅ¡Ä‡u SSO prijavljivanja.
- **OAuth** je dizajniran da bude viÅ¡e prilagoÄ‘en mobilnim ureÄ‘ajima, koristi JSON i rezultat je saradnje kompanija kao Å¡to su Google i Twitter.

# SAML Tok Autentifikacije

**Za viÅ¡e detalja pogledajte ceo post sa [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Ovo je saÅ¾etak:

Proces SAML autentifikacije ukljuÄuje nekoliko koraka, kao Å¡to je prikazano u Å¡emi:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **PokuÅ¡aj pristupa resursu**: Korisnik pokuÅ¡ava da pristupi zaÅ¡tiÄ‡enom resursu.
2. **Generisanje SAML Zahteva**: SP ne prepoznaje korisnika i generiÅ¡e SAML Zahtev.
3. **Preusmeravanje na IdP**: Korisnik se preusmerava na IdP, pri Äemu SAML Zahtev prolazi kroz korisnikov pretraÅ¾ivaÄ.
4. **IdP prima zahtev**: IdP prima SAML Zahtev.
5. **Autentifikacija na IdP**: IdP autentifikuje korisnika.
6. **Validacija korisnika**: IdP validira legitimnost korisnika za pristup traÅ¾enom resursu.
7. **Kreiranje SAML Odgovora**: IdP generiÅ¡e SAML Odgovor koji sadrÅ¾i potrebne tvrdnje.
8. **Preusmeravanje na SP-ovu ACS URL**: Korisnik se preusmerava na SP-ovu URL adresu za uslugu potroÅ¡nje tvrdnji (ACS).
9. **Validacija SAML Odgovora**: ACS validira SAML Odgovor.
10. **Odobren pristup resursu**: Pristup inicijalno traÅ¾enom resursu je odobren.

# SAML Primer Zahteva

Razmotrite scenario u kojem korisnik traÅ¾i pristup sigurnom resursu na [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). SP identifikuje nedostatak autentifikacije i generiÅ¡e SAML Zahtev:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Raw SAML zahtev izgleda ovako:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
KljuÄni elementi ovog zahteva ukljuÄuju:
- **AssertionConsumerServiceURL**: OdreÄ‘uje gde IdP treba da poÅ¡alje SAML odgovor nakon autentifikacije.
- **Destination**: Adresa IdP-a na koju se zahtev Å¡alje.
- **ProtocolBinding**: DefiniÅ¡e metodu prenosa SAML protokol poruka.
- **saml:Issuer**: Identifikuje entitet koji je inicirao zahtev.

Nakon generisanja SAML zahteva, SP odgovara sa **302 preusmeravanjem**, usmeravajuÄ‡i pregledaÄ ka IdP-u sa SAML zahtevom kodiranim u **Location** header-u HTTP odgovora. **RelayState** parametar odrÅ¾ava informacije o stanju tokom transakcije, osiguravajuÄ‡i da SP prepozna inicijalni zahtev za resurs prilikom primanja SAML odgovora. **SAMLRequest** parametar je kompresovana i kodirana verzija sirovog XML isjeÄka, koristeÄ‡i Deflate kompresiju i base64 kodiranje.


# SAML Odgovor Primer

MoÅ¾ete pronaÄ‡i [puni SAML odgovor ovde](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). KljuÄne komponente odgovora ukljuÄuju:

- **ds:Signature**: Ovaj deo, XML potpis, osigurava integritet i autentiÄnost izdavaoca asertacije. SAML odgovor u primeru sadrÅ¾i dva `ds:Signature` elementa, jedan za poruku i drugi za asertaciju.
- **saml:Assertion**: Ovaj deo sadrÅ¾i informacije o identitetu korisnika i moguÄ‡e druge atribute.
- **saml:Subject**: OdreÄ‘uje glavnog subjekta svih izjava u asertaciji.
- **saml:StatusCode**: Predstavlja status operacije kao odgovor na odgovarajuÄ‡i zahtev.
- **saml:Conditions**: Detalji o uslovima kao Å¡to su vremenski okvir vaÅ¾enja asertacije i odreÄ‘eni provajder usluga.
- **saml:AuthnStatement**: PotvrÄ‘uje da je IdP autentifikovao subjekat asertacije.
- **saml:AttributeStatement**: SadrÅ¾i atribute koji opisuju subjekat asertacije.

Nakon SAML odgovora, proces ukljuÄuje 302 preusmeravanje sa IdP-a. To dovodi do POST zahteva ka URL-u usluge potroÅ¡nje asertacija (ACS) provajdera usluga. POST zahtev ukljuÄuje `RelayState` i `SAMLResponse` parametre. ACS je odgovoran za obradu i validaciju SAML odgovora.

Nakon Å¡to je POST zahtev primljen i SAML odgovor validiran, pristup se odobrava za zaÅ¡tiÄ‡eni resurs koji je prvobitno zahtevao korisnik. Ovo je ilustrovano sa `GET` zahtevom ka `/secure/` endpoint-u i `200 OK` odgovorom, Å¡to ukazuje na uspeÅ¡an pristup resursu.


# XML Potpisi

XML potpisi su svestrani, sposobni da potpiÅ¡u celu XML stablo ili specifiÄne elemente unutar njega. Mogu se primeniti na bilo koji XML objekat, ne samo na elemente odgovora. Ispod su kljuÄne vrste XML potpisa:

### Osnovna struktura XML potpisa
XML potpis se sastoji od osnovnih elemenata kao Å¡to je prikazano:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Svaki `Reference` element oznaÄava specifiÄan resurs koji se potpisuje, prepoznatljiv po URI atributu.

### Tipovi XML Potpisa

1. **Enveloped Signature**: Ova vrsta potpisa je potomak resursa koji potpisuje, Å¡to znaÄi da je potpis sadrÅ¾an unutar iste XML strukture kao i potpisani sadrÅ¾aj.

Primer:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

U enveloped potpisu, `ds:Transform` element specificira da je potpis obavijen kroz `enveloped-signature` algoritam.

2. **Enveloping Signature**: U suprotnosti sa enveloped potpisima, enveloping potpisi obavijaju resurs koji se potpisuje.

Primer:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Detached Signature**: Ova vrsta je odvojena od sadrÅ¾aja koji potpisuje. Potpis i sadrÅ¾aj postoje nezavisno, ali se odrÅ¾ava veza izmeÄ‘u njih.

Primer:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

U zakljuÄku, XML potpisi pruÅ¾aju fleksibilne naÄine za osiguranje XML dokumenata, pri Äemu svaka vrsta zadovoljava razliÄite strukturne i sigurnosne potrebe.


## Reference
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
