# Cache Poisoning y Cache Deception

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Usa [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) para construir y **automatizar flujos de trabajo** f√°cilmente con las **herramientas comunitarias m√°s avanzadas** del mundo.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

## La diferencia

> **¬øCu√°l es la diferencia entre el envenenamiento de cach√© web y la decepci√≥n de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante hace que la aplicaci√≥n almacene contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En la **decepci√≥n de cach√© web**, el atacante hace que la aplicaci√≥n almacene contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El envenenamiento de cach√© tiene como objetivo manipular la cach√© del lado del cliente para obligar a los clientes a cargar recursos que son inesperados, parciales o controlados por un atacante. La magnitud del impacto depende de la popularidad de la p√°gina afectada, ya que la respuesta contaminada se sirve exclusivamente a los usuarios que visitan la p√°gina durante el per√≠odo de contaminaci√≥n de la cach√©.

La ejecuci√≥n de un ataque de envenenamiento de cach√© implica varios pasos:

1. **Identificaci√≥n de Entradas Sin Clave**: Estos son par√°metros que, aunque no son necesarios para que una solicitud sea almacenada en cach√©, pueden alterar la respuesta devuelta por el servidor. Identificar estas entradas es crucial, ya que pueden ser explotadas para manipular la cach√©.
2. **Explotaci√≥n de las Entradas Sin Clave**: Despu√©s de identificar las entradas sin clave, el siguiente paso implica averiguar c√≥mo abusar de estos par√°metros para modificar la respuesta del servidor de una manera que beneficie al atacante.
3. **Asegurar que la Respuesta Envenenada est√© Almacenada en Cach√©**: El paso final es asegurarse de que la respuesta manipulada est√© almacenada en la cach√©. De esta manera, cualquier usuario que acceda a la p√°gina afectada mientras la cach√© est√© envenenada recibir√° la respuesta contaminada.

### Descubrimiento: Verificar encabezados HTTP

Por lo general, cuando una respuesta fue **almacenada en la cach√©**, habr√° un **encabezado que lo indique**, puedes verificar qu√© encabezados debes tener en cuenta en esta publicaci√≥n: [**Encabezados de cach√© HTTP**](../../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: C√≥digos de error de cach√©

Si est√°s pensando que la respuesta se est√° almacenando en una cach√©, podr√≠as intentar **enviar solicitudes con un encabezado incorrecto**, que deber√≠a ser respondido con un **c√≥digo de estado 400**. Luego intenta acceder a la solicitud normalmente y si la **respuesta es un c√≥digo de estado 400**, sabes que es vulnerable (y podr√≠as incluso realizar un DoS).

Puedes encontrar m√°s opciones en:

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

Sin embargo, ten en cuenta que **a veces estos tipos de c√≥digos de estado no se almacenan en cach√©**, por lo que esta prueba podr√≠a no ser confiable.

### Descubrimiento: Identificar y evaluar entradas sin clave

Podr√≠as usar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **fuerza bruta de par√°metros y encabezados** que pueden estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina puede estar usando el encabezado `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Elicit a harmful response from the back-end server

Con el par√°metro/cabecera identificado, verifica c√≥mo est√° siendo **sanitizado** y **d√≥nde** se est√° **reflejando** o afectando la respuesta de la cabecera. ¬øPuedes abusar de ello de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Get the response cached

Una vez que hayas **identificado** la **p√°gina** que puede ser abusada, qu√© **par√°metro**/**cabecera** usar y **c√≥mo** **abusar** de ello, necesitas hacer que la p√°gina se almacene en cach√©. Dependiendo del recurso que est√©s tratando de almacenar en cach√©, esto podr√≠a tomar alg√∫n tiempo, podr√≠as necesitar intentarlo durante varios segundos.

La cabecera **`X-Cache`** en la respuesta podr√≠a ser muy √∫til ya que puede tener el valor **`miss`** cuando la solicitud no fue almacenada en cach√© y el valor **`hit`** cuando est√° en cach√©.\
La cabecera **`Cache-Control`** tambi√©n es interesante para saber si un recurso est√° siendo almacenado en cach√© y cu√°ndo ser√° la pr√≥xima vez que el recurso ser√° almacenado en cach√© nuevamente: `Cache-Control: public, max-age=1800`

Otra cabecera interesante es **`Vary`**. Esta cabecera se utiliza a menudo para **indicar cabeceras adicionales** que se tratan como **parte de la clave de cach√©** incluso si normalmente no est√°n indexadas. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima que est√° atacando, puede envenenar la cach√© para los usuarios que utilizan ese `User-Agent` espec√≠fico.

Una cabecera m√°s relacionada con la cach√© es **`Age`**. Define el tiempo en segundos que el objeto ha estado en la cach√© del proxy.

Al almacenar en cach√© una solicitud, ten **cuidado con las cabeceras que usas** porque algunas de ellas podr√≠an ser **usadas inesperadamente** como **indexadas** y la **v√≠ctima necesitar√° usar esa misma cabecera**. Siempre **prueba** un Cache Poisoning con **diferentes navegadores** para verificar si est√° funcionando.

## Exploiting Examples

### Easiest example

Una cabecera como `X-Forwarded-For` se est√° reflejando en la respuesta sin sanitizar.\
Puedes enviar una carga √∫til b√°sica de XSS y envenenar la cach√© para que todos los que accedan a la p√°gina sean XSSed:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Note que esto envenenar√° una solicitud a `/en?region=uk` no a `/en`_

### Envenenamiento de cach√© para DoS

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

### Usando el envenenamiento de cach√© web para explotar vulnerabilidades en el manejo de cookies

Las cookies tambi√©n podr√≠an reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que cargan la respuesta de cach√© maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Note que si la cookie vulnerable es muy utilizada por los usuarios, las solicitudes regulares estar√°n limpiando la cach√©.

### Generando discrepancias con delimitadores, normalizaci√≥n y puntos <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Verifique:

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### Envenenamiento de cach√© con recorrido de ruta para robar la clave de API <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Este informe explica**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) c√≥mo fue posible robar una clave de API de OpenAI con una URL como `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` porque cualquier cosa que coincida con `/share/*` ser√° almacenada en cach√© sin que Cloudflare normalice la URL, lo cual se hizo cuando la solicitud lleg√≥ al servidor web.

Esto tambi√©n se explica mejor en:

{% content-ref url="cache-poisoning-via-url-discrepancies.md" %}
[cache-poisoning-via-url-discrepancies.md](cache-poisoning-via-url-discrepancies.md)
{% endcontent-ref %}

### Usando m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

A veces necesitar√°s **explotar varias entradas sin clave** para poder abusar de una cach√©. Por ejemplo, puedes encontrar un **redireccionamiento abierto** si configuras `X-Forwarded-Host` a un dominio controlado por ti y `X-Forwarded-Scheme` a `http`. **Si** el **servidor** est√° **reenviando** todas las **solicitudes HTTP** **a HTTPS** y usando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para el redireccionamiento. Puedes controlar hacia d√≥nde apunta la p√°gina por el redireccionamiento.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotando con un encabezado `Vary` limitado

Si descubres que el **`X-Host`** se est√° utilizando como **nombre de dominio para cargar un recurso JS** pero el encabezado **`Vary`** en la respuesta indica **`User-Agent`**. Entonces, necesitas encontrar una manera de exfiltrar el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Fat Get

Env√≠a una solicitud GET con la solicitud en la URL y en el cuerpo. Si el servidor web utiliza la del cuerpo pero el servidor de cach√© almacena en cach√© la de la URL, cualquier persona que acceda a esa URL utilizar√° en realidad el par√°metro del cuerpo. Como la vulnerabilidad que James Kettle encontr√≥ en el sitio web de Github:
```
GET /contact/report-abuse?report=albinowax HTTP/1.1
Host: github.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

report=innocent-victim
```
There it a portswigger lab about this: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-fat-get)

### Parameter Cloacking

Por ejemplo, es posible separar **par√°metros** en servidores ruby usando el car√°cter **`;`** en lugar de **`&`**. Esto podr√≠a usarse para poner valores de par√°metros no clave dentro de los clave y abusar de ellos.

Portswigger lab: [https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking](https://portswigger.net/web-security/web-cache-poisoning/exploiting-implementation-flaws/lab-web-cache-poisoning-param-cloaking)

### Exploiting HTTP Cache Poisoning by abusing HTTP Request Smuggling

Aprende aqu√≠ c√≥mo realizar [ataques de Cache Poisoning abusando de HTTP Request Smuggling](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automated testing for Web Cache Poisoning

El [Esc√°ner de Vulnerabilidades de Cache Web](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) se puede usar para probar autom√°ticamente la intoxicaci√≥n de cach√© web. Soporta muchas t√©cnicas diferentes y es altamente personalizable.

Ejemplo de uso: `wcvs -u example.com`

## Vulnerable Examples

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS reenvi√≥ el fragmento dentro de la URL sin eliminarlo y gener√≥ la clave de cach√© solo usando el host, la ruta y la consulta (ignorando el fragmento). As√≠ que la solicitud `/#/../?r=javascript:alert(1)` se envi√≥ al backend como `/#/../?r=javascript:alert(1)` y la clave de cach√© no ten√≠a la carga √∫til dentro de ella, solo host, ruta y consulta.

### GitHub CP-DoS

Enviar un valor incorrecto en el encabezado content-type activ√≥ una respuesta 405 en cach√©. La clave de cach√© conten√≠a la cookie, por lo que solo era posible atacar a usuarios no autenticados.

### GitLab + GCP CP-DoS

GitLab utiliza buckets de GCP para almacenar contenido est√°tico. **Los Buckets de GCP** soportan el **encabezado `x-http-method-override`**. Por lo tanto, era posible enviar el encabezado `x-http-method-override: HEAD` y envenenar la cach√© para que devolviera un cuerpo de respuesta vac√≠o. Tambi√©n podr√≠a soportar el m√©todo `PURGE`.

### Rack Middleware (Ruby on Rails)

En aplicaciones Ruby on Rails, a menudo se utiliza middleware Rack. El prop√≥sito del c√≥digo Rack es tomar el valor del encabezado **`x-forwarded-scheme`** y establecerlo como el esquema de la solicitud. Cuando se env√≠a el encabezado `x-forwarded-scheme: http`, ocurre una redirecci√≥n 301 a la misma ubicaci√≥n, lo que puede causar una Denegaci√≥n de Servicio (DoS) a ese recurso. Adem√°s, la aplicaci√≥n podr√≠a reconocer el encabezado `X-forwarded-host` y redirigir a los usuarios al host especificado. Este comportamiento puede llevar a la carga de archivos JavaScript desde el servidor de un atacante, lo que representa un riesgo de seguridad.

### 403 and Storage Buckets

Cloudflare anteriormente almacenaba en cach√© respuestas 403. Intentar acceder a S3 o Azure Storage Blobs con encabezados de autorizaci√≥n incorrectos resultar√≠a en una respuesta 403 que se almacen√≥ en cach√©. Aunque Cloudflare ha dejado de almacenar en cach√© respuestas 403, este comportamiento podr√≠a seguir presente en otros servicios de proxy.

### Injecting Keyed Parameters

Las cach√©s a menudo incluyen par√°metros GET espec√≠ficos en la clave de cach√©. Por ejemplo, el Varnish de Fastly almacenaba en cach√© el par√°metro `size` en las solicitudes. Sin embargo, si se enviaba una versi√≥n codificada en URL del par√°metro (por ejemplo, `siz%65`) con un valor err√≥neo, la clave de cach√© se construir√≠a usando el par√°metro `size` correcto. Sin embargo, el backend procesar√≠a el valor en el par√°metro codificado en URL. Codificar en URL el segundo par√°metro `size` llev√≥ a su omisi√≥n por parte de la cach√©, pero su utilizaci√≥n por parte del backend. Asignar un valor de 0 a este par√°metro result√≥ en un error 400 Bad Request que se pod√≠a almacenar en cach√©.

### User Agent Rules

Algunos desarrolladores bloquean solicitudes con user-agents que coinciden con los de herramientas de alto tr√°fico como FFUF o Nuclei para gestionar la carga del servidor. Ir√≥nicamente, este enfoque puede introducir vulnerabilidades como la intoxicaci√≥n de cach√© y DoS.

### Illegal Header Fields

El [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) especifica los caracteres aceptables en los nombres de encabezados. Los encabezados que contienen caracteres fuera del rango **tchar** especificado deber√≠an idealmente activar una respuesta 400 Bad Request. En la pr√°ctica, los servidores no siempre se adhieren a este est√°ndar. Un ejemplo notable es Akamai, que reenv√≠a encabezados con caracteres no v√°lidos y almacena en cach√© cualquier error 400, siempre que el encabezado `cache-control` no est√© presente. Se identific√≥ un patr√≥n explotable donde enviar un encabezado con un car√°cter ilegal, como `\`, resultar√≠a en un error 400 Bad Request que se pod√≠a almacenar en cach√©.

### Finding new headers

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Cache Deception

El objetivo de la Decepci√≥n de Cach√© es hacer que los clientes **carguen recursos que van a ser guardados por la cach√© con su informaci√≥n sensible**.

Primero, ten en cuenta que **extensiones** como `.css`, `.js`, `.png`, etc., suelen estar **configuradas** para ser **guardadas** en la **cach√©.** Por lo tanto, si accedes a `www.example.com/profile.php/nonexistent.js`, la cach√© probablemente almacenar√° la respuesta porque ve la **extensi√≥n** `.js`. Pero, si la **aplicaci√≥n** est√° **reproduciendo** con los contenidos **sensibles** del usuario almacenados en _www.example.com/profile.php_, puedes **robar** esos contenidos de otros usuarios.

Otras cosas para probar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Usa extensiones menos conocidas como_ `.avif`

Otro ejemplo muy claro se puede encontrar en este informe: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
En el ejemplo, se explica que si cargas una p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, el contenido de _http://www.example.com/home.php_ (**con la informaci√≥n sensible del usuario**) se devolver√° y el servidor de cach√© guardar√° el resultado.\
Luego, el **atacante** puede acceder a _http://www.example.com/home.php/non-existent.css_ en su propio navegador y observar la **informaci√≥n confidencial** de los usuarios que accedieron antes.

Ten en cuenta que el **proxy de cach√©** debe estar **configurado** para **almacenar en cach√©** archivos **basados** en la **extensi√≥n** del archivo (_.css_) y no basarse en el tipo de contenido. En el ejemplo _http://www.example.com/home.php/non-existent.css_ tendr√° un tipo de contenido `text/html` en lugar de un tipo MIME `text/css` (que es el esperado para un archivo _.css_).

Aprende aqu√≠ c√≥mo realizar [ataques de Decepci√≥n de Cach√© abusando de HTTP Request Smuggling](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## Automatic Tools

* [**toxicache**](https://github.com/xhzeem/toxicache): Esc√°ner de Golang para encontrar vulnerabilidades de intoxicaci√≥n de cach√© web en una lista de URLs y probar m√∫ltiples t√©cnicas de inyecci√≥n.

## References

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Usa [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=cache-deception) para construir y **automatizar flujos de trabajo** f√°cilmente impulsados por las **herramientas m√°s avanzadas** de la comunidad.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=cache-deception" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
