# MySQL File priv to SSRF/RCE

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

**Este √© um resumo das t√©cnicas MySQL/MariaDB/Percona de [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

### Server-Side Request Forgery (SSRF) via SQL Functions

Na explora√ß√£o da exfiltra√ß√£o de dados SQL Out of Band, a fun√ß√£o `LOAD_FILE()` √© comumente utilizada para iniciar requisi√ß√µes de rede. No entanto, essa fun√ß√£o √© limitada pelo sistema operacional em que opera e pelas configura√ß√µes de inicializa√ß√£o do banco de dados.

A vari√°vel global `secure_file_priv`, se n√£o definida, tem como padr√£o `/var/lib/mysql-files/`, limitando o acesso a arquivos a este diret√≥rio, a menos que seja definida como uma string vazia (`""`). Essa altera√ß√£o requer modifica√ß√µes no arquivo de configura√ß√£o do banco de dados ou nos par√¢metros de inicializa√ß√£o.

Dado que `secure_file_priv` est√° desativado (`""`), e assumindo que as permiss√µes necess√°rias de arquivo e `file_priv` s√£o concedidas, arquivos fora do diret√≥rio designado podem ser lidos. No entanto, a capacidade dessas fun√ß√µes de fazer chamadas de rede depende fortemente do sistema operacional. Em sistemas Windows, chamadas de rede para caminhos UNC s√£o vi√°veis devido √† compreens√£o do sistema operacional sobre as conven√ß√µes de nomenclatura UNC, potencialmente levando √† exfiltra√ß√£o de hashes NTLMv2.

Esse m√©todo SSRF √© limitado √† porta TCP 445 e n√£o permite a modifica√ß√£o do n√∫mero da porta, embora possa ser usado para acessar compartilhamentos com plenos privil√©gios de leitura e, como demonstrado em pesquisas anteriores, para roubar hashes para explora√ß√£o adicional.

### Remote Code Execution (RCE) via User Defined Functions (UDF)

Bancos de dados MySQL oferecem o uso de Fun√ß√µes Definidas pelo Usu√°rio (UDF) a partir de arquivos de biblioteca externos. Se essas bibliotecas estiverem acess√≠veis dentro de diret√≥rios espec√≠ficos ou no `$PATH` do sistema, podem ser invocadas a partir do MySQL.

Essa t√©cnica permite a execu√ß√£o de requisi√ß√µes de rede/HTTP atrav√©s de uma UDF, desde que v√°rias condi√ß√µes sejam atendidas, incluindo acesso de grava√ß√£o ao `@@plugin_dir`, `file_priv` definido como `Y`, e `secure_file_priv` desativado.

Por exemplo, a biblioteca `lib_mysqludf_sys` ou outras bibliotecas UDF que permitem requisi√ß√µes HTTP podem ser carregadas para realizar SSRF. As bibliotecas devem ser transferidas para o servidor, o que pode ser alcan√ßado atrav√©s da codifica√ß√£o em hex ou base64 do conte√∫do da biblioteca e, em seguida, escrevendo-o no diret√≥rio apropriado.

O processo varia se o `@@plugin_dir` n√£o for grav√°vel, especialmente para vers√µes do MySQL acima de `v5.0.67`. Nesses casos, caminhos alternativos que sejam grav√°veis devem ser utilizados.

A automa√ß√£o desses processos pode ser facilitada por ferramentas como SQLMap, que suporta inje√ß√£o de UDF, e para inje√ß√µes SQL cegas, t√©cnicas de redirecionamento de sa√≠da ou de contrabando de requisi√ß√µes DNS podem ser utilizadas.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
