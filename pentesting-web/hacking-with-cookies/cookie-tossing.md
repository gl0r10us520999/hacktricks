# Cookie Tossing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Description

Se um atacante puder **controlar um subdom√≠nio ou o dom√≠nio de uma empresa ou encontrar um XSS em um subdom√≠nio**, ele ser√° capaz de realizar este ataque.

Como foi indicado na se√ß√£o de Cookies Hacking, quando um **cookie √© definido para um dom√≠nio (especificando-o), ele ser√° usado no dom√≠nio e subdom√≠nios.**

{% hint style="danger" %}
Portanto, **um atacante poder√° definir para o dom√≠nio e subdom√≠nios um cookie espec√≠fico fazendo algo como** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Isso pode ser perigoso, pois o atacante pode ser capaz de:

* **Fixar o cookie da v√≠tima na conta do atacante**, ent√£o se o usu√°rio n√£o perceber, **ele realizar√° as a√ß√µes na conta do atacante** e o atacante pode obter algumas informa√ß√µes interessantes (ver o hist√≥rico de buscas do usu√°rio na plataforma, a v√≠tima pode ter configurado seu cart√£o de cr√©dito na conta...)
* Se o **cookie n√£o mudar ap√≥s o login**, o atacante pode apenas **fixar um cookie (session-fixation)**, esperar at√© que a v√≠tima fa√ßa login e ent√£o **usar esse cookie para fazer login como a v√≠tima**.
* √Äs vezes, mesmo que os cookies de sess√£o mudem, o atacante usa o anterior e tamb√©m receber√° o novo.
* Se o **cookie estiver definindo algum valor inicial** (como no flask onde o **cookie** pode **definir** o **token CSRF** da sess√£o e esse valor ser√° mantido ap√≥s a v√≠tima fazer login), o **atacante pode definir esse valor conhecido e ent√£o abusar dele** (nesse cen√°rio, o atacante pode ent√£o fazer o usu√°rio realizar uma solicita√ß√£o CSRF, pois ele conhece o token CSRF).
* Assim como definir o valor, o atacante tamb√©m poderia obter um cookie n√£o autenticado gerado pelo servidor, obter o token CSRF dele e us√°-lo.

### Cookie Order

Quando um navegador recebe dois cookies com o mesmo nome **afetando parcialmente o mesmo escopo** (dom√≠nio, subdom√≠nios e caminho), o **navegador enviar√° ambos os valores do cookie** quando ambos forem v√°lidos para a solicita√ß√£o.

Dependendo de quem tem **o caminho mais espec√≠fico** ou qual √© o **mais antigo**, o navegador **definir√° o valor do cookie primeiro** e depois o valor do outro como em: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

A maioria **dos sites usar√° apenas o primeiro valor**. Ent√£o, se um atacante quiser definir um cookie, √© melhor defini-lo antes que outro seja definido ou defini-lo com um caminho mais espec√≠fico.

{% hint style="warning" %}
Al√©m disso, a capacidade de **definir um cookie em um caminho mais espec√≠fico** √© muito interessante, pois voc√™ poder√° fazer com que a **v√≠tima trabalhe com seu cookie, exceto no caminho espec√≠fico onde o cookie malicioso definido ser√° enviado antes**.
{% endhint %}

### Protection Bypass

Uma poss√≠vel prote√ß√£o contra este ataque seria que o **servidor web n√£o aceitasse solicita√ß√µes com dois cookies com o mesmo nome, mas com dois valores diferentes**.

Para contornar o cen√°rio onde o atacante est√° definindo um cookie ap√≥s a v√≠tima j√° ter recebido o cookie, o atacante poderia causar um **cookie overflow** e ent√£o, uma vez que o **cookie leg√≠timo √© deletado, definir o malicioso**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Outro **bypass** √∫til poderia ser **URL codificar o nome do cookie**, pois algumas prote√ß√µes verificam 2 cookies com o mesmo nome em uma solicita√ß√£o e ent√£o o servidor decodificar√° os nomes dos cookies.

### Cookie Bomb

Um ataque de Cookie Tossing tamb√©m pode ser usado para realizar um ataque de **Cookie Bomb**:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Defense**s**

#### **Use o prefixo `__Host` no nome do cookie**

* Se um nome de cookie tiver esse prefixo, ele **ser√° aceito** em uma diretiva Set-Cookie apenas se estiver marcado como Seguro, foi enviado de uma origem segura, n√£o incluir um atributo Domain e tiver o atributo Path definido como /
* **Isso impede que subdom√≠nios forcem um cookie para o dom√≠nio principal, uma vez que esses cookies podem ser vistos como "bloqueados por dom√≠nio"**

### References

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
