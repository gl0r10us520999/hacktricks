# Cookie Tossing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Description

Se un attaccante pu√≤ **controllare un sottodominio o il dominio di un'azienda o trova un XSS in un sottodominio**, sar√† in grado di eseguire questo attacco.

Come indicato nella sezione Cookies Hacking, quando un **cookie √® impostato su un dominio (specificandolo) verr√† utilizzato nel dominio e nei sottodomini.**

{% hint style="danger" %}
Pertanto, **un attaccante sar√† in grado di impostare su dominio e sottodomini un cookie specifico facendo qualcosa come** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Questo pu√≤ essere pericoloso poich√© l'attaccante potrebbe essere in grado di:

* **Fissare il cookie della vittima all'account dell'attaccante** in modo che se l'utente non se ne accorge, **eseguir√† le azioni nell'account dell'attaccante** e l'attaccante potrebbe ottenere alcune informazioni interessanti (controllare la cronologia delle ricerche dell'utente nella piattaforma, la vittima potrebbe impostare la sua carta di credito nell'account...)
* Se il **cookie non cambia dopo il login**, l'attaccante potrebbe semplicemente **fissare un cookie (session-fixation)**, aspettare che la vittima effettui il login e poi **usare quel cookie per accedere come la vittima**.
* A volte, anche se i cookie di sessione cambiano, l'attaccante usa quello precedente e ricever√† anche il nuovo.
* Se il **cookie imposta un valore iniziale** (come in flask dove il **cookie** pu√≤ **impostare** il **token CSRF** della sessione e questo valore sar√† mantenuto dopo che la vittima effettua il login), l'**attaccante potrebbe impostare questo valore noto e poi abusarne** (in quel scenario, l'attaccante potrebbe quindi far eseguire all'utente una richiesta CSRF poich√© conosce il token CSRF).
* Proprio come impostare il valore, l'attaccante potrebbe anche ottenere un cookie non autenticato generato dal server, ottenere il token CSRF da esso e usarlo.

### Cookie Order

Quando un browser riceve due cookie con lo stesso nome **che influiscono parzialmente sullo stesso ambito** (dominio, sottodomini e percorso), il **browser invier√† entrambi i valori del cookie** quando entrambi sono validi per la richiesta.

A seconda di chi ha **il percorso pi√π specifico** o quale sia il **pi√π vecchio**, il browser **imposter√† prima il valore del cookie** e poi il valore dell'altro come in: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

La maggior parte **dei siti web utilizzer√† solo il primo valore**. Quindi, se un attaccante vuole impostare un cookie, √® meglio impostarlo prima che un altro venga impostato o impostarlo con un percorso pi√π specifico.

{% hint style="warning" %}
Inoltre, la capacit√† di **impostare un cookie in un percorso pi√π specifico** √® molto interessante poich√© sar√† possibile far **lavorare la vittima con il suo cookie tranne che nel percorso specifico dove il cookie malevolo impostato verr√† inviato prima**.
{% endhint %}

### Protection Bypass

Una possibile protezione contro questo attacco sarebbe che il **server web non accetti richieste con due cookie con lo stesso nome ma due valori diversi**.

Per bypassare lo scenario in cui l'attaccante sta impostando un cookie dopo che alla vittima √® gi√† stato dato il cookie, l'attaccante potrebbe causare un **cookie overflow** e poi, una volta che il **cookie legittimo √® stato eliminato, impostare quello malevolo**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Un altro utile **bypass** potrebbe essere **URL codificare il nome del cookie** poich√© alcune protezioni controllano 2 cookie con lo stesso nome in una richiesta e poi il server decodificher√† i nomi dei cookie.

### Cookie Bomb

Un attacco di Cookie Tossing pu√≤ anche essere utilizzato per eseguire un **attacco Cookie Bomb**:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Defense**s**

#### **Usa il prefisso `__Host` nel nome del cookie**

* Se un nome di cookie ha questo prefisso, **verr√† accettato** in una direttiva Set-Cookie solo se √® contrassegnato come Sicuro, √® stato inviato da un'origine sicura, non include un attributo Domain e ha l'attributo Path impostato su /
* **Questo impedisce ai sottodomini di forzare un cookie al dominio principale poich√© questi cookie possono essere visti come "bloccati a livello di dominio"**

### References

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
