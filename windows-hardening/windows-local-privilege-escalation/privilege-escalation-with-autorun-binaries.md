# Privilege Escalation with Autoruns

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **prijavite se** za **Intigriti**, premium **bug bounty platformu koju su kreirali hakeri, za hakere**! Pridru≈æite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i poƒçnite da zaraƒëujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## WMIC

**Wmic** se mo≈æe koristiti za pokretanje programa pri **pokretanju**. Pogledajte koji su binarni programi pode≈°eni da se pokrenu pri pokretanju sa:
```bash
wmic startup get caption,command 2>nul & ^
Get-CimInstance Win32_StartupCommand | select Name, command, Location, User | fl
```
## Zakazani zadaci

**Zadaci** mogu biti zakazani da se izvr≈°avaju sa **odreƒëenom frekvencijom**. Pogledajte koji su binarni fajlovi zakazani za izvr≈°avanje sa:
```bash
schtasks /query /fo TABLE /nh | findstr /v /i "disable deshab"
schtasks /query /fo LIST 2>nul | findstr TaskName
schtasks /query /fo LIST /v > schtasks.txt; cat schtask.txt | grep "SYSTEM\|Task To Run" | grep -B 1 SYSTEM
Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State

#Schtask to give admin access
#You can also write that content on a bat file that is being executed by a scheduled task
schtasks /Create /RU "SYSTEM" /SC ONLOGON /TN "SchedPE" /TR "cmd /c net localgroup administrators user /add"
```
## Folders

Svi binarni fajlovi sme≈°teni u **Startup folderima ƒáe biti izvr≈°eni prilikom pokretanja**. Uobiƒçajeni startup folderi su oni navedeni u nastavku, ali je startup folder oznaƒçen u registru. [Proƒçitajte ovo da saznate gde.](privilege-escalation-with-autorun-binaries.md#startup-path)
```bash
dir /b "C:\Documents and Settings\All Users\Start Menu\Programs\Startup" 2>nul
dir /b "C:\Documents and Settings\%username%\Start Menu\Programs\Startup" 2>nul
dir /b "%programdata%\Microsoft\Windows\Start Menu\Programs\Startup" 2>nul
dir /b "%appdata%\Microsoft\Windows\Start Menu\Programs\Startup" 2>nul
Get-ChildItem "C:\Users\All Users\Start Menu\Programs\Startup"
Get-ChildItem "C:\Users\$env:USERNAME\Start Menu\Programs\Startup"
```
## Registry

{% hint style="info" %}
[–ù–∞–ø–æ–º–µ–Ω–∞ –æ–¥ –æ–≤–¥–µ](https://answers.microsoft.com/en-us/windows/forum/all/delete-registry-key/d425ae37-9dcc-4867-b49c-723dcd15147f): **Wow6432Node** —Ä–µ–≥–∏—Å—Ç–∞—Ä—Å–∫–∏ —É–Ω–æ—Å —É–∫–∞–∑—É—ò–µ –¥–∞ –∫–æ—Ä–∏—Å—Ç–∏—Ç–µ 64-–±–∏—Ç–Ω—É –≤–µ—Ä–∑–∏—ò—É Windows-a. –û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏ —Å–∏—Å—Ç–µ–º –∫–æ—Ä–∏—Å—Ç–∏ –æ–≤–∞—ò –∫—ô—É—á –¥–∞ –ø—Ä–∏–∫–∞–∂–µ –æ–¥–≤–æ—ò–µ–Ω—É –≤–µ—Ä–∑–∏—ò—É HKEY\_LOCAL\_MACHINE\SOFTWARE –∑–∞ 32-–±–∏—Ç–Ω–µ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–µ –∫–æ—ò–µ —Ä–∞–¥–µ –Ω–∞ 64-–±–∏—Ç–Ω–∏–º –≤–µ—Ä–∑–∏—ò–∞–º–∞ Windows-a.
{% endhint %}

### Runs

**–û–±–∏—á–Ω–æ –ø–æ–∑–Ω–∞—Ç–∏** AutoRun —Ä–µ–≥–∏—Å—Ç–∞—Ä:

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run`
* `HKCU\Software\Wow6432Npde\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Runonce`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunonceEx`

–†–µ–≥–∏—Å—Ç–∞—Ä—Å–∫–∏ –∫—ô—É—á–µ–≤–∏ –ø–æ–∑–Ω–∞—Ç–∏ –∫–∞–æ **Run** –∏ **RunOnce** —Å—É –¥–∏–∑–∞—ò–Ω–∏—Ä–∞–Ω–∏ –¥–∞ –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ –∏–∑–≤—Ä—à–∞–≤–∞—ò—É –ø—Ä–æ–≥—Ä–∞–º–µ —Å–≤–∞–∫–∏ –ø—É—Ç –∫–∞–¥–∞ —Å–µ –∫–æ—Ä–∏—Å–Ω–∏–∫ –ø—Ä–∏—ò–∞–≤–∏ —É —Å–∏—Å—Ç–µ–º. –ö–æ–º–∞–Ω–¥–Ω–∞ –ª–∏–Ω–∏—ò–∞ –¥–æ–¥–µ—ô–µ–Ω–∞ –∫–∞–æ –≤—Ä–µ–¥–Ω–æ—Å—Ç –∫—ô—É—á–∞ —ò–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –Ω–∞ 260 –∑–Ω–∞–∫–æ–≤–∞ –∏–ª–∏ –º–∞—ö–µ.

**Service runs** (–º–æ–≥—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Å–∞—Ç–∏ –∞—É—Ç–æ–º–∞—Ç—Å–∫–æ –ø–æ–∫—Ä–µ—Ç–∞—ö–µ —É—Å–ª—É–≥–∞ —Ç–æ–∫–æ–º –ø–æ–∫—Ä–µ—Ç–∞—ö–∞):

* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices`

**RunOnceEx:**

* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx`
* `HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnceEx`

–ù–∞ Windows Vista –∏ –Ω–æ–≤–∏—ò–∏–º –≤–µ—Ä–∑–∏—ò–∞–º–∞, **Run** –∏ **RunOnce** —Ä–µ–≥–∏—Å—Ç–∞—Ä—Å–∫–∏ –∫—ô—É—á–µ–≤–∏ —Å–µ –Ω–µ –≥–µ–Ω–µ—Ä–∏—à—É –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏. –£–Ω–æ—Å–∏ —É –æ–≤–∏–º –∫—ô—É—á–µ–≤–∏–º–∞ –º–æ–≥—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫—Ä–µ–Ω—É—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–µ –∏–ª–∏ –∏—Ö –æ–¥—Ä–µ–¥–∏—Ç–∏ –∫–∞–æ –∑–∞–≤–∏—Å–Ω–æ—Å—Ç–∏. –ù–∞ –ø—Ä–∏–º–µ—Ä, –¥–∞ –±–∏ —Å–µ —É—á–∏—Ç–∞–æ DLL —Ñ–∞—ò–ª –ø—Ä–∏ –ø—Ä–∏—ò–∞–≤–∏, –º–æ–≥–ª–æ –±–∏ —Å–µ –∫–æ—Ä–∏—Å—Ç–∏—Ç–∏ **RunOnceEx** —Ä–µ–≥–∏—Å—Ç–∞—Ä—Å–∫–∏ –∫—ô—É—á –∑–∞—ò–µ–¥–Ω–æ —Å–∞ "Depend" –∫—ô—É—á–µ–º. –û–≤–æ —Å–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–∞ –¥–æ–¥–∞–≤–∞—ö–µ–º —Ä–µ–≥–∏—Å—Ç–∞—Ä—Å–∫–æ–≥ —É–Ω–æ—Å–∞ –∑–∞ –∏–∑–≤—Ä—à–∞–≤–∞—ö–µ "C:\temp\evil.dll" —Ç–æ–∫–æ–º –ø–æ–∫—Ä–µ—Ç–∞—ö–∞ —Å–∏—Å—Ç–µ–º–∞:
```
reg add HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\0001\\Depend /v 1 /d "C:\\temp\\evil.dll"
```
{% hint style="info" %}
**Eksploit 1**: Ako mo≈æete da pi≈°ete unutar bilo kog od pomenutih registra unutar **HKLM**, mo≈æete da eskalirate privilegije kada se drugi korisnik prijavi.
{% endhint %}

{% hint style="info" %}
**Eksploit 2**: Ako mo≈æete da prepi≈°ete bilo koji od binarnih fajlova navedenih u bilo kom od registara unutar **HKLM**, mo≈æete da modifikujete taj binarni fajl sa backdoor-om kada se drugi korisnik prijavi i eskalirate privilegije.
{% endhint %}
```bash
#CMD
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunE

reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices
reg query HKCU\Software\Wow5432Node\Microsoft\Windows\CurrentVersion\RunServices

reg query HKLM\Software\Microsoft\Windows\RunOnceEx
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\RunOnceEx
reg query HKCU\Software\Microsoft\Windows\RunOnceEx
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\RunOnceEx

#PowerShell
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunE'

Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices'

Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\RunOnceEx'
```
### Startup Path

* `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
* `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
* `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`

Preƒçice postavljene u **Startup** fasciklu automatski ƒáe pokrenuti usluge ili aplikacije tokom prijavljivanja korisnika ili ponovnog pokretanja sistema. Lokacija **Startup** fascikle je definisana u registru za **Local Machine** i **Current User** opsege. To znaƒçi da ƒáe svaka preƒçica dodata ovim odreƒëenim **Startup** lokacijama osigurati da se povezana usluga ili program pokrene nakon procesa prijavljivanja ili ponovnog pokretanja, ≈°to ga ƒçini jednostavnom metodom za zakazivanje programa da se automatski pokreƒáu.

{% hint style="info" %}
Ako mo≈æete prepisati bilo koju \[User] Shell Folder pod **HKLM**, moƒái ƒáete da je usmerite na fasciklu koju kontroli≈°ete i postavite backdoor koji ƒáe se izvr≈°iti svaki put kada se korisnik prijavi u sistem, poveƒáavajuƒái privilegije.
{% endhint %}
```bash
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" /v "Common Startup"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v "Common Startup"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v "Common Startup"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" /v "Common Startup"

Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders' -Name "Common Startup"
```
### Winlogon Kljuƒçevi

`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`

Obiƒçno je **Userinit** kljuƒç postavljen na **userinit.exe**. Meƒëutim, ako se ovaj kljuƒç izmeni, navedeni izvr≈°ni fajl ƒáe takoƒëe biti pokrenut od strane **Winlogon** prilikom prijavljivanja korisnika. Sliƒçno tome, **Shell** kljuƒç je namenjen da upuƒáuje na **explorer.exe**, koji je podrazumevani shell za Windows.
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v "Userinit"
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v "Shell"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "Userinit"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "Shell"
```
{% hint style="info" %}
Ako mo≈æete da prepi≈°ete vrednost registra ili binarni fajl, moƒái ƒáete da eskalirate privilegije.
{% endhint %}

### Pode≈°avanja politike

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer`

Proverite kljuƒç **Run**.
```bash
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" /v "Run"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" /v "Run"
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name "Run"
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name "Run"
```
### AlternateShell

### Promena komande za siguran re≈æim

U Windows registru pod `HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot`, postoji **`AlternateShell`** vrednost koja je podrazumevano postavljena na `cmd.exe`. To znaƒçi da kada izaberete "Siguran re≈æim sa komandnom linijom" tokom pokretanja (pritiskom na F8), koristi se `cmd.exe`. Meƒëutim, moguƒáe je postaviti va≈° raƒçunar da se automatski pokreƒáe u ovom re≈æimu bez potrebe da pritisnete F8 i ruƒçno ga izaberete.

Koraci za kreiranje opcije za pokretanje u "Sigurnom re≈æimu sa komandnom linijom":

1. Promenite atribute `boot.ini` datoteke da uklonite read-only, system i hidden oznake: `attrib c:\boot.ini -r -s -h`
2. Otvorite `boot.ini` za ureƒëivanje.
3. Umetnite liniju kao ≈°to je: `multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Microsoft Windows XP Professional" /fastdetect /SAFEBOOT:MINIMAL(ALTERNATESHELL)`
4. Saƒçuvajte promene u `boot.ini`.
5. Ponovo primenite originalne atribute datoteke: `attrib c:\boot.ini +r +s +h`

* **Eksploit 1:** Promena **AlternateShell** registracijske kljuƒçe omoguƒáava prilagoƒëenu postavku komandne ljuske, potencijalno za neovla≈°ƒáen pristup.
* **Eksploit 2 (PATH Write Permissions):** Imati dozvole za pisanje u bilo koji deo sistema **PATH** promenljive, posebno pre `C:\Windows\system32`, omoguƒáava vam da izvr≈°ite prilagoƒëeni `cmd.exe`, koji bi mogao biti backdoor ako se sistem pokrene u sigurnom re≈æimu.
* **Eksploit 3 (PATH i boot.ini Write Permissions):** Pristup za pisanje u `boot.ini` omoguƒáava automatsko pokretanje u sigurnom re≈æimu, olak≈°avajuƒái neovla≈°ƒáen pristup prilikom sledeƒáeg ponovnog pokretanja.

Da proverite trenutnu **AlternateShell** postavku, koristite ove komande:
```bash
reg query HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot /v AlternateShell
Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SafeBoot' -Name 'AlternateShell'
```
### Installed Component

Active Setup je funkcija u Windows-u koja **pokreƒáe pre nego ≈°to se radno okru≈æenje potpuno uƒçita**. Prioritizuje izvr≈°avanje odreƒëenih komandi, koje moraju biti zavr≈°ene pre nego ≈°to se prijavljivanje korisnika nastavi. Ovaj proces se de≈°ava ƒçak i pre nego ≈°to se aktiviraju drugi startni unosi, kao ≈°to su oni u Run ili RunOnce registrima.

Active Setup se upravlja kroz sledeƒáe registre:

* `HKLM\SOFTWARE\Microsoft\Active Setup\Installed Components`
* `HKLM\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components`
* `HKCU\SOFTWARE\Microsoft\Active Setup\Installed Components`
* `HKCU\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components`

Unutar ovih kljuƒçeva postoje razliƒçiti podkljuƒçevi, od kojih svaki odgovara odreƒëenom komponentu. Kljuƒçne vrednosti od posebnog interesa ukljuƒçuju:

* **IsInstalled:**
* `0` oznaƒçava da komanda komponente neƒáe biti izvr≈°ena.
* `1` znaƒçi da ƒáe se komanda izvr≈°iti jednom za svakog korisnika, ≈°to je podrazumevano pona≈°anje ako vrednost `IsInstalled` nedostaje.
* **StubPath:** Defini≈°e komandu koja ƒáe biti izvr≈°ena od strane Active Setup-a. Mo≈æe biti bilo koja validna komandna linija, kao ≈°to je pokretanje `notepad`.

**Security Insights:**

* Modifikovanje ili pisanje u kljuƒç gde je **`IsInstalled`** postavljen na `"1"` sa specifiƒçnim **`StubPath`** mo≈æe dovesti do neovla≈°ƒáenog izvr≈°avanja komandi, potencijalno za eskalaciju privilegija.
* Menjanje binarnog fajla na koji se poziva u bilo kojoj **`StubPath`** vrednosti takoƒëe mo≈æe postiƒái eskalaciju privilegija, uz dovoljno dozvola.

Da biste pregledali **`StubPath`** konfiguracije ≈°irom Active Setup komponenti, mogu se koristiti sledeƒáe komande:
```bash
reg query "HKLM\SOFTWARE\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKCU\SOFTWARE\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKCU\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components" /s /v StubPath
```
### Browser Helper Objects

### Overview of Browser Helper Objects (BHOs)

Browser Helper Objects (BHOs) su DLL moduli koji dodaju dodatne funkcije Microsoftovom Internet Exploreru. Uƒçitavaju se u Internet Explorer i Windows Explorer pri svakom pokretanju. Ipak, njihovo izvr≈°avanje mo≈æe biti blokirano postavljanjem **NoExplorer** kljuƒça na 1, spreƒçavajuƒái ih da se uƒçitavaju sa instancama Windows Explorera.

BHOs su kompatibilni sa Windows 10 putem Internet Explorer 11, ali nisu podr≈æani u Microsoft Edge, podrazumevanom pretra≈æivaƒçu u novijim verzijama Windows-a.

Da biste istra≈æili BHOs registrovane na sistemu, mo≈æete pregledati sledeƒáe registre:

* `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects`
* `HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects`

Svaki BHO je predstavljen svojim **CLSID** u registru, koji slu≈æi kao jedinstveni identifikator. Detaljne informacije o svakom CLSID-u mogu se naƒái pod `HKLM\SOFTWARE\Classes\CLSID\{<CLSID>}`.

Za upit BHOs u registru, mogu se koristiti sledeƒáe komande:
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects" /s
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects" /s
```
### Internet Explorer Extensions

* `HKLM\Software\Microsoft\Internet Explorer\Extensions`
* `HKLM\Software\Wow6432Node\Microsoft\Internet Explorer\Extensions`

Napomena da ƒáe registar sadr≈æati 1 novi unos registra za svaku dll i biƒáe predstavljen sa **CLSID**. Informacije o CLSID-u mo≈æete pronaƒái u `HKLM\SOFTWARE\Classes\CLSID\{<CLSID>}`

### Font Drivers

* `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers`
* `HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers`
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers"
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers'
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers'
```
### Open Command

* `HKLM\SOFTWARE\Classes\htmlfile\shell\open\command`
* `HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command`
```bash
reg query "HKLM\SOFTWARE\Classes\htmlfile\shell\open\command" /v ""
reg query "HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command" /v ""
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Classes\htmlfile\shell\open\command' -Name ""
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command' -Name ""
```
### Opcije izvr≈°avanja slika
```
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
HKLM\Software\Microsoft\Wow6432Node\Windows NT\CurrentVersion\Image File Execution Options
```
## SysInternals

Napomena da su sve lokacije gde mo≈æete pronaƒái autorune **veƒá pretra≈æene od strane**[ **winpeas.exe**](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe). Meƒëutim, za **opse≈æniju listu automatski izvr≈°enih** fajlova mo≈æete koristiti [autoruns ](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns)iz sysinternals:
```
autorunsc.exe -m -nobanner -a * -ct /accepteula
```
## Vi≈°e

**Pronaƒëite vi≈°e Autorun-a poput registrija na** [**https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2**](https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2)

## Reference

* [https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/#gref](https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/#gref)
* [https://attack.mitre.org/techniques/T1547/001/](https://attack.mitre.org/techniques/T1547/001/)
* [https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2](https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2)
* [https://www.itprotoday.com/cloud-computing/how-can-i-add-boot-option-starts-alternate-shell](https://www.itprotoday.com/cloud-computing/how-can-i-add-boot-option-starts-alternate-shell)

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty savet**: **prijavite se** za **Intigriti**, premium **bug bounty platformu koju su kreirali hakeri, za hakere**! Pridru≈æite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i poƒçnite da zaraƒëujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
Uƒçite i ve≈æbajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Uƒçite i ve≈æbajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr≈æite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
