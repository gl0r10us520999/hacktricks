# macOS è¿›ç¨‹æ»¥ç”¨

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## è¿›ç¨‹åŸºæœ¬ä¿¡æ¯

è¿›ç¨‹æ˜¯æ­£åœ¨è¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„å®ä¾‹ï¼Œä½†è¿›ç¨‹å¹¶ä¸è¿è¡Œä»£ç ï¼Œè¿™äº›æ˜¯çº¿ç¨‹ã€‚å› æ­¤ **è¿›ç¨‹åªæ˜¯è¿è¡Œçº¿ç¨‹çš„å®¹å™¨**ï¼Œæä¾›å†…å­˜ã€æè¿°ç¬¦ã€ç«¯å£ã€æƒé™...

ä¼ ç»Ÿä¸Šï¼Œè¿›ç¨‹æ˜¯åœ¨å…¶ä»–è¿›ç¨‹ä¸­å¯åŠ¨çš„ï¼ˆé™¤äº† PID 1ï¼‰ï¼Œé€šè¿‡è°ƒç”¨ **`fork`** åˆ›å»ºå½“å‰è¿›ç¨‹çš„ç²¾ç¡®å‰¯æœ¬ï¼Œç„¶å **å­è¿›ç¨‹** é€šå¸¸ä¼šè°ƒç”¨ **`execve`** æ¥åŠ è½½æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶è¿è¡Œå®ƒã€‚éšåï¼Œå¼•å…¥äº† **`vfork`** ä»¥åŠ å¿«æ­¤è¿‡ç¨‹è€Œæ— éœ€ä»»ä½•å†…å­˜å¤åˆ¶ã€‚\
ç„¶åå¼•å…¥äº† **`posix_spawn`**ï¼Œå°† **`vfork`** å’Œ **`execve`** ç»“åˆåœ¨ä¸€ä¸ªè°ƒç”¨ä¸­ï¼Œå¹¶æ¥å—æ ‡å¿—ï¼š

* `POSIX_SPAWN_RESETIDS`: å°†æœ‰æ•ˆ ID é‡ç½®ä¸ºçœŸå® ID
* `POSIX_SPAWN_SETPGROUP`: è®¾ç½®è¿›ç¨‹ç»„å½’å±
* `POSUX_SPAWN_SETSIGDEF`: è®¾ç½®ä¿¡å·é»˜è®¤è¡Œä¸º
* `POSIX_SPAWN_SETSIGMASK`: è®¾ç½®ä¿¡å·æ©ç 
* `POSIX_SPAWN_SETEXEC`: åœ¨åŒä¸€è¿›ç¨‹ä¸­æ‰§è¡Œï¼ˆç±»ä¼¼äº `execve`ï¼Œä½†æœ‰æ›´å¤šé€‰é¡¹ï¼‰
* `POSIX_SPAWN_START_SUSPENDED`: å¯åŠ¨æ—¶æŒ‚èµ·
* `_POSIX_SPAWN_DISABLE_ASLR`: å¯åŠ¨æ—¶ä¸ä½¿ç”¨ ASLR
* `_POSIX_SPAWN_NANO_ALLOCATOR:` ä½¿ç”¨ libmalloc çš„ Nano åˆ†é…å™¨
* `_POSIX_SPAWN_ALLOW_DATA_EXEC:` å…è®¸æ•°æ®æ®µçš„ `rwx`
* `POSIX_SPAWN_CLOEXEC_DEFAULT`: é»˜è®¤æƒ…å†µä¸‹åœ¨ exec(2) æ—¶å…³é—­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦
* `_POSIX_SPAWN_HIGH_BITS_ASLR:` éšæœºåŒ– ASLR æ»‘åŠ¨çš„é«˜ä½

æ­¤å¤–ï¼Œ`posix_spawn` å…è®¸æŒ‡å®šä¸€ä¸ª **`posix_spawnattr`** æ•°ç»„ï¼Œä»¥æ§åˆ¶ç”Ÿæˆè¿›ç¨‹çš„æŸäº›æ–¹é¢ï¼Œä»¥åŠ **`posix_spawn_file_actions`** æ¥ä¿®æ”¹æè¿°ç¬¦çš„çŠ¶æ€ã€‚

å½“è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå®ƒä¼šå‘ **çˆ¶è¿›ç¨‹å‘é€è¿”å›ä»£ç **ï¼ˆå¦‚æœçˆ¶è¿›ç¨‹å·²ç»ˆæ­¢ï¼Œåˆ™æ–°çˆ¶è¿›ç¨‹ä¸º PID 1ï¼‰ï¼Œå¹¶å‘é€ä¿¡å· `SIGCHLD`ã€‚çˆ¶è¿›ç¨‹éœ€è¦é€šè¿‡è°ƒç”¨ `wait4()` æˆ– `waitid()` æ¥è·å–æ­¤å€¼ï¼Œç›´åˆ°é‚£æ—¶ï¼Œå­è¿›ç¨‹ä¿æŒåœ¨åƒµå°¸çŠ¶æ€ï¼Œä»ç„¶è¢«åˆ—å‡ºä½†ä¸æ¶ˆè€—èµ„æºã€‚

### PIDs

PIDï¼Œè¿›ç¨‹æ ‡è¯†ç¬¦ï¼Œæ ‡è¯†ä¸€ä¸ªå”¯ä¸€çš„è¿›ç¨‹ã€‚åœ¨ XNU ä¸­ï¼Œ**PIDs** æ˜¯ **64 ä½**ï¼Œå•è°ƒé€’å¢ä¸” **æ°¸ä¸å›ç»•**ï¼ˆä»¥é¿å…æ»¥ç”¨ï¼‰ã€‚

### è¿›ç¨‹ç»„ã€ä¼šè¯ä¸è”ç›Ÿ

**è¿›ç¨‹** å¯ä»¥è¢«æ’å…¥åˆ° **ç»„** ä¸­ï¼Œä»¥ä¾¿æ›´å®¹æ˜“åœ°å¤„ç†å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œshell è„šæœ¬ä¸­çš„å‘½ä»¤å°†å¤„äºåŒä¸€è¿›ç¨‹ç»„ä¸­ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ kill ç­‰æ–¹å¼ **ä¸€èµ·å‘é€ä¿¡å·**ã€‚\
ä¹Ÿå¯ä»¥ **å°†è¿›ç¨‹åˆ†ç»„åˆ°ä¼šè¯ä¸­**ã€‚å½“è¿›ç¨‹å¯åŠ¨ä¼šè¯ï¼ˆ`setsid(2)`ï¼‰æ—¶ï¼Œå­è¿›ç¨‹è¢«è®¾ç½®åœ¨ä¼šè¯å†…ï¼Œé™¤éå®ƒä»¬å¯åŠ¨è‡ªå·±çš„ä¼šè¯ã€‚

è”ç›Ÿæ˜¯å¦ä¸€ç§åœ¨ Darwin ä¸­åˆ†ç»„è¿›ç¨‹çš„æ–¹å¼ã€‚åŠ å…¥è”ç›Ÿçš„è¿›ç¨‹å¯ä»¥è®¿é—®æ± èµ„æºï¼Œå…±äº«è´¦æœ¬æˆ–é¢å¯¹ Jetsamã€‚è”ç›Ÿæœ‰ä¸åŒçš„è§’è‰²ï¼šé¢†å¯¼è€…ã€XPC æœåŠ¡ã€æ‰©å±•ã€‚

### å‡­è¯ä¸è§’è‰²

æ¯ä¸ªè¿›ç¨‹æŒæœ‰ **å‡­è¯**ï¼Œä»¥ **è¯†åˆ«å…¶åœ¨ç³»ç»Ÿä¸­çš„æƒé™**ã€‚æ¯ä¸ªè¿›ç¨‹å°†æœ‰ä¸€ä¸ªä¸»è¦çš„ `uid` å’Œä¸€ä¸ªä¸»è¦çš„ `gid`ï¼ˆå°½ç®¡å¯èƒ½å±äºå¤šä¸ªç»„ï¼‰ã€‚\
å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶å…·æœ‰ `setuid/setgid` ä½ï¼Œä¹Ÿå¯ä»¥æ›´æ”¹ç”¨æˆ·å’Œç»„ IDã€‚\
æœ‰å‡ ä¸ªå‡½æ•°å¯ä»¥ **è®¾ç½®æ–°çš„ uids/gids**ã€‚

ç³»ç»Ÿè°ƒç”¨ **`persona`** æä¾›äº†ä¸€ç»„ **æ›¿ä»£** çš„ **å‡­è¯**ã€‚é‡‡ç”¨è§’è‰²ä¼šåŒæ—¶å‡è®¾å…¶ uidã€gid å’Œç»„æˆå‘˜èµ„æ ¼ã€‚åœ¨ [**æºä»£ç **](https://github.com/apple/darwin-xnu/blob/main/bsd/sys/persona.h) ä¸­å¯ä»¥æ‰¾åˆ°è¯¥ç»“æ„ï¼š
```c
struct kpersona_info { uint32_t persona_info_version;
uid_t    persona_id; /* overlaps with UID */
int      persona_type;
gid_t    persona_gid;
uint32_t persona_ngroups;
gid_t    persona_groups[NGROUPS];
uid_t    persona_gmuid;
char     persona_name[MAXLOGNAME + 1];

/* TODO: MAC policies?! */
}
```
## çº¿ç¨‹åŸºæœ¬ä¿¡æ¯

1. **POSIX çº¿ç¨‹ (pthreads):** macOS æ”¯æŒ POSIX çº¿ç¨‹ï¼ˆ`pthreads`ï¼‰ï¼Œè¿™æ˜¯ C/C++ çš„æ ‡å‡†çº¿ç¨‹ API çš„ä¸€éƒ¨åˆ†ã€‚macOS ä¸­ pthreads çš„å®ç°ä½äº `/usr/lib/system/libsystem_pthread.dylib`ï¼Œè¯¥åº“æ¥è‡ªå…¬å¼€å¯ç”¨çš„ `libpthread` é¡¹ç›®ã€‚æ­¤åº“æä¾›åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ‰€éœ€çš„å‡½æ•°ã€‚
2. **åˆ›å»ºçº¿ç¨‹:** `pthread_create()` å‡½æ•°ç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ã€‚å†…éƒ¨ï¼Œè¯¥å‡½æ•°è°ƒç”¨ `bsdthread_create()`ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹å®šäº XNU å†…æ ¸çš„ä½çº§ç³»ç»Ÿè°ƒç”¨ï¼ˆmacOS åŸºäºçš„å†…æ ¸ï¼‰ã€‚æ­¤ç³»ç»Ÿè°ƒç”¨æ¥å—æ¥è‡ª `pthread_attr`ï¼ˆå±æ€§ï¼‰çš„å„ç§æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—æŒ‡å®šçº¿ç¨‹è¡Œä¸ºï¼ŒåŒ…æ‹¬è°ƒåº¦ç­–ç•¥å’Œå †æ ˆå¤§å°ã€‚
* **é»˜è®¤å †æ ˆå¤§å°:** æ–°çº¿ç¨‹çš„é»˜è®¤å †æ ˆå¤§å°ä¸º 512 KBï¼Œè¶³ä»¥æ»¡è¶³å…¸å‹æ“ä½œï¼Œä½†å¦‚æœéœ€è¦æ›´å¤šæˆ–æ›´å°‘çš„ç©ºé—´ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹å±æ€§è¿›è¡Œè°ƒæ•´ã€‚
3. **çº¿ç¨‹åˆå§‹åŒ–:** `__pthread_init()` å‡½æ•°åœ¨çº¿ç¨‹è®¾ç½®è¿‡ç¨‹ä¸­è‡³å…³é‡è¦ï¼Œåˆ©ç”¨ `env[]` å‚æ•°è§£æç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å¯ä»¥åŒ…å«æœ‰å…³å †æ ˆä½ç½®å’Œå¤§å°çš„è¯¦ç»†ä¿¡æ¯ã€‚

#### macOS ä¸­çš„çº¿ç¨‹ç»ˆæ­¢

1. **é€€å‡ºçº¿ç¨‹:** çº¿ç¨‹é€šå¸¸é€šè¿‡è°ƒç”¨ `pthread_exit()` æ¥ç»ˆæ­¢ã€‚æ­¤å‡½æ•°å…è®¸çº¿ç¨‹å¹²å‡€åœ°é€€å‡ºï¼Œæ‰§è¡Œå¿…è¦çš„æ¸…ç†ï¼Œå¹¶å…è®¸çº¿ç¨‹å°†è¿”å›å€¼å‘é€å›ä»»ä½•åŠ å…¥è€…ã€‚
2. **çº¿ç¨‹æ¸…ç†:** è°ƒç”¨ `pthread_exit()` åï¼Œå°†è°ƒç”¨ `pthread_terminate()` å‡½æ•°ï¼Œè¯¥å‡½æ•°å¤„ç†æ‰€æœ‰ç›¸å…³çº¿ç¨‹ç»“æ„çš„ç§»é™¤ã€‚å®ƒä¼šé‡Šæ”¾ Mach çº¿ç¨‹ç«¯å£ï¼ˆMach æ˜¯ XNU å†…æ ¸ä¸­çš„é€šä¿¡å­ç³»ç»Ÿï¼‰ï¼Œå¹¶è°ƒç”¨ `bsdthread_terminate`ï¼Œè¿™æ˜¯ä¸€ä¸ªç§»é™¤ä¸çº¿ç¨‹ç›¸å…³çš„å†…æ ¸çº§ç»“æ„çš„ç³»ç»Ÿè°ƒç”¨ã€‚

#### åŒæ­¥æœºåˆ¶

ä¸ºäº†ç®¡ç†å¯¹å…±äº«èµ„æºçš„è®¿é—®å¹¶é¿å…ç«äº‰æ¡ä»¶ï¼ŒmacOS æä¾›äº†å‡ ç§åŒæ­¥åŸè¯­ã€‚è¿™äº›åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯¹äºç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œç³»ç»Ÿç¨³å®šæ€§è‡³å…³é‡è¦ï¼š

1. **äº’æ–¥é”:**
* **å¸¸è§„äº’æ–¥é” (ç­¾å: 0x4D555458):** æ ‡å‡†äº’æ–¥é”ï¼Œå†…å­˜å ç”¨ä¸º 60 å­—èŠ‚ï¼ˆ56 å­—èŠ‚ç”¨äºäº’æ–¥é”ï¼Œ4 å­—èŠ‚ç”¨äºç­¾åï¼‰ã€‚
* **å¿«é€Ÿäº’æ–¥é” (ç­¾å: 0x4d55545A):** ç±»ä¼¼äºå¸¸è§„äº’æ–¥é”ï¼Œä½†ç»è¿‡ä¼˜åŒ–ä»¥å®ç°æ›´å¿«çš„æ“ä½œï¼Œå¤§å°ä¹Ÿä¸º 60 å­—èŠ‚ã€‚
2. **æ¡ä»¶å˜é‡:**
* ç”¨äºç­‰å¾…æŸäº›æ¡ä»¶å‘ç”Ÿï¼Œå¤§å°ä¸º 44 å­—èŠ‚ï¼ˆ40 å­—èŠ‚åŠ  4 å­—èŠ‚ç­¾åï¼‰ã€‚
* **æ¡ä»¶å˜é‡å±æ€§ (ç­¾å: 0x434e4441):** æ¡ä»¶å˜é‡çš„é…ç½®å±æ€§ï¼Œå¤§å°ä¸º 12 å­—èŠ‚ã€‚
3. **ä¸€æ¬¡å˜é‡ (ç­¾å: 0x4f4e4345):**
* ç¡®ä¿ä¸€æ®µåˆå§‹åŒ–ä»£ç ä»…æ‰§è¡Œä¸€æ¬¡ã€‚å…¶å¤§å°ä¸º 12 å­—èŠ‚ã€‚
4. **è¯»å†™é”:**
* å…è®¸å¤šä¸ªè¯»è€…æˆ–ä¸€ä¸ªå†™è€…åŒæ—¶è®¿é—®ï¼Œä¿ƒè¿›å¯¹å…±äº«æ•°æ®çš„é«˜æ•ˆè®¿é—®ã€‚
* **è¯»å†™é” (ç­¾å: 0x52574c4b):** å¤§å°ä¸º 196 å­—èŠ‚ã€‚
* **è¯»å†™é”å±æ€§ (ç­¾å: 0x52574c41):** è¯»å†™é”çš„å±æ€§ï¼Œå¤§å°ä¸º 20 å­—èŠ‚ã€‚

{% hint style="success" %}
è¿™äº›å¯¹è±¡çš„æœ€å 4 å­—èŠ‚ç”¨äºæ£€æµ‹æº¢å‡ºã€‚
{% endhint %}

### çº¿ç¨‹å±€éƒ¨å˜é‡ (TLV)

**çº¿ç¨‹å±€éƒ¨å˜é‡ (TLV)** åœ¨ Mach-O æ–‡ä»¶ï¼ˆmacOS ä¸­å¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ï¼‰çš„ä¸Šä¸‹æ–‡ä¸­ç”¨äºå£°æ˜ç‰¹å®šäº **æ¯ä¸ªçº¿ç¨‹** çš„å˜é‡ï¼Œä»¥ä¾¿åœ¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚è¿™ç¡®ä¿æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡å®ä¾‹ï¼Œæä¾›äº†ä¸€ç§é¿å…å†²çªå’Œç»´æŠ¤æ•°æ®å®Œæ•´æ€§çš„æ–¹æ³•ï¼Œè€Œæ— éœ€åƒäº’æ–¥é”é‚£æ ·çš„æ˜¾å¼åŒæ­¥æœºåˆ¶ã€‚

åœ¨ C åŠç›¸å…³è¯­è¨€ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ **`__thread`** å…³é”®å­—å£°æ˜çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ä»¥ä¸‹æ˜¯å®ƒåœ¨æ‚¨çš„ç¤ºä¾‹ä¸­çš„å·¥ä½œæ–¹å¼ï¼š
```c
cCopy code__thread int tlv_var;

void main (int argc, char **argv){
tlv_var = 10;
}
```
è¿™ä¸ªç‰‡æ®µå°† `tlv_var` å®šä¹‰ä¸ºçº¿ç¨‹å±€éƒ¨å˜é‡ã€‚æ¯ä¸ªè¿è¡Œæ­¤ä»£ç çš„çº¿ç¨‹å°†æ‹¥æœ‰è‡ªå·±çš„ `tlv_var`ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ `tlv_var` çš„æ›´æ”¹ä¸ä¼šå½±å“å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ `tlv_var`ã€‚

åœ¨ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä¸çº¿ç¨‹å±€éƒ¨å˜é‡ç›¸å…³çš„æ•°æ®è¢«ç»„ç»‡æˆç‰¹å®šçš„éƒ¨åˆ†ï¼š

* **`__DATA.__thread_vars`**ï¼šæ­¤éƒ¨åˆ†åŒ…å«æœ‰å…³çº¿ç¨‹å±€éƒ¨å˜é‡çš„å…ƒæ•°æ®ï¼Œå¦‚å®ƒä»¬çš„ç±»å‹å’Œåˆå§‹åŒ–çŠ¶æ€ã€‚
* **`__DATA.__thread_bss`**ï¼šæ­¤éƒ¨åˆ†ç”¨äºæœªæ˜¾å¼åˆå§‹åŒ–çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚å®ƒæ˜¯ä¸ºé›¶åˆå§‹åŒ–æ•°æ®ä¿ç•™çš„å†…å­˜çš„ä¸€éƒ¨åˆ†ã€‚

Mach-O è¿˜æä¾›äº†ä¸€ä¸ªç‰¹å®šçš„ APIï¼Œç§°ä¸º **`tlv_atexit`**ï¼Œç”¨äºç®¡ç†çº¿ç¨‹é€€å‡ºæ—¶çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚æ­¤ API å…è®¸æ‚¨ **æ³¨å†Œææ„å‡½æ•°**â€”â€”åœ¨çº¿ç¨‹ç»ˆæ­¢æ—¶æ¸…ç†çº¿ç¨‹å±€éƒ¨æ•°æ®çš„ç‰¹æ®Šå‡½æ•°ã€‚

### çº¿ç¨‹ä¼˜å…ˆçº§

ç†è§£çº¿ç¨‹ä¼˜å…ˆçº§æ¶‰åŠæŸ¥çœ‹æ“ä½œç³»ç»Ÿå¦‚ä½•å†³å®šè¿è¡Œå“ªäº›çº¿ç¨‹ä»¥åŠä½•æ—¶è¿è¡Œã€‚è¿™ä¸€å†³å®šå—åˆ°åˆ†é…ç»™æ¯ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§çº§åˆ«çš„å½±å“ã€‚åœ¨ macOS å’Œç±» Unix ç³»ç»Ÿä¸­ï¼Œè¿™é€šè¿‡ `nice`ã€`renice` å’ŒæœåŠ¡è´¨é‡ (QoS) ç±»ç­‰æ¦‚å¿µæ¥å¤„ç†ã€‚

#### Nice å’Œ Renice

1. **Nice:**
* è¿›ç¨‹çš„ `nice` å€¼æ˜¯ä¸€ä¸ªå½±å“å…¶ä¼˜å…ˆçº§çš„æ•°å­—ã€‚æ¯ä¸ªè¿›ç¨‹çš„ nice å€¼èŒƒå›´ä» -20ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰åˆ° 19ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ã€‚è¿›ç¨‹åˆ›å»ºæ—¶çš„é»˜è®¤ nice å€¼é€šå¸¸ä¸º 0ã€‚
* è¾ƒä½çš„ nice å€¼ï¼ˆæ¥è¿‘ -20ï¼‰ä½¿è¿›ç¨‹å˜å¾—æ›´åŠ â€œè‡ªç§â€ï¼Œç›¸å¯¹äºå…¶ä»–å…·æœ‰è¾ƒé«˜ nice å€¼çš„è¿›ç¨‹ï¼Œç»™äºˆå…¶æ›´å¤šçš„ CPU æ—¶é—´ã€‚
2. **Renice:**
* `renice` æ˜¯ä¸€ä¸ªç”¨äºæ›´æ”¹å·²è¿è¡Œè¿›ç¨‹çš„ nice å€¼çš„å‘½ä»¤ã€‚è¿™å¯ä»¥ç”¨äºåŠ¨æ€è°ƒæ•´è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼ŒåŸºäºæ–°çš„ nice å€¼å¢åŠ æˆ–å‡å°‘å…¶ CPU æ—¶é—´åˆ†é…ã€‚
* ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹æš‚æ—¶éœ€è¦æ›´å¤šçš„ CPU èµ„æºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `renice` é™ä½å…¶ nice å€¼ã€‚

#### æœåŠ¡è´¨é‡ (QoS) ç±»

QoS ç±»æ˜¯å¤„ç†çº¿ç¨‹ä¼˜å…ˆçº§çš„æ›´ç°ä»£çš„æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åœ¨æ”¯æŒ **Grand Central Dispatch (GCD)** çš„ç³»ç»Ÿä¸­ã€‚QoS ç±»å…è®¸å¼€å‘äººå‘˜æ ¹æ®ä»»åŠ¡çš„é‡è¦æ€§æˆ–ç´§æ€¥æ€§å°†å·¥ä½œ **åˆ†ç±»** ä¸ºä¸åŒçº§åˆ«ã€‚macOS æ ¹æ®è¿™äº› QoS ç±»è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ä¼˜å…ˆçº§ï¼š

1. **ç”¨æˆ·äº¤äº’ï¼š**
* æ­¤ç±»ç”¨äºå½“å‰ä¸ç”¨æˆ·äº¤äº’æˆ–éœ€è¦ç«‹å³ç»“æœä»¥æä¾›è‰¯å¥½ç”¨æˆ·ä½“éªŒçš„ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡è¢«èµ‹äºˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œä»¥ä¿æŒç•Œé¢çš„å“åº”æ€§ï¼ˆä¾‹å¦‚ï¼ŒåŠ¨ç”»æˆ–äº‹ä»¶å¤„ç†ï¼‰ã€‚
2. **ç”¨æˆ·å¯åŠ¨ï¼š**
* ç”¨æˆ·å¯åŠ¨å¹¶æœŸæœ›ç«‹å³ç»“æœçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ‰“å¼€æ–‡æ¡£æˆ–å•å‡»éœ€è¦è®¡ç®—çš„æŒ‰é’®ã€‚è¿™äº›ä»»åŠ¡ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œä½†ä½äºç”¨æˆ·äº¤äº’ã€‚
3. **å®ç”¨ç¨‹åºï¼š**
* è¿™äº›ä»»åŠ¡æ˜¯é•¿æ—¶é—´è¿è¡Œçš„ï¼Œé€šå¸¸æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆä¾‹å¦‚ï¼Œä¸‹è½½æ–‡ä»¶ã€å¯¼å…¥æ•°æ®ï¼‰ã€‚å®ƒä»¬çš„ä¼˜å…ˆçº§ä½äºç”¨æˆ·å¯åŠ¨çš„ä»»åŠ¡ï¼Œä¸éœ€è¦ç«‹å³å®Œæˆã€‚
4. **åå°ï¼š**
* æ­¤ç±»ç”¨äºåœ¨åå°è¿è¡Œä¸”å¯¹ç”¨æˆ·ä¸å¯è§çš„ä»»åŠ¡ã€‚è¿™äº›å¯ä»¥æ˜¯ç´¢å¼•ã€åŒæ­¥æˆ–å¤‡ä»½ç­‰ä»»åŠ¡ã€‚å®ƒä»¬çš„ä¼˜å…ˆçº§æœ€ä½ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“æœ€å°ã€‚

ä½¿ç”¨ QoS ç±»ï¼Œå¼€å‘äººå‘˜ä¸éœ€è¦ç®¡ç†ç¡®åˆ‡çš„ä¼˜å…ˆçº§æ•°å­—ï¼Œè€Œæ˜¯ä¸“æ³¨äºä»»åŠ¡çš„æ€§è´¨ï¼Œç³»ç»Ÿä¼šç›¸åº”ä¼˜åŒ– CPU èµ„æºã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸åŒçš„ **çº¿ç¨‹è°ƒåº¦ç­–ç•¥**ï¼Œç”¨äºæŒ‡å®šè°ƒåº¦å™¨å°†è€ƒè™‘çš„ä¸€ç»„è°ƒåº¦å‚æ•°ã€‚è¿™å¯ä»¥é€šè¿‡ `thread_policy_[set/get]` æ¥å®Œæˆã€‚è¿™åœ¨ç«äº‰æ¡ä»¶æ”»å‡»ä¸­å¯èƒ½ä¼šå¾ˆæœ‰ç”¨ã€‚

## MacOS è¿›ç¨‹æ»¥ç”¨

MacOS åƒå…¶ä»–æ“ä½œç³»ç»Ÿä¸€æ ·ï¼Œæä¾›å¤šç§æ–¹æ³•å’Œæœºåˆ¶ä¾› **è¿›ç¨‹äº¤äº’ã€é€šä¿¡å’Œå…±äº«æ•°æ®**ã€‚è™½ç„¶è¿™äº›æŠ€æœ¯å¯¹ç³»ç»Ÿçš„é«˜æ•ˆè¿è¡Œè‡³å…³é‡è¦ï¼Œä½†ä¹Ÿå¯èƒ½è¢«å¨èƒè¡Œä¸ºè€…æ»¥ç”¨ä»¥ **æ‰§è¡Œæ¶æ„æ´»åŠ¨**ã€‚

### åº“æ³¨å…¥

åº“æ³¨å…¥æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œæ”»å‡»è€… **å¼ºåˆ¶è¿›ç¨‹åŠ è½½æ¶æ„åº“**ã€‚ä¸€æ—¦æ³¨å…¥ï¼Œåº“å°†åœ¨ç›®æ ‡è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œæ”»å‡»è€…å°†è·å¾—ä¸è¯¥è¿›ç¨‹ç›¸åŒçš„æƒé™å’Œè®¿é—®æƒé™ã€‚

{% content-ref url="macos-library-injection/" %}
[macos-library-injection](macos-library-injection/)
{% endcontent-ref %}

### å‡½æ•°é’©å­

å‡½æ•°é’©å­æ¶‰åŠ **æ‹¦æˆªè½¯ä»¶ä»£ç ä¸­çš„å‡½æ•°è°ƒç”¨** æˆ–æ¶ˆæ¯ã€‚é€šè¿‡é’©ä½å‡½æ•°ï¼Œæ”»å‡»è€…å¯ä»¥ **ä¿®æ”¹è¿›ç¨‹çš„è¡Œä¸º**ã€è§‚å¯Ÿæ•æ„Ÿæ•°æ®ï¼Œç”šè‡³æ§åˆ¶æ‰§è¡Œæµç¨‹ã€‚

{% content-ref url="macos-function-hooking.md" %}
[macos-function-hooking.md](macos-function-hooking.md)
{% endcontent-ref %}

### è¿›ç¨‹é—´é€šä¿¡

è¿›ç¨‹é—´é€šä¿¡ (IPC) æŒ‡çš„æ˜¯ä¸åŒæ–¹æ³•ï¼Œé€šè¿‡è¿™äº›æ–¹æ³•ï¼Œç‹¬ç«‹è¿›ç¨‹ **å…±äº«å’Œäº¤æ¢æ•°æ®**ã€‚è™½ç„¶ IPC å¯¹è®¸å¤šåˆæ³•åº”ç”¨ç¨‹åºè‡³å…³é‡è¦ï¼Œä½†ä¹Ÿå¯èƒ½è¢«æ»¥ç”¨ä»¥ç ´åè¿›ç¨‹éš”ç¦»ã€æ³„éœ²æ•æ„Ÿä¿¡æ¯æˆ–æ‰§è¡Œæœªç»æˆæƒçš„æ“ä½œã€‚

{% content-ref url="macos-ipc-inter-process-communication/" %}
[macos-ipc-inter-process-communication](macos-ipc-inter-process-communication/)
{% endcontent-ref %}

### Electron åº”ç”¨ç¨‹åºæ³¨å…¥

ä½¿ç”¨ç‰¹å®šç¯å¢ƒå˜é‡æ‰§è¡Œçš„ Electron åº”ç”¨ç¨‹åºå¯èƒ½å®¹æ˜“å—åˆ°è¿›ç¨‹æ³¨å…¥çš„æ”»å‡»ï¼š

{% content-ref url="macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](macos-electron-applications-injection.md)
{% endcontent-ref %}

### Chromium æ³¨å…¥

å¯ä»¥ä½¿ç”¨æ ‡å¿— `--load-extension` å’Œ `--use-fake-ui-for-media-stream` æ‰§è¡Œ **æµè§ˆå™¨ä¸­çš„ä¸­é—´äººæ”»å‡»**ï¼Œä»è€Œçªƒå–å‡»é”®ã€æµé‡ã€cookieï¼Œåœ¨é¡µé¢ä¸­æ³¨å…¥è„šæœ¬...ï¼š

{% content-ref url="macos-chromium-injection.md" %}
[macos-chromium-injection.md](macos-chromium-injection.md)
{% endcontent-ref %}

### è„ NIB

NIB æ–‡ä»¶ **å®šä¹‰ç”¨æˆ·ç•Œé¢ (UI) å…ƒç´ ** åŠå…¶åœ¨åº”ç”¨ç¨‹åºä¸­çš„äº¤äº’ã€‚ç„¶è€Œï¼Œå®ƒä»¬å¯ä»¥ **æ‰§è¡Œä»»æ„å‘½ä»¤**ï¼Œè€Œä¸” **Gatekeeper ä¸ä¼šé˜»æ­¢** å·²æ‰§è¡Œçš„åº”ç”¨ç¨‹åºåœ¨ **NIB æ–‡ä»¶è¢«ä¿®æ”¹** åå†æ¬¡æ‰§è¡Œã€‚å› æ­¤ï¼Œå®ƒä»¬å¯ä»¥ç”¨äºä½¿ä»»æ„ç¨‹åºæ‰§è¡Œä»»æ„å‘½ä»¤ï¼š

{% content-ref url="macos-dirty-nib.md" %}
[macos-dirty-nib.md](macos-dirty-nib.md)
{% endcontent-ref %}

### Java åº”ç”¨ç¨‹åºæ³¨å…¥

å¯ä»¥æ»¥ç”¨æŸäº› Java åŠŸèƒ½ï¼ˆå¦‚ **`_JAVA_OPTS`** ç¯å¢ƒå˜é‡ï¼‰ä½¿ Java åº”ç”¨ç¨‹åºæ‰§è¡Œ **ä»»æ„ä»£ç /å‘½ä»¤**ã€‚

{% content-ref url="macos-java-apps-injection.md" %}
[macos-java-apps-injection.md](macos-java-apps-injection.md)
{% endcontent-ref %}

### .Net åº”ç”¨ç¨‹åºæ³¨å…¥

å¯ä»¥é€šè¿‡ **æ»¥ç”¨ .Net è°ƒè¯•åŠŸèƒ½**ï¼ˆä¸å— macOS ä¿æŠ¤ï¼Œå¦‚è¿è¡Œæ—¶å¼ºåŒ–ï¼‰å‘ .Net åº”ç”¨ç¨‹åºæ³¨å…¥ä»£ç ã€‚

{% content-ref url="macos-.net-applications-injection.md" %}
[macos-.net-applications-injection.md](macos-.net-applications-injection.md)
{% endcontent-ref %}

### Perl æ³¨å…¥

æ£€æŸ¥ä¸åŒé€‰é¡¹ä»¥ä½¿ Perl è„šæœ¬æ‰§è¡Œä»»æ„ä»£ç ï¼š

{% content-ref url="macos-perl-applications-injection.md" %}
[macos-perl-applications-injection.md](macos-perl-applications-injection.md)
{% endcontent-ref %}

### Ruby æ³¨å…¥

ä¹Ÿå¯ä»¥æ»¥ç”¨ Ruby ç¯å¢ƒå˜é‡ä½¿ä»»æ„è„šæœ¬æ‰§è¡Œä»»æ„ä»£ç ï¼š

{% content-ref url="macos-ruby-applications-injection.md" %}
[macos-ruby-applications-injection.md](macos-ruby-applications-injection.md)
{% endcontent-ref %}

### Python æ³¨å…¥

å¦‚æœç¯å¢ƒå˜é‡ **`PYTHONINSPECT`** è¢«è®¾ç½®ï¼ŒPython è¿›ç¨‹å°†åœ¨å®Œæˆåè¿›å…¥ Python CLIã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ **`PYTHONSTARTUP`** æŒ‡å®šåœ¨äº¤äº’ä¼šè¯å¼€å§‹æ—¶æ‰§è¡Œçš„ Python è„šæœ¬ã€‚\
ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œå½“ **`PYTHONINSPECT`** åˆ›å»ºäº¤äº’ä¼šè¯æ—¶ï¼Œ**`PYTHONSTARTUP`** è„šæœ¬ä¸ä¼šè¢«æ‰§è¡Œã€‚

å…¶ä»–ç¯å¢ƒå˜é‡å¦‚ **`PYTHONPATH`** å’Œ **`PYTHONHOME`** ä¹Ÿå¯èƒ½å¯¹ä½¿ Python å‘½ä»¤æ‰§è¡Œä»»æ„ä»£ç æœ‰ç”¨ã€‚

è¯·æ³¨æ„ï¼Œä½¿ç”¨ **`pyinstaller`** ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶å³ä½¿åœ¨ä½¿ç”¨åµŒå…¥å¼ Python è¿è¡Œæ—¶ä¹Ÿä¸ä¼šä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡ã€‚

{% hint style="danger" %}
æ€»ä½“è€Œè¨€ï¼Œæˆ‘æ‰¾ä¸åˆ°é€šè¿‡æ»¥ç”¨ç¯å¢ƒå˜é‡ä½¿ Python æ‰§è¡Œä»»æ„ä»£ç çš„æ–¹æ³•ã€‚\
ç„¶è€Œï¼Œå¤§å¤šæ•°äººä½¿ç”¨ **Hombrew** å®‰è£… Pythonï¼Œè¿™å°†åœ¨ **å¯å†™ä½ç½®** ä¸ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å®‰è£… Pythonã€‚æ‚¨å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹å¼åŠ«æŒå®ƒï¼š
```bash
mv /opt/homebrew/bin/python3 /opt/homebrew/bin/python3.old
cat > /opt/homebrew/bin/python3 <<EOF
#!/bin/bash
# Extra hijack code
/opt/homebrew/bin/python3.old "$@"
EOF
chmod +x /opt/homebrew/bin/python3
```
å³ä½¿**root**åœ¨è¿è¡Œpythonæ—¶ä¹Ÿä¼šè¿è¡Œæ­¤ä»£ç ã€‚  
{% endhint %}

## æ£€æµ‹

### Shield

[**Shield**](https://theevilbit.github.io/shield/) ([**Github**](https://github.com/theevilbit/Shield)) æ˜¯ä¸€ä¸ªå¼€æºåº”ç”¨ç¨‹åºï¼Œå¯ä»¥**æ£€æµ‹å’Œé˜»æ­¢è¿›ç¨‹æ³¨å…¥**æ“ä½œï¼š

* ä½¿ç”¨**ç¯å¢ƒå˜é‡**ï¼šå®ƒå°†ç›‘æ§ä»¥ä¸‹ç¯å¢ƒå˜é‡çš„å­˜åœ¨ï¼š**`DYLD_INSERT_LIBRARIES`**ã€**`CFNETWORK_LIBRARY_PATH`**ã€**`RAWCAMERA_BUNDLE_PATH`**å’Œ**`ELECTRON_RUN_AS_NODE`**
* ä½¿ç”¨**`task_for_pid`**è°ƒç”¨ï¼šæŸ¥æ‰¾ä¸€ä¸ªè¿›ç¨‹ä½•æ—¶æƒ³è¦è·å–**å¦ä¸€ä¸ªè¿›ç¨‹çš„ä»»åŠ¡ç«¯å£**ï¼Œè¿™å…è®¸åœ¨è¯¥è¿›ç¨‹ä¸­æ³¨å…¥ä»£ç ã€‚
* **Electronåº”ç”¨å‚æ•°**ï¼šæœ‰äººå¯ä»¥ä½¿ç”¨**`--inspect`**ã€**`--inspect-brk`**å’Œ**`--remote-debugging-port`**å‘½ä»¤è¡Œå‚æ•°ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨Electronåº”ç”¨ï¼Œä»è€Œå‘å…¶æ³¨å…¥ä»£ç ã€‚
* ä½¿ç”¨**ç¬¦å·é“¾æ¥**æˆ–**ç¡¬é“¾æ¥**ï¼šé€šå¸¸æœ€å¸¸è§çš„æ»¥ç”¨æ˜¯**ä»¥æˆ‘ä»¬çš„ç”¨æˆ·æƒé™æ”¾ç½®ä¸€ä¸ªé“¾æ¥**ï¼Œå¹¶**æŒ‡å‘æ›´é«˜æƒé™**çš„ä½ç½®ã€‚å¯¹äºç¡¬é“¾æ¥å’Œç¬¦å·é“¾æ¥ï¼Œæ£€æµ‹éå¸¸ç®€å•ã€‚å¦‚æœåˆ›å»ºé“¾æ¥çš„è¿›ç¨‹ä¸ç›®æ ‡æ–‡ä»¶å…·æœ‰**ä¸åŒçš„æƒé™çº§åˆ«**ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª**è­¦æŠ¥**ã€‚ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ç¬¦å·é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œæ— æ³•é˜»æ­¢ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºä¹‹å‰æ²¡æœ‰å…³äºé“¾æ¥ç›®æ ‡çš„ä¿¡æ¯ã€‚è¿™æ˜¯Appleçš„EndpointSecurityæ¡†æ¶çš„ä¸€ä¸ªé™åˆ¶ã€‚

### å…¶ä»–è¿›ç¨‹å‘å‡ºçš„è°ƒç”¨

åœ¨[**è¿™ç¯‡åšå®¢æ–‡ç« **](https://knight.sc/reverse%20engineering/2019/04/15/detecting-task-modifications.html)ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å¦‚ä½•ä½¿ç”¨å‡½æ•°**`task_name_for_pid`**è·å–å…³äºå…¶ä»–**è¿›ç¨‹åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ³¨å…¥ä»£ç **çš„ä¿¡æ¯ï¼Œç„¶åè·å–å…³äºè¯¥å…¶ä»–è¿›ç¨‹çš„ä¿¡æ¯ã€‚

è¯·æ³¨æ„ï¼Œè¦è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ‚¨éœ€è¦ä¸è¿è¡Œè¯¥è¿›ç¨‹çš„**ç›¸åŒuid**æˆ–**root**ï¼ˆå¹¶ä¸”å®ƒè¿”å›å…³äºè¯¥è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ³¨å…¥ä»£ç çš„æ–¹æ³•ï¼‰ã€‚

## å‚è€ƒ

* [https://theevilbit.github.io/shield/](https://theevilbit.github.io/shield/)
* [https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
