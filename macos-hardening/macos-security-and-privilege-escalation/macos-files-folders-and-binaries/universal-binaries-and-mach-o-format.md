# macOS Universal binaries & Mach-O Format

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Mac OS рдмрд╛рдЗрдирд░реА рдЖрдорддреМрд░ рдкрд░ **рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реА** рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрдХрд▓рд┐рдд рд╣реЛрддреА рд╣реИрдВред рдПрдХ **рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реА** **рдПрдХ рд╣реА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХрдИ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░ рд╕рдХрддреА рд╣реИ**ред

рдпреЗ рдмрд╛рдЗрдирд░реА **Mach-O рд╕рдВрд░рдЪрдирд╛** рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреА рд╣реИрдВ рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗ рдмрдиреА рд╣реЛрддреА рд╣реИ:

* рд╣реЗрдбрд░
* рд▓реЛрдб рдХрдорд╛рдВрдб
* рдбреЗрдЯрд╛

![https://alexdremov.me/content/images/2022/10/6XLCD.gif](<../../../.gitbook/assets/image (470).png>)

## Fat Header

рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдЦреЛрдЬреЗрдВ: `mdfind fat.h | grep -i mach-o | grep -E "fat.h$"`

<pre class="language-c"><code class="lang-c"><strong>#define FAT_MAGIC	0xcafebabe
</strong><strong>#define FAT_CIGAM	0xbebafeca	/* NXSwapLong(FAT_MAGIC) */
</strong>
struct fat_header {
<strong>	uint32_t	magic;		/* FAT_MAGIC рдпрд╛ FAT_MAGIC_64 */
</strong><strong>	uint32_t	nfat_arch;	/* рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдЬреЛ рдЖрдЧреЗ рдЖрддреА рд╣реИрдВ */
</strong>};

struct fat_arch {
cpu_type_t	cputype;	/* cpu рдирд┐рд░реНрджрд┐рд╖реНрдЯрдХ (int) */
cpu_subtype_t	cpusubtype;	/* рдорд╢реАрди рдирд┐рд░реНрджрд┐рд╖реНрдЯрдХ (int) */
uint32_t	offset;		/* рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓ рдСрдлрд╝рд╕реЗрдЯ */
uint32_t	size;		/* рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЖрдХрд╛рд░ */
uint32_t	align;		/* 2 рдХреА рд╢рдХреНрддрд┐ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрд░реЗрдЦрдг */
};
</code></pre>

рд╣реЗрдбрд░ рдореЗрдВ **рдЬрд╛рджреБрдИ** рдмрд╛рдЗрдЯреНрд╕ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдмрд╛рдж **рд╕рдВрдЦреНрдпрд╛рдПрдБ** рд╣реЛрддреА рд╣реИрдВ **рдЖрд░реНрдХреНрд╕** рдЬреЛ рдлрд╝рд╛рдЗрд▓ **рдореЗрдВ рд╣реИрдВ** (`nfat_arch`) рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдЖрд░реНрдХ рдХреЗ рдкрд╛рд╕ рдПрдХ `fat_arch` рд╕рдВрд░рдЪрдирд╛ рд╣реЛрдЧреАред

рдЗрд╕реЗ рдЬрд╛рдВрдЪреЗрдВ:

<pre class="language-shell-session"><code class="lang-shell-session">% file /bin/ls
/bin/ls: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/bin/ls (for architecture x86_64):	Mach-O 64-bit executable x86_64
/bin/ls (for architecture arm64e):	Mach-O 64-bit executable arm64e

% otool -f -v /bin/ls
Fat headers
fat_magic FAT_MAGIC
<strong>nfat_arch 2
</strong><strong>architecture x86_64
</strong>    cputype CPU_TYPE_X86_64
cpusubtype CPU_SUBTYPE_X86_64_ALL
capabilities 0x0
<strong>    offset 16384
</strong><strong>    size 72896
</strong>    align 2^14 (16384)
<strong>architecture arm64e
</strong>    cputype CPU_TYPE_ARM64
cpusubtype CPU_SUBTYPE_ARM64E
capabilities PTR_AUTH_VERSION USERSPACE 0
<strong>    offset 98304
</strong><strong>    size 88816
</strong>    align 2^14 (16384)
</code></pre>

рдпрд╛ [Mach-O View](https://sourceforge.net/projects/machoview/) рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

<figure><img src="../../../.gitbook/assets/image (1094).png" alt=""><figcaption></figcaption></figure>

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд╕реЛрдЪ рд░рд╣реЗ рд╣реЛрдВрдЧреЗ, рдЖрдорддреМрд░ рдкрд░ 2 рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рд╕рдВрдХрд▓рд┐рдд рдПрдХ рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реА **рдПрдХ рдЖрд░реНрдХ рдХреЗ рд▓рд┐рдП рд╕рдВрдХрд▓рд┐рдд рдмрд╛рдЗрдирд░реА рдХреЗ рдЖрдХрд╛рд░ рдХреЛ рджреЛрдЧреБрдирд╛ рдХрд░ рджреЗрддреА рд╣реИ**ред

## **Mach-O Header**

рд╣реЗрдбрд░ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреБрдирд┐рдпрд╛рджреА рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдЗрд╕реЗ Mach-O рдлрд╝рд╛рдЗрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╛рджреБрдИ рдмрд╛рдЗрдЯреНрд╕ рдФрд░ рд▓рдХреНрд╖рд┐рдд рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реАред рдЖрдк рдЗрд╕реЗ рдпрд╣рд╛рдБ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `mdfind loader.h | grep -i mach-o | grep -E "loader.h$"`
```c
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */
struct mach_header {
uint32_t	magic;		/* mach magic number identifier */
cpu_type_t	cputype;	/* cpu specifier (e.g. I386) */
cpu_subtype_t	cpusubtype;	/* machine specifier */
uint32_t	filetype;	/* type of file (usage and alignment for the file) */
uint32_t	ncmds;		/* number of load commands */
uint32_t	sizeofcmds;	/* the size of all the load commands */
uint32_t	flags;		/* flags */
};

#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */
#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */
struct mach_header_64 {
uint32_t	magic;		/* mach magic number identifier */
int32_t		cputype;	/* cpu specifier */
int32_t		cpusubtype;	/* machine specifier */
uint32_t	filetype;	/* type of file */
uint32_t	ncmds;		/* number of load commands */
uint32_t	sizeofcmds;	/* the size of all the load commands */
uint32_t	flags;		/* flags */
uint32_t	reserved;	/* reserved */
};
```
### Mach-O рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдХрд╛рд░

рд╡рд┐рднрд┐рдиреНрди рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк [**рд╕реНрд░реЛрдд рдХреЛрдб рдореЗрдВ рдпрд╣рд╛рдБ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**](https://opensource.apple.com/source/xnu/xnu-2050.18.24/EXTERNAL\_HEADERS/mach-o/loader.h)ред рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВ:

* `MH_OBJECT`: рдкреБрдирд░реНрд╕реНрдерд╛рдкрдиреАрдп рдСрдмреНрдЬреЗрдХреНрдЯ рдлрд╝рд╛рдЗрд▓ (рд╕рдВрдХрд▓рди рдХреЗ рдордзреНрдп рдЙрддреНрдкрд╛рдж, рдЕрднреА рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдирд╣реАрдВ)ред
* `MH_EXECUTE`: рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓реЗрдВред
* `MH_FVMLIB`: рд╕реНрдерд┐рд░ VM рдкреБрд╕реНрддрдХрд╛рд▓рдп рдлрд╝рд╛рдЗрд▓ред
* `MH_CORE`: рдХреЛрдб рдбрдВрдк
* `MH_PRELOAD`: рдкреНрд░реАрд▓реЛрдбреЗрдб рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ (рдЕрдм XNU рдореЗрдВ рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ) 
* `MH_DYLIB`: рдЧрддрд┐рд╢реАрд▓ рдкреБрд╕реНрддрдХрд╛рд▓рдп
* `MH_DYLINKER`: рдЧрддрд┐рд╢реАрд▓ рд▓рд┐рдВрдХрд░реНрд╕
* `MH_BUNDLE`: "рдкреНрд▓рдЧрдЗрди рдлрд╝рд╛рдЗрд▓реЗрдВ"ред gcc рдореЗрдВ -bundle рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрддреНрдкрдиреНрди рдФрд░ `NSBundle` рдпрд╛ `dlopen` рджреНрд╡рд╛рд░рд╛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд▓реЛрдб рдХреА рдЧрдИред
* `MH_DYSM`: рд╕рд╛рдереА `.dSym` рдлрд╝рд╛рдЗрд▓ (рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреАрдХреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рд╛рдЗрд▓)ред
* `MH_KEXT_BUNDLE`: рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиред
```bash
# Checking the mac header of a binary
otool -arch arm64e -hv /bin/ls
Mach header
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64          E USR00     EXECUTE    19       1728   NOUNDEFS DYLDLINK TWOLEVEL PIE
```
Or using [Mach-O View](https://sourceforge.net/projects/machoview/):

<figure><img src="../../../.gitbook/assets/image (1133).png" alt=""><figcaption></figcaption></figure>

## **Mach-O Flags**

рд╕реНрд░реЛрдд рдХреЛрдб рдХрдИ рдзреНрд╡рдЬреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИрдВ:

* `MH_NOUNDEFS`: рдХреЛрдИ рдЕрдкрд░рд┐рднрд╛рд╖рд┐рдд рд╕рдВрджрд░реНрдн рдирд╣реАрдВ (рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рд▓рд┐рдВрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛)
* `MH_DYLDLINK`: Dyld рд▓рд┐рдВрдХрд┐рдВрдЧ
* `MH_PREBOUND`: рдЧрддрд┐рд╢реАрд▓ рд╕рдВрджрд░реНрдн рдкреВрд░реНрд╡ рдмрдВрдзрд┐рддред
* `MH_SPLIT_SEGS`: рдлрд╝рд╛рдЗрд▓ r/o рдФрд░ r/w рдЦрдВрдбреЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рд╣реЛрддреА рд╣реИред
* `MH_WEAK_DEFINES`: рдмрд╛рдЗрдирд░реА рдореЗрдВ рдХрдордЬреЛрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдкреНрд░рддреАрдХ рд╣реИрдВ
* `MH_BINDS_TO_WEAK`: рдмрд╛рдЗрдирд░реА рдХрдордЬреЛрд░ рдкреНрд░рддреАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ
* `MH_ALLOW_STACK_EXECUTION`: рд╕реНрдЯреИрдХ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдпреЛрдЧреНрдп рдмрдирд╛рдПрдВ
* `MH_NO_REEXPORTED_DYLIBS`: рдкреБрд╕реНрддрдХрд╛рд▓рдп LC\_REEXPORT рдЖрджреЗрд╢ рдирд╣реАрдВ рд╣реИ
* `MH_PIE`: рд╕реНрдерд┐рддрд┐ рд╕реНрд╡рддрдВрддреНрд░ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп
* `MH_HAS_TLV_DESCRIPTORS`: рд╡рд╣рд╛рдБ рдПрдХ рдЕрдиреБрднрд╛рдЧ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдереНрд░реЗрдб рд╕реНрдерд╛рдиреАрдп рдЪрд░ рд╣реИрдВ
* `MH_NO_HEAP_EXECUTION`: рд╣реАрдк/рдбреЗрдЯрд╛ рдкреГрд╖реНрдареЛрдВ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдирд┐рд╖реНрдкрд╛рджрди рдирд╣реАрдВ
* `MH_HAS_OBJC`: рдмрд╛рдЗрдирд░реА рдореЗрдВ oBject-C рдЕрдиреБрднрд╛рдЧ рд╣реИрдВ
* `MH_SIM_SUPPORT`: рд╕рд┐рдореНрдпреБрд▓реЗрдЯрд░ рд╕рдорд░реНрдерди
* `MH_DYLIB_IN_CACHE`: рд╕рд╛рдЭрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреИрд╢ рдореЗрдВ dylibs/рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ред

## **Mach-O Load commands**

**рдлрд╛рдЗрд▓ рдХрд╛ рд▓реЗрдЖрдЙрдЯ рдореЗрдореЛрд░реА рдореЗрдВ** рдпрд╣рд╛рдБ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ **рдкреНрд░рддреАрдХ рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рд╕реНрдерд╛рди**, рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рд░рдВрдн рдкрд░ рдореБрдЦреНрдп рдереНрд░реЗрдб рдХрд╛ рд╕рдВрджрд░реНрдн, рдФрд░ рдЖрд╡рд╢реНрдпрдХ **рд╕рд╛рдЭрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ** рдХрд╛ рд╡рд┐рд╡рд░рдг рджреЗрддрд╛ рд╣реИред рдЧрддрд┐рд╢реАрд▓ рд▓реЛрдбрд░ **(dyld)** рдХреЛ рдмрд╛рдЗрдирд░реА рдХреЗ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред

рдпрд╣ **load\_command** рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЙрд▓реНрд▓реЗрдЦрд┐рдд **`loader.h`** рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```objectivec
struct load_command {
uint32_t cmd;           /* type of load command */
uint32_t cmdsize;       /* total size of command in bytes */
};
```
There are about **50 different types of load commands** that the system handles differently. The most common ones are: `LC_SEGMENT_64`, `LC_LOAD_DYLINKER`, `LC_MAIN`, `LC_LOAD_DYLIB`, and `LC_CODE_SIGNATURE`.

### **LC\_SEGMENT/LC\_SEGMENT\_64**

{% hint style="success" %}
рдмреБрдирд┐рдпрд╛рджреА рд░реВрдк рд╕реЗ, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд▓реЛрдб рдХрдорд╛рдВрдб **рдХреИрд╕реЗ \_\_TEXT** (рдХрд╛рд░реНрдпрдХрд╛рд░реА рдХреЛрдб) **рдФрд░ \_\_DATA** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛) **рд╕реЗрдЧрдореЗрдВрдЯ рдХреЛ рд▓реЛрдб рдХрд░рдирд╛ рд╣реИ** рдпрд╣ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рдмрд╛рдЗрдирд░реА рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╕рдордп **рдбреЗрдЯрд╛ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдСрдлрд╝рд╕реЗрдЯ** рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╣реЛрддрд╛ рд╣реИред
{% endhint %}

рдпреЗ рдХрдорд╛рдВрдб **рд╕реЗрдЧрдореЗрдВрдЯ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВ** рдЬреЛ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╕рдордп** рдЗрд╕рдХреЗ **рдЖрднрд╛рд╕реА рдореЗрдореЛрд░реА рд╕реНрдкреЗрд╕** рдореЗрдВ **рдореИрдк** рд╣реЛрддреЗ рд╣реИрдВред

рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ **рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░** рд╣реЛрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ **\_\_TEXT** рд╕реЗрдЧрдореЗрдВрдЯ, рдЬреЛ рдПрдХ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рдХрд╛рд░реНрдпрдХрд╛рд░реА рдХреЛрдб рдХреЛ рд░рдЦрддрд╛ рд╣реИ, рдФрд░ **\_\_DATA** рд╕реЗрдЧрдореЗрдВрдЯ, рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдЯрд╛ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред рдпреЗ **рд╕реЗрдЧрдореЗрдВрдЯ Mach-O рдлрд╝рд╛рдЗрд▓ рдХреЗ рдбреЗрдЯрд╛ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ**ред

**рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрдЧрдореЗрдВрдЯ** рдХреЛ рдЖрдЧреЗ **рдХрдИ рдЕрдиреБрднрд╛рдЧреЛрдВ** рдореЗрдВ **рд╡рд┐рднрд╛рдЬрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред **рд▓реЛрдб рдХрдорд╛рдВрдб рд╕рдВрд░рдЪрдирд╛** рдореЗрдВ **рдЗрди рдЕрдиреБрднрд╛рдЧреЛрдВ** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ **рдЬрд╛рдирдХрд╛рд░реА** рд╣реЛрддреА рд╣реИ рдЬреЛ рд╕рдВрдмрдВрдзрд┐рдд рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рднреАрддрд░ рд╣реЛрддреА рд╣реИред

рд╣реЗрдбрд░ рдореЗрдВ рдкрд╣рд▓реЗ рдЖрдкрдХреЛ **рд╕реЗрдЧрдореЗрдВрдЯ рд╣реЗрдбрд░** рдорд┐рд▓рддрд╛ рд╣реИ:

<pre class="language-c"><code class="lang-c">struct segment_command_64 { /* for 64-bit architectures */
uint32_t	cmd;		/* LC_SEGMENT_64 */
uint32_t	cmdsize;	/* includes sizeof section_64 structs */
char		segname[16];	/* segment name */
uint64_t	vmaddr;		/* memory address of this segment */
uint64_t	vmsize;		/* memory size of this segment */
uint64_t	fileoff;	/* file offset of this segment */
uint64_t	filesize;	/* amount to map from the file */
int32_t		maxprot;	/* maximum VM protection */
int32_t		initprot;	/* initial VM protection */
<strong>	uint32_t	nsects;		/* number of sections in segment */
</strong>	uint32_t	flags;		/* flags */
};
</code></pre>

Example of segment header:

<figure><img src="../../../.gitbook/assets/image (1126).png" alt=""><figcaption></figcaption></figure>

This header defines the **number of sections whose headers appear after** it:
```c
struct section_64 { /* for 64-bit architectures */
char		sectname[16];	/* name of this section */
char		segname[16];	/* segment this section goes in */
uint64_t	addr;		/* memory address of this section */
uint64_t	size;		/* size in bytes of this section */
uint32_t	offset;		/* file offset of this section */
uint32_t	align;		/* section alignment (power of 2) */
uint32_t	reloff;		/* file offset of relocation entries */
uint32_t	nreloc;		/* number of relocation entries */
uint32_t	flags;		/* flags (section type and attributes)*/
uint32_t	reserved1;	/* reserved (for offset or index) */
uint32_t	reserved2;	/* reserved (for count or sizeof) */
uint32_t	reserved3;	/* reserved */
};
```
рдЙрджрд╛рд╣рд░рдг **рдЕрдиреБрднрд╛рдЧ рд╢реАрд░реНрд╖рдХ** рдХрд╛:

<figure><img src="../../../.gitbook/assets/image (1108).png" alt=""><figcaption></figcaption></figure>

рдпрджрд┐ рдЖрдк **рдЕрдиреБрднрд╛рдЧ рдСрдлрд╝рд╕реЗрдЯ** (0x37DC) + **рдСрдлрд╝рд╕реЗрдЯ** рдЬрд╣рд╛рдВ **рдЖрд░реНрдХ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ**, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `0x18000` --> `0x37DC + 0x18000 = 0x1B7DC` рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ

<figure><img src="../../../.gitbook/assets/image (701).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ **рдХрдорд╛рдВрдб рд▓рд╛рдЗрди** рд╕реЗ **рд╣реЗрдбрд░ рдЬрд╛рдирдХрд╛рд░реА** рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рднреА рд╕рдВрднрд╡ рд╣реИ:
```bash
otool -lv /bin/ls
```
Common segments loaded by this cmd:

* **`__PAGEZERO`:** рдпрд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ **рдкрддрд╛ рд╢реВрдиреНрдп** рдХреЛ **рдореИрдк** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрд╕реЗ **рдкрдврд╝рд╛, рд▓рд┐рдЦрд╛ рдпрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ maxprot рдФрд░ minprot рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рд╢реВрдиреНрдп рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдЗрд╕ рдкреГрд╖реНрда рдкрд░ **рдХреЛрдИ рдкрдврд╝рдиреЗ-рд▓рд┐рдЦрдиреЗ-рдирд┐рд╖реНрдкрд╛рджрди рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рд╣реИрдВ**ред
* рдпрд╣ рдЖрд╡рдВрдЯрди **NULL рдкреЙрдЗрдВрдЯрд░ рдбреЗрд░рд┐рдлрд░реЗрдВрд╕ рдХрдордЬреЛрд░рд┐рдпреЛрдВ** рдХреЛ **рдХрдо рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ XNU рдПрдХ рдХрдареЛрд░ рдкреГрд╖реНрда рд╢реВрдиреНрдп рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдореЗрдореЛрд░реА рдХрд╛ рдкрд╣рд▓рд╛ рдкреГрд╖реНрда (рдХреЗрд╡рд▓ рдкрд╣рд▓рд╛) рдЕрдиреБрдкрд▓рдмреНрдз рд╣реИ (i386 рдХреЛ рдЫреЛрдбрд╝рдХрд░)ред рдПрдХ рдмрд╛рдЗрдирд░реА рдЗрди рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░ рд╕рдХрддреА рд╣реИ рдПрдХ рдЫреЛрдЯреЗ \_\_PAGEZERO (рдЬреЛ `-pagezero_size` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ) рдХреЛ рдкрд╣рд▓реЗ 4k рдХреЛ рдХрд╡рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдХрд░рдХреЗ рдФрд░ рд╢реЗрд╖ 32-рдмрд┐рдЯ рдореЗрдореЛрд░реА рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдХрд░реНрдиреЗрд▓ рдореЛрдб рджреЛрдиреЛрдВ рдореЗрдВ рд╕реБрд▓рдн рдмрдирд╛рдХрд░ред
* **`__TEXT`**: рдЗрд╕рдореЗрдВ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** **рдХреЛрдб** рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдкрдврд╝рдиреЗ** рдФрд░ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИ (рдХреЛрдИ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдирд╣реАрдВ)**ред** рдЗрд╕ рдЦрдВрдб рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рдЕрдиреБрднрд╛рдЧ:
* `__text`: рд╕рдВрдХрд▓рд┐рдд рдмрд╛рдЗрдирд░реА рдХреЛрдб
* `__const`: рд╕реНрдерд╛рдпреА рдбреЗрдЯрд╛ (рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП)
* `__[c/u/os_log]string`: C, рдпреВрдирд┐рдХреЛрдб рдпрд╛ os рд▓реЙрдЧ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕реНрдерд╛рдпреА
* `__stubs` рдФрд░ `__stubs_helper`: рдЧрддрд┐рд╢реАрд▓ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рд╢рд╛рдорд┐рд▓
* `__unwind_info`: рд╕реНрдЯреИрдХ рдЕрдирд╡рд╛рдЗрдВрдб рдбреЗрдЯрд╛ред
* рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рд╕рднреА рд╕рд╛рдордЧреНрд░реА рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдРрд╕реЗ рдЕрдиреБрднрд╛рдЧреЛрдВ рдХреЗ рд╢реЛрд╖рдг рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд╡рд┐рдХрд▓реНрдк рдмрдирд╛рдирд╛ рдЬреЛ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд░рдЦрддреЗ, рдЬреИрд╕реЗ рдХрд┐ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕рдорд░реНрдкрд┐рдд рдЕрдиреБрднрд╛рдЧ)ред
* **`__DATA`**: рдЗрд╕рдореЗрдВ рдбреЗрдЯрд╛ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп** рдФрд░ **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп** (рдХреЛрдИ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдирд╣реАрдВ)**ред**
* `__got:` рд╡реИрд╢реНрд╡рд┐рдХ рдСрдлрд╕реЗрдЯ рддрд╛рд▓рд┐рдХрд╛
* `__nl_symbol_ptr`: рдЧреИрд░ рдЖрд▓рд╕реА (рд▓реЛрдб рдкрд░ рдмрд╛рдЗрдВрдб) рдкреНрд░рддреАрдХ рдкреЙрдЗрдВрдЯрд░
* `__la_symbol_ptr`: рдЖрд▓рд╕реА (рдЙрдкрдпреЛрдЧ рдкрд░ рдмрд╛рдЗрдВрдб) рдкреНрд░рддреАрдХ рдкреЙрдЗрдВрдЯрд░
* `__const`: рдЗрд╕реЗ рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп рдбреЗрдЯрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдирд╣реАрдВ)
* `__cfstring`: рдХреЛрд░рдлрд╛рдЙрдВрдбреЗрд╢рди рд╕реНрдЯреНрд░рд┐рдВрдЧ
* `__data`: рд╡реИрд╢реНрд╡рд┐рдХ рд╡реЗрд░рд┐рдПрдмрд▓ (рдЬреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* `__bss`: рд╕реНрдерд┐рд░ рд╡реЗрд░рд┐рдПрдмрд▓ (рдЬреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* `__objc_*` (\_\_objc\_classlist, \_\_objc\_protolist, рдЖрджрд┐): рдЬрд╛рдирдХрд╛рд░реА рдЬреЛ рдСрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-рд╕реА рд░рдирдЯрд╛рдЗрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИ
* **`__DATA_CONST`**: \_\_DATA.\_\_const рдХреЛ рд╕реНрдерд╛рдпреА рд╣реЛрдиреЗ рдХреА рдЧрд╛рд░рдВрдЯреА рдирд╣реАрдВ рд╣реИ (рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐), рди рд╣реА рдЕрдиреНрдп рдкреЙрдЗрдВрдЯрд░реНрд╕ рдФрд░ GOTред рдпрд╣ рдЕрдиреБрднрд╛рдЧ `__const`, рдХреБрдЫ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдФрд░ GOT рддрд╛рд▓рд┐рдХрд╛ (рдПрдХ рдмрд╛рд░ рд╣рд▓ рд╣реЛрдиреЗ рдкрд░) рдХреЛ **рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп** рдмрдирд╛рддрд╛ рд╣реИ `mprotect` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред
* **`__LINKEDIT`**: рдЗрд╕рдореЗрдВ рд▓рд┐рдВрдХрд░реНрд╕ (dyld) рдХреЗ рд▓рд┐рдП рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИ рдЬреИрд╕реЗ, рдкреНрд░рддреАрдХ, рд╕реНрдЯреНрд░рд┐рдВрдЧ, рдФрд░ рдкреБрдирд░реНрд╕реНрдерд╛рдкрди рддрд╛рд▓рд┐рдХрд╛ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдБред рдпрд╣ `__TEXT` рдпрд╛ `__DATA` рдореЗрдВ рди рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╕рд╛рдордЧреНрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдХрдВрдЯреЗрдирд░ рд╣реИ рдФрд░ рдЗрд╕рдХреА рд╕рд╛рдордЧреНрд░реА рдЕрдиреНрдп рд▓реЛрдб рдХрдорд╛рдВрдб рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИред
* dyld рдЬрд╛рдирдХрд╛рд░реА: рд░реАрдмреЗрд╕, рдЧреИрд░-рдЖрд▓рд╕реА/рдЖрд▓рд╕реА/рдХрдордЬреЛрд░ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдСрдкрдХреЛрдб рдФрд░ рдирд┐рд░реНрдпрд╛рдд рдЬрд╛рдирдХрд╛рд░реА
* рдлрд╝рдВрдХреНрд╢рдВрд╕ рдкреНрд░рд╛рд░рдВрдн: рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЗ рдкреНрд░рд╛рд░рдВрдн рдкрддреЗ рдХреА рддрд╛рд▓рд┐рдХрд╛
* рдХреЛрдб рдореЗрдВ рдбреЗрдЯрд╛: \_\_text рдореЗрдВ рдбреЗрдЯрд╛ рджреНрд╡реАрдк
* рдкреНрд░рддреАрдХ рддрд╛рд▓рд┐рдХрд╛: рдмрд╛рдЗрдирд░реА рдореЗрдВ рдкреНрд░рддреАрдХ
* рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рдкреНрд░рддреАрдХ рддрд╛рд▓рд┐рдХрд╛: рдкреЙрдЗрдВрдЯрд░/рд╕реНрдЯрдм рдкреНрд░рддреАрдХ
* рд╕реНрдЯреНрд░рд┐рдВрдЧ рддрд╛рд▓рд┐рдХрд╛
* рдХреЛрдб рд╕рд┐рдЧреНрдиреЗрдЪрд░
* **`__OBJC`**: рдЗрд╕рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-рд╕реА рд░рдирдЯрд╛рдЗрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА \_\_DATA рдЦрдВрдб рдореЗрдВ рднреА рдкрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ, рд╡рд┐рднрд┐рдиреНрди \_\_objc\_\* рдЕрдиреБрднрд╛рдЧреЛрдВ рдХреЗ рднреАрддрд░ред
* **`__RESTRICT`**: рдПрдХ рдРрд╕рд╛ рдЦрдВрдб рдЬрд┐рд╕рдореЗрдВ рд╕рд╛рдордЧреНрд░реА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХрд▓ рдЕрдиреБрднрд╛рдЧ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ **`__restrict`** (рднреА рдЦрд╛рд▓реА) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдмрд╛рдЗрдирд░реА рдЪрд▓рд╛рддреЗ рд╕рдордп, рдпрд╣ DYLD рдкрд░реНрдпрд╛рд╡рд░рдгреАрдп рдЪрд░ рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд░реЗрдЧрд╛ред

рдЬреИрд╕рд╛ рдХрд┐ рдХреЛрдб рдореЗрдВ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, **рдЦрдВрдб рднреА рдлрд╝реНрд▓реИрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ** (рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЙрдирдХрд╛ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛):

* `SG_HIGHVM`: рдХреЗрд╡рд▓ рдХреЛрд░ (рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛)
* `SG_FVMLIB`: рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛
* `SG_NORELOC`: рдЦрдВрдб рдореЗрдВ рдХреЛрдИ рдкреБрдирд░реНрд╕реНрдерд╛рдкрди рдирд╣реАрдВ рд╣реИ
* `SG_PROTECTED_VERSION_1`: рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рдиред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП Finder рджреНрд╡рд╛рд░рд╛ `__TEXT` рдЦрдВрдб рдХреЗ рдкрд╛рда рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### **`LC_UNIXTHREAD/LC_MAIN`**

**`LC_MAIN`** рдореЗрдВ **entryoff рд╡рд┐рд╢реЗрд╖рддрд╛** рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рд╣реЛрддрд╛ рд╣реИред рд▓реЛрдб рд╕рдордп рдкрд░, **dyld** рдмрд╕ рдЗрд╕ рдорд╛рди рдХреЛ (рдореЗрдореЛрд░реА рдореЗрдВ) **рдмрд╛рдЗрдирд░реА рдХреЗ рдЖрдзрд╛рд░** рдореЗрдВ **рдЬреЛрдбрд╝рддрд╛** рд╣реИ, рдлрд┐рд░ **рдЗрд╕ рдирд┐рд░реНрджреЗрд╢ рдкрд░ рдХреВрджрддрд╛** рд╣реИ рддрд╛рдХрд┐ рдмрд╛рдЗрдирд░реА рдХреЗ рдХреЛрдб рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рд╣реЛ рд╕рдХреЗред

**`LC_UNIXTHREAD`** рдореЗрдВ рд╡реЗ рдорд╛рди рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЛ рдореБрдЦреНрдп рдзрд╛рдЧрд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╕рдордп рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕реЗ рдкрд╣рд▓реЗ рд╣реА рдЕрдорд╛рдиреНрдп рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рд▓реЗрдХрд┐рди **`dyld`** рдЕрднреА рднреА рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдХрд┐рдП рдЧрдП рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рдорд╛рдиреЛрдВ рдХреЛ рджреЗрдЦрдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```bash
otool -l /usr/lib/dyld
[...]
Load command 13
cmd LC_UNIXTHREAD
cmdsize 288
flavor ARM_THREAD_STATE64
count ARM_THREAD_STATE64_COUNT
x0  0x0000000000000000 x1  0x0000000000000000 x2  0x0000000000000000
x3  0x0000000000000000 x4  0x0000000000000000 x5  0x0000000000000000
x6  0x0000000000000000 x7  0x0000000000000000 x8  0x0000000000000000
x9  0x0000000000000000 x10 0x0000000000000000 x11 0x0000000000000000
x12 0x0000000000000000 x13 0x0000000000000000 x14 0x0000000000000000
x15 0x0000000000000000 x16 0x0000000000000000 x17 0x0000000000000000
x18 0x0000000000000000 x19 0x0000000000000000 x20 0x0000000000000000
x21 0x0000000000000000 x22 0x0000000000000000 x23 0x0000000000000000
x24 0x0000000000000000 x25 0x0000000000000000 x26 0x0000000000000000
x27 0x0000000000000000 x28 0x0000000000000000  fp 0x0000000000000000
lr 0x0000000000000000 sp  0x0000000000000000  pc 0x0000000000004b70
cpsr 0x00000000

[...]
```
### **`LC_CODE_SIGNATURE`**

рдЗрд╕рдореЗрдВ **Macho-O рдлрд╝рд╛рдЗрд▓ рдХреЗ рдХреЛрдб рд╕рд┐рдЧреНрдиреЗрдЪрд░** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИред рдЗрд╕рдореЗрдВ рдХреЗрд╡рд▓ рдПрдХ **рдСрдлрд╕реЗрдЯ** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдмреНрд▓реЙрдм** рдХреА рдУрд░ **рд╕рдВрдХреЗрдд** рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╣реЛрддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рдЕрдиреБрднрд╛рдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА [**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://davedelong.com/blog/2018/01/10/reading-your-own-entitlements/) рдФрд░ рдЗрд╕ [**gists**](https://gist.github.com/carlospolop/ef26f8eb9fafd4bc22e69e1a32b81da4) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

### **`LC_ENCRYPTION_INFO[_64]`**

рдмрд╛рдЗрдирд░реА рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдердиред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдмрд┐рдирд╛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдореЗрдореЛрд░реА рдХреЛ рдбрдВрдк рдХрд░ рд╕рдХреЗрдЧрд╛ред

### **`LC_LOAD_DYLINKER`**

рдЗрд╕рдореЗрдВ **рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХрд░реНрд╕ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди** рдХрд╛ **рдкрде** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рд╕рд╛рдЭрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрддреЗ рдХреА рдЬрдЧрд╣ рдореЗрдВ рдореИрдк рдХрд░рддрд╛ рд╣реИред **рдорд╛рди рд╣рдореЗрд╢рд╛ `/usr/lib/dyld` рдкрд░ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИ**ред рдпрд╣ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ macOS рдореЗрдВ, dylib рдореИрдкрд┐рдВрдЧ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб** рдореЗрдВ рд╣реЛрддреА рд╣реИ, рди рдХрд┐ рдХрд░реНрдиреЗрд▓ рдореЛрдб рдореЗрдВред

### **`LC_IDENT`**

рдкреБрд░рд╛рдирд╛ рд▓реЗрдХрд┐рди рдЬрдм рдкреИрдирд┐рдХ рдкрд░ рдбрдВрдк рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ Mach-O рдХреЛрд░ рдбрдВрдк рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдг `LC_IDENT` рдХрдорд╛рдВрдб рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### **`LC_UUID`**

рдпрд╛рджреГрдЪреНрдЫрд┐рдХ UUIDред рдпрд╣ рдХрд┐рд╕реА рднреА рдЪреАрдЬрд╝ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИ рд▓реЗрдХрд┐рди XNU рдЗрд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдмрд╛рдХреА рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рдХреИрд╢ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрд░реИрд╢ рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### **`LC_DYLD_ENVIRONMENT`**

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рд╕реЗ рдкрд╣рд▓реЗ dyld рдХреЛ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рдмрд╣реБрдд рдЦрддрд░рдирд╛рдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдВрджрд░ рдордирдорд╛рдирд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд▓реЛрдб рдХрдорд╛рдВрдб рдХреЗрд╡рд▓ `#define SUPPORT_LC_DYLD_ENVIRONMENT` рдХреЗ рд╕рд╛рде dyld рдирд┐рд░реНрдорд╛рдг рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдХреЗрд╡рд▓ `DYLD_..._PATH` рдХреЗ рд░реВрдк рдХреЗ рдЪрд░ рдХреЛ рд▓реЛрдб рдкрде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдЧреЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред

### **`LC_LOAD_DYLIB`**

рдпрд╣ рд▓реЛрдб рдХрдорд╛рдВрдб рдПрдХ **рдбрд╛рдпрдирд╛рдорд┐рдХ** **рд▓рд╛рдЗрдмреНрд░реЗрд░реА** рдирд┐рд░реНрднрд░рддрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ **рд▓реЛрдбрд░** (dyld) рдХреЛ **рдХрд╣рд╛ рдЧрдпрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдФрд░ рд▓рд┐рдВрдХ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП **рдирд┐рд░реНрджреЗрд╢** рджреЗрддрд╛ рд╣реИред Mach-O рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ **рдкреНрд░рддреНрдпреЗрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА** рдХреЗ рд▓рд┐рдП рдПрдХ `LC_LOAD_DYLIB` рд▓реЛрдб рдХрдорд╛рдВрдб рд╣реЛрддрд╛ рд╣реИред

* рдпрд╣ рд▓реЛрдб рдХрдорд╛рдВрдб **`dylib_command`** рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдВрд░рдЪрдирд╛ рд╣реИ (рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╕рдВрд░рдЪрдирд╛ dylib рд╣реЛрддреА рд╣реИ, рдЬреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдирд┐рд░реНрднрд░ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреА рд╣реИ):
```objectivec
struct dylib_command {
uint32_t        cmd;            /* LC_LOAD_{,WEAK_}DYLIB */
uint32_t        cmdsize;        /* includes pathname string */
struct dylib    dylib;          /* the library identification */
};

struct dylib {
union lc_str  name;                 /* library's path name */
uint32_t timestamp;                 /* library's build time stamp */
uint32_t current_version;           /* library's current version number */
uint32_t compatibility_version;     /* library's compatibility vers number*/
};
```
![](<../../../.gitbook/assets/image (486).png>)

рдЖрдк рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ CLI рд╕реЗ рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
otool -L /bin/ls
/bin/ls:
/usr/lib/libutil.dylib (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1319.0.0)
```
рдХреБрдЫ рд╕рдВрднрд╛рд╡рд┐рдд рдореИрд▓рд╡реЗрдпрд░ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╣реИрдВ:

* **DiskArbitration**: USB рдбреНрд░рд╛рдЗрд╡ рдХреА рдирд┐рдЧрд░рд╛рдиреА
* **AVFoundation:** рдСрдбрд┐рдпреЛ рдФрд░ рд╡реАрдбрд┐рдпреЛ рдХреИрдкреНрдЪрд░
* **CoreWLAN**: рд╡рд╛рдИрдлрд╛рдИ рд╕реНрдХреИрдиред

{% hint style="info" %}
рдПрдХ Mach-O рдмрд╛рдЗрдирд░реА рдореЗрдВ рдПрдХ рдпрд╛ **рдЕрдзрд┐рдХ** **рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░реНрд╕** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ **LC\_MAIN** рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рд╕реЗ **рдкрд╣рд▓реЗ** **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдХрд┐рд╕реА рднреА рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХреЗ рдСрдлрд╕реЗрдЯ **\_\_mod\_init\_func** рдЕрдиреБрднрд╛рдЧ рдореЗрдВ **\_\_DATA\_CONST** рдЦрдВрдб рдореЗрдВ рд░рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВред
{% endhint %}

## **Mach-O рдбреЗрдЯрд╛**

рдлрд╛рдЗрд▓ рдХреЗ рдореВрд▓ рдореЗрдВ рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░ рд╣реИ, рдЬреЛ рд▓реЛрдб-рдХрдорд╛рдВрдб рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрдИ рдЦрдВрдбреЛрдВ рд╕реЗ рдмрдирд╛ рд╣реИред **рдкреНрд░рддреНрдпреЗрдХ рдЦрдВрдб рдХреЗ рднреАрддрд░ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреЗ рдбреЗрдЯрд╛ рдЕрдиреБрднрд╛рдЧ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ**, рдкреНрд░рддреНрдпреЗрдХ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ **рдХреЛрдб рдпрд╛ рдбреЗрдЯрд╛** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╣реЛрддрд╛ рд╣реИред

{% hint style="success" %}
рдбреЗрдЯрд╛ рдореВрд▓ рд░реВрдк рд╕реЗ рдЙрд╕ рднрд╛рдЧ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕рднреА **рдЬрд╛рдирдХрд╛рд░реА** рд╣реЛрддреА рд╣реИ рдЬреЛ рд▓реЛрдб рдХрдорд╛рдВрдб **LC\_SEGMENTS\_64** рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХреА рдЬрд╛рддреА рд╣реИред
{% endhint %}

![https://www.oreilly.com/api/v2/epubs/9781785883378/files/graphics/B05055\_02\_38.jpg](<../../../.gitbook/assets/image (507) (3).png>)

рдЗрд╕рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* **рдлрдВрдХреНрд╢рди рдЯреЗрдмрд▓:** рдЬреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдлрдВрдХреНрд╢рдВрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреА рд╣реИред
* **рд╕рд┐рдВрдмреЙрд▓ рдЯреЗрдмрд▓**: рдЬреЛ рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдмрд╛рд╣рд░реА рдлрдВрдХреНрд╢рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреА рд╣реИ
* рдЗрд╕рдореЗрдВ рдЖрдВрддрд░рд┐рдХ рдлрдВрдХреНрд╢рди, рд╡реЗрд░рд┐рдПрдмрд▓ рдирд╛рдо рднреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рднреА рдмрд╣реБрдд рдХреБрдЫред

рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк [**Mach-O View**](https://sourceforge.net/projects/machoview/) рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (1120).png" alt=""><figcaption></figcaption></figure>

рдпрд╛ CLI рд╕реЗ:
```bash
size -m /bin/ls
```
## Objetive-C рд╕рд╛рдорд╛рдиреНрдп рдЕрдиреБрднрд╛рдЧ

In `__TEXT` segment (r-x):

* `__objc_classname`: рдХреНрд▓рд╛рд╕ рдирд╛рдо (рд╕реНрдЯреНрд░рд┐рдВрдЧ)
* `__objc_methname`: рдореЗрдердб рдирд╛рдо (рд╕реНрдЯреНрд░рд┐рдВрдЧ)
* `__objc_methtype`: рдореЗрдердб рдкреНрд░рдХрд╛рд░ (рд╕реНрдЯреНрд░рд┐рдВрдЧ)

In `__DATA` segment (rw-):

* `__objc_classlist`: рд╕рднреА Objetive-C рдХреНрд▓рд╛рд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░реНрд╕
* `__objc_nlclslist`: рдиреЙрди-рд▓реЗрдЬрд╝реА рдСрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-C рдХреНрд▓рд╛рд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░реНрд╕
* `__objc_catlist`: рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░
* `__objc_nlcatlist`: рдиреЙрди-рд▓реЗрдЬрд╝реА рд╢реНрд░реЗрдгрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░
* `__objc_protolist`: рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕реВрдЪреА
* `__objc_const`: рд╕реНрдерд╛рдпреА рдбреЗрдЯрд╛
* `__objc_imageinfo`, `__objc_selrefs`, `objc__protorefs`...

## Swift

* `_swift_typeref`, `_swift3_capture`, `_swift3_assocty`, `_swift3_types, _swift3_proto`, `_swift3_fieldmd`, `_swift3_builtin`, `_swift3_reflstr`

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
