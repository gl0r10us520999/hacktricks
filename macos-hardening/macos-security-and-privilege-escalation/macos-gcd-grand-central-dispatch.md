# macOS GCD - Grand Central Dispatch

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг AWS рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ рдкреНрд░реИрдХреНрдЯрд┐рд╕ рдХрд░реЗрдВ GCP рд╣реИрдХрд┐рдВрдЧ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks рдкреНрд░рд╢рд┐рдХреНрд╖рдг GCP рд░реЗрдб рдЯреАрдо рдПрдХреНрд╕рдкрд░реНрдЯ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
{% endhint %}

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

**рдЧреНрд░реИрдВрдб рд╕реЗрдВрдЯреНрд░рд▓ рдбрд┐рд╕реНрдкреИрдЪ (GCD),** рдЬрд┐рд╕реЗ **рд▓рд┐рдмрдбрд┐рд╕реНрдкреИрдЪ** (`libdispatch.dyld`) рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, macOS рдФрд░ iOS рджреЛрдиреЛрдВ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред рдпрд╣ рдПрдХ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рд╣реИ рдЬрд┐рд╕реЗ Apple рдиреЗ рдмрдирд╛рдпрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рдорд░реНрдерди рдХреЛ рдЕрдиреБрдХреНрд░рдорд┐рдХ (рдорд▓реНрдЯреАрдереНрд░реЗрдбреЗрдб) рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рдХреЗ рд▓рд┐рдП рдЕрдиреБрдХреВрд▓ рдмрдирд╛рдП рд░рдЦ рд╕рдХреЗ рдорд▓реНрдЯреАрдХреЛрд░ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдкрд░ред

**GCD** рдЖрдкрдХреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ **рдмреНрд▓реЙрдХ рдСрдмреНрдЬреЗрдХреНрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ **рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕рдмрдорд┐рдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **FIFO рдХрддрд╛рд░реЗрдВ** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдбрд┐рд╕реНрдкреИрдЪ рдХрддрд╛рд░реЛрдВ рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд┐рдП рдЧрдП рдмреНрд▓реЙрдХ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдзрд╛рдЧреЛрдВ рдкрд░ **рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред GCD рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдзрд╛рдЧреЛрдВ рдХреЛ рдирд┐рд░реНрдорд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдбрд┐рд╕реНрдкреИрдЪ рдХрддрд╛рд░реЛрдВ рдореЗрдВ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдЙрдкрд▓рдмреНрдз рдХреЛрд░реЛрдВ рдкрд░ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред

{% hint style="success" %}
рд╕рд╛рд░рд╛рдВрд╢ рдореЗрдВ, **рдкреИрд░рд▓рд▓** рдореЗрдВ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ **GCD рдХреЛ рдХреЛрдб рдХреЗ рдмреНрд▓реЙрдХ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ**, рдЬреЛ рдЙрдирдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХрд╛ рдзреНрдпрд╛рди рд░рдЦреЗрдЧрд╛ред рдЗрд╕рд▓рд┐рдП, рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдирдП рдзрд╛рдЧреЗ рдирд╣реАрдВ рдмрдирд╛рддреА рд╣реИрдВ; **GCD рдЕрдкрдиреЗ рдзрд╛рдЧреЛрдВ рдХреЗ рд╕рд╛рде рджрд┐рдП рдЧрдП рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ** (рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдиреЗ рдкрд░ рдмрдврд╝ рд╕рдХрддреЗ рдпрд╛ рдХрдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ)ред
{% endhint %}

рдпрд╣ рдкреИрд░рд▓рд▓ рдирд┐рд╖реНрдкрд╛рджрди рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдмрд╣реБрдд рд╕рд╣рд╛рдпрдХ рд╣реИ, рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдмрдирд╛рддреА рд╣реИрдВ рдзрд╛рдЧреЗ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдХрдо рдФрд░ рдкреИрд░рд▓рд▓ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдпрд╣ рдЙрди рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЖрджрд░реНрд╢ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ **рдмрдбрд╝реА рдкреИрд░рд▓рд▓рддрд╛** (рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕рд┐рдВрдЧ?) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдпрд╛ рдЬрд┐рдиреНрд╣реЗрдВ рдореБрдЦреНрдп рдзрд╛рдЧрд╛ рдмреНрд▓реЙрдХ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП: рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, iOS рдкрд░ рдореБрдЦреНрдп рдзрд╛рдЧрд╛ UI рдЗрдВрдЯрд░реЗрдХреНрд╢рди рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдРрд╕реА рдХрд┐рд╕реА рднреА рдЕрдиреНрдп рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдЬреЛ рдРрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЕрдЯрдХрд╛ рд╕рдХрддреА рд╣реИ (рдЦреЛрдЬ, рд╡реЗрдм рддрдХ рдкрд╣реБрдВрдЪрдирд╛, рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдирд╛...) рдЗрд╕ рддрд░рд╣ рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### рдмреНрд▓реЙрдХреНрд╕

рдПрдХ рдмреНрд▓реЙрдХ рдПрдХ **рд╕реНрд╡рдпрдВ рд╕рдорд╛рд╣рд┐рдд рдХреЛрдб рдХрд╛ рдЦрдВрдб** рд╣реИ (рдЬреИрд╕реЗ рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдЬрд┐рд╕рдореЗрдВ рддрд░реНрдХ рд╡рд╛рд▓реЗ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЗ рд╕рд╛рде рдПрдХ рдорд╛рди рд▓реМрдЯрд╛рддрд╛ рд╣реИ) рдФрд░ рдмрд╛рдЙрдВрдб рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХрдВрдкрд╛рдЗрд▓рд░ рд╕реНрддрд░ рдкрд░ рдмреНрд▓реЙрдХреНрд╕ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИрдВ, рд╡реЗ `os_object`s рд╣реИрдВред рдЗрди рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдореЗрдВ рджреЛ рд╕рдВрд░рдЪрдирд╛рдПрдБ рд╣реЛрддреА рд╣реИрдВ:

* **рдмреНрд▓реЙрдХ рд▓рд┐рдЯрд░рд▓**:&#x20;
* рдпрд╣ **`isa`** рдлрд╝реАрд▓реНрдб рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдмреНрд▓реЙрдХ рдХреА рдХреНрд▓рд╛рд╕ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ:
* `NSConcreteGlobalBlock` (рдбреЗрдЯрд╛ рд╕реЗ рдмреНрд▓реЙрдХреНрд╕)
* `NSConcreteMallocBlock` (рд╣реАрдк рдореЗрдВ рдмреНрд▓реЙрдХреНрд╕)
* `NSConcreateStackBlock` (рд╕реНрдЯреИрдХ рдореЗрдВ рдмреНрд▓реЙрдХреНрд╕)
* рдЗрд╕рдореЗрдВ **`flags`** рд╣реЛрддреЗ рд╣реИрдВ (рдмреНрд▓реЙрдХ рдбреЗрд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдореЗрдВ рдореМрдЬреВрдж рдлрд╝реАрд▓реНрдбреНрд╕ рдХреА рд╕реВрдЪрдирд╛ рджреЗрддреЗ рд╣реИрдВ) рдФрд░ рдХреБрдЫ рдЖрд░рдХреНрд╖рд┐рдд рдмрд╛рдЗрдЯреНрд╕
* рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди рдкреЙрдЗрдВрдЯрд░
* рдмреНрд▓реЙрдХ рдбреЗрд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░
* рдмреНрд▓реЙрдХ рдЗрдореНрдкреЛрд░реНрдЯреЗрдб рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ (рдЕрдЧрд░ рдХреЛрдИ рд╣реЛ)
* **рдмреНрд▓реЙрдХ рдбреЗрд╕реНрдХреНрд░рд┐рдкреНрдЯрд░**: рдЗрд╕рдХрд╛ рдЖрдХрд╛рд░ рдЙрдкрд╕реНрдерд┐рдд рдбреЗрдЯрд╛ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдкрд┐рдЫрд▓реЗ рдлрд╝реНрд▓реИрдЧреНрд╕ рдореЗрдВ рдЗрдВрджрд┐рдХрд┐рдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* рдЗрд╕рдореЗрдВ рдХреБрдЫ рдЖрд░рдХреНрд╖рд┐рдд рдмрд╛рдЗрдЯреНрд╕ рд╣реЛрддреЗ рд╣реИрдВ
* рдЗрд╕рдХрд╛ рдЖрдХрд╛рд░
* рдЖрдо рддреМрд░ рдкрд░ рдЗрд╕рдореЗрдВ рдкреИрд░рд╛рдореНрд╕ рдХреЗ рд▓рд┐рдП рдХрд┐рддрдиреА рдЬрдЧрд╣ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-рд╕реА рд╕реНрдЯрд╛рдЗрд▓ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░ рд╣реЛрддрд╛ рд╣реИ (рдлрд╝реНрд▓реИрдЧ `BLOCK_HAS_SIGNATURE`)
* рдпрджрд┐ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рд╕рдВрджрд░реНрднрд┐рдд рд╣реИрдВ, рддреЛ рдЗрд╕ рдмреНрд▓реЙрдХ рдореЗрдВ рднреА рдПрдХ рдХреЙрдкреА рд╣реЗрд▓реНрдкрд░ (рдореВрд▓реНрдп рдХреА рдХреЙрдкреА рдХрд░рдирд╛) рдФрд░ рдбрд┐рд╕реНрдкреЛрдЬрд╝ рд╣реЗрд▓реНрдкрд░ (рдЗрд╕реЗ рдореБрдХреНрдд рдХрд░рдирд╛) рдХреЗ рдкреЙрдЗрдВрдЯрд░ рд╣реЛрдВрдЧреЗред

### рдХрддрд╛рд░реЗрдВ

рдПрдХ рдбрд┐рд╕реНрдкреИрдЪ рдХрддрд╛рд░ рдПрдХ рдирд╛рдорд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ рдЬреЛ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдмреНрд▓реЙрдХреНрд╕ рдХреА FIFO рдХреНрд░рдордмрджреНрдзрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдХрддрд╛рд░реЛрдВ рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЧрдП рдмреНрд▓реЙрдХреНрд╕ рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдФрд░ рдЗрдирдореЗрдВ 2 рдореЛрдб рд╣реИрдВ: `DISPATCH_QUEUE_SERIAL` рдФрд░ `DISPATCH_QUEUE_CONCURRENT`ред рдмреЗрд╢рдХ **рд╕реАрд░рд┐рдпрд▓** рд╡рд╛рд▓рд╛ **рд░реЗрд╕ рдХрдВрдбреАрд╢рди** рд╕рдорд╕реНрдпрд╛рдПрдБ рдирд╣реАрдВ рд╣реЛрдВрдЧреА рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рдмреНрд▓реЙрдХ рдХреЛ рддрдм рддрдХ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЬрдм рддрдХ рдкрд┐рдЫрд▓рд╛ рдирд╣реАрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рд▓реЗрдХрд┐рди **рдХрддрд╛рд░ рдХреЗ рджреВрд╕рд░реЗ рдкреНрд░рдХрд╛рд░ рдореЗрдВ рдпрд╣ рд╕рдорд╕реНрдпрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ**ред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХрддрд╛рд░реЗрдВ:

* `.main-thread`: `dispatch_get_main_queue()` рд╕реЗ
* `.libdispatch-manager`: GCD рдХреА рдХрддрд╛рд░ рдкреНрд░рдмрдВрдзрдХ
* `.root.libdispatch-manager`: GCD рдХреА рдХрддрд╛рд░ рдкреНрд░рдмрдВрдзрдХ
* `.root.maintenance-qos`: рд╕рдмрд╕реЗ рдХрдо рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рд╡рд╛рд▓реЗ рдХрд╛рд░реНрдп
* `.root.maintenance-qos.overcommit`
* `.root.background-qos`: `DISPATCH_QUEUE_PRIORITY_BACKGROUND` рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ
* `.root.background-qos.overcommit`
* `.root.utility-qos`: `DISPATCH_QUEUE_PRIORITY_NON_INTERACTIVE` рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ
* `.root.utility-qos.overcommit`
* `.root.default-qos`: `DISPATCH_QUEUE_PRIORITY_DEFAULT` рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ
* `.root.background-qos.overcommit`
* `.root.user-initiated-qos`: `DISPATCH_QUEUE_PRIORITY_HIGH` рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ
* `.root.background-qos.overcommit`
* `.root.user-interactive-qos`: рд╕рдмрд╕реЗ рдЙрдЪреНрдЪ рдкреНрд░рд╛рдердорд┐рдХрддрд╛

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рд╣реЛрдЧрд╛ рдЬреЛ **рд╣рд░ рд╕рдордп рдХрд┐рд╕ рдзрд╛рдЧрд╛ рдХреЛ рдХрд┐рд╕ рдХрддрд╛рд░ рдХрд╛ рд╣реИрдВрдбрд▓ рдХрд░реЗрдЧрд╛** (рдХрдИ рдзрд╛рдЧреЗ рдПрдХ рд╣реА рдХрддрд╛рд░ рдореЗрдВ рдХрд╛рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдПрдХ рд╣реА рдзрд╛рдЧрд╛ рдХрд┐рд╕реА рд╕рдордп рдЕрд▓рдЧ-рдЕрд▓рдЧ рдХрддрд╛рд░реЛрдВ рдореЗрдВ рдХрд╛рдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ)

#### рдЧреБрдг

**`dispatch_queue_create`** рдХреЗ рд╕рд╛рде рдХрддрд╛рд░ рдмрдирд╛рддреЗ рд╕рдордп рддреАрд╕рд░рд╛ рддрддреНрд╡ **`dispatch_queue_attr_t`** рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдЖрдо рддреМрд░ рдкрд░ рдпрд╛ рддреЛ `DISPATCH_QUEUE_SERIAL` (рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ NULL рд╣реИ) рд╣реЛрддрд╛ рд╣реИ рдпрд╛ `DISPATCH_QUEUE_CONCURRENT` рдЬреЛ рдПрдХ `dispatch_queue_attr_t` рд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХрд╛ рдкреЙрдЗрдВрдЯрд░ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдХрддрд╛рд░
```c
struct Block {
void *isa; // NSConcreteStackBlock,...
int flags;
int reserved;
void *invoke;
struct BlockDescriptor *descriptor;
// captured variables go here
};
```
рдФрд░ рдпрд╣ **рдкреИрд░рд▓рд▓рд┐рдЬрд╝реНрдо** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ **`dispatch_async`** рдХреЗ рд╕рд╛рде:
```objectivec
#import <Foundation/Foundation.h>

// Define a block
void (^backgroundTask)(void) = ^{
// Code to be executed in the background
for (int i = 0; i < 10; i++) {
NSLog(@"Background task %d", i);
sleep(1);  // Simulate a long-running task
}
};

int main(int argc, const char * argv[]) {
@autoreleasepool {
// Create a dispatch queue
dispatch_queue_t backgroundQueue = dispatch_queue_create("com.example.backgroundQueue", NULL);

// Submit the block to the queue for asynchronous execution
dispatch_async(backgroundQueue, backgroundTask);

// Continue with other work on the main queue or thread
for (int i = 0; i < 10; i++) {
NSLog(@"Main task %d", i);
sleep(1);  // Simulate a long-running task
}
}
return 0;
}
```
## рд╕реНрд╡рд┐рдлреНрдЯ

**`libswiftDispatch`** рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╣реИ рдЬреЛ рдЧреНрд░рд╛рдВрдб рд╕реЗрдВрдЯреНрд░рд▓ рдбрд┐рд╕реНрдкреИрдЪ (GCD) рдлреНрд░реЗрдорд╡рд░реНрдХ рдХреЗ рд▓рд┐рдП **рд╕реНрд╡рд┐рдлреНрдЯ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ** рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ C рдореЗрдВ рд▓рд┐рдЦреА рдЧрдИ рд╣реИред\
**`libswiftDispatch`** рд▓рд╛рдЗрдмреНрд░реЗрд░реА C GCD APIs рдХреЛ рдПрдХ рдФрд░ рд╕реНрд╡рд┐рдлреНрдЯ-рдорд┐рддреНрд░ рдЗрдВрдЯрд░рдлреЗрд╕ рдореЗрдВ рд▓рдкреЗрдЯрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реНрд╡рд┐рдлреНрдЯ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ GCD рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдЖрд╕рд╛рди рдФрд░ рд╕рдордЭрдиреЗ рдореЗрдВ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛ рд╣реЛрддреА рд╣реИред

* **`DispatchQueue.global().sync{ ... }`**
* **`DispatchQueue.global().async{ ... }`**
* **`let onceToken = DispatchOnce(); onceToken.perform { ... }`**
* **`async await`**
* **`var (data, response) = await URLSession.shared.data(from: URL(string: "https://api.example.com/getData"))`**

**рдХреЛрдб рдЙрджрд╛рд╣рд░рдг**:
```swift
import Foundation

// Define a closure (the Swift equivalent of a block)
let backgroundTask: () -> Void = {
for i in 0..<10 {
print("Background task \(i)")
sleep(1)  // Simulate a long-running task
}
}

// Entry point
autoreleasepool {
// Create a dispatch queue
let backgroundQueue = DispatchQueue(label: "com.example.backgroundQueue")

// Submit the closure to the queue for asynchronous execution
backgroundQueue.async(execute: backgroundTask)

// Continue with other work on the main queue
for i in 0..<10 {
print("Main task \(i)")
sleep(1)  // Simulate a long-running task
}
}
```
## рдлреНрд░рд┐рдбрд╛

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлреНрд░рд┐рдбрд╛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрдИ `рдбрд┐рд╕реНрдкреИрдЪ` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ **рд╣реБрдХ рдХрд░рдиреЗ** рдФрд░ рдХрддрд╛рд░ рдХрд╛ рдирд╛рдо, рдмреИрдХрдЯреНрд░реЗрд╕ рдФрд░ рдмреНрд▓реЙрдХ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: [**https://github.com/seemoo-lab/frida-scripts/blob/main/scripts/libdispatch.js**](https://github.com/seemoo-lab/frida-scripts/blob/main/scripts/libdispatch.js)
```bash
frida -U <prog_name> -l libdispatch.js

dispatch_sync
Calling queue: com.apple.UIKit._UIReusePool.reuseSetAccess
Callback function: 0x19e3a6488 UIKitCore!__26-[_UIReusePool addObject:]_block_invoke
Backtrace:
0x19e3a6460 UIKitCore!-[_UIReusePool addObject:]
0x19e3a5db8 UIKitCore!-[UIGraphicsRenderer _enqueueContextForReuse:]
0x19e3a57fc UIKitCore!+[UIGraphicsRenderer _destroyCGContext:withRenderer:]
[...]
```
## рдЧрд┐рдбрд░рд╛

рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЧрд┐рдбрд░рд╛ рдХреЛ рди рддреЛ ObjectiveC **`dispatch_block_t`** рд╕рдВрд░рдЪрдирд╛ рд╕рдордЭрддрд╛ рд╣реИ, рди рд╣реА **`swift_dispatch_block`** рдХреЛред

рддреЛ рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдЙрдиреНрд╣реЗрдВ рд╕рдордЭреЗ, рддреЛ рдЖрдк рдмрд╕ **рдЙрдиреНрд╣реЗрдВ рдШреЛрд╖рд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (1160).png" alt="" width="563"><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1162).png" alt="" width="563"><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1163).png" alt="" width="563"><figcaption></figcaption></figure>

рдлрд┐рд░, рдХреЛрдб рдореЗрдВ рдПрдХ рд╕реНрдерд╛рди рдвреВрдВрдвреЗрдВ рдЬрд╣рд╛рдБ рд╡реЗ **рдЙрдкрдпреЛрдЧ** рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ:

{% hint style="success" %}
"рдмреНрд▓реЙрдХ" рдХреЗ рд╕рднреА рд╕рдВрджрд░реНрднреЛрдВ рдХрд╛ рдзреНрдпрд╛рди рд░рдЦреЗрдВ рддрд╛рдХрд┐ рдЖрдк рд╕рдордЭ рд╕рдХреЗрдВ рдХрд┐ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред
{% endhint %}

<figure><img src="../../.gitbook/assets/image (1164).png" alt="" width="563"><figcaption></figcaption></figure>

рдорд╛рдЙрд╕ рджрд╛рдпрд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ -> рдкрд░рд┐рд╡рд░реНрддрди рдЪрд░ рдХрд░реЗрдВ рдФрд░ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **`swift_dispatch_block`** рдХрд╛ рдЪрдпрди рдХрд░реЗрдВ:

<figure><img src="../../.gitbook/assets/image (1165).png" alt="" width="563"><figcaption></figcaption></figure>

рдЧрд┐рдбрд░рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕рдм рдХреБрдЫ рд▓рд┐рдЦ рджреЗрдЧрд╛:

<figure><img src="../../.gitbook/assets/image (1166).png" alt="" width="563"><figcaption></figcaption></figure>

## рд╕рдВрджрд░реНрдн

* [**\*OS Internals, Volume I: User Mode. By Jonathan Levin**](https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X)
