# macOS - AMFI - AppleMobileFileIntegrity

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}



## AppleMobileFileIntegrity.kext рдФрд░ amfid

рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓ рд░рд╣реЗ рдХреЛрдб рдХреА рдЕрдЦрдВрдбрддрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рдЬреЛ XNU рдХреЗ рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди рдХреЗ рдкреАрдЫреЗ рдХреА рддрд░реНрдХ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдФрд░ рдЕрдиреНрдп рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдореЗрдВ рднреА рд╕рдХреНрд╖рдо рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ рдпрд╛ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдХреБрдЫ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдП, kext рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдерд╛рди рдкрд░ рдЪрд▓рдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдорди `/usr/libexec/amfid` рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдирд╛ рдкрд╕рдВрдж рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рдВрдмрдВрдз рдХрд╛ рдХрдИ рдЬреЗрд▓рдмреНрд░реЗрдХ рдореЗрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

AMFI **MACF** рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдпрд╣ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реА рдЕрдкрдиреЗ рд╣реБрдХ рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рд▓реЛрдбрд┐рдВрдЧ рдпрд╛ рдЕрдирд▓реЛрдбрд┐рдВрдЧ рдХреЛ рд░реЛрдХрдиреЗ рд╕реЗ рдХрд░реНрдиреЗрд▓ рдкреИрдирд┐рдХ рдЙрддреНрдкрдиреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдХреБрдЫ рдмреВрдЯ рддрд░реНрдХ рд╣реИрдВ рдЬреЛ AMFI рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ:

* `amfi_unrestricted_task_for_pid`: рдЖрд╡рд╢реНрдпрдХ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдмрд┐рдирд╛ task_for_pid рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* `amfi_allow_any_signature`: рдХрд┐рд╕реА рднреА рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ
* `cs_enforcement_disable`: рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рд╡рд░реНрддрди рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд┐рд╕реНрдЯрдо-рд╡реНрдпрд╛рдкреА рддрд░реНрдХ
* `amfi_prevent_old_entitled_platform_binaries`: рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдмрд╛рдЗрдирд░реА рдХреЛ рдЕрдорд╛рдиреНрдп рдХрд░реЗрдВ
* `amfi_get_out_of_my_way`: amfi рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ

рдпреЗ рдХреБрдЫ MACF рдиреАрддрд┐рдпрд╛рдБ рд╣реИрдВ рдЬреЛ рдпрд╣ рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ:

* **`cred_check_label_update_execve:`** рд▓реЗрдмрд▓ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ 1 рд▓реМрдЯрд╛рдПрдЧрд╛
* **`cred_label_associate`**: AMFI рдХреЗ рдореИрдХ рд▓реЗрдмрд▓ рд╕реНрд▓реЙрдЯ рдХреЛ рд▓реЗрдмрд▓ рдХреЗ рд╕рд╛рде рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
* **`cred_label_destroy`**: AMFI рдХрд╛ рдореИрдХ рд▓реЗрдмрд▓ рд╕реНрд▓реЙрдЯ рд╣рдЯрд╛ рджреЗрдВ
* **`cred_label_init`**: AMFI рдХреЗ рдореИрдХ рд▓реЗрдмрд▓ рд╕реНрд▓реЙрдЯ рдореЗрдВ 0 рдбрд╛рд▓реЗрдВ
* **`cred_label_update_execve`:** рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЗрд╕реЗ рд▓реЗрдмрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдПред
* **`file_check_mmap`:** рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ mmap рдореЗрдореЛрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░ рд░рд╣рд╛ рд╣реИред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ рдпрджрд┐ рд╣рд╛рдВ, рддреЛ рдпрд╣ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИред
* **`file_check_library_validation`**: рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЕрдиреНрдп рдЪреАрдЬреЛрдВ рдХреЗ рдмреАрдЪ рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдмрд╛рдЗрдирд░реА рдПрдХ рдЕрдиреНрдп рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдмрд╛рдЗрдирд░реА рдХреЛ рд▓реЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИ рдпрд╛ рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдФрд░ рдирдпрд╛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдПрдХ рд╣реА TeamID рд╣реИред рдХреБрдЫ рдЕрдзрд┐рдХрд╛рд░ рдХрд┐рд╕реА рднреА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рднреА рджреЗрдВрдЧреЗред
* **`policy_initbsd`**: рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп NVRAM рдХреБрдВрдЬреА рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ
* **`policy_syscall`**: рдпрд╣ DYLD рдиреАрддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХрд┐ рдХреНрдпрд╛ рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рдЦрдВрдб рд╣реИрдВ, рдХреНрдпрд╛ рдЗрд╕реЗ env vars рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреА рдЪрд╛рд╣рд┐рдП... рдпрд╣ рддрдм рднреА рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ `amfi_check_dyld_policy_self()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИред
* **`proc_check_inherit_ipc_ports`**: рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдЬрдм рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рдирдпрд╛ рдмрд╛рдЗрдирд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреА рд╣реИ рддреЛ рдХреНрдпрд╛ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкрд░ SEND рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдЙрдиреНрд╣реЗрдВ рдмрдирд╛рдП рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП рдпрд╛ рдирд╣реАрдВред рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдмрд╛рдЗрдирд░реА рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, `get-task-allow` рдЕрдзрд┐рдХрд╛рд░ рдЗрд╕реЗ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, `task_for_pid-allow` рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рдФрд░ рдПрдХ рд╣реА TeamID рд╡рд╛рд▓реЗ рдмрд╛рдЗрдирд░реАред
* **`proc_check_expose_task`**: рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░реЗрдВ
* **`amfi_exc_action_check_exception_send`**: рдбрд┐рдмрдЧрд░ рдХреЛ рдПрдХ рдЕрдкрд╡рд╛рдж рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ
* **`amfi_exc_action_label_associate & amfi_exc_action_label_copy/populate & amfi_exc_action_label_destroy & amfi_exc_action_label_init & amfi_exc_action_label_update`**: рдЕрдкрд╡рд╛рдж рд╣реИрдВрдбрд▓рд┐рдВрдЧ (рдбрд┐рдмрдЧрд┐рдВрдЧ) рдХреЗ рджреМрд░рд╛рди рд▓реЗрдмрд▓ рдЬреАрд╡рдирдЪрдХреНрд░
* **`proc_check_get_task`**: рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ `get-task-allow` рдЬреЛ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдФрд░ `task_for_pid-allow`, рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдХрд╛рд░реНрдп рдкреЛрд░реНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрджрд┐ рдЗрдирдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ `amfid permitunrestricteddebugging` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреНрдпрд╛ рдЗрд╕рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред
* **`proc_check_mprotect`**: рдпрджрд┐ `mprotect` рдХреЛ `VM_PROT_TRUSTED` рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ рдЬреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрд╖реЗрддреНрд░ рдХреЛ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреИрд╕реЗ рдХрд┐ рдЗрд╕рдХрд╛ рдПрдХ рдорд╛рдиреНрдп рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реИред
* **`vnode_check_exec`**: рдЬрдм рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓реЗрдВ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдб рд╣реЛрддреА рд╣реИрдВ рддреЛ рдЗрд╕реЗ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ `cs_hard | cs_kill` рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдорд╛рд░ рджреЗрдЧрд╛ рдпрджрд┐ рдХреЛрдИ рднреА рдкреГрд╖реНрда рдЕрдорд╛рдиреНрдп рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ
* **`vnode_check_getextattr`**: MacOS: `com.apple.root.installed` рдФрд░ `isVnodeQuarantined()` рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
* **`vnode_check_setextattr`**: рдЬреИрд╕реЗ рдкреНрд░рд╛рдкреНрдд + com.apple.private.allow-bless рдФрд░ рдЖрдВрддрд░рд┐рдХ-рдЗрдВрд╕реНрдЯреЙрд▓рд░-рд╕рдорд╛рди рдЕрдзрд┐рдХрд╛рд░
* &#x20;**`vnode_check_signature`**: рдХреЛрдб рдЬреЛ рдЕрдзрд┐рдХрд╛рд░реЛрдВ, рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХреИрд╢ рдФрд░ `amfid` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП XNU рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ
* &#x20;**`proc_check_run_cs_invalid`**: рдпрд╣ `ptrace()` рдХреЙрд▓ (`PT_ATTACH` рдФрд░ `PT_TRACE_ME`) рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдХрд┐рд╕реА рднреА рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ `get-task-allow`, `run-invalid-allow` рдФрд░ `run-unsigned-code` рдФрд░ рдпрджрд┐ рдХреЛрдИ рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред
* **`proc_check_map_anon`**: рдпрджрд┐ mmap рдХреЛ **`MAP_JIT`** рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ AMFI `dynamic-codesigning` рдЕрдзрд┐рдХрд╛рд░ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛ред

`AMFI.kext` рдЕрдиреНрдп рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ API рднреА рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рдирд┐рд░реНрднрд░рддрд╛рдУрдВ рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реИ:
```bash
kextstat | grep " 19 " | cut -c2-5,50- | cut -d '(' -f1
Executing: /usr/bin/kmutil showloaded
No variant specified, falling back to release
8   com.apple.kec.corecrypto
19   com.apple.driver.AppleMobileFileIntegrity
22   com.apple.security.sandbox
24   com.apple.AppleSystemPolicy
67   com.apple.iokit.IOUSBHostFamily
70   com.apple.driver.AppleUSBTDM
71   com.apple.driver.AppleSEPKeyStore
74   com.apple.iokit.EndpointSecurity
81   com.apple.iokit.IOUserEthernet
101   com.apple.iokit.IO80211Family
102   com.apple.driver.AppleBCMWLANCore
118   com.apple.driver.AppleEmbeddedUSBHost
134   com.apple.iokit.IOGPUFamily
135   com.apple.AGXG13X
137   com.apple.iokit.IOMobileGraphicsFamily
138   com.apple.iokit.IOMobileGraphicsFamily-DCP
162   com.apple.iokit.IONVMeFamily
```
## amfid

рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдбреЗрдорди рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ `AMFI.kext` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб рдореЗрдВ рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реЗрдЧрд╛ред\
`AMFI.kext` рдбреЗрдорди рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `HOST_AMFID_PORT` рдкрд░ рдордЪ рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ `18` рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ macOS рдореЗрдВ рдЕрдм рд░реВрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЗрдВ `SIP` рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдХреЗрд╡рд▓ launchd рдЙрдиреНрд╣реЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред iOS рдореЗрдВ рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд╛рдкрд╕ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `amfid` рдХрд╛ CDHash рд╣рд╛рд░реНрдбрдХреЛрдбреЗрдб рд╣реИред

рдЬрдм `amfid` рдХреЛ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрддреНрддрд░ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ рдбрд┐рдмрдЧ рдХрд░рдХреЗ рдФрд░ `mach_msg` рдореЗрдВ рдПрдХ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд╕реЗрдЯ рдХрд░рдХреЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдПрдХ рдмрд╛рд░ рдЬрдм рд╡рд┐рд╢реЗрд╖ рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ **MIG** рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░рддреНрдпреЗрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдпрд╣ рдХреЙрд▓ рдХрд░ рд░рд╣рд╛ рд╣реИред рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рдВрд╕ рдХреЛ рдЙрд▓рдЯрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдФрд░ рдкреБрд╕реНрддрдХ рдХреЗ рдЕрдВрджрд░ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ред

## Provisioning Profiles

рдПрдХ рдкреНрд░реЛрд╡рд┐рдЬрдирд┐рдВрдЧ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреЛрдб рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред **рдбреЗрд╡рд▓рдкрд░** рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХреЛрдб рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдФрд░ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ **рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ** рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╣реИрдВ рдЬреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

рдПрдХ рдРрдк рдХреЛ Apple Store рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрджрд┐ рд╕реНрд╡реАрдХреГрдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ Apple рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкреНрд░реЛрд╡рд┐рдЬрдирд┐рдВрдЧ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреА рдЕрдм рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред

рдПрдХ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЖрдорддреМрд░ рдкрд░ `.mobileprovision` рдпрд╛ `.provisionprofile` рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ рдФрд░ рдЗрд╕реЗ рдбрдВрдк рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
openssl asn1parse -inform der -in /path/to/profile

# Or

security cms -D -i /path/to/profile
```
рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрднреА-рдХрднреА рдЗрдиреНрд╣реЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпреЗ рдкреНрд░реЛрд╡рд┐рдЬрдирд┐рдВрдЧ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛрддреЗ рд╣реИрдВ:

* **AppIDName:** рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛
* **AppleInternalProfile**: рдЗрд╕реЗ рдПрдХ Apple рдЖрдВрддрд░рд┐рдХ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ
* **ApplicationIdentifierPrefix**: AppIDName рдХреЗ рдЖрдЧреЗ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ (TeamIdentifier рдХреЗ рд╕рдорд╛рди)
* **CreationDate**: `YYYY-MM-DDTHH:mm:ssZ` рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рддрд╛рд░реАрдЦ
* **DeveloperCertificates**: (рдЖрдорддреМрд░ рдкрд░ рдПрдХ) рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХрд╛ рдПрдХ рд╕рд░рдгреА, рдЬреЛ Base64 рдбреЗрдЯрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдиреНрдХреЛрдбреЗрдб рд╣реИ
* **Entitlements**: рдЗрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдордд рдЕрдзрд┐рдХрд╛рд░
* **ExpirationDate**: `YYYY-MM-DDTHH:mm:ssZ` рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╕рдорд╛рдкреНрддрд┐ рддрд┐рдерд┐
* **Name**: рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ рдирд╛рдо, рдЬреЛ AppIDName рдХреЗ рд╕рдорд╛рди рд╣реИ
* **ProvisionedDevices**: UDIDs рдХреА рдПрдХ рд╕рд░рдгреА (рдбреЗрд╡рд▓рдкрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП) рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдпрд╣ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдорд╛рдиреНрдп рд╣реИ
* **ProvisionsAllDevices**: рдПрдХ рдмреВрд▓рд┐рдпрди (рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рддреНрдп)
* **TeamIdentifier**: (рдЖрдорддреМрд░ рдкрд░ рдПрдХ) рдЕрд▓реНрдлрд╝рд╛рдиреНрдпреВрдореЗрд░рд┐рдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ(s) рдХреА рдПрдХ рд╕рд░рдгреА рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЗрдВрдЯрд░-рдРрдк рдЗрдВрдЯрд░реИрдХреНрд╢рди рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдбреЗрд╡рд▓рдкрд░ рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ
* **TeamName**: рдбреЗрд╡рд▓рдкрд░ рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдорд╛рдирд╡-рдкрдардиреАрдп рдирд╛рдо
* **TimeToLive**: рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рд╡реИрдзрддрд╛ (рджрд┐рдиреЛрдВ рдореЗрдВ)
* **UUID**: рдЗрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдпреВрдирд┐рд╡рд░реНрд╕рд▓реА рдпреВрдирд┐рдХ рдЖрдЗрдбреЗрдВрдЯрд┐рдлрд╛рдпрд░
* **Version**: рд╡рд░реНрддрдорд╛рди рдореЗрдВ 1 рдкрд░ рд╕реЗрдЯ

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдореЗрдВ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдПрдХ рд╕реАрдорд┐рдд рд╕реЗрдЯ рд╣реЛрдЧрд╛ рдФрд░ рдкреНрд░реЛрд╡рд┐рдЬрдирд┐рдВрдЧ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗрд╡рд▓ рдЙрди рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рджреЗрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧреА рддрд╛рдХрд┐ Apple рдХреЗ рдирд┐рдЬреА рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рд╕реЗ рд░реЛрдХрд╛ рдЬрд╛ рд╕рдХреЗред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдЖрдорддреМрд░ рдкрд░ `/var/MobileDeviceProvisioningProfiles` рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЗрдиреНрд╣реЗрдВ **`security cms -D -i /path/to/profile`** рдХреЗ рд╕рд╛рде рдЬрд╛рдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИред

## **libmis.dyld**

рдпрд╣ рдмрд╛рд╣рд░реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╣реИ рдЬрд┐рд╕реЗ `amfid` рдпрд╣ рдкреВрдЫрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЗрд╕реЗ рдХреБрдЫ рдЕрдиреБрдорддрд┐ рджреЗрдиреА рдЪрд╛рд╣рд┐рдП рдпрд╛ рдирд╣реАрдВред рдЗрд╕рдХрд╛ рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд░реВрдк рд╕реЗ рдЬреЗрд▓рдмреНрд░реЗрдХрд┐рдВрдЧ рдореЗрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЗрд╕рдХрд╛ рдПрдХ рдмреИрдХрдбреЛрд░ рд╕рдВрд╕реНрдХрд░рдг рдЪрд▓рд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ рд╕рдм рдХреБрдЫ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛ред

macOS рдореЗрдВ рдпрд╣ `MobileDevice.framework` рдХреЗ рдЕрдВрджрд░ рд╣реИред

## AMFI Trust Caches

iOS AMFI рдЬреНрдЮрд╛рдд рд╣реИрд╢ рдХреА рдПрдХ рд╕реВрдЪреА рдмрдирд╛рдП рд░рдЦрддрд╛ рд╣реИ рдЬреЛ рдРрдб-рд╣реЙрдХ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ **Trust Cache** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ kext рдХреЗ `__TEXT.__const` рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдмрд╣реБрдд рд╡рд┐рд╢рд┐рд╖реНрдЯ рдФрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рдВрдЪрд╛рд▓рди рдореЗрдВ, рдЗрд╕ Trust Cache рдХреЛ рдПрдХ рдмрд╛рд╣рд░реА рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде рдмрдврд╝рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИред

## References

* [**\*OS Internals Volume III**](https://newosxbook.com/home.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
