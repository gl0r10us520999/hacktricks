# macOS - AMFI - AppleMobileFileIntegrity

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}



## AppleMobileFileIntegrity.kext —Ç–∞ amfid

–í—ñ–Ω –∑–æ—Å–µ—Ä–µ–¥–∂—É—î—Ç—å—Å—è –Ω–∞ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—ñ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –∫–æ–¥—É, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º—ñ, –Ω–∞–¥–∞—é—á–∏ –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å—É –∫–æ–¥—É XNU. –í—ñ–Ω —Ç–∞–∫–æ–∂ –º–æ–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É —Ç–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ —á—É—Ç–ª–∏–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, —Ç–∞–∫—ñ —è–∫ –¥–æ–∑–≤–æ–ª–µ–Ω–Ω—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –∞–±–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ä—Ç—ñ–≤ –∑–∞–≤–¥–∞–Ω—å.

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, –¥–ª—è –¥–µ—è–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π kext –Ω–∞–¥–∞—î –ø–µ—Ä–µ–≤–∞–≥—É –∑–≤'—è–∑–∫—É –∑ –¥–µ–º–æ–Ω–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É `/usr/libexec/amfid`. –¶—è –¥–æ–≤—ñ—Ä—á–∞ –≤–∑–∞—î–º–æ–∑–≤'—è–∑–æ–∫ –±—É–ª–∞ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–∞ –≤ –∫—ñ–ª—å–∫–æ—Ö –¥–∂–µ–π–ª–±—Ä–µ–π–∫–∞—Ö.

AMFI –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **MACF** –ø–æ–ª—ñ—Ç–∏–∫–∏ —ñ —Ä–µ—î—Å—Ç—Ä—É—î —Å–≤–æ—ó —Ö—É–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –∑–∞–ø—É—Å–∫—É. –¢–∞–∫–æ–∂, –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –π–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é –∞–±–æ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø–∞–Ω—ñ–∫—É —è–¥—Ä–∞. –û–¥–Ω–∞–∫ —î –∫—ñ–ª—å–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –æ—Å–ª–∞–±–∏—Ç–∏ AMFI:

* `amfi_unrestricted_task_for_pid`: –î–æ–∑–≤–æ–ª–∏—Ç–∏ task\_for\_pid –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É
* `amfi_allow_any_signature`: –î–æ–∑–≤–æ–ª–∏—Ç–∏ –±—É–¥—å-—è–∫–∏–π –ø—ñ–¥–ø–∏—Å –∫–æ–¥—É
* `cs_enforcement_disable`: –ê—Ä–≥—É–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–∏–º—É—Å—É –ø—ñ–¥–ø–∏—Å—É –∫–æ–¥—É
* `amfi_prevent_old_entitled_platform_binaries`: –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–Ω—ñ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø—É
* `amfi_get_out_of_my_way`: –ü–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–º–∏–∫–∞—î amfi

–¶–µ –¥–µ—è–∫—ñ –∑ –ø–æ–ª—ñ—Ç–∏–∫ MACF, —è–∫—ñ –≤—ñ–Ω —Ä–µ—î—Å—Ç—Ä—É—î:

* **`cred_check_label_update_execve:`** –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ—Ç–∫–∏ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–æ —ñ –ø–æ–≤–µ—Ä–Ω–µ 1
* **`cred_label_associate`**: –û–Ω–æ–≤–∏—Ç–∏ —Å–ª–æ—Ç –º—ñ—Ç–∫–∏ mac AMFI
* **`cred_label_destroy`**: –í–∏–¥–∞–ª–∏—Ç–∏ —Å–ª–æ—Ç –º—ñ—Ç–∫–∏ mac AMFI
* **`cred_label_init`**: –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ 0 –≤ —Å–ª–æ—Ç –º—ñ—Ç–∫–∏ mac AMFI
* **`cred_label_update_execve`:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –ø—Ä–æ—Ü–µ—Å—É, —â–æ–± –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —á–∏ —Å–ª—ñ–¥ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–º—ñ–Ω—É –º—ñ—Ç–æ–∫.
* **`file_check_mmap`:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ mmap –æ—Ç—Ä–∏–º—É—î –ø–∞–º'—è—Ç—å —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î —ó—ó —è–∫ –≤–∏–∫–æ–Ω—É–≤–∞–Ω—É. –£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —ñ —è–∫—â–æ —Ç–∞–∫, –≤–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏.
* **`file_check_library_validation`**: –í–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —è–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —Å–µ—Ä–µ–¥ —ñ–Ω—à–æ–≥–æ, —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –ø–ª–∞—Ç—Ñ–æ—Ä–º–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª —ñ–Ω—à–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –∞–±–æ —á–∏ –º–∞—î –ø—Ä–æ—Ü–µ—Å —ñ –Ω–æ–≤–∏–π –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π —Ñ–∞–π–ª –æ–¥–Ω–∞–∫–æ–≤–∏–π TeamID. –î–µ—è–∫—ñ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É —Ç–∞–∫–æ–∂ –¥–æ–∑–≤–æ–ª—è—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—É–¥—å-—è–∫—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É.
* **`policy_initbsd`**: –ù–∞–ª–∞—à—Ç–æ–≤—É—î –¥–æ–≤—ñ—Ä–µ–Ω—ñ –∫–ª—é—á—ñ NVRAM
* **`policy_syscall`**: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø–æ–ª—ñ—Ç–∏–∫–∏ DYLD, —Ç–∞–∫—ñ —è–∫ —á–∏ –º–∞—î –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –Ω–µ–æ–±–º–µ–∂–µ–Ω—ñ —Å–µ–≥–º–µ–Ω—Ç–∏, —á–∏ —Å–ª—ñ–¥ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞... —Ü–µ —Ç–∞–∫–æ–∂ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ –ø—Ä–æ—Ü–µ—Å –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `amfi_check_dyld_policy_self()`.
* **`proc_check_inherit_ipc_ports`**: –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –ø–æ–≤–∏–Ω–Ω—ñ —ñ–Ω—à—ñ –ø—Ä–æ—Ü–µ—Å–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ SEND –Ω–∞ –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —ó—Ö, –∫–æ–ª–∏ –ø—Ä–æ—Ü–µ—Å –≤–∏–∫–æ–Ω—É—î –Ω–æ–≤–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª. –ü–ª–∞—Ç—Ñ–æ—Ä–º–Ω—ñ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ, –ø—Ä–∞–≤–æ `get-task-allow` —Ü–µ –¥–æ–∑–≤–æ–ª—è—î, –ø—Ä–∞–≤–∞ `task_for_pid-allow` –¥–æ–∑–≤–æ–ª–µ–Ω—ñ, –∞ —Ç–∞–∫–æ–∂ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º TeamID.
* **`proc_check_expose_task`**: –∑–∞–±–µ–∑–ø–µ—á—É—î –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É
* **`amfi_exc_action_check_exception_send`**: –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞–ª–∞–≥–æ–¥–∂—É–≤–∞—á—É
* **`amfi_exc_action_label_associate & amfi_exc_action_label_copy/populate & amfi_exc_action_label_destroy & amfi_exc_action_label_init & amfi_exc_action_label_update`**: –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –º—ñ—Ç–∫–∏ –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ –≤–∏–∫–ª—é—á–µ–Ω—å (–Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è)
* **`proc_check_get_task`**: –ü–µ—Ä–µ–≤—ñ—Ä—è—î –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É, —Ç–∞–∫—ñ —è–∫ `get-task-allow`, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å —ñ–Ω—à–∏–º –ø—Ä–æ—Ü–µ—Å–∞–º –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ—Ä—Ç –∑–∞–≤–¥–∞–Ω—å, —ñ `task_for_pid-allow`, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –ø—Ä–æ—Ü–µ—Å—É –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–æ—Ä—Ç–∏ –∑–∞–≤–¥–∞–Ω—å —ñ–Ω—à–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤. –Ø–∫—â–æ –∂–æ–¥–µ–Ω –∑ —Ü–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å, –≤–∏–∫–ª–∏–∫–∞—î `amfid permitunrestricteddebugging`, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —Ü–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ.
* **`proc_check_mprotect`**: –í—ñ–¥–º–æ–≤–ª—è—î, —è–∫—â–æ `mprotect` –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ –ø—Ä–∞–ø–æ—Ä–æ–º `VM_PROT_TRUSTED`, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ —Ä–µ–≥—ñ–æ–Ω –ø–æ–≤–∏–Ω–µ–Ω –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è —Ç–∞–∫, –Ω—ñ–±–∏ –º–∞—î –¥—ñ–π—Å–Ω–∏–π –ø—ñ–¥–ø–∏—Å –∫–æ–¥—É.
* **`vnode_check_exec`**: –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ –≤–∏–∫–æ–Ω—É–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—å, —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î `cs_hard | cs_kill`, —â–æ –≤–±'—î –ø—Ä–æ—Ü–µ—Å, —è–∫—â–æ –±—É–¥—å-—è–∫–∞ –∑ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —Å—Ç–∞–Ω–µ –Ω–µ–¥—ñ–π—Å–Ω–æ—é
* **`vnode_check_getextattr`**: MacOS: –ü–µ—Ä–µ–≤—ñ—Ä—è—î `com.apple.root.installed` —Ç–∞ `isVnodeQuarantined()`
* **`vnode_check_setextattr`**: –Ø–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ + com.apple.private.allow-bless —Ç–∞ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —ñ–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä–∞
* &#x20;**`vnode_check_signature`**: –ö–æ–¥, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î XNU –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å—É –∫–æ–¥—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É, –∫–µ—à—É –¥–æ–≤—ñ—Ä–∏ —Ç–∞ `amfid`
* &#x20;**`proc_check_run_cs_invalid`**: –ü–µ—Ä–µ—Ö–æ–ø–ª—é—î –≤–∏–∫–ª–∏–∫–∏ `ptrace()` (`PT_ATTACH` —Ç–∞ `PT_TRACE_ME`). –ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –±—É–¥—å-—è–∫–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É `get-task-allow`, `run-invalid-allow` —Ç–∞ `run-unsigned-code`, —ñ —è–∫—â–æ –∂–æ–¥–µ–Ω –∑ –Ω–∏—Ö –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å, –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è.
* **`proc_check_map_anon`**: –Ø–∫—â–æ mmap –≤–∏–∫–ª–∏–∫–∞–Ω–æ –∑ –ø—Ä–∞–ø–æ—Ä–æ–º **`MAP_JIT`**, AMFI –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –ø—Ä–∞–≤–æ `dynamic-codesigning`.

`AMFI.kext` —Ç–∞–∫–æ–∂ –Ω–∞–¥–∞—î API –¥–ª—è —ñ–Ω—à–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å —è–¥—Ä–∞, —ñ –º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–π—Ç–∏ –π–æ–≥–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
kextstat | grep " 19 " | cut -c2-5,50- | cut -d '(' -f1
Executing: /usr/bin/kmutil showloaded
No variant specified, falling back to release
8   com.apple.kec.corecrypto
19   com.apple.driver.AppleMobileFileIntegrity
22   com.apple.security.sandbox
24   com.apple.AppleSystemPolicy
67   com.apple.iokit.IOUSBHostFamily
70   com.apple.driver.AppleUSBTDM
71   com.apple.driver.AppleSEPKeyStore
74   com.apple.iokit.EndpointSecurity
81   com.apple.iokit.IOUserEthernet
101   com.apple.iokit.IO80211Family
102   com.apple.driver.AppleBCMWLANCore
118   com.apple.driver.AppleEmbeddedUSBHost
134   com.apple.iokit.IOGPUFamily
135   com.apple.AGXG13X
137   com.apple.iokit.IOMobileGraphicsFamily
138   com.apple.iokit.IOMobileGraphicsFamily-DCP
162   com.apple.iokit.IONVMeFamily
```
## amfid

–¶–µ –¥–µ–º–æ–Ω, —â–æ –ø—Ä–∞—Ü—é—î –≤ —Ä–µ–∂–∏–º—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `AMFI.kext` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å—ñ–≤ –∫–æ–¥—É –≤ —Ä–µ–∂–∏–º—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.\
–î–ª—è —Ç–æ–≥–æ, —â–æ–± `AMFI.kext` –º—ñ–≥ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –¥–µ–º–æ–Ω–æ–º, –≤—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î mach-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç `HOST_AMFID_PORT`, —è–∫–∏–π —î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–º –ø–æ—Ä—Ç–æ–º `18`.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ macOS –±—ñ–ª—å—à–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ, —â–æ–± –ø—Ä–æ—Ü–µ—Å–∏ root –∑–∞—Ö–æ–ø–ª—é–≤–∞–ª–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –ø–æ—Ä—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –∑–∞—Ö–∏—â–µ–Ω—ñ `SIP`, —ñ –ª–∏—à–µ launchd –º–æ–∂–µ —ó—Ö –æ—Ç—Ä–∏–º–∞—Ç–∏. –í iOS –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è, —â–æ –ø—Ä–æ—Ü–µ—Å, —è–∫–∏–π –Ω–∞–¥—Å–∏–ª–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –º–∞—î CDHash, –∑–∞–∫–æ–¥–æ–≤–∞–Ω–∏–π –¥–ª—è `amfid`.

–ú–æ–∂–ª–∏–≤–æ –ø–æ–±–∞—á–∏—Ç–∏, –∫–æ–ª–∏ `amfid` –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É —Ç–∞ –π–æ–≥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å, –≤—ñ–¥–ª–∞–≥–æ–¥–∂—É—é—á–∏ –π–æ–≥–æ —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—á–∏ —Ç–æ—á–∫—É –∑—É–ø–∏–Ω–∫–∏ –≤ `mach_msg`.

–ö–æ–ª–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –ø–æ—Ä—Ç, **MIG** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–æ–∂–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—É –≤–æ–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—î. –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –±—É–ª–∏ —Ä–µ–≤–µ—Ä—Å–æ–≤–∞–Ω—ñ —Ç–∞ –ø–æ—è—Å–Ω–µ–Ω—ñ –≤ –∫–Ω–∏–∑—ñ.

## Provisioning Profiles

–ü—Ä–æ—Ñ—ñ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è –∫–æ–¥—É. –Ñ **Developer** –ø—Ä–æ—Ñ—ñ–ª—ñ, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è –∫–æ–¥—É —Ç–∞ –π–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, —ñ **Enterprise** –ø—Ä–æ—Ñ—ñ–ª—ñ, —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –Ω–∞ –≤—Å—ñ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö.

–ü—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –¥–æ–¥–∞—Ç–æ–∫ –ø–æ–¥–∞—î—Ç—å—Å—è –¥–æ Apple Store, —è–∫—â–æ –π–æ–≥–æ –∑–∞—Ç–≤–µ—Ä–¥–∂—É—é—Ç—å, –≤—ñ–Ω –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è Apple, —ñ –ø—Ä–æ—Ñ—ñ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω.

–ü—Ä–æ—Ñ—ñ–ª—å –∑–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è `.mobileprovision` –∞–±–æ `.provisionprofile` —ñ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
openssl asn1parse -inform der -in /path/to/profile

# Or

security cms -D -i /path/to/profile
```
–•–æ—á–∞ —ñ–Ω–æ–¥—ñ —ó—Ö –Ω–∞–∑–∏–≤–∞—é—Ç—å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º–∏, —Ü—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–∞—é—Ç—å –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç:

* **AppIDName:** –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–∏
* **AppleInternalProfile**: –ü–æ–∑–Ω–∞—á–∞—î —Ü–µ —è–∫ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å Apple
* **ApplicationIdentifierPrefix**: –î–æ–¥–∞—î—Ç—å—Å—è –¥–æ AppIDName (—Ç–∞–∫ —Å–∞–º–æ, —è–∫ TeamIdentifier)
* **CreationDate**: –î–∞—Ç–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ `YYYY-MM-DDTHH:mm:ssZ`
* **DeveloperCertificates**: –ú–∞—Å–∏–≤ (–∑–∞–∑–≤–∏—á–∞–π –æ–¥–∏–Ω) —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç(—ñ–≤), –∑–∞–∫–æ–¥–æ–≤–∞–Ω–∏—Ö —É —Ñ–æ—Ä–º–∞—Ç—ñ Base64
* **Entitlements**: –ü—Ä–∞–≤–∞, –¥–æ–∑–≤–æ–ª–µ–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
* **ExpirationDate**: –î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ `YYYY-MM-DDTHH:mm:ssZ`
* **Name**: –ù–∞–∑–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∏, —Ç–∞–∫–∞ –∂, —è–∫ AppIDName
* **ProvisionedDevices**: –ú–∞—Å–∏–≤ (–¥–ª—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞) UDID, –¥–ª—è —è–∫–∏—Ö —Ü–µ–π –ø—Ä–æ—Ñ—ñ–ª—å —î –¥—ñ–π—Å–Ω–∏–º
* **ProvisionsAllDevices**: –õ–æ–≥—ñ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è (true –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤)
* **TeamIdentifier**: –ú–∞—Å–∏–≤ (–∑–∞–∑–≤–∏—á–∞–π –æ–¥–∏–Ω) –∞–ª—Ñ–∞–≤—ñ—Ç–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤–∏–π —Ä—è–¥–æ–∫(–∏), —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ –¥–ª—è –º—ñ–∂–ø—Ä–æ–≥—Ä–∞–º–Ω–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó
* **TeamName**: –õ—é–¥—Å—å–∫–µ —ñ–º'—è, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞
* **TimeToLive**: –¢–µ—Ä–º—ñ–Ω –¥—ñ—ó (–≤ –¥–Ω—è—Ö) —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞
* **UUID**: –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
* **Version**: –í –¥–∞–Ω–∏–π —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 1

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∑–∞–ø–∏—Å –ø—Ä–∞–≤ –º—ñ—Å—Ç–∏—Ç–∏–º–µ –æ–±–º–µ–∂–µ–Ω–∏–π –Ω–∞–±—ñ—Ä –ø—Ä–∞–≤, —ñ –ø—Ä–æ—Ñ—ñ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º–æ–∂–µ –Ω–∞–¥–∞—Ç–∏ –ª–∏—à–µ —Ü—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –ø—Ä–∞–≤–∞, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –Ω–∞–¥–∞–Ω–Ω—é –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –ø—Ä–∞–≤ Apple.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –ø—Ä–æ—Ñ—ñ–ª—ñ –∑–∞–∑–≤–∏—á–∞–π —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –≤ `/var/MobileDeviceProvisioningProfiles`, —ñ —ó—Ö –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **`security cms -D -i /path/to/profile`**

## **libmis.dyld**

–¶–µ –∑–æ–≤–Ω—ñ—à–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞, —è–∫—É –≤–∏–∫–ª–∏–∫–∞—î `amfid`, —â–æ–± –∑–∞–ø–∏—Ç–∞—Ç–∏, —á–∏ —Å–ª—ñ–¥ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ —â–æ—Å—å —á–∏ –Ω—ñ. –Ü—Å—Ç–æ—Ä–∏—á–Ω–æ —Ü–µ –∑–ª–æ–≤–∂–∏–≤–∞–ª–æ—Å—è –≤ –¥–∂–µ–π–ª–±—Ä–µ–π–∫—ñ–Ω–≥—É —à–ª—è—Ö–æ–º –∑–∞–ø—É—Å–∫—É –∑–ª–∞–º–∞–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è–ª–∞ –≤—Å–µ.

–£ macOS —Ü–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `MobileDevice.framework`.

## AMFI Trust Caches

iOS AMFI –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å–ø–∏—Å–æ–∫ –≤—ñ–¥–æ–º–∏—Ö —Ö–µ—à—ñ–≤, —è–∫—ñ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ ad-hoc, –∑–≤–∞–Ω–∏–π **Trust Cache** —ñ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Å–µ–∫—Ü—ñ—ó kext `__TEXT.__const`. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ –¥—É–∂–µ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏—Ö —ñ —á—É—Ç–ª–∏–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö –º–æ–∂–ª–∏–≤–æ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ —Ü–µ–π Trust Cache –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ —Ñ–∞–π–ª—É.

## References

* [**\*OS Internals Volume III**](https://newosxbook.com/home.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
