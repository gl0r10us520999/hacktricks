# macOS Sandbox

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Î¤Î¿ macOS Sandbox (Î±ÏÏ‡Î¹ÎºÎ¬ Î¿Î½Î¿Î¼Î±Î¶ÏŒÏ„Î±Î½ Seatbelt) **Ï€ÎµÏÎ¹Î¿ÏÎ¯Î¶ÎµÎ¹ Ï„Î¹Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚** Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ sandbox ÏƒÏ„Î¹Ï‚ **ÎµÏ€Î¹Ï„ÏÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… ÎºÎ±Î¸Î¿ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ Ï€ÏÎ¿Ï†Î¯Î» Sandbox** Î¼Îµ Ï„Î¿ Î¿Ï€Î¿Î¯Î¿ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®. Î‘Ï…Ï„ÏŒ Î²Î¿Î·Î¸Î¬ Î½Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¹ÏƒÏ„ÎµÎ¯ ÏŒÏ„Î¹ **Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î¸Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î¼ÏŒÎ½Î¿ ÏƒÎµ Î±Î½Î±Î¼ÎµÎ½ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ Ï€ÏŒÏÎ¿Ï…Ï‚**.

ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î¼Îµ Ï„Î·Î½ **Ï€Î±ÏÎ¿Ï‡Î®** **`com.apple.security.app-sandbox`** Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ sandbox. **ÎŸÎ¹ Î´Ï…Î±Î´Î¹ÎºÎ¿Î¯ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Ï„Î·Ï‚ Apple** ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± Sandbox, ÎºÎ±Î¹ ÏŒÎ»ÎµÏ‚ Î¿Î¹ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Î±Ï€ÏŒ Ï„Î¿ **App Store Î­Ï‡Î¿Ï…Î½ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î±ÏÎ¿Ï‡Î®**. ÎˆÏ„ÏƒÎ¹, Ï€Î¿Î»Î»Î­Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Î¸Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ sandbox.

Î“Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Ï„Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î® Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎºÎ¬Î½ÎµÎ¹ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±, Ï„Î¿ **Sandbox Î­Ï‡ÎµÎ¹ hooks** ÏƒÎµ ÏƒÏ‡ÎµÎ´ÏŒÎ½ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÎ¹ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÏ‰Î½ syscalls) Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ **MACF**. Î©ÏƒÏ„ÏŒÏƒÎ¿, **Î±Î½Î¬Î»Î¿Î³Î±** Î¼Îµ Ï„Î¹Ï‚ **Ï€Î±ÏÎ¿Ï‡Î­Ï‚** Ï„Î·Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚, Ï„Î¿ Sandbox Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎµÏ€Î¹ÎµÎ¹ÎºÎ­Ï‚ Î¼Îµ Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±.

ÎŸÏÎ¹ÏƒÎ¼Î­Î½Î± ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Î¿Ï… Sandbox ÎµÎ¯Î½Î±Î¹:

* Î— **ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï€Ï…ÏÎ®Î½Î±** `/System/Library/Extensions/Sandbox.kext`
* Î¤Î¿ **Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒ Ï€Î»Î±Î¯ÏƒÎ¹Î¿** `/System/Library/PrivateFrameworks/AppSandbox.framework`
* ÎˆÎ½Î±Ï‚ **daemon** Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î¿ userland `/usr/libexec/sandboxd`
* ÎŸÎ¹ **ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ** `~/Library/Containers`

### Containers

ÎšÎ¬Î¸Îµ sandboxed ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î¸Î± Î­Ï‡ÎµÎ¹ Ï„Î¿ Î´Î¹ÎºÏŒ Ï„Î·Ï‚ ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ ÏƒÏ„Î¿ `~/Library/Containers/{CFBundleIdentifier}` :
```bash
ls -l ~/Library/Containers
total 0
drwx------@ 4 username  staff  128 May 23 20:20 com.apple.AMPArtworkAgent
drwx------@ 4 username  staff  128 May 23 20:13 com.apple.AMPDeviceDiscoveryAgent
drwx------@ 4 username  staff  128 Mar 24 18:03 com.apple.AVConference.Diagnostic
drwx------@ 4 username  staff  128 Mar 25 14:14 com.apple.Accessibility-Settings.extension
drwx------@ 4 username  staff  128 Mar 25 14:10 com.apple.ActionKit.BundledIntentHandler
[...]
```
ÎœÎ­ÏƒÎ± ÏƒÎµ ÎºÎ¬Î¸Îµ Ï†Î¬ÎºÎµÎ»Î¿ bundle id Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Ï„Î¿ **plist** ÎºÎ±Î¹ Ï„Î¿Î½ **Ï†Î¬ÎºÎµÎ»Î¿ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½** Ï„Î·Ï‚ Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚ Î¼Îµ Î¼Î¹Î± Î´Î¿Î¼Î® Ï€Î¿Ï… Î¼Î¹Î¼ÎµÎ¯Ï„Î±Î¹ Ï„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿ Home:
```bash
cd /Users/username/Library/Containers/com.apple.Safari
ls -la
total 104
drwx------@   4 username  staff    128 Mar 24 18:08 .
drwx------  348 username  staff  11136 May 23 20:57 ..
-rw-r--r--    1 username  staff  50214 Mar 24 18:08 .com.apple.containermanagerd.metadata.plist
drwx------   13 username  staff    416 Mar 24 18:05 Data

ls -l Data
total 0
drwxr-xr-x@  8 username  staff   256 Mar 24 18:08 CloudKit
lrwxr-xr-x   1 username  staff    19 Mar 24 18:02 Desktop -> ../../../../Desktop
drwx------   2 username  staff    64 Mar 24 18:02 Documents
lrwxr-xr-x   1 username  staff    21 Mar 24 18:02 Downloads -> ../../../../Downloads
drwx------  35 username  staff  1120 Mar 24 18:08 Library
lrwxr-xr-x   1 username  staff    18 Mar 24 18:02 Movies -> ../../../../Movies
lrwxr-xr-x   1 username  staff    17 Mar 24 18:02 Music -> ../../../../Music
lrwxr-xr-x   1 username  staff    20 Mar 24 18:02 Pictures -> ../../../../Pictures
drwx------   2 username  staff    64 Mar 24 18:02 SystemData
drwx------   2 username  staff    64 Mar 24 18:02 tmp
```
{% hint style="danger" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¹ Î±Î½ Ï„Î± symlinks ÎµÎ¯Î½Î±Î¹ ÎµÎºÎµÎ¯ Î³Î¹Î± Î½Î± "Î´Î¹Î±Ï†ÏÎ³Î¿Ï…Î½" Î±Ï€ÏŒ Ï„Î¿ Sandbox ÎºÎ±Î¹ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎ¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î¬Î»Î»Î¿Ï…Ï‚ Ï†Î±ÎºÎ­Î»Î¿Ï…Ï‚, Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± **Î­Ï‡ÎµÎ¹ Î¬Î´ÎµÎ¹ÎµÏ‚** Î³Î¹Î± Î½Î± Ï„Î¿Ï…Ï‚ Ï€ÏÎ¿ÏƒÏ€ÎµÎ»Î¬ÏƒÎµÎ¹. Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ Î¬Î´ÎµÎ¹ÎµÏ‚ Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ **`.plist`** ÏƒÏ„Î¿ `RedirectablePaths`.
{% endhint %}

Î¤Î¿ **`SandboxProfileData`** ÎµÎ¯Î½Î±Î¹ Ï„Î¿ ÏƒÏ…Î¼Ï€Î¹ÎµÏƒÎ¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» sandbox CFData Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ Î´Î¹Î±Ï†ÏÎ³ÎµÎ¹ ÏƒÎµ B64.
```bash
# Get container config
## You need FDA to access the file, not even just root can read it
plutil -convert xml1 .com.apple.containermanagerd.metadata.plist -o -

# Binary sandbox profile
<key>SandboxProfileData</key>
<data>
AAAhAboBAAAAAAgAAABZAO4B5AHjBMkEQAUPBSsGPwsgASABHgEgASABHwEf...

# In this file you can find the entitlements:
<key>Entitlements</key>
<dict>
<key>com.apple.MobileAsset.PhishingImageClassifier2</key>
<true/>
<key>com.apple.accounts.appleaccount.fullaccess</key>
<true/>
<key>com.apple.appattest.spi</key>
<true/>
<key>keychain-access-groups</key>
<array>
<string>6N38VWS5BX.ru.keepcoder.Telegram</string>
<string>6N38VWS5BX.ru.keepcoder.TelegramShare</string>
</array>
[...]

# Some parameters
<key>Parameters</key>
<dict>
<key>_HOME</key>
<string>/Users/username</string>
<key>_UID</key>
<string>501</string>
<key>_USER</key>
<string>username</string>
[...]

# The paths it can access
<key>RedirectablePaths</key>
<array>
<string>/Users/username/Downloads</string>
<string>/Users/username/Documents</string>
<string>/Users/username/Library/Calendars</string>
<string>/Users/username/Desktop</string>
<key>RedirectedPaths</key>
<array/>
[...]
```
{% hint style="warning" %}
ÎŒ,Ï„Î¹ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Î±Î¹/Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Î¼Î¹Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Sandbox Î¸Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÎ¹ Ï„Î¿ **attribute ÎºÎ±ÏÎ±Î½Ï„Î¯Î½Î±Ï‚**. Î‘Ï…Ï„ÏŒ Î¸Î± Î±Ï€Î¿Ï„ÏÎ­ÏˆÎµÎ¹ Î­Î½Î±Î½ Ï‡ÏÏÎ¿ sandbox ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¿Î½ Gatekeeper Î±Î½ Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î® sandbox Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÎ¹ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ ÎºÎ¬Ï„Î¹ Î¼Îµ **`open`**.
{% endhint %}

## Sandbox Î ÏÎ¿Ï†Î¯Î»

Î¤Î± Sandbox Ï€ÏÎ¿Ï†Î¯Î» ÎµÎ¯Î½Î±Î¹ Î±ÏÏ‡ÎµÎ¯Î± ÏÏÎ¸Î¼Î¹ÏƒÎ·Ï‚ Ï€Î¿Ï… Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎ¿Ï…Î½ Ï„Î¹ Î¸Î± ÎµÎ¯Î½Î±Î¹ **ÎµÏ€Î¹Ï„ÏÎµÏ€Ï„ÏŒ/Î±Ï€Î±Î³Î¿ÏÎµÏ…Î¼Î­Î½Î¿** ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ **Sandbox**. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î· **Î“Î»ÏÏƒÏƒÎ± Î ÏÎ¿Ï†Î¯Î» Sandbox (SBPL)**, Î· Î¿Ï€Î¿Î¯Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î· Î³Î»ÏÏƒÏƒÎ± Ï€ÏÎ¿Î³ÏÎ±Î¼Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï [**Scheme**](https://en.wikipedia.org/wiki/Scheme\_\(programming\_language\)).

Î•Î´Ï Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±:
```scheme
(version 1) ; First you get the version

(deny default) ; Then you shuold indicate the default action when no rule applies

(allow network*) ; You can use wildcards and allow everything

(allow file-read* ; You can specify where to apply the rule
(subpath "/Users/username/")
(literal "/tmp/afile")
(regex #"^/private/etc/.*")
)

(allow mach-lookup
(global-name "com.apple.analyticsd")
)
```
{% hint style="success" %}
Î”ÎµÎ¯Ï„Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ [**Î­ÏÎµÏ…Î½Î±**](https://reverse.put.as/2011/09/14/apple-sandbox-guide-v1-0/) **Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î½ Î½Î± ÎµÏ€Î¹Ï„ÏÎ±Ï€Î¿ÏÎ½ Î® Î½Î± Î±Ï€Î¿ÏÏÎ¹Ï†Î¸Î¿ÏÎ½.**

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ ÏƒÏ„Î·Î½ ÏƒÏ…Î¼Ï€Î¹ÎµÏƒÎ¼Î­Î½Î· Î­ÎºÎ´Î¿ÏƒÎ· ÎµÎ½ÏŒÏ‚ Ï€ÏÎ¿Ï†Î¯Î», Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Ï‰Î½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÏÎ½ Î±Î½Ï„Î¹ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ¯ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï…Ï‚ ÏƒÎµ Î­Î½Î±Î½ Ï€Î¯Î½Î±ÎºÎ± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î¿ dylib ÎºÎ±Î¹ Ï„Î¿ kext, ÎºÎ±Î¸Î¹ÏƒÏ„ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ ÏƒÏ…Î¼Ï€Î¹ÎµÏƒÎ¼Î­Î½Î· Î­ÎºÎ´Î¿ÏƒÎ· Ï€Î¹Î¿ ÏƒÏÎ½Ï„Î¿Î¼Î· ÎºÎ±Î¹ Ï€Î¹Î¿ Î´ÏÏƒÎºÎ¿Î»Î· ÏƒÏ„Î·Î½ Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·.
{% endhint %}

Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚ **Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚** ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Î´Î¹ÎºÏŒ Ï„Î¿Ï…Ï‚ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î¿ **sandbox**, ÏŒÏ€Ï‰Ï‚ Î· Ï…Ï€Î·ÏÎµÏƒÎ¯Î± `mdnsresponder`. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Î±Ï…Ï„Î¬ Ï„Î± Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î± **Ï€ÏÎ¿Ï†Î¯Î» sandbox** Î¼Î­ÏƒÎ± ÏƒÎµ:

* **`/usr/share/sandbox`**
* **`/System/Library/Sandbox/Profiles`**
* Î†Î»Î»Î± Ï€ÏÎ¿Ï†Î¯Î» sandbox Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎµÎ»ÎµÎ³Ï‡Î¸Î¿ÏÎ½ ÏƒÏ„Î¿ [https://github.com/s7ephen/OSX-Sandbox--Seatbelt--Profiles](https://github.com/s7ephen/OSX-Sandbox--Seatbelt--Profiles).

ÎŸÎ¹ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Ï„Î¿Ï… **App Store** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½ Ï„Î¿ **Ï€ÏÎ¿Ï†Î¯Î»** **`/System/Library/Sandbox/Profiles/application.sb`**. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» Ï€ÏÏ‚ Î¿Î¹ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î®ÏƒÎµÎ¹Ï‚ ÏŒÏ€Ï‰Ï‚ **`com.apple.security.network.server`** ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ ÏƒÎµ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ Î´Î¯ÎºÏ„Ï…Î¿.

Î¤Î¿ SIP ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Ï€ÏÎ¿Ï†Î¯Î» Sandbox Ï€Î¿Ï… Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ platform\_profile ÏƒÏ„Î¿ /System/Library/Sandbox/rootless.conf

### Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î ÏÎ¿Ï†Î¯Î» Sandbox

Î“Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ Î¼Î¹Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î¼Îµ Î­Î½Î± **ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» sandbox**, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ:
```bash
sandbox-exec -f example.sb /Path/To/The/Application
```
{% tabs %}
{% tab title="touch" %}
{% code title="touch.sb" %}
```scheme
(version 1)
(deny default)
(allow file* (literal "/tmp/hacktricks.txt"))
```
{% endcode %}
```bash
# This will fail because default is denied, so it cannot execute touch
sandbox-exec -f touch.sb touch /tmp/hacktricks.txt
# Check logs
log show --style syslog --predicate 'eventMessage contains[c] "sandbox"' --last 30s
[...]
2023-05-26 13:42:44.136082+0200  localhost kernel[0]: (Sandbox) Sandbox: sandbox-exec(41398) deny(1) process-exec* /usr/bin/touch
2023-05-26 13:42:44.136100+0200  localhost kernel[0]: (Sandbox) Sandbox: sandbox-exec(41398) deny(1) file-read-metadata /usr/bin/touch
2023-05-26 13:42:44.136321+0200  localhost kernel[0]: (Sandbox) Sandbox: sandbox-exec(41398) deny(1) file-read-metadata /var
2023-05-26 13:42:52.701382+0200  localhost kernel[0]: (Sandbox) 5 duplicate reports for Sandbox: sandbox-exec(41398) deny(1) file-read-metadata /var
[...]
```
{% code title="touch2.sb" %}
```scheme
(version 1)
(deny default)
(allow file* (literal "/tmp/hacktricks.txt"))
(allow process* (literal "/usr/bin/touch"))
; This will also fail because:
; 2023-05-26 13:44:59.840002+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) file-read-metadata /usr/bin/touch
; 2023-05-26 13:44:59.840016+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) file-read-data /usr/bin/touch
; 2023-05-26 13:44:59.840028+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) file-read-data /usr/bin
; 2023-05-26 13:44:59.840034+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) file-read-metadata /usr/lib/dyld
; 2023-05-26 13:44:59.840050+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) sysctl-read kern.bootargs
; 2023-05-26 13:44:59.840061+0200  localhost kernel[0]: (Sandbox) Sandbox: touch(41575) deny(1) file-read-data /
```
{% endcode %}

{% code title="touch3.sb" %}
```scheme
(version 1)
(deny default)
(allow file* (literal "/private/tmp/hacktricks.txt"))
(allow process* (literal "/usr/bin/touch"))
(allow file-read-data (literal "/"))
; This one will work
```
{% endcode %}
{% endtab %}
{% endtabs %}

{% hint style="info" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ **Î»Î¿Î³Î¹ÏƒÎ¼Î¹ÎºÏŒ** Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÏƒÏ…Î³Î³ÏÎ±Ï†ÎµÎ¯ Î±Ï€ÏŒ Ï„Î·Î½ **Apple** Ï€Î¿Ï… Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÎµ **Windows** **Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ Î¼Î­Ï„ÏÎ± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚**, ÏŒÏ€Ï‰Ï‚ Î· Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³ÏÎ½.
{% endhint %}

Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ‰Î½:

* [https://lapcatsoftware.com/articles/sandbox-escape.html](https://lapcatsoftware.com/articles/sandbox-escape.html)
* [https://desi-jarvis.medium.com/office365-macos-sandbox-escape-fcce4fa4123c](https://desi-jarvis.medium.com/office365-macos-sandbox-escape-fcce4fa4123c) (Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î³ÏÎ¬Ï†Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± ÎµÎºÏ„ÏŒÏ‚ Ï„Î·Ï‚ Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·Ï‚ Ï„Ï‰Î½ Î¿Ï€Î¿Î¯Ï‰Î½ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Î¾ÎµÎºÎ¹Î½Î¬ Î¼Îµ `~$`).

### Î™Ï‡Î½Î·Î»Î¬Ï„Î·ÏƒÎ· Î‘Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·Ï‚

#### ÎœÎ­ÏƒÏ‰ Ï€ÏÎ¿Ï†Î¯Î»

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Î¹Ï‡Î½Î·Î»Î±Ï„Î®ÏƒÎµÏ„Îµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Î· Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Î¼Î¹Î± ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±. Î“Î¹Î± Î±Ï…Ï„ÏŒ, Î±Ï€Î»ÏÏ‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Ï„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€ÏÎ¿Ï†Î¯Î»:

{% code title="trace.sb" %}
```scheme
(version 1)
(trace /tmp/trace.out)
```
{% endcode %}

ÎšÎ±Î¹ Î¼ÎµÏ„Î¬ Î±Ï€Î»ÏÏ‚ ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ ÎºÎ¬Ï„Î¹ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î»:
```bash
sandbox-exec -f /tmp/trace.sb /bin/ls
```
In `/tmp/trace.out` Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ ÎºÎ¬Î¸Îµ Î­Î»ÎµÎ³Ï‡Î¿ sandbox Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î­ÏƒÏ„Î·ÎºÎµ ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÎºÎ»Î®Î¸Î·ÎºÎµ (Î¿Ï€ÏŒÏ„Îµ, Ï€Î¿Î»Î»Î¬ Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î±).

Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÎµÏ„Îµ Ï„Î¿ sandbox Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î·Î½ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿ **`-t`**: `sandbox-exec -t /path/trace.out -p "(version 1)" /bin/ls`

#### ÎœÎ­ÏƒÏ‰ API

Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· `sandbox_set_trace_path` Ï€Î¿Ï… ÎµÎ¾Î¬Î³ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ `libsystem_sandbox.dylib` ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÎµÏ„Îµ Î­Î½Î± ÏŒÎ½Î¿Î¼Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ ÏŒÏ€Î¿Ï… Î¸Î± Î³ÏÎ¬Ï†Î¿Î½Ï„Î±Î¹ Î¿Î¹ Î­Î»ÎµÎ³Ï‡Î¿Î¹ sandbox.\
Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ ÎºÎ¬Ï„Î¹ Ï€Î±ÏÏŒÎ¼Î¿Î¹Î¿ ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ `sandbox_vtrace_enable()` ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ Ï„Î± ÏƒÏ†Î¬Î»Î¼Î±Ï„Î± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î®Ï‚ Î±Ï€ÏŒ Ï„Î¿ buffer ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ `sandbox_vtrace_report()`.

### Î•Ï€Î¹Î¸ÎµÏÏÎ·ÏƒÎ· Sandbox

`libsandbox.dylib` ÎµÎ¾Î¬Î³ÎµÎ¹ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ sandbox\_inspect\_pid Î· Î¿Ï€Î¿Î¯Î± Î´Î¯Î½ÎµÎ¹ Î¼Î¹Î± Î»Î¯ÏƒÏ„Î± Ï„Î·Ï‚ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ sandbox Î¼Î¹Î±Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚ (ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÏ‰Î½). Î©ÏƒÏ„ÏŒÏƒÎ¿, Î¼ÏŒÎ½Î¿ Î¿Î¹ Î´Ï…Î±Î´Î¹ÎºÎ¿Î¯ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Ï„Î·Ï‚ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î±Ï‚ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·.

### Î ÏÎ¿Ï†Î¯Î» Sandbox MacOS & iOS

Î¤Î¿ MacOS Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÎ¹ Ï„Î± Ï€ÏÎ¿Ï†Î¯Î» sandbox Ï„Î¿Ï… ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ ÏƒÎµ Î´ÏÎ¿ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯ÎµÏ‚: **/usr/share/sandbox/** ÎºÎ±Î¹ **/System/Library/Sandbox/Profiles**.

ÎšÎ±Î¹ Î±Î½ Î¼Î¹Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï„ÏÎ¯Ï„Î¿Ï… Î¼Î­ÏÎ¿Ï…Ï‚ Ï†Î­ÏÎµÎ¹ Ï„Î·Î½ _**com.apple.security.app-sandbox**_ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ·, Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÏ†Î±ÏÎ¼ÏŒÎ¶ÎµÎ¹ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» **/System/Library/Sandbox/Profiles/application.sb** ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±.

Î£Ï„Î¿ iOS, Ï„Î¿ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ **container** ÎºÎ±Î¹ Î´ÎµÎ½ Î­Ï‡Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÎµÎ¹Î¼ÎµÎ½Î¹ÎºÎ® Î±Î½Î±Ï€Î±ÏÎ¬ÏƒÏ„Î±ÏƒÎ· SBPL. Î£Ï„Î· Î¼Î½Î®Î¼Î·, Î±Ï…Ï„ÏŒ Ï„Î¿ sandbox Î±Î½Î±Ï€Î±ÏÎ¯ÏƒÏ„Î±Ï„Î±Î¹ Ï‰Ï‚ Î´Ï…Î±Î´Î¹ÎºÏŒ Î´Î­Î½Ï„ÏÎ¿ Allow/Deny Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¬Î´ÎµÎ¹Î± Î±Ï€ÏŒ Ï„Î¿ sandbox.

### Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î¿ SBPL ÏƒÎµ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ App Store

Î˜Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î³Î¹Î± Ï„Î¹Ï‚ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Î½Î± ÎºÎ¬Î½Î¿Ï…Î½ Ï„Î¹Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Ï„Î¿Ï…Ï‚ Î½Î± ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ **Î¼Îµ Ï€ÏÎ¿ÏƒÎ±ÏÎ¼Î¿ÏƒÎ¼Î­Î½Î± Ï€ÏÎ¿Ï†Î¯Î» Sandbox** (Î±Î½Ï„Î¯ Î¼Îµ Ï„Î¿ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿). Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½ Ï„Î·Î½ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ· **`com.apple.security.temporary-exception.sbpl`** Î· Î¿Ï€Î¿Î¯Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ³ÎºÏÎ¹Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï„Î·Î½ Apple.

Î•Î¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÏ„Îµ Ï„Î¿Î½ Î¿ÏÎ¹ÏƒÎ¼ÏŒ Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚ ÏƒÏ„Î¿ **`/System/Library/Sandbox/Profiles/application.sb:`**
```scheme
(sandbox-array-entitlement
"com.apple.security.temporary-exception.sbpl"
(lambda (string)
(let* ((port (open-input-string string)) (sbpl (read port)))
(with-transparent-redirection (eval sbpl)))))
```
Î‘Ï…Ï„ÏŒ Î¸Î± **eval Ï„Î·Î½ Î±Î»Ï†Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ·** Ï‰Ï‚ Ï€ÏÎ¿Ï†Î¯Î» Sandbox.

### Î£Ï…Î³ÎºÎ­Î½Ï„ÏÏ‰ÏƒÎ· & Î±Ï€Î¿ÏƒÏ…Î¼Ï€Î¯ÎµÏƒÎ· ÎµÎ½ÏŒÏ‚ Ï€ÏÎ¿Ï†Î¯Î» Sandbox

Î¤Î¿ **`sandbox-exec`** ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¹Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ `sandbox_compile_*` Î±Ï€ÏŒ Ï„Î¿ `libsandbox.dylib`. ÎŸÎ¹ ÎºÏÏÎ¹ÎµÏ‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… ÎµÎ¾Î¬Î³Î¿Î½Ï„Î±Î¹ ÎµÎ¯Î½Î±Î¹: `sandbox_compile_file` (Î±Î½Î±Î¼Î­Î½ÎµÎ¹ Î¼Î¹Î± Î´Î¹Î±Î´ÏÎ¿Î¼Î® Î±ÏÏ‡ÎµÎ¯Î¿Ï…, Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Ï‚ `-f`), `sandbox_compile_string` (Î±Î½Î±Î¼Î­Î½ÎµÎ¹ Î¼Î¹Î± Î±Î»Ï†Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ®, Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Ï‚ `-p`), `sandbox_compile_name` (Î±Î½Î±Î¼Î­Î½ÎµÎ¹ Î­Î½Î± ÏŒÎ½Î¿Î¼Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ, Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Ï‚ `-n`), `sandbox_compile_entitlements` (Î±Î½Î±Î¼Î­Î½ÎµÎ¹ plist ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î®ÏƒÎµÏ‰Î½).

Î‘Ï…Ï„Î® Î· Î±Î½Ï„Î¯ÏƒÏ„ÏÎ¿Ï†Î· ÎºÎ±Î¹ [**Î±Î½Î¿Î¹Ï‡Ï„Î¿Ï ÎºÏÎ´Î¹ÎºÎ± Î­ÎºÎ´Î¿ÏƒÎ· Ï„Î¿Ï… ÎµÏÎ³Î±Î»ÎµÎ¯Î¿Ï… sandbox-exec**](https://newosxbook.com/src.jl?tree=listings\&file=/sandbox\_exec.c) ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ ÏƒÏ„Î¿ **`sandbox-exec`** Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Ï„Î¿ ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏ‰Î¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» sandbox.

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î³Î¹Î± Î½Î± Ï€ÎµÏÎ¹Î¿ÏÎ¯ÏƒÎµÎ¹ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ `sandbox_spawnattrs_set[container/profilename]` ÎºÎ±Î¹ Î½Î± Ï€ÎµÏÎ¬ÏƒÎµÎ¹ Î­Î½Î± ÎºÎ¿Î½Ï„Î­Î¹Î½ÎµÏ Î® Ï€ÏÎ¿Ï‹Ï€Î¬ÏÏ‡Î¿Î½ Ï€ÏÎ¿Ï†Î¯Î».

## Debug & Î Î±ÏÎ¬ÎºÎ±Î¼ÏˆÎ· Sandbox

Î£Ï„Î¿ macOS, ÏƒÎµ Î±Î½Ï„Î¯Î¸ÎµÏƒÎ· Î¼Îµ Ï„Î¿ iOS ÏŒÏ€Î¿Ï… Î¿Î¹ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ sandboxed Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î® Î±Ï€ÏŒ Ï„Î¿Î½ Ï€Ï…ÏÎ®Î½Î±, **Î¿Î¹ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÏ€Î¹Î»Î­Î¾Î¿Ï…Î½ Î½Î± Î¼Ï€Î¿Ï…Î½ ÏƒÏ„Î¿ sandbox Î¼ÏŒÎ½ÎµÏ‚ Ï„Î¿Ï…Ï‚**. Î‘Ï…Ï„ÏŒ ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ ÏƒÏ„Î¿ macOS, Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î´ÎµÎ½ Ï€ÎµÏÎ¹Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿ sandbox Î¼Î­Ï‡ÏÎ¹ Î½Î± Î±Ï€Î¿Ï†Î±ÏƒÎ¯ÏƒÎµÎ¹ ÎµÎ½ÎµÏÎ³Î¬ Î½Î± ÎµÎ¹ÏƒÎ­Î»Î¸ÎµÎ¹ ÏƒÎµ Î±Ï…Ï„ÏŒ, Î±Î½ ÎºÎ±Î¹ Î¿Î¹ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Ï„Î¿Ï… App Store ÎµÎ¯Î½Î±Î¹ Ï€Î¬Î½Ï„Î± sandboxed.

ÎŸÎ¹ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± sandboxed Î±Ï€ÏŒ Ï„Î¿ userland ÏŒÏ„Î±Î½ Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ Î±Î½ Î­Ï‡Î¿Ï…Î½ Ï„Î·Î½ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´ÏŒÏ„Î·ÏƒÎ·: `com.apple.security.app-sandbox`. Î“Î¹Î± Î¼Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎ® ÎµÎ¾Î®Î³Î·ÏƒÎ· Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚, ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="macos-sandbox-debug-and-bypass/" %}
[macos-sandbox-debug-and-bypass](macos-sandbox-debug-and-bypass/)
{% endcontent-ref %}

## **Î•Ï€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ Sandbox**

ÎŸÎ¹ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ Î½Î± Î´Î¿Î¸Î¿ÏÎ½ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ Ï€ÏÎ¿Î½ÏŒÎ¼Î¹Î± ÏƒÎµ Î­Î½Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÎºÎ±Î¹ Î´Î¯Î½Î¿Î½Ï„Î±Î¹ ÎºÎ±Î»ÏÎ½Ï„Î±Ï‚ Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚:

* `sandbox_issue_extension`
* `sandbox_extension_issue_file[_with_new_type]`
* `sandbox_extension_issue_mach`
* `sandbox_extension_issue_iokit_user_client_class`
* `sandbox_extension_issue_iokit_registry_rentry_class`
* `sandbox_extension_issue_generic`
* `sandbox_extension_issue_posix_ipc`

ÎŸÎ¹ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÏ„Î· Î´ÎµÏÏ„ÎµÏÎ· Ï…Ï€Î¿Î´Î¿Ï‡Î® ÎµÏ„Î¹ÎºÎ­Ï„Î±Ï‚ MACF Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿ÏƒÎ²Î¬ÏƒÎ¹Î¼Î· Î±Ï€ÏŒ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï„Î·Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚. Î¤Î¿ Î±ÎºÏŒÎ»Î¿Ï…Î¸Î¿ **`sbtool`** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¿Î¹ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Ï‡Î¿ÏÎ·Î³Î¿ÏÎ½Ï„Î±Î¹ Î±Ï€ÏŒ ÎµÏ€Î¹Ï„ÏÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚, Î³Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Ï„Î¿ `tccd` Î¸Î± Ï‡Î¿ÏÎ·Î³Î®ÏƒÎµÎ¹ Ï„Î¿ token ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·Ï‚ Ï„Î¿Ï… `com.apple.tcc.kTCCServicePhotos` ÏŒÏ„Î±Î½ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¹Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ ÎºÎ±Î¹ ÎµÏ€Î¹Ï„ÏÎ±Ï€ÎµÎ¯ ÏƒÎµ Î­Î½Î± Î¼Î®Î½Ï…Î¼Î± XPC. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± ÎºÎ±Ï„Î±Î½Î±Î»ÏÏƒÎµÎ¹ Ï„Î¿ token ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·Ï‚ ÏÏƒÏ„Îµ Î½Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸ÎµÎ¯ ÏƒÎµ Î±Ï…Ï„Î®Î½.\
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î± tokens ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÏ‰Î½ ÎµÎ¯Î½Î±Î¹ Î¼Î±ÎºÏÎ¿Ï‡ÏÏŒÎ½Î¹Î± Î´ÎµÎºÎ±ÎµÎ¾Î±Î´Î¹ÎºÎ¬ Ï€Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î¿ÏÎ½ Ï„Î¹Ï‚ Ï‡Î¿ÏÎ·Î³Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î¬Î´ÎµÎ¹ÎµÏ‚. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î´ÎµÎ½ Î­Ï‡Î¿Ï…Î½ Ï„Î¿Î½ ÎµÏ€Î¹Ï„ÏÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ PID ÏƒÎºÎ»Î·ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿, Ï€ÏÎ¬Î³Î¼Î± Ï€Î¿Ï… ÏƒÎ·Î¼Î±Î¯Î½ÎµÎ¹ ÏŒÏ„Î¹ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î¼Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ token Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± **ÎºÎ±Ï„Î±Î½Î±Î»Ï‰Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï€Î¿Î»Î»Î­Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚**.

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¿Î¹ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚ ÏƒÏ‡ÎµÏ„Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï€Î¿Î»Ï ÎºÎ±Î¹ Î¼Îµ Ï„Î¹Ï‚ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î®ÏƒÎµÎ¹Ï‚, Î¿Ï€ÏŒÏ„Îµ Î· ÎºÎ±Ï„Î¿Ï‡Î® Î¿ÏÎ¹ÏƒÎ¼Î­Î½Ï‰Î½ ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î®ÏƒÎµÏ‰Î½ Î¼Ï€Î¿ÏÎµÎ¯ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î½Î± Ï‡Î¿ÏÎ·Î³Î®ÏƒÎµÎ¹ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ ÎµÏ€ÎµÎºÏ„Î¬ÏƒÎµÎ¹Ï‚.

### **ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î ÏÎ¿Î½Î¿Î¼Î¯Ï‰Î½ PID**

[**Î£ÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Î±Ï…Ï„ÏŒ**](https://www.youtube.com/watch?v=mG715HcDgO8\&t=3011s), Î¿Î¹ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ **`sandbox_check`** (ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± `__mac_syscall`), Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎµÎ»Î­Î³Î¾Î¿Ï…Î½ **Î±Î½ Î¼Î¹Î± ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î® ÏŒÏ‡Î¹** Î±Ï€ÏŒ Ï„Î¿ sandbox ÏƒÎµ Î­Î½Î±Î½ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ PID, audit token Î® Î¼Î¿Î½Î±Î´Î¹ÎºÏŒ ID.

Î¤Î¿ [**ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ sbtool**](http://newosxbook.com/src.jl?tree=listings\&file=sbtool.c) (Î²ÏÎµÎ¯Ï„Îµ Ï„Î¿ [ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏ‰Î¼Î­Î½Î¿ ÎµÎ´Ï](https://newosxbook.com/articles/hitsb.html)) Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Î±Î½ Î­Î½Î±Ï‚ PID Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚:
```bash
sbtool <pid> mach #Check mac-ports (got from launchd with an api)
sbtool <pid> file /tmp #Check file access
sbtool <pid> inspect #Gives you an explanation of the sandbox profile and extensions
sbtool <pid> all
```
### \[un]suspend

Î•Î¯Î½Î±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Î±Î½Î±ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ ÎºÎ±Î¹ Î½Î± Î±Î½Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ Ï„Î·Î½ Î±Î½Î±ÏƒÏ„Î¿Î»Î® Ï„Î¿Ï… sandbox Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î¹Ï‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ `sandbox_suspend` ÎºÎ±Î¹ `sandbox_unsuspend` Î±Ï€ÏŒ Ï„Î¿ `libsystem_sandbox.dylib`.

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î±Î½Î±ÏƒÏ„Î¿Î»Î®Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Î¹ Î¿ÏÎ¹ÏƒÎ¼Î­Î½Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€ÏÎ¿ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î½Î± ÎµÎ¾Î¿Ï…ÏƒÎ¹Î¿Î´Î¿Ï„Î·Î¸ÎµÎ¯ Î¿ ÎºÎ±Î»ÏÎ½ Î½Î± Ï„Î·Î½ ÎºÎ±Î»Î­ÏƒÎµÎ¹ ÏŒÏ€Ï‰Ï‚:

* com.apple.private.security.sandbox-manager
* com.apple.security.print
* com.apple.security.temporary-exception.audio-unit-host

## mac\_syscall

Î‘Ï…Ï„Î® Î· ÎºÎ»Î®ÏƒÎ· ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ (#381) Î±Î½Î±Î¼Î­Î½ÎµÎ¹ Î­Î½Î± string Ï‰Ï‚ Ï€ÏÏÏ„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± Ï€Î¿Ï… Î¸Î± Ï…Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹ Ï„Î¿ module Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯, ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î­Î½Î±Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï‰Ï‚ Î´ÎµÏÏ„ÎµÏÎ¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± Ï€Î¿Ï… Î¸Î± Ï…Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯. Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Ï„Î¿ Ï„ÏÎ¯Ï„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± Î¸Î± ÎµÎ¾Î±ÏÏ„Î¬Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹.

Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· `___sandbox_ms` ÎºÎ±Î»ÎµÎ¯ Ï„Î· `mac_syscall` Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎ¿Î½Ï„Î±Ï‚ ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± `"Sandbox"` Î±ÎºÏÎ¹Î²ÏÏ‚ ÏŒÏ€Ï‰Ï‚ Î· `___sandbox_msp` ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± Ï€ÎµÏÎ¹Ï„ÏÎ»Î¹Î¾Î· Ï„Î·Ï‚ `mac_set_proc` (#387). Î£Ï„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±, Î¼ÎµÏÎ¹ÎºÎ¿Î¯ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿Ï…Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ Î±Ï€ÏŒ Ï„Î·Î½ `___sandbox_ms` Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î²ÏÎµÎ¸Î¿ÏÎ½ ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±:

* **set\_profile (#0)**: Î•Ï†Î±ÏÎ¼ÏŒÏƒÏ„Îµ Î­Î½Î± ÏƒÏ…Î¼Ï€Î¹ÎµÏƒÎ¼Î­Î½Î¿ Î® Î¿Î½Î¿Î¼Î±ÏƒÎ¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» ÏƒÎµ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±.
* **platform\_policy (#1)**: Î•Ï€Î¹Î²Î¬Î»Î»ÎµÏ„Îµ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï…Ï‚ Î³Î¹Î± Ï„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± (Î´Î¹Î±Ï†Î­ÏÎµÎ¹ Î¼ÎµÏ„Î±Î¾Ï macOS ÎºÎ±Î¹ iOS).
* **check\_sandbox (#2)**: Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Î­Î½Î±Î½ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î¿ Î­Î»ÎµÎ³Ï‡Î¿ Î¼Î¹Î±Ï‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ sandbox.
* **note (#3)**: Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î¼Î¹Î± ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· ÏƒÎµ Î­Î½Î± Sandbox
* **container (#4)**: Î£Ï…Î½Î´Î­ÏƒÏ„Îµ Î¼Î¹Î± ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ· ÏƒÎµ Î­Î½Î± sandbox, ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î³Î¹Î± Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ· Î® Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ·.
* **extension\_issue (#5)**: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Î³Î¹Î± Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±.
* **extension\_consume (#6)**: ÎšÎ±Ï„Î±Î½Î±Î»ÏÏƒÏ„Îµ Î¼Î¹Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î· ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·.
* **extension\_release (#7)**: Î‘Ï€ÎµÎ»ÎµÏ…Î¸ÎµÏÏÏƒÏ„Îµ Ï„Î· Î¼Î½Î®Î¼Î· Ï€Î¿Ï… ÏƒÏ‡ÎµÏ„Î¯Î¶ÎµÏ„Î±Î¹ Î¼Îµ Î¼Î¹Î± ÎºÎ±Ï„Î±Î½Î±Î»Ï‰Î¸ÎµÎ¯ÏƒÎ± ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·.
* **extension\_update\_file (#8)**: Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï…Ï‚ Î¼Î¹Î±Ï‚ Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ±Ï‚ ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÎµÎ½Ï„ÏŒÏ‚ Ï„Î¿Ï… sandbox.
* **extension\_twiddle (#9)**: Î¡Ï…Î¸Î¼Î¯ÏƒÏ„Îµ Î® Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Î¼Î¹Î± Ï…Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ± ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Î¿Ï… (Ï€.Ï‡., TextEdit, rtf, rtfd).
* **suspend (#10)**: Î‘Î½Î±ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¬ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ sandbox (Î±Ï€Î±Î¹Ï„ÎµÎ¯ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±).
* **unsuspend (#11)**: Î•Ï€Î±Î½Î±Ï†Î­ÏÎµÏ„Îµ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï€ÏÎ¿Î·Î³Î¿Ï…Î¼Î­Î½Ï‰Ï‚ Î±Î½Î±ÏƒÏ„Î±Î»Î¼Î­Î½Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ sandbox.
* **passthrough\_access (#12)**: Î•Ï€Î¹Ï„ÏÎ­ÏˆÏ„Îµ Î¬Î¼ÎµÏƒÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· passthrough ÏƒÎµ Î¼Î¹Î± Ï€Î·Î³Î®, Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„Î¿Î½Ï„Î±Ï‚ Ï„Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ sandbox.
* **set\_container\_path (#13)**: (Î¼ÏŒÎ½Î¿ iOS) ÎŸÏÎ¯ÏƒÏ„Îµ Î¼Î¹Î± Î´Î¹Î±Î´ÏÎ¿Î¼Î® container Î³Î¹Î± Î¼Î¹Î± Î¿Î¼Î¬Î´Î± ÎµÏ†Î±ÏÎ¼Î¿Î³ÏÎ½ Î® ID Ï…Ï€Î¿Î³ÏÎ±Ï†Î®Ï‚.
* **container\_map (#14)**: (Î¼ÏŒÎ½Î¿ iOS) Î‘Î½Î±ÎºÏ„Î®ÏƒÏ„Îµ Î¼Î¹Î± Î´Î¹Î±Î´ÏÎ¿Î¼Î® container Î±Ï€ÏŒ Ï„Î¿ `containermanagerd`.
* **sandbox\_user\_state\_item\_buffer\_send (#15)**: (iOS 10+) ÎŸÏÎ¯ÏƒÏ„Îµ Î¼ÎµÏ„Î±Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î· ÏƒÏ„Î¿ sandbox.
* **inspect (#16)**: Î Î±ÏÎ­Ï‡ÎµÏ„Îµ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ·Ï‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± sandboxed.
* **dump (#18)**: (macOS 11) Î•ÎºÏ„Ï…Ï€ÏÏƒÏ„Îµ Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ Ï€ÏÎ¿Ï†Î¯Î» ÎµÎ½ÏŒÏ‚ sandbox Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·.
* **vtrace (#19)**: Î™Ï‡Î½Î·Î»Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¹Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ sandbox Î³Î¹Î± Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î® Î±Ï€Î¿ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰ÏƒÎ·.
* **builtin\_profile\_deactivate (#20)**: (macOS < 11) Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î± Î¿Î½Î¿Î¼Î±ÏƒÎ¼Î­Î½Î± Ï€ÏÎ¿Ï†Î¯Î» (Ï€.Ï‡., `pe_i_can_has_debugger`).
* **check\_bulk (#21)**: Î•ÎºÏ„ÎµÎ»Î­ÏƒÏ„Îµ Ï€Î¿Î»Î»Î­Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ `sandbox_check` ÏƒÎµ Î¼Î¯Î± Î¼ÏŒÎ½Î¿ ÎºÎ»Î®ÏƒÎ·.
* **reference\_retain\_by\_audit\_token (#28)**: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± Î±Î½Î±Ï†Î¿ÏÎ¬ Î³Î¹Î± Î­Î½Î± audit token Î³Î¹Î± Ï‡ÏÎ®ÏƒÎ· ÏƒÎµ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ sandbox.
* **reference\_release (#29)**: Î‘Ï€ÎµÎ»ÎµÏ…Î¸ÎµÏÏÏƒÏ„Îµ Î¼Î¹Î± Ï€ÏÎ¿Î·Î³Î¿Ï…Î¼Î­Î½Ï‰Ï‚ Î´Î¹Î±Ï„Î·ÏÎ·Î¼Î­Î½Î· Î±Î½Î±Ï†Î¿ÏÎ¬ audit token.
* **rootless\_allows\_task\_for\_pid (#30)**: Î•Ï€Î±Î»Î·Î¸ÎµÏÏƒÏ„Îµ ÎµÎ¬Î½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Ï„Î¿ `task_for_pid` (Ï€Î±ÏÏŒÎ¼Î¿Î¹Î¿ Î¼Îµ Ï„Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ `csr`).
* **rootless\_whitelist\_push (#31)**: (macOS) Î•Ï†Î±ÏÎ¼ÏŒÏƒÏ„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ manifest System Integrity Protection (SIP).
* **rootless\_whitelist\_check (preflight) (#32)**: Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ manifest SIP Ï€ÏÎ¹Î½ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·.
* **rootless\_protected\_volume (#33)**: (macOS) Î•Ï†Î±ÏÎ¼ÏŒÏƒÏ„Îµ SIP Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯ÎµÏ‚ ÏƒÎµ Î­Î½Î±Î½ Î´Î¯ÏƒÎºÎ¿ Î® Î´Î¹Î±Î¼Î­ÏÎ¹ÏƒÎ¼Î±.
* **rootless\_mkdir\_protected (#34)**: Î•Ï†Î±ÏÎ¼ÏŒÏƒÏ„Îµ SIP/DataVault Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± ÏƒÎµ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎºÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï….

## Sandbox.kext

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ ÏƒÏ„Î¿ iOS Î· ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï€Ï…ÏÎ®Î½Î± Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ **ÏƒÎºÎ»Î·ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± ÏŒÎ»Î± Ï„Î± Ï€ÏÎ¿Ï†Î¯Î»** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Ï„Î¼Î®Î¼Î± `__TEXT.__const` Î³Î¹Î± Î½Î± Î±Ï€Î¿Ï†ÎµÏ…Ï‡Î¸ÎµÎ¯ Î· Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ® Ï„Î¿Ï…Ï‚. Î‘ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ½ Î¼ÎµÏÎ¹ÎºÎ­Ï‚ ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎµÏ‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï€Ï…ÏÎ®Î½Î±:

* **`hook_policy_init`**: Î£Ï…Î½Î´Î­ÎµÎ¹ Ï„Î¿ `mpo_policy_init` ÎºÎ±Î¹ ÎºÎ±Î»ÎµÎ¯Ï„Î±Î¹ Î¼ÎµÏ„Î¬ Ï„Î¿ `mac_policy_register`. Î•ÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î±Ï€ÏŒ Ï„Î¹Ï‚ Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï… Sandbox. Î•Ï€Î¯ÏƒÎ·Ï‚, Î±ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ SIP.
* **`hook_policy_initbsd`**: Î¡Ï…Î¸Î¼Î¯Î¶ÎµÎ¹ Ï„Î· Î´Î¹ÎµÏ€Î±Ï†Î® sysctl ÎºÎ±Ï„Î±Ï‡Ï‰ÏÏÎ½Ï„Î±Ï‚ `security.mac.sandbox.sentinel`, `security.mac.sandbox.audio_active` ÎºÎ±Î¹ `security.mac.sandbox.debug_mode` (Î±Î½ Î­Ï‡ÎµÎ¹ ÎµÎºÎºÎ¹Î½Î®ÏƒÎµÎ¹ Î¼Îµ `PE_i_can_has_debugger`).
* **`hook_policy_syscall`**: ÎšÎ±Î»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î· `mac_syscall` Î¼Îµ "Sandbox" Ï‰Ï‚ Ï€ÏÏÏ„Î¿ ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·Î¼Î± ÎºÎ±Î¹ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€Î¿Ï… Ï…Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ„Î¿ Î´ÎµÏÏ„ÎµÏÎ¿. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î­Î½Î± switch Î³Î¹Î± Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Î¿ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î¿Î½ Î¶Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ.

### MACF Hooks

**`Sandbox.kext`** Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Ï…Ï‚ Î±Ï€ÏŒ ÎµÎºÎ±Ï„ÏŒ hooks Î¼Î­ÏƒÏ‰ MACF. ÎŸÎ¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿Î¹ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ hooks Î¸Î± ÎµÎ»Î­Î³Î¾Î¿Ï…Î½ Î±Ï€Î»ÏÏ‚ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Ï„Ï…Ï€Î¹ÎºÎ­Ï‚ Ï€ÎµÏÎ¹Ï€Ï„ÏÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î½ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï„Î·Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±Ï‚, Î±Î½ ÏŒÏ‡Î¹, Î¸Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î½ **`cred_sb_evalutate`** Î¼Îµ Ï„Î± **Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î±** Î±Ï€ÏŒ Ï„Î¿ MACF ÎºÎ±Î¹ Î­Î½Î±Î½ Î±ÏÎ¹Î¸Î¼ÏŒ Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯ ÏƒÏ„Î·Î½ **Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±** Ï€Î¿Ï… Î¸Î± ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ ÎºÎ±Î¹ Î­Î½Î± **buffer** Î³Î¹Î± Ï„Î·Î½ Î­Î¾Î¿Î´Î¿.

ÎˆÎ½Î± ÎºÎ±Î»ÏŒ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î¿Ï ÎµÎ¯Î½Î±Î¹ Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· **`_mpo_file_check_mmap`** Ï€Î¿Ï… ÏƒÏ…Î½Î´Î­ÎµÎ¹ Ï„Î¿ **`mmap`** ÎºÎ±Î¹ Î¸Î± Î±ÏÏ‡Î¯ÏƒÎµÎ¹ Î½Î± ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Î±Î½ Î· Î½Î­Î± Î¼Î½Î®Î¼Î· Î¸Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ³Î³ÏÎ¬ÏˆÎ¹Î¼Î· (ÎºÎ±Î¹ Î±Î½ ÏŒÏ‡Î¹ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·), ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Î¸Î± ÎµÎ»Î­Î³Î¾ÎµÎ¹ Î±Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î± Ï„Î·Î½ ÎºÎ¿Î¹Î½Î® Î¼Î½Î®Î¼Î· dyld ÎºÎ±Î¹ Î±Î½ Î½Î±Î¹ Î¸Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·, ÎºÎ±Î¹ Ï„ÎµÎ»Î¹ÎºÎ¬ Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ **`sb_evaluate_internal`** (Î® Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹Ï„Ï…Î»Î¯Î¾ÎµÎ¹Ï‚ Ï„Î·Ï‚) Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ Ï€ÎµÏÎ±Î¹Ï„Î­ÏÏ‰ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚ ÎµÏ€Î¹Ï„ÏÎµÏ€ÏŒÎ¼ÎµÎ½Î·Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ ÎµÎºÎ±Ï„Î¿Î½Ï„Î¬Î´ÎµÏ‚ hooks Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ Sandbox, Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ 3 Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î¹Î´Î¹Î±Î¯Ï„ÎµÏÎ± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Î½Ï„Î±:

* `mpo_proc_check_for`: Î•Ï†Î±ÏÎ¼ÏŒÎ¶ÎµÎ¹ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ ÎºÎ±Î¹ Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ†Î±ÏÎ¼Î¿ÏƒÏ„ÎµÎ¯ Ï€ÏÎ¿Î·Î³Î¿Ï…Î¼Î­Î½Ï‰Ï‚
* `mpo_vnode_check_exec`: ÎšÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Î¼Î¹Î± Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Ï„Î¿ ÏƒÏ‡ÎµÏ„Î¹ÎºÏŒ Î´Ï…Î±Î´Î¹ÎºÏŒ, ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Ï€ÏÎ¿Ï†Î¯Î» ÎºÎ±Î¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Ï€Î¿Ï… Î±Ï€Î±Î³Î¿ÏÎµÏÎµÎ¹ Ï„Î¹Ï‚ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹Ï‚ SUID/SGID.
* `mpo_cred_label_update_execve`: Î‘Ï…Ï„ÏŒ ÎºÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Î±Î½Î±Ï„Î¯Î¸ÎµÏ„Î±Î¹ Î· ÎµÏ„Î¹ÎºÎ­Ï„Î±. Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ ÎºÎ±Î¸ÏÏ‚ ÎºÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î­Ï‡ÎµÎ¹ Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï€Î»Î®ÏÏ‰Ï‚ Î±Î»Î»Î¬ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎºÏ„ÎµÎ»ÎµÏƒÏ„ÎµÎ¯ Î±ÎºÏŒÎ¼Î±. Î˜Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÎ¹ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ ÏŒÏ€Ï‰Ï‚ Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… sandbox, Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Ï„Î·Ï‚ Î´Î¿Î¼Î®Ï‚ sandbox ÏƒÏ„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± kauth, Î· Î±Ï†Î±Î¯ÏÎµÏƒÎ· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ mach ports...

Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ **`_cred_sb_evalutate`** ÎµÎ¯Î½Î±Î¹ Î¼Î¹Î± Ï€ÎµÏÎ¹Ï„ÏÎ»Î¹Î¾Î· Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ **`sb_evaluate_internal`** ÎºÎ±Î¹ Î±Ï…Ï„Î® Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î± Î´Î¹Î±Ï€Î¹ÏƒÏ„ÎµÏ…Ï„Î®ÏÎ¹Î± Ï€Î¿Ï… Ï€ÎµÏÎ½Î¹Î¿ÏÎ½Ï„Î±Î¹ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î·Î½ Î±Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ Ï„Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· **`eval`** Ï€Î¿Ï… ÏƒÏ…Î½Î®Î¸Ï‰Ï‚ Î±Î¾Î¹Î¿Î»Î¿Î³ÎµÎ¯ Ï„Î¿ **Ï€ÏÎ¿Ï†Î¯Î» Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î±Ï‚** Ï€Î¿Ï… ÎµÏ†Î±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÎµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ ÎºÎ±Î¹ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î± Ï„Î¿ **ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ Ï€ÏÎ¿Ï†Î¯Î» Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚**. Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î±Ï‚ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Î±Ï€ÏŒ Ï„Î± ÎºÏÏÎ¹Î± ÏƒÏ…ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ Ï„Î¿Ï… **SIP** ÏƒÏ„Î¿ macOS.

## Sandboxd

Î¤Î¿ Sandbox Î­Ï‡ÎµÎ¹ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î­Î½Î±Î½ daemon Ï‡ÏÎ®ÏƒÏ„Î· Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯ Ï„Î·Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î± XPC Mach `com.apple.sandboxd` ÎºÎ±Î¹ ÏƒÏ…Î½Î´Î­ÎµÎ¹ Ï„Î·Î½ ÎµÎ¹Î´Î¹ÎºÎ® Î¸ÏÏÎ± 14 (`HOST_SEATBELT_PORT`) Ï„Î·Î½ Î¿Ï€Î¿Î¯Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Î· ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï€Ï…ÏÎ®Î½Î± Î³Î¹Î± Î½Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎµÎ¹ Î¼Î±Î¶Î¯ Ï„Î·Ï‚. Î•ÎºÎ¸Î­Ï„ÎµÎ¹ Î¿ÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚ MIG.

## References

* [**\*OS Internals Volume III**](https://newosxbook.com/home.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
