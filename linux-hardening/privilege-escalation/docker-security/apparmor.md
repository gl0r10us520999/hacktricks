# AppArmor

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

AppArmor рдПрдХ **рдХрд░реНрдиреЗрд▓ рд╕рдВрд╡рд░реНрдзрди рд╣реИ рдЬрд┐рд╕реЗ рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдкреНрд░рддрд┐-рдХрд╛рд░реНрдпрдХреНрд░рдо рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**, рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЕрдирд┐рд╡рд╛рд░реНрдп рдкрд╣реБрдБрдЪ рдирд┐рдпрдВрддреНрд░рдг (MAC) рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдкрд╣реБрдБрдЪ рдирд┐рдпрдВрддреНрд░рдг рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рд╕реАрдзреЗ рдХрд╛рд░реНрдпрдХреНрд░рдореЛрдВ рд╕реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИ рдмрдЬрд╛рдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗред рдпрд╣ рдкреНрд░рдгрд╛рд▓реА **рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд▓реЛрдб рдХрд░рдХреЗ** рдХрд╛рдо рдХрд░рддреА рд╣реИ, рдЖрдорддреМрд░ рдкрд░ рдмреВрдЯ рдХреЗ рджреМрд░рд╛рди, рдФрд░ рдпреЗ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХрд┐рди рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдХрдиреЗрдХреНрд╢рди, рдХрдЪреНрдЪреЗ рд╕реЙрдХреЗрдЯ рддрдХ рдкрд╣реБрдБрдЪ, рдФрд░ рдлрд╝рд╛рдЗрд▓ рдЕрдиреБрдорддрд┐рдпрд╛рдБред

AppArmor рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рджреЛ рд╕рдВрдЪрд╛рд▓рди рдореЛрдб рд╣реИрдВ:

* **Enforcement Mode**: рдпрд╣ рдореЛрдб рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЗ рднреАрддрд░ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ, рдЙрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЗрди рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрд▓реНрд▓рдВрдШрди рдХрд░рддреА рд╣реИрдВ рдФрд░ syslog рдпрд╛ auditd рдЬреИрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрд▓реНрд▓рдВрдШрди рдХреЗ рдХрд┐рд╕реА рднреА рдкреНрд░рдпрд╛рд╕ рдХреЛ рд▓реЙрдЧ рдХрд░рддрд╛ рд╣реИред
* **Complain Mode**: рдкреНрд░рд╡рд░реНрддрди рдореЛрдб рдХреЗ рд╡рд┐рдкрд░реАрдд, рд╢рд┐рдХрд╛рдпрдд рдореЛрдб рдЙрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреА рдиреАрддрд┐рдпреЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЬрд╛рддреА рд╣реИрдВред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдпрд╣ рдЗрди рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЛ рдиреАрддрд┐ рдЙрд▓реНрд▓рдВрдШрдиреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдХрд░рддрд╛ рд╣реИ рдмрд┐рдирд╛ рдкреНрд░рддрд┐рдмрдВрдз рд▓рд╛рдЧреВ рдХрд┐рдПред

### Components of AppArmor

* **Kernel Module**: рдиреАрддрд┐рдпреЛрдВ рдХреЗ рдкреНрд░рд╡рд░реНрддрди рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ред
* **Policies**: рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдФрд░ рд╕рдВрд╕рд╛рдзрди рдкрд╣реБрдБрдЪ рдХреЗ рд▓рд┐рдП рдирд┐рдпрдо рдФрд░ рдкреНрд░рддрд┐рдмрдВрдз рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВред
* **Parser**: рдкреНрд░рд╡рд░реНрддрди рдпрд╛ рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред
* **Utilities**: рдпреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдореЛрдб рдХрд╛рд░реНрдпрдХреНрд░рдо рд╣реИрдВ рдЬреЛ AppArmor рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

### Profiles path

Apparmor рдкреНрд░реЛрдлрд╛рдЗрд▓ рдЖрдорддреМрд░ рдкрд░ _**/etc/apparmor.d/**_ рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВред\
`sudo aa-status` рдХреЗ рд╕рд╛рде рдЖрдк рдЙрди рдмрд╛рдЗрдирд░реАрдЬрд╝ рдХреА рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВрдЧреЗ рдЬреЛ рдХрд┐рд╕реА рдкреНрд░реЛрдлрд╛рдЗрд▓ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реИрдВред рдпрджрд┐ рдЖрдк рд╕реВрдЪреАрдмрджреНрдз рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рдЗрдирд░реА рдХреЗ рдкрде рдореЗрдВ "/" рдХреЛ рдмрд┐рдВрджреБ рдореЗрдВ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рднреАрддрд░ apparmor рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХрд╛ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, _/usr/bin/man_ рдХреЗ рд▓рд┐рдП рдПрдХ **apparmor** рдкреНрд░реЛрдлрд╛рдЗрд▓ _/etc/apparmor.d/usr.bin.man_ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрдЧрд╛ред

### Commands
```bash
aa-status     #check the current status
aa-enforce    #set profile to enforce mode (from disable or complain)
aa-complain   #set profile to complain mode (from diable or enforcement)
apparmor_parser #to load/reload an altered policy
aa-genprof    #generate a new profile
aa-logprof    #used to change the policy when the binary/program is changed
aa-mergeprof  #used to merge the policies
```
## рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдирд╛

* рдкреНрд░рднрд╛рд╡рд┐рдд рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **рдкреВрд░реНрдг рдкрде рдФрд░ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рд╣реИред
* рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ **рдлрд╛рдЗрд▓реЛрдВ** рдкрд░ рдХреНрдпрд╛ рдкрд╣реБрдВрдЪ рд╣реЛрдЧреА, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд **рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
* **r** (рдкрдврд╝реЗрдВ)
* **w** (рд▓рд┐рдЦреЗрдВ)
* **m** (рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЗ рд░реВрдк рдореЗрдВ рдореЗрдореЛрд░реА рдореИрдк)
* **k** (рдлрд╛рдЗрд▓ рд▓реЙрдХрд┐рдВрдЧ)
* **l** (рд╣рд╛рд░реНрдб рд▓рд┐рдВрдХ рдмрдирд╛рдирд╛)
* **ix** (рдПрдХ рдирдП рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рд╕рд╛рде рджреВрд╕рд░реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдиреАрддрд┐ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рд▓реЗрдирд╛)
* **Px** (рджреВрд╕рд░реЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗ рддрд╣рдд рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ, рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж)
* **Cx** (рдПрдХ рдмрдЪреНрдЪреЗ рдХреЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗ рддрд╣рдд рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ, рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж)
* **Ux** (рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкреНрд░рддрд┐рдмрдВрдз рдХреЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ, рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж)
* **рдЪрд░** рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗ рдмрд╛рд╣рд░ рд╕реЗ рд╣реЗрд░рдлреЗрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг: @{PROC} рдФрд░ @{HOME} (рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ #include \<tunables/global> рдЬреЛрдбрд╝реЗрдВ)
* **рдЕрдиреБрдорддрд┐ рдирд┐рдпрдореЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд╕реНрд╡реАрдХреГрддрд┐ рдирд┐рдпрдореЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

### aa-genprof

рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП apparmor рдЖрдкрдХреА рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **apparmor рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рдХрд┐рдП рдЧрдП рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░реЗ рдФрд░ рдлрд┐рд░ рдЖрдкрдХреЛ рдпрд╣ рддрдп рдХрд░рдиреЗ рджреЗ рдХрд┐ рдЖрдк рдХреМрди рд╕реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ рдпрд╛ рдЕрд╕реНрд╡реАрдХреГрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**ред\
рдЖрдкрдХреЛ рдмрд╕ рдпрд╣ рдЪрд▓рд╛рдирд╛ рд╣реИ:
```bash
sudo aa-genprof /path/to/binary
```
рдлрд┐рд░, рдПрдХ рдЕрд▓рдЧ рдХрдВрд╕реЛрд▓ рдореЗрдВ рд╕рднреА рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░реЗрдВ рдЬреЛ рдмрд╛рдЗрдирд░реА рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдХрд░реЗрдЧреА:
```bash
/path/to/binary -a dosomething
```
рдлрд┐рд░, рдкрд╣рд▓реЗ рдХрдВрд╕реЛрд▓ рдореЗрдВ "**s**" рджрдмрд╛рдПрдВ рдФрд░ рдлрд┐рд░ рд░рд┐рдХреЙрд░реНрдб рдХреА рдЧрдИ рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдмрддрд╛рдПрдВ рдХрд┐ рдЖрдк рдХреНрдпрд╛ рдЕрдирджреЗрдЦрд╛, рдЕрдиреБрдорддрд┐ рдпрд╛ рдХреБрдЫ рдФрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рдЬрдм рдЖрдк рд╕рдорд╛рдкреНрдд рдХрд░ рд▓реЗрдВ, рддреЛ "**f**" рджрдмрд╛рдПрдВ рдФрд░ рдирдпрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ _/etc/apparmor.d/path.to.binary_ рдореЗрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

{% hint style="info" %}
рддреАрд░ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХреНрдпрд╛ рдЕрдиреБрдорддрд┐/рдЕрд╕реНрд╡реАрдХреГрдд/рдХреБрдЫ рдФрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ
{% endhint %}

### aa-easyprof

рдЖрдк рдПрдХ рдмрд╛рдЗрдирд░реА рдХреЗ apparmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЯреЗрдореНрдкрд▓реЗрдЯ рднреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
sudo aa-easyprof /path/to/binary
# vim:syntax=apparmor
# AppArmor policy for binary
# ###AUTHOR###
# ###COPYRIGHT###
# ###COMMENT###

#include <tunables/global>

# No template variables specified

"/path/to/binary" {
#include <abstractions/base>

# No abstractions specified

# No policy groups specified

# No read paths specified

# No write paths specified
}
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдХ рдмрдирд╛рдП рдЧрдП рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреБрдЫ рднреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рдм рдХреБрдЫ рдЕрд╕реНрд╡реАрдХреГрдд рд╣реИред рдЖрдкрдХреЛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдмрд╛рдЗрдирд░реА рдХреЛ `/etc/passwd` рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП `/etc/passwd r,` рдЬреИрд╕реА рдкрдВрдХреНрддрд┐рдпрд╛рдБ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред
{% endhint %}

рдЖрдк рдлрд┐рд░ **рд▓рд╛рдЧреВ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдирдпрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗ рд╕рд╛рде
```bash
sudo apparmor_parser -a /etc/apparmor.d/path.to.binary
```
### Modifying a profile from logs

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрдХрд░рдг рд▓реЙрдЧ рдкрдврд╝реЗрдЧрд╛ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдкреВрдЫреЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╡рд╣ рдХреБрдЫ рдкрд╣рдЪрд╛рдиреЗ рдЧрдП рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ:
```bash
sudo aa-logprof
```
{% hint style="info" %}
рддреАрд░ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХреНрдпрд╛ рдЕрдиреБрдорддрд┐ рджреЗрдирд╛/рдЕрд╕реНрд╡реАрдХреГрдд рдХрд░рдирд╛/рдХреБрдЫ рдФрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ
{% endhint %}

### рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдирд╛
```bash
#Main profile management commands
apparmor_parser -a /etc/apparmor.d/profile.name #Load a new profile in enforce mode
apparmor_parser -C /etc/apparmor.d/profile.name #Load a new profile in complain mode
apparmor_parser -r /etc/apparmor.d/profile.name #Replace existing profile
apparmor_parser -R /etc/apparmor.d/profile.name #Remove profile
```
## Logs

Example of **AUDIT** and **DENIED** logs from _/var/log/audit/audit.log_ of the executable **`service_bin`**:
```bash
type=AVC msg=audit(1610061880.392:286): apparmor="AUDIT" operation="getattr" profile="/bin/rcat" name="/dev/pts/1" pid=954 comm="service_bin" requested_mask="r" fsuid=1000 ouid=1000
type=AVC msg=audit(1610061880.392:287): apparmor="DENIED" operation="open" profile="/bin/rcat" name="/etc/hosts" pid=954 comm="service_bin" requested_mask="r" denied_mask="r" fsuid=1000 ouid=0
```
рдЖрдк рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
sudo aa-notify -s 1 -v
Profile: /bin/service_bin
Operation: open
Name: /etc/passwd
Denied: r
Logfile: /var/log/audit/audit.log

Profile: /bin/service_bin
Operation: open
Name: /etc/hosts
Denied: r
Logfile: /var/log/audit/audit.log

AppArmor denials: 2 (since Wed Jan  6 23:51:08 2021)
For more information, please see: https://wiki.ubuntu.com/DebuggingApparmor
```
## Apparmor in Docker

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **docker-profile** рдХрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдбреЙрдХрд░ рджреНрд╡рд╛рд░рд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
sudo aa-status
apparmor module is loaded.
50 profiles are loaded.
13 profiles are in enforce mode.
/sbin/dhclient
/usr/bin/lxc-start
/usr/lib/NetworkManager/nm-dhcp-client.action
/usr/lib/NetworkManager/nm-dhcp-helper
/usr/lib/chromium-browser/chromium-browser//browser_java
/usr/lib/chromium-browser/chromium-browser//browser_openjdk
/usr/lib/chromium-browser/chromium-browser//sanitized_helper
/usr/lib/connman/scripts/dhclient-script
docker-default
```
рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **Apparmor docker-default profile** [https://github.com/moby/moby/tree/master/profiles/apparmor](https://github.com/moby/moby/tree/master/profiles/apparmor) рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ

**docker-default profile рд╕рд╛рд░рд╛рдВрд╢**:

* рд╕рднреА **рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ** рддрдХ **рдкрд╣реБрдБрдЪ**
* **рдХреЛрдИ рдХреНрд╖рдорддрд╛** рдкрд░рд┐рднрд╛рд╖рд┐рдд рдирд╣реАрдВ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ рдХреНрд╖рдорддрд╛рдПрдБ рдмреБрдирд┐рдпрд╛рджреА рдЖрдзрд╛рд░ рдирд┐рдпрдореЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╕реЗ рдЖрдПрдВрдЧреА рдпрд╛рдиреА #include \<abstractions/base>)
* рдХрд┐рд╕реА рднреА **/proc** рдлрд╝рд╛рдЗрд▓ рдореЗрдВ **рд▓рд┐рдЦрдирд╛** **рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ**
* /**proc** рдФрд░ /**sys** рдХреЗ рдЕрдиреНрдп **рдЙрдкрдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ**/**рдлрд╝рд╛рдЗрд▓реЗрдВ** рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ/рд▓реЙрдХ/рд▓рд┐рдВрдХ/рдХрд╛рд░реНрдпрдиреНрд╡рдпрди рдкрд╣реБрдБрдЪ рдХреЗ рд▓рд┐рдП **рдЕрд╕реНрд╡реАрдХреГрдд** рд╣реИрдВ
* **рдорд╛рдЙрдВрдЯ** **рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ**
* **Ptrace** рдХреЗрд╡рд▓ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдЪрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ **рд╕рдорд╛рди apparmor profile** рджреНрд╡рд╛рд░рд╛ рд╕реАрдорд┐рдд рд╣реИ

рдПрдХ рдмрд╛рд░ рдЬрдм рдЖрдк **docker container** рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЖрдЙрдЯрдкреБрдЯ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
1 processes are in enforce mode.
docker-default (825)
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **apparmor рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреЛ рджрд┐рдП рдЧрдП рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рднреА рдмреНрд▓реЙрдХ рдХрд░реЗрдЧрд╛**ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╣ **/proc рдХреЗ рдЕрдВрджрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рд╕рдХреЗрдЧрд╛, рднрд▓реЗ рд╣реА SYS\_ADMIN рдХреНрд╖рдорддрд╛ рджреА рдЧрдИ рд╣реЛ** рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ docker apparmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЗрд╕ рдПрдХреНрд╕реЗрд╕ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддреА рд╣реИ:
```bash
docker run -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined ubuntu /bin/bash
echo "" > /proc/stat
sh: 1: cannot create /proc/stat: Permission denied
```
рдЖрдкрдХреЛ рдЗрд╕рдХреА рд╕реАрдорд╛рдУрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **apparmor** рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рд╣реЛрдЧрд╛:
```bash
docker run -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined --security-opt apparmor=unconfined ubuntu /bin/bash
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **AppArmor** рдХрдВрдЯреЗрдирд░ рдХреЛ **рдлреЛрд▓реНрдбрд░реНрд╕ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рд╕реЗ рдордирд╛ рдХрд░реЗрдЧрд╛** рдЕрдВрджрд░ рд╕реЗ, рднрд▓реЗ рд╣реА SYS\_ADMIN рдХреНрд╖рдорддрд╛ рд╣реЛред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк **docker** рдХрдВрдЯреЗрдирд░ рдореЗрдВ **рдХреНрд╖рдорддрд╛рдПрдБ** **рдЬреЛрдбрд╝/рд╣рдЯрд╛** рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣ рдЕрднреА рднреА **AppArmor** рдФрд░ **Seccomp** рдЬреИрд╕реА рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдзрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реЛрдЧрд╛):

* `--cap-add=SYS_ADMIN` `SYS_ADMIN` рдХреНрд╖рдорддрд╛ рджреЗрдВ
* `--cap-add=ALL` рд╕рднреА рдХреНрд╖рдорддрд╛рдПрдБ рджреЗрдВ
* `--cap-drop=ALL --cap-add=SYS_PTRACE` рд╕рднреА рдХреНрд╖рдорддрд╛рдПрдБ рд╣рдЯрд╛ рджреЗрдВ рдФрд░ рдХреЗрд╡рд▓ `SYS_PTRACE` рджреЗрдВ

{% hint style="info" %}
рдЖрдорддреМрд░ рдкрд░, рдЬрдм рдЖрдк **рдкрд╛рддреЗ** рд╣реИрдВ рдХрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд╖рдорддрд╛** **docker** рдХрдВрдЯреЗрдирд░ рдХреЗ **рдЕрдВрджрд░** рдЙрдкрд▓рдмреНрдз рд╣реИ **рд▓реЗрдХрд┐рди** **рд╢реЛрд╖рдг рдХрд╛ рдХреБрдЫ рд╣рд┐рд╕реНрд╕рд╛ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ**, рддреЛ рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реЛрдЧрд╛ рдХрд┐ docker **apparmor рдЗрд╕реЗ рд░реЛрдХ рд░рд╣рд╛ рд╣реЛрдЧрд╛**ред
{% endhint %}

### рдЙрджрд╛рд╣рд░рдг

(рдЙрджрд╛рд╣рд░рдг [**рдпрд╣рд╛рдВ**](https://sreeninet.wordpress.com/2016/03/06/docker-security-part-2docker-engine/) рд╕реЗ)

AppArmor рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдПрдХ рдирдпрд╛ Docker рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ "mydocker" рдмрдирд╛рдпрд╛ рдЬрд┐рд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкрдВрдХреНрддрд┐ рдЬреЛрдбрд╝реА рдЧрдИ:
```
deny /etc/* w,   # deny write for all files directly in /etc (not in a subdir)
```
рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:
```
sudo apparmor_parser -r -W mydocker
```
рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдиреАрдЪреЗ рджреА рдЧрдИ рдХрдорд╛рдВрдб рдореЗрд░реЗ рдирдП AppArmor рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░ рд░рд╣реА рд╣реИред
```
$ sudo apparmor_status  | grep mydocker
mydocker
```
рдЬреИрд╕рд╛ рдХрд┐ рдиреАрдЪреЗ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрдм рд╣рдо тАЬ/etc/тАЭ рдХреЛ рдмрджрд▓рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдореЗрдВ рддреНрд░реБрдЯрд┐ рдорд┐рд▓рддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ AppArmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ тАЬ/etcтАЭ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкрд╣реБрдВрдЪ рдХреЛ рд░реЛрдХ рд░рд╣реА рд╣реИред
```
$ docker run --rm -it --security-opt apparmor:mydocker -v ~/haproxy:/localhost busybox chmod 400 /etc/hostname
chmod: /etc/hostname: Permission denied
```
### AppArmor Docker Bypass1

рдЖрдк рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **рдХреМрди рд╕рд╛ apparmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдПрдХ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИ**:
```bash
docker inspect 9d622d73a614 | grep lowpriv
"AppArmorProfile": "lowpriv",
"apparmor=lowpriv"
```
рдлрд┐рд░, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкрдВрдХреНрддрд┐ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ **рд╕рдЯреАрдХ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ**:
```bash
find /etc/apparmor.d/ -name "*lowpriv*" -maxdepth 1 2>/dev/null
```
In the weird case you can **modify the apparmor docker profile and reload it.** You could remove the restrictions and "bypass" them.

### AppArmor Docker Bypass2

**AppArmor is path based**, this means that even if it might be **protecting** files inside a directory like **`/proc`** if you can **configure how the container is going to be run**, you could **mount** the proc directory of the host inside **`/host/proc`** and it **рдЕрдм AppArmor рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реЛрдЧрд╛**.

### AppArmor Shebang Bypass

In [**this bug**](https://bugs.launchpad.net/apparmor/+bug/1911431) you can see an example of how **even if you are preventing perl to be run with certain resources**, if you just create a a shell script **specifying** in the first line **`#!/usr/bin/perl`** and you **execute the file directly**, you will be able to execute whatever you want. E.g.:
```perl
echo '#!/usr/bin/perl
use POSIX qw(strftime);
use POSIX qw(setuid);
POSIX::setuid(0);
exec "/bin/sh"' > /tmp/test.pl
chmod +x /tmp/test.pl
/tmp/test.pl
```
{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
