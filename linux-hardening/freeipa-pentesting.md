# FreeIPA Pentesting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

FreeIPA est une **alternative** open-source √† Microsoft Windows **Active Directory**, principalement pour les environnements **Unix**. Il combine un **annuaire LDAP** complet avec un Centre de Distribution de Cl√©s **Kerberos** MIT pour une gestion similaire √† Active Directory. Utilisant le **Syst√®me de Certificats** Dogtag pour la gestion des certificats CA et RA, il prend en charge l'**authentification multi-facteurs**, y compris les cartes intelligentes. SSSD est int√©gr√© pour les processus d'authentification Unix.

## Fingerprints

### Files & Environment Variables

* Le fichier √† `/etc/krb5.conf` est l'endroit o√π les informations du client Kerberos, n√©cessaires pour l'inscription dans le domaine, sont stock√©es. Cela inclut les emplacements des KDC et des serveurs administratifs, les param√®tres par d√©faut et les mappages.
* Les param√®tres par d√©faut pour les clients et serveurs IPA sont d√©finis dans le fichier situ√© √† `/etc/ipa/default.conf`.
* Les h√¥tes au sein du domaine doivent avoir un fichier `krb5.keytab` √† `/etc/krb5.keytab` pour les processus d'authentification.
* Diverses variables d'environnement (`KRB5CCNAME`, `KRB5_KTNAME`, `KRB5_CONFIG`, `KRB5_KDC_PROFILE`, `KRB5RCACHETYPE`, `KRB5RCACHEDIR`, `KRB5_TRACE`, `KRB5_CLIENT_KTNAME`, `KPROP_PORT`) sont utilis√©es pour pointer vers des fichiers et des param√®tres sp√©cifiques li√©s √† l'authentification Kerberos.

### Binaries

Des outils tels que `ipa`, `kdestroy`, `kinit`, `klist`, `kpasswd`, `ksu`, `kswitch`, et `kvno` sont centraux pour la gestion des domaines FreeIPA, la gestion des tickets Kerberos, le changement de mots de passe et l'acquisition de tickets de service, entre autres fonctionnalit√©s.

### Network

Une illustration est fournie pour d√©peindre une configuration typique de serveur FreeIPA.

## Authentication

L'authentification dans FreeIPA, utilisant **Kerberos**, refl√®te celle de **Active Directory**. L'acc√®s aux ressources du domaine n√©cessite un ticket Kerberos valide, qui peut √™tre stock√© √† divers emplacements selon la configuration du domaine FreeIPA.

### **CCACHE Ticket Files**

Les fichiers CCACHE, g√©n√©ralement stock√©s dans **`/tmp`** avec des permissions **600**, sont des formats binaires pour stocker les informations d'identification Kerberos, importants pour l'authentification sans le mot de passe en texte clair de l'utilisateur en raison de leur portabilit√©. L'analyse d'un ticket CCACHE peut √™tre effectu√©e √† l'aide de la commande `klist`, et la r√©utilisation d'un ticket CCACHE valide implique d'exporter `KRB5CCNAME` vers le chemin du fichier de ticket.

### **Unix Keyring**

Alternativement, les tickets CCACHE peuvent √™tre stock√©s dans le keyring Linux, offrant plus de contr√¥le sur la gestion des tickets. La port√©e du stockage des tickets varie (`KEYRING:name`, `KEYRING:process:name`, `KEYRING:thread:name`, `KEYRING:session:name`, `KEYRING:persistent:uidnumber`), avec `klist` capable d'analyser ces informations pour l'utilisateur. Cependant, la r√©utilisation d'un ticket CCACHE depuis le keyring Unix peut poser des d√©fis, avec des outils comme **Tickey** disponibles pour extraire les tickets Kerberos.

### Keytab

Les fichiers keytab, contenant des principaux Kerberos et des cl√©s chiffr√©es, sont critiques pour obtenir des tickets de distribution de tickets valides (TGT) sans avoir besoin du mot de passe du principal. L'analyse et la r√©utilisation des informations d'identification √† partir des fichiers keytab peuvent √™tre facilement effectu√©es avec des utilitaires comme `klist` et des scripts tels que **KeytabParser**.

### Cheatsheet

Vous pouvez trouver plus d'informations sur la fa√ßon d'utiliser les tickets dans linux dans le lien suivant :

{% content-ref url="privilege-escalation/linux-active-directory.md" %}
[linux-active-directory.md](privilege-escalation/linux-active-directory.md)
{% endcontent-ref %}

## Enumeration

{% hint style="warning" %}
Vous pourriez effectuer l'**√©num√©ration** via **ldap** et d'autres outils **binaires**, ou **en vous connectant √† la page web sur le port 443 du serveur FreeIPA**.
{% endhint %}

### Hosts, Users, and Groups <a href="#id-4b3b" id="id-4b3b"></a>

Il est possible de cr√©er des **h√¥tes**, des **utilisateurs** et des **groupes**. Les h√¥tes et les utilisateurs sont tri√©s dans des conteneurs appel√©s ‚Äú**Groupes d'H√¥tes**‚Äù et ‚Äú**Groupes d'Utilisateurs**‚Äù respectivement. Ceux-ci sont similaires aux **Unit√©s Organisationnelles** (OU).

Par d√©faut dans FreeIPA, le serveur LDAP permet des **liens anonymes**, et une grande partie des donn√©es est √©num√©rable **non authentifi√©e**. Cela peut √©num√©rer toutes les donn√©es disponibles non authentifi√©es :
```
ldapsearch -x
```
Pour obtenir **plus d'informations**, vous devez utiliser une session **authentifi√©e** (consultez la section Authentification pour apprendre comment pr√©parer une session authentifi√©e).
```bash
# Get all users of domain
ldapsearch -Y gssapi -b "cn=users,cn=compat,dc=domain_name,dc=local"

# Get users groups
ldapsearch -Y gssapi -b "cn=groups,cn=accounts,dc=domain_name,dc=local"

# Get all the hosts
ldapsearch -Y gssapi -b "cn=computers,cn=accounts,dc=domain_name,dc=local"

# Get hosts groups
ldapsearch -Y gssapi -b "cn=hostgroups,cn=accounts,dc=domain_name,dc=local"
```
√Ä partir d'une machine jointe au domaine, vous pourrez utiliser **des binaires install√©s** pour √©num√©rer le domaine :
```bash
ipa user-find
ipa usergroup-find
ipa host-find
ipa host-group-find

-------------------

ipa user-show <username> --all
ipa usergroup-show <user group> --all
ipa host-find <host> --all
ipa hostgroup-show <host group> --all
```
{% hint style="info" %}
L'utilisateur **admin** de **FreeIPA** est l'√©quivalent des **domain admins** de **AD**.
{% endhint %}

### Hashes <a href="#id-482b" id="id-482b"></a>

L'utilisateur **root** du serveur **IPA** a acc√®s aux **hashes** de mot de passe.

* Le hash de mot de passe d'un utilisateur est stock√© en **base64** dans l'attribut ‚Äú**userPassword**‚Äù. Ce hash peut √™tre **SSHA512** (anciennes versions de FreeIPA) ou **PBKDF2\_SHA256**.
* Le **Nthash** du mot de passe est stock√© en **base64** dans ‚Äú**ipaNTHash**‚Äù si le syst√®me a une **int√©gration** avec **AD**.

Pour cracker ces hashes :

‚Ä¢ Si FreeIPA est int√©gr√© avec AD, **ipaNTHash** est facile √† cracker : Vous devez **d√©coder** **base64** -> le r√©encoder en **ASCII** hex -> John The Ripper ou **hashcat** peuvent vous aider √† le cracker rapidement.

‚Ä¢ Si une ancienne version de FreeIPA est utilis√©e, alors **SSHA512** est utilis√© : Vous devez d√©coder **base64** -> trouver le **hash** SSHA512 -> John The Ripper ou **hashcat** peuvent vous aider √† le cracker.

‚Ä¢ Si une nouvelle version de FreeIPA est utilis√©e, alors **PBKDF2\_SHA256** est utilis√© : Vous devez d√©coder **base64** -> trouver PBKDF2\_SHA256 -> sa **longueur** est de 256 octets. John peut travailler avec 256 bits (32 octets) -> SHA-265 est utilis√© comme fonction pseudo-al√©atoire, la taille de bloc est de 32 octets -> vous pouvez utiliser seulement les premiers 256 bits de notre hash PBKDF2\_SHA256 -> John The Ripper ou hashcat peuvent vous aider √† le cracker.

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

Pour extraire les hashes, vous devez √™tre **root sur le serveur FreeIPA**, l√† vous pouvez utiliser l'outil **`dbscan`** pour les extraire :

<figure><img src="../.gitbook/assets/image (293).png" alt=""><figcaption></figcaption></figure>

### HBAC-Rules <a href="#id-482b" id="id-482b"></a>

Ce sont les r√®gles qui accordent des permissions sp√©cifiques aux utilisateurs ou aux h√¥tes sur des ressources (h√¥tes, services, groupes de services...)
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=hbac,dc=domain_name,dc=local"
# Using ipa
ipa hbacrule-find
# Show info of rule
ipa hbacrule-show <hbacrule> --all
```
#### Sudo-Rules

FreeIPA permet un contr√¥le centralis√© des **permissions sudo** via des r√®gles sudo. Ces r√®gles permettent ou limitent l'ex√©cution de commandes avec sudo sur les h√¥tes au sein du domaine. Un attaquant pourrait potentiellement identifier les h√¥tes applicables, les utilisateurs et les commandes autoris√©es en examinant ces ensembles de r√®gles.
```bash
# Enumerate using ldap
ldapsearch -Y gssapi -b "cn=sudorules,cn=sudo,dc=domain_name,dc=local"
# Using ipa
ipa sudorule-find
# Show info of rule
ipa sudorule-show <sudorule> --all
```
### Contr√¥le d'Acc√®s Bas√© sur les R√¥les

Un **r√¥le** est compos√© de divers **privil√®ges**, chacun englobant un ensemble de **permissions**. Ces r√¥les peuvent √™tre attribu√©s aux Utilisateurs, Groupes d'Utilisateurs, **H√¥tes**, Groupes d'H√¥tes et Services. Par exemple, consid√©rons le r√¥le par d√©faut ‚ÄúAdministrateur d'Utilisateurs‚Äù dans FreeIPA pour illustrer cette structure.

Le r√¥le `Administrateur d'Utilisateurs` a ces privil√®ges :

* **Administrateurs d'Utilisateurs**
* **Administrateurs de Groupes**
* **Administrateurs d'Utilisateurs de Stage**

Avec les commandes suivantes, il est possible d'√©num√©rer les r√¥les, privil√®ges et permissions :
```bash
# Using ldap
ldapsearch -Y gssapi -b "cn=roles,cn=accounts,dc=westeros,dc=local"
# Using ipa binary
ipa role-find
ipa role-show <role> --all
ipa privilege-find
ipa privilege-show <privilege> --all
ipa permission-find
ipa permission-show <permission> --all
```
### Exemple de sc√©nario d'attaque

Dans [https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e](https://posts.specterops.io/attacking-freeipa-part-iii-finding-a-path-677405b5b95e), vous pouvez trouver un exemple simple de la fa√ßon d'abuser de certaines permissions pour compromettre le domaine.

### Linikatz/LinikatzV2

* [https://github.com/Orange-Cyberdefense/LinikatzV2](https://github.com/Orange-Cyberdefense/LinikatzV2)
* [https://github.com/CiscoCXSecurity/linikatz](https://github.com/CiscoCXSecurity/linikatz)

## Privesc

### ~~cr√©ation d'utilisateur root~~

{% hint style="warning" %}
Si vous pouvez **cr√©er un nouvel utilisateur avec le nom `root`**, vous pouvez vous faire passer pour lui et vous pourrez **SSH sur n'importe quelle machine en tant que root.**

**CECI A √âT√â CORRIG√â.**
{% endhint %}

Vous pouvez consulter une explication d√©taill√©e dans [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)

## R√©f√©rences

* [https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b](https://posts.specterops.io/attacking-freeipa-part-iv-cve-2020-10747-7c373a1bf66b)
* [https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a](https://posts.specterops.io/attacking-freeipa-part-i-authentication-77e73d837d6a)
* [https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1](https://posts.specterops.io/attacking-freeipa-part-ii-enumeration-ad27224371e1)
* [https://www.youtube.com/watch?v=9dOu-7BTwPQ](https://www.youtube.com/watch?v=9dOu-7BTwPQ)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
