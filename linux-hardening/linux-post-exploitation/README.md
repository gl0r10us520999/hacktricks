# Linux Na-Exploitation

{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Sniffing Aanteken Wagwoorde met PAM

Laat ons 'n PAM-module konfigureer om elke wagwoord wat elke gebruiker gebruik om in te teken, te registreer. As jy nie weet wat PAM is nie, kyk:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Vir verdere besonderhede, kyk na die [oorspronklike pos](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Dit is net 'n opsomming:

**Tegniek Oorsig:**
Pluggable Authentication Modules (PAM) bied buigsaamheid in die bestuur van outentifikasie op Unix-gebaseerde stelsels. Hulle kan die sekuriteit verbeter deur die aanpassing van die aanmeldingsproses, maar hulle kan ook risiko's inhou as dit verkeerd gebruik word. Hierdie opsomming skets 'n tegniek om aanmeldingskredensiale met PAM vas te vang, tesame met maatre√´ls vir verligting.

**Vaslegging van Kredensiale:**
- 'n bash-skrip met die naam `toomanysecrets.sh` word geskep om aanmeldingspogings te registreer, waar die datum, gebruikersnaam (`$PAM_USER`), wagwoord (via stdin), en afgele√´ gasheer IP (`$PAM_RHOST`) na `/var/log/toomanysecrets.log` vasgel√™ word.
- Die skrip word uitvoerbaar gemaak en ge√Øntegreer in die PAM-konfigurasie (`common-auth`) deur die `pam_exec.so`-module te gebruik met opsies om stil te hardloop en die outentiseringsleutel aan die skrip bloot te stel.
- Die benadering demonstreer hoe 'n gekompromitteerde Linux-gasheer uitgebuit kan word om kredensiale stiekem te registreer.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**Vir verdere besonderhede, kyk na die [oorspronklike pos](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Hierdie is net 'n opsomming:

Die Pluggable Authentication Module (PAM) is 'n stelsel wat onder Linux gebruik word vir gebruikersverifikasie. Dit werk op drie hoofkonsepte: **gebruikersnaam**, **wagwoord**, en **diens**. Konfigurasie l√™ers vir elke diens is gele√´ in die `/etc/pam.d/` gids, waar gedeelde biblioteke verifikasie hanteer.

**Doel**: Wysig PAM om verifikasie met 'n spesifieke wagwoord moontlik te maak, deur die werklike gebruikerswagwoord te omseil. Dit fokus veral op die `pam_unix.so` gedeelde biblioteek wat deur die `common-auth` l√™er gebruik word, wat deur byna alle dienste vir wagwoordverifikasie ingesluit word.

### Stappe vir die Wysiging van `pam_unix.so`:

1. **Vind die Verifikasie Direktief** in die `common-auth` l√™er:
- Die lyn verantwoordelik vir die kontrole van 'n gebruiker se wagwoord roep `pam_unix.so` aan.
2. **Wysig die Bronkode**:
- Voeg 'n kondisionele verklaring by in die `pam_unix_auth.c` bronl√™er wat toegang verleen as 'n voorafbepaalde wagwoord gebruik word, anders gaan dit voort met die normale verifikasieproses.
3. **Herstel en Vervang** die gewysigde `pam_unix.so` biblioteek in die toepaslike gids.
4. **Toetsing**:
- Toegang word verleen oor verskeie dienste (aanmelding, ssh, sudo, su, skermspaarder) met die voorafbepaalde wagwoord, terwyl normale verifikasieprosesse onveranderd bly.

{% hint style="info" %}
Jy kan hierdie proses outomatiseer met [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Leer & oefen AWS Hack: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
