# Linux Post-Exploitation

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä½¿ç”¨ PAM å—…æ¢ç™»å½•å¯†ç 

è®©æˆ‘ä»¬é…ç½®ä¸€ä¸ª PAM æ¨¡å—æ¥è®°å½•æ¯ä¸ªç”¨æˆ·ç™»å½•æ—¶ä½¿ç”¨çš„å¯†ç ã€‚å¦‚æœä½ ä¸çŸ¥é“ PAM æ˜¯ä»€ä¹ˆï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [åŸå§‹å¸–å­](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

**æŠ€æœ¯æ¦‚è¿°ï¼š**
å¯æ’æ‹”è®¤è¯æ¨¡å— (PAM) æä¾›äº†åœ¨åŸºäº Unix çš„ç³»ç»Ÿä¸Šç®¡ç†è®¤è¯çš„çµæ´»æ€§ã€‚å®ƒä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç™»å½•è¿‡ç¨‹æ¥å¢å¼ºå®‰å…¨æ€§ï¼Œä½†å¦‚æœä½¿ç”¨ä¸å½“ä¹Ÿä¼šå¸¦æ¥é£é™©ã€‚æ­¤æ‘˜è¦æ¦‚è¿°äº†ä¸€ç§ä½¿ç”¨ PAM æ•è·ç™»å½•å‡­æ®çš„æŠ€æœ¯ï¼Œä»¥åŠç¼“è§£ç­–ç•¥ã€‚

**æ•è·å‡­æ®ï¼š**
- åˆ›å»ºä¸€ä¸ªåä¸º `toomanysecrets.sh` çš„ bash è„šæœ¬ï¼Œç”¨äºè®°å½•ç™»å½•å°è¯•ï¼Œæ•è·æ—¥æœŸã€ç”¨æˆ·å (`$PAM_USER`)ã€å¯†ç ï¼ˆé€šè¿‡ stdinï¼‰å’Œè¿œç¨‹ä¸»æœº IP (`$PAM_RHOST`) åˆ° `/var/log/toomanysecrets.log`ã€‚
- è¯¥è„šæœ¬è¢«è®¾ç½®ä¸ºå¯æ‰§è¡Œï¼Œå¹¶é€šè¿‡ `pam_exec.so` æ¨¡å—é›†æˆåˆ° PAM é…ç½® (`common-auth`) ä¸­ï¼Œé€‰é¡¹ä¸ºå®‰é™è¿è¡Œå¹¶å°†è®¤è¯ä»¤ç‰Œæš´éœ²ç»™è„šæœ¬ã€‚
- è¯¥æ–¹æ³•æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨è¢«æ”»é™·çš„ Linux ä¸»æœºæ¥éšç§˜åœ°è®°å½•å‡­æ®ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[åŸå§‹å¸–å­](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‘˜è¦ï¼š

å¯æ’æ‹”è®¤è¯æ¨¡å—ï¼ˆPAMï¼‰æ˜¯Linuxä¸‹ç”¨äºç”¨æˆ·è®¤è¯çš„ç³»ç»Ÿã€‚å®ƒåŸºäºä¸‰ä¸ªä¸»è¦æ¦‚å¿µï¼š**ç”¨æˆ·å**ã€**å¯†ç **å’Œ**æœåŠ¡**ã€‚æ¯ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶ä½äº`/etc/pam.d/`ç›®å½•ä¸­ï¼Œé‚£é‡Œæœ‰å…±äº«åº“å¤„ç†è®¤è¯ã€‚

**ç›®æ ‡**ï¼šä¿®æ”¹PAMä»¥å…è®¸ä½¿ç”¨ç‰¹å®šå¯†ç è¿›è¡Œè®¤è¯ï¼Œç»•è¿‡å®é™…ç”¨æˆ·å¯†ç ã€‚è¿™ç‰¹åˆ«å…³æ³¨`common-auth`æ–‡ä»¶ä¸­ä½¿ç”¨çš„`pam_unix.so`å…±äº«åº“ï¼Œè¯¥æ–‡ä»¶å‡ ä¹è¢«æ‰€æœ‰æœåŠ¡ç”¨äºå¯†ç éªŒè¯ã€‚

### ä¿®æ”¹`pam_unix.so`çš„æ­¥éª¤ï¼š

1. **åœ¨`common-auth`æ–‡ä»¶ä¸­å®šä½è®¤è¯æŒ‡ä»¤**ï¼š
- è´Ÿè´£æ£€æŸ¥ç”¨æˆ·å¯†ç çš„è¡Œè°ƒç”¨`pam_unix.so`ã€‚
2. **ä¿®æ”¹æºä»£ç **ï¼š
- åœ¨`pam_unix_auth.c`æºæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œå¦‚æœä½¿ç”¨é¢„å®šä¹‰å¯†ç åˆ™æˆäºˆè®¿é—®æƒé™ï¼Œå¦åˆ™ç»§ç»­è¿›è¡Œå¸¸è§„è®¤è¯è¿‡ç¨‹ã€‚
3. **é‡æ–°ç¼–è¯‘å¹¶æ›¿æ¢**ä¿®æ”¹åçš„`pam_unix.so`åº“åˆ°é€‚å½“çš„ç›®å½•ã€‚
4. **æµ‹è¯•**ï¼š
- ä½¿ç”¨é¢„å®šä¹‰å¯†ç åœ¨å„ç§æœåŠ¡ï¼ˆç™»å½•ã€sshã€sudoã€suã€å±å¹•ä¿æŠ¤ç¨‹åºï¼‰ä¸­æˆäºˆè®¿é—®æƒé™ï¼Œè€Œæ­£å¸¸çš„è®¤è¯è¿‡ç¨‹ä¸å—å½±å“ã€‚

{% hint style="info" %}
æ‚¨å¯ä»¥ä½¿ç”¨[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹
{% endhint %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWSé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­AWSçº¢é˜Ÿä¸“å®¶ï¼ˆARTEï¼‰**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCPé»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricksåŸ¹è®­GCPçº¢é˜Ÿä¸“å®¶ï¼ˆGRTEï¼‰**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
