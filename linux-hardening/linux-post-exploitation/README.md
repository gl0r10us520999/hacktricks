# Linux Post-Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Sniffing Logon Passwords with PAM

Configurons un module PAM pour enregistrer chaque mot de passe utilis√© par chaque utilisateur pour se connecter. Si vous ne savez pas ce qu'est PAM, consultez :

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Pour plus de d√©tails, consultez le [post original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Ceci est juste un r√©sum√© :

**Aper√ßu de la technique :**
Les modules d'authentification pluggables (PAM) offrent une flexibilit√© dans la gestion de l'authentification sur les syst√®mes bas√©s sur Unix. Ils peuvent am√©liorer la s√©curit√© en personnalisant les processus de connexion, mais pr√©sentent √©galement des risques s'ils sont mal utilis√©s. Ce r√©sum√© d√©crit une technique pour capturer les informations d'identification de connexion √† l'aide de PAM, ainsi que des strat√©gies d'att√©nuation.

**Capture des informations d'identification :**
- Un script bash nomm√© `toomanysecrets.sh` est cr√©√© pour enregistrer les tentatives de connexion, capturant la date, le nom d'utilisateur (`$PAM_USER`), le mot de passe (via stdin) et l'IP de l'h√¥te distant (`$PAM_RHOST`) dans `/var/log/toomanysecrets.log`.
- Le script est rendu ex√©cutable et int√©gr√© dans la configuration PAM (`common-auth`) √† l'aide du module `pam_exec.so` avec des options pour s'ex√©cuter silencieusement et exposer le jeton d'authentification au script.
- L'approche d√©montre comment un h√¥te Linux compromis peut √™tre exploit√© pour enregistrer discr√®tement les informations d'identification.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**Pour plus de d√©tails, consultez le [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Ceci est juste un r√©sum√© :

Le Module d'Authentification Pluggable (PAM) est un syst√®me utilis√© sous Linux pour l'authentification des utilisateurs. Il fonctionne sur trois concepts principaux : **nom d'utilisateur**, **mot de passe** et **service**. Les fichiers de configuration pour chaque service se trouvent dans le r√©pertoire `/etc/pam.d/`, o√π des biblioth√®ques partag√©es g√®rent l'authentification.

**Objectif** : Modifier PAM pour permettre l'authentification avec un mot de passe sp√©cifique, contournant le mot de passe r√©el de l'utilisateur. Cela se concentre particuli√®rement sur la biblioth√®que partag√©e `pam_unix.so` utilis√©e par le fichier `common-auth`, qui est inclus par presque tous les services pour la v√©rification des mots de passe.

### √âtapes pour modifier `pam_unix.so` :

1. **Localiser la directive d'authentification** dans le fichier `common-auth` :
- La ligne responsable de la v√©rification du mot de passe d'un utilisateur appelle `pam_unix.so`.
2. **Modifier le code source** :
- Ajouter une instruction conditionnelle dans le fichier source `pam_unix_auth.c` qui accorde l'acc√®s si un mot de passe pr√©d√©fini est utilis√©, sinon, il poursuit le processus d'authentification habituel.
3. **Recompiler et remplacer** la biblioth√®que modifi√©e `pam_unix.so` dans le r√©pertoire appropri√©.
4. **Test** :
- L'acc√®s est accord√© √† travers divers services (connexion, ssh, sudo, su, √©conomiseur d'√©cran) avec le mot de passe pr√©d√©fini, tandis que les processus d'authentification normaux restent inchang√©s.

{% hint style="info" %}
Vous pouvez automatiser ce processus avec [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supportez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
