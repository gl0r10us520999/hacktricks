# Linux Post-Exploitation

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Capturando Senhas de Login com PAM

Vamos configurar um m√≥dulo PAM para registrar cada senha que cada usu√°rio usa para fazer login. Se voc√™ n√£o sabe o que √© PAM, confira:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**Para mais detalhes, confira o [post original](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Este √© apenas um resumo:

**Vis√£o Geral da T√©cnica:**
M√≥dulos de Autentica√ß√£o Pluggable (PAM) oferecem flexibilidade na gest√£o de autentica√ß√£o em sistemas baseados em Unix. Eles podem aumentar a seguran√ßa personalizando processos de login, mas tamb√©m apresentam riscos se mal utilizados. Este resumo descreve uma t√©cnica para capturar credenciais de login usando PAM, juntamente com estrat√©gias de mitiga√ß√£o.

**Capturando Credenciais:**
- Um script bash chamado `toomanysecrets.sh` √© criado para registrar tentativas de login, capturando a data, nome de usu√°rio (`$PAM_USER`), senha (via stdin) e IP do host remoto (`$PAM_RHOST`) em `/var/log/toomanysecrets.log`.
- O script √© tornado execut√°vel e integrado √† configura√ß√£o do PAM (`common-auth`) usando o m√≥dulo `pam_exec.so` com op√ß√µes para rodar silenciosamente e expor o token de autentica√ß√£o ao script.
- A abordagem demonstra como um host Linux comprometido pode ser explorado para registrar credenciais discretamente.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**Para mais detalhes, consulte o [post original](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Este √© apenas um resumo:

O M√≥dulo de Autentica√ß√£o Pluggable (PAM) √© um sistema usado no Linux para autentica√ß√£o de usu√°rios. Ele opera em tr√™s conceitos principais: **nome de usu√°rio**, **senha** e **servi√ßo**. Os arquivos de configura√ß√£o para cada servi√ßo est√£o localizados no diret√≥rio `/etc/pam.d/`, onde bibliotecas compartilhadas gerenciam a autentica√ß√£o.

**Objetivo**: Modificar o PAM para permitir a autentica√ß√£o com uma senha espec√≠fica, contornando a senha real do usu√°rio. Isso √© particularmente focado na biblioteca compartilhada `pam_unix.so` usada pelo arquivo `common-auth`, que √© inclu√≠do por quase todos os servi√ßos para verifica√ß√£o de senha.

### Passos para Modificar `pam_unix.so`:

1. **Localizar a Diretiva de Autentica√ß√£o** no arquivo `common-auth`:
- A linha respons√°vel por verificar a senha de um usu√°rio chama `pam_unix.so`.
2. **Modificar o C√≥digo Fonte**:
- Adicione uma instru√ß√£o condicional no arquivo de c√≥digo fonte `pam_unix_auth.c` que concede acesso se uma senha predefinida for usada; caso contr√°rio, prossegue com o processo de autentica√ß√£o usual.
3. **Recompilar e Substituir** a biblioteca `pam_unix.so` modificada no diret√≥rio apropriado.
4. **Teste**:
- O acesso √© concedido em v√°rios servi√ßos (login, ssh, sudo, su, protetor de tela) com a senha predefinida, enquanto os processos normais de autentica√ß√£o permanecem inalterados.

{% hint style="info" %}
Voc√™ pode automatizar esse processo com [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
