# NTFS

## NTFS

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを入手
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**をフォロー**する。
- **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## **NTFS**

**NTFS**（**New Technology File System**）は、Microsoftによって開発されたプロプライエタリなジャーナリングファイルシステムです。

クラスタはNTFSにおける最小のサイズ単位であり、クラスタのサイズはパーティションのサイズに依存します。

| パーティションサイズ       | クラスタあたりのセクタ数 | クラスタサイズ |
| ------------------------ | ------------------- | ------------ |
| 512MB以下                 | 1                   | 512バイト     |
| 513MB-1024MB（1GB）       | 2                   | 1KB          |
| 1025MB-2048MB（2GB）      | 4                   | 2KB          |
| 2049MB-4096MB（4GB）      | 8                   | 4KB          |
| 4097MB-8192MB（8GB）      | 16                  | 8KB          |
| 8193MB-16,384MB（16GB）   | 32                  | 16KB         |
| 16,385MB-32,768MB（32GB） | 64                  | 32KB         |
| 32,768MBより大きい        | 128                 | 64KB         |

### **スラックスペース**

NTFSにおける最小のサイズ単位は**クラスタ**です。各ファイルは複数の完全なクラスタを占有します。そのため、**各ファイルが必要以上のスペースを占有する可能性が非常に高い**です。ファイルが予約した**未使用のスペース**は、**スラックスペース**と呼ばれ、人々はこの領域を利用して**情報を隠す**ことができます。

![](<../../../.gitbook/assets/image (498).png>)

### **NTFSブートセクタ**

NTFSボリュームをフォーマットすると、フォーマットプログラムは最初の16セクタをブートメタデータファイルに割り当てます。最初のセクタはブートセクタであり、「ブートストラップ」コードが含まれ、続く15セクタはブートセクタのIPL（Initial Program Loader）です。ファイルシステムの信頼性を高めるために、NTFSパーティションの最後のセクタにはブートセクタの予備コピーが含まれています。

### **マスターファイルテーブル（MFT）**

NTFSファイルシステムには、マスターファイルテーブル（MFT）と呼ばれるファイルが含まれています。NTFSファイルシステムボリューム上のすべてのファイルに対して、MFTに少なくとも**1つのエントリがあります**。MFT自体を含む、ファイルの**サイズ、時刻、日付スタンプ、権限、データ内容**などのすべての情報は、MFTエントリまたはMFTエントリで説明されているMFTの外側のスペースに格納されます。

NTFSファイルシステムボリュームにファイルが追加されると、MFTにエントリが追加され、MFTのサイズが増加します。NTFSファイルシステムボリュームからファイルが削除されると、そのMFTエントリは**空きとしてマークされ**、再利用される可能性があります。ただし、これらのエントリに割り当てられたディスクスペースは再割り当てされず、MFTのサイズは減少しません。

NTFSファイルシステムは、MFTを可能な限り連続した状態に保つためにMFTのためのスペースを予約します。各ボリュームでNTFSファイルシステムによってMFTのために予約されたスペースは**MFTゾーン**と呼ばれます。ファイルとディレクトリのスペースもこのスペースから割り当てられますが、MFTゾーンの外側のボリュームスペースがすべて割り当てられた後にのみ割り当てられます。

平均ファイルサイズやその他の変数に応じて、**ディスクが容量いっぱいになると、予約されたMFTゾーンまたはディスクの未予約スペースのどちらかが最初に割り当てられます**。比較的大きなファイル数を持つボリュームは、未予約スペースを最初に割り当てますが、比較的小さなファイル数を持つボリュームは、MFTゾーンを最初に割り当てます。いずれの場合も、MFTの断片化が発生し始めます。未予約スペースが完全に割り当てられると、ユーザーファイルとディレクトリのスペースがMFTゾーンから割り当てられます。MFTゾーンが完全に割り当てられると、新しいMFTエントリのスペースが未予約スペースから割り当てられます。

NTFSファイルシステムは、**$MFTMirror**も生成します。これはMFTの最初の4つのエントリの**コピー**です：$MFT、$MFT Mirror、$Log、$Volume。

NTFSは、テーブルの最初の16レコードを特別な情報のために予約します：

| システムファイル       | ファイル名 | MFTレコード | ファイルの目的                                                                                                                                                                                                           |
| --------------------- | --------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| マスターファイルテーブル | $Mft      | 0          | NTFSボリューム上のすべてのファイルとフォルダに1つの基本ファイルレコードが含まれています。ファイルまたはフォルダの割り当て情報が1つのレコードに収まりきらない場合、他のファイルレコードも割り当てられます。            |
| マスターファイルテーブル2   | $MftMirr  | 1          | MFTの最初の4つのレコードの重複画像。このファイルは、1つのセクタの障害が発生した場合にMFTへのアクセスを保証します。                                                                                            |
| ログファイル              | $LogFile  | 2          | NTFSの回復可能性に使用されるトランザクション手順のリストが含まれています。ログファイルのサイズはボリュームサイズに依存し、最大で4MBになります。Windows NT/2000は、システム障害後にNTFSの整合性を回復するために使用します。 |
| ボリューム                | $Volume   | 3          | ボリュームに関する情報、ボリュームラベル、ボリュームバージョンなどが含まれています。                                                                                                                                       |
| 属性定義 | $AttrDef  | 4          | 属性名、番号、説明のテーブル。                                                                                                                                                                        |
| ルートファイル名インデックス  | $         | 5          | ルートフォルダ。                                                                                                                                                                                                              |
| クラスタビットマップ        | $Bitmap   | 6          | 使用中のクラスタを示すボリュームの表現。                                                                                                                                                             |
| ブートセクタ           | $Boot     | 7          | ボリュームをマウントするために使用されるBPBと、ボリュームがブート可能な場合に使用される追加のブートストラップローダーコードが含まれています。                                                                                                                |
| バッドクラスタファイル      | $BadClus  | 8          | ボリュームの悪いクラスタが含まれています。                                                                                                                                                                                         |
| セキュリティファイル         | $Secure   | 9          | ボリューム内のすべてのファイルに固有のセキュリティ記述子が含まれています。                                                                                                                                                           |
| 大文字変換テーブル          | $Upcase   | 10         | 小文字の文字を一致するUnicode大文字に変換します。                                                                                                                                                       |
| NTFS拡張ファイル   | $Extend   | 11         | クォータ、再解釈ポイントデータ、オブジェクト識別子などのさまざまなオプションの拡張機能に使用されます。                                                                                                                              |
|                       |           | 12-15      | 将来の使用のために予約されています。                                                                                                                                                                                                      |
| クォータ管理ファイル | $Quota    | 24         | ボリュームスペースに割り当てられたユーザー割り当てクォータ制限が含まれています。                                                                                                                                                                      |
| オブジェクトIDファイル        | $ObjId    | 25         | ファイルオブジェクトIDが含まれています。                                                                                                                                                                                                     |
| 再解釈ポイントファイル    | $Reparse  | 26         | このファイルには、再解釈ポイントデータを含むボリューム上のファイルとフォルダに関する情報が含まれています。                                                                                                                            |

### MFTの各エントリは次のようになります：

![](<../../../.gitbook/assets/image (499).png>)

各エントリが「FILE」で始まることに注目してください。各エントリは1024ビットを占有します。したがって、MFTエントリの開始から1024ビット後に次のエントリが見つかります。

[**Active Disk Editor**](https://www.disk-editor.org/index.html)を使用すると、MFT内のファイルのエントリを簡単に検査できます。ファイルを右クリックして、「Inspect File Record」をクリックします。

![](<../../../.gitbook/assets/image (500).png>)

![](<../../../.gitbook/assets/image (501).png>)

**「In use」**フラグをチェックすることで、ファイルが削除されたかどうかを簡単に知ることができます（**0x0の値は削除されたことを意味します**）。

![](<../../../.gitbook/assets/image (510).png>)

FTKImagerを使用して削除されたファイルを回復することも可能です：

![](<../../../.gitbook/assets/image (502).png>)

### MFT属性

各MFTエントリには、次の画像に示すように複数の属性があります：

![](<../../../.gitbook/assets/image (506).png>)

各属性は、次のタイプによって識別されるエントリ情報を示します：

| タイプ識別子 | 名前                     | 説明                                                                                                       |
| --------------- | ------------------------ | ----------------------------------------------------------------------------------------------------------------- |
| 16              | $STANDARD\_INFORMATION   | フラグ、最終アクセス、書き込み、作成時刻、所有者、セキュリティIDなどの一般情報。 |
| 32              | $ATTRIBUTE\_LIST         | ファイルの他の属性が見つかるリスト。                                                              |
| 48              | $FILE\_NAME              | ファイル名（Unicode）、最終アクセス、書き込み、作成時刻。                                         |
| 64              | $VOLUME\_VERSION         | ボリューム情報。バージョン1.2（Windows NT）のみ存在します。                                                      |
| 64              | $OBJECT\_ID              | ファイルまたはディレクトリの16バイトの一意の識別子。バージョン3.0以降（Windows 2000以降）のみ存在します。    |
| 80              | $SECURITY\_ DESCRIPTOR   | ファイルのアクセス制御とセキュリティプロパティ。                                                           |
| 96              | $VOLUME\_NAME            | ボリューム名。                                                                                                      |
| 112             | $VOLUME\_ INFORMATION    | ファイルシステムバージョンおよびその他のフラグ。                                                                              |
| 128             | $DATA                    | ファイルの内容。                                                                                                    |
| 144             | $INDEX\_ROOT             | インデックスツリーのルートノード。                                                                                       |
| 160             | $INDEX\_ALLOCATION       | $INDEX\_ROOT属性にルートされたインデックスツリーのノード。                                                          |
| 176             | $BITMAP                  | $MFTファイルとインデックスのためのビットマップ。                                                                       |
| 192             | $SYMBOLIC\_LINK          | ソフトリンク情報。バージョン1.2（Windows NT）のみ存在します。                                                   |
| 192             | $REPARSE\_POINT          | 再解釈ポイントに関する
