# Analyse de Malware

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## CheatSheets de Forensique

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Services en Ligne

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Outils Antivirus et de D√©tection Hors Ligne

### Yara

#### Installer
```bash
sudo apt-get install -y yara
```
#### Pr√©parer les r√®gles

Utilisez ce script pour t√©l√©charger et fusionner toutes les r√®gles yara de malware depuis github : [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Cr√©ez le r√©pertoire _**rules**_ et ex√©cutez-le. Cela cr√©era un fichier appel√© _**malware\_rules.yar**_ qui contient toutes les r√®gles yara pour les malwares.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Analyse
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen : V√©rifiez la pr√©sence de malware et cr√©ez des r√®gles

Vous pouvez utiliser l'outil [**YaraGen**](https://github.com/Neo23x0/yarGen) pour g√©n√©rer des r√®gles yara √† partir d'un binaire. Consultez ces tutoriels : [**Partie 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Partie 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Partie 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Installer
```
sudo apt-get install -y clamav
```
#### Analyse
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** d√©tecte des **capabilit√©s** potentiellement malveillantes dans les ex√©cutables : PE, ELF, .NET. Il trouvera donc des √©l√©ments tels que les tactiques Att\&ck, ou des capacit√©s suspectes telles que :

* v√©rifier l'erreur OutputDebugString
* s'ex√©cuter en tant que service
* cr√©er un processus

Obtenez-le dans le [**repo Github**](https://github.com/mandiant/capa).

### IOCs

IOC signifie Indicateur de Compromission. Un IOC est un ensemble de **conditions qui identifient** un logiciel potentiellement ind√©sirable ou un **malware** confirm√©. Les Blue Teams utilisent ce type de d√©finition pour **rechercher ce type de fichiers malveillants** dans leurs **syst√®mes** et **r√©seaux**.\
Partager ces d√©finitions est tr√®s utile car lorsque le malware est identifi√© sur un ordinateur et qu'un IOC pour ce malware est cr√©√©, d'autres Blue Teams peuvent l'utiliser pour identifier le malware plus rapidement.

Un outil pour cr√©er ou modifier des IOCs est [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Vous pouvez utiliser des outils tels que [**Redline**](https://www.fireeye.com/services/freeware/redline.html) pour **rechercher des IOCs d√©finis dans un appareil**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) est un scanner pour des Indicateurs de Compromission Simples.\
La d√©tection est bas√©e sur quatre m√©thodes de d√©tection :
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) est un scanner de malware pour Linux publi√© sous la licence GNU GPLv2, con√ßu autour des menaces rencontr√©es dans des environnements d'h√©bergement partag√©. Il utilise des donn√©es de menace provenant de syst√®mes de d√©tection d'intrusion en bordure de r√©seau pour extraire les malwares qui sont activement utilis√©s dans des attaques et g√©n√®re des signatures pour la d√©tection. De plus, les donn√©es de menace proviennent √©galement des soumissions des utilisateurs avec la fonctionnalit√© de v√©rification LMD et des ressources de la communaut√© des malwares.

### rkhunter

Des outils comme [**rkhunter**](http://rkhunter.sourceforge.net) peuvent √™tre utilis√©s pour v√©rifier le syst√®me de fichiers √† la recherche de **rootkits** et de malwares.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) est un outil qui essaiera de trouver des cha√Ænes obfusqu√©es √† l'int√©rieur des ex√©cutables en utilisant diff√©rentes techniques.

### PEpper

[PEpper ](https://github.com/Th3Hurrican3/PEpper) v√©rifie certaines informations de base √† l'int√©rieur de l'ex√©cutable (donn√©es binaires, entropie, URLs et IPs, certaines r√®gles yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) est un outil qui permet d'obtenir des informations sur les ex√©cutables Windows tels que les imports, les exports, les en-t√™tes, mais v√©rifiera √©galement virus total et trouvera des techniques Att\&ck potentielles.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) est un outil pour d√©tecter si un fichier est **chiffr√©** et √©galement trouver des **packers**.

### NeoPI

[**NeoPI** ](https://github.com/CiscoCXSecurity/NeoPI) est un script Python qui utilise une vari√©t√© de **m√©thodes statistiques** pour d√©tecter du contenu **obfusqu√©** et **chiffr√©** dans des fichiers texte/script. L'objectif de NeoPI est d'aider √† la **d√©tection de code de shell web cach√©**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) fait de son mieux pour d√©tecter du **code obfusqu√©**/**suspect** ainsi que des fichiers utilisant des fonctions **PHP** souvent utilis√©es dans des **malwares**/webshells.

### Apple Binary Signatures

Lors de la v√©rification d'un **√©chantillon de malware**, vous devez toujours **v√©rifier la signature** du binaire car le **d√©veloppeur** qui l'a sign√© peut d√©j√† √™tre **li√©** √† des **malwares.**
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Techniques de D√©tection

### Empilement de Fichiers

Si vous savez qu'un dossier contenant les **fichiers** d'un serveur web a √©t√© **derni√®rement mis √† jour √† une certaine date**. **V√©rifiez** la **date** √† laquelle tous les **fichiers** du **serveur web ont √©t√© cr√©√©s et modifi√©s** et si une date est **suspecte**, v√©rifiez ce fichier.

### Lignes de Base

Si les fichiers d'un dossier **n'auraient pas d√ª √™tre modifi√©s**, vous pouvez calculer le **hash** des **fichiers originaux** du dossier et **les comparer** avec les **actuels**. Tout ce qui a √©t√© modifi√© sera **suspect**.

### Analyse Statistique

Lorsque l'information est enregistr√©e dans des journaux, vous pouvez **v√©rifier des statistiques comme combien de fois chaque fichier d'un serveur web a √©t√© acc√©d√©, car un web shell pourrait √™tre l'un des plus**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
