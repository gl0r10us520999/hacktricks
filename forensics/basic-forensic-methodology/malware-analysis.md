# An√°lisis de Malware

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

## Hojas de Trucos de Forense

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Servicios en L√≠nea

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Herramientas de Antivirus y Detecci√≥n Offline

### Yara

#### Instalar
```bash
sudo apt-get install -y yara
```
#### Prepare reglas

Use este script para descargar y fusionar todas las reglas de malware yara de github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Cree el directorio _**rules**_ y ejec√∫telo. Esto crear√° un archivo llamado _**malware\_rules.yar**_ que contiene todas las reglas yara para malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Escanear
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Verificar malware y crear reglas

Puedes usar la herramienta [**YaraGen**](https://github.com/Neo23x0/yarGen) para generar reglas yara a partir de un binario. Consulta estos tutoriales: [**Parte 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Parte 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Parte 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalar
```
sudo apt-get install -y clamav
```
#### Escanear
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detecta capacidades **potencialmente maliciosas** en ejecutables: PE, ELF, .NET. As√≠ que encontrar√° cosas como t√°cticas de Att\&ck, o capacidades sospechosas como:

* verificar el error de OutputDebugString
* ejecutarse como un servicio
* crear proceso

Cons√≠guelo en el [**repositorio de Github**](https://github.com/mandiant/capa).

### IOCs

IOC significa Indicador de Compromiso. Un IOC es un conjunto de **condiciones que identifican** alg√∫n software potencialmente no deseado o **malware** confirmado. Los Blue Teams utilizan este tipo de definici√≥n para **buscar este tipo de archivos maliciosos** en sus **sistemas** y **redes**.\
Compartir estas definiciones es muy √∫til, ya que cuando se identifica malware en una computadora y se crea un IOC para ese malware, otros Blue Teams pueden usarlo para identificar el malware m√°s r√°pido.

Una herramienta para crear o modificar IOCs es [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Puedes usar herramientas como [**Redline**](https://www.fireeye.com/services/freeware/redline.html) para **buscar IOCs definidos en un dispositivo**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) es un esc√°ner para Indicadores Simples de Compromiso.\
La detecci√≥n se basa en cuatro m√©todos de detecci√≥n:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) es un esc√°ner de malware para Linux lanzado bajo la licencia GNU GPLv2, que est√° dise√±ado en torno a las amenazas que enfrentan los entornos de alojamiento compartido. Utiliza datos de amenazas de sistemas de detecci√≥n de intrusiones en el borde de la red para extraer malware que se est√° utilizando activamente en ataques y genera firmas para la detecci√≥n. Adem√°s, los datos de amenazas tambi√©n se derivan de las presentaciones de los usuarios con la funci√≥n de verificaci√≥n de LMD y recursos de la comunidad de malware.

### rkhunter

Herramientas como [**rkhunter**](http://rkhunter.sourceforge.net) se pueden utilizar para verificar el sistema de archivos en busca de posibles **rootkits** y malware.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) es una herramienta que intentar√° encontrar cadenas ofuscadas dentro de ejecutables utilizando diferentes t√©cnicas.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) verifica algunas cosas b√°sicas dentro del ejecutable (datos binarios, entrop√≠a, URLs e IPs, algunas reglas yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) es una herramienta que permite obtener informaci√≥n de ejecutables de Windows como importaciones, exportaciones, encabezados, pero tambi√©n verificar√° virus total y encontrar√° t√©cnicas potenciales de Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) es una herramienta para detectar si un archivo est√° **encriptado** y tambi√©n encontrar **empaquetadores**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) es un script de Python que utiliza una variedad de **m√©todos estad√≠sticos** para detectar contenido **ofuscado** y **encriptado** dentro de archivos de texto/script. El prop√≥sito de NeoPI es ayudar en la **detecci√≥n de c√≥digo de shell web oculto**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) hace todo lo posible para detectar **c√≥digo ofuscado**/**sospechoso** as√≠ como archivos que utilizan funciones de **PHP** a menudo usadas en **malwares**/webshells.

### Apple Binary Signatures

Al revisar alguna **muestra de malware** siempre debes **verificar la firma** del binario ya que el **desarrollador** que la firm√≥ puede estar ya **relacionado** con **malware.**
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## T√©cnicas de Detecci√≥n

### Apilamiento de Archivos

Si sabes que alguna carpeta que contiene los **archivos** de un servidor web fue **actualizada por √∫ltima vez en alguna fecha**. **Verifica** la **fecha** en que se **crearon y modificaron** todos los **archivos** en el **servidor web** y si alguna fecha es **sospechosa**, revisa ese archivo.

### L√≠neas Base

Si los archivos de una carpeta **no deber√≠an haber sido modificados**, puedes calcular el **hash** de los **archivos originales** de la carpeta y **compararlos** con los **actuales**. Cualquier cosa modificada ser√° **sospechosa**.

### An√°lisis Estad√≠stico

Cuando la informaci√≥n se guarda en registros, puedes **verificar estad√≠sticas como cu√°ntas veces se accedi√≥ a cada archivo de un servidor web, ya que un web shell podr√≠a ser uno de los m√°s**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
