# Malware Analysis

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Forensics CheatSheets

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Online Services

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Offline Antivirus and Detection Tools

### Yara

#### Install
```bash
sudo apt-get install -y yara
```
#### Pripremite pravila

Use this script to download and merge all the yara malware rules from github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Create the _**rules**_ directory and execute it. This will create a file called _**malware\_rules.yar**_ which contains all the yara rules for malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Skeniranje
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Proverite malware i kreirajte pravila

Mo≈æete koristiti alat [**YaraGen**](https://github.com/Neo23x0/yarGen) za generisanje yara pravila iz binarnog fajla. Pogledajte ove tutorijale: [**Deo 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Deo 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Deo 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instaliraj
```
sudo apt-get install -y clamav
```
#### Skeniranje
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detektuje potencijalno zlonamerne **moguƒánosti** u izvr≈°nim datotekama: PE, ELF, .NET. Tako ƒáe pronaƒái stvari kao ≈°to su Att\&ck taktike, ili sumnjive moguƒánosti kao ≈°to su:

* provera za OutputDebugString gre≈°ku
* pokretanje kao servis
* kreiranje procesa

Preuzmite ga u [**Github repozitorijumu**](https://github.com/mandiant/capa).

### IOCs

IOC znaƒçi Indikator Kompromitacije. IOC je skup **uslova koji identifikuju** neki potencijalno ne≈æeljen softver ili potvrƒëeni **malver**. Plave ekipe koriste ovu vrstu definicije da **tra≈æe ovakve zlonamerne datoteke** u svojim **sistemima** i **mre≈æama**.\
Deljenje ovih definicija je veoma korisno jer kada se malver identifikuje na raƒçunaru i kreira se IOC za taj malver, druge Plave ekipe mogu to koristiti da br≈æe identifikuju malver.

Alat za kreiranje ili modifikovanje IOCs je [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Mo≈æete koristiti alate kao ≈°to su [**Redline**](https://www.fireeye.com/services/freeware/redline.html) da **tra≈æite definisane IOCs na ureƒëaju**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) je skener za Simple Indicators of Compromise.\
Detekcija se zasniva na ƒçetiri metode detekcije:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) —ò–µ —Å–∫–µ–Ω–µ—Ä –∑–∞ –º–∞–ª–≤–µ—Ä –∑–∞ Linux –∫–æ—ò–∏ —ò–µ –æ–±—ò–∞–≤—ô–µ–Ω –ø–æ–¥ GNU GPLv2 –ª–∏—Ü–µ–Ω—Ü–æ–º, –∞ –¥–∏–∑–∞—ò–Ω–∏—Ä–∞–Ω —ò–µ –æ–∫–æ –ø—Ä–µ—Ç—ö–∏ —Å–∞ –∫–æ—ò–∏–º–∞ —Å–µ —Å—É–æ—á–∞–≤–∞—ò—É —É –¥–µ–ª—ò–µ–Ω–∏–º —Ö–æ—Å—Ç–æ–≤–∞–Ω–∏–º –æ–∫—Ä—É–∂–µ—ö–∏–º–∞. –ö–æ—Ä–∏—Å—Ç–∏ –ø–æ–¥–∞—Ç–∫–µ –æ –ø—Ä–µ—Ç—ö–∞–º–∞ –∏–∑ —Å–∏—Å—Ç–µ–º–∞ –∑–∞ –¥–µ—Ç–µ–∫—Ü–∏—ò—É —É–ø–∞–¥–∞ –Ω–∞ –º—Ä–µ–∂–Ω–æ–º –∏–≤–∏—Ü—É –¥–∞ –±–∏ –∏–∑–≤—É–∫–∞–æ –º–∞–ª–≤–µ—Ä –∫–æ—ò–∏ —Å–µ –∞–∫—Ç–∏–≤–Ω–æ –∫–æ—Ä–∏—Å—Ç–∏ —É –Ω–∞–ø–∞–¥–∏–º–∞ –∏ –≥–µ–Ω–µ—Ä–∏—à–µ –ø–æ—Ç–ø–∏—Å–µ –∑–∞ –¥–µ—Ç–µ–∫—Ü–∏—ò—É. –ü–æ—Ä–µ–¥ —Ç–æ–≥–∞, –ø–æ–¥–∞—Ü–∏ –æ –ø—Ä–µ—Ç—ö–∞–º–∞ —Å–µ —Ç–∞–∫–æ—í–µ –¥–æ–±–∏—ò–∞—ò—É –æ–¥ –∫–æ—Ä–∏—Å–Ω–∏—á–∫–∏—Ö –ø–æ–¥–Ω–µ—Å–∞–∫–∞ —Å–∞ LMD —Ñ—É–Ω–∫—Ü–∏—ò–æ–º –ø—Ä–æ–≤–µ—Ä–µ –∏ —Ä–µ—Å—É—Ä—Å–∞ –∑–∞ –º–∞–ª–≤–µ—Ä –∑–∞—ò–µ–¥–Ω–∏—Ü—É.

### rkhunter

–ê–ª–∞—Ç–∫–µ –∫–∞–æ —à—Ç–æ —Å—É [**rkhunter**](http://rkhunter.sourceforge.net) –º–æ–≥—É —Å–µ –∫–æ—Ä–∏—Å—Ç–∏—Ç–∏ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∞–≤–∞—ö–µ –¥–∞—Ç–æ—Ç–µ—á–Ω–æ–≥ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –º–æ–≥—É—õ–µ **rootkit**-–æ–≤–µ –∏ –º–∞–ª–≤–µ—Ä.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) je alat koji poku≈°ava da pronaƒëe obfuskirane stringove unutar izvr≈°nih datoteka koristeƒái razliƒçite tehnike.

### PEpper

[PEpper ](https://github.com/Th3Hurrican3/PEpper)proverava neke osnovne stvari unutar izvr≈°ne datoteke (binarni podaci, entropija, URL-ovi i IP adrese, neka yara pravila).

### PEstudio

[PEstudio](https://www.winitor.com/download) je alat koji omoguƒáava dobijanje informacija o Windows izvr≈°nim datotekama kao ≈°to su uvozi, izvozi, zaglavlja, ali takoƒëe proverava virus total i pronalazi potencijalne Att\&ck tehnike.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) je alat za detekciju da li je datoteka **kriptovana** i takoƒëe pronalazi **pakere**.

### NeoPI

[**NeoPI** ](https://github.com/CiscoCXSecurity/NeoPI)je Python skripta koja koristi razne **statistiƒçke metode** za detekciju **obfuskovanog** i **kriptovanog** sadr≈æaja unutar tekstualnih/skript datoteka. Namena NeoPI-a je da pomogne u **detekciji skrivenog web shell koda**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) daje sve od sebe da detektuje **obfuskovani**/**sumnjivi kod** kao i datoteke koje koriste **PHP** funkcije ƒçesto kori≈°ƒáene u **malverima**/webshell-ima.

### Apple Binary Signatures

Kada proveravate neki **uzorak malvera**, uvek treba da **proverite potpis** binarne datoteke jer **razvijaƒç** koji je potpisao mo≈æe veƒá biti **povezan** sa **malverom.**
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Tehnike Detekcije

### Stacking Fajlova

Ako znate da je neka fascikla koja sadr≈æi **fajlove** web servera **poslednji put a≈æurirana na neki datum**. **Proverite** **datum** kada su svi **fajlovi** na **web serveru kreirani i modifikovani** i ako je neki datum **sumnjiv**, proverite taj fajl.

### Osnovne Linije

Ako **fajlovi** u fascikli **ne bi trebali biti modifikovani**, mo≈æete izraƒçunati **hash** **originalnih fajlova** iz fascikle i **uporediti** ih sa **trenutnim**. Sve ≈°to je modifikovano ƒáe biti **sumnjivo**.

### Statistiƒçka Analiza

Kada su informacije saƒçuvane u logovima, mo≈æete **proveriti statistiku kao ≈°to je koliko puta je svaki fajl web servera bio pristupljen, jer web shell mo≈æe biti jedan od naj**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
