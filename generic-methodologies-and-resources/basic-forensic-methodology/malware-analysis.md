# Analiza zoliwego oprogramowania

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}

## Arkusze oszustw w dziedzinie forensyki

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Usugi online

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Offline narzdzia antywirusowe i detekcyjne

### Yara

#### Instalacja
```bash
sudo apt-get install -y yara
```
#### Przygotuj zasady

U偶yj tego skryptu, aby pobra i poczy wszystkie zasady yara dotyczce zoliwego oprogramowania z github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Utw贸rz katalog _**rules**_ i uruchom go. To stworzy plik o nazwie _**malware\_rules.yar**_, kt贸ry zawiera wszystkie zasady yara dotyczce zoliwego oprogramowania.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Skanuj
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Sprawd藕 zoliwe oprogramowanie i utw贸rz reguy

Mo偶esz u偶y narzdzia [**YaraGen**](https://github.com/Neo23x0/yarGen) do generowania regu yara z pliku binarnego. Sprawd藕 te samouczki: [**Cz 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Cz 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Cz 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalacja
```
sudo apt-get install -y clamav
```
#### Skanuj
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** wykrywa potencjalnie zoliwe **zdolnoci** w plikach wykonywalnych: PE, ELF, .NET. Zatem znajdzie takie rzeczy jak taktyki Att\&ck lub podejrzane zdolnoci, takie jak:

* sprawdzenie bdu OutputDebugString
* uruchomienie jako usuga
* utworzenie procesu

Pobierz to w [**repozytorium Github**](https://github.com/mandiant/capa).

### IOCs

IOC oznacza Wska藕nik Kompromitacji. IOC to zestaw **warunk贸w, kt贸re identyfikuj** potencjalnie niechciane oprogramowanie lub potwierdzone **zoliwe oprogramowanie**. Zespoy Blue u偶ywaj tego rodzaju definicji do **wyszukiwania tego rodzaju zoliwych plik贸w** w swoich **systemach** i **sieciach**.\
Dzielenie si tymi definicjami jest bardzo przydatne, poniewa偶 gdy zoliwe oprogramowanie zostanie zidentyfikowane na komputerze i utworzone zostanie IOC dla tego zoliwego oprogramowania, inne zespoy Blue mog go u偶y do szybszej identyfikacji zoliwego oprogramowania.

Narzdziem do tworzenia lub modyfikowania IOC jest [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Mo偶esz u偶y narzdzi takich jak [**Redline**](https://www.fireeye.com/services/freeware/redline.html), aby **wyszukiwa zdefiniowane IOC w urzdzeniu**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) to skaner dla prostych wska藕nik贸w kompromitacji.\
Wykrywanie opiera si na czterech metodach wykrywania:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) to skaner zoliwego oprogramowania dla systemu Linux wydany na licencji GNU GPLv2, zaprojektowany z myl o zagro偶eniach wystpujcych w rodowiskach wsp贸dzielonych. Wykorzystuje dane o zagro偶eniach z system贸w wykrywania intruz贸w na krawdzi sieci, aby wyodrbni zoliwe oprogramowanie, kt贸re jest aktywnie wykorzystywane w atakach, i generuje sygnatury do wykrywania. Dodatkowo dane o zagro偶eniach pochodz r贸wnie偶 z zgosze u偶ytkownik贸w z funkcji LMD checkout oraz zasob贸w spoecznoci zoliwego oprogramowania.

### rkhunter

Narzdzia takie jak [**rkhunter**](http://rkhunter.sourceforge.net) mog by u偶ywane do sprawdzania systemu plik贸w pod ktem mo偶liwych **rootkit贸w** i zoliwego oprogramowania.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) to narzdzie, kt贸re spr贸buje znale藕 zafaszowane cigi w plikach wykonywalnych, u偶ywajc r贸偶nych technik.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) sprawdza podstawowe rzeczy w pliku wykonywalnym (dane binarne, entropi, adresy URL i IP, niekt贸re reguy yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) to narzdzie, kt贸re pozwala uzyska informacje o plikach wykonywalnych Windows, takie jak importy, eksporty, nag贸wki, ale tak偶e sprawdzi virus total i znajdzie potencjalne techniki Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) to narzdzie do wykrywania, czy plik jest **szyfrowany** oraz do znajdowania **packer贸w**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) to skrypt w Pythonie, kt贸ry wykorzystuje r贸偶norodne **metody statystyczne** do wykrywania **zafaszowanej** i **szyfrowanej** zawartoci w plikach tekstowych/skryptowych. Celem NeoPI jest pomoc w **wykrywaniu ukrytego kodu web shell**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) robi wszystko, co w jego mocy, aby wykry **zafaszowany**/**podejrzany kod**, a tak偶e pliki u偶ywajce funkcji **PHP** czsto stosowanych w **malware**/webshellach.

### Apple Binary Signatures

Podczas sprawdzania niekt贸rych **pr贸bek malware** zawsze powiniene **sprawdzi podpis** pliku binarnego, poniewa偶 **deweloper**, kt贸ry go podpisa, mo偶e by ju偶 **powizany** z **malware.**
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the apps contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Techniki wykrywania

### Stacking plik贸w

Jeli wiesz, 偶e jaki folder zawierajcy **pliki** serwera WWW by **ostatnio aktualizowany w jakiej dacie**. **Sprawd藕** **dat** wszystkich **plik贸w** w **serwerze WWW**, kt贸re zostay utworzone i zmodyfikowane, a jeli jakakolwiek data jest **podejrzana**, sprawd藕 ten plik.

### Bazowe wartoci

Jeli pliki w folderze **nie powinny byy by modyfikowane**, mo偶esz obliczy **hash** **oryginalnych plik贸w** folderu i **por贸wna** je z **aktualnymi**. Wszystko, co zostao zmodyfikowane, bdzie **podejrzane**.

### Analiza statystyczna

Gdy informacje s zapisywane w logach, mo偶esz **sprawdzi statystyki, takie jak ile razy ka偶dy plik serwera WWW by otwierany, poniewa偶 web shell mo偶e by jednym z najczstszych**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
