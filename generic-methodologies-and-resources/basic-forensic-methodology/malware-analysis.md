# An√°lisis de Malware

{% hint style="success" %}
Aprende y practica Hacking en AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* ¬°Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Hojas de Trucos Forenses

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Servicios en L√≠nea

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Herramientas de Antivirus y Detecci√≥n sin Conexi√≥n

### Yara

#### Instalaci√≥n
```bash
sudo apt-get install -y yara
```
#### Preparar reglas

Utiliza este script para descargar y fusionar todas las reglas de malware yara desde github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Crea el directorio _**rules**_ y ejec√∫talo. Esto crear√° un archivo llamado _**malware\_rules.yar**_ que contiene todas las reglas yara para malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Escaneo
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Verificar malware y Crear reglas

Puedes utilizar la herramienta [**YaraGen**](https://github.com/Neo23x0/yarGen) para generar reglas yara a partir de un binario. Consulta estos tutoriales: [**Parte 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Parte 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Parte 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalaci√≥n
```
sudo apt-get install -y clamav
```
#### Escaneo
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detecta posibles **capacidades** maliciosas en ejecutables: PE, ELF, .NET. Por lo tanto, encontrar√° cosas como t√°cticas de Att\&ck o capacidades sospechosas como:

- verificar errores de OutputDebugString
- ejecutarse como un servicio
- crear procesos

Obt√©nlo en el [**repositorio de Github**](https://github.com/mandiant/capa).

### IOCs

IOC significa Indicador de Compromiso. Un IOC es un conjunto de **condiciones que identifican** alg√∫n software potencialmente no deseado o **malware** confirmado. Los equipos Azules utilizan este tipo de definici√≥n para **buscar este tipo de archivos maliciosos** en sus **sistemas** y **redes**.\
Compartir estas definiciones es muy √∫til, ya que cuando se identifica malware en un equipo y se crea un IOC para ese malware, otros equipos Azules pueden utilizarlo para identificar el malware m√°s r√°pidamente.

Una herramienta para crear o modificar IOCs es [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Puedes utilizar herramientas como [**Redline**](https://www.fireeye.com/services/freeware/redline.html) para **buscar IOCs definidos en un dispositivo**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) es un esc√°ner de Indicadores Simples de Compromiso.\
La detecci√≥n se basa en cuatro m√©todos de detecci√≥n:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### An√°lisis de Malware en Linux

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) es un esc√°ner de malware para Linux lanzado bajo la licencia GNU GPLv2, dise√±ado para hacer frente a las amenazas en entornos de alojamiento compartido. Utiliza datos de amenazas de sistemas de detecci√≥n de intrusiones en el borde de la red para extraer malware que se est√° utilizando activamente en ataques y genera firmas para su detecci√≥n. Adem√°s, los datos de amenazas tambi√©n se derivan de las contribuciones de usuarios con la funci√≥n de verificaci√≥n de LMD y los recursos de la comunidad de malware.

### rkhunter

Herramientas como [**rkhunter**](http://rkhunter.sourceforge.net) se pueden utilizar para verificar el sistema de archivos en busca de posibles **rootkits** y malware.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) es una herramienta que intentar√° encontrar cadenas ofuscadas dentro de ejecutables utilizando diferentes t√©cnicas.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) verifica algunas cosas b√°sicas dentro del ejecutable (datos binarios, entrop√≠a, URLs e IPs, algunas reglas yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) es una herramienta que permite obtener informaci√≥n de ejecutables de Windows como importaciones, exportaciones, encabezados, pero tambi√©n verificar√° VirusTotal y encontrar√° posibles t√©cnicas de Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) es una herramienta para detectar si un archivo est√° **encriptado** y tambi√©n encontrar **empaquetadores**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) es un script de Python que utiliza una variedad de **m√©todos estad√≠sticos** para detectar contenido **ofuscado** y **encriptado** dentro de archivos de texto o script. El prop√≥sito previsto de NeoPI es ayudar en la **detecci√≥n de c√≥digo de shell web oculto**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) hace todo lo posible para detectar c√≥digo **ofuscado**/**sospechoso** as√≠ como archivos que utilizan funciones de **PHP** a menudo utilizadas en **malwares**/webshells.

### Firmas Binarias de Apple

Al verificar alguna **muestra de malware** siempre se debe **verificar la firma** del binario, ya que el **desarrollador** que lo firm√≥ puede estar **relacionado** con **malware**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## T√©cnicas de Detecci√≥n

### Apilamiento de Archivos

Si sabes que alguna carpeta que contiene los **archivos** de un servidor web fue **actualizada por √∫ltima vez en alguna fecha**. **Verifica** la **fecha** en la que todos los **archivos** en el **servidor web fueron creados y modificados** y si alguna fecha es **sospechosa**, verifica ese archivo.

### L√≠neas de Base

Si los archivos de una carpeta **no deber√≠an haber sido modificados**, puedes calcular el **hash** de los **archivos originales** de la carpeta y **compararlos** con los **actuales**. Cualquier modificaci√≥n ser√° **sospechosa**.

### An√°lisis Estad√≠stico

Cuando la informaci√≥n se guarda en registros, puedes **verificar estad√≠sticas como cu√°ntas veces se accedi√≥ a cada archivo de un servidor web, ya que una shell web podr√≠a ser una de las m√°s**.
