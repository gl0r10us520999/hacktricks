# An√°lise de Malware

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Cheatsheets de Forense

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Servi√ßos Online

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Ferramentas de Antiv√≠rus e Detec√ß√£o Offline

### Yara

#### Instalar
```bash
sudo apt-get install -y yara
```
#### Prepare regras

Use este script para baixar e mesclar todas as regras yara de malware do github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Crie o diret√≥rio _**rules**_ e execute-o. Isso criar√° um arquivo chamado _**malware\_rules.yar**_ que cont√©m todas as regras yara para malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Escanear
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Verifique se h√° malware e crie regras

Voc√™ pode usar a ferramenta [**YaraGen**](https://github.com/Neo23x0/yarGen) para gerar regras yara a partir de um bin√°rio. Confira estes tutoriais: [**Parte 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Parte 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Parte 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Instalar
```
sudo apt-get install -y clamav
```
#### Escanear
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detecta **capacidades** potencialmente maliciosas em execut√°veis: PE, ELF, .NET. Portanto, encontrar√° coisas como t√°ticas do Att\&ck, ou capacidades suspeitas como:

* verificar erro de OutputDebugString
* executar como um servi√ßo
* criar processo

Obtenha no [**reposit√≥rio do Github**](https://github.com/mandiant/capa).

### IOCs

IOC significa Indicador de Compromisso. Um IOC √© um conjunto de **condi√ß√µes que identificam** algum software potencialmente indesejado ou **malware** confirmado. As Blue Teams usam esse tipo de defini√ß√£o para **procurar por esse tipo de arquivos maliciosos** em seus **sistemas** e **redes**.\
Compartilhar essas defini√ß√µes √© muito √∫til, pois quando o malware √© identificado em um computador e um IOC para esse malware √© criado, outras Blue Teams podem us√°-lo para identificar o malware mais rapidamente.

Uma ferramenta para criar ou modificar IOCs √© o [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Voc√™ pode usar ferramentas como [**Redline**](https://www.fireeye.com/services/freeware/redline.html) para **procurar por IOCs definidos em um dispositivo**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) √© um scanner para Indicadores Simples de Compromisso.\
A detec√ß√£o √© baseada em quatro m√©todos de detec√ß√£o:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) √© um scanner de malware para Linux lan√ßado sob a licen√ßa GNU GPLv2, que √© projetado em torno das amea√ßas enfrentadas em ambientes de hospedagem compartilhada. Ele usa dados de amea√ßas de sistemas de detec√ß√£o de intrus√µes na borda da rede para extrair malware que est√° sendo ativamente utilizado em ataques e gera assinaturas para detec√ß√£o. Al√©m disso, os dados de amea√ßas tamb√©m s√£o derivados de envios de usu√°rios com o recurso de checkout do LMD e recursos da comunidade de malware.

### rkhunter

Ferramentas como [**rkhunter**](http://rkhunter.sourceforge.net) podem ser usadas para verificar o sistema de arquivos em busca de poss√≠veis **rootkits** e malware.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) √© uma ferramenta que tentar√° encontrar strings ofuscadas dentro de execut√°veis usando diferentes t√©cnicas.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) verifica algumas informa√ß√µes b√°sicas dentro do execut√°vel (dados bin√°rios, entropia, URLs e IPs, algumas regras yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) √© uma ferramenta que permite obter informa√ß√µes de execut√°veis do Windows, como imports, exports, cabe√ßalhos, mas tamb√©m verificar√° o virus total e encontrar√° t√©cnicas potenciais do Att\&ck.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) √© uma ferramenta para detectar se um arquivo est√° **criptografado** e tamb√©m encontrar **empacotadores**.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) √© um script em Python que usa uma variedade de **m√©todos estat√≠sticos** para detectar conte√∫do **ofuscado** e **criptografado** dentro de arquivos de texto/script. O objetivo pretendido do NeoPI √© ajudar na **detec√ß√£o de c√≥digo de shell web oculto**.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) faz o seu melhor para detectar **c√≥digo ofuscado**/**suspeito**, bem como arquivos que usam fun√ß√µes **PHP** frequentemente utilizadas em **malwares**/webshells.

### Apple Binary Signatures

Ao verificar alguma **amostra de malware**, voc√™ deve sempre **verificar a assinatura** do bin√°rio, pois o **desenvolvedor** que o assinou pode j√° estar **relacionado** com **malware.**
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## T√©cnicas de Detec√ß√£o

### Empilhamento de Arquivos

Se voc√™ sabe que alguma pasta contendo os **arquivos** de um servidor web foi **atualizada pela √∫ltima vez em alguma data**. **Verifique** a **data** em que todos os **arquivos** no **servidor web foram criados e modificados** e se alguma data √© **suspeita**, verifique esse arquivo.

### Linhas de Base

Se os arquivos de uma pasta **n√£o deveriam ter sido modificados**, voc√™ pode calcular o **hash** dos **arquivos originais** da pasta e **compar√°-los** com os **atuais**. Qualquer coisa modificada ser√° **suspeita**.

### An√°lise Estat√≠stica

Quando as informa√ß√µes s√£o salvas em logs, voc√™ pode **verificar estat√≠sticas como quantas vezes cada arquivo de um servidor web foi acessado, pois um web shell pode ser um dos mais**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
