# Riassunto di Nmap (ESP)

{% hint style="success" %}
Impara e pratica l'Hacking su AWS: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Impara e pratica l'Hacking su GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Sostieni HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parametri

### IP da scansionare

* **`<ip>,<net/mask>`:** Indica gli ip direttamente
* **`-iL <ips_file>`:** lista_IPs
* **`-iR <numero>`**: Numero di Ips casuali, √® possibile escludere possibili Ips con `--exclude <Ips>` o `--excludefile <file>`.

### Scoperta dell'attrezzatura

Per impostazione predefinita, Nmap avvia una fase di scoperta composta da: `-PA80 -PS443 -PE -PP`

* **`-sL`**: Non invasivo, elenca i target facendo richieste **DNS** per risolvere i nomi. √à utile per sapere se ad esempio www.prueba.es/24 tutti gli Ips sono i nostri target.
* **`-Pn`**: **Nessun ping**. Questo √® utile se si sa che tutti sono attivi (altrimenti si potrebbe perdere molto tempo, ma questa opzione produce anche falsi negativi dicendo che non sono attivi), impedisce la fase di scoperta.
* **`-sn`** : **Nessuna scansione di porte**. Dopo aver completato la fase di ricognizione, non esegue la scansione delle porte. √à relativamente stealthy e consente una piccola scansione di rete. Con privilegi invia un ACK (-PA) a 80, un SYN(-PS) a 443 e una richiesta di eco e una richiesta di timestamp, senza privilegi completa sempre le connessioni. Se il target √® la rete, utilizza solo ARP(-PR). Se utilizzato con un'altra opzione, vengono scartati solo i pacchetti dell'altra opzione.
* **`-PR`**: **Ping ARP**. Viene utilizzato per impostazione predefinita quando si analizzano computer nella nostra rete, √® pi√π veloce dell'utilizzo di ping. Se non si desidera utilizzare i pacchetti ARP, utilizzare `--send-ip`.
* **`-PS <porte>`**: Invia pacchetti SYN a cui se risponde SYN/ACK √® aperto (a cui risponde con RST per non terminare la connessione), se risponde RST √® chiuso e se non risponde √® irraggiungibile. In caso di mancanza di privilegi, viene utilizzata automaticamente una connessione totale. Se non vengono specificate porte, le invia a 80.
* **`-PA <porte>`**: Come il precedente ma con ACK, combinando entrambi si ottengono risultati migliori.
* **`-PU <porte>`**: L'obiettivo √® opposto, vengono inviati a porte che si prevede siano chiuse. Alcuni firewall controllano solo le connessioni TCP. Se √® chiuso viene risposto con porta irraggiungibile, se viene risposto con un altro icmp o non viene risposto viene lasciato come destinazione irraggiungibile.
* **`-PE, -PP, -PM`** : PING ICMP: risposta echo, timestamp e addresmask. Vengono inviati per scoprire se il target √® attivo.
* **`-PY<porte>`**: Invia sonde SCTP INIT a 80 per impostazione predefinita, INIT-ACK(aperto) o ABORT(chiuso) o niente o ICMP irraggiungibile(inattivo) possono essere risposti.
* **`-PO <protocolli>`**: Viene indicato un protocollo negli header, per impostazione predefinita 1(ICMP), 2(IGMP) e 4(Encap IP). Per i protocolli ICMP, IGMP, TCP (6) e UDP (17) vengono inviati gli header del protocollo, per il resto viene inviato solo l'header IP. Lo scopo di ci√≤ √® che a causa della malformazione degli header, vengono risposti Protocol unreachable o risposte dello stesso protocollo per sapere se √® attivo.
* **`-n`**: Nessun DNS
* **`-R`**: DNS sempre

### Tecniche di scansione delle porte

* **`-sS`**: Non completa la connessione quindi non lascia traccia, molto buono se pu√≤ essere utilizzato (privilegi). √à quello utilizzato per impostazione predefinita.
* **`-sT`**: Completa la connessione, quindi lascia una traccia, ma pu√≤ essere utilizzato con sicurezza. Di default senza privilegi.
* **`-sU`**: Pi√π lento, per UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 e 68), (-sU53,161,162,67,68): aperto(risposta), chiuso(porta irraggiungibile), filtrato (un altro ICMP), aperto/filtrato (niente). In caso di aperto/filtrato, -sV invia numerose richieste per rilevare una delle versioni supportate da nmap e pu√≤ rilevare lo stato reale. Aumenta notevolmente il tempo.
* **`-sY`**: Il protocollo SCTP non riesce a stabilire la connessione, quindi non ci sono log, funziona come -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, possono penetrare alcuni firewall ed estrarre informazioni. Si basano sul fatto che le macchine conformi allo standard dovrebbero rispondere con RST a tutte le richieste che non hanno sollevato flag SYN, RST o ACK: aperto/filtrato(niente), chiuso(RST), filtrato (ICMP irraggiungibile). Non affidabile su Windows, CIsco, BSDI e OS/400. Su Unix s√¨.
* **`-sM`**: Scansione Maimon: Invia flag FIN e ACK, utilizzato per BSD, attualmente restituir√† tutto come chiuso.
* **`-sA, sW`**: ACK e Window, viene utilizzato per rilevare i firewall, per sapere se le porte sono filtrate o meno. Il -sW distingue tra aperto/chiuso poich√© quelli aperti rispondono con un valore di finestra diverso: aperto (RST con finestra diversa da 0), chiuso (finestra RST = 0), filtrato (ICMP irraggiungibile o niente). Non tutti i computer funzionano in questo modo, quindi se sono tutti chiusi, non funziona, se sono pochi aperti, funziona correttamente, e se sono molti aperti e pochi chiusi, funziona al contrario.
* **`-sI`:** Scansione inattiva. Nei casi in cui c'√® un firewall attivo ma sappiamo che non filtra verso un certo Ip (o quando vogliamo semplicemente l'anonimato) possiamo utilizzare lo scanner zombie (funziona per tutte le porte), per cercare possibili zombie possiamo utilizzare lo script ipidseq o l'exploit auxiliary/scanner/ip/ipidseq. Questo scanner si basa sul numero IPID dei pacchetti IP.
* **`--badsum`:** Invia il sommario sbagliato, i computer scarterebbero i pacchetti, ma i firewall potrebbero rispondere qualcosa, viene utilizzato per rilevare i firewall.
* **`-sZ`:** Scanner SCTP "strano", quando invia sonde con frammenti di cookie echo dovrebbero essere scartati se aperti o risposti con ABORT se chiusi. Pu√≤ passare attraverso i firewall che init non riesce a superare, il brutto √® che non distingue tra filtrato e aperto.
* **`-sO`:** Scansione del protocollo Ip. Invia intestazioni errate e vuote in cui a volte non √® nemmeno possibile distinguere il protocollo. Se arriva un protocollo ICMP irraggiungibile √® chiuso, se arriva una porta irraggiungibile √® aperto, se arriva un altro errore, filtrato, se non arriva nulla, aperto|filtrato.
* **`-b <server>`:** FTPhost--> Viene utilizzato per scansionare un host da un altro, ci√≤ viene fatto collegandosi all'ftp di un'altra macchina e chiedendo di inviare file alle porte che si desidera scansionare da un'altra macchina, in base alle risposte sapremo se sono aperte o no. \[\<user>:\<password>@]\<server>\[:\<port>] Quasi tutti i server ftp non ti permettono pi√π di farlo e quindi √® di scarsa utilit√† pratica.

### **Analisi centrale**

**-p:** Serve per specificare le porte da scansionare. Per selezionare le 65335: **-p-** o **-p all**. Nmap ha una classificazione interna in base alla sua popolarit√†. Di default utilizza le 1000 principali. Con **-F** (scansione veloce) analizza le prime 100. Con **--top-ports \<numero>** Analizza quel numero di porte principali (da 1 a 65335). Controlla le porte in ordine casuale, per evitare ci√≤ **-r**. √à anche possibile selezionare le porte: 20-30,80,443,1024- Quest'ultimo significa di controllare in avanti dal 1024. √à anche possibile raggruppare le porte per protocolli: U:53,T:21-25,80,139,S:9. √à anche possibile scegliere un intervallo all'interno delle porte popolari di nmap: -p \[-1024] controlla fino al 1024 incluso nei servizi nmap. **--port-ratio \<ratio>** Controlla le porte pi√π comuni rispetto a un rapporto che deve essere compreso tra 0 e 1

**-sV** Scansione della versione, √® possibile regolare l'intensit√† da 0 a 9, di default 7.

**--version-intensity \<numero>** Regola l'intensit√†, in modo che quanto pi√π bassa sar√†, lancer√† solo le sonde pi√π probabili, ma non tutte. Con questo possiamo accorciare notevolmente il tempo di scansione UDP

**-O** Rilevamento del sistema operativo

**--osscan-limit** Per scansionare correttamente un host √® necessario che ci sia almeno una porta aperta e una chiusa, se questa condizione non √® soddisfatta e abbiamo impostato questo, non tenta di fare previsioni sul sistema operativo (risparmia tempo)
**--osscan-guess** Quando la rilevazione dell'OS non √® perfetta, questo sforza ulteriormente

**Scripts**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

Per utilizzare quelli predefiniti, √® sufficiente usare -sC o --script=default

I tipi disponibili sono: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version e vuln

* **Auth:** esegue tutti i suoi _scripts_ disponibili per l'autenticazione
* **Default:** esegue gli _scripts_ di base predefiniti dello strumento
* **Discovery:** recupera informazioni sul _target_ o vittima
* **External:** _script_ per utilizzare risorse esterne
* **Intrusive:** utilizza _scripts_ considerati intrusivi per la vittima o il _target_
* **Malware:** controlla se ci sono connessioni aperte da codici dannosi o _backdoors_
* **Safe:** esegue _scripts_ non intrusivi
* **Vuln:** scopre le vulnerabilit√† pi√π conosciute
* **All:** esegue tutti i _scripts_ NSE disponibili

Per cercare _scripts_:

**nmap --script-help="http-\*" -> Quelli che iniziano con http-**

**nmap --script-help="not intrusive" -> Tutti tranne quelli**

**nmap --script-help="default or safe" -> Quelli che sono in uno o in altro o in entrambi**

**nmap --script-help="default and safe" --> Quelli che sono in entrambi**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> Fornisce informazioni sullo stato dello script

\--script-updatedb

**Per utilizzare uno script basta digitare: nmap --script Nome\_dello\_script obiettivo** --> Quando si specifica lo script, verr√† eseguito sia lo script che lo scanner, quindi √® possibile aggiungere **"safe=1"** per eseguire solo quelli sicuri.

**Controllo del tempo**

**Nmap pu√≤ modificare il tempo in secondi, minuti, ms:** --host-timeout arguments 900000ms, 900, 900s e 15m fanno la stessa cosa.

Nmap divide il numero totale di host da scansionare in gruppi e analizza quei gruppi a blocchi in modo che non passi al blocco successivo fino a quando tutti i blocchi non sono stati analizzati (e l'utente non riceve alcun aggiornamento fino a quando il blocco non √® stato analizzato). In questo modo, √® pi√π efficiente per nmap utilizzare gruppi pi√π grandi. Di default, in classe C usa 256.

Pu√≤ essere modificato con\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Regola le dimensioni dei gruppi di scansione parallela)

√à possibile controllare il numero di scanner paralleli, ma √® meglio evitarlo (nmap incorpora gi√† un controllo automatico in base allo stato della rete): **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

√à possibile modificare il timeout rtt, ma di solito non √® necessario: **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

√à possibile modificare il numero di tentativi: **--max-retries** _**\<numtries>**_

√à possibile modificare il timeout di un host: **--host-timeout** _**\<time>**_

√à possibile modificare il tempo tra ogni scansione per rallentare: **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

√à possibile modificare il numero di pacchetti al secondo: **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

Molti porti impiegano molto tempo a rispondere se sono filtrati o chiusi, se siamo interessati solo a quelli aperti, possiamo accelerare con: **--defeat-rst-ratelimit**

Per definire il livello di aggressivit√† di nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Scansiona solo 1 porta alla volta e attende 5 minuti prima della successiva

\-T1 e T2 --> Molto simili ma attendono rispettivamente 15 e 0,4 secondi tra ogni scansione

\-T3 --> Funzionamento predefinito, include in parallelo

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Bloccano le porte e analizzano i pacchetti.

**-f** Per frammentare i pacchetti, di default li frammenta in 8 byte dopo l'intestazione, per specificare quella dimensione usiamo ..mtu (con questo, non usare -f), l'offset deve essere multiplo di 8. **Version scan e script non supportano la frammentazione**

**-D decoy1,decoy2,ME** Nmap invia scansioni ma con altri indirizzi IP come origine, in questo modo ti nasconde. Se inserisci ME nell'elenco, nmap ti posizioner√† l√¨, √® meglio inserire 5 o 6 prima di te per mascherarti completamente. √à possibile generare IP casuali con RND:\<numero> per generare \<numero> di IP casuali. Non funzionano con il rilevamento delle versioni senza connessione TCP. Se sei all'interno di una rete, √® consigliabile utilizzare IP attivi, altrimenti sar√† molto facile capire che sei l'unico attivo.

Per utilizzare IP casuali: nmap-D RND: 10 Ip\_obiettivo

**-S IP** Quando Nmap non rileva il tuo indirizzo IP, devi fornirlo con questo. Serve anche per far pensare che ci sia un altro obiettivo che li sta scansionando.

**-e \<interfaccia>** Per scegliere l'interfaccia

Molti amministratori lasciano aperte le porte di ingresso affinch√© tutto funzioni correttamente e sia pi√π facile per loro che cercare un'altra soluzione. Queste possono essere le porte DNS o quelle FTP... per cercare questa vulnerabilit√† nmap include: **--source-port** _**\<portnumber>**_**;-g** _**\<portnumber>**_ _Sono equivalenti_

**--data** _**\<stringa esadecimale>**_ Per inviare testo esadecimale: --data 0xdeadbeef e --data \xCA\xFE\x09

**--data-string** _**\<stringa>**_ Per inviare un testo normale: --data-string "Scansione condotta da Security Ops, estensione 7192"

**--data-length** _**\<numero>**_ Nmap invia solo intestazioni, con questo facciamo in modo che aggiunga a queste un numero di byte in pi√π (che verranno generati casualmente)

Per configurare completamente il pacchetto IP utilizzare **--ip-options**

Se si desidera visualizzare le opzioni nei pacchetti inviati e ricevuti, specificare --packet-trace. Per ulteriori informazioni ed esempi sull'utilizzo delle opzioni IP con Nmap, vedere [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**\<valore>**_

**--randomize-hosts** Per rendere l'attacco meno ovvio

**--spoof-mac** _**\<indirizzo MAC, prefisso o nome del produttore>**_ Per cambiare il MAC esempi: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2 e Cisco
**--proxies** _**\<Elenco separato da virgole di URL proxy>**_ Per utilizzare i proxy, a volte un proxy non mantiene tante connessioni aperte come nmap desidera, quindi potrebbe essere necessario modificare la parallelit√†: --max-parallelism

**-sP** Per scoprire gli host nella rete in cui ci troviamo tramite ARP

Molti amministratori creano una regola nel firewall che consente il passaggio di tutti i pacchetti provenienti da una porta specifica (come la 20, 53 e 67), possiamo dire a nmap di inviare i nostri pacchetti da tali porte: **nmap --source-port 53 Ip**

**Output**

**-oN file** Output normale

**-oX file** Output XML

**-oS file** Output per script kiddies

**-oG file** Output grepable

**-oA file** Tutti tranne -oS

**-v level** verbosit√†

**-d level** debug

**--reason** Motivo dell'host e dello stato

**--stats-every time** Ogni tot tempo mostra lo stato

**--packet-trace** Per visualizzare i pacchetti inviati, √® possibile specificare filtri come: --version-trace o --script-trace

**--open** mostra gli host aperti, aperti|filtrati e non filtrati

**--resume file** Genera un riassunto

**Miscellanea**

**-6** Abilita ipv6

**-A** Equivale a -O -sV -sC --traceroute

**Run time**

Durante l'esecuzione di nmap √® possibile modificare le opzioni:

v / V Aumenta / diminuisce il livello di verbosit√†

d / D Aumenta / diminuisce il livello di debug

p / P Attiva / disattiva il tracciamento dei pacchetti

? Stampa un aiuto interattivo durante l'esecuzione

**Vulscan**

Script di nmap che controlla le versioni dei servizi ottenuti in un database offline (scaricato da fonti molto importanti) e restituisce le possibili vulnerabilit√†

I database utilizzati sono:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Per scaricarlo e installarlo nella cartella di Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap\_nse\_vulscan-2.0.tar.gz && tar -czvf nmap\_nse\_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Inoltre √® necessario scaricare i pacchetti dei database e aggiungerli a /usr/share/nmap/scripts/vulscan/

Utilizzo:

Per utilizzare tutti: sudo nmap -sV --script=vulscan HOST\_A\_ESCANEAR

Per utilizzare un database specifico: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST\_A\_ESCANEAR

## Accelerare la scansione dei servizi Nmap x16

Secondo [**questo post**](https://joshua.hu/nmap-speedup-service-scanning-16x) √® possibile accelerare l'analisi dei servizi nmap modificando tutti i valori di **`totalwaitms`** in **`/usr/share/nmap/nmap-service-probes`** a **300** e **`tcpwrappedms`** a **200**.

Inoltre, le sonde che non hanno un **`servicewaitms`** definito specificamente utilizzano un valore predefinito di **`5000`**. Pertanto, possiamo aggiungere valori a ciascuna delle sonde, oppure possiamo **compilare nmap** noi stessi e modificare il valore predefinito in [**service\_scan.h**](https://github.com/nmap/nmap/blob/master/service\_scan.h#L79).

Se non si desidera modificare affatto i valori di **`totalwaitms`** e **`tcpwrappedms`** nel file `/usr/share/nmap/nmap-service-probes`, √® possibile modificare il [codice di analisi](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358) in modo che questi valori nel file `nmap-service-probes` vengano completamente ignorati.

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Impara e pratica l'hacking su AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Impara e pratica l'hacking su GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
