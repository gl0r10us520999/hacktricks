# Nmap Summary (ESP)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Par√°metros

### IPs a escanear

* **`<ip>,<net/mask>`:** Indica las ips directamente
* **`-iL <ips_file>`:** list\_IPs
* **`-iR <number>`**: N√∫mero de Ips aleatorias, puedes excluir posibles Ips con `--exclude <Ips>` o `--excludefile <file>`.

### Descubrimiento de equipos

Por defecto, Nmap lanza una fase de descubrimiento que consiste en: `-PA80 -PS443 -PE -PP`

* **`-sL`**: No es invasivo, lista los objetivos haciendo **DNS** solicitudes para resolver nombres. Es √∫til para saber si, por ejemplo, www.prueba.es/24 todas las Ips son nuestros objetivos.
* **`-Pn`**: **Sin ping**. Esto es √∫til si sabes que todos est√°n activos (si no, podr√≠as perder mucho tiempo, pero esta opci√≥n tambi√©n produce falsos negativos diciendo que no est√°n activos), previene la fase de descubrimiento.
* **`-sn`** : **Sin escaneo de puertos**. Despu√©s de completar la fase de reconocimiento, no escanea puertos. Es relativamente sigiloso y permite un peque√±o escaneo de red. Con privilegios env√≠a un ACK (-PA) a 80, un SYN(-PS) a 443 y una solicitud de eco y una solicitud de marca de tiempo; sin privilegios siempre completa conexiones. Si el objetivo es la red, solo utiliza ARP(-PR). Si se usa con otra opci√≥n, solo se descartan los paquetes de la otra opci√≥n.
* **`-PR`**: **Ping ARP**. Se utiliza por defecto al analizar computadoras en nuestra red, es m√°s r√°pido que usar pings. Si no deseas usar paquetes ARP, usa `--send-ip`.
* **`-PS <ports>`**: Env√≠a paquetes SYN a los cuales, si responde SYN/ACK, est√° abierto (a lo que responde con RST para no finalizar la conexi√≥n); si responde RST, est√° cerrado y si no responde, es inalcanzable. En caso de no tener privilegios, se utiliza autom√°ticamente una conexi√≥n total. Si no se dan puertos, se lanza a 80.
* **`-PA <ports>`**: Como el anterior pero con ACK, combinando ambos da mejores resultados.
* **`-PU <ports>`**: El objetivo es el opuesto, se env√≠an a puertos que se espera que est√©n cerrados. Algunos firewalls solo verifican conexiones TCP. Si est√° cerrado, se responde con puerto inalcanzable; si se responde con otro icmp o no se responde, se deja como inalcanzable.
* **`-PE, -PP, -PM`** : ICMP PINGS: respuesta de eco, marca de tiempo y m√°scara de direcci√≥n. Se lanzan para averiguar si el objetivo est√° activo.
* **`-PY<ports>`**: Env√≠a sondas SCTP INIT a 80 por defecto; INIT-ACK(abierto) o ABORT(cerrado) o nada o ICMP inalcanzable(inactivo) pueden ser respondidos.
* **`-PO <protocols>`**: Se indica un protocolo en los encabezados, por defecto 1(ICMP), 2(IGMP) y 4(Encap IP). Para los protocolos ICMP, IGMP, TCP (6) y UDP (17) se env√≠an los encabezados de protocolo; para el resto, solo se env√≠a el encabezado IP. El prop√≥sito de esto es que, debido a la malformaci√≥n de los encabezados, se responda con protocolo inalcanzable o respuestas del mismo protocolo para saber si est√° activo.
* **`-n`**: Sin DNS
* **`-R`**: DNS siempre

### T√©cnicas de escaneo de puertos

* **`-sS`**: No completa la conexi√≥n, por lo que no deja rastro, muy bueno si se puede usar. (privilegios) Es el que se usa por defecto.
* **`-sT`**: Completa la conexi√≥n, por lo que deja un rastro, pero se puede usar con seguridad. Por defecto, sin privilegios.
* **`-sU`**: M√°s lento, para UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 y 68), (-sU53,161,162,67,68): abierto(respuesta), cerrado(puerto inalcanzable), filtrado (otro ICMP), abierto/filtrado (nada). En caso de abierto/filtrado, -sV env√≠a numerosas solicitudes para detectar cualquiera de las versiones que nmap soporta y puede detectar el verdadero estado. Aumenta mucho el tiempo.
* **`-sY`**: El protocolo SCTP no logra establecer la conexi√≥n, por lo que no hay registros, funciona como -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, pueden penetrar algunos firewalls y extraer informaci√≥n. Se basan en el hecho de que las m√°quinas que cumplen con el est√°ndar deber√≠an responder con RST a todas las solicitudes que no tengan SYN, RST o ACK. Respuestas: abierto/filtrado(nada), cerrado(RST), filtrado (ICMP inalcanzable). No confiable en Windows, Cisco, BSDI y OS/400. En unix s√≠.
* **`-sM`**: Escaneo Maimon: Env√≠a banderas FIN y ACK, utilizado para BSD, actualmente devolver√° todo como cerrado.
* **`-sA, sW`**: ACK y Window, se utiliza para detectar firewalls, para saber si los puertos est√°n filtrados o no. El -sW distingue entre abierto/cerrado ya que los abiertos responden con un valor de ventana diferente: abierto (RST con ventana diferente de 0), cerrado (RST ventana = 0), filtrado (ICMP inalcanzable o nada). No todas las computadoras funcionan de esta manera, as√≠ que si todo est√° cerrado, no est√° funcionando; si hay pocos abiertos, est√° funcionando bien, y si hay muchos abiertos y pocos cerrados, est√° funcionando al rev√©s.
* **`-sI`:** Escaneo Idle. Para los casos en los que hay un firewall activo pero sabemos que no filtra a una cierta Ip (o cuando simplemente queremos anonimato) podemos usar el esc√°ner zombie (funciona para todos los puertos); para buscar posibles zombies podemos usar el script ipidseq o el exploit auxiliary/scanner/ip/ipidseq. Este esc√°ner se basa en el n√∫mero IPID de los paquetes IP.
* **`--badsum`:** Env√≠a la suma incorrecta, las computadoras descartar√≠an los paquetes, pero los firewalls podr√≠an responder algo, se utiliza para detectar firewalls.
* **`-sZ`:** Esc√°ner SCTP "raro", al enviar sondas con fragmentos de eco de cookie, deber√≠an ser descartados si est√°n abiertos o respondidos con ABORT si est√°n cerrados. Puede pasar a trav√©s de firewalls que init no pasa, lo malo es que no distingue entre filtrado y abierto.
* **`-sO`:** Escaneo de protocolo IP. Env√≠a encabezados malos y vac√≠os en los que a veces ni siquiera se puede distinguir el protocolo. Si llega un protocolo ICMP inalcanzable, est√° cerrado; si llega un puerto inalcanzable, est√° abierto; si llega otro error, filtrado; si no llega nada, abierto|filtrado.
* **`-b <server>`:** FTPhost--> Se utiliza para escanear un host desde otro, esto se hace conectando el ftp de otra m√°quina y pidi√©ndole que env√≠e archivos a los puertos que deseas escanear desde otra m√°quina; seg√∫n las respuestas, sabremos si est√°n abiertos o no. \[\<user>:\<password>@]\<server>\[:\<port>] Casi todos los servidores ftps ya no permiten hacer esto y, por lo tanto, tiene poco uso pr√°ctico.

### **Centrar an√°lisis**

**-p:** Sirve para dar los puertos a escanear. Para seleccionar los 65335: **-p-** o **-p all**. Nmap tiene una clasificaci√≥n interna seg√∫n su popularidad. Por defecto usa los 1000 principales. Con **-F** (escaneo r√°pido) analiza los 100 principales. Con **--top-ports \<numero>** analiza ese n√∫mero de principales (de 1 hasta los 65335). Comprueba los puertos en orden aleatorio; para que eso no pase, usa **-r**. Tambi√©n podemos seleccionar puertos: 20-30,80,443,1024- Esto √∫ltimo significa que mire en adelante del 1024. Tambi√©n podemos agrupar los puertos por protocolos: U:53,T:21-25,80,139,S:9. Tambi√©n podemos escoger un rango dentro de los puertos populares de nmap: -p \[-1024] analiza hasta el 1024 de los incluidos en nmap-services. **--port-ratio \<ratio>** analiza los puertos m√°s comunes que un ratio que debe estar entre 0 y 1.

**-sV** Escaneado de versi√≥n, se puede regular la intensidad de 0 a 9, por defecto 7.

**--version-intensity \<numero>** Regulamos la intensidad, de forma que cuanto m√°s bajo solo lanzar√° las sondas m√°s probables, pero no todas. Con esto podemos acortar considerablemente el tiempo de escaneo UDP.

**-O** Detecci√≥n de os.

**--osscan-limit** Para escanear bien un host se necesita que al menos haya 1 puerto abierto y otro cerrado; si no se da esta condici√≥n y hemos puesto esto, no intenta hacer predicci√≥n de os (ahorra tiempo).

**--osscan-guess** Cuando la detecci√≥n de os no es perfecta, esto hace que se esfuerce m√°s.

**Scripts**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

Para usar los de por defecto vale con -sC o --script=default.

Los tipos que hay son de: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, y vuln.

* **Auth:** ejecuta todos sus _scripts_ disponibles para autenticaci√≥n.
* **Default:** ejecuta los _scripts_ b√°sicos por defecto de la herramienta.
* **Discovery:** recupera informaci√≥n del _target_ o v√≠ctima.
* **External:** _script_ para utilizar recursos externos.
* **Intrusive:** utiliza _scripts_ que son considerados intrusivos para la v√≠ctima o _target_.
* **Malware:** revisa si hay conexiones abiertas por c√≥digos maliciosos o _backdoors_ (puertas traseras).
* **Safe:** ejecuta _scripts_ que no son intrusivos.
* **Vuln:** descubre las vulnerabilidades m√°s conocidas.
* **All:** ejecuta absolutamente todos los _scripts_ con extensi√≥n NSE disponibles.

Para buscar scripts:

**nmap --script-help="http-\*" -> Los que empiecen por http-**

**nmap --script-help="not intrusive" -> Todos menos esos**

**nmap --script-help="default or safe" -> Los que est√°n en uno o en otro o en ambos**

**nmap --script-help="default and safe" --> Los que est√°n en ambos**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> Da info de c√≥mo va el script.

\--script-updatedb

**Para usar un script solo hay que poner: namp --script Nombre\_del\_script objetivo** --> Al poner el script se ejecutar√° tanto el script como el esc√°ner, as√≠ que tambi√©n se pueden poner opciones del esc√°ner; podemos a√±adir **‚Äúsafe=1‚Äù** para que se ejecuten solo los que sean seguros.

**Control tiempo**

**Nmap puede modificar el tiempo en segundos, minutos, ms:** --host-timeout arguments 900000ms, 900, 900s, y 15m hacen lo mismo.

Nmap divide el n√∫mero total de hosts a escanear en grupos y analiza esos grupos en bloques de forma que hasta que no han sido analizados todos, no pasa al siguiente bloque (y el usuario tampoco recibe ninguna actualizaci√≥n hasta que se haya analizado el bloque); de esta forma, es m√°s √≥ptimo para nmap usar grupos grandes. Por defecto, en clase C usa 256.

Se puede cambiar con **--min-hostgroup** _**\<numhosts>**_; **--max-hostgroup** _**\<numhosts>**_ (Ajustar tama√±os de grupo de escaneo paralelo).

Se puede controlar el n√∫mero de esc√°neres en paralelo, pero es mejor que no (nmap ya incorpora control autom√°tico en base al estado de la red): **--min-parallelism** _**\<numprobes>**_; **--max-parallelism** _**\<numprobes>**_.

Podemos modificar el tiempo de espera RTT, pero no suele ser necesario: **--min-rtt-timeout** _**\<time>**_, **--max-rtt-timeout** _**\<time>**_, **--initial-rtt-timeout** _**\<time>**_.

Podemos modificar el n√∫mero de intentos:**--max-retries** _**\<numtries>**_.

Podemos modificar el tiempo de escaneado de un host: **--host-timeout** _**\<time>**_.

Podemos modificar el tiempo entre cada prueba para que vaya despacio: **--scan-delay** _**\<time>**_; **--max-scan-delay** _**\<time>**_.

Podemos modificar el n√∫mero de paquetes por segundo: **--min-rate** _**\<number>**_; **--max-rate** _**\<number>**_.

Muchos puertos tardan mucho en responder al estar filtrados o cerrados; si solo nos interesan los abiertos, podemos ir m√°s r√°pido con: **--defeat-rst-ratelimit**.

Para definir lo agresivo que queremos que sea nmap: -T paranoid|sneaky|polite|normal|aggressive|insane.

\-T (0-1).

\-T0 --> Solo se escanea 1 puerto a la vez y se espera 5min hasta el siguiente.

\-T1 y T2 --> Muy parecidos pero solo esperan 15 y 0,4seg respectivamente entre cada prueba.

\-T3 --> Funcionamiento por defecto, incluye en paralelo.

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms.

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms.

**Firewall/IDS**

No dejan pasar a puertos y analizan paquetes.

**-f** Para fragmentar paquetes, por defecto los fragmenta en 8bytes despu√©s de la cabecera; para especificar ese tama√±o usamos ..mtu (con esto, no usar -f), el offset debe ser m√∫ltiplo de 8. **Esc√°neres de versi√≥n y scripts no soportan la fragmentaci√≥n**.

**-D decoy1,decoy2,ME** Nmap env√≠a esc√°neres pero con otras direcciones IPs como origen, de esta forma te esconden a ti. Si pones el ME en la lista, nmap te situar√° ah√≠; mejor poner 5 o 6 antes de ti para que te enmascaren completamente. Se pueden generar Ips aleatorias con RND:\<numero> para generar \<numero> de Ips aleatorias. No funcionan con detector de versiones sin conexi√≥n de TCP. Si est√°s dentro de una red, te interesa usar Ips que est√©n activas, pues si no ser√° muy f√°cil averiguar que t√∫ eres la √∫nica activa.

Para usar Ips aleatorias: nmap-D RND: 10 Ip\_objetivo.

**-S IP** Para cuando Nmap no pilla tu direcci√≥n Ip, se la tienes que dar con eso. Tambi√©n sirve para hacer pensar que hay otro objetivo escane√°ndoles.

**-e \<interface>** Para elegir la interfaz.

Muchos administradores dejan puertos de entrada abiertos para que todo funcione correctamente y les es m√°s f√°cil que buscar otra soluci√≥n. Estos pueden ser los puertos DNS o los de FTP... para buscar esta vulnerabilidad, nmap incorpora: **--source-port** _**\<portnumber>**_ **;-g** _**\<portnumber>**_ _Son equivalentes_.

**--data** _**\<hex string>**_ Para enviar texto hexadecimal: --data 0xdeadbeef y --data \xCA\xFE\x09.

**--data-string** _**\<string>**_ Para enviar un texto normal: --data-string "Scan conducted by Security Ops, extension 7192".

**--data-length** _**\<number>**_ Nmap env√≠a solo cabeceras; con esto logramos que a√±ada a estar un n√∫mero de bytes m√°s (que se generar√°n aleatoriamente).

Para configurar el paquete IP completamente, usar **--ip-options**.

Si deseas ver las opciones en los paquetes enviados y recibidos, especifica --packet-trace. Para m√°s informaci√≥n y ejemplos de uso de opciones IP con Nmap, consulta [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**\<value>**_.

**--randomize-hosts** Para que el ataque sea menos obvio.

**--spoof-mac** _**\<MAC address, prefix, or vendor name>**_ Para cambiar la mac ejemplos: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, y Cisco.

**--proxies** _**\<Comma-separated list of proxy URLs>**_ Para usar proxies; a veces un proxy no mantiene tantas conexiones abiertas como nmap quiere, por lo que habr√≠a que modificar el paralelismo: --max-parallelism.

**-sP** Para descubrir hosts en la red en la que estamos por ARP.

Muchos administradores crean una regla en el firewall que permite pasar todos los paquetes que provienen de un puerto en particular (como el 20,53 y 67); podemos decirle a nmap que mande nuestros paquetes desde esos puertos: **nmap --source-port 53 Ip**.

**Salidas**

**-oN file** Salida normal.

**-oX file** Salida XML.

**-oS file** Salida de script kiddies.

**-oG file** Salida grepable.

**-oA file** Todos menos -oS.

**-v level** verbosity.

**-d level** debugging.

**--reason** Por qu√© del host y estado.

**--stats-every time** Cada ese tiempo nos dice c√≥mo va.

**--packet-trace** Para ver qu√© paquetes salen, se pueden especificar filtros como: --version-trace o --script-trace.

**--open** muestra los abiertos, abiertos|filtrados y los no filtrados.

**--resume file** Saca un resumen.

**Miscel√°nea**

**-6** Permite ipv6.

**-A** es lo mismo que -O -sV -sC --traceroute.

**Tiempo de ejecuci√≥n**

Mientras corre nmap, podemos cambiar opciones:

v / V Aumentar / disminuir el nivel de verbosidad.

d / D Aumentar / disminuir el nivel de depuraci√≥n.

p / P Activar / desactivar el seguimiento de paquetes.

? Imprimir una pantalla de ayuda de interacci√≥n en tiempo de ejecuci√≥n.

**Vulscan**

Script de nmap que mira las versiones de los servicios obtenidos en una base de datos offline (que descarga de otras muy importantes) y devuelve las posibles vulnerabilidades.

Las BD que usa son:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Para descargarlo e instalarlo en la carpeta de Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap\_nse\_vulscan-2.0.tar.gz && tar -czvf nmap\_nse\_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Tambi√©n habr√≠a que descargar los paquetes de las BD y a√±adirlos a /usr/share/nmap/scripts/vulscan/.

Uso:

Para usar todos: sudo nmap -sV --script=vulscan HOST\_A\_ESCANEAR.

Para usar una BD espec√≠fica: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST\_A\_ESCANEAR.

## Acelerar el escaneo de servicios de Nmap x16

Seg√∫n [**este post**](https://joshua.hu/nmap-speedup-service-scanning-16x), puedes acelerar el an√°lisis de servicios de nmap modificando todos los valores de **`totalwaitms`** en **`/usr/share/nmap/nmap-service-probes`** a **300** y **`tcpwrappedms`** a **200**.

Adem√°s, las sondas que no tienen un **`servicewaitms`** espec√≠ficamente definido utilizan un valor predeterminado de **`5000`**. Por lo tanto, podemos agregar valores a cada una de las sondas, o podemos **compilar nmap** nosotros mismos y cambiar el valor predeterminado en [**service\_scan.h**](https://github.com/nmap/nmap/blob/master/service\_scan.h#L79).

Si no deseas cambiar los valores de **`totalwaitms`** y **`tcpwrappedms`** en absoluto en el archivo `/usr/share/nmap/nmap-service-probes`, puedes editar el [c√≥digo de an√°lisis](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358) de tal manera que estos valores en el archivo `nmap-service-probes` sean completamente ignorados.

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
