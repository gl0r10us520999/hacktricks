# GLBP & HSRP Angriffe

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## FHRP Hijacking √úbersicht

### Einblicke in FHRP
FHRP wurde entwickelt, um die Netzwerkrobustheit zu gew√§hrleisten, indem mehrere Router zu einer einzigen virtuellen Einheit zusammengef√ºhrt werden, wodurch die Lastverteilung und Fehlertoleranz verbessert werden. Cisco Systems f√ºhrte prominente Protokolle in dieser Suite ein, wie GLBP und HSRP.

### GLBP Protokoll Einblicke
Ciscos Kreation, GLBP, funktioniert im TCP/IP-Stack und nutzt UDP auf Port 3222 f√ºr die Kommunikation. Router in einer GLBP-Gruppe tauschen alle 3 Sekunden "Hallo"-Pakete aus. Wenn ein Router diese Pakete 10 Sekunden lang nicht sendet, wird angenommen, dass er offline ist. Diese Timer sind jedoch nicht fest und k√∂nnen ge√§ndert werden.

### GLBP-Betrieb und Lastverteilung
GLBP zeichnet sich dadurch aus, dass es eine Lastverteilung √ºber Router mit einer einzigen virtuellen IP in Verbindung mit mehreren virtuellen MAC-Adressen erm√∂glicht. In einer GLBP-Gruppe ist jeder Router am Paketweiterleitung beteiligt. Im Gegensatz zu HSRP/VRRP bietet GLBP echtes Lastenausgleich durch mehrere Mechanismen:

- **Host-abh√§ngiger Lastenausgleich:** Beibehaltung einer konsistenten AVF-MAC-Adresse f√ºr einen Host, die f√ºr stabile NAT-Konfigurationen entscheidend ist.
- **Round-Robin-Lastenausgleich:** Der Standardansatz, der die Zuweisung der AVF-MAC-Adresse zwischen anfordernden Hosts wechselt.
- **Gewichteter Round-Robin-Lastenausgleich:** Verteilung der Last basierend auf vordefinierten "Gewicht"-Metriken.

### Schl√ºsselkomponenten und Terminologien in GLBP
- **AVG (Aktiver Virtueller Gateway):** Der Hauptrouter, verantwortlich f√ºr die Zuweisung von MAC-Adressen an Peer-Router.
- **AVF (Aktiver Virtueller Weiterleiter):** Ein Router, der f√ºr die Verwaltung des Netzwerkverkehrs zust√§ndig ist.
- **GLBP-Priorit√§t:** Eine Metrik, die den AVG bestimmt, beginnend bei einem Standardwert von 100 und im Bereich von 1 bis 255.
- **GLBP-Gewicht:** Spiegelt die aktuelle Last auf einem Router wider, die entweder manuell oder durch Objektverfolgung angepasst werden kann.
- **GLBP Virtuelle IP-Adresse:** Dient als Standardgateway des Netzwerks f√ºr alle angeschlossenen Ger√§te.

F√ºr Interaktionen verwendet GLBP die reservierte Multicast-Adresse 224.0.0.102 und UDP-Port 3222. Router senden alle 3 Sekunden "Hallo"-Pakete und werden als nicht betriebsbereit angesehen, wenn ein Paket √ºber einen Zeitraum von 10 Sekunden fehlt.

### GLBP-Angriffsmechanismus
Ein Angreifer kann der prim√§re Router werden, indem er ein GLBP-Paket mit dem h√∂chsten Priorit√§tswert (255) sendet. Dies kann zu DoS- oder MITM-Angriffen f√ºhren, die es erm√∂glichen, den Datenverkehr abzufangen oder umzuleiten.

### Durchf√ºhrung eines GLBP-Angriffs mit Loki
[Loki](https://github.com/raizo62/loki_on_kali) kann einen GLBP-Angriff durchf√ºhren, indem ein Paket mit Priorit√§t und Gewicht auf 255 gesetzt wird. Vor den Angriffsschritten m√ºssen Informationen wie die virtuelle IP-Adresse, das Vorhandensein von Authentifizierung und die Priorit√§tswerte der Router mit Tools wie Wireshark gesammelt werden.

Angriffsschritte:
1. Wechsel in den Promiscuous-Modus und aktiviere IP-Weiterleitung.
2. Identifiziere den Zielrouter und rufe seine IP ab.
3. Generiere ein Gratuitous ARP.
4. Injektiere ein b√∂sartiges GLBP-Paket, das den AVG imitiert.
5. Weisen Sie der Netzwerkoberfl√§che des Angreifers eine sekund√§re IP-Adresse zu, die der GLBP-virtuellen IP entspricht.
6. Implementiere SNAT f√ºr vollst√§ndige Sichtbarkeit des Datenverkehrs.
7. Passe das Routing an, um den fortgesetzten Internetzugang √ºber den urspr√ºnglichen AVG-Router sicherzustellen.

Durch das Befolgen dieser Schritte positioniert sich der Angreifer als "Man-in-the-Middle", der in der Lage ist, Netzwerkverkehr abzufangen und zu analysieren, einschlie√ülich unverschl√ºsselter oder sensibler Daten.

Zur Demonstration hier die erforderlichen Befehls-Snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring und Abfangen von Datenverkehr kann mit net-creds.py oder √§hnlichen Tools durchgef√ºhrt werden, um Daten zu erfassen und zu analysieren, die durch das kompromittierte Netzwerk flie√üen.

### Passive Erkl√§rung des HSRP-Hijackings mit Befehlsdetails

#### √úberblick √ºber HSRP (Hot Standby Router/Redundancy Protocol)
HSRP ist ein propriet√§res Protokoll von Cisco, das f√ºr die Redundanz von Netzwerk-Gateways entwickelt wurde. Es erm√∂glicht die Konfiguration mehrerer physischer Router zu einer einzigen logischen Einheit mit einer gemeinsamen IP-Adresse. Diese logische Einheit wird von einem prim√§ren Router verwaltet, der f√ºr die Verkehrslenkung verantwortlich ist. Im Gegensatz zu GLBP, das Metriken wie Priorit√§t und Gewicht f√ºr die Lastverteilung verwendet, verl√§sst sich HSRP auf einen einzigen aktiven Router f√ºr das Verkehrsmanagement.

#### Rollen und Terminologie in HSRP
- **HSRP Aktiver Router**: Das Ger√§t, das als Gateway fungiert und den Datenverkehr verwaltet.
- **HSRP Standby Router**: Ein Backup-Router, der bereit ist, die Rolle zu √ºbernehmen, wenn der aktive Router ausf√§llt.
- **HSRP Gruppe**: Eine Gruppe von Routern, die zusammenarbeiten, um einen einzigen resilienten virtuellen Router zu bilden.
- **HSRP MAC-Adresse**: Eine virtuelle MAC-Adresse, die dem logischen Router in der HSRP-Konfiguration zugewiesen ist.
- **HSRP Virtuelle IP-Adresse**: Die virtuelle IP-Adresse der HSRP-Gruppe, die als Standardgateway f√ºr verbundene Ger√§te fungiert.

#### HSRP-Versionen
HSRP gibt es in zwei Versionen, HSRPv1 und HSRPv2, die sich haupts√§chlich in der Gruppenkapazit√§t, der Verwendung von Multicast-IP und der Struktur der virtuellen MAC-Adresse unterscheiden. Das Protokoll nutzt spezifische Multicast-IP-Adressen f√ºr den Austausch von Dienstinformationen, wobei alle 3 Sekunden Hello-Pakete gesendet werden. Ein Router wird als inaktiv angesehen, wenn innerhalb eines 10-Sekunden-Intervalls kein Paket empfangen wird.

#### HSRP-Angriffsmechanismus
HSRP-Angriffe beinhalten das gewaltsame √úbernehmen der Rolle des aktiven Routers durch das Injizieren eines maximalen Priorit√§tswerts. Dies kann zu einem Man-In-The-Middle (MITM)-Angriff f√ºhren. Wesentliche Schritte vor dem Angriff umfassen das Sammeln von Daten √ºber die HSRP-Konfiguration, was mit Wireshark zur Verkehrsanalysierung durchgef√ºhrt werden kann.

#### Schritte zum Umgehen der HSRP-Authentifizierung
1. Speichern Sie den Netzwerkverkehr, der HSRP-Daten enth√§lt, als .pcap-Datei.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrahieren Sie MD5-Hashes aus der .pcap-Datei mit hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Knacken Sie die MD5-Hashes mit John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ausf√ºhren der HSRP-Injektion mit Loki**

1. Starten Sie Loki, um HSRP-Werbung zu identifizieren.
2. Setzen Sie die Netzwerkschnittstelle in den Promiscuous-Modus und aktivieren Sie das IP-Forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Verwenden Sie Loki, um den spezifischen Router anzuvisieren, geben Sie das geknackte HSRP-Passwort ein und f√ºhren Sie die erforderlichen Konfigurationen durch, um den aktiven Router zu impersonifizieren.
4. Nachdem Sie die Rolle des aktiven Routers √ºbernommen haben, konfigurieren Sie Ihre Netzwerkschnittstelle und IP-Tabellen, um den legitimen Datenverkehr abzufangen.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. √Ñndern Sie die Routing-Tabelle, um den Datenverkehr √ºber den ehemaligen aktiven Router zu leiten.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Verwenden Sie net-creds.py oder ein √§hnliches Dienstprogramm, um Anmeldeinformationen aus dem abgefangenen Datenverkehr zu erfassen.
```shell
sudo python2 net-creds.py -i eth0
```

Das Ausf√ºhren dieser Schritte versetzt den Angreifer in die Lage, den Datenverkehr abzufangen und zu manipulieren, √§hnlich wie beim Verfahren f√ºr GLBP-Hijacking. Dies hebt die Verwundbarkeit in Redundanzprotokollen wie HSRP und die Notwendigkeit robuster Sicherheitsma√ünahmen hervor.


## Referenzen
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
