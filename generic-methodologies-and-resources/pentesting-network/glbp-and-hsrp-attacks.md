# GLBP & HSRP Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## Vis√£o Geral do Sequestro FHRP

### Insights sobre FHRP
FHRP √© projetado para fornecer robustez √† rede, unindo v√°rios roteadores em uma √∫nica unidade virtual, melhorando assim a distribui√ß√£o de carga e a toler√¢ncia a falhas. A Cisco Systems introduziu protocolos proeminentes nesta su√≠te, como GLBP e HSRP.

### Insights sobre o Protocolo GLBP
A cria√ß√£o da Cisco, GLBP, funciona na pilha TCP/IP, utilizando UDP na porta 3222 para comunica√ß√£o. Roteadores em um grupo GLBP trocam pacotes "hello" em intervalos de 3 segundos. Se um roteador n√£o enviar esses pacotes por 10 segundos, presume-se que est√° offline. No entanto, esses temporizadores n√£o s√£o fixos e podem ser modificados.

### Opera√ß√µes GLBP e Distribui√ß√£o de Carga
GLBP se destaca ao permitir a distribui√ß√£o de carga entre roteadores usando um √∫nico IP virtual combinado com v√°rios endere√ßos MAC virtuais. Em um grupo GLBP, cada roteador est√° envolvido no encaminhamento de pacotes. Ao contr√°rio do HSRP/VRRP, o GLBP oferece balanceamento de carga genu√≠no por meio de v√°rios mecanismos:

- **Balanceamento de Carga Dependente do Host:** Mant√©m a atribui√ß√£o consistente do endere√ßo MAC AVF a um host, essencial para configura√ß√µes NAT est√°veis.
- **Balanceamento de Carga Round-Robin:** A abordagem padr√£o, alternando a atribui√ß√£o do endere√ßo MAC AVF entre os hosts solicitantes.
- **Balanceamento de Carga Round-Robin Ponderado:** Distribui a carga com base em m√©tricas de "Peso" predefinidas.

### Componentes e Terminologias Chave no GLBP
- **AVG (Active Virtual Gateway):** O roteador principal, respons√°vel por alocar endere√ßos MAC para roteadores pares.
- **AVF (Active Virtual Forwarder):** Um roteador designado para gerenciar o tr√°fego da rede.
- **Prioridade GLBP:** Uma m√©trica que determina o AVG, come√ßando em um padr√£o de 100 e variando entre 1 e 255.
- **Peso GLBP:** Reflete a carga atual em um roteador, ajust√°vel manualmente ou por meio de Object Tracking.
- **Endere√ßo IP Virtual GLBP:** Serve como o gateway padr√£o da rede para todos os dispositivos conectados.

Para intera√ß√µes, o GLBP utiliza o endere√ßo multicast reservado 224.0.0.102 e a porta UDP 3222. Os roteadores transmitem pacotes "hello" em intervalos de 3 segundos e s√£o considerados n√£o operacionais se um pacote for perdido por um per√≠odo de 10 segundos.

### Mecanismo de Ataque GLBP
Um atacante pode se tornar o roteador principal enviando um pacote GLBP com o maior valor de prioridade (255). Isso pode levar a ataques DoS ou MITM, permitindo a intercepta√ß√£o ou redirecionamento de tr√°fego.

### Executando um Ataque GLBP com Loki
[Loki](https://github.com/raizo62/loki_on_kali) pode realizar um ataque GLBP injetando um pacote com prioridade e peso definidos como 255. Os passos pr√©-ataque envolvem coletar informa√ß√µes como o endere√ßo IP virtual, presen√ßa de autentica√ß√£o e valores de prioridade do roteador usando ferramentas como Wireshark.

Passos do Ataque:
1. Mude para o modo prom√≠scuo e habilite o encaminhamento IP.
2. Identifique o roteador alvo e recupere seu IP.
3. Gere um ARP Gratuitous.
4. Injete um pacote GLBP malicioso, se passando pelo AVG.
5. Atribua um endere√ßo IP secund√°rio √† interface de rede do atacante, espelhando o IP virtual GLBP.
6. Implemente SNAT para visibilidade completa do tr√°fego.
7. Ajuste o roteamento para garantir acesso cont√≠nuo √† internet atrav√©s do roteador AVG original.

Seguindo esses passos, o atacante se posiciona como um "homem no meio", capaz de interceptar e analisar o tr√°fego da rede, incluindo dados n√£o criptografados ou sens√≠veis.

Para demonstra√ß√£o, aqui est√£o os trechos de comando necess√°rios:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### Explica√ß√£o Passiva do Sequestro HSRP com Detalhes de Comando

#### Vis√£o Geral do HSRP (Hot Standby Router/Redundancy Protocol)
HSRP √© um protocolo propriet√°rio da Cisco projetado para redund√¢ncia de gateway de rede. Ele permite a configura√ß√£o de v√°rios roteadores f√≠sicos em uma √∫nica unidade l√≥gica com um endere√ßo IP compartilhado. Esta unidade l√≥gica √© gerenciada por um roteador prim√°rio respons√°vel por direcionar o tr√°fego. Ao contr√°rio do GLBP, que usa m√©tricas como prioridade e peso para balanceamento de carga, o HSRP depende de um √∫nico roteador ativo para gerenciamento de tr√°fego.

#### Fun√ß√µes e Terminologia no HSRP
- **Roteador Ativo HSRP**: O dispositivo que atua como gateway, gerenciando o fluxo de tr√°fego.
- **Roteador em Espera HSRP**: Um roteador de backup, pronto para assumir se o roteador ativo falhar.
- **Grupo HSRP**: Um conjunto de roteadores colaborando para formar um √∫nico roteador virtual resiliente.
- **Endere√ßo MAC HSRP**: Um endere√ßo MAC virtual atribu√≠do ao roteador l√≥gico na configura√ß√£o HSRP.
- **Endere√ßo IP Virtual HSRP**: O endere√ßo IP virtual do grupo HSRP, atuando como o gateway padr√£o para dispositivos conectados.

#### Vers√µes do HSRP
O HSRP vem em duas vers√µes, HSRPv1 e HSRPv2, que diferem principalmente na capacidade do grupo, uso de IP multicast e estrutura do endere√ßo MAC virtual. O protocolo utiliza endere√ßos IP multicast espec√≠ficos para troca de informa√ß√µes de servi√ßo, com pacotes Hello enviados a cada 3 segundos. Um roteador √© considerado inativo se nenhum pacote for recebido dentro de um intervalo de 10 segundos.

#### Mecanismo de Ataque HSRP
Os ataques HSRP envolvem a tomada for√ßada do papel do Roteador Ativo, injetando um valor de prioridade m√°ximo. Isso pode levar a um ataque Man-In-The-Middle (MITM). Os passos essenciais antes do ataque incluem a coleta de dados sobre a configura√ß√£o HSRP, que pode ser feita usando o Wireshark para an√°lise de tr√°fego.

#### Passos para Bypass da Autentica√ß√£o HSRP
1. Salve o tr√°fego de rede contendo dados HSRP como um arquivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraia hashes MD5 do arquivo .pcap usando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Quebre os hashes MD5 usando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executando a Inje√ß√£o HSRP com Loki**

1. Inicie o Loki para identificar an√∫ncios HSRP.
2. Defina a interface de rede para modo prom√≠scuo e habilite o encaminhamento de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Use o Loki para direcionar o roteador espec√≠fico, insira a senha HSRP quebrada e execute as configura√ß√µes necess√°rias para se passar pelo Roteador Ativo.
4. Ap√≥s assumir o papel de Roteador Ativo, configure sua interface de rede e tabelas IP para interceptar o tr√°fego leg√≠timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifique a tabela de roteamento para direcionar o tr√°fego atrav√©s do antigo Roteador Ativo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Use net-creds.py ou uma utilidade similar para capturar credenciais do tr√°fego interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Executar esses passos coloca o atacante em uma posi√ß√£o para interceptar e manipular tr√°fego, semelhante ao procedimento para sequestro GLBP. Isso destaca a vulnerabilidade em protocolos de redund√¢ncia como HSRP e a necessidade de medidas de seguran√ßa robustas.

## Refer√™ncias
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
