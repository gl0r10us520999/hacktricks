# GLBP & HSRP Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## FHRP Hijacking Overview

### Insights into FHRP
FHRP je dizajniran da obezbedi robusnost mreÅ¾e spajanjem viÅ¡e rutera u jednu virtuelnu jedinicu, Äime se poboljÅ¡ava raspodela optereÄ‡enja i otpornost na greÅ¡ke. Cisco Systems je uveo istaknute protokole u ovom skupu, kao Å¡to su GLBP i HSRP.

### GLBP Protocol Insights
Cisco-ova kreacija, GLBP, funkcioniÅ¡e na TCP/IP steku, koristeÄ‡i UDP na portu 3222 za komunikaciju. Ruteri u GLBP grupi razmenjuju "hello" pakete na svakih 3 sekunde. Ako ruter ne poÅ¡alje ove pakete tokom 10 sekundi, smatra se da je van mreÅ¾e. MeÄ‘utim, ovi tajmeri nisu fiksni i mogu se modifikovati.

### GLBP Operations and Load Distribution
GLBP se izdvaja omoguÄ‡avajuÄ‡i raspodelu optereÄ‡enja meÄ‘u ruterima koristeÄ‡i jednu virtuelnu IP adresu u kombinaciji sa viÅ¡e virtuelnih MAC adresa. U GLBP grupi, svaki ruter uÄestvuje u prosleÄ‘ivanju paketa. Za razliku od HSRP/VRRP, GLBP nudi pravu ravnoteÅ¾u optereÄ‡enja kroz nekoliko mehanizama:

- **Host-Dependent Load Balancing:** OdrÅ¾ava doslednu AVF MAC adresu dodeljenu hostu, Å¡to je bitno za stabilne NAT konfiguracije.
- **Round-Robin Load Balancing:** Podrazumevani pristup, naizmeniÄno dodeljujuÄ‡i AVF MAC adrese meÄ‘u zahtevima hostova.
- **Weighted Round-Robin Load Balancing:** Raspodeljuje optereÄ‡enje na osnovu unapred definisanih "Weight" metrika.

### Key Components and Terminologies in GLBP
- **AVG (Active Virtual Gateway):** Glavni ruter, odgovoran za dodeljivanje MAC adresa peer ruterima.
- **AVF (Active Virtual Forwarder):** Ruter zaduÅ¾en za upravljanje mreÅ¾nim saobraÄ‡ajem.
- **GLBP Priority:** Metrika koja odreÄ‘uje AVG, poÄinje od podrazumevanog nivoa 100 i kreÄ‡e se izmeÄ‘u 1 i 255.
- **GLBP Weight:** OdraÅ¾ava trenutno optereÄ‡enje na ruteru, moÅ¾e se prilagoditi ruÄno ili putem Object Tracking-a.
- **GLBP Virtual IP Address:** SluÅ¾i kao podrazumevani prolaz mreÅ¾e za sve povezane ureÄ‘aje.

Za interakcije, GLBP koristi rezervisanu multicast adresu 224.0.0.102 i UDP port 3222. Ruteri Å¡alju "hello" pakete na svakih 3 sekunde i smatraju se neoperativnim ako se paket propusti tokom 10 sekundi.

### GLBP Attack Mechanism
NapadaÄ moÅ¾e postati glavni ruter slanjem GLBP paketa sa najviÅ¡om prioritetnom vrednoÅ¡Ä‡u (255). To moÅ¾e dovesti do DoS ili MITM napada, omoguÄ‡avajuÄ‡i presretanje ili preusmeravanje saobraÄ‡aja.

### Executing a GLBP Attack with Loki
[Loki](https://github.com/raizo62/loki_on_kali) moÅ¾e izvesti GLBP napad injektovanjem paketa sa prioritetom i teÅ¾inom postavljenim na 255. Pre napada, koraci ukljuÄuju prikupljanje informacija kao Å¡to su virtuelna IP adresa, prisustvo autentifikacije i prioritetne vrednosti rutera koristeÄ‡i alate kao Å¡to je Wireshark.

Attack Steps:
1. Prebacite se u promiscuous mode i omoguÄ‡ite IP prosleÄ‘ivanje.
2. Identifikujte ciljni ruter i preuzmite njegovu IP adresu.
3. GeneriÅ¡ite Gratuitous ARP.
4. Injektujte zlonamerni GLBP paket, pretvarajuÄ‡i se da ste AVG.
5. Dodelite sekundarnu IP adresu mreÅ¾nom interfejsu napadaÄa, odraÅ¾avajuÄ‡i GLBP virtuelnu IP.
6. Implementirajte SNAT za potpunu vidljivost saobraÄ‡aja.
7. Prilagodite rutiranje kako biste osigurali nastavak pristupa internetu kroz originalni AVG ruter.

PrateÄ‡i ove korake, napadaÄ se pozicionira kao "Äovek u sredini", sposoban da presreÄ‡e i analizira mreÅ¾ni saobraÄ‡aj, ukljuÄujuÄ‡i neÅ¡ifrovane ili osetljive podatke.

Za demonstraciju, evo potrebnih komandi:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### Passive Explanation of HSRP Hijacking with Command Details

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)
HSRP je Cisco-ov proprietarni protokol dizajniran za redundanciju mreÅ¾nih prolaza. OmoguÄ‡ava konfiguraciju viÅ¡e fiziÄkih rutera u jednu logiÄku jedinicu sa zajedniÄkom IP adresom. Ova logiÄka jedinica se upravlja od strane primarnog rutera koji je odgovoran za usmeravanje saobraÄ‡aja. Za razliku od GLBP, koji koristi metrike poput prioriteta i teÅ¾ine za balansiranje optereÄ‡enja, HSRP se oslanja na jedan aktivni ruter za upravljanje saobraÄ‡ajem.

#### Roles and Terminology in HSRP
- **HSRP Active Router**: UreÄ‘aj koji deluje kao prolaz, upravljajuÄ‡i protokom saobraÄ‡aja.
- **HSRP Standby Router**: Rezervni ruter, spreman da preuzme ako aktivni ruter otkaÅ¾e.
- **HSRP Group**: Skup rutera koji saraÄ‘uju kako bi formirali jedan otporniji virtuelni ruter.
- **HSRP MAC Address**: Virtuelna MAC adresa dodeljena logiÄkom ruteru u HSRP postavci.
- **HSRP Virtual IP Address**: Virtuelna IP adresa HSRP grupe, koja deluje kao podrazumevani prolaz za povezane ureÄ‘aje.

#### HSRP Versions
HSRP dolazi u dve verzije, HSRPv1 i HSRPv2, koje se razlikuju uglavnom u kapacitetu grupe, koriÅ¡Ä‡enju multicast IP adresa i strukturi virtuelne MAC adrese. Protokol koristi specifiÄne multicast IP adrese za razmenu informacija o usluzi, sa Hello paketima koji se Å¡alju svake 3 sekunde. Ruter se smatra neaktivnim ako ne primi paket u intervalu od 10 sekundi.

#### HSRP Attack Mechanism
HSRP napadi ukljuÄuju prisilno preuzimanje uloge Aktivnog Rutera injektovanjem maksimalne vrednosti prioriteta. Ovo moÅ¾e dovesti do napada Man-In-The-Middle (MITM). Osnovni koraci pre napada ukljuÄuju prikupljanje podataka o HSRP postavci, Å¡to se moÅ¾e uraditi koriÅ¡Ä‡enjem Wireshark-a za analizu saobraÄ‡aja.

#### Steps for Bypassing HSRP Authentication
1. SaÄuvajte mreÅ¾ni saobraÄ‡aj koji sadrÅ¾i HSRP podatke kao .pcap datoteku.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Izvucite MD5 heÅ¡ vrednosti iz .pcap datoteke koristeÄ‡i hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Razbijte MD5 heÅ¡ vrednosti koristeÄ‡i John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executing HSRP Injection with Loki**

1. Pokrenite Loki da identifikujete HSRP oglase.
2. Postavite mreÅ¾ni interfejs u promiscuous mode i omoguÄ‡ite IP prosleÄ‘ivanje.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Koristite Loki da ciljate specifiÄni ruter, unesite razbijenu HSRP lozinku i izvrÅ¡ite potrebne konfiguracije da se pretvarate da ste Aktivni Ruter.
4. Nakon Å¡to preuzmete ulogu Aktivnog Rutera, konfiguriÅ¡ite svoj mreÅ¾ni interfejs i IP tabele da presretnete legitimni saobraÄ‡aj.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Izmenite tabelu rutiranja da usmerite saobraÄ‡aj kroz bivÅ¡eg Aktivnog Rutera.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Koristite net-creds.py ili sliÄan alat za prikupljanje kredencijala iz presretnutog saobraÄ‡aja.
```shell
sudo python2 net-creds.py -i eth0
```

IzvrÅ¡avanje ovih koraka stavlja napadaÄa u poziciju da presreÄ‡e i manipuliÅ¡e saobraÄ‡ajem, sliÄno postupku za GLBP otmicu. Ovo naglaÅ¡ava ranjivost u protokolima redundancije poput HSRP i potrebu za robusnim bezbednosnim merama.


## References
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
