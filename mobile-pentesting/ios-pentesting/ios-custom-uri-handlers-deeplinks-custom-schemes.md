# iOS Custom URI Handlers / Deeplinks / Custom Schemes

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Benutzerdefinierte URL-Schemata erm√∂glichen es Apps, √ºber ein benutzerdefiniertes Protokoll zu kommunizieren, wie in der [Apple Developer Documentation](https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple\_ref/doc/uid/TP40007072-CH6-SW1) beschrieben. Diese Schemata m√ºssen von der App deklariert werden, die dann eingehende URLs gem√§√ü diesen Schemata verarbeitet. Es ist entscheidend, **alle URL-Parameter zu validieren** und **alle fehlerhaften URLs zu verwerfen**, um Angriffe √ºber diesen Vektor zu verhindern.

Ein Beispiel wird gegeben, bei dem die URI `myapp://hostname?data=123876123` eine spezifische Anwendungsaktion ausl√∂st. Eine festgestellte Schwachstelle war in der Skype Mobile-App, die unzul√§ssige Anrufaktionen √ºber das `skype://`-Protokoll erm√∂glichte. Die registrierten Schemata sind in der `Info.plist` der App unter `CFBundleURLTypes` zu finden. B√∂sartige Anwendungen k√∂nnen dies ausnutzen, indem sie URIs neu registrieren, um sensible Informationen abzufangen.

### Registrierung von Anwendungsabfrage-Schemata

Seit iOS 9.0 erfordert `canOpenURL:`, um zu √ºberpr√ºfen, ob eine App verf√ºgbar ist, die Deklaration von URL-Schemata in der `Info.plist` unter `LSApplicationQueriesSchemes`. Dies begrenzt die Schemata, die eine App abfragen kann, auf 50 und verbessert die Privatsph√§re, indem es die Aufz√§hlung von Apps verhindert.
```xml
<key>LSApplicationQueriesSchemes</key>
<array>
<string>url_scheme1</string>
<string>url_scheme2</string>
</array>
```
### Testing URL Handling and Validation

Entwickler sollten spezifische Methoden im Quellcode √ºberpr√ºfen, um den Aufbau und die Validierung von URL-Pfaden zu verstehen, wie `application:didFinishLaunchingWithOptions:` und `application:openURL:options:`. Zum Beispiel verwendet Telegram verschiedene Methoden zum √ñffnen von URLs:
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, handleOpen url: URL) -> Bool {
self.openUrl(url: url)
return true
}
```
### Testing URL Requests to Other Apps

Methoden wie `openURL:options:completionHandler:` sind entscheidend, um URLs zu √∂ffnen und mit anderen Apps zu interagieren. Die Identifizierung der Nutzung solcher Methoden im Quellcode der App ist der Schl√ºssel zum Verst√§ndnis externer Kommunikationen.

### Testing for Deprecated Methods

Veraltete Methoden zur Handhabung von URL-√ñffnungen, wie `application:handleOpenURL:` und `openURL:`, sollten identifiziert und auf Sicherheitsimplikationen √ºberpr√ºft werden.

### Fuzzing URL Schemes

Fuzzing von URL-Schemata kann Speicherbesch√§digungsfehler identifizieren. Tools wie [Frida](https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/) k√∂nnen diesen Prozess automatisieren, indem sie URLs mit unterschiedlichen Payloads √∂ffnen, um auf Abst√ºrze zu √ºberwachen, veranschaulicht durch die Manipulation von URLs in der iGoat-Swift-App:
```bash
$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
[iPhone::SpringBoard]-> fuzz("iGoat", "iGoat://?contactNumber={0}&message={0}")
Watching for crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber=0&message=0
```
## Hijacking benutzerdefinierter URL-Schemata

Laut [**diesem Beitrag**](https://evanconnelly.github.io/post/ios-oauth/) k√∂nnten b√∂sartige Apps **andere Apps benutzerdefinierte Schemata registrieren,** dann kann die b√∂sartige App einen Browser √∂ffnen, der alle Cookies der Safari-App mit [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession/2990952-init#parameters) hat.&#x20;

Mit dem Browser kann die b√∂sartige App eine von Angreifern kontrollierte Webseite laden, und TCC wird den mobilen Benutzer um Erlaubnis bitten, diese App zu √∂ffnen. Dann k√∂nnte die b√∂sartige Webseite auf eine Opferseite umleiten, zum Beispiel einen OAuth-Fluss mit dem Parameter `prompt=none`. Wenn der Benutzer bereits im OAuth-Fluss angemeldet war, wird der OAuth-Fluss das Geheimnis √ºber das benutzerdefinierte Schema der Opferanwendung zur√ºcksenden.\
Da die b√∂sartige App es jedoch auch registriert hat und da der verwendete Browser innerhalb der b√∂sartigen App ist, wird das benutzerdefinierte Schema in diesem Fall von der b√∂sartigen App behandelt, die in der Lage sein wird, das OAuth-Token zu stehlen.

## Referenzen

* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0075/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0075/)
* [https://evanconnelly.github.io/post/ios-oauth/](https://evanconnelly.github.io/post/ios-oauth/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
